<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.io/docs/concept/iac/><link rel=alternate type=application/rss+xml href=https://pigsty.io/docs/concept/iac/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Infra as Code | PIGSTY</title><meta name=description content="Pigsty uses Infrastructure as Code (IaC) philosophy to manage all components, providing declarative management for large-scale clusters."><meta property="og:url" content="https://pigsty.io/docs/concept/iac/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="Infra as Code"><meta property="og:description" content="Pigsty uses Infrastructure as Code (IaC) philosophy to manage all components, providing declarative management for large-scale clusters."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Infra as Code"><meta itemprop=description content="Pigsty uses Infrastructure as Code (IaC) philosophy to manage all components, providing declarative management for large-scale clusters."><meta itemprop=dateModified content="2026-01-08T21:14:36+08:00"><meta itemprop=wordCount content="3017"><meta itemprop=keywords content="Concept,PIGSTY"><meta name=twitter:card content="summary"><meta name=twitter:title content="Infra as Code"><meta name=twitter:description content="Pigsty uses Infrastructure as Code (IaC) philosophy to manage all components, providing declarative management for large-scale clusters."><link rel=preload href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css as=style integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><link href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css rel=stylesheet integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Ver</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.cc>Pigsty 中文网站</a></li><li><a class=dropdown-item href=https://doc.pgsty.com>Pigsty v3.7 Doc</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc>Pigsty v3.4 Doc</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 Doc</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 Doc</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch Language / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d757e151050fd40088751a74721d74f6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:window.location.href="https://pigsty.cc"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/concept/iac/>Return to the regular view of this page</a>.</p></div><h1 class=title>Infra as Code</h1><div class=lead>Pigsty uses Infrastructure as Code (IaC) philosophy to manage all components, providing declarative management for large-scale clusters.</div><ul><li>1: <a href=#pg-6b8b3debf71b9a47be1364eba07a65ae>Inventory</a></li><li>2: <a href=#pg-c48a7025a948ffe27199cd10986e517a>Configure</a></li><li>3: <a href=#pg-e42d80439da940091a403ada6ca968af>Parameters</a></li><li>4: <a href=#pg-a71a0b133f9617fabea630bbd56757f4>Conf Templates</a></li><li>5: <a href=#pg-4f710b6522c00bd4a1ee261283a935b7>Use CMDB as Config Inventory</a></li></ul><div class=content><p>Pigsty follows the IaC and GitOPS philosophy: use a declarative <a href=/docs/setup/config#inventory><strong>config inventory</strong></a> to describe the entire environment, and materialize it through <a href=/docs/setup/playbook><strong>idempotent playbooks</strong></a>.</p><p>Users describe their desired state declaratively through <a href=/docs/ref/param><strong>parameters</strong></a>, and playbooks idempotently adjust target nodes to reach that state.
This is similar to Kubernetes CRDs & Operators, but Pigsty implements this functionality on bare metal and virtual machines through Ansible.</p><p>Pigsty was born to solve the operational management problem of ultra-large-scale PostgreSQL clusters. The idea behind it is simple — we need the ability to replicate the entire infrastructure (100+ database clusters + PG/Redis + observability) on ready servers within ten minutes.
No GUI + ClickOps can complete such a complex task in such a short time, making CLI + IaC the only choice — it provides precise, efficient control.</p><p>The config inventory <a href=/docs/setup/config><code>pigsty.yml</code></a> file describes the state of the entire deployment. Whether it&rsquo;s production (prod), staging, test, or development (devbox) environments,
the difference between infrastructures lies only in the config inventory, while the deployment delivery logic is exactly the same.</p><p>You can use git for version control and auditing of this deployment &ldquo;seed/gene&rdquo;, and Pigsty even supports storing the config inventory as database tables in PostgreSQL CMDB, further achieving Infra as Data capability.
Seamlessly integrate with your existing workflows.</p><p>IaC is designed for professional users and enterprise scenarios but is also deeply optimized for individual developers and SMBs.
Even if you&rsquo;re not a professional DBA, you don&rsquo;t need to understand these hundreds of adjustment knobs and switches. All parameters come with well-performing default values.
You can get an out-of-the-box single-node database with <strong>zero configuration</strong>;
Simply add two more IP addresses to get an enterprise-grade high-availability PostgreSQL cluster.</p><hr><h2 id=declare-modules>Declare Modules</h2><p>Take the following default config snippet as an example. This config describes a node <code>10.10.10.10</code> with <a href=/docs/infra><strong><code>INFRA</code></strong></a>, <a href=/docs/node><strong><code>NODE</code></strong></a>, <a href=/docs/etcd><strong><code>ETCD</code></strong></a>, and <a href=/docs/pgsql><strong><code>PGSQL</code></strong></a> modules installed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitoring, alerting, DNS, NTP and other infrastructure cluster...</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># minio cluster, s3 compatible object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># etcd cluster, used as DCS for PostgreSQL high availability</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL example cluster: pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To actually install these modules, execute the following playbooks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># Initialize infra module on node 10.10.10.10</span>
</span></span><span style=display:flex><span>./etcd.yml  -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># Initialize etcd module on node 10.10.10.10</span>
</span></span><span style=display:flex><span>./minio.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># Initialize minio module on node 10.10.10.10</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># Initialize pgsql module on node 10.10.10.10</span>
</span></span></code></pre></div><hr><h2 id=declare-clusters>Declare Clusters</h2><p>You can declare PostgreSQL database clusters by installing the <a href=/docs/pgsql/><strong><code>PGSQL</code></strong></a> module on multiple nodes, making them a service unit:</p><p>For example, to deploy a three-node high-availability PostgreSQL cluster using streaming replication on the following three Pigsty-managed nodes,
you can add the following definition to the <code>all.children</code> section of the config file <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><code>pigsty.yml</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>After defining, you can use <a href=/docs/setup/playbook/><strong>playbooks</strong></a> to create the cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># Create the pg-test cluster</span>
</span></span></code></pre></div><p><img src=/img/pigsty/iac.jpg alt=pigsty-iac.jpg></p><p>You can use different instance roles such as <a href=/docs/pgsql/config#primary><strong>primary</strong></a>, <a href=/docs/pgsql/config#replica><strong>replica</strong></a>, <a href=/docs/pgsql/config#offline><strong>offline</strong></a>, <a href=/docs/pgsql/config#delayed-cluster><strong>delayed</strong></a>, <a href=/docs/pgsql/config#sync-standby><strong>sync standby</strong></a>;
as well as different clusters: such as <a href=/docs/pgsql/config#standby-cluster><strong>standby clusters</strong></a>, <a href=/docs/pgsql/config#citus-cluster><strong>Citus clusters</strong></a>, and even <a href=/docs/redis><strong>Redis</strong></a> / <a href=/docs/minio><strong>MinIO</strong></a> / <a href=/docs/etcd><strong>Etcd</strong></a> clusters</p><hr><h2 id=customize-cluster-content>Customize Cluster Content</h2><p>Not only can you define clusters declaratively, but you can also define databases, users, services, and HBA rules within the cluster. For example, the following config file deeply customizes the content of the default <code>pg-meta</code> single-node database cluster:</p><p>Including: declaring six business databases and seven business users, adding an extra <code>standby</code> service (synchronous standby, providing read capability with no replication delay), defining some additional <code>pg_hba</code> rules, an L2 VIP address pointing to the cluster primary, and a customized backup strategy.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># define business databases on this cluster, array of database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database sql baseline path, (relative path among ansible search path, e.g files/)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this database to pgbouncer database list? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, additional schemas to be created, array of schema names</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions:                     # optional, additional extensions to be installed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>array of `{name[,schema]}`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database owner, postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, which template to use, template1 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database encoding, UTF8 by default. (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database locale, C by default.  (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database collate, C by default. (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database ctype, C by default.   (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, default tablespace, &#39;pg_default&#39; by default.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, allow connection, true by default. false will disable connect at all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, revoke public connection privilege. false by default. (leave connect with grant option to owner)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># optional, register this database to grafana datasources? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, database connection limit, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, all connection to this pgbouncer database will be authenticated by this user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at database level, default transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size at database level, default 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size reserve at database level, default 32</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size min at database level, default 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_max_db_conn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># optional, max database connections at database level, default 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># define business users/roles on this cluster, array of user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, password, can be a scram-sha-256 hash string or plain text</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># optional, can log in, true by default  (new biz ROLE should be false)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, is superuser? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, can create database? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, can create role? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, can this role use inherited privileges? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, can this role do replication? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, can this role bypass row level security? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this user to pgbouncer user-list? false by default (production user should be true explicitly)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, user connection limit, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, now + n days when this role is expired (OVERWRITE expire_at)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># optional, YYYY-MM-DD &#39;timestamp&#39; when this role is expired  (OVERWRITTEN by expire_in)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this user/role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>roles: [dbrole_admin]           # optional, belonged roles. default roles are</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_{admin,readonly,readwrite,offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, role level parameters with `ALTER ROLE SET`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at user level, transaction by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, max database connections at user level, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service      }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                        </span><span style=color:#8f5902;font-style:italic># extra services in addition to pg_default_services, array of service definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># standby service will route {ip|name}:5435 to sync replica&#39;s pgbouncer (5435-&gt;6432 standby)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name: standby                   # required, service name, the actual svc name will be prefixed with `pg_cluster`, e.g</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># required, service exposed port (work as kubernetes service node port mode)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># optional, service bind ip address, `*` for all ip by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># required, service member selector, use JMESPath to filter inventory</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, destination port, default|postgres|pgbouncer|&lt;port_number&gt;, &#39;default&#39; by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>check</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, health check url path, / by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># backup server selector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, max allowed front-end connection</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>balance: roundrobin             # optional, haproxy load balance algorithm (roundrobin by default, other</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>leastconn)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.2</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># make a full backup 1 am everyday</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=declare-access-control>Declare Access Control</h2><p>You can also deeply customize Pigsty&rsquo;s access control capabilities through declarative configuration. For example, the following config file provides deep security customization for the <code>pg-meta</code> cluster:</p><p>Uses the three-node core cluster template: <code>crit.yml</code>, to ensure data consistency is prioritized with zero data loss during failover.
Enables L2 VIP and restricts database and connection pool listening addresses to local loopback IP + internal network IP + VIP three specific addresses.
The template enforces Patroni&rsquo;s SSL API and Pgbouncer&rsquo;s SSL, and in HBA rules, enforces SSL usage for accessing the database cluster.
Also enables the <code>$libdir/passwordcheck</code> extension in <code>pg_libs</code> to enforce password strength security policy.</p><p>Finally, a separate <code>pg-meta-delay</code> cluster is declared as <code>pg-meta</code>&rsquo;s delayed replica from one hour ago, for emergency data deletion recovery.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 3 instance postgres cluster `pg-meta`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta , password: DBUser.Meta   , pgbouncer: true , roles: [ dbrole_admin ] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view , password: DBUser.Viewer , pgbouncer: true , roles: [ dbrole_readonly ] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: standby ,src_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,port: 5435 , dest: default ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.2</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_listen</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${ip},${vip},${lo}&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_ssl_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>require</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, $libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add passwordcheck extension to enforce strong password</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly]               ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite]  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,expire_in: 7300                        ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,expire_in: 7300 ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,expire_in: 7300 ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,expire_in: 7300 ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres host-based auth rules by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: cert  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; cert&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer host-based authentication rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu local admin access with os ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user local access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor access via intranet with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other monitor access addr&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin access via intranet with pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other admin access addr&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user intra access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># OPTIONAL delayed cluster for pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta-delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># delayed instance for pg-meta (1 hour ago)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_upstream: 10.10.10.10, pg_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1h } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-delay }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=citus-distributed-cluster>Citus Distributed Cluster</h2><p>Below is a declarative configuration for a four-node Citus distributed cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus coordinator, pg_group = 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 3, with an extra replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.14</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># global parameters for all citus clusters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                    # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_citus_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus distributed database name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=redis-clusters>Redis Clusters</h2><p>Below are declarative configuration examples for Redis primary-replica cluster, sentinel cluster, and Redis Cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-ms</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># redis classic primary &amp; replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 , redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_cluster: redis-ms ,redis_password: &#39;redis.ms&#39; ,redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MB }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># redis sentinel x 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 , redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>26379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,26380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,26381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_sentinel_monitor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary list for redis sentinel, use cls as name, primary ip:port</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: redis-ms, host: 10.10.10.10, port: 6379 ,password: redis.ms, quorum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-test: # redis native cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>3m x 3s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 ,redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 2 ,redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_cluster: redis-test ,redis_password: &#39;redis.test&#39; ,redis_mode: cluster, redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=etcd-cluster>ETCD Cluster</h2><p>Below is a declarative configuration example for a three-node Etcd cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># dcs service for postgres/patroni ha consensus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 1 node for testing, 3 or 5 for production</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># etcd_seq required</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># assign from 1 ~ n</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># odd number please</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># cluster level parameter override roles/etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># mark etcd cluster name etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># safeguard against purging</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_clean</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># purge etcd during init process</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=minio-cluster>MinIO Cluster</h2><p>Below is a declarative configuration example for a three-node MinIO cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data{1...2}&#39;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># use two disks per node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${minio_cluster}-${minio_seq}.pigsty&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># node name pattern</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>haproxy_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># [required] service name, must be unique</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9002</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># [required] service port, must be unique</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>http-check send meth OPTIONS uri /minio/health/live</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>servers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-1 ,ip: 10.10.10.10 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-2 ,ip: 10.10.10.11 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-3 ,ip: 10.10.10.12 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6b8b3debf71b9a47be1364eba07a65ae>1 - Inventory</h1><div class=lead>Describe your infrastructure and clusters using declarative configuration files</div><p>Every Pigsty deployment corresponds to an <strong>Inventory</strong> that describes key properties of the infrastructure and database clusters.</p><hr><h2 id=configuration-file>Configuration File</h2><p>Pigsty uses <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html><strong>Ansible YAML configuration format</strong></a> by default,
with a single YAML configuration file <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><strong><code>pigsty.yml</code></strong></a> as the inventory.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/pigsty
</span></span><span style=display:flex><span>  ^---- pigsty.yml   <span style=color:#8f5902;font-style:italic># &lt;---- Default configuration file</span>
</span></span></code></pre></div><p>You can directly edit this configuration file to customize your deployment, or use the <a href=/docs/concept/iac/configure><strong><code>configure</code></strong></a> wizard script provided by Pigsty to automatically generate an appropriate configuration file.</p><hr><h2 id=configuration-structure>Configuration Structure</h2><p>The inventory uses standard <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html><strong>Ansible YAML configuration format</strong></a>, consisting of two parts: <strong>global parameters</strong> (<code>all.vars</code>) and multiple <strong>groups</strong> (<code>all.children</code>).</p><p>You can define new clusters in <code>all.children</code> and describe the infrastructure using global variables: <code>all.vars</code>, which looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all:                  # Top-level object</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Global parameters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Group definitions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra:            # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>...}        # Group members</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span>{<span style=color:#204a87;font-weight:700>...}        # Group parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#204a87;font-weight:700>...}    # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etcd&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>...}    # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>...}    # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>...} # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis-test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=cluster-definition>Cluster Definition</h2><p>Each Ansible group may represent a cluster, which can be a node cluster, PostgreSQL cluster, Redis cluster, Etcd cluster, MinIO cluster, etc.</p><p>A cluster definition consists of two parts: <strong>cluster members</strong> (<strong><code>hosts</code></strong>) and <strong>cluster parameters</strong> (<strong><code>vars</code></strong>).
You can define cluster members in <code>&lt;cls>.hosts</code> and describe the cluster using <a href=/docs/concept/iac/parameter><strong>configuration parameters</strong></a> in <code>&lt;cls>.vars</code>.
Here&rsquo;s an example of a 3-node high-availability PostgreSQL cluster definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Ansible group list</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Ansible group name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Ansible group instances (cluster members)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Host 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Host 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Host 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Ansible group variables (cluster parameters)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Cluster-level <code>vars</code> (cluster parameters) override global parameters, and instance-level <code>vars</code> override both cluster parameters and global parameters.</p><hr><h2 id=splitting-configuration>Splitting Configuration</h2><p>If your deployment is large or you want to better organize configuration files,
you can <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html#id18><strong>split the inventory into multiple files</strong></a> for easier management and maintenance.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>inventory/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>├── hosts.yml             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Host and cluster definitions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>├── group_vars/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── all.yml           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Global default variables (corresponds to all.vars)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── infra.yml         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># infra group variables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── etcd.yml          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># etcd group variables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   └── pg-meta.yml       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg-meta cluster variables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>└── host_vars/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>├── 10.10.10.10.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Specific host variables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>└── 10.10.10.11.yml</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can place cluster member definitions in the <code>hosts.yml</code> file and put cluster-level <a href=/docs/concept/iac/parameter#parameter-priority><strong>configuration parameters</strong></a> in corresponding files under the <code>group_vars</code> directory.</p><hr><h2 id=switching-configuration>Switching Configuration</h2><p>You can temporarily specify a different inventory file when running playbooks using the <code>-i</code> parameter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -i another_config.yml
</span></span><span style=display:flex><span>./infra.yml -i nginx_config.yml
</span></span></code></pre></div><p>Additionally, Ansible supports multiple configuration methods. You can use local <code>yaml|ini</code> configuration files, or use CMDB and any dynamic configuration scripts as configuration sources.</p><p>In Pigsty, we specify <strong><code>pigsty.yml</code></strong> in the same directory as the default <strong>inventory</strong> through <a href=https://github.com/pgsty/pigsty/blob/main/ansible.cfg#L6><strong><code>ansible.cfg</code></strong></a> in the Pigsty home directory. You can modify it as needed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[defaults]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>inventory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pigsty.yml</span>
</span></span></code></pre></div><p>Additionally, Pigsty supports using a <a href=/docs/concept/iac/cmdb><strong>CMDB metabase</strong></a> to store the inventory, facilitating integration with existing systems.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c48a7025a948ffe27199cd10986e517a>2 - Configure</h1><div class=lead>Use the configure script to automatically generate recommended configuration files based on your environment.</div><p>Pigsty provides a <strong><code>configure</code></strong> script as a <strong>configuration wizard</strong> that automatically generates an appropriate <code>pigsty.yml</code> configuration file based on your current environment.</p><p>This is an <strong>optional</strong> script: if you already understand how to configure Pigsty, you can directly edit the <code>pigsty.yml</code> configuration file and skip the wizard.</p><hr><h2 id=quick-start>Quick Start</h2><p>Enter the pigsty source home directory and run <code>./configure</code> to automatically start the configuration wizard. Without any arguments, it defaults to the <a href=/docs/conf/meta><strong><code>meta</code></strong></a> single-node configuration template:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty
</span></span><span style=display:flex><span>./configure          <span style=color:#8f5902;font-style:italic># Interactive configuration wizard, auto-detect environment and generate config</span>
</span></span></code></pre></div><p>This command will use the selected template as a base, detect the current node&rsquo;s IP address and region, and generate a <code>pigsty.yml</code> configuration file suitable for the current environment.</p><div id=asciinema-faf4cf8e717f5b9f582b3cede024d31c class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-faf4cf8e717f5b9f582b3cede024d31c",o="/demo/configure.cast",e="solarized-light",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[3,"Default config"],[7,"Specify IP"],[14,"Random password"],[17,"rich template"],[20,"app/odoo template"],[26,"china region"],[33,"ha/full template"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><h2 id=features>Features</h2><p>The <strong><code>configure</code></strong> script performs the following adjustments based on environment and input, generating a <code>pigsty.yml</code> configuration file in the current directory.</p><ul><li>Detects the current node IP address; if multiple IPs exist, prompts the user to input a <strong>primary IP address</strong> as the node&rsquo;s identity</li><li>Uses the IP address to replace the placeholder <strong><code>10.10.10.10</code></strong> in the configuration template and sets it as the <a href=/docs/infra/param#admin_ip><strong><code>admin_ip</code></strong></a> parameter value</li><li>Detects the current region, setting <a href=/docs/infra/param#region><strong><code>region</code></strong></a> to <strong><code>default</code></strong> (global default repos) or <strong><code>china</code></strong> (using Chinese mirror repos)</li><li>For micro instances (vCPU &lt; 4), uses the <strong><code>tiny</code></strong> parameter template for <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> and <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> to optimize resource usage</li><li>If <strong><code>-v</code></strong> PG major version is specified, sets <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a> and all PG alias parameters to the corresponding major version</li><li>If <strong><code>-g</code></strong> is specified, replaces all default passwords with randomly generated strong passwords for enhanced security (<strong>strongly recommended</strong>)</li><li>When PG major version ≥ 17, prioritizes the built-in <strong><code>C.UTF-8</code></strong> locale, or the OS-supported <strong><code>C.UTF-8</code></strong></li><li>Checks if the core dependency <strong><code>ansible</code></strong> for deployment is available in the current environment</li><li>Also checks if the deployment target node is SSH-reachable and can execute commands with sudo (<strong><code>-s</code></strong> to skip)</li></ul><hr><h2 id=usage-examples>Usage Examples</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Basic usage</span>
</span></span><span style=display:flex><span>./configure                       <span style=color:#8f5902;font-style:italic># Interactive configuration wizard</span>
</span></span><span style=display:flex><span>./configure -i 10.10.10.10        <span style=color:#8f5902;font-style:italic># Specify primary IP address</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify configuration template</span>
</span></span><span style=display:flex><span>./configure -c meta               <span style=color:#8f5902;font-style:italic># Use default single-node template (default)</span>
</span></span><span style=display:flex><span>./configure -c rich               <span style=color:#8f5902;font-style:italic># Use feature-rich single-node template</span>
</span></span><span style=display:flex><span>./configure -c slim               <span style=color:#8f5902;font-style:italic># Use minimal template (PGSQL + ETCD only)</span>
</span></span><span style=display:flex><span>./configure -c ha/full            <span style=color:#8f5902;font-style:italic># Use 4-node HA sandbox template</span>
</span></span><span style=display:flex><span>./configure -c ha/trio            <span style=color:#8f5902;font-style:italic># Use 3-node HA template</span>
</span></span><span style=display:flex><span>./configure -c app/supa           <span style=color:#8f5902;font-style:italic># Use Supabase self-hosted template</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify PostgreSQL version</span>
</span></span><span style=display:flex><span>./configure -v <span style=color:#0000cf;font-weight:700>17</span>                 <span style=color:#8f5902;font-style:italic># Use PostgreSQL 17</span>
</span></span><span style=display:flex><span>./configure -v <span style=color:#0000cf;font-weight:700>16</span>                 <span style=color:#8f5902;font-style:italic># Use PostgreSQL 16</span>
</span></span><span style=display:flex><span>./configure -c rich -v <span style=color:#0000cf;font-weight:700>16</span>         <span style=color:#8f5902;font-style:italic># rich template + PG 16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Region and proxy</span>
</span></span><span style=display:flex><span>./configure -r china              <span style=color:#8f5902;font-style:italic># Use Chinese mirrors</span>
</span></span><span style=display:flex><span>./configure -r europe             <span style=color:#8f5902;font-style:italic># Use European mirrors</span>
</span></span><span style=display:flex><span>./configure -x                    <span style=color:#8f5902;font-style:italic># Import current proxy environment variables</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Skip and automation</span>
</span></span><span style=display:flex><span>./configure -s                    <span style=color:#8f5902;font-style:italic># Skip IP detection, keep placeholder</span>
</span></span><span style=display:flex><span>./configure -n -i 10.10.10.10     <span style=color:#8f5902;font-style:italic># Non-interactive mode with specified IP</span>
</span></span><span style=display:flex><span>./configure -c ha/full -s         <span style=color:#8f5902;font-style:italic># 4-node template, skip IP replacement</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Security enhancement</span>
</span></span><span style=display:flex><span>./configure -g                    <span style=color:#8f5902;font-style:italic># Generate random passwords</span>
</span></span><span style=display:flex><span>./configure -c meta -g -i 10.10.10.10  <span style=color:#8f5902;font-style:italic># Complete production configuration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify output and SSH port</span>
</span></span><span style=display:flex><span>./configure -o prod.yml           <span style=color:#8f5902;font-style:italic># Output to prod.yml</span>
</span></span><span style=display:flex><span>./configure -p <span style=color:#0000cf;font-weight:700>2222</span>               <span style=color:#8f5902;font-style:italic># Use SSH port 2222</span>
</span></span></code></pre></div><hr><h2 id=command-arguments>Command Arguments</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-c<span style=color:#000;font-weight:700>|</span>--conf &lt;template&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># Configuration template name (meta|rich|slim|ha/full|...)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-i<span style=color:#000;font-weight:700>|</span>--ip &lt;ipaddr&gt;<span style=color:#ce5c00;font-weight:700>]</span>          <span style=color:#8f5902;font-style:italic># Specify primary IP address</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-v<span style=color:#000;font-weight:700>|</span>--version &lt;pgver&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># PostgreSQL major version (13|14|15|16|17|18)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-r<span style=color:#000;font-weight:700>|</span>--region &lt;region&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># Upstream software repo region (default|china|europe)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-o<span style=color:#000;font-weight:700>|</span>--output &lt;file&gt;<span style=color:#ce5c00;font-weight:700>]</span>        <span style=color:#8f5902;font-style:italic># Output configuration file path (default: pigsty.yml)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-s<span style=color:#000;font-weight:700>|</span>--skip<span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#8f5902;font-style:italic># Skip IP address detection and replacement</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-x<span style=color:#000;font-weight:700>|</span>--proxy<span style=color:#ce5c00;font-weight:700>]</span>                <span style=color:#8f5902;font-style:italic># Import proxy settings from environment variables</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-n<span style=color:#000;font-weight:700>|</span>--non-interactive<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># Non-interactive mode (don&#39;t ask any questions)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-p<span style=color:#000;font-weight:700>|</span>--port &lt;port&gt;<span style=color:#ce5c00;font-weight:700>]</span>          <span style=color:#8f5902;font-style:italic># Specify SSH port</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-g<span style=color:#000;font-weight:700>|</span>--generate<span style=color:#ce5c00;font-weight:700>]</span>             <span style=color:#8f5902;font-style:italic># Generate random passwords</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-h<span style=color:#000;font-weight:700>|</span>--help<span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#8f5902;font-style:italic># Display help information</span>
</span></span></code></pre></div><h3 id=argument-details>Argument Details</h3><table><thead><tr><th style=text-align:left>Argument</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>-c, --conf</code></td><td style=text-align:left>Generate config from <code>conf/&lt;template>.yml</code>, supports subdirectories like <code>ha/full</code></td></tr><tr><td style=text-align:left><code>-i, --ip</code></td><td style=text-align:left>Replace placeholder <code>10.10.10.10</code> in config template with specified IP</td></tr><tr><td style=text-align:left><code>-v, --version</code></td><td style=text-align:left>Specify PostgreSQL major version (13-18), keeps template default if not specified</td></tr><tr><td style=text-align:left><code>-r, --region</code></td><td style=text-align:left>Set software repo mirror region: <code>default</code>, <code>china</code> (Chinese mirrors), <code>europe</code> (European)</td></tr><tr><td style=text-align:left><code>-o, --output</code></td><td style=text-align:left>Specify output file path, defaults to <code>pigsty.yml</code></td></tr><tr><td style=text-align:left><code>-s, --skip</code></td><td style=text-align:left>Skip IP address detection and replacement, keep <code>10.10.10.10</code> placeholder in template</td></tr><tr><td style=text-align:left><code>-x, --proxy</code></td><td style=text-align:left>Write current environment proxy variables (<code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code>, <code>ALL_PROXY</code>, <code>NO_PROXY</code>) to config</td></tr><tr><td style=text-align:left><code>-n, --non-interactive</code></td><td style=text-align:left>Non-interactive mode, don&rsquo;t ask any questions (requires <code>-i</code> to specify IP)</td></tr><tr><td style=text-align:left><code>-p, --port</code></td><td style=text-align:left>Specify SSH port (when using non-default port 22)</td></tr><tr><td style=text-align:left><code>-g, --generate</code></td><td style=text-align:left><strong>Generate random values for passwords in config file, improving security (strongly recommended)</strong></td></tr></tbody></table><hr><h2 id=execution-flow>Execution Flow</h2><p>The <code>configure</code> script executes detection and configuration in the following order:</p><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────┐
│                  configure Execution Flow                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. check_region          Detect network region (GFW check) │
│         ↓                                                   │
│  2. check_version         Validate PostgreSQL version       │
│         ↓                                                   │
│  3. check_kernel          Detect OS kernel (Linux/Darwin)   │
│         ↓                                                   │
│  4. check_machine         Detect CPU arch (x86_64/aarch64)  │
│         ↓                                                   │
│  5. check_package_manager Detect package manager (dnf/yum/apt) │
│         ↓                                                   │
│  6. check_vendor_version  Detect OS distro and version      │
│         ↓                                                   │
│  7. check_sudo            Detect passwordless sudo          │
│         ↓                                                   │
│  8. check_ssh             Detect passwordless SSH to self   │
│         ↓                                                   │
│  9. check_proxy           Handle proxy environment vars     │
│         ↓                                                   │
│ 10. check_ipaddr          Detect/input primary IP address   │
│         ↓                                                   │
│ 11. check_admin           Validate admin SSH + Sudo access  │
│         ↓                                                   │
│ 12. check_conf            Select configuration template     │
│         ↓                                                   │
│ 13. check_config          Generate configuration file       │
│         ↓                                                   │
│ 14. check_utils           Check if Ansible etc. installed   │
│         ↓                                                   │
│     ✓ Configuration complete, output pigsty.yml             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre><hr><h2 id=automatic-behaviors>Automatic Behaviors</h2><h3 id=region-detection>Region Detection</h3><p>The script automatically detects the network environment to determine if you&rsquo;re in mainland China (behind GFW):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check network environment by accessing Google</span>
</span></span><span style=display:flex><span>curl -I -s --connect-timeout <span style=color:#0000cf;font-weight:700>1</span> www.google.com
</span></span></code></pre></div><ul><li>If Google is inaccessible, automatically sets <code>region: china</code> to use domestic mirrors</li><li>If accessible, uses <code>region: default</code> default mirrors</li><li>Can manually specify region via <code>-r</code> argument</li></ul><h3 id=ip-address-handling>IP Address Handling</h3><p>The script determines the primary IP address in the following priority:</p><ol><li><strong>Command line argument</strong>: If IP is specified via <code>-i</code>, use it directly</li><li><strong>Single IP detection</strong>: If the current node has only one IP, use it automatically</li><li><strong>Demo IP detection</strong>: If <code>10.10.10.10</code> is detected, select it automatically (for sandbox environments)</li><li><strong>Interactive input</strong>: When multiple IPs exist, prompt user to choose or input</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> Multiple IP address candidates found:
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span> 192.168.1.100   inet 192.168.1.100/24 scope global eth0
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> 10.10.10.10     inet 10.10.10.10/24 scope global eth1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> IN <span style=color:#ce5c00;font-weight:700>]</span> INPUT primary_ip address <span style=color:#ce5c00;font-weight:700>(</span>of current meta node, e.g 10.10.10.10<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>=</span>&gt; 10.10.10.10
</span></span></code></pre></div><h3 id=low-end-hardware-optimization>Low-End Hardware Optimization</h3><p>When CPU core count ≤ 4 is detected, the script automatically adjusts configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> replace oltp template with tiny due to cpu &lt; <span style=color:#0000cf;font-weight:700>4</span>
</span></span></code></pre></div><ul><li>Changes <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a> from <code>oltp.yml</code> to <code>tiny.yml</code></li><li>Changes <a href=/docs/node/param#node_tune><code>node_tune</code></a> from <code>oltp</code> to <code>tiny</code></li></ul><p>This ensures smooth operation on low-spec virtual machines.</p><h3 id=locale-settings>Locale Settings</h3><p>The script automatically enables <code>C.UTF-8</code> as the default locale when:</p><ul><li>PostgreSQL version ≥ 17 (built-in Locale Provider support)</li><li><strong>Or</strong> the current system supports <code>C.UTF-8</code> / <code>C.utf8</code> locale</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=china-region-special-handling>China Region Special Handling</h3><p>When region is set to <code>china</code>, the script automatically:</p><ul><li>Enables <code>docker_registry_mirrors</code> Docker mirror acceleration</li><li>Enables <code>PIP_MIRROR_URL</code> Python mirror acceleration</li></ul><h3 id=password-generation>Password Generation</h3><p>When using the <code>-g</code> argument, the script generates 24-character random strings for the following passwords:</p><table><thead><tr><th style=text-align:center>Password Parameter</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>grafana_admin_password</code></td><td style=text-align:left>Grafana admin password</td></tr><tr><td style=text-align:center><code>pg_admin_password</code></td><td style=text-align:left>PostgreSQL admin password</td></tr><tr><td style=text-align:center><code>pg_monitor_password</code></td><td style=text-align:left>PostgreSQL monitor user password</td></tr><tr><td style=text-align:center><code>pg_replication_password</code></td><td style=text-align:left>PostgreSQL replication user password</td></tr><tr><td style=text-align:center><code>patroni_password</code></td><td style=text-align:left>Patroni API password</td></tr><tr><td style=text-align:center><code>haproxy_admin_password</code></td><td style=text-align:left>HAProxy admin password</td></tr><tr><td style=text-align:center><code>minio_secret_key</code></td><td style=text-align:left>MinIO Secret Key</td></tr><tr><td style=text-align:center><code>etcd_root_password</code></td><td style=text-align:left>ETCD Root password</td></tr></tbody></table><p>It also replaces the following placeholder passwords:</p><ul><li><code>DBUser.Meta</code> → random password</li><li><code>DBUser.Viewer</code> → random password</li><li><code>S3User.Backup</code> → random password</li><li><code>S3User.Meta</code> → random password</li><li><code>S3User.Data</code> → random password</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./configure -g
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> generating random passwords...
</span></span><span style=display:flex><span>    grafana_admin_password   : xK9mL2nP4qR7sT1vW3yZ5bD8
</span></span><span style=display:flex><span>    pg_admin_password        : aB3cD5eF7gH9iJ1kL2mN4oP6
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> random passwords generated, check and save them
</span></span></code></pre></div><hr><h2 id=configuration-templates>Configuration Templates</h2><p>The script reads configuration templates from the <code>conf/</code> directory, supporting the following templates:</p><h3 id=core-templates>Core Templates</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>meta</code></td><td style=text-align:left><strong>Default template</strong>: Single-node installation with INFRA + NODE + ETCD + PGSQL</td></tr><tr><td style=text-align:center><code>rich</code></td><td style=text-align:left>Feature-rich version: Includes almost all extensions, MinIO, local repo</td></tr><tr><td style=text-align:center><code>slim</code></td><td style=text-align:left>Minimal version: PostgreSQL + ETCD only, no monitoring infrastructure</td></tr><tr><td style=text-align:center><code>fat</code></td><td style=text-align:left>Complete version: rich base with more extensions installed</td></tr><tr><td style=text-align:center><code>pgsql</code></td><td style=text-align:left>Pure PostgreSQL template</td></tr><tr><td style=text-align:center><code>infra</code></td><td style=text-align:left>Pure infrastructure template</td></tr></tbody></table><h3 id=ha-templates-ha>HA Templates (<code>ha/</code>)</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>ha/dual</code></td><td style=text-align:left>2-node HA cluster</td></tr><tr><td style=text-align:center><code>ha/trio</code></td><td style=text-align:left>3-node HA cluster</td></tr><tr><td style=text-align:center><code>ha/full</code></td><td style=text-align:left>4-node complete sandbox environment</td></tr><tr><td style=text-align:center><code>ha/safe</code></td><td style=text-align:left>Security-hardened HA configuration</td></tr><tr><td style=text-align:center><code>ha/simu</code></td><td style=text-align:left>42-node large-scale simulation environment</td></tr></tbody></table><h3 id=application-templates-app>Application Templates (<code>app/</code>)</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>supabase</code></td><td style=text-align:left>Supabase self-hosted configuration</td></tr><tr><td style=text-align:center><code>app/dify</code></td><td style=text-align:left>Dify AI platform configuration</td></tr><tr><td style=text-align:center><code>app/odoo</code></td><td style=text-align:left>Odoo ERP configuration</td></tr><tr><td style=text-align:center><code>app/teable</code></td><td style=text-align:left>Teable table database configuration</td></tr><tr><td style=text-align:center><code>app/registry</code></td><td style=text-align:left>Docker Registry configuration</td></tr></tbody></table><h3 id=special-kernel-templates>Special Kernel Templates</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>ivory</code></td><td style=text-align:left>IvorySQL: Oracle-compatible PostgreSQL</td></tr><tr><td style=text-align:center><code>mssql</code></td><td style=text-align:left>Babelfish: SQL Server-compatible PostgreSQL</td></tr><tr><td style=text-align:center><code>polar</code></td><td style=text-align:left>PolarDB: Alibaba Cloud open-source distributed PostgreSQL</td></tr><tr><td style=text-align:center><code>citus</code></td><td style=text-align:left>Citus: Distributed PostgreSQL</td></tr><tr><td style=text-align:center><code>oriole</code></td><td style=text-align:left>OrioleDB: Next-generation storage engine</td></tr></tbody></table><h3 id=demo-templates-demo>Demo Templates (<code>demo/</code>)</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>demo/demo</code></td><td style=text-align:left>Demo environment configuration</td></tr><tr><td style=text-align:center><code>demo/redis</code></td><td style=text-align:left>Redis cluster demo</td></tr><tr><td style=text-align:center><code>demo/minio</code></td><td style=text-align:left>MinIO cluster demo</td></tr></tbody></table><hr><h2 id=output-example>Output Example</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./configure
</span></span><span style=display:flex><span>configure pigsty v4.0.0 begin
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>region</span> <span style=color:#ce5c00;font-weight:700>=</span> china
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>kernel</span>  <span style=color:#ce5c00;font-weight:700>=</span> Linux
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>machine</span> <span style=color:#ce5c00;font-weight:700>=</span> x86_64
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>package</span> <span style=color:#ce5c00;font-weight:700>=</span> rpm,dnf
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>vendor</span>  <span style=color:#ce5c00;font-weight:700>=</span> rocky <span style=color:#ce5c00;font-weight:700>(</span>Rocky Linux<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#ce5c00;font-weight:700>(</span>9.5<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>sudo</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ssh</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@127.0.0.1 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> Multiple IP address candidates found:
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span> 192.168.121.193	    inet 192.168.121.193/24 brd 192.168.121.255 scope global dynamic noprefixroute eth0
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> 10.10.10.10	    inet 10.10.10.10/24 brd 10.10.10.255 scope global noprefixroute eth1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>primary_ip</span> <span style=color:#ce5c00;font-weight:700>=</span> 10.10.10.10 <span style=color:#ce5c00;font-weight:700>(</span>from demo<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>admin</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@10.10.10.10 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>=</span> meta <span style=color:#ce5c00;font-weight:700>(</span>el9<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>locale</span>  <span style=color:#ce5c00;font-weight:700>=</span> C.UTF-8
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ansible</span> <span style=color:#ce5c00;font-weight:700>=</span> ready
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> pigsty configured
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> don<span style=color:#a40000>&#39;</span>t forget to check it and change passwords!
</span></span><span style=display:flex><span>proceed with ./deploy.yml
</span></span></code></pre></div><hr><h2 id=environment-variables>Environment Variables</h2><p>The script supports the following environment variables:</p><table><thead><tr><th style=text-align:center>Environment Variable</th><th style=text-align:left>Description</th><th style=text-align:center>Default</th></tr></thead><tbody><tr><td style=text-align:center><code>PIGSTY_HOME</code></td><td style=text-align:left>Pigsty installation directory</td><td style=text-align:center><code>~/pigsty</code></td></tr><tr><td style=text-align:center><code>METADB_URL</code></td><td style=text-align:left>Metabase connection URL</td><td style=text-align:center><code>service=meta</code></td></tr><tr><td style=text-align:center><code>HTTP_PROXY</code></td><td style=text-align:left>HTTP proxy</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>HTTPS_PROXY</code></td><td style=text-align:left>HTTPS proxy</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>ALL_PROXY</code></td><td style=text-align:left>Universal proxy</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>NO_PROXY</code></td><td style=text-align:left>Proxy whitelist</td><td style=text-align:center>Built-in default</td></tr></tbody></table><hr><h2 id=notes>Notes</h2><ol><li><p><strong>Passwordless access</strong>: Before running <code>configure</code>, ensure the current user has passwordless sudo privileges and passwordless SSH to localhost. This can be automatically configured via the <code>bootstrap</code> script.</p></li><li><p><strong>IP address selection</strong>: Choose an <strong>internal IP</strong> as the primary IP address, not a public IP or <code>127.0.0.1</code>.</p></li><li><p><strong>Password security</strong>: In production environments, <strong>always</strong> modify default passwords in the configuration file, or use the <code>-g</code> argument to generate random passwords.</p></li><li><p><strong>Configuration review</strong>: After the script completes, it&rsquo;s recommended to review the generated <code>pigsty.yml</code> file to confirm the configuration meets expectations.</p></li><li><p><strong>Multiple executions</strong>: You can run <code>configure</code> multiple times to regenerate configuration; each run will overwrite the existing <code>pigsty.yml</code>.</p></li><li><p><strong>macOS limitations</strong>: When running on macOS, the script skips some Linux-specific checks and uses placeholder IP <code>10.10.10.10</code>. macOS can only serve as an admin node.</p></li></ol><hr><h2 id=faq>FAQ</h2><h3 id=how-to-use-a-custom-configuration-template>How to use a custom configuration template?</h3><p>Place your configuration file in the <code>conf/</code> directory, then specify it with the <code>-c</code> argument:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp my-config.yml ~/pigsty/conf/myconf.yml
</span></span><span style=display:flex><span>./configure -c myconf
</span></span></code></pre></div><h3 id=how-to-generate-different-configurations-for-multiple-clusters>How to generate different configurations for multiple clusters?</h3><p>Use the <code>-o</code> argument to specify different output files:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c ha/full -o cluster-a.yml
</span></span><span style=display:flex><span>./configure -c ha/trio -o cluster-b.yml
</span></span></code></pre></div><p>Then specify the configuration file when running playbooks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy.yml -i cluster-a.yml
</span></span></code></pre></div><h3 id=how-to-handle-multiple-ips-in-non-interactive-mode>How to handle multiple IPs in non-interactive mode?</h3><p>You must explicitly specify the IP address using the <code>-i</code> argument:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -n -i 10.10.10.10
</span></span></code></pre></div><h3 id=how-to-keep-the-placeholder-ip-in-the-template>How to keep the placeholder IP in the template?</h3><p>Use the <code>-s</code> argument to skip IP replacement:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c ha/full -s   <span style=color:#8f5902;font-style:italic># Keep 10.10.10.10 placeholder</span>
</span></span></code></pre></div><hr><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=/docs/concept/iac/inventory/><strong>Inventory</strong></a>: Understand the Ansible inventory structure</li><li><a href=/docs/concept/iac/parameter/><strong>Parameters</strong></a>: Understand Pigsty parameter hierarchy and priority</li><li><a href=/docs/conf/><strong>Templates</strong></a>: View all available configuration templates</li><li><a href=/docs/setup/install/><strong>Installation</strong></a>: Understand the complete installation process</li><li><a href=/docs/concept/iac/cmdb/><strong>Metabase</strong></a>: Use PostgreSQL as a dynamic configuration source</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e42d80439da940091a403ada6ca968af>3 - Parameters</h1><div class=lead>Fine-tune Pigsty customization using configuration parameters</div><p>In the <strong>inventory</strong>, you can use various parameters to fine-tune Pigsty customization. These parameters cover everything from infrastructure settings to database configuration.</p><hr><h2 id=parameter-list>Parameter List</h2><p>Pigsty provides approximately <strong>380+</strong> configuration parameters distributed across 8 default modules for fine-grained control of various system aspects. See <a href=/docs/ref/param><strong>Reference - Parameter List</strong></a> for the complete list.</p><table class=stretch-last><thead><tr><th style=text-align:left>Module</th><th style=text-align:center>Groups</th><th style=text-align:center>Params</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param><strong>PGSQL</strong></a></td><td style=text-align:center>9</td><td style=text-align:center>123</td><td style=text-align:left>Core configuration for PostgreSQL database clusters</td></tr><tr><td style=text-align:left><a href=/docs/infra/param><strong>INFRA</strong></a></td><td style=text-align:center>10</td><td style=text-align:center>82</td><td style=text-align:left>Infrastructure: repos, Nginx, DNS, monitoring, Grafana, etc.</td></tr><tr><td style=text-align:left><a href=/docs/node/param><strong>NODE</strong></a></td><td style=text-align:center>11</td><td style=text-align:center>83</td><td style=text-align:left>Host node tuning: identity, DNS, packages, tuning, security, admin, time, VIP, etc.</td></tr><tr><td style=text-align:left><a href=/docs/etcd/param><strong>ETCD</strong></a></td><td style=text-align:center>2</td><td style=text-align:center>13</td><td style=text-align:left>Distributed configuration store and service discovery</td></tr><tr><td style=text-align:left><a href=/docs/redis/param><strong>REDIS</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>21</td><td style=text-align:left>Redis cache and data structure server</td></tr><tr><td style=text-align:left><a href=/docs/minio/param><strong>MINIO</strong></a></td><td style=text-align:center>2</td><td style=text-align:center>21</td><td style=text-align:left>S3-compatible object storage service</td></tr><tr><td style=text-align:left><a href=/docs/ferret/param><strong>FERRET</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>9</td><td style=text-align:left>MongoDB-compatible database FerretDB</td></tr><tr><td style=text-align:left><a href=/docs/docker/param><strong>DOCKER</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>8</td><td style=text-align:left>Docker container engine</td></tr></tbody></table><hr><h2 id=parameter-form>Parameter Form</h2><p><strong>Parameters</strong> are <strong>key-value pairs</strong> that describe entities. The <strong>Key</strong> is a string, and the <strong>Value</strong> can be one of five types: boolean, string, number, array, or object.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all:                            # &lt;------- Top-level object</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># &lt;------- Global configuration parameter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># &lt;------- pg-meta group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;------- Cluster-level parameter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># &lt;------- Host node IP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;------- Instance-level parameter</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=parameter-priority>Parameter Priority</h2><p>Parameters can be set at different levels with the following priority:</p><table><thead><tr><th style=text-align:left>Level</th><th style=text-align:left>Location</th><th style=text-align:left>Description</th><th style=text-align:left>Priority</th></tr></thead><tbody><tr><td style=text-align:left><strong>CLI</strong></td><td style=text-align:left><code>-e</code> command line argument</td><td style=text-align:left>Passed via command line</td><td style=text-align:left>Highest (5)</td></tr><tr><td style=text-align:left><strong>Host/Instance</strong></td><td style=text-align:left><code>&lt;group>.hosts.&lt;host></code></td><td style=text-align:left>Parameters specific to a single host</td><td style=text-align:left>Higher (4)</td></tr><tr><td style=text-align:left><strong>Group/Cluster</strong></td><td style=text-align:left><code>&lt;group>.vars</code></td><td style=text-align:left>Parameters shared by hosts in group/cluster</td><td style=text-align:left>Medium (3)</td></tr><tr><td style=text-align:left><strong>Global</strong></td><td style=text-align:left><code>all.vars</code></td><td style=text-align:left>Parameters shared by all hosts</td><td style=text-align:left>Lower (2)</td></tr><tr><td style=text-align:left><strong>Default</strong></td><td style=text-align:left><code>&lt;roles>/default/main.yml</code></td><td style=text-align:left>Role implementation defaults</td><td style=text-align:left>Lowest (1)</td></tr></tbody></table><p>Here are some examples of parameter priority:</p><ul><li>Use command line parameter <a href=/docs/infra/param#grafana_clean><strong><code>-e grafana_clean=true</code></strong></a> when running playbooks to wipe Grafana data</li><li>Use instance-level parameter <code>pg_role</code> on host variables to override pg instance role</li><li>Use cluster-level parameter <code>pg_cluster</code> on group variables to override pg cluster name</li><li>Use global parameter <code>node_ntp_servers</code> on global variables to specify global NTP servers</li><li>If <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a> is not set, Pigsty will use the default value from the <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/defaults/main.yml#L42><strong><code>pgsql</code></strong></a> role implementation (default is <code>18</code>)</li></ul><p>Except for <strong>identity parameters</strong>, every parameter has an appropriate default value, so explicit setting is not required.</p><hr><h2 id=identity-parameters>Identity Parameters</h2><p>Identity parameters are special parameters that serve as entity ID identifiers, therefore they <strong>have no default values</strong> and <strong>must be explicitly set</strong>.</p><table><thead><tr><th style=text-align:left>Module</th><th style=text-align:left>Identity Parameters</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_id><strong><code>PGSQL</code></strong></a></td><td style=text-align:left><code>pg_cluster</code>, <code>pg_seq</code>, <code>pg_role</code>, &mldr;</td></tr><tr><td style=text-align:left><a href=/docs/node/param#node_id><strong><code>NODE</code></strong></a></td><td style=text-align:left><code>nodename</code>, <code>node_cluster</code></td></tr><tr><td style=text-align:left><a href=/docs/etcd/param#etcd><strong><code>ETCD</code></strong></a></td><td style=text-align:left><code>etcd_cluster</code>, <code>etcd_seq</code></td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio><strong><code>MINIO</code></strong></a></td><td style=text-align:left><code>minio_cluster</code>, <code>minio_seq</code></td></tr><tr><td style=text-align:left><a href=/docs/redis/param/><strong><code>REDIS</code></strong></a></td><td style=text-align:left><code>redis_cluster</code>, <code>redis_node</code>, <code>redis_instances</code></td></tr><tr><td style=text-align:left><a href=/docs/infra/param#infra_id><strong><code>INFRA</code></strong></a></td><td style=text-align:left><code>infra_seq</code></td></tr></tbody></table><p>Exceptions are <a href=/docs/etcd/param#etcd_cluster><strong><code>etcd_cluster</code></strong></a> and <a href=/docs/minio/param#minio_cluster><strong><code>minio_cluster</code></strong></a> which have default values.
This assumes each deployment has only one etcd cluster for DCS and one optional MinIO cluster for centralized backup storage, so they are assigned default cluster names <code>etcd</code> and <code>minio</code>.
However, you can still deploy multiple etcd or MinIO clusters using different names.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a71a0b133f9617fabea630bbd56757f4>4 - Conf Templates</h1><div class=lead>Use pre-made configuration templates to quickly generate configuration files adapted to your environment</div><p>In Pigsty, deployment blueprint details are defined by the <a href=/docs/setup/config/><strong>inventory</strong></a>, which is the <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><strong><code>pigsty.yml</code></strong></a> configuration file. You can customize it through declarative configuration.</p><p>However, writing configuration files directly can be daunting for new users. To address this, we provide some ready-to-use configuration templates covering common usage scenarios.</p><p>Each template is a predefined <code>pigsty.yml</code> configuration file containing reasonable defaults suitable for specific scenarios.</p><p>You can choose a template as your customization starting point, then modify it as needed to meet your specific requirements.</p><hr><h2 id=using-templates>Using Templates</h2><p>Pigsty provides the <a href=https://github.com/pgsty/pigsty/blob/main/configure><strong><code>configure</code></strong></a> script as an optional configuration wizard that generates an <a href=/docs/setup/config/><strong>inventory</strong></a> with good defaults based on your environment and input.</p><p>Use <code>./configure -c &lt;conf></code> to specify a configuration template, where <code>&lt;conf></code> is the path relative to the <code>conf</code> directory (the <code>.yml</code> suffix can be omitted).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure                     <span style=color:#8f5902;font-style:italic># Default to meta.yml configuration template</span>
</span></span><span style=display:flex><span>./configure -c meta             <span style=color:#8f5902;font-style:italic># Explicitly specify meta.yml single-node template</span>
</span></span><span style=display:flex><span>./configure -c rich             <span style=color:#8f5902;font-style:italic># Use feature-rich template with all extensions and MinIO</span>
</span></span><span style=display:flex><span>./configure -c slim             <span style=color:#8f5902;font-style:italic># Use minimal single-node template</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use different database kernels</span>
</span></span><span style=display:flex><span>./configure -c pgsql            <span style=color:#8f5902;font-style:italic># Native PostgreSQL kernel, basic features (13~18)</span>
</span></span><span style=display:flex><span>./configure -c citus            <span style=color:#8f5902;font-style:italic># Citus distributed HA PostgreSQL (14~17)</span>
</span></span><span style=display:flex><span>./configure -c mssql            <span style=color:#8f5902;font-style:italic># Babelfish kernel, SQL Server protocol compatible (15)</span>
</span></span><span style=display:flex><span>./configure -c polar            <span style=color:#8f5902;font-style:italic># PolarDB PG kernel, Aurora/RAC style (15)</span>
</span></span><span style=display:flex><span>./configure -c ivory            <span style=color:#8f5902;font-style:italic># IvorySQL kernel, Oracle syntax compatible (18)</span>
</span></span><span style=display:flex><span>./configure -c mysql            <span style=color:#8f5902;font-style:italic># OpenHalo kernel, MySQL compatible (14)</span>
</span></span><span style=display:flex><span>./configure -c pgtde            <span style=color:#8f5902;font-style:italic># Percona PostgreSQL Server transparent encryption (18)</span>
</span></span><span style=display:flex><span>./configure -c oriole           <span style=color:#8f5902;font-style:italic># OrioleDB kernel, OLTP enhanced (17)</span>
</span></span><span style=display:flex><span>./configure -c supabase         <span style=color:#8f5902;font-style:italic># Supabase self-hosted configuration (15~18)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use multi-node HA templates</span>
</span></span><span style=display:flex><span>./configure -c ha/dual          <span style=color:#8f5902;font-style:italic># Use 2-node HA template</span>
</span></span><span style=display:flex><span>./configure -c ha/trio          <span style=color:#8f5902;font-style:italic># Use 3-node HA template</span>
</span></span><span style=display:flex><span>./configure -c ha/full          <span style=color:#8f5902;font-style:italic># Use 4-node HA template</span>
</span></span></code></pre></div><p>If no template is specified, Pigsty defaults to the <code>meta.yml</code> single-node configuration template.</p><hr><h2 id=template-list>Template List</h2><h3 id=main-templates>Main Templates</h3><p>The following are single-node configuration templates for installing Pigsty on a single server:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/meta/><strong><code>meta.yml</code></strong></a></td><td><strong>Default template</strong>, single-node PostgreSQL online installation</td></tr><tr><td><a href=/docs/conf/rich/><strong><code>rich.yml</code></strong></a></td><td>Feature-rich template with local repo, MinIO, and more examples</td></tr><tr><td><a href=/docs/conf/slim/><strong><code>slim.yml</code></strong></a></td><td>Minimal template, PostgreSQL only without monitoring and infrastructure</td></tr></tbody></table><h3 id=database-kernel-templates>Database Kernel Templates</h3><p>Templates for various database management systems and kernels:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/pgsql/><strong><code>pgsql.yml</code></strong></a></td><td>Native PostgreSQL kernel, basic features (13~18)</td></tr><tr><td><a href=/docs/conf/citus/><strong><code>citus.yml</code></strong></a></td><td>Citus distributed HA PostgreSQL (14~17)</td></tr><tr><td><a href=/docs/conf/mssql/><strong><code>mssql.yml</code></strong></a></td><td>Babelfish kernel, SQL Server protocol compatible (15)</td></tr><tr><td><a href=/docs/conf/polar/><strong><code>polar.yml</code></strong></a></td><td>PolarDB PG kernel, Aurora/RAC style (15)</td></tr><tr><td><a href=/docs/conf/ivory/><strong><code>ivory.yml</code></strong></a></td><td>IvorySQL kernel, Oracle syntax compatible (17)</td></tr><tr><td><a href=/docs/conf/mysql/><strong><code>mysql.yml</code></strong></a></td><td>OpenHalo kernel, MySQL compatible (14)</td></tr><tr><td><a href=/docs/conf/pgtde/><strong><code>pgtde.yml</code></strong></a></td><td>Percona PostgreSQL Server transparent encryption (17)</td></tr><tr><td><a href=/docs/conf/oriole/><strong><code>oriole.yml</code></strong></a></td><td>OrioleDB kernel, OLTP enhanced (17, Debian pkg pending)</td></tr><tr><td><a href=/docs/conf/supabase/><strong><code>supabase.yml</code></strong></a></td><td>Supabase self-hosted configuration (15~17)</td></tr></tbody></table><p>You can add more nodes later or use <a href=#ha-templates>HA templates</a> to plan your cluster from the start.</p><hr><h3 id=ha-templates>HA Templates</h3><p>You can configure Pigsty to run on multiple nodes, forming a high-availability (HA) cluster:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/dual/><strong><code>dual.yml</code></strong></a></td><td>2-node semi-HA deployment</td></tr><tr><td><a href=/docs/conf/trio/><strong><code>trio.yml</code></strong></a></td><td>3-node standard HA deployment</td></tr><tr><td><a href=/docs/conf/full/><strong><code>full.yml</code></strong></a></td><td>4-node standard deployment</td></tr><tr><td><a href=/docs/conf/safe/><strong><code>safe.yml</code></strong></a></td><td>4-node security-enhanced deployment with delayed replica</td></tr><tr><td><a href=/docs/conf/simu/><strong><code>simu.yml</code></strong></a></td><td>20-node production environment simulation</td></tr></tbody></table><hr><h3 id=application-templates>Application Templates</h3><p>You can use the following templates to run Docker applications/software:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/supabase><strong><code>supa.yml</code></strong></a></td><td>Start single-node Supabase</td></tr><tr><td><a href=/docs/conf/odoo/><strong><code>odoo.yml</code></strong></a></td><td>Start Odoo ERP system</td></tr><tr><td><a href=/docs/conf/dify/><strong><code>dify.yml</code></strong></a></td><td>Start Dify AI workflow system</td></tr><tr><td><a href=/docs/conf/electric/><strong><code>electric.yml</code></strong></a></td><td>Start Electric sync engine</td></tr></tbody></table><hr><h3 id=demo-templates>Demo Templates</h3><p>Besides main templates, Pigsty provides a set of demo templates for different scenarios:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/el/><strong><code>el.yml</code></strong></a></td><td>Full-parameter config file for EL 8/9 systems</td></tr><tr><td><a href=/docs/conf/debian/><strong><code>debian.yml</code></strong></a></td><td>Full-parameter config file for Debian/Ubuntu systems</td></tr><tr><td><strong><code>remote.yml</code></strong></td><td>Example config for monitoring remote PostgreSQL clusters or RDS</td></tr><tr><td><strong><code>redis.yml</code></strong></td><td>Redis cluster example configuration</td></tr><tr><td><a href=/docs/conf/minio/><strong><code>minio.yml</code></strong></a></td><td>3-node MinIO cluster example configuration</td></tr><tr><td><a href=/docs/conf/demo/><strong><code>demo.yml</code></strong></a></td><td>Configuration file for Pigsty <a href=https://demo.pigsty.io>public demo site</a></td></tr></tbody></table><hr><h3 id=build-templates>Build Templates</h3><p>The following configuration templates are for development and testing purposes:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><strong><code>build.yml</code></strong></td><td>Open source build config for EL 9/10, Debian 12/13, Ubuntu 22.04/24.04</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-4f710b6522c00bd4a1ee261283a935b7>5 - Use CMDB as Config Inventory</h1><div class=lead>Use PostgreSQL as a CMDB metabase to store Ansible inventory.</div><p>Pigsty allows you to use a PostgreSQL <strong>metabase</strong> as a dynamic configuration source, replacing static YAML configuration files for more powerful configuration management capabilities.</p><hr><h2 id=overview>Overview</h2><p><strong>CMDB</strong> (Configuration Management Database) is a method of storing configuration information in a database for management.</p><p>In Pigsty, the default configuration source is a static YAML file <code>pigsty.yml</code>,
which serves as Ansible&rsquo;s <a href=/docs/concept/iac/inventory/><strong>inventory</strong></a>.</p><p>This approach is simple and direct, but when infrastructure scales and requires complex, fine-grained management and external integration, a single static file becomes insufficient.</p><table><thead><tr><th style=text-align:center>Feature</th><th style=text-align:left>Static YAML File</th><th style=text-align:left>CMDB Metabase</th></tr></thead><tbody><tr><td style=text-align:center><strong>Querying</strong></td><td style=text-align:left>Manual search/grep</td><td style=text-align:left>SQL queries with any conditions, aggregation analysis</td></tr><tr><td style=text-align:center><strong>Versioning</strong></td><td style=text-align:left>Depends on Git or manual backup</td><td style=text-align:left>Database transactions, audit logs, time-travel snapshots</td></tr><tr><td style=text-align:center><strong>Access Control</strong></td><td style=text-align:left>File system permissions, coarse-grained</td><td style=text-align:left>PostgreSQL fine-grained access control</td></tr><tr><td style=text-align:center><strong>Concurrent Editing</strong></td><td style=text-align:left>Requires file locking or merge conflicts</td><td style=text-align:left>Database transactions naturally support concurrency</td></tr><tr><td style=text-align:center><strong>External Integration</strong></td><td style=text-align:left>Requires YAML parsing</td><td style=text-align:left>Standard SQL interface, easy integration with any language</td></tr><tr><td style=text-align:center><strong>Scalability</strong></td><td style=text-align:left>Difficult to maintain when file becomes too large</td><td style=text-align:left>Scales to physical limits</td></tr><tr><td style=text-align:center><strong>Dynamic Generation</strong></td><td style=text-align:left>Static file, changes require manual application</td><td style=text-align:left>Immediate effect, real-time configuration changes</td></tr></tbody></table><p>Pigsty provides the CMDB database schema in the sample database <a href=https://github.com/pgsty/pigsty/blob/main/conf/meta.yml#L52><strong><code>pg-meta.meta</code></strong></a> schema baseline definition.</p><hr><h2 id=how-it-works>How It Works</h2><p>The core idea of CMDB is to replace the static configuration file with a <strong>dynamic script</strong>.
Ansible supports using executable scripts as inventory, as long as the script outputs inventory data in JSON format.
When you enable CMDB, Pigsty creates a dynamic inventory script named <code>inventory.sh</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span>psql <span style=color:#4e9a06>${</span><span style=color:#000>METADB_URL</span><span style=color:#4e9a06>}</span> -AXtwc <span style=color:#4e9a06>&#39;SELECT text FROM pigsty.inventory;&#39;</span>
</span></span></code></pre></div><p>This script&rsquo;s function is simple: every time Ansible needs to read the inventory, it queries configuration data from the PostgreSQL database&rsquo;s <code>pigsty.inventory</code> view and returns it in JSON format.</p><p>The overall architecture is as follows:</p><pre class=mermaid>flowchart LR
    conf[&#34;bin/inventory_conf&#34;]
    tocmdb[&#34;bin/inventory_cmdb&#34;]
    load[&#34;bin/inventory_load&#34;]
    ansible[&#34;🚀 Ansible&#34;]

    subgraph static[&#34;📄 Static Config Mode&#34;]
        yml[(&#34;pigsty.yml&#34;)]
    end

    subgraph dynamic[&#34;🗄️ CMDB Dynamic Mode&#34;]
        sh[&#34;inventory.sh&#34;]
        cmdb[(&#34;PostgreSQL CMDB&#34;)]
    end

    conf --&gt;|&#34;switch&#34;| yml
    yml --&gt;|&#34;load config&#34;| load
    load --&gt;|&#34;write&#34;| cmdb
    tocmdb --&gt;|&#34;switch&#34;| sh
    sh --&gt; cmdb

    yml --&gt; ansible
    cmdb --&gt; ansible</pre><hr><h2 id=data-model>Data Model</h2><p>The CMDB database schema is defined in <a href=https://github.com/pgsty/pigsty/blob/main/files/cmdb.sql><code>files/cmdb.sql</code></a>, with all objects in the <code>pigsty</code> schema.</p><h3 id=core-tables>Core Tables</h3><table><thead><tr><th style=text-align:center>Table</th><th style=text-align:left>Description</th><th style=text-align:center>Primary Key</th></tr></thead><tbody><tr><td style=text-align:center><code>pigsty.group</code></td><td style=text-align:left>Cluster/group definitions, corresponds to Ansible groups</td><td style=text-align:center><code>cls</code></td></tr><tr><td style=text-align:center><code>pigsty.host</code></td><td style=text-align:left>Host definitions, belongs to a group</td><td style=text-align:center><code>(cls, ip)</code></td></tr><tr><td style=text-align:center><code>pigsty.global_var</code></td><td style=text-align:left>Global variables, corresponds to <code>all.vars</code></td><td style=text-align:center><code>key</code></td></tr><tr><td style=text-align:center><code>pigsty.group_var</code></td><td style=text-align:left>Group variables, corresponds to <code>all.children.&lt;cls>.vars</code></td><td style=text-align:center><code>(cls, key)</code></td></tr><tr><td style=text-align:center><code>pigsty.host_var</code></td><td style=text-align:left>Host variables, host-level variables</td><td style=text-align:center><code>(cls, ip, key)</code></td></tr><tr><td style=text-align:center><code>pigsty.default_var</code></td><td style=text-align:left>Default variable definitions, stores parameter metadata</td><td style=text-align:center><code>key</code></td></tr><tr><td style=text-align:center><code>pigsty.job</code></td><td style=text-align:left>Job records table, records executed tasks</td><td style=text-align:center><code>id</code></td></tr></tbody></table><h3 id=table-structure-details>Table Structure Details</h3><p><strong>Cluster Table <code>pigsty.group</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>     </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- Cluster name, primary key
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ctime</span><span style=color:#f8f8f8>   </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>-- Creation time
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8>   </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- Modification time
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Host Table <code>pigsty.host</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>    </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- Parent cluster
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ip</span><span style=color:#f8f8f8>     </span><span style=color:#000>INET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic>-- Host IP address
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ctime</span><span style=color:#f8f8f8>  </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8>  </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Global Variables Table <code>pigsty.global_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Variable name
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic>-- Variable value (JSON format)
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- Modification time
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Group Variables Table <code>pigsty.group_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Host Variables Table <code>pigsty.host_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>host_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ip</span><span style=color:#f8f8f8>    </span><span style=color:#000>INET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>FOREIGN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=core-views>Core Views</h3><p>CMDB provides a series of views for querying and displaying configuration data:</p><table><thead><tr><th style=text-align:center>View</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>pigsty.inventory</code></td><td style=text-align:left><strong>Core view</strong>: Generates Ansible dynamic inventory JSON</td></tr><tr><td style=text-align:center><code>pigsty.raw_config</code></td><td style=text-align:left>Raw configuration in JSON format</td></tr><tr><td style=text-align:center><code>pigsty.global_config</code></td><td style=text-align:left>Global config view, merges defaults and global vars</td></tr><tr><td style=text-align:center><code>pigsty.group_config</code></td><td style=text-align:left>Group config view, includes host list and group vars</td></tr><tr><td style=text-align:center><code>pigsty.host_config</code></td><td style=text-align:left>Host config view, merges group and host-level vars</td></tr><tr><td style=text-align:center><code>pigsty.pg_cluster</code></td><td style=text-align:left>PostgreSQL cluster view</td></tr><tr><td style=text-align:center><code>pigsty.pg_instance</code></td><td style=text-align:left>PostgreSQL instance view</td></tr><tr><td style=text-align:center><code>pigsty.pg_database</code></td><td style=text-align:left>PostgreSQL database definition view</td></tr><tr><td style=text-align:center><code>pigsty.pg_users</code></td><td style=text-align:left>PostgreSQL user definition view</td></tr><tr><td style=text-align:center><code>pigsty.pg_service</code></td><td style=text-align:left>PostgreSQL service definition view</td></tr><tr><td style=text-align:center><code>pigsty.pg_hba</code></td><td style=text-align:left>PostgreSQL HBA rules view</td></tr><tr><td style=text-align:center><code>pigsty.pg_remote</code></td><td style=text-align:left>Remote PostgreSQL instance view</td></tr></tbody></table><p><strong><code>pigsty.inventory</code></strong> is the core view that converts database configuration data to the JSON format required by Ansible:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87>text</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inventory</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=utility-scripts>Utility Scripts</h2><p>Pigsty provides three convenience scripts for managing CMDB:</p><table><thead><tr><th style=text-align:center>Script</th><th style=text-align:left>Function</th></tr></thead><tbody><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_load><code>bin/inventory_load</code></a></td><td style=text-align:left>Load YAML configuration file into PostgreSQL database</td></tr><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_cmdb><code>bin/inventory_cmdb</code></a></td><td style=text-align:left>Switch configuration source to CMDB (dynamic inventory script)</td></tr><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_conf><code>bin/inventory_conf</code></a></td><td style=text-align:left>Switch configuration source to static config file <code>pigsty.yml</code></td></tr></tbody></table><h3 id=inventory_load>inventory_load</h3><p>Parse and import YAML configuration file into CMDB:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_load                     <span style=color:#8f5902;font-style:italic># Load default pigsty.yml to default CMDB</span>
</span></span><span style=display:flex><span>bin/inventory_load -p /path/to/conf.yml  <span style=color:#8f5902;font-style:italic># Specify configuration file path</span>
</span></span><span style=display:flex><span>bin/inventory_load -d <span style=color:#4e9a06>&#34;postgres://...&#34;</span>   <span style=color:#8f5902;font-style:italic># Specify database connection URL</span>
</span></span><span style=display:flex><span>bin/inventory_load -n myconfig           <span style=color:#8f5902;font-style:italic># Specify configuration name</span>
</span></span></code></pre></div><p>The script performs the following operations:</p><ol><li>Clears existing data in the <code>pigsty</code> schema</li><li>Parses the YAML configuration file</li><li>Writes global variables to the <code>global_var</code> table</li><li>Writes cluster definitions to the <code>group</code> table</li><li>Writes cluster variables to the <code>group_var</code> table</li><li>Writes host definitions to the <code>host</code> table</li><li>Writes host variables to the <code>host_var</code> table</li></ol><p><strong>Environment Variables</strong></p><ul><li><code>PIGSTY_HOME</code>: Pigsty installation directory, defaults to <code>~/pigsty</code></li><li><code>METADB_URL</code>: Database connection URL, defaults to <code>service=meta</code></li></ul><h3 id=inventory_cmdb>inventory_cmdb</h3><p>Switch Ansible to use CMDB as the configuration source:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_cmdb
</span></span></code></pre></div><p>The script performs the following operations:</p><ol><li>Creates dynamic inventory script <code>${PIGSTY_HOME}/inventory.sh</code></li><li>Modifies <code>ansible.cfg</code> to set <code>inventory</code> to <code>inventory.sh</code></li></ol><p>The generated <code>inventory.sh</code> contents:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span>psql <span style=color:#4e9a06>${</span><span style=color:#000>METADB_URL</span><span style=color:#4e9a06>}</span> -AXtwc <span style=color:#4e9a06>&#39;SELECT text FROM pigsty.inventory;&#39;</span>
</span></span></code></pre></div><h3 id=inventory_conf>inventory_conf</h3><p>Switch back to using static YAML configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_conf
</span></span></code></pre></div><p>The script modifies <code>ansible.cfg</code> to set <code>inventory</code> back to <code>pigsty.yml</code>.</p><hr><h2 id=usage-workflow>Usage Workflow</h2><h3 id=first-time-cmdb-setup>First-time CMDB Setup</h3><ol><li><strong>Initialize CMDB schema</strong> (usually done automatically during Pigsty installation):</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -f ~/pigsty/files/cmdb.sql
</span></span></code></pre></div><ol start=2><li><strong>Load configuration to database</strong>:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_load
</span></span></code></pre></div><ol start=3><li><strong>Switch to CMDB mode</strong>:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_cmdb
</span></span></code></pre></div><ol start=4><li><strong>Verify configuration</strong>:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible all --list-hosts          <span style=color:#8f5902;font-style:italic># List all hosts</span>
</span></span><span style=display:flex><span>ansible-inventory --list          <span style=color:#8f5902;font-style:italic># View complete inventory</span>
</span></span></code></pre></div><h3 id=query-configuration>Query Configuration</h3><p>After enabling CMDB, you can flexibly query configuration using SQL:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all clusters
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all hosts in a cluster
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View global variables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View cluster variables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all PostgreSQL clusters
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_databases</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_users</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_cluster</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all PostgreSQL instances
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ins</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>seq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_instance</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all database definitions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_database</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all user definitions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>login</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>superuser</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_users</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=modify-configuration>Modify Configuration</h3><p>You can modify configuration directly via SQL:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Add new cluster
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Add cluster variable
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_cluster&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;pg-new&#34;&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Add host
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Add host variables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>host_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_seq&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;1&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_role&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;primary&#34;&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Modify global variable
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;new-value&#34;&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;some_param&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Delete cluster (cascades to hosts and variables)
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DELETE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-old&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Changes take effect immediately without reloading or restarting any service.</p><h3 id=switch-back-to-static-configuration>Switch Back to Static Configuration</h3><p>To switch back to static configuration file mode:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_conf
</span></span></code></pre></div><hr><h2 id=advanced-usage>Advanced Usage</h2><h3 id=export-configuration>Export Configuration</h3><p>Export CMDB configuration to YAML format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>=</span>meta -AXtwc <span style=color:#4e9a06>&#34;SELECT jsonb_pretty(jsonb_build_object(&#39;all&#39;, jsonb_build_object(&#39;children&#39;, children, &#39;vars&#39;, vars))) FROM pigsty.raw_config;&#34;</span>
</span></span></code></pre></div><p>Or use the <code>ansible-inventory</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-inventory --list --yaml &gt; exported_config.yml
</span></span></code></pre></div><h3 id=configuration-auditing>Configuration Auditing</h3><p>Track configuration changes using the <code>mtime</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View recently modified global variables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View changes after a specific time
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-01-01&#39;</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>timestamptz</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=integration-with-external-systems>Integration with External Systems</h3><p>CMDB uses standard PostgreSQL, making it easy to integrate with other systems:</p><ul><li><strong>Web Management Interface</strong>: Expose configuration data through REST API (e.g., PostgREST)</li><li><strong>CI/CD Pipelines</strong>: Read/write database directly in deployment scripts</li><li><strong>Monitoring & Alerting</strong>: Generate monitoring rules based on configuration data</li><li><strong>ITSM Systems</strong>: Sync with enterprise CMDB systems</li></ul><hr><h2 id=considerations>Considerations</h2><ol><li><p><strong>Data Consistency</strong>: After modifying configuration, you need to re-run the corresponding Ansible playbooks to apply changes to the actual environment</p></li><li><p><strong>Backup</strong>: Configuration data in CMDB is critical, ensure regular backups</p></li><li><p><strong>Permissions</strong>: Configure appropriate database access permissions for CMDB to avoid accidental modifications</p></li><li><p><strong>Transactions</strong>: When making batch configuration changes, perform them within a transaction for rollback on errors</p></li><li><p><strong>Connection Pooling</strong>: The <code>inventory.sh</code> script creates a new connection on each execution; if Ansible runs frequently, consider using connection pooling</p></li></ol><hr><h2 id=summary>Summary</h2><p>CMDB is Pigsty&rsquo;s advanced configuration management solution, suitable for scenarios requiring large-scale cluster management, complex queries, external integration, or fine-grained access control. By storing configuration data in PostgreSQL, you can fully leverage the database&rsquo;s powerful capabilities to manage infrastructure configuration.</p><table><thead><tr><th style=text-align:center>Feature</th><th style=text-align:center>Description</th></tr></thead><tbody><tr><td style=text-align:center><strong>Storage</strong></td><td style=text-align:center>PostgreSQL <code>pigsty</code> schema</td></tr><tr><td style=text-align:center><strong>Dynamic Inventory</strong></td><td style=text-align:center><code>inventory.sh</code> script</td></tr><tr><td style=text-align:center><strong>Config Load</strong></td><td style=text-align:center><code>bin/inventory_load</code></td></tr><tr><td style=text-align:center><strong>Switch to CMDB</strong></td><td style=text-align:center><code>bin/inventory_cmdb</code></td></tr><tr><td style=text-align:center><strong>Switch to YAML</strong></td><td style=text-align:center><code>bin/inventory_conf</code></td></tr><tr><td style=text-align:center><strong>Core View</strong></td><td style=text-align:center><code>pigsty.inventory</code></td></tr></tbody></table></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Email - Vonng" aria-label="Email - Vonng"><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label="Email - Vonng"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=WeChat aria-label=WeChat><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=WeChat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Discussion aria-label=Discussion><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=Discussion><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Repo aria-label=Repo><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=Repo><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>