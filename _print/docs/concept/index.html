<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.io/docs/concept/><link rel=alternate type=application/rss+xml href=https://pigsty.io/docs/concept/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Concepts | PIGSTY</title><meta name=description content="Understand Pigsty's core concepts, architecture design, and principles. Master high availability, backup recovery, security compliance, and other key capabilities."><meta property="og:url" content="https://pigsty.io/docs/concept/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="Concepts"><meta property="og:description" content="Understand Pigsty's core concepts, architecture design, and principles. Master high availability, backup recovery, security compliance, and other key capabilities."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Concepts"><meta itemprop=description content="Understand Pigsty's core concepts, architecture design, and principles. Master high availability, backup recovery, security compliance, and other key capabilities."><meta itemprop=dateModified content="2026-01-15T11:51:06+08:00"><meta itemprop=wordCount content="1186"><meta itemprop=keywords content="Concept,PIGSTY"><meta name=twitter:card content="summary"><meta name=twitter:title content="Concepts"><meta name=twitter:description content="Understand Pigsty's core concepts, architecture design, and principles. Master high availability, backup recovery, security compliance, and other key capabilities."><link rel=preload href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css as=style integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><link href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css rel=stylesheet integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Ver</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.cc>Pigsty 中文网站</a></li><li><a class=dropdown-item href=https://doc.pgsty.com>Pigsty v3.7 Doc</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc>Pigsty v3.4 Doc</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 Doc</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 Doc</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch Language / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d757e151050fd40088751a74721d74f6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:window.location.href="https://pigsty.cc"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/concept/>Return to the regular view of this page</a>.</p></div><h1 class=title>Concepts</h1><div class=lead>Understand Pigsty&rsquo;s core concepts, architecture design, and principles. Master high availability, backup recovery, security compliance, and other key capabilities.</div><ul><li>1: <a href=#pg-5f0248151627a7f914932011cbe64c98>Architecture</a></li><ul><li>1.1: <a href=#pg-66767bf2f054756113e02343d62b9774>Nodes</a></li><li>1.2: <a href=#pg-d65561d0ed395a21fc6b7dd2654dc081>Infrastructure</a></li><li>1.3: <a href=#pg-c777ff17702df77ebc33dadeb81e4174>PGSQL Arch</a></li></ul><li>2: <a href=#pg-d1b03f22fc5f90cf6ddcf42073d7603d>ER Model</a></li><ul><li>2.1: <a href=#pg-2ad10e50acca12cdeaaf406b2cf23f3b>E-R Model of Infra Cluster</a></li><li>2.2: <a href=#pg-97ed05d79e93eabb25565a36bc328883>E-R Model of PostgreSQL Cluster</a></li><li>2.3: <a href=#pg-5a875c30b5ea163b13415e0cf143a46f>E-R Model of Etcd Cluster</a></li><li>2.4: <a href=#pg-c495cfba1010bd7cf73164bea4ebc4f3>E-R Model of MinIO Cluster</a></li><li>2.5: <a href=#pg-0de22cd0f8c383fe4e1ef5a4eb6b5440>E-R Model of Redis Cluster</a></li></ul><li>3: <a href=#pg-d1070a4639ccf6fd6d12d222bf92c497>Infra as Code</a></li><ul><li>3.1: <a href=#pg-6b8b3debf71b9a47be1364eba07a65ae>Inventory</a></li><li>3.2: <a href=#pg-c48a7025a948ffe27199cd10986e517a>Configure</a></li><li>3.3: <a href=#pg-e42d80439da940091a403ada6ca968af>Parameters</a></li><li>3.4: <a href=#pg-a71a0b133f9617fabea630bbd56757f4>Conf Templates</a></li><li>3.5: <a href=#pg-4f710b6522c00bd4a1ee261283a935b7>Use CMDB as Config Inventory</a></li></ul><li>4: <a href=#pg-611f3486b406a3e3cb452cbc6af4b548>High Availability</a></li><ul><li>4.1: <a href=#pg-928294eb73615de574523762c3a1ab07>RPO Trade-offs</a></li><li>4.2: <a href=#pg-95882b9440d286103890671f368774b6>RTO Trade-offs</a></li><li>4.3: <a href=#pg-439a629138018b9fe8b5a1c8323745be>Failure Model</a></li><ul><li>4.3.1: <a href=#pg-358e309cdbb4cb46571e2cba4875ac34>Model of Patroni Passive Failure</a></li><li>4.3.2: <a href=#pg-42b7950723c66bacccc650303281acc3>Model of Patroni Active Failure</a></li></ul><li>4.4: <a href=#pg-895a94576239d65b824c6e6ae06deb76>Service Access</a></li></ul><li>5: <a href=#pg-397dc822a55434d21cd8ee3a6f846291>Point-in-Time Recovery</a></li><li>6: <a href=#pg-640213fc983ef0aae5180ea5bbbfb2d3>Monitoring System</a></li><li>7: <a href=#pg-7ed29cc39a1f06050bef0386106a93cc>Security and Compliance</a></li><ul><li>7.1: <a href=#pg-8b790153f8312a89aef83b802d30c481>Local CA</a></li><li>7.2: <a href=#pg-42af3045c7ebee43d7c66fbe8a4cd267>Seven-Layer Security Model</a></li><li>7.3: <a href=#pg-6a3742ed82b65fb5a722f76337bf835d>Access Control</a></li></ul></ul><div class=content><p>Pigsty is a portable, extensible open-source PostgreSQL distribution for building production-grade database services in local environments with declarative configuration and automation. It has a vast ecosystem providing a complete set of tools, scripts, and best practices to bring PostgreSQL to enterprise-grade RDS service levels.</p><p>Pigsty&rsquo;s name comes from <strong>P</strong>ostgreSQL <strong>I</strong>n <strong>G</strong>reat <strong>STY</strong>le, also understood as <strong>P</strong>ostgres, <strong>I</strong>nfras, <strong>G</strong>raphics, <strong>S</strong>ervice, <strong>T</strong>oolbox, it&rsquo;s all <strong>Y</strong>ours—a self-hosted PostgreSQL solution with graphical monitoring that&rsquo;s all yours. You can find the source code on <a href=https://github.com/pgsty/pigsty><strong>GitHub</strong></a>, visit the <a href=https://pigsty.io><strong>official documentation</strong></a> for more information, or experience the <a href=/docs/setup/webui><strong>Web UI</strong></a> in the <a href=https://demo.pigsty.io><strong>online demo</strong></a>.</p><p><a href=/docs/deploy/sandbox><img src=/img/pigsty/banner.png alt=pigsty-banner></a></p><hr><h2 id=why-pigsty-what-can-it-do>Why Pigsty? What Can It Do?</h2><p>PostgreSQL is a sufficiently perfect database kernel, but it needs more tools and systems to become a truly excellent database service. In production environments, you need to manage every aspect of your database: high availability, backup recovery, monitoring alerts, access control, parameter tuning, extension installation, connection pooling, load balancing&mldr;</p><p>Wouldn&rsquo;t it be easier if all this complex operational work could be automated? This is precisely why Pigsty was created.</p><p>Pigsty provides:</p><ul><li><p><strong>Out-of-the-Box PostgreSQL Distribution</strong></p><p>Pigsty deeply integrates <a href=https://pgext.cloud/list><strong>440+ extensions</strong></a> from the PostgreSQL ecosystem, providing out-of-the-box distributed, time-series, geographic, spatial, graph, vector, search, and other multi-modal database capabilities. From kernel to RDS distribution, providing production-grade database services for versions 13-18 on EL/Debian/Ubuntu.</p></li><li><p><strong>Self-Healing High Availability Architecture</strong></p><p>A <a href=/docs/concept/ha><strong>high availability architecture</strong></a> built on Patroni, Etcd, and HAProxy enables automatic failover for hardware failures with seamless traffic handoff. Primary failure recovery time RTO &lt; 45s, data recovery point RPO ≈ 0. You can perform rolling maintenance and upgrades on the entire cluster without application coordination.</p></li><li><p><strong>Complete Point-in-Time Recovery Capability</strong></p><p>Based on pgBackRest and optional MinIO cluster, providing out-of-the-box <a href=/docs/concept/pitr><strong>PITR point-in-time recovery</strong></a> capability. Giving you the ability to quickly return to any point in time, protecting against software defects and accidental data deletion.</p></li><li><p><strong>Flexible Service Access and Traffic Management</strong></p><p>Through HAProxy, Pgbouncer, and VIP, providing flexible <a href=/docs/pgsql/misc/svc><strong>service access</strong></a> patterns for read-write separation, connection pooling, and automatic routing. Delivering stable, reliable, auto-routing, transaction-pooled high-performance database services.</p></li><li><p><strong>Stunning Observability</strong></p><p>A modern observability stack based on Prometheus and Grafana provides unparalleled <a href=/docs/concept/monitor><strong>monitoring best practices</strong></a>. Over three thousand types of monitoring metrics describe every aspect of the system, from global dashboards to CRUD operations on individual objects.</p></li><li><p><strong>Declarative Configuration Management</strong></p><p>Following the <a href=/docs/concept/iac><strong>Infrastructure as Code</strong></a> philosophy, using declarative configuration to describe the entire environment. You just tell Pigsty &ldquo;what kind of database cluster you want&rdquo; without worrying about how to implement it—the system automatically adjusts to the desired state.</p></li><li><p><strong>Modular Architecture Design</strong></p><p>A modular <a href=/docs/concept/arch><strong>architecture</strong></a> design that can be freely combined to suit different scenarios. Beyond the core PostgreSQL module, it also provides optional modules for Redis, MinIO, Etcd, FerretDB, and support for various PG-compatible kernels.</p></li><li><p><strong>Solid Security Best Practices</strong></p><p>Industry-leading security best practices: self-signed CA certificate encryption, AES encrypted backups, scram-sha-256 encrypted passwords, out-of-the-box ACL model, HBA rule sets following the principle of least privilege, ensuring data security.</p></li><li><p><strong>Simple and Easy Deployment</strong></p><p>All dependencies are pre-packaged for one-click installation in environments without internet access. Local sandbox environments can run on micro VMs with 1 core and 2GB RAM, providing functionality identical to production environments. Provides Vagrant-based local sandboxes and Terraform-based cloud deployments.</p></li></ul><hr><h2 id=what-pigsty-is-not>What Pigsty Is Not</h2><p>Pigsty is not a traditional, all-encompassing PaaS (Platform as a Service) system.</p><ul><li><p><strong>Pigsty doesn&rsquo;t provide basic hardware resources</strong>. It runs on nodes you provide, whether bare metal, VMs, or cloud instances, but it doesn&rsquo;t create or manage these resources itself (though it provides Terraform templates to simplify cloud resource preparation).</p></li><li><p><strong>Pigsty is not a container orchestration system</strong>. It runs directly on the operating system, not requiring Kubernetes or Docker as infrastructure. Of course, it can coexist with these systems and provides a Docker module for running stateless applications.</p></li><li><p><strong>Pigsty is not a general database management tool</strong>. It focuses on PostgreSQL and its ecosystem. While it also supports peripheral components like Redis, Etcd, and MinIO, the core is always built around PostgreSQL.</p></li><li><p><strong>Pigsty won&rsquo;t lock you in</strong>. It&rsquo;s built on open-source components, doesn&rsquo;t modify the PostgreSQL kernel, and introduces no proprietary protocols. You can continue using your well-managed PostgreSQL clusters anytime without Pigsty.</p></li></ul><p>Pigsty doesn&rsquo;t restrict how you should or shouldn&rsquo;t build your database services. For example:</p><ul><li>Pigsty provides good parameter defaults and configuration templates, but you can override any parameter.</li><li>Pigsty provides a declarative API, but you can still use underlying tools (Ansible, Patroni, pgBackRest, etc.) for manual management.</li><li>Pigsty can manage the complete lifecycle, or you can use only its monitoring system to observe existing database instances or RDS.</li></ul><p>Pigsty provides a different level of abstraction than the hardware layer—it works at the database service layer, focusing on how to deliver PostgreSQL at its best, rather than reinventing the wheel.</p><hr><h2 id=evolution-of-postgresql-deployment>Evolution of PostgreSQL Deployment</h2><p>To understand Pigsty&rsquo;s value, let&rsquo;s review the evolution of PostgreSQL deployment approaches.</p><h3 id=manual-deployment-era>Manual Deployment Era</h3><p>In traditional deployment, DBAs needed to manually install and configure PostgreSQL, manually set up replication, manually configure monitoring, and manually handle failures. The problems with this approach are obvious:</p><ul><li><strong>Low efficiency</strong>: Each instance requires repeating many manual operations, prone to errors.</li><li><strong>Lack of standardization</strong>: Databases configured by different DBAs can vary greatly, making maintenance difficult.</li><li><strong>Poor reliability</strong>: Failure handling depends on manual intervention, with long recovery times and susceptibility to human error.</li><li><strong>Weak observability</strong>: Lack of unified monitoring, making problem discovery and diagnosis difficult.</li></ul><h3 id=managed-database-era>Managed Database Era</h3><p>To solve these problems, cloud providers offer managed database services (RDS). Cloud RDS does solve some operational issues, but also brings new challenges:</p><ul><li><strong>High cost</strong>: Managed services typically charge multiples to dozens of times hardware cost as &ldquo;service fees.&rdquo;</li><li><strong>Vendor lock-in</strong>: Migration is difficult, tied to specific cloud platforms.</li><li><strong>Limited functionality</strong>: Cannot use certain advanced features, extensions are restricted, parameter tuning is limited.</li><li><strong>Data sovereignty</strong>: Data stored in the cloud, reducing autonomy and control.</li></ul><h3 id=local-rds-era>Local RDS Era</h3><p>Pigsty represents a third approach: building database services in local environments that match or exceed cloud RDS.</p><p>Pigsty combines the advantages of both approaches:</p><ul><li><strong>High automation</strong>: One-click deployment, automatic configuration, self-healing failures—as convenient as cloud RDS.</li><li><strong>Complete autonomy</strong>: Runs on your own infrastructure, data completely in your own hands.</li><li><strong>Extremely low cost</strong>: Run enterprise-grade database services at near-pure-hardware costs.</li><li><strong>Complete functionality</strong>: Unlimited use of PostgreSQL&rsquo;s full capabilities and ecosystem extensions.</li><li><strong>Open architecture</strong>: Based on open-source components, no vendor lock-in, free to migrate anytime.</li></ul><p>This approach is particularly suitable for:</p><ul><li><strong>Private and hybrid clouds</strong>: Enterprises needing to run databases in local environments.</li><li><strong>Cost-sensitive users</strong>: Organizations looking to reduce database TCO.</li><li><strong>High-security scenarios</strong>: Critical data requiring complete autonomy and control.</li><li><strong>PostgreSQL power users</strong>: Scenarios requiring advanced features and rich extensions.</li><li><strong>Development and testing</strong>: Quickly setting up databases locally that match production environments.</li></ul><hr><h2 id=whats-next>What&rsquo;s Next</h2><p>Now that you understand Pigsty&rsquo;s basic concepts, you can:</p><ul><li>View <a href=/docs/concept/arch><strong>System Architecture</strong></a> to understand Pigsty&rsquo;s modular design</li><li>Learn about <a href=/docs/concept/model><strong>Cluster Model</strong></a> to understand how Pigsty organizes database clusters</li><li>Study <a href=/docs/concept/ha><strong>High Availability</strong></a> mechanisms to master self-healing principles</li><li>Explore <a href=/docs/concept/pitr><strong>Point-in-Time Recovery</strong></a> to learn how to handle data deletion</li><li>Research <a href=/docs/pgsql/misc/svc><strong>Service Access</strong></a> to understand stable database service delivery</li><li>Experience <a href=/docs/concept/iac><strong>Infrastructure as Code</strong></a> to feel the magic of declarative configuration</li><li>Or directly start <a href=/docs/setup/install><strong>Quick Start</strong></a> to deploy your first Pigsty environment in minutes</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5f0248151627a7f914932011cbe64c98>1 - Architecture</h1><div class=lead>Pigsty&rsquo;s modular architecture—declarative composition, on-demand customization, flexible deployment.</div><p>Pigsty uses a <strong>modular architecture</strong> with a <strong>declarative interface</strong>. You can <a href=/docs/deploy/planning#common-solutions><strong>freely combine modules like building blocks</strong></a> as needed.</p><ul><li>Pigsty adopts a <a href=/docs/deploy/planning><strong>modular design</strong></a> that can be freely combined and used on demand (use one or all) to suit different scenarios.</li><li>Pigsty uses <a href=/docs/concept/iac/inventory><strong>config inventory</strong></a> and <a href=/docs/concept/iac/parameter><strong>config parameters</strong></a> to describe the entire deployment environment, implemented via <a href=/docs/setup/playbook><strong>Ansible playbooks</strong></a>.</li><li>Pigsty can run on any <a href=/docs/concept/arch/node><strong>node</strong></a>—physical or virtual—as long as the OS is <a href=/docs/ref/linux><strong>compatible</strong></a>.</li></ul><hr><h2 id=modules>Modules</h2><p>Pigsty uses a modular design with six main default modules: <a href=/docs/pgsql><code>PGSQL</code></a>, <a href=/docs/infra><code>INFRA</code></a>, <a href=/docs/node><code>NODE</code></a>, <a href=/docs/etcd><code>ETCD</code></a>, <a href=/docs/redis><code>REDIS</code></a>, and <a href=/docs/minio><code>MINIO</code></a>.</p><ul><li><a href=/docs/pgsql><code>PGSQL</code></a>: Self-healing HA Postgres clusters powered by Patroni, Pgbouncer, HAproxy, PgBackrest, and more.</li><li><a href=/docs/infra><code>INFRA</code></a>: Local software repo, Nginx, Grafana, Victoria, AlertManager, Blackbox Exporter—the complete observability stack.</li><li><a href=/docs/node><code>NODE</code></a>: Tune nodes to desired state—hostname, timezone, NTP, ssh, sudo, haproxy, docker, vector, keepalived.</li><li><a href=/docs/etcd><code>ETCD</code></a>: Distributed key-value store as DCS for HA Postgres clusters: consensus leader election/config management/service discovery.</li><li><a href=/docs/redis><code>REDIS</code></a>: Redis servers supporting standalone primary-replica, sentinel, and cluster modes with full monitoring.</li><li><a href=/docs/minio><code>MINIO</code></a>: S3-compatible simple object storage that can serve as an optional backup destination for PG databases.</li></ul><p>You can declaratively compose them freely. If you only want host monitoring, installing the <a href=/docs/infra><code>INFRA</code></a> module on infrastructure nodes and the <a href=/docs/node><code>NODE</code></a> module on managed nodes is sufficient.
The <a href=/docs/etcd><code>ETCD</code></a> and <a href=/docs/pgsql><code>PGSQL</code></a> modules are used to build HA PG clusters—installing these modules on multiple nodes automatically forms a high-availability database cluster.
You can reuse Pigsty infrastructure and develop your own modules; <a href=/docs/redis><code>REDIS</code></a> and <a href=/docs/minio><code>MINIO</code></a> can serve as examples. More modules will be added—preliminary support for Mongo and MySQL is already on the roadmap.</p><p>Note that all modules depend strongly on the <code>NODE</code> module: in Pigsty, nodes must first have the <code>NODE</code> module installed to be managed before deploying other modules.
When nodes (by default) use the local software repo for installation, the <code>NODE</code> module has a weak dependency on the <code>INFRA</code> module. Therefore, the admin/infrastructure nodes with the <code>INFRA</code> module complete the bootstrap process in the <a href=/docs/setup/playbook><code>deploy.yml</code></a> playbook, resolving the circular dependency.</p><p><a href=/docs/deploy/sandbox><img src=/img/pigsty/sandbox.png alt=pigsty-sandbox></a></p><hr><h2 id=standalone-installation>Standalone Installation</h2><p>By default, Pigsty installs on a single <strong>node</strong> (physical/virtual machine). The <a href=https://github.com/pgsty/pigsty/blob/main/deploy.yml><code>deploy.yml</code></a> playbook installs <a href=/docs/infra><code>INFRA</code></a>, <a href=/docs/etcd><code>ETCD</code></a>, <a href=/docs/pgsql><code>PGSQL</code></a>, and optionally <a href=/docs/minio><code>MINIO</code></a> modules on the <strong>current</strong> node,
giving you a fully-featured observability stack (Prometheus, Grafana, Loki, AlertManager, PushGateway, BlackboxExporter, etc.), plus a built-in PostgreSQL standalone instance as a CMDB, ready to use out of the box (cluster name <code>pg-meta</code>, database name <code>meta</code>).</p><p>This node now has a complete self-monitoring system, visualization tools, and a Postgres database with PITR auto-configured (HA unavailable since you only have one node). You can use this node as a devbox, for testing, running demos, and data visualization/analysis. Or, use this node as an admin node to deploy and manage more nodes!</p><p><a href=/docs/infra/><img src=/img/pigsty/arch.png alt=pigsty-arch></a></p><hr><h2 id=monitoring>Monitoring</h2><p>The installed <a href=#standalone-installation>standalone meta node</a> can serve as an <strong>admin node</strong> and <strong>monitoring center</strong> to bring more nodes and database servers under its supervision and control.</p><p>Pigsty&rsquo;s monitoring system can be used independently. If you want to install the Prometheus/Grafana observability stack, Pigsty provides best practices!
It offers rich dashboards for <a href=https://demo.pigsty.io/d/node-overview>host nodes</a> and <a href=https://demo.pigsty.io/d/pgsql-overview>PostgreSQL databases</a>.
Whether or not these nodes or PostgreSQL servers are managed by Pigsty, with simple configuration, you immediately have a production-grade monitoring and alerting system, bringing existing hosts and PostgreSQL under management.</p><p><a href=/docs/pgsql/monitor/dashboard><img src=/img/pigsty/dashboard.jpg alt=pigsty-dashboard.jpg></a></p><hr><h2 id=ha-postgresql-clusters>HA PostgreSQL Clusters</h2><p>Pigsty helps you <strong>own</strong> your own production-grade HA PostgreSQL RDS service anywhere.</p><p>To create such an HA PostgreSQL cluster/RDS service, you simply describe it with a short config and run the playbook to create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bin/pgsql-add pg-test  <span style=color:#8f5902;font-style:italic># Initialize cluster &#39;pg-test&#39;</span>
</span></span></code></pre></div><p>In less than 10 minutes, you&rsquo;ll have a PostgreSQL database cluster with service access, monitoring, backup PITR, and HA fully configured.</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>Hardware failures are covered by the self-healing HA architecture provided by patroni, etcd, and haproxy—in case of primary failure, automatic failover executes within 45 seconds by default.
Clients don&rsquo;t need to modify config or restart applications: Haproxy uses patroni health checks for traffic distribution, and read-write requests are automatically routed to the new cluster primary, avoiding split-brain issues.
This process is seamless—for example, in case of replica failure or planned switchover, clients experience only a momentary flash of the current query.</p><p>Software failures, human errors, and datacenter-level disasters are covered by pgbackrest and the optional <a href=/docs/minio>MinIO</a> cluster. This provides local/cloud PITR capabilities and, in case of datacenter failure, offers cross-region replication and disaster recovery.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-66767bf2f054756113e02343d62b9774>1.1 - Nodes</h1><div class=lead>A node is an abstraction of hardware/OS resources—physical machines, bare metal, VMs, or containers/pods.</div><p>A <strong>node</strong> is an abstraction of hardware resources and operating systems. It can be a physical machine, bare metal, virtual machine, or container/pod.</p><p>Any machine running a <a href=/docs/ref/linux><strong>Linux OS</strong></a> (with systemd daemon) and standard CPU/memory/disk/network resources can be treated as a node.</p><p>Nodes can have <a href=/docs/ref/module><strong>modules</strong></a> installed. Pigsty has several node types, distinguished by which modules are deployed:</p><table class=full-width><thead><tr><th style=text-align:center>Type</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><a href=#regular-node><strong>Regular Node</strong></a></td><td style=text-align:left>A node managed by Pigsty</td></tr><tr><td style=text-align:center><a href=#admin-node><strong>ADMIN Node</strong></a></td><td style=text-align:left>The node that runs Ansible to issue management commands</td></tr><tr><td style=text-align:center><a href=#infra-node><strong>INFRA Node</strong></a></td><td style=text-align:left>Nodes with the <a href=/docs/infra/><strong>INFRA</strong></a> module installed</td></tr><tr><td style=text-align:center><a href=#etcd-node><strong>ETCD Node</strong></a></td><td style=text-align:left>Nodes with the <a href=/docs/etcd/><strong>ETCD</strong></a> module for DCS</td></tr><tr><td style=text-align:center><a href=#minio-node><strong>MINIO Node</strong></a></td><td style=text-align:left>Nodes with the <a href=/docs/minio/><strong>MINIO</strong></a> module for object storage</td></tr><tr><td style=text-align:center><a href=#pgsql-node><strong>PGSQL Node</strong></a></td><td style=text-align:left>Nodes with the <a href=/docs/pgsql/><strong>PGSQL</strong></a> module installed</td></tr><tr><td style=text-align:center>&mldr;</td><td style=text-align:left>Nodes with other modules&mldr;</td></tr></tbody></table><p>In a <a href=/docs/setup/install><strong>singleton</strong></a> Pigsty deployment, multiple roles converge on one node: it serves as the regular node, admin node, infra node, ETCD node, and database node simultaneously.</p><hr><h2 id=regular-node>Regular Node</h2><p>Nodes managed by Pigsty can have modules installed. The <a href=/docs/node/playbook#nodeyml><strong><code>node.yml</code></strong></a> playbook configures nodes to the desired state.
A regular node may run the following services:</p><table class=full-width><thead><tr><th style=text-align:center>Component</th><th style=text-align:center>Port</th><th>Description</th><th>Status</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>node_exporter</code></strong></td><td style=text-align:center><code>9100</code></td><td>Host metrics exporter</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>haproxy</code></strong></td><td style=text-align:center><code>9101</code></td><td>HAProxy load balancer (admin port)</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>vector</code></strong></td><td style=text-align:center><code>9598</code></td><td>Log collection agent</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>docker</code></strong></td><td style=text-align:center><code>9323</code></td><td>Container runtime support</td><td>Optional</td></tr><tr><td style=text-align:center><strong><code>keepalived</code></strong></td><td style=text-align:center><code>n/a</code></td><td>L2 VIP for node cluster</td><td>Optional</td></tr><tr><td style=text-align:center><strong><code>keepalived_exporter</code></strong></td><td style=text-align:center><code>9650</code></td><td>Keepalived status monitor</td><td>Optional</td></tr></tbody></table><p>Here, <code>node_exporter</code> exposes host metrics, <code>vector</code> sends logs to the collection system, and <code>haproxy</code> provides load balancing. These three are enabled by default.
<a href=/docs/docker><strong>Docker</strong></a>, <code>keepalived</code>, and <code>keepalived_exporter</code> are optional and can be enabled as needed.</p><hr><h2 id=admin-node>ADMIN Node</h2><p>A Pigsty deployment has exactly <strong>one admin node</strong>—the node that runs Ansible playbooks and issues control/deployment commands.</p><p>This node has <code>ssh/sudo</code> access to all other nodes. Admin node security is critical; ensure access is strictly controlled.</p><p>During <a href=/docs/setup/install><strong>single-node installation</strong></a> and <a href=/docs/concept/iac/configure><strong>configuration</strong></a>, the current node becomes the admin node.
However, alternatives exist. For example, if your laptop can SSH to all managed nodes and has Ansible installed, it can serve as the admin node—though this isn&rsquo;t recommended for production.</p><p>For instance, you might use your laptop to manage a Pigsty VM in the cloud. In this case, your laptop is the admin node.</p><p>In serious production environments, the admin node is typically 1-2 dedicated DBA machines. In resource-constrained setups, <a href=#infra-node><strong>INFRA nodes</strong></a> often double as admin nodes since all INFRA nodes have Ansible installed by default.</p><hr><h2 id=infra-node>INFRA Node</h2><p>A Pigsty deployment may have <strong>1</strong> or more INFRA nodes; large production environments typically have <strong>2-3</strong>.</p><p>The <strong><code>infra</code></strong> group in the <a href=/docs/concept/iac/inventory><strong>inventory</strong></a> defines which nodes are INFRA nodes. These nodes run the <a href=/docs/infra/><strong>INFRA</strong></a> module with these components:</p><table class=full-width><thead><tr><th style=text-align:center>Component</th><th style=text-align:center>Port</th><th>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>nginx</code></td><td style=text-align:center><code>80/443</code></td><td>Web UI, local software repository</td></tr><tr><td style=text-align:center><code>grafana</code></td><td style=text-align:center><code>3000</code></td><td>Visualization platform</td></tr><tr><td style=text-align:center><code>victoriaMetrics</code></td><td style=text-align:center><code>8428</code></td><td>Time-series database (metrics)</td></tr><tr><td style=text-align:center><code>victoriaLogs</code></td><td style=text-align:center><code>9428</code></td><td>Log collection server</td></tr><tr><td style=text-align:center><code>victoriaTraces</code></td><td style=text-align:center><code>10428</code></td><td>Trace collection server</td></tr><tr><td style=text-align:center><code>vmalert</code></td><td style=text-align:center><code>8880</code></td><td>Alerting and derived metrics</td></tr><tr><td style=text-align:center><code>alertmanager</code></td><td style=text-align:center><code>9059</code></td><td>Alert aggregation and routing</td></tr><tr><td style=text-align:center><code>blackbox_exporter</code></td><td style=text-align:center><code>9115</code></td><td>Blackbox probing (ping nodes/VIPs)</td></tr><tr><td style=text-align:center><code>dnsmasq</code></td><td style=text-align:center><code>53</code></td><td>Internal DNS resolution</td></tr><tr><td style=text-align:center><code>chronyd</code></td><td style=text-align:center><code>123</code></td><td>NTP time server</td></tr><tr><td style=text-align:center><code>ansible</code></td><td style=text-align:center><code>-</code></td><td>Playbook execution</td></tr></tbody></table><p>Nginx serves as the module&rsquo;s entry point, providing the web UI and local software repository.
With multiple INFRA nodes, services on each are independent, but you can access all monitoring data sources from any INFRA node&rsquo;s Grafana.</p><p>Note: The <a href=/docs/infra><strong>INFRA</strong></a> module is licensed under <a href=/docs/about/license#pigsty-special-module><strong>AGPLv3</strong></a> due to Grafana.
As an exception, if you only use Nginx/Victoria components without Grafana, you&rsquo;re effectively under <a href=/docs/about/license#pigsty-license><strong>Apache-2.0</strong></a>.</p><hr><h2 id=etcd-node>ETCD Node</h2><p>The <a href=/docs/etcd><strong>ETCD</strong></a> module provides Distributed Consensus Service (DCS) for PostgreSQL high availability.</p><p>The <strong><code>etcd</code></strong> group in the <a href=/docs/concept/iac/inventory><strong>inventory</strong></a> defines ETCD nodes. These nodes run etcd servers on two ports:</p><table class=full-width><thead><tr><th style=text-align:center>Component</th><th style=text-align:center>Port</th><th>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>etcd</code></td><td style=text-align:center><code>2379</code></td><td>ETCD key-value store (client port)</td></tr><tr><td style=text-align:center><code>etcd</code></td><td style=text-align:center><code>2380</code></td><td>ETCD cluster peer communication</td></tr></tbody></table><hr><h2 id=minio-node>MINIO Node</h2><p>The <a href=/docs/minio><strong>MINIO</strong></a> module provides optional <a href=/docs/pgsql/backup/repository><strong>backup storage</strong></a> for PostgreSQL.</p><p>The <strong><code>minio</code></strong> group in the inventory defines MinIO nodes. These nodes run MinIO servers on:</p><table class=full-width><thead><tr><th style=text-align:center>Component</th><th style=text-align:center>Port</th><th>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>minio</code></td><td style=text-align:center><code>9000</code></td><td>MinIO S3 API endpoint</td></tr><tr><td style=text-align:center><code>minio</code></td><td style=text-align:center><code>9001</code></td><td>MinIO admin console</td></tr></tbody></table><hr><h2 id=pgsql-node>PGSQL Node</h2><p>Nodes with the <a href=/docs/pgsql/><strong>PGSQL</strong></a> module are called PGSQL nodes. Node and PostgreSQL instance have a 1:1 deployment—one PG instance per node.</p><p>PGSQL nodes can borrow <strong>identity</strong> from their PostgreSQL instance—controlled by <a href=/docs/node/param/#node_id_from_pg><code>node_id_from_pg</code></a>, defaulting to <code>true</code>, meaning the node name is set to the PG instance name.</p><p>PGSQL nodes run these additional components beyond <a href=#regular-node><strong>regular node</strong></a> services:</p><table class=full-width><thead><tr><th style=text-align:center>Component</th><th style=text-align:center>Port</th><th>Description</th><th>Status</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>postgres</code></strong></td><td style=text-align:center><code>5432</code></td><td>PostgreSQL database server</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>pgbouncer</code></strong></td><td style=text-align:center><code>6432</code></td><td>PgBouncer connection pool</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>patroni</code></strong></td><td style=text-align:center><code>8008</code></td><td>Patroni HA management</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>pg_exporter</code></strong></td><td style=text-align:center><code>9630</code></td><td>PostgreSQL metrics exporter</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>pgbouncer_exporter</code></strong></td><td style=text-align:center><code>9631</code></td><td>PgBouncer metrics exporter</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>pgbackrest_exporter</code></strong></td><td style=text-align:center><code>9854</code></td><td>pgBackRest metrics exporter</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>vip-manager</code></strong></td><td style=text-align:center><code>n/a</code></td><td>Binds L2 VIP to cluster primary</td><td>Optional</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-primary</code></strong></td><td style=text-align:center><code>5433</code></td><td>HAProxy service: pooled read/write</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-replica</code></strong></td><td style=text-align:center><code>5434</code></td><td>HAProxy service: pooled read-only</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-default</code></strong></td><td style=text-align:center><code>5436</code></td><td>HAProxy service: primary direct connection</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-offline</code></strong></td><td style=text-align:center><code>5438</code></td><td>HAProxy service: offline read</td><td>Enabled</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-&lt;service></code></strong></td><td style=text-align:center><code>543x</code></td><td>HAProxy service: custom PostgreSQL services</td><td>Custom</td></tr></tbody></table><p>The <code>vip-manager</code> is only enabled when users configure a <strong>PG VIP</strong>.
Additional <a href=/docs/pgsql/service#defining-services><strong>custom services</strong></a> can be defined in <a href=/docs/pgsql/service><strong><code>pg_services</code></strong></a>, exposed via <code>haproxy</code> using additional service ports.</p><hr><h2 id=node-relationships>Node Relationships</h2><p>Regular nodes typically reference an <a href=#infra-node><strong>INFRA node</strong></a> via the <a href=/docs/infra/param/#admin_ip><strong><code>admin_ip</code></strong></a> parameter as their infrastructure provider.
For example, with global <code>admin_ip = 10.10.10.10</code>, all nodes use infrastructure services at this IP.</p><p>Parameters that reference <code>${admin_ip}</code>:</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Module</th><th>Default Value</th><th>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/infra/param/#repo_endpoint><strong><code>repo_endpoint</code></strong></a></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>http://${admin_ip}:80</code></td><td>Software repo URL</td></tr><tr><td style=text-align:left><a href=/docs/infra/param/#repo_upstream><strong><code>repo_upstream</code></strong></a><code>.baseurl</code></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>http://${admin_ip}/pigsty</code></td><td>Local repo baseurl</td></tr><tr><td style=text-align:left><a href=/docs/infra/param/#infra_portal><strong><code>infra_portal</code></strong></a><code>.endpoint</code></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>${admin_ip}:&lt;port></code></td><td>Nginx proxy backend</td></tr><tr><td style=text-align:left><a href=/docs/infra/param/#dns_records><strong><code>dns_records</code></strong></a></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>["${admin_ip} i.pigsty", ...]</code></td><td>DNS records</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_default_etc_hosts><strong><code>node_default_etc_hosts</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>["${admin_ip} i.pigsty"]</code></td><td>Default static DNS</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_etc_hosts><strong><code>node_etc_hosts</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td>-</td><td>Custom static DNS</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_dns_servers><strong><code>node_dns_servers</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>["${admin_ip}"]</code></td><td>Dynamic DNS servers</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_ntp_servers><strong><code>node_ntp_servers</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td>-</td><td>NTP servers (optional)</td></tr></tbody></table><p>Typically the admin node and INFRA node coincide. With multiple INFRA nodes, the admin node is usually the first one; others serve as backups.</p><p>In large-scale production deployments, you might separate the Ansible admin node from INFRA module nodes.
For example, use 1-2 small dedicated hosts under the DBA team as the control hub (ADMIN nodes), and 2-3 high-spec physical machines as monitoring infrastructure (INFRA nodes).</p><p>Typical node counts by deployment scale:</p><table class=full-width><thead><tr><th style=text-align:center>Scale</th><th style=text-align:center>ADMIN</th><th style=text-align:center>INFRA</th><th style=text-align:center>ETCD</th><th style=text-align:center>MINIO</th><th style=text-align:center>PGSQL</th></tr></thead><tbody><tr><td style=text-align:center>Single-node</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td></tr><tr><td style=text-align:center>3-node</td><td style=text-align:center>1</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>3</td></tr><tr><td style=text-align:center>Small prod</td><td style=text-align:center>1</td><td style=text-align:center>2</td><td style=text-align:center>3</td><td style=text-align:center>0</td><td style=text-align:center>N</td></tr><tr><td style=text-align:center>Large prod</td><td style=text-align:center>2</td><td style=text-align:center>3</td><td style=text-align:center>5</td><td style=text-align:center>4+</td><td style=text-align:center>N</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-d65561d0ed395a21fc6b7dd2654dc081>1.2 - Infrastructure</h1><div class=lead>Infrastructure module architecture, components, and functionality in Pigsty.</div><p>Running production-grade, highly available PostgreSQL clusters typically requires a comprehensive set of infrastructure services (foundation) for support, such as monitoring and alerting, log collection, time synchronization, DNS resolution, and local software repositories.
Pigsty provides the <a href=/docs/infra><strong>INFRA module</strong></a> to address this—it&rsquo;s an <strong>optional module</strong>, but we strongly recommend enabling it.</p><hr><h2 id=overview>Overview</h2><p>The diagram below shows the architecture of a <a href=/docs/setup/install><strong>single-node deployment</strong></a>. The right half represents the components included in the <a href=/docs/infra><strong>INFRA module</strong></a>:</p><table><thead><tr><th style=text-align:left>Component</th><th>Type</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#nginx><strong>Nginx</strong></a></td><td>Web Server</td><td style=text-align:left>Unified entry for <a href=/docs/setup/webui><strong>WebUI</strong></a>, <a href=#repo><strong>local repo</strong></a>, reverse proxy for internal services</td></tr><tr><td style=text-align:left><a href=#repo><strong>Repo</strong></a></td><td>Software Repo</td><td style=text-align:left>APT/DNF repository with all RPM/DEB packages needed for deployment</td></tr><tr><td style=text-align:left><a href=#grafana><strong>Grafana</strong></a></td><td>Visualization</td><td style=text-align:left>Displays metrics, logs, and traces; hosts dashboards, reports, and custom data apps</td></tr><tr><td style=text-align:left><a href=#victoriametrics><strong>VictoriaMetrics</strong></a></td><td>Time Series DB</td><td style=text-align:left>Scrapes all metrics, Prometheus API compatible, provides VMUI query interface</td></tr><tr><td style=text-align:left><a href=#victorialogs><strong>VictoriaLogs</strong></a></td><td>Log Platform</td><td style=text-align:left>Centralized log storage; all nodes run Vector by default, pushing logs here</td></tr><tr><td style=text-align:left><a href=#victoriatraces><strong>VictoriaTraces</strong></a></td><td>Tracing</td><td style=text-align:left>Collects slow SQL, service traces, and other tracing data</td></tr><tr><td style=text-align:left><a href=#vmalert><strong>VMAlert</strong></a></td><td>Alert Engine</td><td style=text-align:left>Evaluates alerting rules, pushes events to Alertmanager</td></tr><tr><td style=text-align:left><a href=#alertmanager><strong>AlertManager</strong></a></td><td>Alert Manager</td><td style=text-align:left>Aggregates alerts, dispatches notifications via email, Webhook, etc.</td></tr><tr><td style=text-align:left><a href=#blackboxexporter><strong>BlackboxExporter</strong></a></td><td>Blackbox Probe</td><td style=text-align:left>Probes reachability of IPs/VIPs/URLs</td></tr><tr><td style=text-align:left><a href=#dnsmasq><strong>DNSMASQ</strong></a></td><td>DNS Service</td><td style=text-align:left>Provides DNS resolution for domains used within Pigsty [Optional]</td></tr><tr><td style=text-align:left><a href=#chronyd><strong>Chronyd</strong></a></td><td>Time Sync</td><td style=text-align:left>Provides NTP time synchronization to ensure consistent time across nodes [Optional]</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/ca><strong>CA</strong></a></td><td>Certificate</td><td style=text-align:left>Issues encryption certificates within the environment</td></tr><tr><td style=text-align:left><a href=/docs/setup/playbook><strong>Ansible</strong></a></td><td>Orchestration</td><td style=text-align:left>Batch, declarative, agentless tool for managing large numbers of servers</td></tr></tbody></table><p><a href=/docs/infra/><img src=/img/pigsty/arch.png alt=pigsty-arch></a></p><hr><h2 id=nginx>Nginx</h2><p><strong>Nginx</strong> is the access entry point for all WebUI services in Pigsty, using ports <a href=/docs/infra/param#nginx_port><strong><code>80</code></strong></a> / <a href=/docs/infra/param#nginx_ssl_port><strong><code>443</code></strong></a> for HTTP/HTTPS by default. <a href=https://demo.pigsty.io/><strong>Live Demo</strong></a></p><table class=full-width><thead><tr><th style=text-align:center>IP Access (replace)</th><th style=text-align:center>Domain (HTTP)</th><th style=text-align:center>Domain (HTTPS)</th><th style=text-align:center>Public Demo</th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10><strong><code>http://10.10.10.10</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty><strong><code>http://i.pigsty</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty><strong><code>https://i.pigsty</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.io><strong><code>https://demo.pigsty.io</code></strong></a></td></tr></tbody></table><p>Infrastructure components with WebUIs can be exposed uniformly through <strong>Nginx</strong>, such as <strong>Grafana</strong>, <strong>VictoriaMetrics</strong> (VMUI), <strong>AlertManager</strong>,
and <strong>HAProxy</strong> console. Additionally, the <strong>local software repository</strong> and other static resources are served via <strong>Nginx</strong>.</p><p><strong>Nginx</strong> configures local web servers or reverse proxy servers based on definitions in <a href=/docs/infra/param/#infra_portal><strong><code>infra_portal</code></strong></a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>By default, it exposes Pigsty&rsquo;s admin homepage: <code>i.pigsty</code>. Different endpoints on this page proxy different components:</p><table class=full-width><thead><tr><th style=text-align:left>Endpoint</th><th style=text-align:left>Component</th><th style=text-align:left>Native Port</th><th style=text-align:left>Notes</th><th>Public Demo</th></tr></thead><tbody><tr><td style=text-align:left><code>/</code></td><td style=text-align:left><a href=/docs/infra/><strong>Nginx</strong></a></td><td style=text-align:left><code>80/443</code></td><td style=text-align:left>Homepage, local repo, file server</td><td><a href=https://demo.pigsty.io><code>demo.pigsty.io</code></a></td></tr><tr><td style=text-align:left><code>/ui/</code></td><td style=text-align:left><a href=#grafana><strong>Grafana</strong></a></td><td style=text-align:left><code>3000</code></td><td style=text-align:left>Grafana dashboard entry</td><td><a href=https://demo.pigsty.io/ui/><code>demo.pigsty.io/ui/</code></a></td></tr><tr><td style=text-align:left><code>/vmetrics/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VictoriaMetrics</strong></a></td><td style=text-align:left><code>8428</code></td><td style=text-align:left>Time series DB Web UI</td><td><a href=https://demo.pigsty.io/vmetrics/><code>demo.pigsty.io/vmetrics/</code></a></td></tr><tr><td style=text-align:left><code>/vlogs/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VictoriaLogs</strong></a></td><td style=text-align:left><code>9428</code></td><td style=text-align:left>Log DB Web UI</td><td><a href=https://demo.pigsty.io/vlogs/><code>demo.pigsty.io/vlogs/</code></a></td></tr><tr><td style=text-align:left><code>/vtraces/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VictoriaTraces</strong></a></td><td style=text-align:left><code>10428</code></td><td style=text-align:left>Tracing Web UI</td><td><a href=https://demo.pigsty.io/vtraces/><code>demo.pigsty.io/vtraces/</code></a></td></tr><tr><td style=text-align:left><code>/vmalert/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VMAlert</strong></a></td><td style=text-align:left><code>8880</code></td><td style=text-align:left>Alert rule management</td><td><a href=https://demo.pigsty.io/vmalert/><code>demo.pigsty.io/vmalert/</code></a></td></tr><tr><td style=text-align:left><code>/alertmgr/</code></td><td style=text-align:left><a href=/docs/infra/><strong>AlertManager</strong></a></td><td style=text-align:left><code>9059</code></td><td style=text-align:left>Alert management Web UI</td><td><a href=https://demo.pigsty.io/alertmgr/><code>demo.pigsty.io/alertmgr/</code></a></td></tr><tr><td style=text-align:left><code>/blackbox/</code></td><td style=text-align:left><a href=/docs/infra/><strong>Blackbox</strong></a></td><td style=text-align:left><code>9115</code></td><td style=text-align:left>Blackbox probe</td><td></td></tr></tbody></table><p><a href=https://demo.pigsty.io><img src=/img/pigsty/home.png alt></a></p><p>Pigsty allows rich customization of <strong>Nginx</strong> as a local file server or reverse proxy, with self-signed or real HTTPS certificates.</p><p>For more information, see: <a href=/docs/infra/admin/portal/><strong>Tutorial: Nginx—Expose Web Services via Proxy</strong></a> and <a href=/docs/infra/admin/cert><strong>Tutorial: Certbot—Request and Renew HTTPS Certificates</strong></a></p><hr><h2 id=repo>Repo</h2><p>Pigsty creates a <strong>local software repository</strong> on the Infra node during installation to accelerate subsequent software installations. <a href=https://demo.pigsty.io/pigsty/><strong>Live Demo</strong></a></p><p>This repository defaults to the <a href=/docs/infra/param#repo_home><strong><code>/www/pigsty</code></strong></a> directory,
served by <strong>Nginx</strong> and mounted at the <code>/pigsty</code> path:</p><table class=full-width><thead><tr><th style=text-align:center>IP Access (replace)</th><th style=text-align:center>Domain (HTTP)</th><th style=text-align:center>Domain (HTTPS)</th><th style=text-align:center>Public Demo</th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/pigsty><strong><code>http://10.10.10.10/pigsty</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/pigsty><strong><code>http://i.pigsty/pigsty</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/pigsty><strong><code>https://i.pigsty/pigsty</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.io/pigsty><strong><code>https://demo.pigsty.io/pigsty</code></strong></a></td></tr></tbody></table><p>Pigsty supports <a href=/docs/setup/offline><strong>offline installation</strong></a>, which essentially pre-copies a prepared local software repository to the target environment.
When Pigsty performs production deployment and needs to create a local software repository, if it finds the <strong><code>/www/pigsty/repo_complete</code></strong> marker file already exists locally, it skips downloading packages from upstream and uses existing packages directly, avoiding internet downloads.</p><p><a href=https://demo.pigsty.io/pigsty/><img src=/img/pigsty/repo.webp alt=repo></a></p><p>For more information, see: <a href=/docs/infra/param/#repo><strong>Config: INFRA - REPO</strong></a></p><hr><h2 id=grafana>Grafana</h2><p><strong>Grafana</strong> is the core component of Pigsty&rsquo;s monitoring system, used for visualizing metrics, logs, and various information. <a href=https://demo.pigsty.io/ui/><strong>Live Demo</strong></a></p><p><strong>Grafana</strong> listens on port <code>3000</code> by default and is proxied via <strong>Nginx</strong> at the <code>/ui</code> path:</p><table class=full-width><thead><tr><th style=text-align:center>IP Access (replace)</th><th style=text-align:center>Domain (HTTP)</th><th style=text-align:center>Domain (HTTPS)</th><th style=text-align:center>Public Demo</th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/ui><strong><code>http://10.10.10.10/ui</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/ui><strong><code>http://i.pigsty/ui</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/ui><strong><code>https://i.pigsty/ui</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.io/ui><strong><code>https://demo.pigsty.io/ui</code></strong></a></td></tr></tbody></table><p>Pigsty provides pre-built dashboards based on <strong>VictoriaMetrics</strong> / <strong>Logs</strong> / <strong>Traces</strong>, with one-click drill-down and roll-up via URL jumps for rapid troubleshooting.</p><p><strong>Grafana</strong> can also serve as a low-code visualization platform, so <strong>ECharts</strong>, victoriametrics-datasource, victorialogs-datasource plugins are installed by default,
with <strong>Vector</strong> / <strong>Victoria</strong> datasources registered uniformly as <code>vmetrics-*</code>, <code>vlogs-*</code>, <code>vtraces-*</code> for easy custom dashboard extension.</p><p><img src=/img/dashboard/pigsty.jpg alt=dashboard></p><p>For more information, see: <a href=/docs/infra/param/#grafana><strong>Config: INFRA - GRAFANA</strong></a>.</p><hr><h2 id=victoriametrics>VictoriaMetrics</h2><p><strong>VictoriaMetrics</strong> is Pigsty&rsquo;s time series database, responsible for scraping and storing all monitoring metrics. <a href=https://demo.pigsty.io/vmetrics/><strong>Live Demo</strong></a></p><p>It listens on port <code>8428</code> by default, mounted at <strong>Nginx</strong> <code>/vmetrics</code> path, and also accessible via the <code>p.pigsty</code> domain:</p><table class=full-width><thead><tr><th style=text-align:center>IP Access (replace)</th><th style=text-align:center>Domain (HTTP)</th><th style=text-align:center>Domain (HTTPS)</th><th style=text-align:center>Public Demo</th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/vmetrics><strong><code>http://10.10.10.10/vmetrics</code></strong></a></td><td style=text-align:center><a href=http://p.pigsty><strong><code>http://p.pigsty</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/vmetrics><strong><code>https://i.pigsty/vmetrics</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.io/vmetrics><strong><code>https://demo.pigsty.io/vmetrics</code></strong></a></td></tr></tbody></table><p><strong>VictoriaMetrics</strong> is fully compatible with the <strong>Prometheus</strong> API, supporting PromQL queries, remote read/write protocols, and the Alertmanager API.
The built-in <strong>VMUI</strong> provides an ad-hoc query interface for exploring metrics data directly, and also serves as a <strong>Grafana</strong> datasource.</p><p><a href=https://demo.pigsty.io/vmetrics/vmui><img src=/img/pigsty/vmetrics.webp alt=vmetrics></a></p><p>For more information, see: <a href=/docs/infra/param/#vmetrics_enabled><strong>Config: INFRA - VMETRICS</strong></a></p><hr><h2 id=victorialogs>VictoriaLogs</h2><p><strong>VictoriaLogs</strong> is Pigsty&rsquo;s log platform, centrally storing structured logs from all nodes. <a href=https://demo.pigsty.io/vlogs/><strong>Live Demo</strong></a></p><p>It listens on port <code>9428</code> by default, mounted at <strong>Nginx</strong> <code>/vlogs</code> path:</p><table class=full-width><thead><tr><th style=text-align:center>IP Access (replace)</th><th style=text-align:center>Domain (HTTP)</th><th style=text-align:center>Domain (HTTPS)</th><th style=text-align:center>Public Demo</th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/vlogs><strong><code>http://10.10.10.10/vlogs</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/vlogs><strong><code>http://i.pigsty/vlogs</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/vlogs><strong><code>https://i.pigsty/vlogs</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.io/vlogs><strong><code>https://demo.pigsty.io/vlogs</code></strong></a></td></tr></tbody></table><p>All managed nodes run <strong>Vector</strong> Agent by default, collecting system logs, PostgreSQL logs, Patroni logs, Pgbouncer logs, etc., processing them into structured format and pushing to <strong>VictoriaLogs</strong>.
The built-in Web UI supports log search and filtering, and can be integrated with <strong>Grafana</strong>&rsquo;s victorialogs-datasource plugin for visual analysis.</p><p><a href=https://demo.pigsty.io/vlogs/select/vmui><img src=/img/pigsty/vmlogs.webp alt=vlogs></a></p><p>For more information, see: <a href=/docs/infra/param/#vlogs_enabled><strong>Config: INFRA - VLOGS</strong></a></p><hr><h2 id=victoriatraces>VictoriaTraces</h2><p><strong>VictoriaTraces</strong> is used for collecting trace data and slow SQL records. <a href=https://demo.pigsty.io/vtraces/><strong>Live Demo</strong></a></p><p>It listens on port <code>10428</code> by default, mounted at <strong>Nginx</strong> <code>/vtraces</code> path:</p><table class=full-width><thead><tr><th style=text-align:center>IP Access (replace)</th><th style=text-align:center>Domain (HTTP)</th><th style=text-align:center>Domain (HTTPS)</th><th style=text-align:center>Public Demo</th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/vtraces><strong><code>http://10.10.10.10/vtraces</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/vtraces><strong><code>http://i.pigsty/vtraces</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/vtraces><strong><code>https://i.pigsty/vtraces</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.io/vtraces><strong><code>https://demo.pigsty.io/vtraces</code></strong></a></td></tr></tbody></table><p><strong>VictoriaTraces</strong> provides a <strong>Jaeger</strong>-compatible interface for analyzing service call chains and database slow queries.
Combined with <strong>Grafana</strong> dashboards, it enables rapid identification of performance bottlenecks and root cause tracing.</p><p>For more information, see: <a href=/docs/infra/param/#vtraces_enabled><strong>Config: INFRA - VTRACES</strong></a></p><hr><h2 id=vmalert>VMAlert</h2><p><strong>VMAlert</strong> is the alerting rule computation engine, responsible for evaluating alert rules and pushing triggered events to <strong>Alertmanager</strong>. <a href=https://demo.pigsty.io/vmalert/><strong>Live Demo</strong></a></p><p>It listens on port <code>8880</code> by default, mounted at <strong>Nginx</strong> <code>/vmalert</code> path:</p><table class=full-width><thead><tr><th style=text-align:center>IP Access (replace)</th><th style=text-align:center>Domain (HTTP)</th><th style=text-align:center>Domain (HTTPS)</th><th style=text-align:center>Public Demo</th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/vmalert><strong><code>http://10.10.10.10/vmalert</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/vmalert><strong><code>http://i.pigsty/vmalert</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/vmalert><strong><code>https://i.pigsty/vmalert</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.io/vmalert><strong><code>https://demo.pigsty.io/vmalert</code></strong></a></td></tr></tbody></table><p><strong>VMAlert</strong> reads metrics data from <strong>VictoriaMetrics</strong> and periodically evaluates alerting rules.
Pigsty provides pre-built alerting rules for PGSQL, NODE, REDIS, and other modules, covering common failure scenarios out of the box.</p><p><a href=https://demo.pigsty.io/vmalert/vmalert/groups><img src=/img/pigsty/vmalert.webp alt=vmalert></a></p><p>For more information, see: <a href=/docs/infra/param/#vmalert_enabled><strong>Config: INFRA - VMALERT</strong></a></p><hr><h2 id=alertmanager>AlertManager</h2><p><strong>AlertManager</strong> handles alert event aggregation, deduplication, grouping, and dispatch. <a href=https://demo.pigsty.io/alertmgr/><strong>Live Demo</strong></a></p><p>It listens on port <code>9059</code> by default, mounted at <strong>Nginx</strong> <code>/alertmgr</code> path, and also accessible via the <code>a.pigsty</code> domain:</p><table class=full-width><thead><tr><th style=text-align:center>IP Access (replace)</th><th style=text-align:center>Domain (HTTP)</th><th style=text-align:center>Domain (HTTPS)</th><th style=text-align:center>Public Demo</th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/alertmgr><strong><code>http://10.10.10.10/alertmgr</code></strong></a></td><td style=text-align:center><a href=http://a.pigsty><strong><code>http://a.pigsty</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/alertmgr><strong><code>https://i.pigsty/alertmgr</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.io/alertmgr><strong><code>https://demo.pigsty.io/alertmgr</code></strong></a></td></tr></tbody></table><p><strong>AlertManager</strong> supports multiple notification channels: email, Webhook, Slack, PagerDuty, WeChat Work, etc.
Through alert routing rules, differentiated dispatch based on severity level and module type is possible, with support for silencing, inhibition, and other advanced features.</p><p><a href=https://demo.pigsty.io/alertmgr/><img src=/img/pigsty/alertmanager.webp alt=alertmanager></a></p><p>For more information, see: <a href=/docs/infra/param/#alertmanager_enabled><strong>Config: INFRA - AlertManager</strong></a></p><hr><h2 id=blackboxexporter>BlackboxExporter</h2><p><strong>Blackbox Exporter</strong> is used for active probing of target reachability, enabling blackbox monitoring.</p><p>It listens on port <code>9115</code> by default, mounted at <strong>Nginx</strong> <code>/blackbox</code> path:</p><table class=full-width><thead><tr><th style=text-align:center>IP Access (replace)</th><th style=text-align:center>Domain (HTTP)</th><th style=text-align:center>Domain (HTTPS)</th><th style=text-align:center>Public Demo</th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/blackbox><strong><code>http://10.10.10.10/blackbox</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/blackbox><strong><code>http://i.pigsty/blackbox</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/blackbox><strong><code>https://i.pigsty/blackbox</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.io/blackbox><strong><code>https://demo.pigsty.io/blackbox</code></strong></a></td></tr></tbody></table><p>It supports multiple probe methods including ICMP Ping, TCP ports, and HTTP/HTTPS endpoints.
Useful for monitoring VIP reachability, service port availability, external dependency health, etc.—an important tool for assessing failure impact scope.</p><p><a href=https://demo.pigsty.io/blackbox/><img src=/img/pigsty/blackbox.webp alt=blackbox></a></p><p>For more information, see: <a href=/docs/infra/param/#blackbox_exporter><strong>Config: INFRA - BLACKBOX</strong></a></p><hr><h2 id=ansible>Ansible</h2><p><strong>Ansible</strong> is Pigsty&rsquo;s core orchestration tool; all deployment, configuration, and management operations are performed through Ansible Playbooks.</p><p>Pigsty automatically installs <strong>Ansible</strong> on the admin node (Infra node) during installation.
It adopts a declarative configuration style and idempotent playbook design: the same playbook can be run repeatedly, and the system automatically converges to the desired state without side effects.</p><p><strong>Ansible</strong>&rsquo;s core advantages:</p><ul><li><strong>Agentless</strong>: Executes remotely via SSH, no additional software needed on target nodes.</li><li><strong>Declarative</strong>: Describes the desired state rather than execution steps; configuration is documentation.</li><li><strong>Idempotent</strong>: Multiple executions produce consistent results; supports retry after partial failures.</li></ul><p>For more information, see: <a href=/docs/setup/playbook><strong>Playbooks: Pigsty Playbook</strong></a></p><hr><h2 id=dnsmasq>DNSMASQ</h2><p><strong>DNSMASQ</strong> provides DNS resolution on <a href=/docs/concept/arch/node#infra-node><strong>INFRA nodes</strong></a>, resolving domain names to their corresponding IP addresses.</p><p>DNSMASQ listens on port <code>53</code> (UDP/TCP) by default, providing DNS resolution for all nodes. Records are stored in the <code>/infra/hosts</code> directory.</p><p>Other modules automatically register their domain names with <strong>DNSMASQ</strong> during deployment, which you can use as needed.
DNS is completely optional—<strong>Pigsty works normally without it</strong>.
Client nodes can configure INFRA nodes as their DNS servers, allowing access to services via domain names without remembering IP addresses.</p><ul><li><a href=/docs/infra/param/#dns_records><strong><code>dns_records</code></strong></a>: Default DNS records written to INFRA nodes</li><li><a href=/docs/node/param/#node_dns_servers><strong><code>node_dns_servers</code></strong></a>: Configure DNS servers for nodes, defaults to INFRA node via <a href=/docs/infra/param/#admin_ip><strong><code>admin_ip</code></strong></a> (can also be <a href=/docs/node/param#node_dns_method><strong>disabled</strong></a>)</li></ul><p>For more information, see: <a href=/docs/infra/param/#dns><strong>Config: INFRA - DNS</strong></a> and <a href=/docs/infra/admin/domain><strong>Tutorial: DNS—Configure Domain Resolution</strong></a></p><hr><h2 id=chronyd>Chronyd</h2><p><strong>Chronyd</strong> provides NTP time synchronization, ensuring consistent clocks across all nodes. It listens on port <code>123</code> (UDP) by default as the time source.</p><p>Time synchronization is critical for distributed systems: log analysis requires aligned timestamps, certificate validation depends on accurate clocks, and <strong>PostgreSQL</strong> streaming replication is sensitive to clock drift.
In isolated network environments, the INFRA node can serve as an internal NTP server with other nodes synchronizing to it.</p><p>In Pigsty, all nodes run chronyd by default for time sync. The default upstream is <a href=/docs/node/param#node_ntp_servers><strong><code>pool.ntp.org</code></strong></a> public NTP servers.
Chronyd is essentially managed by the <a href=/docs/node><strong>Node module</strong></a>, but in isolated networks, you can use <a href=/docs/infra/param/#admin_ip><strong><code>admin_ip</code></strong></a> to point to the INFRA node&rsquo;s Chronyd service as the internal time source.
In this case, the Chronyd service on the <a href=/docs/concept/arch/node#infra-node><strong>INFRA node</strong></a> serves as the internal time synchronization infrastructure.</p><p>For more information, see: <a href=/docs/node/param/#node_time><strong>Config: NODE - TIME</strong></a></p><hr><h2 id=infra-node-vs-regular-node>INFRA Node vs Regular Node</h2><p>In Pigsty, the relationship between nodes and infrastructure is a <strong>weak circular dependency</strong>: node_monitor → infra → node</p><p>The <a href=/docs/node><strong>NODE module</strong></a> itself doesn&rsquo;t depend on the <a href=/docs/infra><strong>INFRA module</strong></a>, but the monitoring functionality (node_monitor) requires the monitoring platform and services provided by the infrastructure module.</p><p>Therefore, in the <a href=/docs/infra/playbook#infrayml><strong><code>infra.yml</code></strong></a> and <a href=/docs/setup/playbook><strong><code>deploy</code></strong></a> playbooks, an &ldquo;interleaved deployment&rdquo; technique is used:</p><ul><li>First, initialize the <a href=/docs/node><strong>NODE module</strong></a> on all <a href=/docs/concept/arch/node#regular-node><strong>regular nodes</strong></a>, but skip monitoring config since infrastructure isn&rsquo;t deployed yet.</li><li>Then, initialize the <a href=/docs/infra><strong>INFRA module</strong></a> on the <a href=/docs/concept/arch/node#infra-node><strong>INFRA node</strong></a>—monitoring is now available.</li><li>Finally, reconfigure monitoring on all <a href=/docs/concept/arch/node#regular-node><strong>regular nodes</strong></a>, connecting to the now-deployed monitoring platform.</li></ul><p>If you don&rsquo;t need &ldquo;one-shot&rdquo; deployment of all nodes, you can use <a href=/docs/setup/config#adding-infrastructure><strong>phased deployment</strong></a>: initialize INFRA nodes first, then regular nodes.</p><h3 id=how-are-nodes-coupled-to-infrastructure>How Are Nodes Coupled to Infrastructure?</h3><p>Regular nodes reference an <a href=#infra-node><strong>INFRA node</strong></a> via the <a href=/docs/infra/param/#admin_ip><strong><code>admin_ip</code></strong></a> parameter as their infrastructure provider.</p><p>For example, when you configure global <code>admin_ip = 10.10.10.10</code>, all nodes will typically use infrastructure services at this IP.</p><p>This design allows quick, batch switching of infrastructure providers. Parameters that <strong>may</strong> reference <code>${admin_ip}</code>:</p><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Module</th><th>Default Value</th><th>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/infra/param/#repo_endpoint><strong><code>repo_endpoint</code></strong></a></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>http://${admin_ip}:80</code></td><td>Software repo URL</td></tr><tr><td style=text-align:left><a href=/docs/infra/param/#repo_upstream><strong><code>repo_upstream</code></strong></a><code>.baseurl</code></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>http://${admin_ip}/pigsty</code></td><td>Local repo baseurl</td></tr><tr><td style=text-align:left><a href=/docs/infra/param/#infra_portal><strong><code>infra_portal</code></strong></a><code>.endpoint</code></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>${admin_ip}:&lt;port></code></td><td>Nginx proxy backend</td></tr><tr><td style=text-align:left><a href=/docs/infra/param/#dns_records><strong><code>dns_records</code></strong></a></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>["${admin_ip} i.pigsty", ...]</code></td><td>DNS records</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_default_etc_hosts><strong><code>node_default_etc_hosts</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>["${admin_ip} i.pigsty"]</code></td><td>Default static DNS</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_etc_hosts><strong><code>node_etc_hosts</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>[]</code></td><td>Custom static DNS</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_dns_servers><strong><code>node_dns_servers</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>["${admin_ip}"]</code></td><td>Dynamic DNS servers</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_ntp_servers><strong><code>node_ntp_servers</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>["pool pool.ntp.org iburst"]</code></td><td>NTP servers (optional)</td></tr></tbody></table><p>For example, when a node installs software, the <code>local</code> repo points to the Nginx local software repository at <code>admin_ip:80/pigsty</code>. The DNS server also points to <a href=#dnsmasq><strong>DNSMASQ</strong></a> at <code>admin_ip:53</code>.
However, this isn&rsquo;t mandatory—nodes can ignore the <code>local</code> repo and install directly from upstream internet sources (most single-node config templates); DNS servers can also remain unconfigured, as Pigsty has no DNS dependency.</p><hr><h2 id=infra-node-vs-admin-node>INFRA Node vs ADMIN Node</h2><p>The management-initiating <a href=/docs/concept/arch/node#admin-node><strong>ADMIN node</strong></a> typically coincides with the <a href=/docs/concept/arch/node#infra-node><strong>INFRA node</strong></a>.
In <a href=/docs/setup/install><strong>single-node deployment</strong></a>, this is exactly the case. In multi-node deployment with multiple INFRA nodes, the admin node is usually the first in the <code>infra</code> group; others serve as backups.
However, exceptions exist. You might separate them for various reasons:</p><p>For example, in <a href=/docs/deploy><strong>large-scale production deployments</strong></a>, a classic pattern uses 1-2 dedicated management hosts (tiny VMs suffice) belonging to the DBA team
as the control hub, with 2-3 high-spec physical machines (or more!) as monitoring infrastructure. Here, admin nodes are separate from infrastructure nodes.
In this case, the <a href=/docs/infra/param/#admin_ip><strong>admin_ip</strong></a> in your config should point to an INFRA node&rsquo;s IP, not the current ADMIN node&rsquo;s IP.
This is for historical reasons: initially ADMIN and INFRA nodes were tightly coupled concepts, with separation capabilities evolving later, so the parameter name wasn&rsquo;t changed.</p><p>Another common scenario is <a href=/docs/setup><strong>managing cloud nodes locally</strong></a>. For example, you can install Ansible on your laptop and specify cloud nodes as &ldquo;managed targets.&rdquo;
In this case, your laptop acts as the ADMIN node, while cloud servers act as INFRA nodes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq: 1 , ansible_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>your_ssh_alias } } } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Use ansible_host to point to cloud node (fill in ssh alias)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster: etcd } }    # SSH connection will use</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssh your_ssh_alias</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>v4.0.0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=multiple-infra-nodes>Multiple INFRA Nodes</h2><p>By default, Pigsty only needs one INFRA node for most requirements. Even if the INFRA module goes down, it won&rsquo;t affect database services on other nodes.</p><p>However, in production environments with high monitoring and alerting requirements, you may want multiple INFRA nodes to improve infrastructure availability.
A common deployment uses two Infra nodes for redundancy, monitoring each other&mldr;
or more nodes to deploy a distributed Victoria cluster for unlimited horizontal scaling.</p><p>Each Infra node is <strong>independent</strong>—Nginx points to services on the local machine.
VictoriaMetrics independently scrapes metrics from all services in the environment,
and logs are pushed to all VictoriaLogs collection endpoints by default.
The only exception is Grafana: every Grafana instance registers all VictoriaMetrics / Logs / Traces / PostgreSQL instances as datasources.
Therefore, each Grafana instance can see complete monitoring data.</p><p>If you modify Grafana—such as adding new dashboards or changing datasource configs—these changes only affect the Grafana instance on that node.
To keep Grafana consistent across all nodes, use a PostgreSQL database as shared storage. See <a href=/docs/infra/admin/grafana><strong>Tutorial: Configure Grafana High Availability</strong></a> for details.</p><p><a href=https://demo.pigsty.io/ui/d/infra-overview><img src=/img/dashboard/infra-overview.webp alt></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c777ff17702df77ebc33dadeb81e4174>1.3 - PGSQL Arch</h1><div class=lead>PostgreSQL module component interactions and data flow.</div><p>The PGSQL module organizes PostgreSQL in production as <strong>clusters</strong>—<strong>logical entities</strong> composed of a group of database <strong>instances</strong> associated by <strong>primary-replica</strong> relationships.</p><hr><h2 id=overview>Overview</h2><p>The <a href=/docs/pgsql><strong>PGSQL module</strong></a> includes the following components, working together to provide production-grade PostgreSQL HA cluster services:</p><table class=full-width><thead><tr><th style=text-align:left>Component</th><th>Type</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#postgresql><strong><code>postgres</code></strong></a></td><td>Database</td><td style=text-align:left>The world&rsquo;s most advanced open-source relational database, PGSQL core</td></tr><tr><td style=text-align:left><a href=#patroni><strong><code>patroni</code></strong></a></td><td>HA</td><td style=text-align:left>Manages PostgreSQL, coordinates failover, leader election, config changes</td></tr><tr><td style=text-align:left><a href=#pgbouncer><strong><code>pgbouncer</code></strong></a></td><td>Pool</td><td style=text-align:left>Lightweight connection pooling middleware, reduces overhead, adds flexibility</td></tr><tr><td style=text-align:left><a href=#pgbackrest><strong><code>pgbackrest</code></strong></a></td><td>Backup</td><td style=text-align:left>Full/incremental backup and WAL archiving, supports local and object storage</td></tr><tr><td style=text-align:left><a href=#pg_exporter><strong><code>pg_exporter</code></strong></a></td><td>Metrics</td><td style=text-align:left>Exports PostgreSQL monitoring metrics for Prometheus scraping</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter><strong><code>pgbouncer_exporter</code></strong></a></td><td>Metrics</td><td style=text-align:left>Exports Pgbouncer connection pool metrics</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter><strong><code>pgbackrest_exporter</code></strong></a></td><td>Metrics</td><td style=text-align:left>Exports backup status metrics</td></tr><tr><td style=text-align:left><a href=#vip-manager><strong><code>vip-manager</code></strong></a></td><td>VIP</td><td style=text-align:left>Binds L2 VIP to current primary node for transparent failover [Optional]</td></tr></tbody></table><p>The <a href=#vip-manager><strong><code>vip-manager</code></strong></a> is an on-demand component. Additionally, PGSQL uses components from other modules:</p><table class=full-width><thead><tr><th>Component</th><th style=text-align:left>Module</th><th>Type</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td><a href=#haproxy><strong><code>haproxy</code></strong></a></td><td style=text-align:left><a href=/docs/node><strong>NODE</strong></a></td><td>LB</td><td style=text-align:left>Exposes service ports, routes traffic to primary or replicas</td></tr><tr><td><a href=#vector><strong><code>vector</code></strong></a></td><td style=text-align:left><a href=/docs/node><strong>NODE</strong></a></td><td>Logging</td><td style=text-align:left>Collects PostgreSQL, <a href=#patroni>Patroni</a>, <a href=#pgbouncer>Pgbouncer</a> logs and ships to center</td></tr><tr><td><a href=#etcd><strong><code>etcd</code></strong></a></td><td style=text-align:left><a href=/docs/etcd><strong>ETCD</strong></a></td><td>DCS</td><td style=text-align:left>Distributed consistent store for cluster metadata and leader info</td></tr></tbody></table><p>By analogy, the <a href=#postgresql>PostgreSQL</a> database kernel is the CPU, while the PGSQL module packages it as a complete computer.
<a href=#patroni>Patroni</a> and <a href=#etcd>Etcd</a> form the <a href=#ha-subsystem>HA subsystem</a>, <a href=#pgbackrest>pgBackRest</a> and MinIO form the <a href=#backup-subsystem>backup subsystem</a>.
<a href=#haproxy>HAProxy</a>, <a href=#pgbouncer>Pgbouncer</a>, and <a href=#vip-manager>vip-manager</a> form the <a href=#access-subsystem>access subsystem</a>.
Various Exporters and <a href=#vector>Vector</a> build the <a href=#observability-subsystem>observability subsystem</a>;
finally, you can swap different <a href=/docs/pgsql/kernel><strong>kernel CPUs</strong></a> and <a href=/docs/pgsql/ext><strong>extension cards</strong></a>.</p><p><img src=/img/pigsty/motherboard.gif alt></p><table class=full-width><thead><tr><th style=text-align:left>Subsystem</th><th style=text-align:left>Components</th><th style=text-align:left>Function</th></tr></thead><tbody><tr><td style=text-align:left><a href=#ha-subsystem><strong>HA Subsystem</strong></a></td><td style=text-align:left><a href=#patroni>Patroni</a> + <a href=#etcd>etcd</a></td><td style=text-align:left>Failure detection, auto-failover, config management</td></tr><tr><td style=text-align:left><a href=#access-subsystem><strong>Access Subsystem</strong></a></td><td style=text-align:left><a href=#haproxy>HAProxy</a> + <a href=#pgbouncer>Pgbouncer</a> + <a href=#vip-manager>vip-manager</a></td><td style=text-align:left>Service exposure, load balancing, pooling, VIP</td></tr><tr><td style=text-align:left><a href=#backup-subsystem><strong>Backup Subsystem</strong></a></td><td style=text-align:left><a href=#pgbackrest>pgBackRest</a> (+ MinIO)</td><td style=text-align:left>Full/incremental backup, WAL archiving, PITR</td></tr><tr><td style=text-align:left><a href=#observability-subsystem><strong>Observability Subsystem</strong></a></td><td style=text-align:left><a href=#pg_exporter>pg_exporter</a> / <a href=#pgbouncer_exporter>pgbouncer_exporter</a> / <a href=#pgbackrest_exporter>pgbackrest_exporter</a> + <a href=#vector>Vector</a></td><td style=text-align:left>Metrics collection, log aggregation</td></tr></tbody></table><hr><h2 id=component-interaction>Component Interaction</h2><p><a href=/docs/infra/><img src=/img/pigsty/arch.png alt=pigsty-arch></a></p><ul><li>Cluster DNS is resolved by <a href=/docs/concept/arch/infra#dnsmasq><strong>DNSMASQ</strong></a> on infra nodes</li><li>Cluster VIP is managed by <a href=#vip-manager><strong>vip-manager</strong></a>, which binds <a href=/docs/pgsql/param#pg_vip_address><code>pg_vip_address</code></a> to the cluster primary node.<ul><li><a href=#vip-manager>vip-manager</a> gets cluster leader info written by <a href=#patroni>patroni</a> from the <a href=#etcd>etcd</a> cluster</li></ul></li><li>Cluster services are exposed by <a href=#haproxy><strong>HAProxy</strong></a> on nodes, different services distinguished by node ports (543x).<ul><li>HAProxy port 9101: Monitoring metrics & statistics & admin page</li><li>HAProxy port 5433: Routes to primary <a href=#pgbouncer>pgbouncer</a>: <a href=/docs/pgsql/service/#primary-service>read-write service</a></li><li>HAProxy port 5434: Routes to replica <a href=#pgbouncer>pgbouncer</a>: <a href=/docs/pgsql/service/#replica-service>read-only service</a></li><li>HAProxy port 5436: Routes to primary <a href=#postgresql>postgres</a>: <a href=/docs/pgsql/service/#default-service>default service</a></li><li>HAProxy port 5438: Routes to offline <a href=#postgresql>postgres</a>: <a href=/docs/pgsql/service/#offline-service>offline service</a></li><li><a href=#haproxy>HAProxy</a> routes traffic based on health check info from <a href=#patroni>patroni</a>.</li></ul></li><li><a href=#pgbouncer><strong>Pgbouncer</strong></a> is connection pooling middleware, listening on port 6432 by default, buffering connections, exposing additional metrics, and providing extra flexibility.<ul><li><a href=#pgbouncer>Pgbouncer</a> is stateless and deployed 1:1 with <a href=#postgresql>Postgres</a> via local Unix socket.</li><li>Production traffic (primary/replica) goes through <a href=#pgbouncer>pgbouncer</a> by default (can specify bypass via <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a>)</li><li>Default/offline services always bypass <a href=#pgbouncer>pgbouncer</a> and connect directly to target <a href=#postgresql>Postgres</a>.</li></ul></li><li><a href=#postgresql><strong>PostgreSQL</strong></a> listens on port 5432, providing relational database services<ul><li>Installing PGSQL module on multiple nodes with the same cluster name automatically forms an HA cluster via streaming replication</li><li><a href=#postgresql>PostgreSQL</a> process is managed by <a href=#patroni>patroni</a> by default.</li></ul></li><li><a href=#patroni><strong>Patroni</strong></a> listens on port 8008 by default, supervising <a href=#postgresql>PostgreSQL</a> server processes<ul><li><a href=#patroni>Patroni</a> starts <a href=#postgresql>Postgres</a> server as child process</li><li><a href=#patroni>Patroni</a> uses <a href=#etcd>etcd</a> as DCS: stores config, failure detection, and leader election.</li><li><a href=#patroni>Patroni</a> provides Postgres info (e.g., primary/replica) via health checks, <a href=#haproxy>HAProxy</a> uses this to distribute traffic</li></ul></li><li><a href=#pg_exporter><strong>pg_exporter</strong></a> exposes <a href=#postgresql>postgres</a> monitoring metrics on port 9630</li><li><a href=#pgbouncer_exporter><strong>pgbouncer_exporter</strong></a> exposes <a href=#pgbouncer>pgbouncer</a> metrics on port 9631</li><li><a href=#pgbackrest><strong>pgBackRest</strong></a> uses local backup repository by default (<code>pgbackrest_method</code> = <code>local</code>)<ul><li>If using <code>local</code> (default), <a href=#pgbackrest>pgBackRest</a> creates local repository under <a href=/docs/pgsql/param#pg_fs_bkup><code>pg_fs_bkup</code></a> on primary node</li><li>If using <code>minio</code>, <a href=#pgbackrest>pgBackRest</a> creates backup repository on dedicated MinIO cluster</li></ul></li><li><a href=#vector><strong>Vector</strong></a> collects Postgres-related logs (postgres, pgbouncer, patroni, pgbackrest)<ul><li><a href=#vector>vector</a> listens on port 9598, also exposes its own metrics to VictoriaMetrics on infra nodes</li><li><a href=#vector>vector</a> sends logs to VictoriaLogs on infra nodes</li></ul></li></ul><hr><h2 id=ha-subsystem>HA Subsystem</h2><p>The <a href=/docs/concept/ha><strong>HA</strong></a> subsystem consists of <a href=#patroni><strong>Patroni</strong></a> and <a href=#etcd><strong>etcd</strong></a>, responsible for PostgreSQL cluster failure detection, automatic failover, and configuration management.</p><p><strong>How it works</strong>: <a href=#patroni>Patroni</a> runs on each node, managing the local <a href=#postgresql>PostgreSQL</a> process and writing cluster state (leader, members, config) to <a href=#etcd>etcd</a>.
When the primary fails, <a href=#patroni>Patroni</a> coordinates election via <a href=#etcd>etcd</a>, promoting the healthiest replica to new primary. The entire process is automatic, with RTO typically under 45 seconds.</p><p><strong>Key Interactions</strong>:</p><ul><li><strong><a href=#postgresql>PostgreSQL</a></strong>: Starts, stops, reloads PG as parent process, controls its lifecycle</li><li><strong><a href=#etcd>etcd</a></strong>: External dependency, writes/watches leader key for distributed consensus and failure detection</li><li><strong><a href=#haproxy>HAProxy</a></strong>: Provides health checks via REST API (<code>:8008</code>), reporting instance role</li><li><strong><a href=#vip-manager>vip-manager</a></strong>: Watches leader key in <a href=#etcd>etcd</a>, auto-migrates VIP</li></ul><p>For more information, see: <a href=/docs/concept/ha/><strong>High Availability</strong></a> and <a href=/docs/pgsql/param/#pg_bootstrap><strong>Config: PGSQL - PG_BOOTSTRAP</strong></a></p><hr><h2 id=access-subsystem>Access Subsystem</h2><p>The access subsystem consists of <a href=#haproxy><strong>HAProxy</strong></a>, <a href=#pgbouncer><strong>Pgbouncer</strong></a>, and <a href=#vip-manager><strong>vip-manager</strong></a>, responsible for service exposure, traffic routing, and connection pooling.</p><p>There are multiple access methods. A typical traffic path is: <code>Client → DNS/VIP → HAProxy (543x) → Pgbouncer (6432) → PostgreSQL (5432)</code></p><table class=full-width><thead><tr><th style=text-align:left>Layer</th><th style=text-align:left>Component</th><th style=text-align:left>Port</th><th style=text-align:left>Role</th></tr></thead><tbody><tr><td style=text-align:left>L2 VIP</td><td style=text-align:left><a href=#vip-manager>vip-manager</a></td><td style=text-align:left>-</td><td style=text-align:left>Binds L2 VIP to primary (optional)</td></tr><tr><td style=text-align:left>L4 Load Bal</td><td style=text-align:left><a href=#haproxy>HAProxy</a></td><td style=text-align:left>543x</td><td style=text-align:left>Service exposure, load balancing, health checks</td></tr><tr><td style=text-align:left>L7 Pool</td><td style=text-align:left><a href=#pgbouncer>Pgbouncer</a></td><td style=text-align:left>6432</td><td style=text-align:left>Connection reuse, session management, transaction pooling</td></tr></tbody></table><p><strong>Service Ports</strong>:</p><ul><li><code>5433</code> primary: Read-write service, routes to primary <a href=#pgbouncer>Pgbouncer</a></li><li><code>5434</code> replica: Read-only service, routes to replica <a href=#pgbouncer>Pgbouncer</a></li><li><code>5436</code> default: Default service, direct to primary (bypasses pool)</li><li><code>5438</code> offline: Offline service, direct to offline replica (ETL/analytics)</li></ul><p><strong>Key Features</strong>:</p><ul><li><a href=#haproxy>HAProxy</a> uses <a href=#patroni>Patroni</a> REST API to determine instance role, auto-routes traffic</li><li><a href=#pgbouncer>Pgbouncer</a> uses transaction-level pooling, absorbs connection spikes, reduces PG connection overhead</li><li><a href=#vip-manager>vip-manager</a> watches <a href=#etcd>etcd</a> leader key, auto-migrates VIP during failover</li></ul><p>For more information, see: <a href=/docs/pgsql/service/><strong>Service Access</strong></a> and <a href=/docs/pgsql/param/#pg_access><strong>Config: PGSQL - PG_ACCESS</strong></a></p><hr><h2 id=backup-subsystem>Backup Subsystem</h2><p>The backup subsystem consists of <a href=#pgbackrest><strong>pgBackRest</strong></a> (optionally with <strong>MinIO</strong> as remote repository), responsible for data backup and point-in-time recovery (<a href=/docs/concept/pitr><strong>PITR</strong></a>).</p><p><strong>Backup Types</strong>:</p><ul><li><strong>Full backup</strong>: Complete database copy</li><li><strong>Incremental/differential backup</strong>: Only backs up changed data blocks</li><li><strong>WAL archiving</strong>: Continuous transaction log archiving, enables any point-in-time recovery</li></ul><p><strong>Storage Backends</strong>:</p><ul><li><code>local</code> (default): Local disk, backups stored at <a href=/docs/pgsql/param#pg_fs_bkup><code>pg_fs_bkup</code></a> mount point</li><li><code>minio</code>: S3-compatible object storage, supports centralized backup management and off-site DR</li></ul><p><strong>Key Interactions</strong>:</p><ul><li><strong><a href=#pgbackrest>pgBackRest</a> → <a href=#postgresql>PostgreSQL</a></strong>: Executes backup commands, manages WAL archiving</li><li><strong><a href=#pgbackrest>pgBackRest</a> → <a href=#patroni>Patroni</a></strong>: Recovery can bootstrap replicas as new primary or standby</li><li><strong><a href=#pgbackrest_exporter>pgbackrest_exporter</a> → Prometheus</strong>: Exports backup status metrics, monitors backup health</li></ul><p>For more information, see: <a href=/docs/concept/pitr/><strong>PITR</strong></a>, <a href=/docs/pgsql/backup/><strong>Backup & Recovery</strong></a>, and <a href=/docs/pgsql/param/#pg_backup><strong>Config: PGSQL - PG_BACKUP</strong></a></p><hr><h2 id=observability-subsystem>Observability Subsystem</h2><p>The observability subsystem consists of three <strong>Exporters</strong> and <a href=#vector><strong>Vector</strong></a>, responsible for metrics collection and log aggregation.</p><table><thead><tr><th style=text-align:left>Component</th><th style=text-align:left>Port</th><th style=text-align:left>Target</th><th style=text-align:left>Key Metrics</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_exporter>pg_exporter</a></td><td style=text-align:left><code>9630</code></td><td style=text-align:left><a href=#postgresql>PostgreSQL</a></td><td style=text-align:left>Sessions, transactions, replication lag, buffer hits</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter>pgbouncer_exporter</a></td><td style=text-align:left><code>9631</code></td><td style=text-align:left><a href=#pgbouncer>Pgbouncer</a></td><td style=text-align:left>Pool utilization, wait queue, hit rate</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter>pgbackrest_exporter</a></td><td style=text-align:left><code>9854</code></td><td style=text-align:left><a href=#pgbackrest>pgBackRest</a></td><td style=text-align:left>Latest backup time, size, type</td></tr><tr><td style=text-align:left><a href=#vector>vector</a></td><td style=text-align:left><code>9598</code></td><td style=text-align:left><a href=#postgresql>postgres</a>/<a href=#patroni>patroni</a>/<a href=#pgbouncer>pgbouncer</a> logs</td><td style=text-align:left>Structured log stream</td></tr></tbody></table><p><strong>Data Flow</strong>:</p><ul><li><strong>Metrics</strong>: Exporter → VictoriaMetrics (INFRA) → Grafana dashboards</li><li><strong>Logs</strong>: <a href=#vector>Vector</a> → VictoriaLogs (INFRA) → Grafana log queries</li></ul><p><a href=#pg_exporter>pg_exporter</a> / <a href=#pgbouncer_exporter>pgbouncer_exporter</a> connect to target services via local Unix socket, decoupled from HA topology. In <a href=/docs/setup/slim><strong>slim install</strong></a> mode, these components can be disabled.</p><p>For more information, see: <a href=/docs/pgsql/param/#pg_monitor><strong>Config: PGSQL - PG_MONITOR</strong></a></p><hr><h2 id=postgresql>PostgreSQL</h2><p><a href=https://www.postgresql.org/><strong>PostgreSQL</strong></a> is the PGSQL module core, listening on port <code>5432</code> by default for relational database services, deployed 1:1 with <a href=/docs/node><strong>nodes</strong></a>.</p><p>Pigsty currently supports PostgreSQL 14-18 (lifecycle major versions), installed via binary packages from the <a href=/docs/repo/pgdg/><strong>PGDG official repo</strong></a>.
Pigsty also allows you to use other <a href=/docs/pgsql/kernel><strong>PG kernel forks</strong></a> to replace the default PostgreSQL kernel,
and install up to <a href=/docs/pgsql/ext><strong>440</strong></a> extension plugins on top of the PG kernel.</p><p><strong>PostgreSQL</strong> processes are managed by default by the <a href=/docs/concept/ha><strong>HA</strong></a> agent—<a href=#patroni><strong>Patroni</strong></a>.
When a cluster has only one node, that instance is the primary; when the cluster has multiple nodes, other instances automatically join as replicas:
through physical replication, syncing data changes from the primary in real-time. Replicas can handle read-only requests and automatically take over when the primary fails.</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>You can access PostgreSQL directly, or through <a href=#haproxy>HAProxy</a> and <a href=#pgbouncer>Pgbouncer</a> connection pool.</p><p>For more information, see: <a href=/docs/pgsql/param/#pg_bootstrap><strong>Config: PGSQL - PG_BOOTSTRAP</strong></a></p><hr><h2 id=patroni>Patroni</h2><p><a href=https://patroni.readthedocs.io/><strong>Patroni</strong></a> is the PostgreSQL HA control component, listening on port <code>8008</code> by default.</p><p><strong>Patroni</strong> takes over <a href=#postgresql><strong>PostgreSQL</strong></a> startup, shutdown, configuration, and health status, writing leader and member information to <a href=#etcd><strong>etcd</strong></a>.
It handles automatic failover, maintains replication factor, coordinates parameter changes, and provides a REST API for <a href=#haproxy><strong>HAProxy</strong></a>, monitoring, and administrators.</p><p><a href=#haproxy><strong>HAProxy</strong></a> uses <strong>Patroni</strong> health check endpoints to determine instance roles and route traffic to the correct primary or replica.
<a href=#vip-manager><strong>vip-manager</strong></a> monitors the leader key in <a href=#etcd><strong>etcd</strong></a> and automatically migrates the VIP when the primary changes.</p><p><a href=/docs/concept/ha><img src=/img/dashboard/pgsql-patroni.webp alt=patroni></a></p><p>For more information, see: <a href=/docs/pgsql/param/#patroni_mode><strong>Config: PGSQL - PG_BOOTSTRAP</strong></a></p><hr><h2 id=pgbouncer>Pgbouncer</h2><p><a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> is a lightweight connection pooling middleware, listening on port <code>6432</code> by default, deployed 1:1 with <a href=#postgresql>PostgreSQL</a> database and node.</p><p><strong>Pgbouncer</strong> runs statelessly on each instance, connecting to <a href=#postgresql><strong>PostgreSQL</strong></a> via local Unix socket, using Transaction Pooling by default
for pool management, absorbing burst client connections, stabilizing database sessions, reducing lock contention, and significantly improving performance under high concurrency.</p><p>Pigsty routes production traffic (read-write service <code>5433</code> / read-only service <code>5434</code>) through <strong>Pgbouncer</strong> by default,
while only the default service (<code>5436</code>) and offline service (<code>5438</code>) bypass the pool for direct <a href=#postgresql><strong>PostgreSQL</strong></a> connections.</p><p>Pool mode is controlled by <a href=/docs/pgsql/param#pgbouncer_poolmode><code>pgbouncer_poolmode</code></a>, defaulting to <code>transaction</code> (transaction-level pooling).
Connection pooling can be disabled via <a href=/docs/pgsql/param#pgbouncer_enabled><code>pgbouncer_enabled</code></a>.</p><p><a href=https://demo.pigsty.io/ui/d/pgsql-pgbouncer><img src=/img/dashboard/pgsql-pgbouncer.webp alt=pgbouncer.png></a></p><p>For more information, see: <a href=/docs/pgsql/param/#pg_access><strong>Config: PGSQL - PG_ACCESS</strong></a></p><hr><h2 id=pgbackrest>pgBackRest</h2><p><a href=https://pgbackrest.org/><strong>pgBackRest</strong></a> is a professional PostgreSQL backup/recovery tool, one of the strongest in the PG ecosystem, supporting full/incremental/differential backup and WAL archiving.</p><p>Pigsty uses pgBackRest for PostgreSQL <a href=/docs/concept/pitr><strong>PITR</strong></a> capability,
allowing you to roll back clusters to any point within the backup retention window.</p><p><strong>pgBackRest</strong> works with <a href=#postgresql><strong>PostgreSQL</strong></a> to create backup repositories on the primary, executing backup and archive tasks.
By default, it uses local backup repository (<a href=/docs/pgsql/param#pgbackrest_method><strong><code>pgbackrest_method</code></strong></a> = <code>local</code>),
but can be configured for MinIO or other object storage for centralized backup management.</p><p>After initialization, <a href=/docs/pgsql/param#pgbackrest_init_backup><strong><code>pgbackrest_init_backup</code></strong></a> can automatically trigger the first full backup.
Recovery integrates with <a href=#patroni><strong>Patroni</strong></a>, supporting bootstrapping replicas as new primaries or standbys.</p><p><a href=/docs/concept/pitr><img src=/img/dashboard/pgsql-pitr.webp alt=pgbackrest></a></p><p>For more information, see: <a href=/docs/pgsql/backup/><strong>Backup & Recovery</strong></a> and <a href=/docs/pgsql/param/#pg_backup><strong>Config: PGSQL - PG_BACKUP</strong></a></p><hr><h2 id=haproxy>HAProxy</h2><p><a href=http://www.haproxy.org/><strong>HAProxy</strong></a> is the service entry point and load balancer, exposing multiple database service ports.</p><table><thead><tr><th style=text-align:left>Port</th><th style=text-align:left>Service</th><th style=text-align:left>Target</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>9101</code></td><td style=text-align:left>Admin</td><td style=text-align:left>-</td><td style=text-align:left>HAProxy statistics and admin page</td></tr><tr><td style=text-align:left><code>5433</code></td><td style=text-align:left>primary</td><td style=text-align:left>Primary <a href=#pgbouncer>Pgbouncer</a></td><td style=text-align:left>Read-write service, routes to primary pool</td></tr><tr><td style=text-align:left><code>5434</code></td><td style=text-align:left>replica</td><td style=text-align:left>Replica <a href=#pgbouncer>Pgbouncer</a></td><td style=text-align:left>Read-only service, routes to replica pool</td></tr><tr><td style=text-align:left><code>5436</code></td><td style=text-align:left>default</td><td style=text-align:left>Primary <a href=#postgresql>Postgres</a></td><td style=text-align:left>Default service, direct to primary (bypasses pool)</td></tr><tr><td style=text-align:left><code>5438</code></td><td style=text-align:left>offline</td><td style=text-align:left>Offline <a href=#postgresql>Postgres</a></td><td style=text-align:left>Offline service, direct to offline replica (ETL/analytics)</td></tr></tbody></table><p><strong>HAProxy</strong> uses <a href=#patroni><strong>Patroni</strong></a> REST API health checks to determine instance roles and route traffic to the appropriate primary or replica.
Service definitions are composed from <a href=/docs/pgsql/param#pg_default_services><strong><code>pg_default_services</code></strong></a> and <a href=/docs/pgsql/param#pg_services><strong><code>pg_services</code></strong></a>.</p><p>A dedicated HAProxy node group can be specified via <a href=/docs/pgsql/param#pg_service_provider><strong><code>pg_service_provider</code></strong></a> to handle higher traffic;
by default, <strong>HAProxy</strong> on local nodes publishes services.</p><p><a href=/docs/concept/ha/svc><img src=/img/dashboard/node-haproxy.webp alt=haproxy></a></p><p>For more information, see: <a href=/docs/pgsql/service/><strong>Service Access</strong></a> and <a href=/docs/pgsql/param/#pg_access><strong>Config: PGSQL - PG_ACCESS</strong></a></p><hr><h2 id=vip-manager>vip-manager</h2><p><a href=https://github.com/cybertec-postgresql/vip-manager><strong>vip-manager</strong></a> binds L2 VIP to the current primary node. This is an optional component; enable it if your network supports L2 VIP.</p><p><strong>vip-manager</strong> runs on each PG node, monitoring the leader key written by <a href=#patroni><strong>Patroni</strong></a> in <a href=#etcd><strong>etcd</strong></a>,
and binds <a href=/docs/pgsql/param#pg_vip_address><strong><code>pg_vip_address</code></strong></a> to the current primary node&rsquo;s network interface.
When cluster failover occurs, <strong>vip-manager</strong> immediately releases the VIP from the old primary and rebinds it on the new primary, switching traffic to the new primary.</p><p>This component is optional, enabled via <a href=/docs/pgsql/param#pg_vip_enabled><strong><code>pg_vip_enabled</code></strong></a>.
When enabled, ensure all nodes are in the same VLAN; otherwise, VIP migration will fail.
Public cloud networks typically don&rsquo;t support L2 VIP; it&rsquo;s recommended only for on-premises and private cloud environments.</p><p><a href=/docs/concept/ha/svc><img src=/img/dashboard/node-vip.webp alt=node-vip></a></p><p>For more information, see: <a href=/docs/pgsql/tutorial/pg-vip/><strong>Tutorial: VIP Configuration</strong></a> and <a href=/docs/pgsql/param/#pg_access><strong>Config: PGSQL - PG_ACCESS</strong></a></p><hr><h2 id=pg_exporter>pg_exporter</h2><p><a href=https://github.com/pgsty/pg_exporter><strong>pg_exporter</strong></a> exports <a href=#postgresql>PostgreSQL</a> monitoring metrics, listening on port <code>9630</code> by default.</p><p><strong>pg_exporter</strong> runs on each PG node, connecting to <a href=#postgresql><strong>PostgreSQL</strong></a> via local Unix socket,
exporting rich metrics covering sessions, buffer hits, replication lag, transaction rates, etc., scraped by <strong>VictoriaMetrics</strong> on INFRA nodes.</p><p>Collection configuration is specified by <a href=/docs/pgsql/param#pg_exporter_config><strong><code>pg_exporter_config</code></strong></a>,
with support for automatic database discovery (<a href=/docs/pgsql/param#pg_exporter_auto_discovery><strong><code>pg_exporter_auto_discovery</code></strong></a>),
and tiered cache strategies via <a href=/docs/pgsql/param#pg_exporter_cache_ttls><strong><code>pg_exporter_cache_ttls</code></strong></a>.</p><p>You can disable this component via parameters; in <a href=/docs/setup/slim><strong>slim install</strong></a>, this component is not enabled.</p><p><a href=https://demo.pigsty.io/ui/d/pgsql-exporter><img src=/img/dashboard/pgsql-exporter.webp alt=pg-exporter></a></p><p>For more information, see: <a href=/docs/pgsql/param/#pg_monitor><strong>Config: PGSQL - PG_MONITOR</strong></a></p><hr><h2 id=pgbouncer_exporter>pgbouncer_exporter</h2><p><strong>pgbouncer_exporter</strong> exports <a href=#pgbouncer>Pgbouncer</a> connection pool metrics, listening on port <code>9631</code> by default.</p><p><code>pgbouncer_exporter</code> uses the same <a href=#pg_exporter><strong>pg_exporter</strong></a> binary but with a dedicated metrics config file, supporting pgbouncer 1.8-1.25+.
<strong>pgbouncer_exporter</strong> reads <a href=#pgbouncer><strong>Pgbouncer</strong></a> statistics views, providing pool utilization, wait queue, and hit rate metrics.</p><p>If <a href=#pgbouncer><strong>Pgbouncer</strong></a> is disabled, this component is also disabled. In <a href=/docs/setup/slim><strong>slim install</strong></a>, this component is not enabled.</p><p>For more information, see: <a href=/docs/pgsql/param/#pg_monitor><strong>Config: PGSQL - PG_MONITOR</strong></a></p><hr><h2 id=pgbackrest_exporter>pgbackrest_exporter</h2><p><strong>pgbackrest_exporter</strong> exports backup status metrics, listening on port <code>9854</code> by default.</p><p><strong>pgbackrest_exporter</strong> parses <a href=#pgbackrest><strong>pgBackRest</strong></a> status, generating metrics for most recent backup time, size, type, etc. Combined with alerting policies, it quickly detects expired or failed backups, ensuring data safety.
Note that when there are many backups or using large network repositories, collection overhead can be significant, so <strong>pgbackrest_exporter</strong> has a default 2-minute collection interval.
In the worst case, you may see the latest backup status in the monitoring system 2 minutes after a backup completes.</p><p>For more information, see: <a href=/docs/pgsql/param/#pg_monitor><strong>Config: PGSQL - PG_MONITOR</strong></a></p><hr><h2 id=etcd>etcd</h2><p><a href=/docs/etcd><strong>etcd</strong></a> is a distributed consistent store (DCS), providing cluster metadata storage and leader election capability for <a href=#patroni><strong>Patroni</strong></a>.</p><p>etcd is deployed and managed by the independent <a href=/docs/etcd><strong>ETCD module</strong></a>, not part of the PGSQL module itself, but critical for PostgreSQL HA.
<a href=#patroni>Patroni</a> writes cluster state, leader info, and config parameters to etcd; all nodes reach consensus through etcd.
<a href=#vip-manager>vip-manager</a> also reads the leader key from etcd to enable automatic VIP migration.</p><p>For more information, see: <a href=/docs/etcd/><strong>ETCD Module</strong></a></p><hr><h2 id=vector>vector</h2><p><a href=https://vector.dev/><strong>Vector</strong></a> is a high-performance log collection component, deployed by the <a href=/docs/node><strong>NODE module</strong></a>, responsible for collecting PostgreSQL-related logs.</p><p>Vector runs on nodes, tracking <a href=#postgresql>PostgreSQL</a>, <a href=#pgbouncer>Pgbouncer</a>, <a href=#patroni>Patroni</a>, and <a href=#pgbackrest>pgBackRest</a> log directories,
sending structured logs to VictoriaLogs on INFRA nodes for centralized storage and querying.</p><p>For more information, see: <a href=/docs/node/><strong>NODE Module</strong></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-d1b03f22fc5f90cf6ddcf42073d7603d>2 - ER Model</h1><div class=lead>How Pigsty abstracts different functionality into modules, and the E-R diagrams for these modules.</div><p>The largest entity concept in Pigsty is a <strong>Deployment</strong>. The main entities and relationships (E-R diagram) in a deployment are shown below:</p><p><img src=/img/pigsty/er-full.svg alt></p><p>A deployment can also be understood as an <strong>Environment</strong>. For example, Production (Prod), User Acceptance Testing (UAT), Staging, Testing, Development (Devbox), etc.
Each environment corresponds to a Pigsty <a href=/docs/concept/iac/inventory><strong>inventory</strong></a> that describes all entities and attributes in that environment.</p><p>Typically, an environment includes shared infrastructure (<a href=/docs/infra><strong><code>INFRA</code></strong></a>), which broadly includes <a href=/docs/etcd><strong><code>ETCD</code></strong></a> (HA DCS) and <a href=/docs/minio><strong><code>MINIO</code></strong></a> (centralized backup repository),
serving multiple PostgreSQL database clusters (and other database module components). (Exception: there are also <a href=/docs/setup/slim><strong>deployments without infrastructure</strong></a>)</p><p>In Pigsty, almost all database modules are organized as &ldquo;<strong>Clusters</strong>&rdquo;. Each cluster is an Ansible group containing several node resources.
For example, PostgreSQL HA database clusters, Redis, Etcd/MinIO all exist as clusters. An environment can contain multiple clusters.</p><ul><li><a href=/docs/concept/model/pgsql><strong>PostgreSQL Cluster</strong></a></li><li><a href=/docs/concept/model/etcd><strong>ETCD Cluster</strong></a></li><li><a href=/docs/concept/model/minio><strong>MinIO Cluster</strong></a></li><li><a href=/docs/concept/model/redis><strong>Redis Cluster</strong></a></li><li><a href=/docs/concept/model/infra><strong>INFRA Nodes</strong></a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2ad10e50acca12cdeaaf406b2cf23f3b>2.1 - E-R Model of Infra Cluster</h1><div class=lead>Entity-Relationship model for INFRA infrastructure nodes in Pigsty, component composition, and naming conventions.</div><p>The INFRA module plays a special role in Pigsty: it&rsquo;s not a traditional &ldquo;cluster&rdquo; but rather a management hub composed of a group of <strong>infrastructure nodes</strong>, providing core services for the entire Pigsty deployment.
Each INFRA node is an <strong>autonomous</strong> infrastructure service unit running core components like Nginx, Grafana, and VictoriaMetrics, collectively providing observability and management capabilities for managed database clusters.</p><p>There are two core entities in Pigsty&rsquo;s INFRA module:</p><ul><li><strong>Node</strong>: A server running infrastructure components—can be bare metal, VM, container, or Pod.</li><li><strong>Component</strong>: Various infrastructure services running on nodes, such as Nginx, Grafana, VictoriaMetrics, etc.</li></ul><p>INFRA nodes typically serve as Admin Nodes, the control plane of Pigsty.</p><hr><h2 id=component-composition>Component Composition</h2><p>Each INFRA node runs the following core components:</p><table class=full-width><thead><tr><th style=text-align:left>Component</th><th style=text-align:left>Port</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/concept/arch/infra#nginx><strong>Nginx</strong></a></td><td style=text-align:left><code>80/443</code></td><td style=text-align:left>Web portal, local repo, unified reverse proxy</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#grafana><strong>Grafana</strong></a></td><td style=text-align:left><code>3000</code></td><td style=text-align:left>Visualization platform, dashboards, data apps</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a></td><td style=text-align:left><code>8428</code></td><td style=text-align:left>Time-series database, Prometheus API compatible</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#victorialogs><strong>VictoriaLogs</strong></a></td><td style=text-align:left><code>9428</code></td><td style=text-align:left>Log database, receives structured logs from Vector</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#victoriatraces><strong>VictoriaTraces</strong></a></td><td style=text-align:left><code>10428</code></td><td style=text-align:left>Trace storage for slow SQL / request tracing</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#vmalert><strong>VMAlert</strong></a></td><td style=text-align:left><code>8880</code></td><td style=text-align:left>Alert rule evaluator based on VictoriaMetrics</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#alertmanager><strong>Alertmanager</strong></a></td><td style=text-align:left><code>9059</code></td><td style=text-align:left>Alert aggregation and dispatch</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#blackboxexporter><strong>Blackbox Exporter</strong></a></td><td style=text-align:left><code>9115</code></td><td style=text-align:left>ICMP/TCP/HTTP black-box probing</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#dnsmasq><strong>DNSMASQ</strong></a></td><td style=text-align:left><code>53</code></td><td style=text-align:left>DNS server for internal domain resolution</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#chronyd><strong>Chronyd</strong></a></td><td style=text-align:left><code>123</code></td><td style=text-align:left>NTP time server</td></tr></tbody></table><p>These components together form Pigsty&rsquo;s observability infrastructure.</p><hr><h2 id=examples>Examples</h2><p>Let&rsquo;s look at a concrete example with a two-node INFRA deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The above config fragment defines a two-node INFRA deployment:</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>Group</strong></span></th><th><span class=text-secondary><strong>Description</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>infra</code></strong></td><td>INFRA infrastructure node group</td></tr><tr><td style=text-align:center><span class=text-danger><strong>Node</strong></span></td><td><span class=text-danger><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>infra-1</code></strong></td><td><code>10.10.10.10</code> INFRA node #1</td></tr><tr><td style=text-align:center><strong><code>infra-2</code></strong></td><td><code>10.10.10.11</code> INFRA node #2</td></tr></tbody></table><p>For production environments, deploying at least two INFRA nodes is recommended for infrastructure component redundancy.</p><hr><h2 id=identity-parameters>Identity Parameters</h2><p>Pigsty uses the <a href=/docs/infra/param#infra_id><strong><code>INFRA_ID</code></strong></a> parameter group to assign deterministic identities to each INFRA module entity. One parameter is required:</p><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th><th style=text-align:left>Format</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/infra/param#infra_seq><strong><code>infra_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>Node</td><td style=text-align:left>INFRA node sequence, required</td><td style=text-align:left>Natural number, starting from 1, unique within group</td></tr></tbody></table><p>With node sequence assigned at node level, Pigsty automatically generates unique identifiers for each entity based on rules:</p><table class=full-width><thead><tr><th>Entity</th><th style=text-align:left>Generation Rule</th><th style=text-align:left>Example</th></tr></thead><tbody><tr><td><strong>Node</strong></td><td style=text-align:left><code>infra-{{ infra_seq }}</code></td><td style=text-align:left><code>infra-1</code>, <code>infra-2</code></td></tr></tbody></table><p>The INFRA module assigns <code>infra-N</code> format identifiers to nodes for distinguishing multiple infrastructure nodes in the monitoring system.
However, this doesn&rsquo;t change the node&rsquo;s hostname or system identity; nodes still use their existing hostname or IP address for identification.</p><hr><h2 id=service-portal>Service Portal</h2><p>INFRA nodes provide unified web service entry through Nginx. The <a href=/docs/infra/param#infra_portal><strong><code>infra_portal</code></strong></a> parameter defines services exposed through Nginx.</p><p>The default configuration only defines the home server:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty automatically configures reverse proxy endpoints for enabled components (Grafana, VictoriaMetrics, AlertManager, etc.). If you need to access these services via separate domains, you can explicitly add configurations:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home         </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>grafana      </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: g.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:3000&#34;</span><span style=color:#204a87;font-weight:700>, websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>prometheus   </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: p.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:8428&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># VMUI</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>alertmanager </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: a.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:9059&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:left>Domain</th><th style=text-align:left>Service</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>i.pigsty</code></td><td style=text-align:left>Home</td><td style=text-align:left>Pigsty homepage</td></tr><tr><td style=text-align:left><code>g.pigsty</code></td><td style=text-align:left>Grafana</td><td style=text-align:left>Monitoring dashboard</td></tr><tr><td style=text-align:left><code>p.pigsty</code></td><td style=text-align:left>VictoriaMetrics</td><td style=text-align:left>TSDB Web UI</td></tr><tr><td style=text-align:left><code>a.pigsty</code></td><td style=text-align:left>Alertmanager</td><td style=text-align:left>Alert management UI</td></tr></tbody></table><p>Accessing Pigsty services via domain names is recommended over direct IP + port.</p><hr><h2 id=deployment-scale>Deployment Scale</h2><p>The number of INFRA nodes depends on deployment scale and HA requirements:</p><table class=full-width><thead><tr><th style=text-align:left>Scale</th><th style=text-align:left>INFRA Nodes</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>Dev/Test</td><td style=text-align:left>1</td><td style=text-align:left>Single-node deployment, all on one node</td></tr><tr><td style=text-align:left>Small Prod</td><td style=text-align:left>1-2</td><td style=text-align:left>Single or dual node, can share with other services</td></tr><tr><td style=text-align:left>Medium Prod</td><td style=text-align:left>2-3</td><td style=text-align:left>Dedicated INFRA nodes, redundant components</td></tr><tr><td style=text-align:left>Large Prod</td><td style=text-align:left>3+</td><td style=text-align:left>Multiple INFRA nodes, component separation</td></tr></tbody></table><p>In <a href=/docs/setup/install><strong>singleton deployment</strong></a>, INFRA components share the same node with PGSQL, ETCD, etc.
In small-scale deployments, INFRA nodes typically also serve as &ldquo;<a href=/docs/concept/arch/node#admin-node><strong>Admin Node</strong></a>&rdquo; / backup admin node and local software repository (<code>/www/pigsty</code>).
In larger deployments, these responsibilities can be separated to dedicated nodes.</p><hr><h2 id=monitoring-label-system>Monitoring Label System</h2><p>Pigsty&rsquo;s monitoring system collects metrics from INFRA components themselves. Unlike database modules, each <strong>component</strong> in the INFRA module is treated as an independent monitoring object, distinguished by the <code>cls</code> (class) label.</p><table class=full-width><thead><tr><th style=text-align:left>Label</th><th style=text-align:left>Description</th><th style=text-align:left>Example</th></tr></thead><tbody><tr><td style=text-align:left><code>cls</code></td><td style=text-align:left>Component type, each forming a &ldquo;class&rdquo;</td><td style=text-align:left><code>nginx</code></td></tr><tr><td style=text-align:left><code>ins</code></td><td style=text-align:left>Instance name, format <code>{component}-{infra_seq}</code></td><td style=text-align:left><code>nginx-1</code></td></tr><tr><td style=text-align:left><code>ip</code></td><td style=text-align:left>INFRA node IP running the component</td><td style=text-align:left><code>10.10.10.10</code></td></tr><tr><td style=text-align:left><code>job</code></td><td style=text-align:left>VictoriaMetrics scrape job, fixed as <code>infra</code></td><td style=text-align:left><code>infra</code></td></tr></tbody></table><p>Using a two-node INFRA deployment (<code>infra_seq: 1</code> and <code>infra_seq: 2</code>) as example, component monitoring labels are:</p><table class=full-width><thead><tr><th style=text-align:left>Component</th><th style=text-align:left><code>cls</code></th><th style=text-align:left><code>ins</code> Example</th><th style=text-align:left>Port</th></tr></thead><tbody><tr><td style=text-align:left><strong>Nginx</strong></td><td style=text-align:left><code>nginx</code></td><td style=text-align:left><code>nginx-1</code>, <code>nginx-2</code></td><td style=text-align:left><code>9113</code></td></tr><tr><td style=text-align:left><strong>Grafana</strong></td><td style=text-align:left><code>grafana</code></td><td style=text-align:left><code>grafana-1</code>, <code>grafana-2</code></td><td style=text-align:left><code>3000</code></td></tr><tr><td style=text-align:left><strong>VictoriaMetrics</strong></td><td style=text-align:left><code>vmetrics</code></td><td style=text-align:left><code>vmetrics-1</code>, <code>vmetrics-2</code></td><td style=text-align:left><code>8428</code></td></tr><tr><td style=text-align:left><strong>VictoriaLogs</strong></td><td style=text-align:left><code>vlogs</code></td><td style=text-align:left><code>vlogs-1</code>, <code>vlogs-2</code></td><td style=text-align:left><code>9428</code></td></tr><tr><td style=text-align:left><strong>VictoriaTraces</strong></td><td style=text-align:left><code>vtraces</code></td><td style=text-align:left><code>vtraces-1</code>, <code>vtraces-2</code></td><td style=text-align:left><code>10428</code></td></tr><tr><td style=text-align:left><strong>VMAlert</strong></td><td style=text-align:left><code>vmalert</code></td><td style=text-align:left><code>vmalert-1</code>, <code>vmalert-2</code></td><td style=text-align:left><code>8880</code></td></tr><tr><td style=text-align:left><strong>Alertmanager</strong></td><td style=text-align:left><code>alertmanager</code></td><td style=text-align:left><code>alertmanager-1</code>, <code>alertmanager-2</code></td><td style=text-align:left><code>9059</code></td></tr><tr><td style=text-align:left><strong>Blackbox</strong></td><td style=text-align:left><code>blackbox</code></td><td style=text-align:left><code>blackbox-1</code>, <code>blackbox-2</code></td><td style=text-align:left><code>9115</code></td></tr></tbody></table><p>All INFRA component metrics use a unified <code>job="infra"</code> label, distinguished by the <code>cls</code> label:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>nginx_up{cls=&#34;nginx&#34;, ins=&#34;nginx-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>grafana_info{cls=&#34;grafana&#34;, ins=&#34;grafana-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>vm_app_version{cls=&#34;vmetrics&#34;, ins=&#34;vmetrics-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>vlogs_rows_ingested_total{cls=&#34;vlogs&#34;, ins=&#34;vlogs-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>alertmanager_alerts{cls=&#34;alertmanager&#34;, ins=&#34;alertmanager-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-97ed05d79e93eabb25565a36bc328883>2.2 - E-R Model of PostgreSQL Cluster</h1><div class=lead>Entity-Relationship model for PostgreSQL clusters in Pigsty, including E-R diagram, entity definitions, and naming conventions.</div><p>The PGSQL module organizes PostgreSQL in production as <strong>clusters</strong>—<strong>logical entities</strong> composed of a group of database <strong>instances</strong> associated by <strong>primary-replica</strong> relationships.</p><p>Each cluster is an <strong>autonomous</strong> business unit consisting of at least one <strong>primary instance</strong>, exposing capabilities through services.</p><p>There are four core entities in Pigsty&rsquo;s PGSQL module:</p><ul><li><strong>Cluster</strong>: An autonomous PostgreSQL business unit serving as the top-level namespace for other entities.</li><li><strong>Service</strong>: A named abstraction that exposes capabilities, routes traffic, and exposes services using node ports.</li><li><strong>Instance</strong>: A single PostgreSQL server consisting of running processes and database files on a single node.</li><li><strong>Node</strong>: A hardware resource abstraction running Linux + Systemd environment—can be bare metal, VM, container, or Pod.</li></ul><p>Along with two business entities—&ldquo;Database&rdquo; and &ldquo;Role&rdquo;—these form the complete logical view as shown below:</p><p><img src=/img/pigsty/er-pgsql.svg alt=er-pgsql></p><hr><h2 id=examples>Examples</h2><p>Let&rsquo;s look at two concrete examples. Using the four-node Pigsty <a href=/docs/deploy/sandbox><strong>sandbox</strong></a>, there&rsquo;s a three-node <code>pg-test</code> cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The above config fragment defines a <a href=/docs/concept/ha/><strong>high-availability</strong></a> PostgreSQL cluster with these related entities:</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>Cluster</strong></span></th><th><span class=text-secondary><strong>Description</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>pg-test</code></strong></td><td>PostgreSQL 3-node HA cluster</td></tr><tr><td style=text-align:center><span class=text-success><strong>Instance</strong></span></td><td><span class=text-success><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>pg-test-1</code></strong></td><td>PostgreSQL instance #1, default primary</td></tr><tr><td style=text-align:center><strong><code>pg-test-2</code></strong></td><td>PostgreSQL instance #2, initial replica</td></tr><tr><td style=text-align:center><strong><code>pg-test-3</code></strong></td><td>PostgreSQL instance #3, initial replica</td></tr><tr><td style=text-align:center><span class=text-info><strong>Service</strong></span></td><td><span class=text-info><strong>Description</strong></span></td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#primary-service><strong><code>pg-test-primary</code></strong></a></td><td>Read-write service (routes to primary pgbouncer)</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#replica-service><strong><code>pg-test-replica</code></strong></a></td><td>Read-only service (routes to replica pgbouncer)</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#default-service><strong><code>pg-test-default</code></strong></a></td><td>Direct read-write service (routes to primary postgres)</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#offline-service><strong><code>pg-test-offline</code></strong></a></td><td>Offline read service (routes to dedicated postgres)</td></tr><tr><td style=text-align:center><span class=text-danger><strong>Node</strong></span></td><td><span class=text-danger><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>node-1</code></strong></td><td><code>10.10.10.11</code> Node #1, hosts <code>pg-test-1</code> PG instance</td></tr><tr><td style=text-align:center><strong><code>node-2</code></strong></td><td><code>10.10.10.12</code> Node #2, hosts <code>pg-test-2</code> PG instance</td></tr><tr><td style=text-align:center><strong><code>node-3</code></strong></td><td><code>10.10.10.13</code> Node #3, hosts <code>pg-test-3</code> PG instance</td></tr></tbody></table><p><img src=/img/pigsty/ha.png alt=ha></p><hr><h2 id=identity-parameters>Identity Parameters</h2><p>Pigsty uses the <a href=/docs/pgsql/param#pg_id><strong><code>PG_ID</code></strong></a> parameter group to assign deterministic identities to each PGSQL module entity. Three parameters are required:</p><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th><th>Format</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_cluster><strong><code>pg_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>Cluster</td><td style=text-align:left>PG cluster name, required</td><td>Valid DNS name, regex <code>[a-zA-Z0-9-]+</code></td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_seq><strong><code>pg_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>Instance</td><td style=text-align:left>PG instance number, required</td><td>Natural number, starting from 0 or 1, unique within cluster</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_role><strong><code>pg_role</code></strong></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center>Instance</td><td style=text-align:left>PG instance role, required</td><td>Enum: <code>primary</code>, <code>replica</code>, <code>offline</code></td></tr></tbody></table><p>With cluster name defined at cluster level and instance number/role assigned at instance level, Pigsty automatically generates unique identifiers for each entity based on rules:</p><table class=full-width><thead><tr><th>Entity</th><th>Generation Rule</th><th>Example</th></tr></thead><tbody><tr><td><strong>Instance</strong></td><td><code>{{ pg_cluster }}-{{ pg_seq }}</code></td><td><code>pg-test-1</code>, <code>pg-test-2</code>, <code>pg-test-3</code></td></tr><tr><td><strong>Service</strong></td><td><code>{{ pg_cluster }}-{{ pg_role }}</code></td><td><code>pg-test-primary</code>, <code>pg-test-replica</code>, <code>pg-test-offline</code></td></tr><tr><td><strong>Node</strong></td><td>Explicitly specified or borrowed from PG</td><td><code>pg-test-1</code>, <code>pg-test-2</code>, <code>pg-test-3</code></td></tr></tbody></table><p>Because Pigsty adopts a 1:1 exclusive deployment model for nodes and PG instances, by default the host node identifier borrows from the PG instance identifier (<a href=/docs/node/param#node_id_from_pg><strong><code>node_id_from_pg</code></strong></a>).
You can also explicitly specify <a href=/docs/node/param#nodename><strong><code>nodename</code></strong></a> to override, or disable <a href=/docs/node/param#nodename_overview><strong><code>nodename_overwrite</code></strong></a> to use the current default.</p><hr><h2 id=sharding-identity-parameters>Sharding Identity Parameters</h2><p>When using multiple PostgreSQL clusters (<strong>sharding</strong>) to serve the same business, two additional identity parameters are used: <a href=/docs/pgsql/param#pg_shard><strong><code>pg_shard</code></strong></a> and <a href=/docs/pgsql/param#pg_group><strong><code>pg_group</code></strong></a>.</p><p>In this case, this group of PostgreSQL clusters shares the same <code>pg_shard</code> name with their own <code>pg_group</code> numbers, like this <a href=/docs/pgsql/config/#citus-cluster><strong>Citus cluster</strong></a>:</p><p>In this case, <code>pg_cluster</code> cluster names are typically composed of: <code>{{ pg_shard }}{{ pg_group }}</code>, e.g., <code>pg-citus0</code>, <code>pg-citus1</code>, etc.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty provides dedicated monitoring dashboards for horizontal sharding clusters, making it easy to compare performance and load across shards, but this requires using the above entity naming convention.</p><p>There are also other identity parameters for special scenarios, such as <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a> for specifying backup clusters/cascading replication upstream, <a href=/docs/pgsql/param#gp_role><code>gp_role</code></a> for Greenplum cluster identity,
<a href=/docs/pgsql/param#pg_exporters><code>pg_exporters</code></a> for external monitoring instances, <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> for offline query instances, etc. See <a href=/docs/pgsql/param#pg_id><strong><code>PG_ID</code> parameter docs</strong></a>.</p><hr><h2 id=monitoring-label-system>Monitoring Label System</h2><p>Pigsty provides an out-of-box monitoring system that uses the above <a href=#identity-parameters><strong>identity parameters</strong></a> to identify various PostgreSQL entities.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-1&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;pgsql&#34;}
</span></span><span style=display:flex><span>pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-2&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;pgsql&#34;}
</span></span><span style=display:flex><span>pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-3&#34;, ip=&#34;10.10.10.13&#34;, job=&#34;pgsql&#34;}
</span></span></code></pre></div><p>For example, the <code>cls</code>, <code>ins</code>, <code>ip</code> labels correspond to cluster name, instance name, and node IP—the identifiers for these three core entities.
They appear along with the <code>job</code> label in <strong>all</strong> native monitoring metrics collected by <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a> and <a href=/docs/concept/arch/infra#victorialogs><strong>VictoriaLogs</strong></a> log streams.</p><p>The <code>job</code> name for collecting PostgreSQL metrics is fixed as <code>pgsql</code>;
The <code>job</code> name for monitoring remote PG instances is fixed as <code>pgrds</code>.
The <code>job</code> name for collecting PostgreSQL CSV logs is fixed as <code>postgres</code>;
The <code>job</code> name for collecting pgbackrest logs is fixed as <code>pgbackrest</code>, other PG components collect logs via <code>job: syslog</code>.</p><p>Additionally, some entity identity labels appear in specific entity-related monitoring metrics, such as:</p><ul><li><code>datname</code>: Database name, if a metric belongs to a specific database.</li><li><code>relname</code>: Table name, if a metric belongs to a specific table.</li><li><code>idxname</code>: Index name, if a metric belongs to a specific index.</li><li><code>funcname</code>: Function name, if a metric belongs to a specific function.</li><li><code>seqname</code>: Sequence name, if a metric belongs to a specific sequence.</li><li><code>query</code>: Query fingerprint, if a metric belongs to a specific query.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5a875c30b5ea163b13415e0cf143a46f>2.3 - E-R Model of Etcd Cluster</h1><div class=lead>Entity-Relationship model for ETCD clusters in Pigsty, including E-R diagram, entity definitions, and naming conventions.</div><p>The ETCD module organizes ETCD in production as <strong>clusters</strong>—<strong>logical entities</strong> composed of a group of ETCD <strong>instances</strong> associated through the <strong>Raft</strong> consensus protocol.</p><p>Each cluster is an <strong>autonomous</strong> distributed key-value storage unit consisting of at least one <strong>ETCD instance</strong>, exposing service capabilities through client ports.</p><p>There are three core entities in Pigsty&rsquo;s ETCD module:</p><ul><li><strong>Cluster</strong>: An autonomous ETCD service unit serving as the top-level namespace for other entities.</li><li><strong>Instance</strong>: A single ETCD server process running on a node, participating in Raft consensus.</li><li><strong>Node</strong>: A hardware resource abstraction running Linux + Systemd environment, implicitly declared.</li></ul><p>Compared to PostgreSQL clusters, the ETCD cluster model is simpler, without Services or complex Role distinctions.
All ETCD instances are functionally equivalent, electing a Leader through the Raft protocol while others become Followers.
During scale-out intermediate states, non-voting Learner instance members are also allowed.</p><hr><h2 id=examples>Examples</h2><p>Let&rsquo;s look at a concrete example with a three-node ETCD cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The above config fragment defines a three-node ETCD cluster with these related entities:</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>Cluster</strong></span></th><th><span class=text-secondary><strong>Description</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>etcd</code></strong></td><td>ETCD 3-node HA cluster</td></tr><tr><td style=text-align:center><span class=text-success><strong>Instance</strong></span></td><td><span class=text-success><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>etcd-1</code></strong></td><td>ETCD instance #1</td></tr><tr><td style=text-align:center><strong><code>etcd-2</code></strong></td><td>ETCD instance #2</td></tr><tr><td style=text-align:center><strong><code>etcd-3</code></strong></td><td>ETCD instance #3</td></tr><tr><td style=text-align:center><span class=text-danger><strong>Node</strong></span></td><td><span class=text-danger><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>10.10.10.10</code></strong></td><td>Node #1, hosts <code>etcd-1</code> instance</td></tr><tr><td style=text-align:center><strong><code>10.10.10.11</code></strong></td><td>Node #2, hosts <code>etcd-2</code> instance</td></tr><tr><td style=text-align:center><strong><code>10.10.10.12</code></strong></td><td>Node #3, hosts <code>etcd-3</code> instance</td></tr></tbody></table><hr><h2 id=identity-parameters>Identity Parameters</h2><p>Pigsty uses the <a href=/docs/etcd/param#etcd><strong><code>ETCD</code></strong></a> parameter group to assign deterministic identities to each ETCD module entity. Two parameters are required:</p><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th><th style=text-align:left>Format</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/etcd/param#etcd_cluster><strong><code>etcd_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>Cluster</td><td style=text-align:left>ETCD cluster name, required</td><td style=text-align:left>Valid DNS name, defaults to fixed <code>etcd</code></td></tr><tr><td style=text-align:left><a href=/docs/etcd/param#etcd_seq><strong><code>etcd_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>Instance</td><td style=text-align:left>ETCD instance number, required</td><td style=text-align:left>Natural number, starting from 1, unique within cluster</td></tr></tbody></table><p>With cluster name defined at cluster level and instance number assigned at instance level, Pigsty automatically generates unique identifiers for each entity based on rules:</p><table class=full-width><thead><tr><th>Entity</th><th style=text-align:left>Generation Rule</th><th style=text-align:left>Example</th></tr></thead><tbody><tr><td><strong>Instance</strong></td><td style=text-align:left><code>{{ etcd_cluster }}-{{ etcd_seq }}</code></td><td style=text-align:left><code>etcd-1</code>, <code>etcd-2</code>, <code>etcd-3</code></td></tr></tbody></table><p>The ETCD module does not assign additional identity to host nodes; nodes are identified by their existing hostname or IP address.</p><hr><h2 id=ports--protocols>Ports & Protocols</h2><p>Each ETCD instance listens on the following two ports:</p><table class=full-width><thead><tr><th style=text-align:left>Port</th><th style=text-align:left>Parameter</th><th style=text-align:left>Purpose</th></tr></thead><tbody><tr><td style=text-align:left><strong>2379</strong></td><td style=text-align:left><a href=/docs/etcd/param#etcd_port><strong><code>etcd_port</code></strong></a></td><td style=text-align:left>Client port, accessed by Patroni, vip-manager, etc.</td></tr><tr><td style=text-align:left><strong>2380</strong></td><td style=text-align:left><a href=/docs/etcd/param#etcd_peer_port><strong><code>etcd_peer_port</code></strong></a></td><td style=text-align:left>Peer communication port, used for Raft consensus</td></tr></tbody></table><p>ETCD clusters enable TLS encrypted communication by default and use RBAC authentication mechanism. Clients need correct certificates and passwords to access ETCD services.</p><hr><h2 id=cluster-size>Cluster Size</h2><p>As a distributed coordination service, ETCD cluster size directly affects availability, requiring more than half (quorum) of nodes to be alive to maintain service.</p><table class=full-width><thead><tr><th style=text-align:center>Cluster Size</th><th style=text-align:center>Quorum</th><th style=text-align:center>Fault Tolerance</th><th style=text-align:left>Use Case</th></tr></thead><tbody><tr><td style=text-align:center>1 node</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:left>Dev, test, demo</td></tr><tr><td style=text-align:center>3 nodes</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:left>Small-medium production</td></tr><tr><td style=text-align:center>5 nodes</td><td style=text-align:center>3</td><td style=text-align:center>2</td><td style=text-align:left>Large-scale production</td></tr></tbody></table><p>Therefore, even-numbered ETCD clusters are meaningless, and clusters over five nodes are uncommon. Typical sizes are single-node, three-node, and five-node.</p><hr><h2 id=monitoring-label-system>Monitoring Label System</h2><p>Pigsty provides an out-of-box monitoring system that uses the above <a href=#identity-parameters><strong>identity parameters</strong></a> to identify various ETCD entities.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>etcd_up{cls=&#34;etcd&#34;, ins=&#34;etcd-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;etcd&#34;}
</span></span><span style=display:flex><span>etcd_up{cls=&#34;etcd&#34;, ins=&#34;etcd-2&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;etcd&#34;}
</span></span><span style=display:flex><span>etcd_up{cls=&#34;etcd&#34;, ins=&#34;etcd-3&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;etcd&#34;}
</span></span></code></pre></div><p>For example, the <code>cls</code>, <code>ins</code>, <code>ip</code> labels correspond to cluster name, instance name, and node IP—the identifiers for these three core entities.
They appear along with the <code>job</code> label in <strong>all</strong> ETCD monitoring metrics collected by <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a>.
The <code>job</code> name for collecting ETCD metrics is fixed as <code>etcd</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c495cfba1010bd7cf73164bea4ebc4f3>2.4 - E-R Model of MinIO Cluster</h1><div class=lead>Entity-Relationship model for MinIO clusters in Pigsty, including E-R diagram, entity definitions, and naming conventions.</div><p>The MinIO module organizes MinIO in production as <strong>clusters</strong>—<strong>logical entities</strong> composed of a group of distributed MinIO <strong>instances</strong>, collectively providing highly available object storage services.</p><p>Each cluster is an <strong>autonomous</strong> S3-compatible object storage unit consisting of at least one <strong>MinIO instance</strong>, exposing service capabilities through the S3 API port.</p><p>There are three core entities in Pigsty&rsquo;s MinIO module:</p><ul><li><strong>Cluster</strong>: An autonomous MinIO service unit serving as the top-level namespace for other entities.</li><li><strong>Instance</strong>: A single MinIO server process running on a node, managing local disk storage.</li><li><strong>Node</strong>: A hardware resource abstraction running Linux + Systemd environment, implicitly declared.</li></ul><p>Additionally, MinIO has the concept of <a href=/docs/minio/config#multi-pool-deployment><strong>Storage Pool</strong></a>, used for smooth cluster scaling.
A cluster can contain multiple storage pools, each composed of a group of nodes and disks.</p><hr><h2 id=deployment-modes>Deployment Modes</h2><p>MinIO supports three main deployment modes for different scenarios:</p><table class=full-width><thead><tr><th style=text-align:center>Mode</th><th style=text-align:center>Code</th><th style=text-align:left>Description</th><th style=text-align:left>Use Case</th></tr></thead><tbody><tr><td style=text-align:center><a href=/docs/minio/config#single-node-single-drive><strong>Single-Node Single-Drive</strong></a></td><td style=text-align:center><strong>SNSD</strong></td><td style=text-align:left>Single node, single data directory or disk</td><td style=text-align:left>Dev, test, demo</td></tr><tr><td style=text-align:center><a href=/docs/minio/config#single-node-multi-drive><strong>Single-Node Multi-Drive</strong></a></td><td style=text-align:center><strong>SNMD</strong></td><td style=text-align:left>Single node, multiple disks, typically 4+</td><td style=text-align:left>Resource-constrained small deployments</td></tr><tr><td style=text-align:center><a href=/docs/minio/config#multi-node-multi-drive><strong>Multi-Node Multi-Drive</strong></a></td><td style=text-align:center><strong>MNMD</strong></td><td style=text-align:left>Multiple nodes, multiple disks per node</td><td style=text-align:left><strong>Production recommended</strong></td></tr></tbody></table><p>SNSD mode can use any directory as storage for quick experimentation; SNMD and MNMD modes require real disk mount points, otherwise startup is refused.</p><hr><h2 id=examples>Examples</h2><p>Let&rsquo;s look at a concrete multi-node multi-drive example with a four-node MinIO cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data{1...4}&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${minio_cluster}-${minio_seq}.pigsty&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The above config fragment defines a four-node MinIO cluster with four disks per node:</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>Cluster</strong></span></th><th><span class=text-secondary><strong>Description</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>minio</code></strong></td><td>MinIO 4-node HA cluster</td></tr><tr><td style=text-align:center><span class=text-success><strong>Instance</strong></span></td><td><span class=text-success><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>minio-1</code></strong></td><td>MinIO instance #1, managing 4 disks</td></tr><tr><td style=text-align:center><strong><code>minio-2</code></strong></td><td>MinIO instance #2, managing 4 disks</td></tr><tr><td style=text-align:center><strong><code>minio-3</code></strong></td><td>MinIO instance #3, managing 4 disks</td></tr><tr><td style=text-align:center><strong><code>minio-4</code></strong></td><td>MinIO instance #4, managing 4 disks</td></tr><tr><td style=text-align:center><span class=text-danger><strong>Node</strong></span></td><td><span class=text-danger><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>10.10.10.10</code></strong></td><td>Node #1, hosts <code>minio-1</code> instance</td></tr><tr><td style=text-align:center><strong><code>10.10.10.11</code></strong></td><td>Node #2, hosts <code>minio-2</code> instance</td></tr><tr><td style=text-align:center><strong><code>10.10.10.12</code></strong></td><td>Node #3, hosts <code>minio-3</code> instance</td></tr><tr><td style=text-align:center><strong><code>10.10.10.13</code></strong></td><td>Node #4, hosts <code>minio-4</code> instance</td></tr></tbody></table><hr><h2 id=identity-parameters>Identity Parameters</h2><p>Pigsty uses the <a href=/docs/minio/param#minio><strong><code>MINIO</code></strong></a> parameter group to assign deterministic identities to each MinIO module entity. Two parameters are required:</p><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th><th style=text-align:left>Format</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/minio/param#minio_cluster><strong><code>minio_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>Cluster</td><td style=text-align:left>MinIO cluster name, required</td><td style=text-align:left>Valid DNS name, defaults to <code>minio</code></td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio_seq><strong><code>minio_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>Instance</td><td style=text-align:left>MinIO instance number, required</td><td style=text-align:left>Natural number, starting from 1, unique within cluster</td></tr></tbody></table><p>With cluster name defined at cluster level and instance number assigned at instance level, Pigsty automatically generates unique identifiers for each entity based on rules:</p><table class=full-width><thead><tr><th>Entity</th><th style=text-align:left>Generation Rule</th><th style=text-align:left>Example</th></tr></thead><tbody><tr><td><strong>Instance</strong></td><td style=text-align:left><code>{{ minio_cluster }}-{{ minio_seq }}</code></td><td style=text-align:left><code>minio-1</code>, <code>minio-2</code>, <code>minio-3</code>, <code>minio-4</code></td></tr></tbody></table><p>The MinIO module does not assign additional identity to host nodes; nodes are identified by their existing hostname or IP address.
The <a href=/docs/minio/param#minio_node><strong><code>minio_node</code></strong></a> parameter generates node names for MinIO cluster internal use (written to <code>/etc/hosts</code> for cluster discovery), not host node identity.</p><hr><h2 id=core-configuration-parameters>Core Configuration Parameters</h2><p>Beyond identity parameters, the following parameters are critical for MinIO cluster configuration:</p><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/minio/param#minio_data><strong><code>minio_data</code></strong></a></td><td style=text-align:center><code>path</code></td><td style=text-align:left>Data directory, use <code>{x...y}</code> for multi-drive</td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio_node><strong><code>minio_node</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:left>Node name pattern for multi-node deployment</td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio_domain><strong><code>minio_domain</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:left>Service domain, defaults to <code>sss.pigsty</code></td></tr></tbody></table><p>These parameters together determine MinIO&rsquo;s core config <code>MINIO_VOLUMES</code>:</p><ul><li><strong>SNSD</strong>: Direct <code>minio_data</code> value, e.g., <code>/data/minio</code></li><li><strong>SNMD</strong>: Expanded <code>minio_data</code> directories, e.g., <code>/data{1...4}</code></li><li><strong>MNMD</strong>: Combined <code>minio_node</code> and <code>minio_data</code>, e.g., <code>https://minio-{1...4}.pigsty:9000/data{1...4}</code></li></ul><hr><h2 id=ports--services>Ports & Services</h2><p>Each MinIO instance listens on the following ports:</p><table class=full-width><thead><tr><th style=text-align:left>Port</th><th style=text-align:left>Parameter</th><th style=text-align:left>Purpose</th></tr></thead><tbody><tr><td style=text-align:left>9000</td><td style=text-align:left><a href=/docs/minio/param#minio_port><strong><code>minio_port</code></strong></a></td><td style=text-align:left>S3 API service port</td></tr><tr><td style=text-align:left>9001</td><td style=text-align:left><a href=/docs/minio/param#minio_admin_port><strong><code>minio_admin_port</code></strong></a></td><td style=text-align:left>Web admin console port</td></tr></tbody></table><p>MinIO enables HTTPS encrypted communication by default (controlled by <a href=/docs/minio/param#minio_https><strong><code>minio_https</code></strong></a>). This is required for backup tools like pgBackREST to access MinIO.</p><p>Multi-node MinIO clusters can be accessed through <strong>any node</strong>. Best practice is to use a load balancer (e.g., HAProxy + VIP) for unified access point.</p><hr><h2 id=resource-provisioning>Resource Provisioning</h2><p>After MinIO cluster deployment, Pigsty automatically creates the following resources (controlled by <a href=/docs/minio/param#minio_provision><strong><code>minio_provision</code></strong></a>):</p><p><strong>Default Buckets</strong> (defined by <a href=/docs/minio/param#minio_buckets><strong><code>minio_buckets</code></strong></a>):</p><table class=full-width><thead><tr><th style=text-align:left>Bucket</th><th style=text-align:left>Purpose</th></tr></thead><tbody><tr><td style=text-align:left><code>pgsql</code></td><td style=text-align:left>PostgreSQL pgBackREST backup storage</td></tr><tr><td style=text-align:left><code>meta</code></td><td style=text-align:left>Metadata storage, versioning enabled</td></tr><tr><td style=text-align:left><code>data</code></td><td style=text-align:left>General data storage</td></tr></tbody></table><p><strong>Default Users</strong> (defined by <a href=/docs/minio/param#minio_users><strong><code>minio_users</code></strong></a>):</p><table class=full-width><thead><tr><th style=text-align:left>User</th><th style=text-align:left>Default Password</th><th style=text-align:left>Policy</th><th style=text-align:left>Purpose</th></tr></thead><tbody><tr><td style=text-align:left><code>pgbackrest</code></td><td style=text-align:left><code>S3User.Backup</code></td><td style=text-align:left><code>pgsql</code></td><td style=text-align:left>PostgreSQL backup dedicated user</td></tr><tr><td style=text-align:left><code>s3user_meta</code></td><td style=text-align:left><code>S3User.Meta</code></td><td style=text-align:left><code>meta</code></td><td style=text-align:left>Access <code>meta</code> bucket</td></tr><tr><td style=text-align:left><code>s3user_data</code></td><td style=text-align:left><code>S3User.Data</code></td><td style=text-align:left><code>data</code></td><td style=text-align:left>Access <code>data</code> bucket</td></tr></tbody></table><p><code>pgbackrest</code> is used for PostgreSQL cluster backups; <code>s3user_meta</code> and <code>s3user_data</code> are reserved users not actively used.</p><hr><h2 id=monitoring-label-system>Monitoring Label System</h2><p>Pigsty provides an out-of-box monitoring system that uses the above <a href=#identity-parameters><strong>identity parameters</strong></a> to identify various MinIO entities.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;minio&#34;}
</span></span><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-2&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;minio&#34;}
</span></span><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-3&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;minio&#34;}
</span></span><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-4&#34;, ip=&#34;10.10.10.13&#34;, job=&#34;minio&#34;}
</span></span></code></pre></div><p>For example, the <code>cls</code>, <code>ins</code>, <code>ip</code> labels correspond to cluster name, instance name, and node IP—the identifiers for these three core entities.
They appear along with the <code>job</code> label in <strong>all</strong> MinIO monitoring metrics collected by <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a>.
The <code>job</code> name for collecting MinIO metrics is fixed as <code>minio</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0de22cd0f8c383fe4e1ef5a4eb6b5440>2.5 - E-R Model of Redis Cluster</h1><div class=lead>Entity-Relationship model for Redis clusters in Pigsty, including E-R diagram, entity definitions, and naming conventions.</div><p>The Redis module organizes Redis in production as <strong>clusters</strong>—<strong>logical entities</strong> composed of a group of Redis <strong>instances</strong> deployed on one or more <strong>nodes</strong>.</p><p>Each cluster is an <strong>autonomous</strong> high-performance cache/storage unit consisting of at least one <strong>Redis instance</strong>, exposing service capabilities through ports.</p><p>There are three core entities in Pigsty&rsquo;s Redis module:</p><ul><li><strong>Cluster</strong>: An autonomous Redis service unit serving as the top-level namespace for other entities.</li><li><strong>Instance</strong>: A single Redis server process running on a specific port on a node.</li><li><strong>Node</strong>: A hardware resource abstraction running Linux + Systemd environment, can host multiple Redis instances, implicitly declared.</li></ul><p>Unlike PostgreSQL, Redis uses a <strong>single-node multi-instance</strong> deployment model: one physical/virtual machine node typically deploys <strong>multiple</strong> Redis instances
to fully utilize multi-core CPUs. Therefore, nodes and instances have a <strong>1:N</strong> relationship. Additionally, production typically advises against Redis instances with memory > 12GB.</p><hr><h2 id=operating-modes>Operating Modes</h2><p>Redis has three different operating modes, specified by the <a href=/docs/redis/param#redis_mode><strong><code>redis_mode</code></strong></a> parameter:</p><table class=full-width><thead><tr><th style=text-align:center>Mode</th><th style=text-align:center>Code</th><th style=text-align:left>Description</th><th style=text-align:left>HA Mechanism</th></tr></thead><tbody><tr><td style=text-align:center><a href=#standalone-cluster><strong>Standalone</strong></a></td><td style=text-align:center><code>standalone</code></td><td style=text-align:left>Classic master-replica, <strong>default mode</strong></td><td style=text-align:left>Requires Sentinel</td></tr><tr><td style=text-align:center><a href=#sentinel-cluster><strong>Sentinel</strong></a></td><td style=text-align:center><code>sentinel</code></td><td style=text-align:left>HA monitoring and auto-failover for standalone</td><td style=text-align:left>Multi-node quorum</td></tr><tr><td style=text-align:center><a href=#native-cluster><strong>Native Cluster</strong></a></td><td style=text-align:center><code>cluster</code></td><td style=text-align:left>Redis native distributed cluster, no sentinel needed</td><td style=text-align:left>Built-in auto-failover</td></tr></tbody></table><ul><li><strong>Standalone</strong>: Default mode, replication via <code>replica_of</code> parameter. Requires additional Sentinel cluster for HA.</li><li><strong>Sentinel</strong>: Stores no business data, dedicated to monitoring standalone Redis clusters for auto-failover; multi-node itself provides HA.</li><li><strong>Native Cluster</strong>: Data auto-sharded across multiple primaries, each can have multiple replicas, built-in HA, no sentinel needed.</li></ul><hr><h2 id=examples>Examples</h2><p>Let&rsquo;s look at concrete examples for each mode:</p><h3 id=standalone-cluster>Standalone Cluster</h3><p>Classic master-replica on a single node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-ms</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.ms&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>Cluster</strong></span></th><th><span class=text-secondary><strong>Description</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>redis-ms</code></strong></td><td>Redis standalone cluster</td></tr><tr><td style=text-align:center><span class=text-danger><strong>Node</strong></span></td><td><span class=text-danger><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-ms-1</code></strong></td><td><code>10.10.10.10</code> Node #1, hosts 2 instances</td></tr><tr><td style=text-align:center><span class=text-success><strong>Instance</strong></span></td><td><span class=text-success><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-ms-1-6379</code></strong></td><td>Primary instance, listening on port 6379</td></tr><tr><td style=text-align:center><strong><code>redis-ms-1-6380</code></strong></td><td>Replica instance, port 6380, replicates from 6379</td></tr></tbody></table><h3 id=sentinel-cluster>Sentinel Cluster</h3><p>Three sentinel instances on a single node for monitoring standalone clusters. Sentinel clusters specify monitored standalone clusters via <a href=/docs/redis/param#redis_sentinel_monitor><strong><code>redis_sentinel_monitor</code></strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-sentinel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>26379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 26380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 26381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.sentinel&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_sentinel_monitor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: redis-ms, host: 10.10.10.10, port: 6379, password: redis.ms, quorum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=native-cluster>Native Cluster</h3><p>A Redis native distributed cluster with two nodes and six instances (minimum spec: 3 primaries, 3 replicas):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1, redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 2, redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>This creates a <strong>3 primary 3 replica</strong> native Redis cluster.</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>Cluster</strong></span></th><th><span class=text-secondary><strong>Description</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>redis-test</code></strong></td><td>Redis native cluster (3P3R)</td></tr><tr><td style=text-align:center><span class=text-success><strong>Instance</strong></span></td><td><span class=text-success><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-test-1-6379</code></strong></td><td>Instance on node 1, port 6379</td></tr><tr><td style=text-align:center><strong><code>redis-test-1-6380</code></strong></td><td>Instance on node 1, port 6380</td></tr><tr><td style=text-align:center><strong><code>redis-test-1-6381</code></strong></td><td>Instance on node 1, port 6381</td></tr><tr><td style=text-align:center><strong><code>redis-test-2-6379</code></strong></td><td>Instance on node 2, port 6379</td></tr><tr><td style=text-align:center><strong><code>redis-test-2-6380</code></strong></td><td>Instance on node 2, port 6380</td></tr><tr><td style=text-align:center><strong><code>redis-test-2-6381</code></strong></td><td>Instance on node 2, port 6381</td></tr><tr><td style=text-align:center><span class=text-danger><strong>Node</strong></span></td><td><span class=text-danger><strong>Description</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-test-1</code></strong></td><td><code>10.10.10.12</code> Node #1, hosts 3 instances</td></tr><tr><td style=text-align:center><strong><code>redis-test-2</code></strong></td><td><code>10.10.10.13</code> Node #2, hosts 3 instances</td></tr></tbody></table><hr><h2 id=identity-parameters>Identity Parameters</h2><p>Pigsty uses the <a href=/docs/redis/param#redis><strong><code>REDIS</code></strong></a> parameter group to assign deterministic identities to each Redis module entity. Three parameters are required:</p><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th><th style=text-align:left>Format</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/redis/param#redis_cluster><strong><code>redis_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>Cluster</td><td style=text-align:left>Redis cluster name, required</td><td style=text-align:left>Valid DNS name, regex <code>[a-z][a-z0-9-]*</code></td></tr><tr><td style=text-align:left><a href=/docs/redis/param#redis_node><strong><code>redis_node</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>Node</td><td style=text-align:left>Redis node number, required</td><td style=text-align:left>Natural number, starting from 1, unique within cluster</td></tr><tr><td style=text-align:left><a href=/docs/redis/param#redis_instances><strong><code>redis_instances</code></strong></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center>Node</td><td style=text-align:left>Redis instance definition, required</td><td style=text-align:left>JSON object, key is port, value is instance config</td></tr></tbody></table><p>With cluster name defined at cluster level and node number/instance definition assigned at node level, Pigsty automatically generates unique identifiers for each entity:</p><table class=full-width><thead><tr><th>Entity</th><th style=text-align:left>Generation Rule</th><th style=text-align:left>Example</th></tr></thead><tbody><tr><td><strong>Instance</strong></td><td style=text-align:left><code>{{ redis_cluster }}-{{ redis_node }}-{{ port }}</code></td><td style=text-align:left><code>redis-ms-1-6379</code>, <code>redis-ms-1-6380</code></td></tr></tbody></table><p>The Redis module does not assign additional identity to host nodes; nodes are identified by their existing hostname or IP address.
<a href=/docs/redis/param#redis_node><strong><code>redis_node</code></strong></a> is used for instance naming, not host node identity.</p><hr><h2 id=instance-definition>Instance Definition</h2><p><a href=/docs/redis/param#redis_instances><strong><code>redis_instances</code></strong></a> is a JSON object with <strong>port number</strong> as key and <strong>instance config</strong> as value:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>                                      </span><span style=color:#8f5902;font-style:italic># Primary instance, no extra config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Replica, specify upstream primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Replica, specify upstream primary</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Each Redis instance listens on a unique port within the node. You can choose any port number,
but avoid system reserved ports (&lt; 1024) or conflicts with <a href=/docs/ref/port/><strong>Pigsty used ports</strong></a>.
The <code>replica_of</code> parameter sets replication relationship in standalone mode, format <code>'&lt;ip> &lt;port>'</code>, specifying upstream primary address and port.</p><p>Additionally, each Redis node runs a Redis Exporter collecting metrics from <strong>all local instances</strong>:</p><table class=full-width><thead><tr><th style=text-align:left>Port</th><th style=text-align:left>Parameter</th><th style=text-align:left>Purpose</th></tr></thead><tbody><tr><td style=text-align:left>9121</td><td style=text-align:left><a href=/docs/redis/param#redis_exporter_port><strong><code>redis_exporter_port</code></strong></a></td><td style=text-align:left>Redis Exporter port</td></tr></tbody></table><p>Redis&rsquo;s single-node multi-instance deployment model has some limitations:</p><ul><li><strong>Node Exclusive</strong>: A node can only belong to one Redis cluster, not assigned to different clusters simultaneously.</li><li><strong>Port Unique</strong>: Redis instances on the same node must use different ports to avoid conflicts.</li><li><strong>Password Shared</strong>: Multiple instances on the same node cannot have different passwords (redis_exporter limitation).</li><li><strong>Manual HA</strong>: Standalone Redis clusters require additional Sentinel configuration for auto-failover.</li></ul><hr><h2 id=monitoring-label-system>Monitoring Label System</h2><p>Pigsty provides an out-of-box monitoring system that uses the above <a href=#identity-parameters><strong>identity parameters</strong></a> to identify various Redis entities.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>redis_up{cls=&#34;redis-ms&#34;, ins=&#34;redis-ms-1-6379&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;redis&#34;}
</span></span><span style=display:flex><span>redis_up{cls=&#34;redis-ms&#34;, ins=&#34;redis-ms-1-6380&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;redis&#34;}
</span></span></code></pre></div><p>For example, the <code>cls</code>, <code>ins</code>, <code>ip</code> labels correspond to cluster name, instance name, and node IP—the identifiers for these three core entities.
They appear along with the <code>job</code> label in <strong>all</strong> Redis monitoring metrics collected by <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a>.
The <code>job</code> name for collecting Redis metrics is fixed as <code>redis</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d1070a4639ccf6fd6d12d222bf92c497>3 - Infra as Code</h1><div class=lead>Pigsty uses Infrastructure as Code (IaC) philosophy to manage all components, providing declarative management for large-scale clusters.</div><p>Pigsty follows the IaC and GitOPS philosophy: use a declarative <a href=/docs/setup/config#inventory><strong>config inventory</strong></a> to describe the entire environment, and materialize it through <a href=/docs/setup/playbook><strong>idempotent playbooks</strong></a>.</p><p>Users describe their desired state declaratively through <a href=/docs/ref/param><strong>parameters</strong></a>, and playbooks idempotently adjust target nodes to reach that state.
This is similar to Kubernetes CRDs & Operators, but Pigsty implements this functionality on bare metal and virtual machines through Ansible.</p><p>Pigsty was born to solve the operational management problem of ultra-large-scale PostgreSQL clusters. The idea behind it is simple — we need the ability to replicate the entire infrastructure (100+ database clusters + PG/Redis + observability) on ready servers within ten minutes.
No GUI + ClickOps can complete such a complex task in such a short time, making CLI + IaC the only choice — it provides precise, efficient control.</p><p>The config inventory <a href=/docs/setup/config><code>pigsty.yml</code></a> file describes the state of the entire deployment. Whether it&rsquo;s production (prod), staging, test, or development (devbox) environments,
the difference between infrastructures lies only in the config inventory, while the deployment delivery logic is exactly the same.</p><p>You can use git for version control and auditing of this deployment &ldquo;seed/gene&rdquo;, and Pigsty even supports storing the config inventory as database tables in PostgreSQL CMDB, further achieving Infra as Data capability.
Seamlessly integrate with your existing workflows.</p><p>IaC is designed for professional users and enterprise scenarios but is also deeply optimized for individual developers and SMBs.
Even if you&rsquo;re not a professional DBA, you don&rsquo;t need to understand these hundreds of adjustment knobs and switches. All parameters come with well-performing default values.
You can get an out-of-the-box single-node database with <strong>zero configuration</strong>;
Simply add two more IP addresses to get an enterprise-grade high-availability PostgreSQL cluster.</p><hr><h2 id=declare-modules>Declare Modules</h2><p>Take the following default config snippet as an example. This config describes a node <code>10.10.10.10</code> with <a href=/docs/infra><strong><code>INFRA</code></strong></a>, <a href=/docs/node><strong><code>NODE</code></strong></a>, <a href=/docs/etcd><strong><code>ETCD</code></strong></a>, and <a href=/docs/pgsql><strong><code>PGSQL</code></strong></a> modules installed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitoring, alerting, DNS, NTP and other infrastructure cluster...</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># minio cluster, s3 compatible object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># etcd cluster, used as DCS for PostgreSQL high availability</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL example cluster: pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To actually install these modules, execute the following playbooks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># Initialize infra module on node 10.10.10.10</span>
</span></span><span style=display:flex><span>./etcd.yml  -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># Initialize etcd module on node 10.10.10.10</span>
</span></span><span style=display:flex><span>./minio.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># Initialize minio module on node 10.10.10.10</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># Initialize pgsql module on node 10.10.10.10</span>
</span></span></code></pre></div><hr><h2 id=declare-clusters>Declare Clusters</h2><p>You can declare PostgreSQL database clusters by installing the <a href=/docs/pgsql/><strong><code>PGSQL</code></strong></a> module on multiple nodes, making them a service unit:</p><p>For example, to deploy a three-node high-availability PostgreSQL cluster using streaming replication on the following three Pigsty-managed nodes,
you can add the following definition to the <code>all.children</code> section of the config file <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><code>pigsty.yml</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>After defining, you can use <a href=/docs/setup/playbook/><strong>playbooks</strong></a> to create the cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># Create the pg-test cluster</span>
</span></span></code></pre></div><p><img src=/img/pigsty/iac.jpg alt=pigsty-iac.jpg></p><p>You can use different instance roles such as <a href=/docs/pgsql/config#primary><strong>primary</strong></a>, <a href=/docs/pgsql/config#replica><strong>replica</strong></a>, <a href=/docs/pgsql/config#offline><strong>offline</strong></a>, <a href=/docs/pgsql/config#delayed-cluster><strong>delayed</strong></a>, <a href=/docs/pgsql/config#sync-standby><strong>sync standby</strong></a>;
as well as different clusters: such as <a href=/docs/pgsql/config#standby-cluster><strong>standby clusters</strong></a>, <a href=/docs/pgsql/config#citus-cluster><strong>Citus clusters</strong></a>, and even <a href=/docs/redis><strong>Redis</strong></a> / <a href=/docs/minio><strong>MinIO</strong></a> / <a href=/docs/etcd><strong>Etcd</strong></a> clusters</p><hr><h2 id=customize-cluster-content>Customize Cluster Content</h2><p>Not only can you define clusters declaratively, but you can also define databases, users, services, and HBA rules within the cluster. For example, the following config file deeply customizes the content of the default <code>pg-meta</code> single-node database cluster:</p><p>Including: declaring six business databases and seven business users, adding an extra <code>standby</code> service (synchronous standby, providing read capability with no replication delay), defining some additional <code>pg_hba</code> rules, an L2 VIP address pointing to the cluster primary, and a customized backup strategy.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># define business databases on this cluster, array of database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database sql baseline path, (relative path among ansible search path, e.g files/)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this database to pgbouncer database list? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, additional schemas to be created, array of schema names</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions:                     # optional, additional extensions to be installed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>array of `{name[,schema]}`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database owner, postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, which template to use, template1 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database encoding, UTF8 by default. (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database locale, C by default.  (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database collate, C by default. (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database ctype, C by default.   (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, default tablespace, &#39;pg_default&#39; by default.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, allow connection, true by default. false will disable connect at all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, revoke public connection privilege. false by default. (leave connect with grant option to owner)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># optional, register this database to grafana datasources? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, database connection limit, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, all connection to this pgbouncer database will be authenticated by this user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at database level, default transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size at database level, default 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size reserve at database level, default 32</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size min at database level, default 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_max_db_conn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># optional, max database connections at database level, default 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># define business users/roles on this cluster, array of user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, password, can be a scram-sha-256 hash string or plain text</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># optional, can log in, true by default  (new biz ROLE should be false)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, is superuser? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, can create database? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, can create role? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, can this role use inherited privileges? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, can this role do replication? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, can this role bypass row level security? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this user to pgbouncer user-list? false by default (production user should be true explicitly)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, user connection limit, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, now + n days when this role is expired (OVERWRITE expire_at)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># optional, YYYY-MM-DD &#39;timestamp&#39; when this role is expired  (OVERWRITTEN by expire_in)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this user/role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>roles: [dbrole_admin]           # optional, belonged roles. default roles are</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_{admin,readonly,readwrite,offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, role level parameters with `ALTER ROLE SET`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at user level, transaction by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, max database connections at user level, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service      }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                        </span><span style=color:#8f5902;font-style:italic># extra services in addition to pg_default_services, array of service definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># standby service will route {ip|name}:5435 to sync replica&#39;s pgbouncer (5435-&gt;6432 standby)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name: standby                   # required, service name, the actual svc name will be prefixed with `pg_cluster`, e.g</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># required, service exposed port (work as kubernetes service node port mode)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># optional, service bind ip address, `*` for all ip by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># required, service member selector, use JMESPath to filter inventory</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, destination port, default|postgres|pgbouncer|&lt;port_number&gt;, &#39;default&#39; by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>check</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, health check url path, / by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># backup server selector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, max allowed front-end connection</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>balance: roundrobin             # optional, haproxy load balance algorithm (roundrobin by default, other</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>leastconn)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.2</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># make a full backup 1 am everyday</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=declare-access-control>Declare Access Control</h2><p>You can also deeply customize Pigsty&rsquo;s access control capabilities through declarative configuration. For example, the following config file provides deep security customization for the <code>pg-meta</code> cluster:</p><p>Uses the three-node core cluster template: <code>crit.yml</code>, to ensure data consistency is prioritized with zero data loss during failover.
Enables L2 VIP and restricts database and connection pool listening addresses to local loopback IP + internal network IP + VIP three specific addresses.
The template enforces Patroni&rsquo;s SSL API and Pgbouncer&rsquo;s SSL, and in HBA rules, enforces SSL usage for accessing the database cluster.
Also enables the <code>$libdir/passwordcheck</code> extension in <code>pg_libs</code> to enforce password strength security policy.</p><p>Finally, a separate <code>pg-meta-delay</code> cluster is declared as <code>pg-meta</code>&rsquo;s delayed replica from one hour ago, for emergency data deletion recovery.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 3 instance postgres cluster `pg-meta`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta , password: DBUser.Meta   , pgbouncer: true , roles: [ dbrole_admin ] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view , password: DBUser.Viewer , pgbouncer: true , roles: [ dbrole_readonly ] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: standby ,src_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,port: 5435 , dest: default ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.2</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_listen</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${ip},${vip},${lo}&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_ssl_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>require</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, $libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add passwordcheck extension to enforce strong password</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly]               ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite]  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,expire_in: 7300                        ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,expire_in: 7300 ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,expire_in: 7300 ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,expire_in: 7300 ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres host-based auth rules by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: cert  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; cert&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer host-based authentication rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu local admin access with os ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user local access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor access via intranet with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other monitor access addr&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin access via intranet with pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other admin access addr&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user intra access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># OPTIONAL delayed cluster for pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta-delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># delayed instance for pg-meta (1 hour ago)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_upstream: 10.10.10.10, pg_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1h } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-delay }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=citus-distributed-cluster>Citus Distributed Cluster</h2><p>Below is a declarative configuration for a four-node Citus distributed cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus coordinator, pg_group = 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 3, with an extra replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.14</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># global parameters for all citus clusters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                    # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_citus_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus distributed database name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=redis-clusters>Redis Clusters</h2><p>Below are declarative configuration examples for Redis primary-replica cluster, sentinel cluster, and Redis Cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-ms</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># redis classic primary &amp; replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 , redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_cluster: redis-ms ,redis_password: &#39;redis.ms&#39; ,redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MB }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># redis sentinel x 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 , redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>26379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,26380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,26381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_sentinel_monitor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary list for redis sentinel, use cls as name, primary ip:port</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: redis-ms, host: 10.10.10.10, port: 6379 ,password: redis.ms, quorum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-test: # redis native cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>3m x 3s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 ,redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 2 ,redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_cluster: redis-test ,redis_password: &#39;redis.test&#39; ,redis_mode: cluster, redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=etcd-cluster>ETCD Cluster</h2><p>Below is a declarative configuration example for a three-node Etcd cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># dcs service for postgres/patroni ha consensus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 1 node for testing, 3 or 5 for production</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># etcd_seq required</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># assign from 1 ~ n</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># odd number please</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># cluster level parameter override roles/etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># mark etcd cluster name etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># safeguard against purging</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_clean</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># purge etcd during init process</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=minio-cluster>MinIO Cluster</h2><p>Below is a declarative configuration example for a three-node MinIO cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data{1...2}&#39;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># use two disks per node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${minio_cluster}-${minio_seq}.pigsty&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># node name pattern</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>haproxy_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># [required] service name, must be unique</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9002</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># [required] service port, must be unique</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>http-check send meth OPTIONS uri /minio/health/live</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>servers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-1 ,ip: 10.10.10.10 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-2 ,ip: 10.10.10.11 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-3 ,ip: 10.10.10.12 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6b8b3debf71b9a47be1364eba07a65ae>3.1 - Inventory</h1><div class=lead>Describe your infrastructure and clusters using declarative configuration files</div><p>Every Pigsty deployment corresponds to an <strong>Inventory</strong> that describes key properties of the infrastructure and database clusters.</p><hr><h2 id=configuration-file>Configuration File</h2><p>Pigsty uses <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html><strong>Ansible YAML configuration format</strong></a> by default,
with a single YAML configuration file <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><strong><code>pigsty.yml</code></strong></a> as the inventory.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/pigsty
</span></span><span style=display:flex><span>  ^---- pigsty.yml   <span style=color:#8f5902;font-style:italic># &lt;---- Default configuration file</span>
</span></span></code></pre></div><p>You can directly edit this configuration file to customize your deployment, or use the <a href=/docs/concept/iac/configure><strong><code>configure</code></strong></a> wizard script provided by Pigsty to automatically generate an appropriate configuration file.</p><hr><h2 id=configuration-structure>Configuration Structure</h2><p>The inventory uses standard <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html><strong>Ansible YAML configuration format</strong></a>, consisting of two parts: <strong>global parameters</strong> (<code>all.vars</code>) and multiple <strong>groups</strong> (<code>all.children</code>).</p><p>You can define new clusters in <code>all.children</code> and describe the infrastructure using global variables: <code>all.vars</code>, which looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all:                  # Top-level object</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Global parameters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Group definitions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra:            # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>...}        # Group members</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span>{<span style=color:#204a87;font-weight:700>...}        # Group parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#204a87;font-weight:700>...}    # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etcd&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>...}    # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>...}    # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>...} # Group definition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis-test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=cluster-definition>Cluster Definition</h2><p>Each Ansible group may represent a cluster, which can be a node cluster, PostgreSQL cluster, Redis cluster, Etcd cluster, MinIO cluster, etc.</p><p>A cluster definition consists of two parts: <strong>cluster members</strong> (<strong><code>hosts</code></strong>) and <strong>cluster parameters</strong> (<strong><code>vars</code></strong>).
You can define cluster members in <code>&lt;cls>.hosts</code> and describe the cluster using <a href=/docs/concept/iac/parameter><strong>configuration parameters</strong></a> in <code>&lt;cls>.vars</code>.
Here&rsquo;s an example of a 3-node high-availability PostgreSQL cluster definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Ansible group list</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Ansible group name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Ansible group instances (cluster members)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Host 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Host 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Host 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Ansible group variables (cluster parameters)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Cluster-level <code>vars</code> (cluster parameters) override global parameters, and instance-level <code>vars</code> override both cluster parameters and global parameters.</p><hr><h2 id=splitting-configuration>Splitting Configuration</h2><p>If your deployment is large or you want to better organize configuration files,
you can <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html#id18><strong>split the inventory into multiple files</strong></a> for easier management and maintenance.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>inventory/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>├── hosts.yml             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Host and cluster definitions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>├── group_vars/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── all.yml           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Global default variables (corresponds to all.vars)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── infra.yml         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># infra group variables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── etcd.yml          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># etcd group variables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   └── pg-meta.yml       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg-meta cluster variables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>└── host_vars/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>├── 10.10.10.10.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Specific host variables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>└── 10.10.10.11.yml</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can place cluster member definitions in the <code>hosts.yml</code> file and put cluster-level <a href=/docs/concept/iac/parameter#parameter-priority><strong>configuration parameters</strong></a> in corresponding files under the <code>group_vars</code> directory.</p><hr><h2 id=switching-configuration>Switching Configuration</h2><p>You can temporarily specify a different inventory file when running playbooks using the <code>-i</code> parameter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -i another_config.yml
</span></span><span style=display:flex><span>./infra.yml -i nginx_config.yml
</span></span></code></pre></div><p>Additionally, Ansible supports multiple configuration methods. You can use local <code>yaml|ini</code> configuration files, or use CMDB and any dynamic configuration scripts as configuration sources.</p><p>In Pigsty, we specify <strong><code>pigsty.yml</code></strong> in the same directory as the default <strong>inventory</strong> through <a href=https://github.com/pgsty/pigsty/blob/main/ansible.cfg#L6><strong><code>ansible.cfg</code></strong></a> in the Pigsty home directory. You can modify it as needed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[defaults]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>inventory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pigsty.yml</span>
</span></span></code></pre></div><p>Additionally, Pigsty supports using a <a href=/docs/concept/iac/cmdb><strong>CMDB metabase</strong></a> to store the inventory, facilitating integration with existing systems.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c48a7025a948ffe27199cd10986e517a>3.2 - Configure</h1><div class=lead>Use the configure script to automatically generate recommended configuration files based on your environment.</div><p>Pigsty provides a <strong><code>configure</code></strong> script as a <strong>configuration wizard</strong> that automatically generates an appropriate <code>pigsty.yml</code> configuration file based on your current environment.</p><p>This is an <strong>optional</strong> script: if you already understand how to configure Pigsty, you can directly edit the <code>pigsty.yml</code> configuration file and skip the wizard.</p><hr><h2 id=quick-start>Quick Start</h2><p>Enter the pigsty source home directory and run <code>./configure</code> to automatically start the configuration wizard. Without any arguments, it defaults to the <a href=/docs/conf/meta><strong><code>meta</code></strong></a> single-node configuration template:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty
</span></span><span style=display:flex><span>./configure          <span style=color:#8f5902;font-style:italic># Interactive configuration wizard, auto-detect environment and generate config</span>
</span></span></code></pre></div><p>This command will use the selected template as a base, detect the current node&rsquo;s IP address and region, and generate a <code>pigsty.yml</code> configuration file suitable for the current environment.</p><div id=asciinema-faf4cf8e717f5b9f582b3cede024d31c class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-faf4cf8e717f5b9f582b3cede024d31c",o="/demo/configure.cast",e="solarized-light",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[3,"Default config"],[7,"Specify IP"],[14,"Random password"],[17,"rich template"],[20,"app/odoo template"],[26,"china region"],[33,"ha/full template"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><h2 id=features>Features</h2><p>The <strong><code>configure</code></strong> script performs the following adjustments based on environment and input, generating a <code>pigsty.yml</code> configuration file in the current directory.</p><ul><li>Detects the current node IP address; if multiple IPs exist, prompts the user to input a <strong>primary IP address</strong> as the node&rsquo;s identity</li><li>Uses the IP address to replace the placeholder <strong><code>10.10.10.10</code></strong> in the configuration template and sets it as the <a href=/docs/infra/param#admin_ip><strong><code>admin_ip</code></strong></a> parameter value</li><li>Detects the current region, setting <a href=/docs/infra/param#region><strong><code>region</code></strong></a> to <strong><code>default</code></strong> (global default repos) or <strong><code>china</code></strong> (using Chinese mirror repos)</li><li>For micro instances (vCPU &lt; 4), uses the <strong><code>tiny</code></strong> parameter template for <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> and <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> to optimize resource usage</li><li>If <strong><code>-v</code></strong> PG major version is specified, sets <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a> and all PG alias parameters to the corresponding major version</li><li>If <strong><code>-g</code></strong> is specified, replaces all default passwords with randomly generated strong passwords for enhanced security (<strong>strongly recommended</strong>)</li><li>When PG major version ≥ 17, prioritizes the built-in <strong><code>C.UTF-8</code></strong> locale, or the OS-supported <strong><code>C.UTF-8</code></strong></li><li>Checks if the core dependency <strong><code>ansible</code></strong> for deployment is available in the current environment</li><li>Also checks if the deployment target node is SSH-reachable and can execute commands with sudo (<strong><code>-s</code></strong> to skip)</li></ul><hr><h2 id=usage-examples>Usage Examples</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Basic usage</span>
</span></span><span style=display:flex><span>./configure                       <span style=color:#8f5902;font-style:italic># Interactive configuration wizard</span>
</span></span><span style=display:flex><span>./configure -i 10.10.10.10        <span style=color:#8f5902;font-style:italic># Specify primary IP address</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify configuration template</span>
</span></span><span style=display:flex><span>./configure -c meta               <span style=color:#8f5902;font-style:italic># Use default single-node template (default)</span>
</span></span><span style=display:flex><span>./configure -c rich               <span style=color:#8f5902;font-style:italic># Use feature-rich single-node template</span>
</span></span><span style=display:flex><span>./configure -c slim               <span style=color:#8f5902;font-style:italic># Use minimal template (PGSQL + ETCD only)</span>
</span></span><span style=display:flex><span>./configure -c ha/full            <span style=color:#8f5902;font-style:italic># Use 4-node HA sandbox template</span>
</span></span><span style=display:flex><span>./configure -c ha/trio            <span style=color:#8f5902;font-style:italic># Use 3-node HA template</span>
</span></span><span style=display:flex><span>./configure -c app/supa           <span style=color:#8f5902;font-style:italic># Use Supabase self-hosted template</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify PostgreSQL version</span>
</span></span><span style=display:flex><span>./configure -v <span style=color:#0000cf;font-weight:700>17</span>                 <span style=color:#8f5902;font-style:italic># Use PostgreSQL 17</span>
</span></span><span style=display:flex><span>./configure -v <span style=color:#0000cf;font-weight:700>16</span>                 <span style=color:#8f5902;font-style:italic># Use PostgreSQL 16</span>
</span></span><span style=display:flex><span>./configure -c rich -v <span style=color:#0000cf;font-weight:700>16</span>         <span style=color:#8f5902;font-style:italic># rich template + PG 16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Region and proxy</span>
</span></span><span style=display:flex><span>./configure -r china              <span style=color:#8f5902;font-style:italic># Use Chinese mirrors</span>
</span></span><span style=display:flex><span>./configure -r europe             <span style=color:#8f5902;font-style:italic># Use European mirrors</span>
</span></span><span style=display:flex><span>./configure -x                    <span style=color:#8f5902;font-style:italic># Import current proxy environment variables</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Skip and automation</span>
</span></span><span style=display:flex><span>./configure -s                    <span style=color:#8f5902;font-style:italic># Skip IP detection, keep placeholder</span>
</span></span><span style=display:flex><span>./configure -n -i 10.10.10.10     <span style=color:#8f5902;font-style:italic># Non-interactive mode with specified IP</span>
</span></span><span style=display:flex><span>./configure -c ha/full -s         <span style=color:#8f5902;font-style:italic># 4-node template, skip IP replacement</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Security enhancement</span>
</span></span><span style=display:flex><span>./configure -g                    <span style=color:#8f5902;font-style:italic># Generate random passwords</span>
</span></span><span style=display:flex><span>./configure -c meta -g -i 10.10.10.10  <span style=color:#8f5902;font-style:italic># Complete production configuration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify output and SSH port</span>
</span></span><span style=display:flex><span>./configure -o prod.yml           <span style=color:#8f5902;font-style:italic># Output to prod.yml</span>
</span></span><span style=display:flex><span>./configure -p <span style=color:#0000cf;font-weight:700>2222</span>               <span style=color:#8f5902;font-style:italic># Use SSH port 2222</span>
</span></span></code></pre></div><hr><h2 id=command-arguments>Command Arguments</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-c<span style=color:#000;font-weight:700>|</span>--conf &lt;template&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># Configuration template name (meta|rich|slim|ha/full|...)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-i<span style=color:#000;font-weight:700>|</span>--ip &lt;ipaddr&gt;<span style=color:#ce5c00;font-weight:700>]</span>          <span style=color:#8f5902;font-style:italic># Specify primary IP address</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-v<span style=color:#000;font-weight:700>|</span>--version &lt;pgver&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># PostgreSQL major version (13|14|15|16|17|18)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-r<span style=color:#000;font-weight:700>|</span>--region &lt;region&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># Upstream software repo region (default|china|europe)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-o<span style=color:#000;font-weight:700>|</span>--output &lt;file&gt;<span style=color:#ce5c00;font-weight:700>]</span>        <span style=color:#8f5902;font-style:italic># Output configuration file path (default: pigsty.yml)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-s<span style=color:#000;font-weight:700>|</span>--skip<span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#8f5902;font-style:italic># Skip IP address detection and replacement</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-x<span style=color:#000;font-weight:700>|</span>--proxy<span style=color:#ce5c00;font-weight:700>]</span>                <span style=color:#8f5902;font-style:italic># Import proxy settings from environment variables</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-n<span style=color:#000;font-weight:700>|</span>--non-interactive<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># Non-interactive mode (don&#39;t ask any questions)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-p<span style=color:#000;font-weight:700>|</span>--port &lt;port&gt;<span style=color:#ce5c00;font-weight:700>]</span>          <span style=color:#8f5902;font-style:italic># Specify SSH port</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-g<span style=color:#000;font-weight:700>|</span>--generate<span style=color:#ce5c00;font-weight:700>]</span>             <span style=color:#8f5902;font-style:italic># Generate random passwords</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-h<span style=color:#000;font-weight:700>|</span>--help<span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#8f5902;font-style:italic># Display help information</span>
</span></span></code></pre></div><h3 id=argument-details>Argument Details</h3><table><thead><tr><th style=text-align:left>Argument</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>-c, --conf</code></td><td style=text-align:left>Generate config from <code>conf/&lt;template>.yml</code>, supports subdirectories like <code>ha/full</code></td></tr><tr><td style=text-align:left><code>-i, --ip</code></td><td style=text-align:left>Replace placeholder <code>10.10.10.10</code> in config template with specified IP</td></tr><tr><td style=text-align:left><code>-v, --version</code></td><td style=text-align:left>Specify PostgreSQL major version (13-18), keeps template default if not specified</td></tr><tr><td style=text-align:left><code>-r, --region</code></td><td style=text-align:left>Set software repo mirror region: <code>default</code>, <code>china</code> (Chinese mirrors), <code>europe</code> (European)</td></tr><tr><td style=text-align:left><code>-o, --output</code></td><td style=text-align:left>Specify output file path, defaults to <code>pigsty.yml</code></td></tr><tr><td style=text-align:left><code>-s, --skip</code></td><td style=text-align:left>Skip IP address detection and replacement, keep <code>10.10.10.10</code> placeholder in template</td></tr><tr><td style=text-align:left><code>-x, --proxy</code></td><td style=text-align:left>Write current environment proxy variables (<code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code>, <code>ALL_PROXY</code>, <code>NO_PROXY</code>) to config</td></tr><tr><td style=text-align:left><code>-n, --non-interactive</code></td><td style=text-align:left>Non-interactive mode, don&rsquo;t ask any questions (requires <code>-i</code> to specify IP)</td></tr><tr><td style=text-align:left><code>-p, --port</code></td><td style=text-align:left>Specify SSH port (when using non-default port 22)</td></tr><tr><td style=text-align:left><code>-g, --generate</code></td><td style=text-align:left><strong>Generate random values for passwords in config file, improving security (strongly recommended)</strong></td></tr></tbody></table><hr><h2 id=execution-flow>Execution Flow</h2><p>The <code>configure</code> script executes detection and configuration in the following order:</p><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────┐
│                  configure Execution Flow                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. check_region          Detect network region (GFW check) │
│         ↓                                                   │
│  2. check_version         Validate PostgreSQL version       │
│         ↓                                                   │
│  3. check_kernel          Detect OS kernel (Linux/Darwin)   │
│         ↓                                                   │
│  4. check_machine         Detect CPU arch (x86_64/aarch64)  │
│         ↓                                                   │
│  5. check_package_manager Detect package manager (dnf/yum/apt) │
│         ↓                                                   │
│  6. check_vendor_version  Detect OS distro and version      │
│         ↓                                                   │
│  7. check_sudo            Detect passwordless sudo          │
│         ↓                                                   │
│  8. check_ssh             Detect passwordless SSH to self   │
│         ↓                                                   │
│  9. check_proxy           Handle proxy environment vars     │
│         ↓                                                   │
│ 10. check_ipaddr          Detect/input primary IP address   │
│         ↓                                                   │
│ 11. check_admin           Validate admin SSH + Sudo access  │
│         ↓                                                   │
│ 12. check_conf            Select configuration template     │
│         ↓                                                   │
│ 13. check_config          Generate configuration file       │
│         ↓                                                   │
│ 14. check_utils           Check if Ansible etc. installed   │
│         ↓                                                   │
│     ✓ Configuration complete, output pigsty.yml             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre><hr><h2 id=automatic-behaviors>Automatic Behaviors</h2><h3 id=region-detection>Region Detection</h3><p>The script automatically detects the network environment to determine if you&rsquo;re in mainland China (behind GFW):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check network environment by accessing Google</span>
</span></span><span style=display:flex><span>curl -I -s --connect-timeout <span style=color:#0000cf;font-weight:700>1</span> www.google.com
</span></span></code></pre></div><ul><li>If Google is inaccessible, automatically sets <code>region: china</code> to use domestic mirrors</li><li>If accessible, uses <code>region: default</code> default mirrors</li><li>Can manually specify region via <code>-r</code> argument</li></ul><h3 id=ip-address-handling>IP Address Handling</h3><p>The script determines the primary IP address in the following priority:</p><ol><li><strong>Command line argument</strong>: If IP is specified via <code>-i</code>, use it directly</li><li><strong>Single IP detection</strong>: If the current node has only one IP, use it automatically</li><li><strong>Demo IP detection</strong>: If <code>10.10.10.10</code> is detected, select it automatically (for sandbox environments)</li><li><strong>Interactive input</strong>: When multiple IPs exist, prompt user to choose or input</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> Multiple IP address candidates found:
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span> 192.168.1.100   inet 192.168.1.100/24 scope global eth0
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> 10.10.10.10     inet 10.10.10.10/24 scope global eth1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> IN <span style=color:#ce5c00;font-weight:700>]</span> INPUT primary_ip address <span style=color:#ce5c00;font-weight:700>(</span>of current meta node, e.g 10.10.10.10<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>=</span>&gt; 10.10.10.10
</span></span></code></pre></div><h3 id=low-end-hardware-optimization>Low-End Hardware Optimization</h3><p>When CPU core count ≤ 4 is detected, the script automatically adjusts configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> replace oltp template with tiny due to cpu &lt; <span style=color:#0000cf;font-weight:700>4</span>
</span></span></code></pre></div><ul><li>Changes <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a> from <code>oltp.yml</code> to <code>tiny.yml</code></li><li>Changes <a href=/docs/node/param#node_tune><code>node_tune</code></a> from <code>oltp</code> to <code>tiny</code></li></ul><p>This ensures smooth operation on low-spec virtual machines.</p><h3 id=locale-settings>Locale Settings</h3><p>The script automatically enables <code>C.UTF-8</code> as the default locale when:</p><ul><li>PostgreSQL version ≥ 17 (built-in Locale Provider support)</li><li><strong>Or</strong> the current system supports <code>C.UTF-8</code> / <code>C.utf8</code> locale</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=china-region-special-handling>China Region Special Handling</h3><p>When region is set to <code>china</code>, the script automatically:</p><ul><li>Enables <code>docker_registry_mirrors</code> Docker mirror acceleration</li><li>Enables <code>PIP_MIRROR_URL</code> Python mirror acceleration</li></ul><h3 id=password-generation>Password Generation</h3><p>When using the <code>-g</code> argument, the script generates 24-character random strings for the following passwords:</p><table><thead><tr><th style=text-align:center>Password Parameter</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>grafana_admin_password</code></td><td style=text-align:left>Grafana admin password</td></tr><tr><td style=text-align:center><code>pg_admin_password</code></td><td style=text-align:left>PostgreSQL admin password</td></tr><tr><td style=text-align:center><code>pg_monitor_password</code></td><td style=text-align:left>PostgreSQL monitor user password</td></tr><tr><td style=text-align:center><code>pg_replication_password</code></td><td style=text-align:left>PostgreSQL replication user password</td></tr><tr><td style=text-align:center><code>patroni_password</code></td><td style=text-align:left>Patroni API password</td></tr><tr><td style=text-align:center><code>haproxy_admin_password</code></td><td style=text-align:left>HAProxy admin password</td></tr><tr><td style=text-align:center><code>minio_secret_key</code></td><td style=text-align:left>MinIO Secret Key</td></tr><tr><td style=text-align:center><code>etcd_root_password</code></td><td style=text-align:left>ETCD Root password</td></tr></tbody></table><p>It also replaces the following placeholder passwords:</p><ul><li><code>DBUser.Meta</code> → random password</li><li><code>DBUser.Viewer</code> → random password</li><li><code>S3User.Backup</code> → random password</li><li><code>S3User.Meta</code> → random password</li><li><code>S3User.Data</code> → random password</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./configure -g
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> generating random passwords...
</span></span><span style=display:flex><span>    grafana_admin_password   : xK9mL2nP4qR7sT1vW3yZ5bD8
</span></span><span style=display:flex><span>    pg_admin_password        : aB3cD5eF7gH9iJ1kL2mN4oP6
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> random passwords generated, check and save them
</span></span></code></pre></div><hr><h2 id=configuration-templates>Configuration Templates</h2><p>The script reads configuration templates from the <code>conf/</code> directory, supporting the following templates:</p><h3 id=core-templates>Core Templates</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>meta</code></td><td style=text-align:left><strong>Default template</strong>: Single-node installation with INFRA + NODE + ETCD + PGSQL</td></tr><tr><td style=text-align:center><code>rich</code></td><td style=text-align:left>Feature-rich version: Includes almost all extensions, MinIO, local repo</td></tr><tr><td style=text-align:center><code>slim</code></td><td style=text-align:left>Minimal version: PostgreSQL + ETCD only, no monitoring infrastructure</td></tr><tr><td style=text-align:center><code>fat</code></td><td style=text-align:left>Complete version: rich base with more extensions installed</td></tr><tr><td style=text-align:center><code>pgsql</code></td><td style=text-align:left>Pure PostgreSQL template</td></tr><tr><td style=text-align:center><code>infra</code></td><td style=text-align:left>Pure infrastructure template</td></tr></tbody></table><h3 id=ha-templates-ha>HA Templates (<code>ha/</code>)</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>ha/dual</code></td><td style=text-align:left>2-node HA cluster</td></tr><tr><td style=text-align:center><code>ha/trio</code></td><td style=text-align:left>3-node HA cluster</td></tr><tr><td style=text-align:center><code>ha/full</code></td><td style=text-align:left>4-node complete sandbox environment</td></tr><tr><td style=text-align:center><code>ha/safe</code></td><td style=text-align:left>Security-hardened HA configuration</td></tr><tr><td style=text-align:center><code>ha/simu</code></td><td style=text-align:left>42-node large-scale simulation environment</td></tr></tbody></table><h3 id=application-templates-app>Application Templates (<code>app/</code>)</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>supabase</code></td><td style=text-align:left>Supabase self-hosted configuration</td></tr><tr><td style=text-align:center><code>app/dify</code></td><td style=text-align:left>Dify AI platform configuration</td></tr><tr><td style=text-align:center><code>app/odoo</code></td><td style=text-align:left>Odoo ERP configuration</td></tr><tr><td style=text-align:center><code>app/teable</code></td><td style=text-align:left>Teable table database configuration</td></tr><tr><td style=text-align:center><code>app/registry</code></td><td style=text-align:left>Docker Registry configuration</td></tr></tbody></table><h3 id=special-kernel-templates>Special Kernel Templates</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>ivory</code></td><td style=text-align:left>IvorySQL: Oracle-compatible PostgreSQL</td></tr><tr><td style=text-align:center><code>mssql</code></td><td style=text-align:left>Babelfish: SQL Server-compatible PostgreSQL</td></tr><tr><td style=text-align:center><code>polar</code></td><td style=text-align:left>PolarDB: Alibaba Cloud open-source distributed PostgreSQL</td></tr><tr><td style=text-align:center><code>citus</code></td><td style=text-align:left>Citus: Distributed PostgreSQL</td></tr><tr><td style=text-align:center><code>oriole</code></td><td style=text-align:left>OrioleDB: Next-generation storage engine</td></tr></tbody></table><h3 id=demo-templates-demo>Demo Templates (<code>demo/</code>)</h3><table><thead><tr><th style=text-align:center>Template</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>demo/demo</code></td><td style=text-align:left>Demo environment configuration</td></tr><tr><td style=text-align:center><code>demo/redis</code></td><td style=text-align:left>Redis cluster demo</td></tr><tr><td style=text-align:center><code>demo/minio</code></td><td style=text-align:left>MinIO cluster demo</td></tr></tbody></table><hr><h2 id=output-example>Output Example</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./configure
</span></span><span style=display:flex><span>configure pigsty v4.0.0 begin
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>region</span> <span style=color:#ce5c00;font-weight:700>=</span> china
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>kernel</span>  <span style=color:#ce5c00;font-weight:700>=</span> Linux
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>machine</span> <span style=color:#ce5c00;font-weight:700>=</span> x86_64
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>package</span> <span style=color:#ce5c00;font-weight:700>=</span> rpm,dnf
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>vendor</span>  <span style=color:#ce5c00;font-weight:700>=</span> rocky <span style=color:#ce5c00;font-weight:700>(</span>Rocky Linux<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#ce5c00;font-weight:700>(</span>9.5<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>sudo</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ssh</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@127.0.0.1 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> Multiple IP address candidates found:
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span> 192.168.121.193	    inet 192.168.121.193/24 brd 192.168.121.255 scope global dynamic noprefixroute eth0
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> 10.10.10.10	    inet 10.10.10.10/24 brd 10.10.10.255 scope global noprefixroute eth1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>primary_ip</span> <span style=color:#ce5c00;font-weight:700>=</span> 10.10.10.10 <span style=color:#ce5c00;font-weight:700>(</span>from demo<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>admin</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@10.10.10.10 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>=</span> meta <span style=color:#ce5c00;font-weight:700>(</span>el9<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>locale</span>  <span style=color:#ce5c00;font-weight:700>=</span> C.UTF-8
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ansible</span> <span style=color:#ce5c00;font-weight:700>=</span> ready
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> pigsty configured
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> don<span style=color:#a40000>&#39;</span>t forget to check it and change passwords!
</span></span><span style=display:flex><span>proceed with ./deploy.yml
</span></span></code></pre></div><hr><h2 id=environment-variables>Environment Variables</h2><p>The script supports the following environment variables:</p><table><thead><tr><th style=text-align:center>Environment Variable</th><th style=text-align:left>Description</th><th style=text-align:center>Default</th></tr></thead><tbody><tr><td style=text-align:center><code>PIGSTY_HOME</code></td><td style=text-align:left>Pigsty installation directory</td><td style=text-align:center><code>~/pigsty</code></td></tr><tr><td style=text-align:center><code>METADB_URL</code></td><td style=text-align:left>Metabase connection URL</td><td style=text-align:center><code>service=meta</code></td></tr><tr><td style=text-align:center><code>HTTP_PROXY</code></td><td style=text-align:left>HTTP proxy</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>HTTPS_PROXY</code></td><td style=text-align:left>HTTPS proxy</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>ALL_PROXY</code></td><td style=text-align:left>Universal proxy</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>NO_PROXY</code></td><td style=text-align:left>Proxy whitelist</td><td style=text-align:center>Built-in default</td></tr></tbody></table><hr><h2 id=notes>Notes</h2><ol><li><p><strong>Passwordless access</strong>: Before running <code>configure</code>, ensure the current user has passwordless sudo privileges and passwordless SSH to localhost. This can be automatically configured via the <code>bootstrap</code> script.</p></li><li><p><strong>IP address selection</strong>: Choose an <strong>internal IP</strong> as the primary IP address, not a public IP or <code>127.0.0.1</code>.</p></li><li><p><strong>Password security</strong>: In production environments, <strong>always</strong> modify default passwords in the configuration file, or use the <code>-g</code> argument to generate random passwords.</p></li><li><p><strong>Configuration review</strong>: After the script completes, it&rsquo;s recommended to review the generated <code>pigsty.yml</code> file to confirm the configuration meets expectations.</p></li><li><p><strong>Multiple executions</strong>: You can run <code>configure</code> multiple times to regenerate configuration; each run will overwrite the existing <code>pigsty.yml</code>.</p></li><li><p><strong>macOS limitations</strong>: When running on macOS, the script skips some Linux-specific checks and uses placeholder IP <code>10.10.10.10</code>. macOS can only serve as an admin node.</p></li></ol><hr><h2 id=faq>FAQ</h2><h3 id=how-to-use-a-custom-configuration-template>How to use a custom configuration template?</h3><p>Place your configuration file in the <code>conf/</code> directory, then specify it with the <code>-c</code> argument:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp my-config.yml ~/pigsty/conf/myconf.yml
</span></span><span style=display:flex><span>./configure -c myconf
</span></span></code></pre></div><h3 id=how-to-generate-different-configurations-for-multiple-clusters>How to generate different configurations for multiple clusters?</h3><p>Use the <code>-o</code> argument to specify different output files:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c ha/full -o cluster-a.yml
</span></span><span style=display:flex><span>./configure -c ha/trio -o cluster-b.yml
</span></span></code></pre></div><p>Then specify the configuration file when running playbooks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy.yml -i cluster-a.yml
</span></span></code></pre></div><h3 id=how-to-handle-multiple-ips-in-non-interactive-mode>How to handle multiple IPs in non-interactive mode?</h3><p>You must explicitly specify the IP address using the <code>-i</code> argument:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -n -i 10.10.10.10
</span></span></code></pre></div><h3 id=how-to-keep-the-placeholder-ip-in-the-template>How to keep the placeholder IP in the template?</h3><p>Use the <code>-s</code> argument to skip IP replacement:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c ha/full -s   <span style=color:#8f5902;font-style:italic># Keep 10.10.10.10 placeholder</span>
</span></span></code></pre></div><hr><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=/docs/concept/iac/inventory/><strong>Inventory</strong></a>: Understand the Ansible inventory structure</li><li><a href=/docs/concept/iac/parameter/><strong>Parameters</strong></a>: Understand Pigsty parameter hierarchy and priority</li><li><a href=/docs/conf/><strong>Templates</strong></a>: View all available configuration templates</li><li><a href=/docs/setup/install/><strong>Installation</strong></a>: Understand the complete installation process</li><li><a href=/docs/concept/iac/cmdb/><strong>Metabase</strong></a>: Use PostgreSQL as a dynamic configuration source</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e42d80439da940091a403ada6ca968af>3.3 - Parameters</h1><div class=lead>Fine-tune Pigsty customization using configuration parameters</div><p>In the <strong>inventory</strong>, you can use various parameters to fine-tune Pigsty customization. These parameters cover everything from infrastructure settings to database configuration.</p><hr><h2 id=parameter-list>Parameter List</h2><p>Pigsty provides approximately <strong>380+</strong> configuration parameters distributed across 8 default modules for fine-grained control of various system aspects. See <a href=/docs/ref/param><strong>Reference - Parameter List</strong></a> for the complete list.</p><table class=stretch-last><thead><tr><th style=text-align:left>Module</th><th style=text-align:center>Groups</th><th style=text-align:center>Params</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param><strong>PGSQL</strong></a></td><td style=text-align:center>9</td><td style=text-align:center>123</td><td style=text-align:left>Core configuration for PostgreSQL database clusters</td></tr><tr><td style=text-align:left><a href=/docs/infra/param><strong>INFRA</strong></a></td><td style=text-align:center>10</td><td style=text-align:center>82</td><td style=text-align:left>Infrastructure: repos, Nginx, DNS, monitoring, Grafana, etc.</td></tr><tr><td style=text-align:left><a href=/docs/node/param><strong>NODE</strong></a></td><td style=text-align:center>11</td><td style=text-align:center>83</td><td style=text-align:left>Host node tuning: identity, DNS, packages, tuning, security, admin, time, VIP, etc.</td></tr><tr><td style=text-align:left><a href=/docs/etcd/param><strong>ETCD</strong></a></td><td style=text-align:center>2</td><td style=text-align:center>13</td><td style=text-align:left>Distributed configuration store and service discovery</td></tr><tr><td style=text-align:left><a href=/docs/redis/param><strong>REDIS</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>21</td><td style=text-align:left>Redis cache and data structure server</td></tr><tr><td style=text-align:left><a href=/docs/minio/param><strong>MINIO</strong></a></td><td style=text-align:center>2</td><td style=text-align:center>21</td><td style=text-align:left>S3-compatible object storage service</td></tr><tr><td style=text-align:left><a href=/docs/ferret/param><strong>FERRET</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>9</td><td style=text-align:left>MongoDB-compatible database FerretDB</td></tr><tr><td style=text-align:left><a href=/docs/docker/param><strong>DOCKER</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>8</td><td style=text-align:left>Docker container engine</td></tr></tbody></table><hr><h2 id=parameter-form>Parameter Form</h2><p><strong>Parameters</strong> are <strong>key-value pairs</strong> that describe entities. The <strong>Key</strong> is a string, and the <strong>Value</strong> can be one of five types: boolean, string, number, array, or object.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all:                            # &lt;------- Top-level object</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># &lt;------- Global configuration parameter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># &lt;------- pg-meta group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;------- Cluster-level parameter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># &lt;------- Host node IP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;------- Instance-level parameter</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=parameter-priority>Parameter Priority</h2><p>Parameters can be set at different levels with the following priority:</p><table><thead><tr><th style=text-align:left>Level</th><th style=text-align:left>Location</th><th style=text-align:left>Description</th><th style=text-align:left>Priority</th></tr></thead><tbody><tr><td style=text-align:left><strong>CLI</strong></td><td style=text-align:left><code>-e</code> command line argument</td><td style=text-align:left>Passed via command line</td><td style=text-align:left>Highest (5)</td></tr><tr><td style=text-align:left><strong>Host/Instance</strong></td><td style=text-align:left><code>&lt;group>.hosts.&lt;host></code></td><td style=text-align:left>Parameters specific to a single host</td><td style=text-align:left>Higher (4)</td></tr><tr><td style=text-align:left><strong>Group/Cluster</strong></td><td style=text-align:left><code>&lt;group>.vars</code></td><td style=text-align:left>Parameters shared by hosts in group/cluster</td><td style=text-align:left>Medium (3)</td></tr><tr><td style=text-align:left><strong>Global</strong></td><td style=text-align:left><code>all.vars</code></td><td style=text-align:left>Parameters shared by all hosts</td><td style=text-align:left>Lower (2)</td></tr><tr><td style=text-align:left><strong>Default</strong></td><td style=text-align:left><code>&lt;roles>/default/main.yml</code></td><td style=text-align:left>Role implementation defaults</td><td style=text-align:left>Lowest (1)</td></tr></tbody></table><p>Here are some examples of parameter priority:</p><ul><li>Use command line parameter <a href=/docs/infra/param#grafana_clean><strong><code>-e grafana_clean=true</code></strong></a> when running playbooks to wipe Grafana data</li><li>Use instance-level parameter <code>pg_role</code> on host variables to override pg instance role</li><li>Use cluster-level parameter <code>pg_cluster</code> on group variables to override pg cluster name</li><li>Use global parameter <code>node_ntp_servers</code> on global variables to specify global NTP servers</li><li>If <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a> is not set, Pigsty will use the default value from the <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/defaults/main.yml#L42><strong><code>pgsql</code></strong></a> role implementation (default is <code>18</code>)</li></ul><p>Except for <strong>identity parameters</strong>, every parameter has an appropriate default value, so explicit setting is not required.</p><hr><h2 id=identity-parameters>Identity Parameters</h2><p>Identity parameters are special parameters that serve as entity ID identifiers, therefore they <strong>have no default values</strong> and <strong>must be explicitly set</strong>.</p><table><thead><tr><th style=text-align:left>Module</th><th style=text-align:left>Identity Parameters</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_id><strong><code>PGSQL</code></strong></a></td><td style=text-align:left><code>pg_cluster</code>, <code>pg_seq</code>, <code>pg_role</code>, &mldr;</td></tr><tr><td style=text-align:left><a href=/docs/node/param#node_id><strong><code>NODE</code></strong></a></td><td style=text-align:left><code>nodename</code>, <code>node_cluster</code></td></tr><tr><td style=text-align:left><a href=/docs/etcd/param#etcd><strong><code>ETCD</code></strong></a></td><td style=text-align:left><code>etcd_cluster</code>, <code>etcd_seq</code></td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio><strong><code>MINIO</code></strong></a></td><td style=text-align:left><code>minio_cluster</code>, <code>minio_seq</code></td></tr><tr><td style=text-align:left><a href=/docs/redis/param/><strong><code>REDIS</code></strong></a></td><td style=text-align:left><code>redis_cluster</code>, <code>redis_node</code>, <code>redis_instances</code></td></tr><tr><td style=text-align:left><a href=/docs/infra/param#infra_id><strong><code>INFRA</code></strong></a></td><td style=text-align:left><code>infra_seq</code></td></tr></tbody></table><p>Exceptions are <a href=/docs/etcd/param#etcd_cluster><strong><code>etcd_cluster</code></strong></a> and <a href=/docs/minio/param#minio_cluster><strong><code>minio_cluster</code></strong></a> which have default values.
This assumes each deployment has only one etcd cluster for DCS and one optional MinIO cluster for centralized backup storage, so they are assigned default cluster names <code>etcd</code> and <code>minio</code>.
However, you can still deploy multiple etcd or MinIO clusters using different names.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a71a0b133f9617fabea630bbd56757f4>3.4 - Conf Templates</h1><div class=lead>Use pre-made configuration templates to quickly generate configuration files adapted to your environment</div><p>In Pigsty, deployment blueprint details are defined by the <a href=/docs/setup/config/><strong>inventory</strong></a>, which is the <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><strong><code>pigsty.yml</code></strong></a> configuration file. You can customize it through declarative configuration.</p><p>However, writing configuration files directly can be daunting for new users. To address this, we provide some ready-to-use configuration templates covering common usage scenarios.</p><p>Each template is a predefined <code>pigsty.yml</code> configuration file containing reasonable defaults suitable for specific scenarios.</p><p>You can choose a template as your customization starting point, then modify it as needed to meet your specific requirements.</p><hr><h2 id=using-templates>Using Templates</h2><p>Pigsty provides the <a href=https://github.com/pgsty/pigsty/blob/main/configure><strong><code>configure</code></strong></a> script as an optional configuration wizard that generates an <a href=/docs/setup/config/><strong>inventory</strong></a> with good defaults based on your environment and input.</p><p>Use <code>./configure -c &lt;conf></code> to specify a configuration template, where <code>&lt;conf></code> is the path relative to the <code>conf</code> directory (the <code>.yml</code> suffix can be omitted).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure                     <span style=color:#8f5902;font-style:italic># Default to meta.yml configuration template</span>
</span></span><span style=display:flex><span>./configure -c meta             <span style=color:#8f5902;font-style:italic># Explicitly specify meta.yml single-node template</span>
</span></span><span style=display:flex><span>./configure -c rich             <span style=color:#8f5902;font-style:italic># Use feature-rich template with all extensions and MinIO</span>
</span></span><span style=display:flex><span>./configure -c slim             <span style=color:#8f5902;font-style:italic># Use minimal single-node template</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use different database kernels</span>
</span></span><span style=display:flex><span>./configure -c pgsql            <span style=color:#8f5902;font-style:italic># Native PostgreSQL kernel, basic features (13~18)</span>
</span></span><span style=display:flex><span>./configure -c citus            <span style=color:#8f5902;font-style:italic># Citus distributed HA PostgreSQL (14~17)</span>
</span></span><span style=display:flex><span>./configure -c mssql            <span style=color:#8f5902;font-style:italic># Babelfish kernel, SQL Server protocol compatible (15)</span>
</span></span><span style=display:flex><span>./configure -c polar            <span style=color:#8f5902;font-style:italic># PolarDB PG kernel, Aurora/RAC style (15)</span>
</span></span><span style=display:flex><span>./configure -c ivory            <span style=color:#8f5902;font-style:italic># IvorySQL kernel, Oracle syntax compatible (18)</span>
</span></span><span style=display:flex><span>./configure -c mysql            <span style=color:#8f5902;font-style:italic># OpenHalo kernel, MySQL compatible (14)</span>
</span></span><span style=display:flex><span>./configure -c pgtde            <span style=color:#8f5902;font-style:italic># Percona PostgreSQL Server transparent encryption (18)</span>
</span></span><span style=display:flex><span>./configure -c oriole           <span style=color:#8f5902;font-style:italic># OrioleDB kernel, OLTP enhanced (17)</span>
</span></span><span style=display:flex><span>./configure -c supabase         <span style=color:#8f5902;font-style:italic># Supabase self-hosted configuration (15~18)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use multi-node HA templates</span>
</span></span><span style=display:flex><span>./configure -c ha/dual          <span style=color:#8f5902;font-style:italic># Use 2-node HA template</span>
</span></span><span style=display:flex><span>./configure -c ha/trio          <span style=color:#8f5902;font-style:italic># Use 3-node HA template</span>
</span></span><span style=display:flex><span>./configure -c ha/full          <span style=color:#8f5902;font-style:italic># Use 4-node HA template</span>
</span></span></code></pre></div><p>If no template is specified, Pigsty defaults to the <code>meta.yml</code> single-node configuration template.</p><hr><h2 id=template-list>Template List</h2><h3 id=main-templates>Main Templates</h3><p>The following are single-node configuration templates for installing Pigsty on a single server:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/meta/><strong><code>meta.yml</code></strong></a></td><td><strong>Default template</strong>, single-node PostgreSQL online installation</td></tr><tr><td><a href=/docs/conf/rich/><strong><code>rich.yml</code></strong></a></td><td>Feature-rich template with local repo, MinIO, and more examples</td></tr><tr><td><a href=/docs/conf/slim/><strong><code>slim.yml</code></strong></a></td><td>Minimal template, PostgreSQL only without monitoring and infrastructure</td></tr></tbody></table><h3 id=database-kernel-templates>Database Kernel Templates</h3><p>Templates for various database management systems and kernels:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/pgsql/><strong><code>pgsql.yml</code></strong></a></td><td>Native PostgreSQL kernel, basic features (13~18)</td></tr><tr><td><a href=/docs/conf/citus/><strong><code>citus.yml</code></strong></a></td><td>Citus distributed HA PostgreSQL (14~17)</td></tr><tr><td><a href=/docs/conf/mssql/><strong><code>mssql.yml</code></strong></a></td><td>Babelfish kernel, SQL Server protocol compatible (15)</td></tr><tr><td><a href=/docs/conf/polar/><strong><code>polar.yml</code></strong></a></td><td>PolarDB PG kernel, Aurora/RAC style (15)</td></tr><tr><td><a href=/docs/conf/ivory/><strong><code>ivory.yml</code></strong></a></td><td>IvorySQL kernel, Oracle syntax compatible (17)</td></tr><tr><td><a href=/docs/conf/mysql/><strong><code>mysql.yml</code></strong></a></td><td>OpenHalo kernel, MySQL compatible (14)</td></tr><tr><td><a href=/docs/conf/pgtde/><strong><code>pgtde.yml</code></strong></a></td><td>Percona PostgreSQL Server transparent encryption (17)</td></tr><tr><td><a href=/docs/conf/oriole/><strong><code>oriole.yml</code></strong></a></td><td>OrioleDB kernel, OLTP enhanced (17, Debian pkg pending)</td></tr><tr><td><a href=/docs/conf/supabase/><strong><code>supabase.yml</code></strong></a></td><td>Supabase self-hosted configuration (15~17)</td></tr></tbody></table><p>You can add more nodes later or use <a href=#ha-templates>HA templates</a> to plan your cluster from the start.</p><hr><h3 id=ha-templates>HA Templates</h3><p>You can configure Pigsty to run on multiple nodes, forming a high-availability (HA) cluster:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/dual/><strong><code>dual.yml</code></strong></a></td><td>2-node semi-HA deployment</td></tr><tr><td><a href=/docs/conf/trio/><strong><code>trio.yml</code></strong></a></td><td>3-node standard HA deployment</td></tr><tr><td><a href=/docs/conf/full/><strong><code>full.yml</code></strong></a></td><td>4-node standard deployment</td></tr><tr><td><a href=/docs/conf/safe/><strong><code>safe.yml</code></strong></a></td><td>4-node security-enhanced deployment with delayed replica</td></tr><tr><td><a href=/docs/conf/simu/><strong><code>simu.yml</code></strong></a></td><td>20-node production environment simulation</td></tr></tbody></table><hr><h3 id=application-templates>Application Templates</h3><p>You can use the following templates to run Docker applications/software:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/supabase><strong><code>supa.yml</code></strong></a></td><td>Start single-node Supabase</td></tr><tr><td><a href=/docs/conf/odoo/><strong><code>odoo.yml</code></strong></a></td><td>Start Odoo ERP system</td></tr><tr><td><a href=/docs/conf/dify/><strong><code>dify.yml</code></strong></a></td><td>Start Dify AI workflow system</td></tr><tr><td><a href=/docs/conf/electric/><strong><code>electric.yml</code></strong></a></td><td>Start Electric sync engine</td></tr></tbody></table><hr><h3 id=demo-templates>Demo Templates</h3><p>Besides main templates, Pigsty provides a set of demo templates for different scenarios:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/conf/el/><strong><code>el.yml</code></strong></a></td><td>Full-parameter config file for EL 8/9 systems</td></tr><tr><td><a href=/docs/conf/debian/><strong><code>debian.yml</code></strong></a></td><td>Full-parameter config file for Debian/Ubuntu systems</td></tr><tr><td><strong><code>remote.yml</code></strong></td><td>Example config for monitoring remote PostgreSQL clusters or RDS</td></tr><tr><td><strong><code>redis.yml</code></strong></td><td>Redis cluster example configuration</td></tr><tr><td><a href=/docs/conf/minio/><strong><code>minio.yml</code></strong></a></td><td>3-node MinIO cluster example configuration</td></tr><tr><td><a href=/docs/conf/demo/><strong><code>demo.yml</code></strong></a></td><td>Configuration file for Pigsty <a href=https://demo.pigsty.io>public demo site</a></td></tr></tbody></table><hr><h3 id=build-templates>Build Templates</h3><p>The following configuration templates are for development and testing purposes:</p><table><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><strong><code>build.yml</code></strong></td><td>Open source build config for EL 9/10, Debian 12/13, Ubuntu 22.04/24.04</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-4f710b6522c00bd4a1ee261283a935b7>3.5 - Use CMDB as Config Inventory</h1><div class=lead>Use PostgreSQL as a CMDB metabase to store Ansible inventory.</div><p>Pigsty allows you to use a PostgreSQL <strong>metabase</strong> as a dynamic configuration source, replacing static YAML configuration files for more powerful configuration management capabilities.</p><hr><h2 id=overview>Overview</h2><p><strong>CMDB</strong> (Configuration Management Database) is a method of storing configuration information in a database for management.</p><p>In Pigsty, the default configuration source is a static YAML file <code>pigsty.yml</code>,
which serves as Ansible&rsquo;s <a href=/docs/concept/iac/inventory/><strong>inventory</strong></a>.</p><p>This approach is simple and direct, but when infrastructure scales and requires complex, fine-grained management and external integration, a single static file becomes insufficient.</p><table><thead><tr><th style=text-align:center>Feature</th><th style=text-align:left>Static YAML File</th><th style=text-align:left>CMDB Metabase</th></tr></thead><tbody><tr><td style=text-align:center><strong>Querying</strong></td><td style=text-align:left>Manual search/grep</td><td style=text-align:left>SQL queries with any conditions, aggregation analysis</td></tr><tr><td style=text-align:center><strong>Versioning</strong></td><td style=text-align:left>Depends on Git or manual backup</td><td style=text-align:left>Database transactions, audit logs, time-travel snapshots</td></tr><tr><td style=text-align:center><strong>Access Control</strong></td><td style=text-align:left>File system permissions, coarse-grained</td><td style=text-align:left>PostgreSQL fine-grained access control</td></tr><tr><td style=text-align:center><strong>Concurrent Editing</strong></td><td style=text-align:left>Requires file locking or merge conflicts</td><td style=text-align:left>Database transactions naturally support concurrency</td></tr><tr><td style=text-align:center><strong>External Integration</strong></td><td style=text-align:left>Requires YAML parsing</td><td style=text-align:left>Standard SQL interface, easy integration with any language</td></tr><tr><td style=text-align:center><strong>Scalability</strong></td><td style=text-align:left>Difficult to maintain when file becomes too large</td><td style=text-align:left>Scales to physical limits</td></tr><tr><td style=text-align:center><strong>Dynamic Generation</strong></td><td style=text-align:left>Static file, changes require manual application</td><td style=text-align:left>Immediate effect, real-time configuration changes</td></tr></tbody></table><p>Pigsty provides the CMDB database schema in the sample database <a href=https://github.com/pgsty/pigsty/blob/main/conf/meta.yml#L52><strong><code>pg-meta.meta</code></strong></a> schema baseline definition.</p><hr><h2 id=how-it-works>How It Works</h2><p>The core idea of CMDB is to replace the static configuration file with a <strong>dynamic script</strong>.
Ansible supports using executable scripts as inventory, as long as the script outputs inventory data in JSON format.
When you enable CMDB, Pigsty creates a dynamic inventory script named <code>inventory.sh</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span>psql <span style=color:#4e9a06>${</span><span style=color:#000>METADB_URL</span><span style=color:#4e9a06>}</span> -AXtwc <span style=color:#4e9a06>&#39;SELECT text FROM pigsty.inventory;&#39;</span>
</span></span></code></pre></div><p>This script&rsquo;s function is simple: every time Ansible needs to read the inventory, it queries configuration data from the PostgreSQL database&rsquo;s <code>pigsty.inventory</code> view and returns it in JSON format.</p><p>The overall architecture is as follows:</p><pre class=mermaid>flowchart LR
    conf[&#34;bin/inventory_conf&#34;]
    tocmdb[&#34;bin/inventory_cmdb&#34;]
    load[&#34;bin/inventory_load&#34;]
    ansible[&#34;🚀 Ansible&#34;]

    subgraph static[&#34;📄 Static Config Mode&#34;]
        yml[(&#34;pigsty.yml&#34;)]
    end

    subgraph dynamic[&#34;🗄️ CMDB Dynamic Mode&#34;]
        sh[&#34;inventory.sh&#34;]
        cmdb[(&#34;PostgreSQL CMDB&#34;)]
    end

    conf --&gt;|&#34;switch&#34;| yml
    yml --&gt;|&#34;load config&#34;| load
    load --&gt;|&#34;write&#34;| cmdb
    tocmdb --&gt;|&#34;switch&#34;| sh
    sh --&gt; cmdb

    yml --&gt; ansible
    cmdb --&gt; ansible</pre><hr><h2 id=data-model>Data Model</h2><p>The CMDB database schema is defined in <a href=https://github.com/pgsty/pigsty/blob/main/files/cmdb.sql><code>files/cmdb.sql</code></a>, with all objects in the <code>pigsty</code> schema.</p><h3 id=core-tables>Core Tables</h3><table><thead><tr><th style=text-align:center>Table</th><th style=text-align:left>Description</th><th style=text-align:center>Primary Key</th></tr></thead><tbody><tr><td style=text-align:center><code>pigsty.group</code></td><td style=text-align:left>Cluster/group definitions, corresponds to Ansible groups</td><td style=text-align:center><code>cls</code></td></tr><tr><td style=text-align:center><code>pigsty.host</code></td><td style=text-align:left>Host definitions, belongs to a group</td><td style=text-align:center><code>(cls, ip)</code></td></tr><tr><td style=text-align:center><code>pigsty.global_var</code></td><td style=text-align:left>Global variables, corresponds to <code>all.vars</code></td><td style=text-align:center><code>key</code></td></tr><tr><td style=text-align:center><code>pigsty.group_var</code></td><td style=text-align:left>Group variables, corresponds to <code>all.children.&lt;cls>.vars</code></td><td style=text-align:center><code>(cls, key)</code></td></tr><tr><td style=text-align:center><code>pigsty.host_var</code></td><td style=text-align:left>Host variables, host-level variables</td><td style=text-align:center><code>(cls, ip, key)</code></td></tr><tr><td style=text-align:center><code>pigsty.default_var</code></td><td style=text-align:left>Default variable definitions, stores parameter metadata</td><td style=text-align:center><code>key</code></td></tr><tr><td style=text-align:center><code>pigsty.job</code></td><td style=text-align:left>Job records table, records executed tasks</td><td style=text-align:center><code>id</code></td></tr></tbody></table><h3 id=table-structure-details>Table Structure Details</h3><p><strong>Cluster Table <code>pigsty.group</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>     </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- Cluster name, primary key
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ctime</span><span style=color:#f8f8f8>   </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>-- Creation time
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8>   </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- Modification time
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Host Table <code>pigsty.host</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>    </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- Parent cluster
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ip</span><span style=color:#f8f8f8>     </span><span style=color:#000>INET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic>-- Host IP address
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ctime</span><span style=color:#f8f8f8>  </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8>  </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Global Variables Table <code>pigsty.global_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Variable name
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic>-- Variable value (JSON format)
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- Modification time
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Group Variables Table <code>pigsty.group_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Host Variables Table <code>pigsty.host_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>host_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ip</span><span style=color:#f8f8f8>    </span><span style=color:#000>INET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>FOREIGN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=core-views>Core Views</h3><p>CMDB provides a series of views for querying and displaying configuration data:</p><table><thead><tr><th style=text-align:center>View</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><code>pigsty.inventory</code></td><td style=text-align:left><strong>Core view</strong>: Generates Ansible dynamic inventory JSON</td></tr><tr><td style=text-align:center><code>pigsty.raw_config</code></td><td style=text-align:left>Raw configuration in JSON format</td></tr><tr><td style=text-align:center><code>pigsty.global_config</code></td><td style=text-align:left>Global config view, merges defaults and global vars</td></tr><tr><td style=text-align:center><code>pigsty.group_config</code></td><td style=text-align:left>Group config view, includes host list and group vars</td></tr><tr><td style=text-align:center><code>pigsty.host_config</code></td><td style=text-align:left>Host config view, merges group and host-level vars</td></tr><tr><td style=text-align:center><code>pigsty.pg_cluster</code></td><td style=text-align:left>PostgreSQL cluster view</td></tr><tr><td style=text-align:center><code>pigsty.pg_instance</code></td><td style=text-align:left>PostgreSQL instance view</td></tr><tr><td style=text-align:center><code>pigsty.pg_database</code></td><td style=text-align:left>PostgreSQL database definition view</td></tr><tr><td style=text-align:center><code>pigsty.pg_users</code></td><td style=text-align:left>PostgreSQL user definition view</td></tr><tr><td style=text-align:center><code>pigsty.pg_service</code></td><td style=text-align:left>PostgreSQL service definition view</td></tr><tr><td style=text-align:center><code>pigsty.pg_hba</code></td><td style=text-align:left>PostgreSQL HBA rules view</td></tr><tr><td style=text-align:center><code>pigsty.pg_remote</code></td><td style=text-align:left>Remote PostgreSQL instance view</td></tr></tbody></table><p><strong><code>pigsty.inventory</code></strong> is the core view that converts database configuration data to the JSON format required by Ansible:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87>text</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inventory</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=utility-scripts>Utility Scripts</h2><p>Pigsty provides three convenience scripts for managing CMDB:</p><table><thead><tr><th style=text-align:center>Script</th><th style=text-align:left>Function</th></tr></thead><tbody><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_load><code>bin/inventory_load</code></a></td><td style=text-align:left>Load YAML configuration file into PostgreSQL database</td></tr><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_cmdb><code>bin/inventory_cmdb</code></a></td><td style=text-align:left>Switch configuration source to CMDB (dynamic inventory script)</td></tr><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_conf><code>bin/inventory_conf</code></a></td><td style=text-align:left>Switch configuration source to static config file <code>pigsty.yml</code></td></tr></tbody></table><h3 id=inventory_load>inventory_load</h3><p>Parse and import YAML configuration file into CMDB:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_load                     <span style=color:#8f5902;font-style:italic># Load default pigsty.yml to default CMDB</span>
</span></span><span style=display:flex><span>bin/inventory_load -p /path/to/conf.yml  <span style=color:#8f5902;font-style:italic># Specify configuration file path</span>
</span></span><span style=display:flex><span>bin/inventory_load -d <span style=color:#4e9a06>&#34;postgres://...&#34;</span>   <span style=color:#8f5902;font-style:italic># Specify database connection URL</span>
</span></span><span style=display:flex><span>bin/inventory_load -n myconfig           <span style=color:#8f5902;font-style:italic># Specify configuration name</span>
</span></span></code></pre></div><p>The script performs the following operations:</p><ol><li>Clears existing data in the <code>pigsty</code> schema</li><li>Parses the YAML configuration file</li><li>Writes global variables to the <code>global_var</code> table</li><li>Writes cluster definitions to the <code>group</code> table</li><li>Writes cluster variables to the <code>group_var</code> table</li><li>Writes host definitions to the <code>host</code> table</li><li>Writes host variables to the <code>host_var</code> table</li></ol><p><strong>Environment Variables</strong></p><ul><li><code>PIGSTY_HOME</code>: Pigsty installation directory, defaults to <code>~/pigsty</code></li><li><code>METADB_URL</code>: Database connection URL, defaults to <code>service=meta</code></li></ul><h3 id=inventory_cmdb>inventory_cmdb</h3><p>Switch Ansible to use CMDB as the configuration source:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_cmdb
</span></span></code></pre></div><p>The script performs the following operations:</p><ol><li>Creates dynamic inventory script <code>${PIGSTY_HOME}/inventory.sh</code></li><li>Modifies <code>ansible.cfg</code> to set <code>inventory</code> to <code>inventory.sh</code></li></ol><p>The generated <code>inventory.sh</code> contents:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span>psql <span style=color:#4e9a06>${</span><span style=color:#000>METADB_URL</span><span style=color:#4e9a06>}</span> -AXtwc <span style=color:#4e9a06>&#39;SELECT text FROM pigsty.inventory;&#39;</span>
</span></span></code></pre></div><h3 id=inventory_conf>inventory_conf</h3><p>Switch back to using static YAML configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_conf
</span></span></code></pre></div><p>The script modifies <code>ansible.cfg</code> to set <code>inventory</code> back to <code>pigsty.yml</code>.</p><hr><h2 id=usage-workflow>Usage Workflow</h2><h3 id=first-time-cmdb-setup>First-time CMDB Setup</h3><ol><li><strong>Initialize CMDB schema</strong> (usually done automatically during Pigsty installation):</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -f ~/pigsty/files/cmdb.sql
</span></span></code></pre></div><ol start=2><li><strong>Load configuration to database</strong>:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_load
</span></span></code></pre></div><ol start=3><li><strong>Switch to CMDB mode</strong>:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_cmdb
</span></span></code></pre></div><ol start=4><li><strong>Verify configuration</strong>:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible all --list-hosts          <span style=color:#8f5902;font-style:italic># List all hosts</span>
</span></span><span style=display:flex><span>ansible-inventory --list          <span style=color:#8f5902;font-style:italic># View complete inventory</span>
</span></span></code></pre></div><h3 id=query-configuration>Query Configuration</h3><p>After enabling CMDB, you can flexibly query configuration using SQL:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all clusters
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all hosts in a cluster
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View global variables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View cluster variables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all PostgreSQL clusters
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_databases</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_users</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_cluster</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all PostgreSQL instances
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ins</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>seq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_instance</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all database definitions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_database</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all user definitions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>login</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>superuser</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_users</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=modify-configuration>Modify Configuration</h3><p>You can modify configuration directly via SQL:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Add new cluster
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Add cluster variable
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_cluster&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;pg-new&#34;&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Add host
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Add host variables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>host_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_seq&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;1&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_role&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;primary&#34;&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Modify global variable
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;new-value&#34;&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;some_param&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Delete cluster (cascades to hosts and variables)
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DELETE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-old&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Changes take effect immediately without reloading or restarting any service.</p><h3 id=switch-back-to-static-configuration>Switch Back to Static Configuration</h3><p>To switch back to static configuration file mode:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_conf
</span></span></code></pre></div><hr><h2 id=advanced-usage>Advanced Usage</h2><h3 id=export-configuration>Export Configuration</h3><p>Export CMDB configuration to YAML format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>=</span>meta -AXtwc <span style=color:#4e9a06>&#34;SELECT jsonb_pretty(jsonb_build_object(&#39;all&#39;, jsonb_build_object(&#39;children&#39;, children, &#39;vars&#39;, vars))) FROM pigsty.raw_config;&#34;</span>
</span></span></code></pre></div><p>Or use the <code>ansible-inventory</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-inventory --list --yaml &gt; exported_config.yml
</span></span></code></pre></div><h3 id=configuration-auditing>Configuration Auditing</h3><p>Track configuration changes using the <code>mtime</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View recently modified global variables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View changes after a specific time
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-01-01&#39;</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>timestamptz</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=integration-with-external-systems>Integration with External Systems</h3><p>CMDB uses standard PostgreSQL, making it easy to integrate with other systems:</p><ul><li><strong>Web Management Interface</strong>: Expose configuration data through REST API (e.g., PostgREST)</li><li><strong>CI/CD Pipelines</strong>: Read/write database directly in deployment scripts</li><li><strong>Monitoring & Alerting</strong>: Generate monitoring rules based on configuration data</li><li><strong>ITSM Systems</strong>: Sync with enterprise CMDB systems</li></ul><hr><h2 id=considerations>Considerations</h2><ol><li><p><strong>Data Consistency</strong>: After modifying configuration, you need to re-run the corresponding Ansible playbooks to apply changes to the actual environment</p></li><li><p><strong>Backup</strong>: Configuration data in CMDB is critical, ensure regular backups</p></li><li><p><strong>Permissions</strong>: Configure appropriate database access permissions for CMDB to avoid accidental modifications</p></li><li><p><strong>Transactions</strong>: When making batch configuration changes, perform them within a transaction for rollback on errors</p></li><li><p><strong>Connection Pooling</strong>: The <code>inventory.sh</code> script creates a new connection on each execution; if Ansible runs frequently, consider using connection pooling</p></li></ol><hr><h2 id=summary>Summary</h2><p>CMDB is Pigsty&rsquo;s advanced configuration management solution, suitable for scenarios requiring large-scale cluster management, complex queries, external integration, or fine-grained access control. By storing configuration data in PostgreSQL, you can fully leverage the database&rsquo;s powerful capabilities to manage infrastructure configuration.</p><table><thead><tr><th style=text-align:center>Feature</th><th style=text-align:center>Description</th></tr></thead><tbody><tr><td style=text-align:center><strong>Storage</strong></td><td style=text-align:center>PostgreSQL <code>pigsty</code> schema</td></tr><tr><td style=text-align:center><strong>Dynamic Inventory</strong></td><td style=text-align:center><code>inventory.sh</code> script</td></tr><tr><td style=text-align:center><strong>Config Load</strong></td><td style=text-align:center><code>bin/inventory_load</code></td></tr><tr><td style=text-align:center><strong>Switch to CMDB</strong></td><td style=text-align:center><code>bin/inventory_cmdb</code></td></tr><tr><td style=text-align:center><strong>Switch to YAML</strong></td><td style=text-align:center><code>bin/inventory_conf</code></td></tr><tr><td style=text-align:center><strong>Core View</strong></td><td style=text-align:center><code>pigsty.inventory</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-611f3486b406a3e3cb452cbc6af4b548>4 - High Availability</h1><div class=lead>Pigsty uses Patroni to implement PostgreSQL high availability, ensuring automatic failover when the primary becomes unavailable.</div><hr><h2 id=overview>Overview</h2><p>Pigsty&rsquo;s PostgreSQL clusters come with out-of-the-box high availability, powered by <a href=https://patroni.readthedocs.io/en/latest/><strong>Patroni</strong></a>, <a href=https://etcd.io/><strong>Etcd</strong></a>, and <a href=http://www.haproxy.org/><strong>HAProxy</strong></a>.</p><p>When your PostgreSQL cluster has two or more instances, you automatically have self-healing database high availability without any additional configuration — as long as any instance in the cluster survives, the cluster can provide complete service. Clients only need to connect to any node in the cluster to get full service without worrying about primary-replica topology changes.</p><p>With default configuration, the primary failure Recovery Time Objective (RTO) ≈ 45s, and Recovery Point Objective (RPO) &lt; 1MB; for replica failures, RPO = 0 and RTO ≈ 0 (brief interruption). In consistency-first mode, failover can guarantee zero data loss: RPO = 0. All these metrics can be <a href=#tradeoffs><strong>configured as needed</strong></a> based on your actual hardware conditions and reliability requirements.</p><p>Pigsty includes built-in HAProxy load balancers for automatic traffic switching, providing DNS/VIP/LVS and other access methods for clients. Failover and switchover are almost transparent to the business side except for brief interruptions - applications don&rsquo;t need to modify connection strings or restart.
The minimal maintenance window requirements bring great flexibility and convenience: you can perform rolling maintenance and upgrades on the entire cluster without application coordination. The feature that hardware failures can wait until the next day to handle lets developers, operations, and DBAs sleep well during incidents.</p><p><del><img src=/img/pigsty/ha.png alt=pigsty-ha></del></p><p>Many large organizations and core institutions have been using Pigsty in production for extended periods. The largest deployment has 25K CPU cores and 220+ PostgreSQL ultra-large instances (64c / 512g / 3TB NVMe SSD). In this deployment case, dozens of hardware failures and various incidents occurred over five years, yet overall availability of over <strong>99.999%</strong> was maintained.</p><hr><p><strong>What problems does High Availability solve?</strong></p><ul><li>Elevates data security C/IA availability to a new level: RPO ≈ 0, RTO &lt; 45s.</li><li>Gains seamless rolling maintenance capability, minimizing maintenance window requirements and bringing great convenience.</li><li>Hardware failures can self-heal immediately without human intervention, allowing operations and DBAs to sleep well.</li><li>Replicas can handle read-only requests, offloading primary load and fully utilizing resources.</li></ul><p><strong>What are the costs of High Availability?</strong></p><ul><li>Infrastructure dependency: HA requires DCS (etcd/zk/consul) for consensus.</li><li>Higher starting threshold: A meaningful HA deployment requires at least <strong>three nodes</strong>.</li><li>Extra resource consumption: Each new replica consumes additional resources, though this is usually not a major concern.</li><li>Significantly increased complexity: Backup costs increase significantly, requiring tools to manage complexity.</li></ul><p><strong>Limitations of High Availability</strong></p><p>Since replication happens in real-time, all changes are immediately applied to replicas. Therefore, streaming replication-based HA solutions cannot handle data deletion or modification caused by human errors and software defects. (e.g., <code>DROP TABLE</code> or <code>DELETE</code> data)
Such failures require using <a href=/docs/pgsql/config#delayed-cluster><strong>delayed clusters</strong></a> or performing <a href=/docs/concept/pitr><strong>point-in-time recovery</strong></a> using previous base backups and WAL archives.</p><table><thead><tr><th style=text-align:left>Configuration Strategy</th><th>RTO</th><th style=text-align:left>RPO</th></tr></thead><tbody><tr><td style=text-align:left>Standalone + <i class="fa-solid fa-music text-danger"></i> Nothing</td><td><i class="fas fa-circle-xmark text-danger"></i> <strong>Data permanently lost, unrecoverable</strong></td><td style=text-align:left><i class="fas fa-circle-xmark text-danger"></i> <strong>All data lost</strong></td></tr><tr><td style=text-align:left>Standalone + <i class="fa-solid fa-copy text-secondary"></i> Base Backup</td><td><i class="fa-solid fa-triangle-exclamation text-secondary"></i> Depends on backup size and bandwidth (hours)</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-secondary"></i> Lose data since last backup (hours to days)</td></tr><tr><td style=text-align:left>Standalone + <i class="fa-solid fa-copy text-primary"></i> Base Backup + <i class="fa-solid fa-clock-rotate-left text-primary"></i> WAL Archive</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> Depends on backup size and bandwidth (hours)</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-primary"></i> Lose unarchived data (tens of MB)</td></tr><tr><td style=text-align:left>Primary-Replica + <i class="fa-solid fa-wrench text-secondary"></i> Manual Failover</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> ~10 minutes</td><td style=text-align:left><i class="fa-solid fa-circle-check text-primary"></i> Lose data in replication lag (~100KB)</td></tr><tr><td style=text-align:left>Primary-Replica + <i class="fa-solid fa-infinity text-primary"></i> Auto Failover</td><td><i class="fa-solid fa-circle-check text-primary"></i> Within 1 minute</td><td style=text-align:left><i class="fa-solid fa-circle-check text-primary"></i> Lose data in replication lag (~100KB)</td></tr><tr><td style=text-align:left>Primary-Replica + <i class="fa-solid fa-infinity text-primary"></i> Auto Failover + <i class="fa-solid fa-rotate text-success"></i> Sync Commit</td><td><i class="fa-solid fa-circle-check text-success"></i> Within 1 minute</td><td style=text-align:left><i class="fa-solid fa-circle-check text-success"></i> No data loss</td></tr></tbody></table><hr><h2 id=how-it-works>How It Works</h2><p>In Pigsty, the high availability architecture works as follows:</p><ul><li>PostgreSQL uses standard streaming replication to build physical replicas; replicas take over when the primary fails.</li><li>Patroni manages PostgreSQL server processes and handles high availability matters.</li><li>Etcd provides distributed configuration storage (DCS) capability and is used for leader election after failures.</li><li>Patroni relies on Etcd to reach cluster leader consensus and provides health check interfaces externally.</li><li>HAProxy exposes cluster services externally and uses Patroni health check interfaces to automatically distribute traffic to healthy nodes.</li><li>vip-manager provides an optional Layer 2 VIP, retrieves leader information from Etcd, and binds the VIP to the node where the cluster primary resides.</li></ul><p>When the primary fails, a new round of leader election is triggered. The healthiest replica in the cluster (highest LSN position, minimum data loss) wins and is promoted to the new primary. After the winning replica is promoted, read-write traffic is immediately routed to the new primary.
The impact of primary failure is <strong>brief write service unavailability</strong>: write requests will be blocked or fail directly from primary failure until new primary promotion, with unavailability typically lasting 15 to 30 seconds, usually not exceeding 1 minute.</p><p>When a replica fails, read-only traffic is routed to other replicas. Only when all replicas fail will read-only traffic ultimately be handled by the primary.
The impact of replica failure is <strong>partial read-only query interruption</strong>: queries currently running on that replica will abort due to connection reset and be immediately taken over by other available replicas.</p><p>Failure detection is performed jointly by Patroni and Etcd. The cluster leader holds a lease; if the cluster leader fails to renew the lease in time (10s) due to failure, the lease is released, triggering a <strong>Failover</strong> and new cluster election.</p><p>Even without any failures, you can proactively change the cluster primary through <a href=/docs/pgsql/admin#switchover><strong>Switchover</strong></a>.
In this case, write queries on the primary will experience a brief interruption and be immediately routed to the new primary. This operation is typically used for rolling maintenance/upgrades of database servers.</p><hr><h2 id=tradeoffs>Tradeoffs</h2><p><strong>Recovery Time Objective (RTO)</strong> and <strong>Recovery Point Objective (RPO)</strong> are two parameters that require careful tradeoffs when designing high availability clusters.</p><p>The default <strong>RTO</strong> and <strong>RPO</strong> values used by Pigsty meet reliability requirements for most scenarios. You can adjust them based on your hardware level, network quality, and business requirements.</p><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>RTO and RPO are NOT always better when smaller!</div><p>Too small an RTO increases false positive rates; too small an RPO reduces the probability of successful automatic failover.</p></div><p>The upper limit of unavailability during failover is controlled by the <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> parameter. <strong>RTO</strong> defaults to <code>45s</code>. Increasing it will result in longer primary failure write unavailability, while decreasing it will increase the rate of false positive failovers (e.g., repeated switching due to brief network jitter).</p><p>The upper limit of potential data loss is controlled by the <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> parameter, defaulting to <code>1MB</code>. Reducing this value can lower the data loss ceiling during failover but also increases the probability of refusing automatic failover when replicas are not healthy enough (lagging too far behind).</p><p>Pigsty uses <strong>availability-first</strong> mode by default, meaning it will failover as quickly as possible when the primary fails, and data not yet replicated to replicas may be lost (under typical 10GbE networks, replication lag is usually a few KB to 100KB).</p><p>If you need to ensure zero data loss during failover, you can use the <a href=/docs/pgsql/param#pg_conf><strong><code>crit.yml</code></strong></a> template to ensure no data loss during failover, but this sacrifices some performance as a tradeoff.</p><hr><h2 id=related-parameters>Related Parameters</h2><h3 id=pg_rto><a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a></h3><p>Parameter name: <code>pg_rto</code>, Type: <code>int</code>, Level: <code>C</code></p><p>Recovery Time Objective (RTO) in seconds. This is used to calculate Patroni&rsquo;s TTL value, defaulting to <code>45</code> seconds.</p><p>If the primary instance is missing for this long, a new leader election will be triggered. This value is not always better when lower; it involves tradeoffs:
Reducing this value can decrease unavailability during cluster failover (inability to write), but makes the cluster more sensitive to short-term network jitter, increasing the probability of false positive failover triggers.
You need to configure this value based on network conditions and business constraints, making a <strong>tradeoff</strong> between <strong>failure probability</strong> and <strong>failure impact</strong>.</p><h3 id=pg_rpo><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a></h3><p>Parameter name: <code>pg_rpo</code>, Type: <code>int</code>, Level: <code>C</code></p><p>Recovery Point Objective (RPO) in bytes, default: <code>1048576</code>.</p><p>Defaults to 1MiB, meaning up to 1MiB of data loss can be tolerated during failover.</p><p>When the primary goes down and all replicas are lagging, you must make a difficult choice:
Either promote a replica to become the new primary immediately, accepting acceptable data loss (e.g., less than 1MB), and restore service as quickly as possible.
Or wait for the primary to come back online (which may never happen) to avoid any data loss, or abandon automatic failover and wait for human intervention to make the final decision.
You need to configure this value based on business preference, making a <strong>tradeoff</strong> between <strong>availability</strong> and <strong>consistency</strong>.</p><p>Additionally, you can always ensure RPO = 0 by enabling synchronous commit (e.g., using the <code>crit.yml</code> template), sacrificing some cluster latency/throughput performance to guarantee data consistency.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-928294eb73615de574523762c3a1ab07>4.1 - RPO Trade-offs</h1><div class=lead>Trade-off analysis for RPO (Recovery Point Objective), finding the optimal balance between availability and data loss.</div><p><strong>RPO</strong> (Recovery Point Objective) defines the <strong>maximum amount of data loss</strong> allowed when the primary fails.</p><p>For scenarios where data integrity is critical, such as financial transactions, RPO = 0 is typically required, meaning no data loss is allowed.</p><p>However, stricter RPO targets come at a cost: higher write latency, reduced system throughput, and the risk that replica failures may cause primary unavailability.
For typical scenarios, some data loss is acceptable (e.g., up to 1MB) in exchange for higher availability and performance.</p><hr><h2 id=trade-offs>Trade-offs</h2><p>In asynchronous replication scenarios, there is typically some replication lag between replicas and the primary (depending on network and throughput, normally in the range of 10KB-100KB / 100µs-10ms).
This means when the primary fails, replicas may not have fully synchronized with the latest data. If a failover occurs, the new primary may lose some unreplicated data.</p><p>The upper limit of potential data loss is controlled by the <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> parameter, which defaults to <code>1048576</code> (<code>1MB</code>), meaning up to 1MiB of data loss can be tolerated during failover.</p><p>When the cluster primary fails, if any replica has replication lag within this threshold, Pigsty will automatically promote that replica to be the new primary.
However, when all replicas exceed this threshold, Pigsty will refuse [<strong>automatic failover</strong>] to prevent data loss.
Manual intervention is then required to decide whether to wait for the primary to recover (which may never happen) or accept the data loss and force-promote a replica.</p><p>You need to configure this value based on your business requirements, making a <strong>trade-off</strong> between <strong>availability</strong> and <strong>consistency</strong>.
Increasing this value improves the success rate of automatic failover but also increases the upper limit of potential data loss.</p><p>When you set <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> = 0, Pigsty enables <strong>synchronous replication</strong>, ensuring the primary only returns write success after at least one replica has persisted the data.
This configuration ensures zero replication lag but introduces significant write latency and reduces overall throughput.</p><pre class=mermaid>flowchart LR
    A([Primary Failure]) --&gt; B{Synchronous&lt;br/&gt;Replication?}

    B --&gt;|No| C{Lag &lt; RPO?}
    B --&gt;|Yes| D{Sync Replica&lt;br/&gt;Available?}

    C --&gt;|Yes| E[Lossy Auto Failover&lt;br/&gt;RPO &lt; 1MB]
    C --&gt;|No| F[Refuse Auto Failover&lt;br/&gt;Wait for Primary Recovery&lt;br/&gt;or Manual Intervention]

    D --&gt;|Yes| G[Lossless Auto Failover&lt;br/&gt;RPO = 0]
    D --&gt;|No| H{Strict Mode?}

    H --&gt;|No| C
    H --&gt;|Yes| F

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#F0AD4E,stroke:#146c43,color:#fff
    style G fill:#198754,stroke:#146c43,color:#fff
    style F fill:#BE002F,stroke:#565e64,color:#fff</pre><hr><h2 id=protection-modes>Protection Modes</h2><p>Pigsty provides three protection modes to help users make trade-offs under different RPO requirements, similar to <a href=https://docs.oracle.com/en/database/oracle/oracle-database/21/sbydb/oracle-data-guard-protection-modes.html><strong>Oracle Data Guard</strong></a> protection modes.</p><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>Maximum Performance</div><ul><li><strong>Default mode</strong>, asynchronous replication, transactions commit with only local WAL persistence, no waiting for replicas, replica failures are completely transparent to the primary</li><li>Primary failure may lose unsent/unreceived WAL (typically &lt; 1MB, normally 10ms/100ms, 10KB/100KB range under normal network conditions)</li><li>Optimized for performance, suitable for typical business scenarios that tolerate minor data loss during failures</li></ul></div><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>Maximum Availability</div><ul><li>Configured with <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo = 0</code></strong></a>, enables Patroni synchronous commit mode: <code>synchronous_mode: true</code></li><li>Under normal conditions, waits for at least one replica confirmation, achieving zero data loss. When <strong>all</strong> sync replicas fail, <strong>automatically degrades to async mode to continue service</strong></li><li>Balances data safety and service availability, recommended configuration for production <strong>critical business</strong></li></ul></div><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Maximum Protection</div><ul><li>Uses <code>crit.yml</code> template, enables Patroni strict synchronous mode: <code>synchronous_mode: true</code> / <code>synchronous_mode_strict: true</code></li><li>When all sync replicas fail, <strong>primary refuses writes</strong> to prevent data loss, transactions must be persisted on at least one replica before returning success</li><li>Suitable for financial transactions, medical records, and other scenarios with extremely high data integrity requirements</li></ul></div><table class=full-width><thead><tr><th style=text-align:left><strong>Name</strong></th><th style=text-align:center><strong>Maximum Performance</strong></th><th style=text-align:center><strong>Maximum Availability</strong></th><th style=text-align:center><strong>Maximum Protection</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>Replication</strong></td><td style=text-align:center><strong>Asynchronous</strong></td><td style=text-align:center><strong>Synchronous</strong></td><td style=text-align:center><strong>Strict Synchronous</strong></td></tr><tr><td style=text-align:left><strong>Data Loss</strong></td><td style=text-align:center><span class=text-danger><strong>Possible</strong></span> (replication lag)</td><td style=text-align:center><span class=text-primary><strong>Zero normally, minor when degraded</strong></span></td><td style=text-align:center><span class=text-success><strong>Zero</strong></span></td></tr><tr><td style=text-align:left><strong>Write Latency</strong></td><td style=text-align:center><span class=text-success><strong>Lowest</strong></span></td><td style=text-align:center><span class=text-warning><strong>Medium</strong></span> (+1 network RTT)</td><td style=text-align:center><span class=text-warning><strong>Medium</strong></span> (+1 network RTT)</td></tr><tr><td style=text-align:left><strong>Throughput</strong></td><td style=text-align:center><span class=text-success><strong>Highest</strong></span></td><td style=text-align:center><span class=text-warning><strong>Reduced</strong></span></td><td style=text-align:center><span class=text-warning><strong>Reduced</strong></span></td></tr><tr><td style=text-align:left><strong>Replica Failure Impact</strong></td><td style=text-align:center><span class=text-success><strong>None</strong></span></td><td style=text-align:center><span class=text-primary><strong>Auto degrade, service continues</strong></span></td><td style=text-align:center><span class=text-danger><strong>Primary stops writes</strong></span></td></tr><tr><td style=text-align:left><strong>RPO</strong></td><td style=text-align:center><span class=text-warning><strong>&lt; 1MB</strong></span></td><td style=text-align:center><span class=text-primary><strong>= 0 (normal) / &lt; 1MB (degraded)</strong></span></td><td style=text-align:center><span class=text-success><strong>= 0</strong></span></td></tr><tr><td style=text-align:left><strong>Use Case</strong></td><td style=text-align:center>Typical business, performance first</td><td style=text-align:center>Critical business, safety first</td><td style=text-align:center>Financial core, compliance first</td></tr><tr><td style=text-align:left><strong>Configuration</strong></td><td style=text-align:center>Default config</td><td style=text-align:center><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> = <code>0</code></td><td style=text-align:center><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>: <code>crit.yml</code></td></tr></tbody></table><hr><h2 id=implementation>Implementation</h2><p>The three protection modes differ in how two core <strong>Patroni</strong> parameters are configured: <a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-mode><strong><code>synchronous_mode</code></strong></a> and <a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-mode><strong><code>synchronous_mode_strict</code></strong></a>:</p><ul><li><strong><code>synchronous_mode</code></strong>: Whether Patroni enables synchronous replication. If enabled, check if <strong><code>synchronous_mode_strict</code></strong> enables strict synchronous mode.</li><li><strong><code>synchronous_mode_strict = false</code></strong>: Default configuration, allows degradation to async mode when replicas fail, <strong>primary continues service</strong> (Maximum Availability)</li><li><strong><code>synchronous_mode_strict = true</code></strong>: Degradation forbidden, <strong>primary stops writes</strong> until sync replica recovers (Maximum Protection)</li></ul><table class=full-width><thead><tr><th style=text-align:center>Mode</th><th style=text-align:center><strong><code>synchronous_mode</code></strong></th><th style=text-align:center><strong><code>synchronous_mode_strict</code></strong></th><th>Replication Mode</th><th style=text-align:left>Replica Failure Behavior</th></tr></thead><tbody><tr><td style=text-align:center><strong>Max Performance</strong></td><td style=text-align:center><span class=text-danger><strong><code>false</code></strong></span></td><td style=text-align:center>-</td><td><strong>Async</strong></td><td style=text-align:left><span class=text-success><strong>No impact</strong></span></td></tr><tr><td style=text-align:center><strong>Max Availability</strong></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td style=text-align:center><span class=text-danger><strong><code>false</code></strong></span></td><td><strong>Synchronous</strong></td><td style=text-align:left><span class=text-primary><strong>Auto degrade to async</strong></span></td></tr><tr><td style=text-align:center><strong>Max Protection</strong></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td><strong>Strict Synchronous</strong></td><td style=text-align:left><span class=text-danger><strong>Primary refuses writes</strong></span></td></tr></tbody></table><p>Typically, you only need to set the <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> parameter to <code>0</code> to enable the <code>synchronous_mode</code> switch, activating <strong>Maximum Availability mode</strong>.
If you use <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <a href=/docs/pgsql/template/crit><strong><code>crit.yml</code></strong></a> template, it additionally enables the <code>synchronous_mode_strict</code> strict mode switch, activating <strong>Maximum Protection mode</strong>.</p><p>You can also directly <a href=/docs/pgsql/admin/patroni#modify-config><strong>configure</strong></a> these Patroni parameters as needed. Refer to Patroni and PostgreSQL documentation to achieve stronger data protection, such as:</p><ul><li>Specify the <a href=/docs/pgsql/config/cluster#quorum-commit><strong>synchronous replica list</strong></a>, configure more sync replicas to improve disaster tolerance, use quorum synchronous commit, or even require all replicas to perform synchronous commit.</li><li><a href=/docs/pgsql/admin/patroni#modify-config><strong>Configure</strong></a> <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT><strong><code>synchronous_commit</code></strong></a>: <code>'remote_apply'</code> to strictly ensure primary-replica read-write consistency. (Oracle Maximum Protection mode is equivalent to <code>remote_write</code>)</li></ul><hr><h2 id=recommendations>Recommendations</h2><p><strong>Maximum Performance mode</strong> (asynchronous replication) is the default mode used by Pigsty and is sufficient for the vast majority of workloads.
Tolerating minor data loss during failures (typically in the range of a few KB to hundreds of KB) in exchange for higher throughput and availability is the recommended configuration for typical business scenarios.
In this case, you can adjust the maximum allowed data loss through the <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> parameter to suit different business needs.</p><p><strong>Maximum Availability mode</strong> (synchronous replication) is suitable for scenarios with high data integrity requirements that cannot tolerate data loss.
In this mode, a minimum of two-node PostgreSQL cluster (one primary, one replica) is required.
Set <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> to 0 to enable this mode.</p><p><strong>Maximum Protection mode</strong> (strict synchronous replication) is suitable for financial transactions, medical records, and other scenarios with extremely high data integrity requirements. We recommend using at least a three-node cluster (one primary, two replicas),
because with only two nodes, if the replica fails, the primary will stop writes, causing service unavailability, which reduces overall system reliability. With three nodes, if only one replica fails, the primary can continue to serve.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-95882b9440d286103890671f368774b6>4.2 - RTO Trade-offs</h1><div class=lead>Trade-off analysis for RTO (Recovery Time Objective), finding the optimal balance between recovery speed and false failover risk.</div><p><strong>RTO</strong> (Recovery Time Objective) defines the <strong>maximum time required for the system to restore write capability</strong> when the primary fails.</p><p>For critical transaction systems where availability is paramount, the shortest possible RTO is typically required, such as under one minute.</p><p>However, shorter RTO comes at a cost: increased false failover risk. Network jitter may be misinterpreted as a failure, leading to unnecessary failovers.
For cross-datacenter/cross-region deployments, RTO requirements are typically relaxed (e.g., 1-2 minutes) to reduce false failover risk.</p><hr><h2 id=trade-offs>Trade-offs</h2><p>The upper limit of unavailability during failover is controlled by the <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> parameter. Pigsty provides four preset RTO modes:
<code>fast</code>, <code>norm</code>, <code>safe</code>, <code>wide</code>, each optimized for different network conditions and deployment scenarios. The default is <code>norm</code> mode (~45 seconds).
You can also specify the RTO upper limit directly in seconds, and the system will automatically map to the closest mode.</p><p>When the primary fails, the entire recovery process involves multiple phases: Patroni detects the failure, DCS lock expires, new primary election, promote execution, HAProxy detects the new primary.
Reducing RTO means shortening the timeout for each phase, which makes the cluster more sensitive to network jitter, thereby increasing false failover risk.</p><p>You need to choose the appropriate mode based on actual network conditions, balancing <strong>recovery speed</strong> and <strong>false failover risk</strong>.
The worse the network quality, the more conservative mode you should choose; the better the network quality, the more aggressive mode you can choose.</p><pre class=mermaid>flowchart LR
    A([Primary Failure]) --&gt; B{Patroni&lt;br/&gt;Detected?}

    B --&gt;|PG Crash| C[Attempt Local Restart]
    B --&gt;|Node Down| D[Wait TTL Expiration]

    C --&gt;|Success| E([Local Recovery])
    C --&gt;|Fail/Timeout| F[Release Leader Lock]

    D --&gt; F
    F --&gt; G[Replica Election]
    G --&gt; H[Execute Promote]
    H --&gt; I[HAProxy Detects]
    I --&gt; J([Service Restored])

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#198754,stroke:#146c43,color:#fff
    style J fill:#198754,stroke:#146c43,color:#fff</pre><hr><h2 id=four-modes>Four Modes</h2><p>Pigsty provides four RTO modes to help users make trade-offs under different network conditions.</p><table class=full-width><thead><tr><th style=text-align:left><strong>Name</strong></th><th style=text-align:center><strong>fast</strong></th><th style=text-align:center><strong>norm</strong></th><th style=text-align:center><strong>safe</strong></th><th style=text-align:center><strong>wide</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>Use Case</strong></td><td style=text-align:center>Same rack</td><td style=text-align:center>Same datacenter (default)</td><td style=text-align:center>Same region, cross-DC</td><td style=text-align:center>Cross-region/continent</td></tr><tr><td style=text-align:left><strong>Network</strong></td><td style=text-align:center>&lt; 1ms, very stable</td><td style=text-align:center>1-5ms, normal</td><td style=text-align:center>10-50ms, cross-DC</td><td style=text-align:center>100-200ms, public network</td></tr><tr><td style=text-align:left><strong>Target RTO</strong></td><td style=text-align:center><span class=text-success><strong>30s</strong></span></td><td style=text-align:center><span class=text-primary><strong>45s</strong></span></td><td style=text-align:center><span class=text-warning><strong>90s</strong></span></td><td style=text-align:center><span class=text-danger><strong>150s</strong></span></td></tr><tr><td style=text-align:left><strong>False Failover Risk</strong></td><td style=text-align:center><span class=text-secondary><strong>Higher</strong></span></td><td style=text-align:center><span class=text-primary><strong>Medium</strong></span></td><td style=text-align:center><span class=text-success><strong>Lower</strong></span></td><td style=text-align:center><span class=text-success><strong>Very Low</strong></span></td></tr><tr><td style=text-align:left><strong>Configuration</strong></td><td style=text-align:center><code>pg_rto: fast</code></td><td style=text-align:center><code>pg_rto: norm</code></td><td style=text-align:center><code>pg_rto: safe</code></td><td style=text-align:center><code>pg_rto: wide</code></td></tr></tbody></table><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>fast: Same Rack/Switch</div><ul><li>Suitable for scenarios with extremely low network latency (&lt; 1ms) and very stable networks, such as same-rack or same-switch deployments</li><li>Average RTO: <strong>14s</strong>, worst case: <strong>29s</strong>, TTL only 20s, check interval 5s</li><li>Highest network quality requirements, any jitter may trigger failover, <strong>higher false failover risk</strong></li></ul></div><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>norm: Same Datacenter (Default)</div><ul><li><strong>Default mode</strong>, suitable for same-datacenter deployment, network latency 1-5ms, normal quality, reasonable packet loss rate</li><li>Average RTO: <strong>21s</strong>, worst case: <strong>43s</strong>, TTL is 30s, provides reasonable tolerance window</li><li>Balances recovery speed and stability, suitable for most production environments</li></ul></div><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>safe: Same Region, Cross-Datacenter</div><ul><li>Suitable for same-region/same-area cross-datacenter deployment, network latency 10-50ms, occasional jitter possible</li><li>Average RTO: <strong>43s</strong>, worst case: <strong>91s</strong>, TTL is 60s, longer tolerance window</li><li>Primary restart wait time is longer (60s), gives more local recovery opportunities, <strong>lower false failover risk</strong></li></ul></div><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>wide: Cross-Region/Continent</div><ul><li>Suitable for cross-region or even cross-continent deployment, network latency 100-200ms, possible public-network-level packet loss</li><li>Average RTO: <strong>92s</strong>, worst case: <strong>207s</strong>, TTL is 120s, very wide tolerance window</li><li>Sacrifices recovery speed for extremely low false failover rate, suitable for geo-disaster recovery scenarios</li></ul></div><hr><h2 id=rto-timeline>RTO Timeline</h2><p>Patroni / PG HA has two critical failure paths. For detailed RTO timing analysis, see: <a href=/docs/concept/ha/failure/active><strong>Active Failure Detection</strong></a> and <a href=/docs/concept/ha/failure/passive><strong>Passive Lease Expiration</strong></a>.</p><div id=echarts-74af516d5864b02d2eb17471e66dde23 class="echarts-container td-max-width-on-larger-screens" style=height:820px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-74af516d5864b02d2eb17471e66dde23");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:110,right:24,top:40},legend:{data:["Lease Expiration","Failure Detection","Restart Timeout","Replica Detection","Lock & Promote","Health Check"],itemGap:10,top:0},series:[{barWidth:16,data:[120,110,100,"-","-","-","-",60,55,50,"-","-","-","-",30,27,25,"-","-","-","-",20,17,15,"-","-","-"],emphasis:{focus:"series"},itemStyle:{color:"#e15759"},name:"Lease Expiration",stack:"main",type:"bar",z:2},{data:["-","-","-",20,10,0,"-","-","-","-",10,5,0,"-","-","-","-",5,3,0,"-","-","-","-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#b07aa1"},name:"Failure Detection",stack:"main",type:"bar",z:2},{data:["-","-","-",95,95,0,"-","-","-","-",45,45,0,"-","-","-","-",25,25,0,"-","-","-","-",15,15,0],emphasis:{focus:"series"},itemStyle:{color:"#f28e2c"},name:"Restart Timeout",stack:"main",type:"bar",z:2},{data:[20,10,0,20,10,0,"-",10,5,0,10,5,0,"-",5,3,0,5,3,0,"-",5,3,0,5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"Replica Detection",stack:"main",type:"bar",z:2},{data:[2,1,0,2,1,0,"-",2,1,0,2,1,0,"-",2,1,0,2,1,0,"-",2,1,0,2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"Lock & Promote",stack:"main",type:"bar",z:2},{data:[8,6,4,8,6,4,"-",6,5,3,6,5,3,"-",4,3,2,4,3,2,"-",2,2,1,2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"Health Check",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:16,data:[150,127,104,145,122,4,"-",78,66,53,73,61,3,"-",41,34,27,41,35,2,"-",29,23,16,29,24,1],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO Total",type:"bar",z:1},{barGap:"-100%",barWidth:16,data:[150,150,150,150,150,150,"-",90,90,90,90,90,90,"-",45,45,45,45,45,45,"-",30,30,30,30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO Budget",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"Seconds",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:9},axisLine:{show:!0},axisTick:{show:!0},data:["wide-passive-max","wide-passive-avg","wide-passive-min","wide-active-max","wide-active-avg","wide-active-min","","safe-passive-max","safe-passive-avg","safe-passive-min","safe-active-max","safe-active-avg","safe-active-min","","norm-passive-max","norm-passive-avg","norm-passive-min","norm-active-max","norm-active-avg","norm-active-min","","fast-passive-max","fast-passive-avg","fast-passive-min","fast-active-max","fast-active-avg","fast-active-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=implementation>Implementation</h2><p>The four RTO modes differ in how the following 10 <strong>Patroni</strong> and <strong>HAProxy</strong> HA-related parameters are configured.</p><table class=full-width><thead><tr><th style=text-align:center>Component</th><th style=text-align:center>Parameter</th><th style=text-align:center><strong>fast</strong></th><th style=text-align:center><strong>norm</strong></th><th style=text-align:center><strong>safe</strong></th><th style=text-align:center><strong>wide</strong></th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>patroni</code></strong></td><td style=text-align:center><strong><code>ttl</code></strong></td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:center>60</td><td style=text-align:center>120</td><td style=text-align:left>Leader lock TTL (seconds)</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>loop_wait</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>20</td><td style=text-align:left>HA loop check interval (seconds)</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>retry_timeout</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:left>DCS operation retry timeout (seconds)</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>primary_start_timeout</code></strong></td><td style=text-align:center>15</td><td style=text-align:center>25</td><td style=text-align:center>45</td><td style=text-align:center>95</td><td style=text-align:left>Primary restart wait time (seconds)</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>safety_margin</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>15</td><td style=text-align:left>Watchdog safety margin (seconds)</td></tr><tr><td style=text-align:center><strong><code>haproxy</code></strong></td><td style=text-align:center><strong><code>inter</code></strong></td><td style=text-align:center>1s</td><td style=text-align:center>2s</td><td style=text-align:center>3s</td><td style=text-align:center>4s</td><td style=text-align:left>Normal state check interval</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>fastinter</code></strong></td><td style=text-align:center>0.5s</td><td style=text-align:center>1s</td><td style=text-align:center>1.5s</td><td style=text-align:center>2s</td><td style=text-align:left>State transition check interval</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>downinter</code></strong></td><td style=text-align:center>1s</td><td style=text-align:center>2s</td><td style=text-align:center>3s</td><td style=text-align:center>4s</td><td style=text-align:left>DOWN state check interval</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>rise</code></strong></td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:left>Consecutive successes to mark UP</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>fall</code></strong></td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:left>Consecutive failures to mark DOWN</td></tr></tbody></table><h3 id=patroni-parameters>Patroni Parameters</h3><ul><li><strong><code>ttl</code></strong>: Leader lock TTL. Primary must renew within this time, otherwise lock expires and triggers election. Directly determines passive failure detection delay.</li><li><strong><code>loop_wait</code></strong>: Patroni main loop interval. Each loop performs one health check and state sync, affects failure discovery timeliness.</li><li><strong><code>retry_timeout</code></strong>: DCS operation retry timeout. During network partition, Patroni retries continuously within this period; after timeout, primary actively demotes to prevent split-brain.</li><li><strong><code>primary_start_timeout</code></strong>: Wait time for Patroni to attempt local restart after PG crash. After timeout, releases Leader lock and triggers failover.</li><li><strong><code>safety_margin</code></strong>: Watchdog safety margin. Ensures sufficient time to trigger system restart during failures, avoiding split-brain.</li></ul><h3 id=haproxy-parameters>HAProxy Parameters</h3><ul><li><strong><code>inter</code></strong>: Health check interval in normal state, used when service status is stable.</li><li><strong><code>fastinter</code></strong>: Check interval during state transition, uses shorter interval to accelerate confirmation when state change detected.</li><li><strong><code>downinter</code></strong>: Check interval in DOWN state, uses this interval to probe recovery after service marked DOWN.</li><li><strong><code>rise</code></strong>: Consecutive successes required to mark UP. After new primary comes online, must pass <code>rise</code> consecutive checks before receiving traffic.</li><li><strong><code>fall</code></strong>: Consecutive failures required to mark DOWN. Service must fail <code>fall</code> consecutive times before being marked DOWN.</li></ul><h3 id=key-constraint>Key Constraint</h3><p><strong>Patroni core constraint</strong>: Ensures primary can complete demotion before TTL expires, preventing split-brain.</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi><mo>+</mo><mn>2</mn><mo>×</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>r</mi><mi>y</mi><mi mathvariant="normal">_</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mo>≤</mo><mi>t</mi><mi>t</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">loop\_wait + 2 \times retry\_timeout \leq ttl</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0044em;vertical-align:-.31em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord style=margin-right:.02778em>_</span><span class="mord mathnormal" style=margin-right:.02691em>w</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.9695em;vertical-align:-.31em></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.03588em>ry</span><span class=mord style=margin-right:.02778em>_</span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">eo</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≤</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6944em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span></span></span></span></span><hr><h2 id=recommendations>Recommendations</h2><p><strong>fast mode</strong> is suitable for scenarios with extremely high RTO requirements, but requires sufficiently good network quality (latency &lt; 1ms, very low packet loss).
Recommended only for same-rack or same-switch deployments, and should be thoroughly tested in production before enabling.</p><p><strong>norm mode</strong> (<strong>default</strong>) is Pigsty&rsquo;s default configuration, sufficient for the vast majority of same-datacenter deployments.
An average recovery time of 21 seconds is within acceptable range while providing a reasonable tolerance window to avoid false failovers from network jitter.</p><p><strong>safe mode</strong> is suitable for same-city cross-datacenter deployments with higher network latency or occasional jitter.
The longer tolerance window effectively prevents false failovers from network jitter, making it the recommended configuration for cross-datacenter disaster recovery.</p><p><strong>wide mode</strong> is suitable for cross-region or even cross-continent deployments with high network latency and possible public-network-level packet loss.
In such scenarios, stability is more important than recovery speed, so an extremely wide tolerance window ensures very low false failover rate.</p><table class=full-width><thead><tr><th style=text-align:left>Scenario</th><th style=text-align:left>Recommended Mode</th><th style=text-align:left>Rationale</th></tr></thead><tbody><tr><td style=text-align:left>Dev/Test environment</td><td style=text-align:left>fast</td><td style=text-align:left>Quick feedback, low impact from false failover</td></tr><tr><td style=text-align:left>Same-datacenter production</td><td style=text-align:left>norm</td><td style=text-align:left>Default choice, well-balanced</td></tr><tr><td style=text-align:left>Same-city active-active/cross-DC DR</td><td style=text-align:left>safe</td><td style=text-align:left>Tolerates network jitter, reduces false failover</td></tr><tr><td style=text-align:left>Geo-DR/cross-country deployment</td><td style=text-align:left>wide</td><td style=text-align:left>Adapts to high-latency public network, very low false failover rate</td></tr><tr><td style=text-align:left>Uncertain network quality</td><td style=text-align:left>safe</td><td style=text-align:left>Conservative choice, avoids false failover</td></tr></tbody></table><p>Typically you only need to set <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> to the mode name, and Pigsty will automatically configure Patroni and HAProxy parameters.
For backward compatibility, Pigsty still supports configuring RTO directly in seconds, but the effect is equivalent to specifying <code>norm</code> mode.</p><p>The mode configuration actually loads the corresponding parameter set from <a href=/docs/pgsql/param#pg_rto_plan><strong><code>pg_rto_plan</code></strong></a>. You can modify or override this configuration to implement custom RTO strategies.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-439a629138018b9fe8b5a1c8323745be>4.3 - Failure Model</h1><div class=lead>Detailed analysis of worst-case, best-case, and average RTO calculation logic and results across three classic failure detection/recovery paths</div><p>Patroni failures can be classified into 10 categories by failure target, and further consolidated into five categories based on detection path, which are detailed in this section.</p><table class=full-width><thead><tr><th>#</th><th>Failure Scenario</th><th>Description</th><th>Final Path</th></tr></thead><tbody><tr><td>1</td><td>PG process crash</td><td>crash, OOM killed</td><td><strong>Active Detection</strong></td></tr><tr><td>2</td><td>PG connection refused</td><td>max_connections</td><td><strong>Active Detection</strong></td></tr><tr><td>3</td><td>PG zombie</td><td>Process alive but unresponsive</td><td><strong>Active Detection</strong> (timeout)</td></tr><tr><td>4</td><td>Patroni process crash</td><td>kill -9, OOM</td><td><strong>Passive Detection</strong></td></tr><tr><td>5</td><td>Patroni zombie</td><td>Process alive but stuck</td><td><strong>Watchdog</strong></td></tr><tr><td>6</td><td>Node down</td><td>Power outage, hardware failure</td><td><strong>Passive Detection</strong></td></tr><tr><td>7</td><td>Node zombie</td><td>IO hang, CPU starvation</td><td><strong>Watchdog</strong></td></tr><tr><td>8</td><td>Primary ↔ DCS network failure</td><td>Firewall, switch failure</td><td><strong>Network Partition</strong></td></tr><tr><td>9</td><td>Storage failure</td><td>Disk failure, disk full, mount failure</td><td><strong>Active Detection</strong> or <strong>Watchdog</strong></td></tr><tr><td>10</td><td>Manual switchover</td><td>Switchover/Failover</td><td><strong>Manual Trigger</strong></td></tr></tbody></table><p>However, for RTO calculation purposes, all failures ultimately converge to two paths. This section explores the upper bound, lower bound, and average RTO for these two scenarios.</p><ul><li><a href=/docs/concept/ha/failure/passive><strong>Passive election triggered after Patroni loses contact</strong></a></li><li><a href=/docs/concept/ha/failure/active><strong>Patroni actively detects failure and triggers switchover</strong></a></li></ul><pre class=mermaid>flowchart LR
    A([Primary Failure]) --&gt; B{Patroni&lt;br/&gt;Detected?}

    B --&gt;|PG Crash| C[Attempt Local Restart]
    B --&gt;|Node Down| D[Wait TTL Expiration]

    C --&gt;|Success| E([Local Recovery])
    C --&gt;|Fail/Timeout| F[Release Leader Lock]

    D --&gt; F
    F --&gt; G[Replica Election]
    G --&gt; H[Execute Promote]
    H --&gt; I[HAProxy Detects]
    I --&gt; J([Service Restored])

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#198754,stroke:#146c43,color:#fff
    style J fill:#198754,stroke:#146c43,color:#fff</pre></div><div class=td-content style=page-break-before:always><h1 id=pg-358e309cdbb4cb46571e2cba4875ac34>4.3.1 - Model of Patroni Passive Failure</h1><div class=lead>Failover path triggered by node crash causing leader lease expiration and cluster election</div><div id=infographic-7de234be936c491ca38d917964899ac2 class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-7de234be936c491ca38d917964899ac2",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  
  desc Lease Expiration Stages
  items
    - label Lease Expiration
    - label Replica Detect
    - label Elect & Promote
    - label Haproxy Up
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-timeline>RTO Timeline</h2><div id=echarts-0f45ad1cb9c0c76384b068caaba7bbfe class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-0f45ad1cb9c0c76384b068caaba7bbfe");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["Lease Expiration","Replica Detection","Lock Contest & Promote","Health Check"],itemGap:12,top:0},series:[{barWidth:20,data:[120,110,100,"-",60,55,50,"-",30,27,25,"-",20,17,15],emphasis:{focus:"series"},itemStyle:{color:"#e15759"},name:"Lease Expire",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"Replica Detect",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"Elect & Promote",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"HAProxy Check",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[150,127,104,"-",78,66,53,"-",41,34,27,"-",29,23,16],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"Total RTO",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO Budget",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"Seconds",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=failure-model>Failure Model</h2><table class=full-width><thead><tr><th style=text-align:center>Phase</th><th style=text-align:center>Best</th><th style=text-align:center>Worst</th><th style=text-align:center>Average</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><strong>Lease Expiration</strong></td><td style=text-align:center><code>ttl - loop</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:center><code>ttl - loop/2</code></td><td style=text-align:left>Best: crash just before refresh<br>Worst: crash right after refresh</td></tr><tr><td style=text-align:center><strong>Replica Detect</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop / 2</code></td><td style=text-align:left>Best: exactly at check point<br>Worst: just missed check point</td></tr><tr><td style=text-align:center><strong>Election Promote</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>Best: direct lock and promote<br>Worst: API timeout + Promote</td></tr><tr><td style=text-align:center><strong>HAProxy Check</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>Best: state change before check<br>Worst: state change right after check</td></tr></tbody></table><p><strong>Key Difference Between Passive and Active Failover</strong>:</p><table class=full-width><thead><tr><th style=text-align:center>Scenario</th><th style=text-align:center>Patroni Status</th><th style=text-align:center>Lease Handling</th><th style=text-align:center>Primary Wait Time</th></tr></thead><tbody><tr><td style=text-align:center><strong>Active Failover</strong> (PG crash)</td><td style=text-align:center>Alive, healthy</td><td style=text-align:center>Actively tries to restart PG, releases lease on timeout</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>Passive Failover</strong> (Node crash)</td><td style=text-align:center>Dies with node</td><td style=text-align:center>Cannot actively release, must wait for TTL expiration</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>In passive failover scenarios, Patroni dies along with the node and <strong>cannot actively release the Leader Key</strong>.
The lease in DCS can only trigger cluster election after TTL naturally expires.</p><hr><h2 id=timeline-analysis>Timeline Analysis</h2><h3 id=phase-1-lease-expiration>Phase 1: Lease Expiration</h3><p>The Patroni primary refreshes the Leader Key every <code>loop_wait</code> cycle, resetting TTL to the configured value.</p><pre tabindex=0><code>Timeline:
     t-loop        t          t+ttl-loop    t+ttl
       |           |              |           |
    Last Refresh  Failure      Best Case   Worst Case
       |←── loop ──→|              |           |
       |←──────────── ttl ─────────────────────→|
</code></pre><ul><li><strong>Best case</strong>: Failure occurs just before lease refresh (elapsed <code>loop</code> since last refresh), remaining TTL = <code>ttl - loop</code></li><li><strong>Worst case</strong>: Failure occurs right after lease refresh, must wait full <code>ttl</code></li><li><strong>Average case</strong>: <code>ttl - loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mi>i</mi><mi>r</mi><mi>e</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{expire} = \begin{cases}
ttl - loop &amp; \text{Best} \\
ttl - loop/2 &amp; \text{Average} \\
ttl &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-2-replica-detection>Phase 2: Replica Detection</h3><p>Replicas wake up on <code>loop_wait</code> cycles and check the Leader Key status in DCS.</p><pre tabindex=0><code>Timeline:
    Lease Expired   Replica Wakes
       |            |
       |←── 0~loop ─→|
</code></pre><ul><li><strong>Best case</strong>: Replica happens to wake when lease expires, wait <code>0</code></li><li><strong>Worst case</strong>: Replica just entered sleep when lease expires, wait <code>loop</code></li><li><strong>Average case</strong>: <code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{Best} \\
loop/2 &amp; \text{Average} \\
loop &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-3-lock-contest--promote>Phase 3: Lock Contest & Promote</h3><p>When replicas detect Leader Key expiration, they start the election process. The replica that acquires the Leader Key executes <code>pg_ctl promote</code> to become the new primary.</p><ol><li>Via REST API, parallel queries to check each replica&rsquo;s replication position, typically 10ms, hardcoded 2s timeout.</li><li>Compare WAL positions to determine the best candidate, replicas attempt to create Leader Key (CAS atomic operation)</li><li>Execute <code>pg_ctl promote</code> to become primary (very fast, typically negligible)</li></ol><pre tabindex=0><code>Election Flow:
  ReplicaA ──→ Query replication position ──→ Compare ──→ Contest lock ──→ Success
  ReplicaB ──→ Query replication position ──→ Compare ──→ Contest lock ──→ Fail
</code></pre><ul><li><strong>Best case</strong>: Single replica or immediate lock acquisition and promotion, constant overhead <code>0.1s</code></li><li><strong>Worst case</strong>: DCS API call timeout: <code>2s</code></li><li><strong>Average case</strong>: <code>1s</code> constant overhead</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{Best} \\
1 &amp; \text{Average} \\
2 &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-4-health-check>Phase 4: Health Check</h3><p>HAProxy detects the new primary online, requiring <code>rise</code> consecutive successful health checks.</p><pre tabindex=0><code>Detection Timeline:
  New Primary    First Check   Second Check  Third Check (UP)
     |          |           |           |
     |←─ 0~inter ─→|←─ fast ─→|←─ fast ─→|
</code></pre><ul><li><strong>Best case</strong>: New primary promoted just before check, <code>(rise-1) × fastinter</code></li><li><strong>Worst case</strong>: New primary promoted right after check, <code>(rise-1) × fastinter + inter</code></li><li><strong>Average case</strong>: <code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{Best} \\
(rise-1) \times fastinter + inter/2 &amp; \text{Average} \\
(rise-1) \times fastinter + inter &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-formula>RTO Formula</h2><p>Sum all phase times to get total RTO:</p><p><strong>Best Case</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = ttl - loop + 0.1 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>Average Case</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = ttl + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>Worst Case</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = ttl + loop + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=model-calculation>Model Calculation</h2><p>Substitute the four RTO model parameters into the formulas above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Four Mode Calculation Results</strong> (unit: seconds, format: min / avg / max)</p><table class=full-width><thead><tr><th style=text-align:center>Phase</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>Lease Expiration</td><td style=text-align:center><code>15</code> / <code>17</code> / <code>20</code></td><td style=text-align:center><code>25</code> / <code>27</code> / <code>30</code></td><td style=text-align:center><code>50</code> / <code>55</code> / <code>60</code></td><td style=text-align:center><code>100</code> / <code>110</code> / <code>120</code></td></tr><tr><td style=text-align:center>Replica Detection</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>Lock Contest & Promote</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>Health Check</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>Total</strong></td><td style=text-align:center><code>16</code> / <code>23</code> / <code>29</code></td><td style=text-align:center><code>27</code> / <code>34</code> / <code>41</code></td><td style=text-align:center><code>53</code> / <code>66</code> / <code>78</code></td><td style=text-align:center><code>104</code> / <code>127</code> / <code>150</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-42b7950723c66bacccc650303281acc3>4.3.2 - Model of Patroni Active Failure</h1><div class=lead>PostgreSQL primary process crashes while Patroni stays alive and attempts restart, triggering failover after timeout</div><div id=infographic-83f086194aaa6ee6523bab9450341f7b class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-83f086194aaa6ee6523bab9450341f7b",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  desc When Patroni is healthy but PostgreSQL crashes
  items
    - label Crash Found
    - label Restart Timeout
    - label Replica Detect
    - label Elect Promote
    - label HAProxy Check
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-timeline>RTO Timeline</h2><div id=echarts-f4f61a909b7c83448b5c4f436a069fec class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-f4f61a909b7c83448b5c4f436a069fec");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["Crash Found","Restart Timeout","Replica Detection","Elect Promote","HAProxy Check"],itemGap:12,top:0},series:[{barWidth:20,data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#b07aa1"},name:"Crash Found",stack:"main",type:"bar",z:2},{data:[95,95,0,"-",45,45,0,"-",25,25,0,"-",15,15,0],emphasis:{focus:"series"},itemStyle:{color:"#f28e2c"},name:"Restart Timeout",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"Replica Detect",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"Elect Promote",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"HAProxy Check",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[145,122,4,"-",73,61,3,"-",41,35,2,"-",29,24,1],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO Total",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO Budget",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"Seconds",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=failure-model>Failure Model</h2><table class=full-width><thead><tr><th style=text-align:center>Item</th><th style=text-align:center>Best</th><th style=text-align:center>Worst</th><th style=text-align:center>Average</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><strong>Crash Found</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>Best: PG crashes right before check<br>Worst: PG crashes right after check</td></tr><tr><td style=text-align:center><strong>Restart Timeout</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>start</code></td><td style=text-align:left>Best: PG recovers instantly<br>Worst: Wait full start timeout before releasing lease</td></tr><tr><td style=text-align:center><strong>Replica Detect</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>Best: Right at check point<br>Worst: Just missed check point</td></tr><tr><td style=text-align:center><strong>Elect Promote</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>Best: Acquire lock and promote directly<br>Worst: API timeout + Promote</td></tr><tr><td style=text-align:center><strong>HAProxy Check</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>Best: State changes before check<br>Worst: State changes right after check</td></tr></tbody></table><p><strong>Key Difference Between Active and Passive Failure</strong>:</p><table class=full-width><thead><tr><th style=text-align:center>Scenario</th><th style=text-align:center>Patroni Status</th><th style=text-align:center>Lease Handling</th><th style=text-align:center>Main Wait Time</th></tr></thead><tbody><tr><td style=text-align:center><strong>Active Failure</strong> (PG crash)</td><td style=text-align:center>Alive, healthy</td><td style=text-align:center>Actively tries to restart PG, releases lease after timeout</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>Passive Failure</strong> (node down)</td><td style=text-align:center>Dies with node</td><td style=text-align:center>Cannot actively release, must wait for TTL expiry</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>In active failure scenarios, Patroni remains alive and can <strong>actively detect PG crash and attempt restart</strong>.
If restart succeeds, service self-heals; if timeout expires without recovery, Patroni <strong>actively releases the Leader Key</strong>, triggering cluster election.</p><hr><h2 id=timing-analysis>Timing Analysis</h2><h3 id=phase-1-failure-detection>Phase 1: Failure Detection</h3><p>Patroni checks PostgreSQL status every <code>loop_wait</code> cycle (via <code>pg_isready</code> or process check).</p><pre tabindex=0><code>Timeline:
    Last check      PG crash      Next check
       |              |              |
       |←── 0~loop ──→|              |
</code></pre><ul><li><strong>Best case</strong>: PG crashes right before Patroni check, detected immediately, wait <code>0</code></li><li><strong>Worst case</strong>: PG crashes right after check, wait for next cycle, wait <code>loop</code></li><li><strong>Average case</strong>: <code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{Best} \\
loop/2 &amp; \text{Average} \\
loop &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-2-restart-timeout>Phase 2: Restart Timeout</h3><p>After Patroni detects PG crash, it attempts to restart PostgreSQL. This phase has two possible outcomes:</p><pre tabindex=0><code>Timeline:
  Crash detected     Restart attempt     Success/Timeout
      |                  |                    |
      |←──── 0 ~ start ─────────────────────→|
</code></pre><p><strong>Path A: Self-healing Success</strong> (Best case)</p><ul><li>PG restarts successfully, service recovers</li><li>No failover triggered, extremely short RTO</li><li>Wait time: <code>0</code> (relative to Failover path)</li></ul><p><strong>Path B: Failover Required</strong> (Average/Worst case)</p><ul><li>PG still not recovered after <code>primary_start_timeout</code></li><li>Patroni actively releases Leader Key</li><li>Wait time: <code>start</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best (self-healing success)</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average (failover required)</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{restart} = \begin{cases}
0 &amp; \text{Best (self-healing success)} \\
start &amp; \text{Average (failover required)} \\
start &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.2806em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">res</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.02778em>r</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best (self-healing success)</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average (failover required)</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><blockquote><p><strong>Note</strong>: Average case assumes failover is required. If PG can quickly self-heal, overall RTO will be significantly lower.</p></blockquote><h3 id=phase-3-standby-detection>Phase 3: Standby Detection</h3><p>Standbys wake up on <code>loop_wait</code> cycle and check Leader Key status in DCS. When primary Patroni releases the Leader Key, standbys discover this and begin election.</p><pre tabindex=0><code>Timeline:
    Lease released    Standby wakes
       |                  |
       |←── 0~loop ──────→|
</code></pre><ul><li><strong>Best case</strong>: Standby wakes right when lease is released, wait <code>0</code></li><li><strong>Worst case</strong>: Standby just went to sleep when lease released, wait <code>loop</code></li><li><strong>Average case</strong>: <code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>b</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{standby} = \begin{cases}
0 &amp; \text{Best} \\
loop/2 &amp; \text{Average} \\
loop &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">an</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-4-lock--promote>Phase 4: Lock & Promote</h3><p>After standbys discover Leader Key vacancy, election begins. The standby that acquires the Leader Key executes <code>pg_ctl promote</code> to become the new primary.</p><ol><li>Via REST API, parallel queries to check each standby&rsquo;s replication position, typically 10ms, hardcoded 2s timeout.</li><li>Compare WAL positions to determine best candidate, standbys attempt to create Leader Key (CAS atomic operation)</li><li>Execute <code>pg_ctl promote</code> to become primary (very fast, typically negligible)</li></ol><pre tabindex=0><code>Election process:
  StandbyA ──→ Query replication position ──→ Compare ──→ Try lock ──→ Success
  StandbyB ──→ Query replication position ──→ Compare ──→ Try lock ──→ Fail
</code></pre><ul><li><strong>Best case</strong>: Single standby or direct lock acquisition and promote, constant overhead <code>0.1s</code></li><li><strong>Worst case</strong>: DCS API call timeout: <code>2s</code></li><li><strong>Average case</strong>: <code>1s</code> constant overhead</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{Best} \\
1 &amp; \text{Average} \\
2 &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-5-health-check>Phase 5: Health Check</h3><p>HAProxy detects new primary online, requires <code>rise</code> consecutive successful health checks.</p><pre tabindex=0><code>Check timeline:
  New primary    First check    Second check   Third check (UP)
     |              |               |               |
     |←─ 0~inter ──→|←─── fast ────→|←─── fast ────→|
</code></pre><ul><li><strong>Best case</strong>: New primary comes up right at check time, <code>(rise-1) × fastinter</code></li><li><strong>Worst case</strong>: New primary comes up right after check, <code>(rise-1) × fastinter + inter</code></li><li><strong>Average case</strong>: <code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{Best} \\
(rise-1) \times fastinter + inter/2 &amp; \text{Average} \\
(rise-1) \times fastinter + inter &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-formula>RTO Formula</h2><p>Sum all phase times to get total RTO:</p><p><strong>Best Case</strong> (PG instant self-healing)</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>≈</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = 0 + 0 + 0 + 0.1 + (rise-1) \times fastinter \approx (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>Average Case</strong> (Failover required)</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = loop + start + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>Worst Case</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>×</mo><mn>2</mn><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = loop \times 2 + start + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=model-calculation>Model Calculation</h2><p>Substituting the four RTO model parameters into the formulas above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Calculation Results for Four Modes</strong> (unit: seconds, format: min / avg / max)</p><table class=full-width><thead><tr><th style=text-align:center>Phase</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>Failure Detection</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>Restart Timeout</td><td style=text-align:center><code>0</code> / <code>15</code> / <code>15</code></td><td style=text-align:center><code>0</code> / <code>25</code> / <code>25</code></td><td style=text-align:center><code>0</code> / <code>45</code> / <code>45</code></td><td style=text-align:center><code>0</code> / <code>95</code> / <code>95</code></td></tr><tr><td style=text-align:center>Standby Detection</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>Lock & Promote</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>Health Check</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>Total</strong></td><td style=text-align:center><code>1</code> / <code>24</code> / <code>29</code></td><td style=text-align:center><code>2</code> / <code>35</code> / <code>41</code></td><td style=text-align:center><code>3</code> / <code>61</code> / <code>73</code></td><td style=text-align:center><code>4</code> / <code>122</code> / <code>145</code></td></tr></tbody></table><hr><h2 id=comparison-with-passive-failure>Comparison with Passive Failure</h2><table class=full-width><thead><tr><th style=text-align:center>Phase</th><th style=text-align:center>Active Failure (PG crash)</th><th style=text-align:center>Passive Failure (node down)</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center>Detection Mechanism</td><td style=text-align:center>Patroni active detection</td><td style=text-align:center>TTL passive expiry</td><td style=text-align:left>Active detection discovers failure faster</td></tr><tr><td style=text-align:center>Core Wait</td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:left>start is usually less than ttl, but requires additional failure detection time</td></tr><tr><td style=text-align:center>Lease Handling</td><td style=text-align:center>Active release</td><td style=text-align:center>Passive expiry</td><td style=text-align:left>Active release is more timely</td></tr><tr><td style=text-align:center>Self-healing Possible</td><td style=text-align:center>Yes</td><td style=text-align:center>No</td><td style=text-align:left>Active detection can attempt local recovery</td></tr></tbody></table><p><strong>RTO Comparison</strong> (Average case):</p><table class=full-width><thead><tr><th style=text-align:center>Mode</th><th style=text-align:center>Active Failure (PG crash)</th><th style=text-align:center>Passive Failure (node down)</th><th style=text-align:left>Difference</th></tr></thead><tbody><tr><td style=text-align:center>fast</td><td style=text-align:center>24s</td><td style=text-align:center>23s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>norm</td><td style=text-align:center>35s</td><td style=text-align:center>34s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>safe</td><td style=text-align:center>61s</td><td style=text-align:center>66s</td><td style=text-align:left>-5s</td></tr><tr><td style=text-align:center>wide</td><td style=text-align:center>122s</td><td style=text-align:center>127s</td><td style=text-align:left>-5s</td></tr></tbody></table><blockquote><p><strong>Analysis</strong>: In <code>fast</code> and <code>norm</code> modes, active failure RTO is slightly higher than passive failure because it waits for <code>primary_start_timeout</code> (<code>start</code>);
but in <code>safe</code> and <code>wide</code> modes, since <code>start &lt; ttl - loop</code>, active failure is actually faster.
However, active failure has the possibility of self-healing, with potentially extremely short RTO in best case scenarios.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-895a94576239d65b824c6e6ae06deb76>4.4 - Service Access</h1><div class=lead>Pigsty uses HAProxy to provide service access, with optional pgBouncer for connection pooling, and optional L2 VIP and DNS access.</div><blockquote><p>Split read and write operations, route traffic correctly, and deliver PostgreSQL cluster capabilities reliably.</p></blockquote><p><a href=#service-overview>Service</a> is an abstraction: it represents the form in which database clusters expose their capabilities externally, encapsulating underlying cluster details.</p><p>Services are crucial for <a href=#access-services>stable access</a> in production environments, showing their value during automatic failover in <a href=/docs/concept/ha>high availability</a> clusters. <a href=#personal-users>Personal users</a> typically don&rsquo;t need to worry about this concept.</p><hr><h2 id=personal-users>Personal Users</h2><p>The concept of &ldquo;service&rdquo; is for production environments. Personal users with single-node clusters can skip the complexity and directly use instance names or IP addresses to access the database.</p><p>For example, Pigsty&rsquo;s default single-node <code>pg-meta</code>.<code>meta</code> database can be connected directly using three different users:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># Connect directly with DBA superuser</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># Connect with default business admin user</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># Connect with default read-only user via instance domain name</span>
</span></span></code></pre></div><hr><h2 id=service-overview>Service Overview</h2><p>In real-world production environments, we use primary-replica database clusters based on replication. Within a cluster, one and only one instance serves as the leader (<a href=/docs/pgsql/config#primary>primary</a>) that can accept writes.
Other instances (<a href=/docs/pgsql/config#replica>replicas</a>) continuously fetch change logs from the cluster leader to stay synchronized. Replicas can also handle read-only requests, significantly offloading the primary in read-heavy, write-light scenarios.
Therefore, distinguishing write requests from read-only requests is a common practice.</p><p>Additionally, for production environments with high-frequency, short-lived connections, we pool requests through connection pool middleware (Pgbouncer) to reduce connection and backend process creation overhead. However, for scenarios like ETL and change execution, we need to bypass the connection pool and directly access the database.
Meanwhile, high-availability clusters may undergo failover during failures, causing cluster leadership changes. Therefore, high-availability database solutions require write traffic to automatically adapt to cluster leadership changes.
These varying access needs (read-write separation, pooled vs. direct connections, failover auto-adaptation) ultimately lead to the abstraction of the <strong>Service</strong> concept.</p><p>Typically, database clusters must provide this most basic service:</p><ul><li><strong>Read-write service (primary)</strong>: Can read from and write to the database</li></ul><p>For production database clusters, at least these two services should be provided:</p><ul><li><strong>Read-write service (primary)</strong>: Write data: Can only be served by the primary.</li><li><strong>Read-only service (replica)</strong>: Read data: Can be served by replicas; falls back to primary when no replicas are available</li></ul><p>Additionally, depending on specific business scenarios, there may be other services, such as:</p><ul><li><strong>Default direct service (default)</strong>: Allows (admin) users to bypass the connection pool and directly access the database</li><li><strong>Offline replica service (offline)</strong>: Dedicated replica not serving online read traffic, used for ETL and analytical queries</li><li><strong>Sync replica service (standby)</strong>: Read-only service with no replication delay, handled by <a href=/docs/pgsql/config#sync-standby>synchronous standby</a>/primary for read queries</li><li><strong>Delayed replica service (delayed)</strong>: Access data from the same cluster as it was some time ago, handled by <a href=/docs/pgsql/config#delayed-cluster>delayed replicas</a></li></ul><hr><h2 id=access-services>Access Services</h2><p>Pigsty&rsquo;s service delivery boundary stops at the cluster&rsquo;s HAProxy. Users can access these load balancers through various means.</p><p>The typical approach is to use DNS or VIP access, binding them to all or any number of load balancers in the cluster.</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>You can use different host & port combinations, which provide PostgreSQL service in different ways.</p><p><strong>Host</strong></p><table><thead><tr><th>Type</th><th>Sample</th><th>Description</th></tr></thead><tbody><tr><td>Cluster Domain Name</td><td><code>pg-test</code></td><td>Access via cluster domain name (resolved by dnsmasq @ infra nodes)</td></tr><tr><td>Cluster VIP Address</td><td><code>10.10.10.3</code></td><td>Access via L2 VIP address managed by <code>vip-manager</code>, bound to primary node</td></tr><tr><td>Instance Hostname</td><td><code>pg-test-1</code></td><td>Access via any instance hostname (resolved by dnsmasq @ infra nodes)</td></tr><tr><td>Instance IP Address</td><td><code>10.10.10.11</code></td><td>Access any instance&rsquo;s IP address</td></tr></tbody></table><p><strong>Port</strong></p><p>Pigsty uses different <strong>ports</strong> to distinguish <a href=#service-overview>pg services</a></p><table><thead><tr><th>Port</th><th>Service</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>Database</td><td>Direct access to postgres server</td></tr><tr><td>6432</td><td>pgbouncer</td><td>Middleware</td><td>Access postgres through connection pool middleware</td></tr><tr><td>5433</td><td>primary</td><td>Service</td><td>Access primary pgbouncer (or postgres)</td></tr><tr><td>5434</td><td>replica</td><td>Service</td><td>Access replica pgbouncer (or postgres)</td></tr><tr><td>5436</td><td>default</td><td>Service</td><td>Access primary postgres</td></tr><tr><td>5438</td><td>offline</td><td>Service</td><td>Access offline postgres</td></tr></tbody></table><p><strong>Combinations</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Access via cluster domain</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; primary direct connection</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; primary connection pool -&gt; primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; primary connection pool -&gt; primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; replica connection pool -&gt; replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; primary direct connection (for admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; offline direct connection (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Access via cluster VIP directly</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; primary direct access</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; primary connection pool -&gt; primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; primary connection pool -&gt; primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; replica connection pool -&gt; replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; primary direct connection (for admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; offline direct connection (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Directly specify any cluster instance name</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; database instance direct connection (singleton access)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; connection pool -&gt; database</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; connection pool -&gt; database read/write</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; connection pool -&gt; database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; database direct connection</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; database offline read/write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Directly specify any cluster instance IP access</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># Database instance direct connection (directly specify instance, no automatic traffic distribution)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># Connection pool -&gt; database</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; connection pool -&gt; database read/write</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; connection pool -&gt; database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; database direct connection</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; database offline read-write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Smart client: read/write separation via URL</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-397dc822a55434d21cd8ee3a6f846291>5 - Point-in-Time Recovery</h1><div class=lead>Pigsty uses pgBackRest to implement PostgreSQL point-in-time recovery, allowing users to roll back to any point in time within the backup policy window.</div><hr><h2 id=overview>Overview</h2><blockquote><p>You can restore and roll back your cluster to any point in the past, avoiding data loss caused by software defects and human errors.</p></blockquote><p>Pigsty&rsquo;s PostgreSQL clusters come with auto-configured Point-in-Time Recovery (PITR) capability, powered by the backup component <a href=https://pgbackrest.org/><strong>pgBackRest</strong></a> and optional object storage repository <a href=https://min.io/><strong>MinIO</strong></a>.</p><p><a href=/docs/concept/ha><strong>High availability solutions</strong></a> can address hardware failures but are powerless against data deletion/overwriting/database drops caused by software defects and human errors.
For such situations, Pigsty provides out-of-the-box <strong>Point-in-Time Recovery</strong> (PITR) capability, enabled by default without additional configuration.</p><p>Pigsty provides default configurations for base backups and WAL archiving. You can use local directories and disks, or dedicated MinIO clusters or S3 object storage services to store backups and achieve geo-redundant disaster recovery.
When using local disks, the default capability to recover to any point within the past day is retained. When using MinIO or S3, the default capability to recover to any point within the past week is retained.
As long as storage space permits, you can retain any arbitrarily long recoverable time window, as your budget allows.</p><hr><p><strong>What problems does PITR solve?</strong></p><ul><li>Enhanced disaster recovery: <strong>RPO</strong> drops from ∞ to tens of MB, <strong>RTO</strong> drops from ∞ to hours/minutes.</li><li>Ensures data security: <strong>Data integrity</strong> in C/I/A: avoids data consistency issues caused by accidental deletion.</li><li>Ensures data security: <strong>Data availability</strong> in C/I/A: provides fallback for &ldquo;permanently unavailable&rdquo; disaster scenarios</li></ul><table><thead><tr><th>Standalone Configuration Strategy</th><th style=text-align:center>Event</th><th>RTO</th><th style=text-align:left>RPO</th></tr></thead><tbody><tr><td><i class="fa-solid fa-music text-danger"></i> Nothing</td><td style=text-align:center>Crash</td><td><i class="fas fa-circle-xmark text-danger"></i> <strong>Permanently lost</strong></td><td style=text-align:left><i class="fas fa-circle-xmark text-danger"></i> <strong>All lost</strong></td></tr><tr><td><i class="fa-solid fa-copy text-secondary"></i> Base Backup</td><td style=text-align:center>Crash</td><td><i class="fa-solid fa-triangle-exclamation text-secondary"></i> Depends on backup size and bandwidth (hours)</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-secondary"></i> Lose data since last backup (hours to days)</td></tr><tr><td><i class="fa-solid fa-copy text-primary"></i> Base Backup + <i class="fa-solid fa-clock-rotate-left text-primary"></i> WAL Archive</td><td style=text-align:center>Crash</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> Depends on backup size and bandwidth (hours)</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-primary"></i> Lose unarchived data (tens of MB)</td></tr></tbody></table><p><strong>What are the costs of PITR?</strong></p><ul><li>Reduces C in data security: <strong>Confidentiality</strong>, creates additional leak points, requires additional backup protection.</li><li>Extra resource consumption: Local storage or network traffic/bandwidth overhead, usually not a concern.</li><li>Increased complexity: Users need to pay backup management costs.</li></ul><p><strong>Limitations of PITR</strong></p><p>If only PITR is used for failure recovery, RTO and RPO metrics are inferior compared to <a href=/docs/concept/ha/><strong>high availability solutions</strong></a>, and typically both should be used together.</p><ul><li><strong>RTO</strong>: With only standalone + PITR, recovery time depends on backup size and network/disk bandwidth, ranging from tens of minutes to hours or days.</li><li><strong>RPO</strong>: With only standalone + PITR, some data may be lost during crashes - one or several WAL segment files may not yet be archived, losing 16 MB to tens of MB of data.</li></ul><p>Besides <a href=/docs/pgsql/backup><strong>PITR</strong></a>, you can also use <a href=/docs/pgsql/config#delayed-cluster><strong>delayed clusters</strong></a> in Pigsty to address data deletion/modification caused by human errors or software defects.</p><hr><h2 id=how-it-works>How It Works</h2><p>Point-in-time recovery allows you to restore and roll back your cluster to &ldquo;any point&rdquo; in the past, avoiding data loss caused by software defects and human errors. To achieve this, two preparations are needed: <a href=#base-backup><strong>Base Backup</strong></a> and <a href=#wal-archiving><strong>WAL Archiving</strong></a>.
Having a <strong>base backup</strong> allows users to restore the database to its state at backup time, while having <strong>WAL archives</strong> starting from a base backup allows users to restore the database to any point after the base backup time.</p><p><img src=/img/blog/kernel/fig-10-02.png alt=fig-10-02.png></p><p>For specific operations, refer to <a href=/docs/pgsql/backup><strong>PGSQL Admin: Backup and Recovery</strong></a>.</p><h3 id=base-backup>Base Backup</h3><p>Pigsty uses pgBackRest to manage PostgreSQL backups. pgBackRest initializes empty repositories on all cluster instances but only actually uses the repository on the cluster primary.</p><p>pgBackRest supports three backup modes: <strong>full backup</strong>, <strong>incremental backup</strong>, and differential backup, with the first two being most commonly used.
Full backup takes a complete physical snapshot of the database cluster at the current moment; incremental backup records the differences between the current database cluster and the previous full backup.</p><p>Pigsty provides a wrapper command for backups: <code>/pg/bin/pg-backup [full|incr]</code>. You can schedule regular base backups as needed through Crontab or any other task scheduling system.</p><h3 id=wal-archiving>WAL Archiving</h3><p>Pigsty enables WAL archiving on the cluster primary by default and uses the <code>pgbackrest</code> command-line tool to continuously push WAL segment files to the backup repository.</p><p>pgBackRest automatically manages required WAL files and timely cleans up expired backups and their corresponding WAL archive files based on the backup retention policy.</p><p>If you don&rsquo;t need PITR functionality, you can disable WAL archiving by <a href=/docs/pgsql/admin#configure-cluster><strong>configuring the cluster</strong></a>: <code>archive_mode: off</code> and remove <a href=/docs/node/param#node_crontab><code>node_crontab</code></a> to stop scheduled backup tasks.</p><hr><h2 id=implementation>Implementation</h2><p>By default, Pigsty provides two preset <a href=/docs/pgsql/backup#backup-strategy>backup strategies</a>: The default uses local filesystem backup repository, performing one full backup daily to ensure users can roll back to any point within the past day. The alternative strategy uses dedicated MinIO clusters or S3 storage for backups, with weekly full backups, daily incremental backups, and two weeks of backup and WAL archive retention by default.</p><p>Pigsty uses pgBackRest to manage backups, receive WAL archives, and perform PITR. Backup repositories can be flexibly configured (<a href=/docs/pgsql/param#pgbackrest_repo><code>pgbackrest_repo</code></a>): defaults to primary&rsquo;s local filesystem (<code>local</code>), but can also use other disk paths, or the included optional <a href=/docs/minio>MinIO</a> service (<code>minio</code>) and cloud S3 services.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># enable pgBackRest on pgsql host?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_clean</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># remove pg backup data during init?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/pgbackrest</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest log dir, `/pg/log/pgbackrest` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method: local          # pgbackrest repo method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local, minio, [user-defined...]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># default pgbackrest repo with local posix fs</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># local backup directory, `/pg/backup` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># retention full backup by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># keep at most 3 full backup, at least 2, when using local fs repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># optional minio repo for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio is s3-compatible, so use s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio endpoint domain name, `sss.pigsty` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio region, us-east-1 by default, not used for minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio bucket name, `pgsql` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user access key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user secret key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use path style uri for minio rather than host style</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio backup path, `/pgbackrest` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio port, 9000 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio ca file path, `/etc/pki/ca.crt` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># bundle small files into a single file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># enable AES encryption for remote backup repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, default is &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># retention full backup by time on minio repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># keep full backup for last 14 days</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># You can also add other optional backup repos, such as S3, for geo-redundant disaster recovery</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty parameter <a href=/docs/pgsql/param#pgbackrest_repo><code>pgbackrest_repo</code></a> target repositories are converted to repository definitions in the <code>/etc/pgbackrest/pgbackrest.conf</code> configuration file.
For example, if you define a US West S3 repository for storing cold backups, you can use the following reference configuration.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>s3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ------&gt; /etc/pgbackrest/pgbackrest.conf</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-type=s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-west-1                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-region=us-west-1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3-us-west-1.amazonaws.com   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-endpoint=s3-us-west-1.amazonaws.com</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&lt;your_access_key&gt;&#39;</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-key=&lt;your_access_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-key-secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&lt;your_secret_key&gt;&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-key-secret=&lt;your_secret_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql                          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-bucket=pgsql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-uri-style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>host                        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-uri-style=host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest                         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-path=/pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                                  </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-bundle=y</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-cipher-type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-cipher-type=aes-256-cbc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-cipher-pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-cipher-pass=pgBackRest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-retention-full-type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-retention-full-type=time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-retention-full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-retention-full=90</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=recovery>Recovery</h2><p>You can directly use the following wrapper commands for PostgreSQL database cluster <a href=https://pgbackrest.org/command.html#command-restore>point-in-time recovery</a>.</p><p>Pigsty uses incremental differential parallel recovery by default, allowing you to recover to a specified point in time at maximum speed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr                                 <span style=color:#8f5902;font-style:italic># Restore to the end of WAL archive stream (e.g., for entire datacenter failure)</span>
</span></span><span style=display:flex><span>pg-pitr -i                              <span style=color:#8f5902;font-style:italic># Restore to the most recent backup completion time (rarely used)</span>
</span></span><span style=display:flex><span>pg-pitr --time<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2022-12-30 14:44:44+08&#34;</span> <span style=color:#8f5902;font-style:italic># Restore to a specified point in time (for database or table drops)</span>
</span></span><span style=display:flex><span>pg-pitr --name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;my-restore-point&#34;</span>       <span style=color:#8f5902;font-style:italic># Restore to a named restore point created with pg_create_restore_point</span>
</span></span><span style=display:flex><span>pg-pitr --lsn<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span> -X            <span style=color:#8f5902;font-style:italic># Restore to immediately before the LSN</span>
</span></span><span style=display:flex><span>pg-pitr --xid<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1234567&#34;</span> -X -P           <span style=color:#8f5902;font-style:italic># Restore to immediately before the specified transaction ID, then promote cluster to primary</span>
</span></span><span style=display:flex><span>pg-pitr --backup<span style=color:#ce5c00;font-weight:700>=</span>latest                 <span style=color:#8f5902;font-style:italic># Restore to the latest backup set</span>
</span></span><span style=display:flex><span>pg-pitr --backup<span style=color:#ce5c00;font-weight:700>=</span>20221108-105325        <span style=color:#8f5902;font-style:italic># Restore to a specific backup set, backup sets can be listed with pgbackrest info</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg-pitr                                 <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta restore</span>
</span></span><span style=display:flex><span>pg-pitr -i                              <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=immediate restore</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2022-12-30 14:44:44+08&#34;</span>     <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=time --target=&#34;2022-12-30 14:44:44+08&#34; restore</span>
</span></span><span style=display:flex><span>pg-pitr -n <span style=color:#4e9a06>&#34;my-restore-point&#34;</span>           <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=name --target=my-restore-point restore</span>
</span></span><span style=display:flex><span>pg-pitr -b 20221108-105325F             <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=name --set=20221230-120101F restore</span>
</span></span><span style=display:flex><span>pg-pitr -l <span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span> -X               <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=lsn --target=&#34;0/7C82CB8&#34; --target-exclusive restore</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>1234567</span> -X -P                <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=xid --target=&#34;0/7C82CB8&#34; --target-exclusive --target-action=promote restore</span>
</span></span></code></pre></div><p>When performing PITR, you can use Pigsty&rsquo;s monitoring system to observe the cluster LSN position status and determine whether recovery to the specified point in time, transaction point, LSN position, or other point was successful.</p><p><img src=/img/docs/concept/pitr.png alt=pitr></p><br><hr><br></div><div class=td-content style=page-break-before:always><h1 id=pg-640213fc983ef0aae5180ea5bbbfb2d3>6 - Monitoring System</h1><div class=lead>How Pigsty&rsquo;s monitoring system is architected and how monitored targets are automatically managed.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-7ed29cc39a1f06050bef0386106a93cc>7 - Security and Compliance</h1><div class=lead>Authentication, access control, encrypted communication, audit logs—meeting SOC2 compliance requirements.</div><h3 id=pigstys-security-philosophy>Pigsty&rsquo;s Security Philosophy</h3><p><strong>Secure by Default</strong>: Out-of-the-box security configuration—basic protection without additional setup.</p><p><strong>Progressive Configuration</strong>: Enterprise users can gradually enhance security measures through configuration.</p><p><strong>Defense in Depth</strong>: Multiple security layers—even if one layer is breached, others remain protective.</p><p><strong>Least Privilege</strong>: Grant users only the minimum permissions needed to complete tasks, reducing risk.</p><hr><h2 id=default-security-configuration>Default Security Configuration</h2><p>Pigsty enables these security features by default:</p><table><thead><tr><th style=text-align:left>Feature</th><th style=text-align:left>Default Config</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><strong>Password Encryption</strong></td><td style=text-align:left><code>scram-sha-256</code></td><td style=text-align:left>PostgreSQL&rsquo;s most secure password hash algorithm</td></tr><tr><td style=text-align:left><strong>SSL Support</strong></td><td style=text-align:left>Enabled</td><td style=text-align:left>Clients can optionally use SSL encrypted connections</td></tr><tr><td style=text-align:left><strong>Local CA</strong></td><td style=text-align:left>Auto-generated</td><td style=text-align:left>Self-signed CA issues server certificates</td></tr><tr><td style=text-align:left><strong>HBA Layering</strong></td><td style=text-align:left>Source-based control</td><td style=text-align:left>Different auth strength for different sources</td></tr><tr><td style=text-align:left><strong>Role System</strong></td><td style=text-align:left>Four-tier permissions</td><td style=text-align:left>Read-only/Read-write/Admin/Offline</td></tr><tr><td style=text-align:left><strong>Data Checksums</strong></td><td style=text-align:left>Enabled</td><td style=text-align:left>Detects storage-layer data corruption</td></tr><tr><td style=text-align:left><strong>Audit Logs</strong></td><td style=text-align:left>Enabled</td><td style=text-align:left>Records connections and slow queries</td></tr></tbody></table><h3 id=enhanced-configuration>Enhanced Configuration</h3><p>Additional configuration enables higher security levels:</p><table><thead><tr><th style=text-align:left>Feature</th><th style=text-align:left>Configuration Method</th><th style=text-align:left>Security Level</th></tr></thead><tbody><tr><td style=text-align:left>Password strength check</td><td style=text-align:left>Enable <code>passwordcheck</code> extension</td><td style=text-align:left>Enterprise</td></tr><tr><td style=text-align:left>Enforce SSL</td><td style=text-align:left>HBA uses <code>hostssl</code></td><td style=text-align:left>Enterprise</td></tr><tr><td style=text-align:left>Client certificates</td><td style=text-align:left>HBA uses <code>cert</code> auth</td><td style=text-align:left>Financial-grade</td></tr><tr><td style=text-align:left>Backup encryption</td><td style=text-align:left>Configure <code>cipher_type</code></td><td style=text-align:left>Compliance</td></tr><tr><td style=text-align:left>Firewall</td><td style=text-align:left>Configure <code>node_firewall_mode</code></td><td style=text-align:left>Infrastructure</td></tr></tbody></table><p>If you only have one minute, remember this diagram:</p><pre class=mermaid>flowchart TB
    subgraph L1[&#34;Layer 1: Network Security&#34;]
        L1A[&#34;Firewall &#43; SSL/TLS Encryption &#43; HAProxy Proxy&#34;]
        L1B[&#34;Who can connect? Is the connection encrypted?&#34;]
    end

    subgraph L2[&#34;Layer 2: Authentication&#34;]
        L2A[&#34;HBA Rules &#43; SCRAM-SHA-256 Passwords &#43; Certificate Auth&#34;]
        L2B[&#34;Who are you? How do you prove it?&#34;]
    end

    subgraph L3[&#34;Layer 3: Access Control&#34;]
        L3A[&#34;Role System &#43; Object Permissions &#43; Database Isolation&#34;]
        L3B[&#34;What can you do? What data can you access?&#34;]
    end

    subgraph L4[&#34;Layer 4: Data Security&#34;]
        L4A[&#34;Data Checksums &#43; Backup Encryption &#43; Audit Logs&#34;]
        L4B[&#34;Is data intact? Are operations logged?&#34;]
    end

    L1 --&gt; L2 --&gt; L3 --&gt; L4</pre><p><strong>Core Value</strong>: Enterprise-grade security configuration out of the box, best practices enabled by default, additional configuration achieves SOC 2 compliance.</p><hr><h2 id=contents>Contents</h2><table><thead><tr><th style=text-align:left>Section</th><th style=text-align:left>Description</th><th style=text-align:left>Core Question</th></tr></thead><tbody><tr><td style=text-align:left><strong>Security Overview</strong></td><td style=text-align:left>Security capability overview and checklist</td><td style=text-align:left>What&rsquo;s the overall security architecture?</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/config/hba><strong>Authentication</strong></a></td><td style=text-align:left>HBA rules, password policies, certificate auth</td><td style=text-align:left>How to verify user identity?</td></tr><tr><td style=text-align:left><a href=ac/><strong>Access Control</strong></a></td><td style=text-align:left>Role system, permission model, database isolation</td><td style=text-align:left>How to control user permissions?</td></tr><tr><td style=text-align:left><a href=ca/><strong>Encrypted Communication</strong></a></td><td style=text-align:left>SSL/TLS, local CA, certificate management</td><td style=text-align:left>How to protect data in transit?</td></tr><tr><td style=text-align:left><strong>Compliance Checklist</strong></td><td style=text-align:left>Detailed SOC2 mapping</td><td style=text-align:left>How to meet compliance requirements?</td></tr></tbody></table><hr><h2 id=why-security-matters>Why Security Matters</h2><h3 id=the-cost-of-data-breaches>The Cost of Data Breaches</h3><pre class=mermaid>flowchart LR
    Breach[&#34;Data Breach&#34;]

    subgraph Direct[&#34;Direct Losses&#34;]
        D1[&#34;Regulatory Fines&lt;br/&gt;GDPR up to 4% global revenue&#34;]
        D2[&#34;Legal Costs&#34;]
        D3[&#34;Customer Compensation&#34;]
    end

    subgraph Indirect[&#34;Indirect Losses&#34;]
        I1[&#34;Brand Reputation Damage&#34;]
        I2[&#34;Customer Trust Loss&#34;]
        I3[&#34;Business Disruption&#34;]
    end

    subgraph Compliance[&#34;Compliance Risk&#34;]
        C1[&#34;Liability&#34;]
        C2[&#34;SOC 2: Certification Revocation&#34;]
        C3[&#34;Industry Access: Banned from Operating&#34;]
    end

    Breach --&gt; Direct
    Breach --&gt; Indirect
    Breach --&gt; Compliance</pre><hr><h2 id=default-users-and-passwords>Default Users and Passwords</h2><p>Pigsty creates these system users by default:</p><table><thead><tr><th style=text-align:left>User</th><th style=text-align:left>Purpose</th><th style=text-align:left>Default Password</th><th style=text-align:left>Post-Deploy Action</th></tr></thead><tbody><tr><td style=text-align:left><code>postgres</code></td><td style=text-align:left>System superuser</td><td style=text-align:left>No password (local only)</td><td style=text-align:left>Keep passwordless</td></tr><tr><td style=text-align:left><code>dbuser_dba</code></td><td style=text-align:left>Admin user</td><td style=text-align:left><code>DBUser.DBA</code></td><td style=text-align:left><strong>Must change</strong></td></tr><tr><td style=text-align:left><code>dbuser_monitor</code></td><td style=text-align:left>Monitor user</td><td style=text-align:left><code>DBUser.Monitor</code></td><td style=text-align:left><strong>Must change</strong></td></tr><tr><td style=text-align:left><code>replicator</code></td><td style=text-align:left>Replication user</td><td style=text-align:left><code>DBUser.Replicator</code></td><td style=text-align:left><strong>Must change</strong></td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pigsty.yml - Change default passwords</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;YourSecurePassword123!&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;AnotherSecurePass456!&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;ReplicationPass789!&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Important</strong>: After production deployment, <strong>immediately</strong> change these default passwords!</p><hr><h2 id=role-and-permission-system>Role and Permission System</h2><p>Pigsty provides a four-tier role system out of the box:</p><pre class=mermaid>flowchart TB
    subgraph Admin[&#34;dbrole_admin (Admin)&#34;]
        A1[&#34;Inherits dbrole_readwrite&#34;]
        A2[&#34;Can CREATE/DROP/ALTER objects (DDL)&#34;]
        A3[&#34;For: Business admins, apps needing table creation&#34;]
    end

    subgraph RW[&#34;dbrole_readwrite (Read-Write)&#34;]
        RW1[&#34;Inherits dbrole_readonly&#34;]
        RW2[&#34;Can INSERT/UPDATE/DELETE&#34;]
        RW3[&#34;For: Production business accounts&#34;]
    end

    subgraph RO[&#34;dbrole_readonly (Read-Only)&#34;]
        RO1[&#34;Can SELECT all tables&#34;]
        RO2[&#34;For: Reporting, data analysis&#34;]
    end

    subgraph Offline[&#34;dbrole_offline (Offline)&#34;]
        OFF1[&#34;Can only access offline instances&#34;]
        OFF2[&#34;For: ETL, personal analysis, slow queries&#34;]
    end

    Admin --&gt; |inherits| RW
    RW --&gt; |inherits| RO</pre><h3 id=creating-business-users>Creating Business Users</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Read-only user - for reporting</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_report</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ReportUser123</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Read-write user - for production</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>AppUser456</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Admin user - for DDL operations</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>AdminUser789</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=hba-access-control>HBA Access Control</h2><p>HBA (Host-Based Authentication) controls &ldquo;who can connect from where&rdquo;:</p><pre class=mermaid>flowchart LR
    subgraph Sources[&#34;Connection Sources&#34;]
        S1[&#34;Local Socket&#34;]
        S2[&#34;localhost&#34;]
        S3[&#34;Intranet CIDR&#34;]
        S4[&#34;Admin Nodes&#34;]
        S5[&#34;External&#34;]
    end

    subgraph Auth[&#34;Auth Methods&#34;]
        A1[&#34;ident/peer&lt;br/&gt;OS user mapping, most secure&#34;]
        A2[&#34;scram-sha-256&lt;br/&gt;Password auth&#34;]
        A3[&#34;scram-sha-256 &#43; SSL&lt;br/&gt;Enforce SSL&#34;]
    end

    S1 --&gt; A1
    S2 --&gt; A2
    S3 --&gt; A2
    S4 --&gt; A3
    S5 --&gt; A3

    Note[&#34;Rules matched in order&lt;br/&gt;First matching rule applies&#34;]</pre><h3 id=custom-hba-rules>Custom HBA Rules</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Allow app servers from intranet</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_app, db: mydb, addr: &#39;10.10.10.0/24&#39;, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>scram-sha-256}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Force SSL for certain users</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: admin, db: all, addr: world, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Require certificate auth (highest security)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: secure_user, db: all, addr: world, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cert}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=encrypted-communication>Encrypted Communication</h2><h3 id=ssltls-architecture>SSL/TLS Architecture</h3><pre class=mermaid>sequenceDiagram
    participant Client as Client
    participant Server as PostgreSQL

    Client-&gt;&gt;Server: 1. ClientHello
    Server-&gt;&gt;Client: 2. ServerHello
    Server-&gt;&gt;Client: 3. Server Certificate
    Client-&gt;&gt;Server: 4. Client Key
    Client-&gt;&gt;Server: 5. Encrypted Channel Established
    Server-&gt;&gt;Client: 5. Encrypted Channel Established

    rect rgb(200, 255, 200)
        Note over Client,Server: Encrypted Data Transfer
        Client-&gt;&gt;Server: 6. Application Data (encrypted)
        Server-&gt;&gt;Client: 6. Application Data (encrypted)
    end

    Note over Client,Server: Prevents eavesdropping, tampering, verifies server identity</pre><h3 id=local-ca>Local CA</h3><p>Pigsty automatically generates a local CA and issues certificates:</p><pre tabindex=0><code>/etc/pki/
├── ca.crt              # CA certificate (public)
├── ca.key              # CA private key (keep secret!)
└── server.crt/key      # Server certificate/key
</code></pre><p><strong>Important</strong>: Securely back up <code>ca.key</code>—if lost, all certificates must be reissued!</p><hr><h2 id=compliance-mapping>Compliance Mapping</h2><h3 id=soc-2-type-ii>SOC 2 Type II</h3><table><thead><tr><th style=text-align:left>Control Point</th><th style=text-align:center>Pigsty Support</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>CC6.1 Logical Access Control</td><td style=text-align:center>Yes</td><td style=text-align:left>HBA + Role System</td></tr><tr><td style=text-align:left>CC6.6 Transmission Encryption</td><td style=text-align:center>Yes</td><td style=text-align:left>SSL/TLS</td></tr><tr><td style=text-align:left>CC7.2 System Monitoring</td><td style=text-align:center>Yes</td><td style=text-align:left>Prometheus + Grafana</td></tr><tr><td style=text-align:left>CC9.1 Business Continuity</td><td style=text-align:center>Yes</td><td style=text-align:left>HA + PITR</td></tr><tr><td style=text-align:left>A1.2 Data Recovery</td><td style=text-align:center>Yes</td><td style=text-align:left>pgBackRest Backup</td></tr></tbody></table><p><strong>Legend</strong>: Yes = Default satisfaction · Partial = Needs additional config</p><hr><h2 id=security-checklist>Security Checklist</h2><h3 id=before-deployment>Before Deployment</h3><ul><li><input disabled type=checkbox> Prepare strong passwords (use password manager)</li><li><input disabled type=checkbox> Plan network partitions (intranet/external CIDRs)</li><li><input disabled type=checkbox> Decide SSL strategy (self-signed/external CA)</li></ul><h3 id=after-deployment-required>After Deployment (Required)</h3><ul><li><input disabled type=checkbox> <strong>Change all default passwords</strong></li><li><input disabled type=checkbox> Verify HBA rules match expectations</li><li><input disabled type=checkbox> Test SSL connections work</li><li><input disabled type=checkbox> Configure auth failure alerts</li><li><input disabled type=checkbox> Securely back up CA private key</li></ul><h3 id=regular-maintenance>Regular Maintenance</h3><ul><li><input disabled type=checkbox> Audit user permissions</li><li><input disabled type=checkbox> Check for expired accounts</li><li><input disabled type=checkbox> Update certificates (if needed)</li><li><input disabled type=checkbox> Review audit logs</li></ul><hr><h2 id=quick-config-examples>Quick Config Examples</h2><h3 id=production-security-configuration>Production Security Configuration</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pigsty.yml - Production security config example</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Change default passwords (required!)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;SecureDBAPassword2024!&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;SecureMonitorPass2024!&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;SecureReplPass2024!&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Enable password strength check</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Custom HBA rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># App servers</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: app, db: appdb, addr: &#39;10.10.10.0/24&#39;, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>scram-sha-256}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Admin enforce SSL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_dba, db: all, addr: world, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=financial-grade-security-configuration>Financial-Grade Security Configuration</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Financial-grade config - enable certificate auth</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Trading system uses certificate auth</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: trade_user, db: trade, addr: world, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cert}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Other systems use SSL + password</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: all, db: all, addr: world, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Enable backup encryption</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;YourBackupEncryptionKey&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=next-steps>Next Steps</h2><p>Deep dive into security configuration details:</p><ul><li><strong>Security Overview</strong>: Overall security architecture and checklist</li><li><a href=/docs/pgsql/config/hba><strong>Authentication</strong></a>: HBA rules and password policies</li><li><a href=ac/><strong>Access Control</strong></a>: Role system and permission model</li><li><a href=ca/><strong>Encrypted Communication</strong></a>: SSL/TLS and certificate management</li><li><strong>Compliance Checklist</strong>: Detailed SOC2 mapping</li></ul><p>Related topics:</p><ul><li><a href=/docs/concept/ha/><strong>High Availability</strong></a>: Business continuity assurance</li><li><a href=/docs/concept/pitr/><strong>Backup & Recovery</strong></a>: Data recovery capabilities</li><li><a href=/docs/concept/monitor><strong>Observability</strong></a>: Security event monitoring</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8b790153f8312a89aef83b802d30c481>7.1 - Local CA</h1><div class=lead>Pigsty includes a self-signed CA PKI infrastructure for issuing SSL certificates and encrypting network traffic.</div><p>Pigsty enables security best practices by default: using SSL to encrypt network traffic and HTTPS for web interfaces.</p><p>To achieve this, Pigsty includes a local self-signed CA for issuing SSL certificates and encrypting network communications.</p><p>By default, SSL and HTTPS are enabled but not enforced. For environments with higher security requirements, you can enforce SSL and HTTPS usage.</p><hr><h2 id=local-ca>Local CA</h2><p>During initialization, Pigsty generates a self-signed CA in the Pigsty source directory (<code>~/pigsty</code>) on the <a href=/docs/node/#admin-node>ADMIN node</a>. This CA can be used for SSL, HTTPS, digital signatures, issuing database client certificates, and advanced security features.</p><p>Each Pigsty deployment uses a unique CA—CAs from different Pigsty deployments are not mutually trusted.</p><p>The local CA consists of two files, located in the <code>files/pki/ca</code> directory by default:</p><ul><li><code>ca.crt</code>: Self-signed CA root certificate, distributed to all managed nodes for certificate verification.</li><li><code>ca.key</code>: CA private key for issuing certificates and verifying CA identity—<strong>keep this file secure and prevent leakage!</strong></li></ul><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>Protect the CA Private Key</div><p>Keep the CA private key file safe—don&rsquo;t lose it or leak it. We recommend encrypting and backing up this file after completing Pigsty installation.</p></div><hr><h2 id=using-an-existing-ca>Using an Existing CA</h2><p>If you already have your own CA PKI infrastructure, Pigsty can be configured to use your existing CA.</p><p>Simply place your CA public key and private key files in the <code>files/pki/ca</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>files/pki/ca/ca.key     <span style=color:#8f5902;font-style:italic># Core CA private key file, must exist; if missing, a new one is randomly generated</span>
</span></span><span style=display:flex><span>files/pki/ca/ca.crt     <span style=color:#8f5902;font-style:italic># If certificate file is missing, Pigsty auto-generates a new root certificate from the CA private key</span>
</span></span></code></pre></div><p>When Pigsty executes the <a href=/docs/infra/#installyml><strong><code>deploy.yml</code></strong></a> or <a href=/docs/infra/#infrayml><strong><code>infra.yml</code></strong></a> playbooks, if a <code>ca.key</code> private key file exists in <code>files/pki/ca</code>, the existing CA will be used. Since <code>ca.crt</code> can be generated from the <code>ca.key</code> private key, Pigsty will automatically regenerate the root certificate file if it&rsquo;s missing.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Note When Using Existing CA</div><p>You can set the <a href=/docs/infra/param#ca_method><strong><code>ca_method</code></strong></a> parameter to <code>copy</code> to ensure Pigsty errors out and stops if it can&rsquo;t find a local CA, rather than auto-generating a new self-signed CA.</p></div><hr><h2 id=trusting-the-ca>Trusting the CA</h2><p>During Pigsty installation, <code>ca.crt</code> is distributed to all nodes at <code>/etc/pki/ca.crt</code> during the <code>node_ca</code> task in the <a href=/docs/node/#nodeyml><strong><code>node.yml</code></strong></a> playbook.</p><p>EL-family and Debian-family operating systems have different default trusted CA certificate paths, so the distribution path and update methods differ:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
Trust CA Certificate</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
Debian / Ubuntu</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash><span style=display:flex><span>rm -rf /etc/pki/ca-trust/source/anchors/ca.crt
</span></span><span style=display:flex><span>ln -s /etc/pki/ca.crt /etc/pki/ca-trust/source/anchors/ca.crt
</span></span><span style=display:flex><span>/bin/update-ca-trust</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash><span style=display:flex><span>rm -rf /usr/local/share/ca-certificates/ca.crt
</span></span><span style=display:flex><span>ln -s /etc/pki/ca.crt /usr/local/share/ca-certificates/ca.crt
</span></span><span style=display:flex><span>/usr/sbin/update-ca-certificates</span></span></code></pre></div></div></div><p>Pigsty issues HTTPS certificates for domain names used by web systems on infrastructure nodes by default, allowing HTTPS access to Pigsty&rsquo;s web interfaces.</p><p>If you want to avoid &ldquo;untrusted CA certificate&rdquo; warnings in client browsers, distribute <code>ca.crt</code> to the trusted certificate directory on client machines.</p><p>You can double-click the <code>ca.crt</code> file to add it to your system keychain. For example, on MacOS, open &ldquo;Keychain Access,&rdquo; search for <code>pigsty-ca</code>, and set it to &ldquo;trust&rdquo; this root certificate.</p><hr><h2 id=viewing-certificate-contents>Viewing Certificate Contents</h2><p>Use the following command to view the Pigsty CA certificate contents:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl x509 -text -in /etc/pki/ca.crt
</span></span></code></pre></div><details><summary>Local CA Root Certificate Content Example</summary><pre tabindex=0><code>Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            50:29:e3:60:96:93:f4:85:14:fe:44:81:73:b5:e1:09:2a:a8:5c:0a
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: O=pigsty, OU=ca, CN=pigsty-ca
        Validity
            Not Before: Feb  7 00:56:27 2023 GMT
            Not After : Jan 14 00:56:27 2123 GMT
        Subject: O=pigsty, OU=ca, CN=pigsty-ca
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                    00:c1:41:74:4f:28:c3:3c:2b:13:a2:37:05:87:31:
                    ....
                    e6:bd:69:a5:5b:e3:b4:c0:65:09:6e:84:14:e9:eb:
                    90:f7:61
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Alternative Name:
                DNS:pigsty-ca
            X509v3 Key Usage:
                Digital Signature, Certificate Sign, CRL Sign
            X509v3 Basic Constraints: critical
                CA:TRUE, pathlen:1
            X509v3 Subject Key Identifier:
                C5:F6:23:CE:BA:F3:96:F6:4B:48:A5:B1:CD:D4:FA:2B:BD:6F:A6:9C
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        89:9d:21:35:59:6b:2c:9b:c7:6d:26:5b:a9:49:80:93:81:18:
        ....
        9e:dd:87:88:0d:c4:29:9e
-----BEGIN CERTIFICATE-----
...
cXyWAYcvfPae3YeIDcQpng==
-----END CERTIFICATE-----
</code></pre></details><hr><h2 id=issuing-certificates>Issuing Certificates</h2><p>If you want to use client certificate authentication, you can use the local CA and the <a href=https://github.com/pgsty/pigsty/blob/main/cert.yml><strong><code>cert.yml</code></strong></a> playbook to manually issue PostgreSQL client certificates.</p><p>Set the certificate&rsquo;s <code>CN</code> field to the database username:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_dba
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_monitor
</span></span></code></pre></div><p>Issued certificates are generated in <code>files/pki/misc/&lt;cn>.{key,crt}</code> by default.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-42af3045c7ebee43d7c66fbe8a4cd267>7.2 - Seven-Layer Security Model</h1><div class=lead>How Pigsty provides defense-in-depth across seven security layers, from physical security to user security.</div><p>Security is not a wall, but a fortress. Pigsty adopts a <strong>defense-in-depth</strong> strategy, building multiple protections across seven layers. Even if one layer is breached, other layers still provide protection.</p><hr><h2 id=overview>Overview</h2><div id=infographic-5c882599098b83b429f94bd07a85bb52 class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-5c882599098b83b429f94bd07a85bb52",s=`\`\`\`\`
infographic sequence-pyramid-simple
data
  title Seven-Layer Security Model
  desc Pigsty Defense-in-Depth: Multi-layer protection from physical to user security
  items
    - label Physical Security
      value 100
      desc Data Checksums · PGTDE Transparent Encryption
      time L1
      icon mingcute/building-4-fill
      illus server-cluster
    - label Network Security
      value 95
      desc Firewall · SSL/TLS Encryption · Local CA
      time L2
      icon mingcute/earth-2-fill
      illus secure-server
    - label Perimeter Security
      value 90
      desc HAProxy Proxy · Nginx Gateway
      time L3
      icon mingcute/shield-fill
      illus firewall-protection
    - label Host Security
      value 85
      desc SELinux · Least Privilege · System Hardening
      time L4
      icon mingcute/computer-fill
      illus server-status
    - label Application Security
      value 80
      desc HBA Rules · Password Policy · Connection Pool
      time L5
      icon mingcute/safe-box-fill
      illus database-security
    - label Data Security
      value 75
      desc Backup Encryption · Audit Logs · PITR
      time L6
      icon mingcute/lock-fill
      illus data-encryption
    - label User Security
      value 70
      desc Four-Role Model · RBAC · Certificate Auth
      time L7
      icon mingcute/user-security-fill
      illus user-flow
theme light
  palette pigsty
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=physical-security>Physical Security</h2><blockquote><p>If physical access is compromised, other layers are rendered useless.</p></blockquote><p>Physical security is the most basic layer, involving data center access control, surveillance, environmental control, equipment theft prevention, power protection, etc. As a software solution, Pigsty provides the following protection mechanisms at the physical layer:</p><h3 id=data-checksums>Data Checksums</h3><p>Enabling data checksums can detect silent data corruption at the storage layer (e.g., bad disk blocks, memory errors, firmware bugs):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_checksum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Default enabled since v3.5+</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Principle</strong>: PostgreSQL calculates checksums when writing each data page and validates when reading. Reports error instead of returning corrupt data when corruption is detected.</p><p><strong>Fallback mechanism</strong>: Replica provides bad block fallback; damaged data pages on primary can be recovered from replica.</p><h3 id=transparent-data-encryption>Transparent Data Encryption</h3><p>For compliance-required scenarios, use <strong>PGTDE</strong> (PostgreSQL Transparent Data Encryption) extension:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pg_tde </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Transparent data encryption extension</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Effect</strong>: Data is stored encrypted on disk; data cannot be read even if physical media is stolen.</p><hr><h2 id=network-security>Network Security</h2><blockquote><p>Control access and filtering at the packet layer.</p></blockquote><h3 id=firewall>Firewall</h3><p>Pigsty supports node-level firewall configuration, controlling which ports are exposed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_firewall_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zone      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># off | none | zone</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_firewall_intranet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># Intranet CIDR (trust zone)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>10.0.0.0</span><span style=color:#000>/8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>172.16.0.0</span><span style=color:#000>/12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>192.168.0.0</span><span style=color:#000>/16</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_firewall_public_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># Public exposed ports</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>22</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># SSH</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># HTTP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># HTTPS</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Three Modes</strong>:</p><table><thead><tr><th style=text-align:left>Mode</th><th style=text-align:left>Description</th><th style=text-align:left>Use Case</th></tr></thead><tbody><tr><td style=text-align:left><code>off</code></td><td style=text-align:left>Don&rsquo;t configure firewall (default)</td><td style=text-align:left>Dev environment, existing security groups</td></tr><tr><td style=text-align:left><code>none</code></td><td style=text-align:left>Disable firewalld</td><td style=text-align:left>Using external firewall</td></tr><tr><td style=text-align:left><code>zone</code></td><td style=text-align:left>Zone mode: trust intranet, restrict public</td><td style=text-align:left>Production recommended</td></tr></tbody></table><h3 id=ssltls-encryption>SSL/TLS Encryption</h3><p>Pigsty provides SSL/TLS encryption at multiple layers:</p><table><thead><tr><th style=text-align:left>Component</th><th style=text-align:left>Parameter</th><th style=text-align:left>Default</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>PostgreSQL</td><td style=text-align:left>HBA <code>auth</code></td><td style=text-align:left><code>pwd</code></td><td style=text-align:left>Supports <code>ssl</code> (enforced), <code>cert</code> (certificate)</td></tr><tr><td style=text-align:left>Pgbouncer</td><td style=text-align:left><code>pgbouncer_sslmode</code></td><td style=text-align:left><code>disable</code></td><td style=text-align:left>Optional <code>require</code> / <code>verify-full</code></td></tr><tr><td style=text-align:left>Patroni</td><td style=text-align:left><code>patroni_ssl_enabled</code></td><td style=text-align:left><code>false</code></td><td style=text-align:left>REST API encryption</td></tr><tr><td style=text-align:left>Nginx</td><td style=text-align:left><code>nginx_sslmode</code></td><td style=text-align:left><code>enable</code></td><td style=text-align:left>Optional <code>enforce</code> (force HTTPS)</td></tr><tr><td style=text-align:left>MinIO</td><td style=text-align:left>Enabled by default</td><td style=text-align:left>enabled</td><td style=text-align:left>Uses local CA certificate</td></tr><tr><td style=text-align:left>etcd</td><td style=text-align:left>Enabled by default</td><td style=text-align:left>enabled</td><td style=text-align:left>TLS encrypted communication</td></tr></tbody></table><p><strong>Security Hardening Configuration</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_ssl_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Enable Patroni SSL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>require  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Force Pgbouncer SSL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>nginx_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>enforce      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Force HTTPS</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=local-ca-certificate-infrastructure>Local CA Certificate Infrastructure</h3><p>Pigsty automatically generates a local CA and issues certificates, no commercial certificates needed:</p><pre tabindex=0><code>files/pki/ca/
├── ca.crt              # CA certificate (public, distributed to all nodes)
└── ca.key              # CA private key (⚠️ Keep secret! Backup securely!)

/etc/pki/               # Certificate directory on nodes
├── ca.crt              # CA certificate
├── server.crt          # Server certificate
└── server.key          # Server private key
</code></pre><p><strong>⚠️ Important</strong>: Please securely backup <code>ca.key</code>. If lost, all certificates need to be re-issued!</p><hr><h2 id=perimeter-security>Perimeter Security</h2><blockquote><p>Handle security policies at internal/external network boundaries.</p></blockquote><h3 id=haproxy-security>HAProxy Security</h3><p>HAProxy serves as the unified entry point for database traffic, providing these security features:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>haproxy_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;StrongPassword123&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Admin interface password</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Security Features</strong>:</p><ul><li>Health checks and traffic control to prevent split-brain</li><li>Connection limits and rate limiting</li><li>Admin interface password protection</li></ul><h3 id=nginx-security>Nginx Security</h3><p>Nginx serves as the unified gateway for web services, providing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>nginx_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>enforce </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Force HTTPS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Configure component domains</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>grafana</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>g.pigsty.io }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>alertmanager</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>a.pigsty.io }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Security Features</strong>:</p><ul><li>Unified HTTPS entry, easy to audit</li><li>Reverse proxy protects backend services</li><li>Can integrate external authentication (OAuth, LDAP)</li></ul><hr><h2 id=host-security>Host Security</h2><blockquote><p>OS hardening, patch management, minimal installation.</p></blockquote><h3 id=selinux-configuration>SELinux Configuration</h3><p>Pigsty correctly configures SELinux policies to ensure PostgreSQL and other services run properly:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_selinux_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>permissive </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># disabled | permissive | enforcing</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><table><thead><tr><th style=text-align:left>Mode</th><th style=text-align:left>Description</th><th style=text-align:left>Use Case</th></tr></thead><tbody><tr><td style=text-align:left><code>disabled</code></td><td style=text-align:left>Completely disabled</td><td style=text-align:left>Dev environment</td></tr><tr><td style=text-align:left><code>permissive</code></td><td style=text-align:left>Permissive mode (log but don&rsquo;t block)</td><td style=text-align:left>Production recommended</td></tr><tr><td style=text-align:left><code>enforcing</code></td><td style=text-align:left>Enforcing mode</td><td style=text-align:left>High security environments</td></tr></tbody></table><h3 id=os-hardening>OS Hardening</h3><p>Pigsty follows the principle of least privilege in design:</p><ul><li><strong>File permissions</strong>: Sensitive files (e.g., CA private key) have strictly controlled permissions</li><li><strong>User groups</strong>: PostgreSQL, etcd, etc. run with dedicated users</li><li><strong>Admin configuration</strong>:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dba       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Admin username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_admin_sudo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>nopasswd      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># sudo policy</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=system-updates>System Updates</h3><p>Keep critical security components updated:</p><ul><li><code>openssh</code>: SSH service</li><li><code>ca-certificates</code>: System root certificates</li><li><code>openssl</code>: Encryption library</li></ul><hr><h2 id=application-security>Application Security</h2><blockquote><p>Database configuration, authentication/authorization, input validation.</p></blockquote><h3 id=password-policy>Password Policy</h3><h4 id=password-encryption-algorithm>Password Encryption Algorithm</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pwd_enc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>scram-sha-256 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Most secure password hash algorithm</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><table><thead><tr><th style=text-align:left>Algorithm</th><th style=text-align:left>Security</th><th style=text-align:left>Compatibility</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>scram-sha-256</code></td><td style=text-align:left>⭐⭐⭐</td><td style=text-align:left>PostgreSQL 10+</td><td style=text-align:left>Recommended, default</td></tr><tr><td style=text-align:left><code>md5</code></td><td style=text-align:left>⭐</td><td style=text-align:left>All versions</td><td style=text-align:left>Only for legacy clients</td></tr></tbody></table><h4 id=password-strength-check>Password Strength Check</h4><p>Enable <code>passwordcheck</code> extension to enforce password complexity:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;$libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>passwordcheck </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Enforce password complexity</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>credcheck     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Additional password checks</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h4 id=password-expiration>Password Expiration</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_app, password: &#39;SecurePass123&#39;, expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>365</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Expires in 1 year</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=hba-rules>HBA Rules</h3><p>HBA (Host-Based Authentication) controls &ldquo;who can connect from where, using what authentication method&rdquo;:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu local via ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu repl via ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;repl via localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;repl from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;repl from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor via localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin from infra&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin from world&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all     ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all     ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all     ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;offline from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Authentication Methods</strong>:</p><table><thead><tr><th style=text-align:left>Alias</th><th style=text-align:left>Description</th><th style=text-align:left>Security Level</th></tr></thead><tbody><tr><td style=text-align:left><code>ident/peer</code></td><td style=text-align:left>OS user mapping</td><td style=text-align:left>⭐⭐⭐ Local only</td></tr><tr><td style=text-align:left><code>pwd</code></td><td style=text-align:left>Password auth (scram-sha-256)</td><td style=text-align:left>⭐⭐</td></tr><tr><td style=text-align:left><code>ssl</code></td><td style=text-align:left>Forced SSL + password</td><td style=text-align:left>⭐⭐⭐</td></tr><tr><td style=text-align:left><code>cert</code></td><td style=text-align:left>Client certificate auth</td><td style=text-align:left>⭐⭐⭐⭐ Highest</td></tr><tr><td style=text-align:left><code>deny</code></td><td style=text-align:left>Deny access</td><td style=text-align:left>-</td></tr></tbody></table><h3 id=listen-address>Listen Address</h3><p>Limit network interfaces PostgreSQL listens on:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_listen</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${ip},${vip},${lo}&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Only listen on specific IPs, not 0.0.0.0</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=data-security>Data Security</h2><blockquote><p>Encryption, backup, audit, integrity protection.</p></blockquote><h3 id=backup-encryption>Backup Encryption</h3><p>pgBackRest supports AES-256 encrypted backups:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES-256-CBC encryption</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgBR.${pg_cluster}&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Use cluster name as part of password</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Effect</strong>: Backup files are stored encrypted; data cannot be read even if storage is compromised.</p><h3 id=audit-logs>Audit Logs</h3><h4 id=postgresql-audit-extensions>PostgreSQL Audit Extensions</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgaudit          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># SQL audit logs</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgauditlogtofile </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Audit logs to file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pg_auth_mon      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Authentication monitoring</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pg_auditor       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Audit helper</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h4 id=connection-logs>Connection Logs</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure in pg_parameters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># Log connection establishment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_disconnections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># Log connection termination</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h4 id=slow-query-logs>Slow Query Logs</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Log queries &gt;1s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=point-in-time-recovery-pitr>Point-in-Time Recovery (PITR)</h3><p>Pigsty configures pgBackRest for PITR by default:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># Local backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># Remote backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Retain 14 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=user-security>User Security</h2><blockquote><p>Identity authentication, permission management, behavior audit.</p></blockquote><h3 id=four-role-model>Four-Role Model</h3><p>Pigsty provides out-of-box four-tier permission roles:</p><pre class=mermaid>flowchart TB
    subgraph Admin[&#34;🔴 dbrole_admin (Administrator)&#34;]
        A1[&#34;Inherits dbrole_readwrite&#34;]
        A2[&#34;Can CREATE/DROP/ALTER (DDL)&#34;]
        A3[&#34;Use case: Business admins, schema-creating apps&#34;]
    end
    subgraph RW[&#34;🟡 dbrole_readwrite (Read-Write)&#34;]
        RW1[&#34;Inherits dbrole_readonly&#34;]
        RW2[&#34;Can INSERT/UPDATE/DELETE&#34;]
        RW3[&#34;Use case: Production business accounts&#34;]
    end
    subgraph RO[&#34;🟢 dbrole_readonly (Read-Only)&#34;]
        RO1[&#34;Can SELECT all tables&#34;]
        RO2[&#34;Use case: Reporting, data analysis&#34;]
    end
    subgraph Offline[&#34;🔵 dbrole_offline (Offline)&#34;]
        OFF1[&#34;Can only access offline instances&#34;]
        OFF2[&#34;Use case: ETL, slow queries, personal analysis&#34;]
    end

    Admin --&gt; |inherits| RW
    RW --&gt; |inherits| RO</pre><p><strong>Creating Business Users</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_report, password: &#39;ReportPass123&#39;, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_app, password: &#39;AppPass456&#39;, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_admin, password: &#39;AdminPass789&#39;, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin] }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=default-users-and-passwords>Default Users and Passwords</h3><table><thead><tr><th style=text-align:left>User</th><th style=text-align:left>Default Password</th><th style=text-align:left>Purpose</th><th style=text-align:left>Post-Deploy Action</th></tr></thead><tbody><tr><td style=text-align:left><code>postgres</code></td><td style=text-align:left>No password (local only)</td><td style=text-align:left>System superuser</td><td style=text-align:left>Keep without password</td></tr><tr><td style=text-align:left><code>dbuser_dba</code></td><td style=text-align:left><code>DBUser.DBA</code></td><td style=text-align:left>Admin user</td><td style=text-align:left><strong>Must change</strong></td></tr><tr><td style=text-align:left><code>dbuser_monitor</code></td><td style=text-align:left><code>DBUser.Monitor</code></td><td style=text-align:left>Monitor user</td><td style=text-align:left><strong>Must change</strong></td></tr><tr><td style=text-align:left><code>replicator</code></td><td style=text-align:left><code>DBUser.Replicator</code></td><td style=text-align:left>Replication user</td><td style=text-align:left><strong>Must change</strong></td></tr></tbody></table><p><strong>Auto-Generate Strong Passwords</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -g  <span style=color:#8f5902;font-style:italic># Automatically generate random strong passwords</span>
</span></span></code></pre></div><h3 id=certificate-authentication>Certificate Authentication</h3><p>Highest security level, requires clients to provide valid certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: admin, db: all, addr: world, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cert} </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Admin uses cert auth</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=etcd-and-minio-security>ETCD and MinIO Security</h3><p>Auxiliary components also use RBAC model and TLS encryption:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ETCD</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_root_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;Etcd.Root.Strong&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Must change</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># MinIO</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_access_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minioadmin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_secret_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;S3User.MinIO.Strong&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Must change</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>access_key: pgbackrest, secret_key: &#39;Min10.bAckup&#39;, policy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>readwrite }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>access_key: dba, secret_key: &#39;S3User.DBA.Strong&#39;, policy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>consoleAdmin }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=watchdog-protection>Watchdog Protection</h3><p>Prevents split-brain, ensures primary forced shutdown during failover:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_watchdog_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>required </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># off | automatic | required</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Effect</strong>: When Patroni process is abnormal, watchdog forces node restart to avoid dual-primary split-brain.</p><hr><h2 id=compliance-mapping>Compliance Mapping</h2><h3 id=china-mlps-level-3-gbt-22239-2019>China MLPS Level 3 (GB/T 22239-2019)</h3><table class=full-width><thead><tr><th style=text-align:left>Requirement</th><th style=text-align:center>Default</th><th style=text-align:center>Configurable</th><th style=text-align:left>Implementation</th></tr></thead><tbody><tr><td style=text-align:left>Unique Identity</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:left>Unique username identifier</td></tr><tr><td style=text-align:left>Password Complexity</td><td style=text-align:center>⚠️</td><td style=text-align:center>✅</td><td style=text-align:left><code>passwordcheck</code> extension</td></tr><tr><td style=text-align:left>Password Rotation</td><td style=text-align:center>⚠️</td><td style=text-align:center>✅</td><td style=text-align:left><code>expire_in</code> attribute</td></tr><tr><td style=text-align:left>Two-Factor Auth</td><td style=text-align:center>⚠️</td><td style=text-align:center>✅</td><td style=text-align:left>Certificate + password (<code>auth: cert</code>)</td></tr><tr><td style=text-align:left>Access Control</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:left>HBA + Four-role model</td></tr><tr><td style=text-align:left>Least Privilege</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:left><code>dbrole_readonly/readwrite/admin</code></td></tr><tr><td style=text-align:left>Encrypted Communication</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:left>SSL/TLS</td></tr><tr><td style=text-align:left>Audit Logs</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:left><code>pgaudit</code> + connection logs</td></tr><tr><td style=text-align:left>Data Integrity</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:left><code>pg_checksum: true</code></td></tr><tr><td style=text-align:left>Backup & Recovery</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:left>pgBackRest + PITR</td></tr></tbody></table><h3 id=soc-2-type-ii>SOC 2 Type II</h3><table class=full-width><thead><tr><th style=text-align:left>Control Point</th><th style=text-align:center>Pigsty Support</th><th style=text-align:left>Implementation</th></tr></thead><tbody><tr><td style=text-align:left>CC6.1 Logical Access Control</td><td style=text-align:center>✅</td><td style=text-align:left>HBA + RBAC</td></tr><tr><td style=text-align:left>CC6.6 Transmission Encryption</td><td style=text-align:center>✅</td><td style=text-align:left>SSL/TLS (can enforce)</td></tr><tr><td style=text-align:left>CC7.2 System Monitoring</td><td style=text-align:center>✅</td><td style=text-align:left>Prometheus + Grafana</td></tr><tr><td style=text-align:left>CC9.1 Business Continuity</td><td style=text-align:center>✅</td><td style=text-align:left>HA + PITR</td></tr><tr><td style=text-align:left>A1.2 Data Recovery</td><td style=text-align:center>✅</td><td style=text-align:left>pgBackRest backup</td></tr></tbody></table><p><strong>Legend</strong>: ✅ Default satisfied · ⚠️ Requires additional configuration</p><hr><h2 id=security-checklist>Security Checklist</h2><h3 id=pre-deployment>Pre-Deployment</h3><ul><li><input disabled type=checkbox> Prepare strong passwords (use <code>./configure -g</code> to auto-generate)</li><li><input disabled type=checkbox> Plan network partitioning (intranet/public CIDR)</li><li><input disabled type=checkbox> Determine SSL policy (self-signed CA or external CA)</li><li><input disabled type=checkbox> Determine whether to enable firewall</li></ul><h3 id=post-deployment-required>Post-Deployment (Required)</h3><ul><li><input disabled type=checkbox> <strong>Change all default passwords</strong></li><li><input disabled type=checkbox> Verify HBA rules meet expectations</li><li><input disabled type=checkbox> Test SSL connections work properly</li><li><input disabled type=checkbox> Configure authentication failure alerts</li><li><input disabled type=checkbox> Securely backup CA private key</li></ul><h3 id=security-enhancement-optional>Security Enhancement (Optional)</h3><ul><li><input disabled type=checkbox> Enable <code>passwordcheck</code> extension</li><li><input disabled type=checkbox> Force SSL (<code>pgbouncer_sslmode: require</code>)</li><li><input disabled type=checkbox> Enable certificate authentication (<code>auth: cert</code>)</li><li><input disabled type=checkbox> Enable <code>pgaudit</code> audit logs</li><li><input disabled type=checkbox> Enable backup encryption</li><li><input disabled type=checkbox> Enable Patroni SSL</li><li><input disabled type=checkbox> Enable watchdog</li><li><input disabled type=checkbox> Configure firewall rules</li><li><input disabled type=checkbox> Enable SELinux enforcing mode</li></ul><hr><h2 id=whats-next>What&rsquo;s Next</h2><p>Deep dive into security configuration details:</p><ul><li>👤 <a href=ac/><strong>Access Control</strong></a>: Role system and permission model</li><li>🔐 <a href=ca/><strong>Encrypted Communication</strong></a>: SSL/TLS and certificate management</li></ul><p>Related topics:</p><ul><li>♾️ <a href=../ha/><strong>High Availability</strong></a>: Business continuity assurance</li><li>⏰ <a href=../pitr/><strong>Backup & Recovery</strong></a>: Data recovery capabilities</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6a3742ed82b65fb5a722f76337bf835d>7.3 - Access Control</h1><div class=lead>Pigsty provides standard security practices with an out-of-the-box role and permission model.</div><blockquote><p>Pigsty provides an out-of-the-box access control model based on the <a href=#role-system>Role System</a> and <a href=#permission-system>Permission System</a>.</p></blockquote><p>Access control is important, but many users struggle to implement it properly. Pigsty provides a streamlined access control model that serves as a security baseline for your cluster.</p><hr><h2 id=role-system>Role System</h2><p>Pigsty&rsquo;s default role system includes four <a href=#default-roles>default roles</a> and four <a href=#default-users>default users</a>:</p><table><thead><tr><th>Role Name</th><th>Attributes</th><th>Member Of</th><th>Description</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td></td><td>Role: Global read-only</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>dbrole_readonly</td><td>Role: Global read-write</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>pg_monitor,dbrole_readwrite</td><td>Role: Admin/Object creation</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td></td><td>Role: Restricted read-only</td></tr><tr><td><code>postgres</code></td><td><code>SUPERUSER</code></td><td></td><td>System superuser</td></tr><tr><td><code>replicator</code></td><td><code>REPLICATION</code></td><td>pg_monitor,dbrole_readonly</td><td>System replication user</td></tr><tr><td><code>dbuser_dba</code></td><td><code>SUPERUSER</code></td><td>dbrole_admin</td><td>PostgreSQL admin user</td></tr><tr><td><code>dbuser_monitor</code></td><td></td><td>pg_monitor</td><td>PostgreSQL monitor user</td></tr></tbody></table><p>These <a href=/docs/pgsql/config/user#define-users>roles and users</a> are defined as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Global default roles and system users</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=default-roles>Default Roles</h2><p>Pigsty has four default roles:</p><ul><li><strong>Business Read-Only</strong> (<code>dbrole_readonly</code>): Role for global read-only access. Use this if other services need read-only access to this database.</li><li><strong>Business Read-Write</strong> (<code>dbrole_readwrite</code>): Role for global read-write access. Production accounts for primary business should have database read-write permissions.</li><li><strong>Business Admin</strong> (<code>dbrole_admin</code>): Role with DDL permissions. Typically used for business administrators or scenarios requiring table creation in applications.</li><li><strong>Offline Read-Only</strong> (<code>dbrole_offline</code>): Restricted read-only access role (can only access <a href=/docs/pgsql/config#offline-replica>offline</a> instances). Usually for personal users or ETL tool accounts.</li></ul><p>Default roles are defined in <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>. Unless you know what you&rsquo;re doing, don&rsquo;t change the default role names.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  , login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline ,   login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access (offline instance) }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=default-users>Default Users</h2><p>Pigsty also has four default users (system users):</p><ul><li><strong>Superuser</strong> (<code>postgres</code>): Cluster owner and creator, same name as OS dbsu.</li><li><strong>Replication User</strong> (<code>replicator</code>): System user for primary-replica replication.</li><li><strong>Monitor User</strong> (<code>dbuser_monitor</code>): User for monitoring database and connection pool metrics.</li><li><strong>Admin User</strong> (<code>dbuser_dba</code>): Administrator for daily operations and database changes.</li></ul><p>These 4 default users&rsquo; username/password are defined by 4 pairs of dedicated parameters and referenced in many places:</p><ul><li><a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a>: OS dbsu name, defaults to postgres. Best not to change it.</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>: dbsu password, default empty means no password. Best not to set it.</li><li><a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a>: Replication username, defaults to <code>replicator</code></li><li><a href=/docs/pgsql/param#pg_replication_password><code>pg_replication_password</code></a>: Replication password, defaults to <code>DBUser.Replicator</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a>: Admin username, defaults to <code>dbuser_dba</code></li><li><a href=/docs/pgsql/param#pg_admin_password><code>pg_admin_password</code></a>: Admin password plaintext, defaults to <code>DBUser.DBA</code></li><li><a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a>: Monitor username, defaults to <code>dbuser_monitor</code></li><li><a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a>: Monitor password, defaults to <code>DBUser.Monitor</code></li></ul><blockquote><p><strong>Remember to change these passwords in production deployments—don&rsquo;t use defaults!</strong></p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Database superuser name, recommended not to change</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Database superuser password, recommended to leave empty!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># System replication username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># System replication password, must change!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># System monitor username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># System monitor password, must change!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># System admin username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># System admin password, must change!</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=permission-system>Permission System</h2><p>Pigsty has an out-of-the-box permission model that works with <a href=#default-roles>default roles</a>.</p><ul><li>All users can access all schemas.</li><li>Read-only users (<code>dbrole_readonly</code>) can read from all tables. (SELECT, EXECUTE)</li><li>Read-write users (<code>dbrole_readwrite</code>) can write to all tables and run DML. (INSERT, UPDATE, DELETE)</li><li>Admin users (<code>dbrole_admin</code>) can create objects and run DDL. (CREATE, USAGE, TRUNCATE, REFERENCES, TRIGGER)</li><li>Offline users (<code>dbrole_offline</code>) are similar to read-only but with restricted access—only <a href=/docs/pgsql/config#offline-replica>offline instances</a> (<code>pg_role = 'offline'</code> or <code>pg_offline_query = true</code>)</li><li>Objects created by admin users will have correct permissions.</li><li>Default privileges are configured on all databases, including template databases.</li><li>Database connection permissions are managed by database <a href=/docs/pgsql/config/db#define-database>definition</a>.</li><li><code>CREATE</code> privilege on databases and <code>public</code> schema is revoked from <code>PUBLIC</code> by default.</li></ul><hr><h2 id=object-privileges>Object Privileges</h2><p>Default privileges for newly created objects are controlled by <a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Objects <strong>newly created</strong> by admins will have the above privileges by default. Use <code>\ddp+</code> to view these default privileges:</p><table><thead><tr><th>Type</th><th>Access Privileges</th></tr></thead><tbody><tr><td>Function</td><td>=X</td></tr><tr><td></td><td>dbrole_readonly=X</td></tr><tr><td></td><td>dbrole_offline=X</td></tr><tr><td></td><td>dbrole_admin=X</td></tr><tr><td>Schema</td><td>dbrole_readonly=U</td></tr><tr><td></td><td>dbrole_offline=U</td></tr><tr><td></td><td>dbrole_admin=UC</td></tr><tr><td>Sequence</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=wU</td></tr><tr><td></td><td>dbrole_admin=rwU</td></tr><tr><td>Table</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=awd</td></tr><tr><td></td><td>dbrole_admin=arwdDxt</td></tr></tbody></table><hr><h2 id=default-privileges>Default Privileges</h2><p>The SQL statement <a href=https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html><code>ALTER DEFAULT PRIVILEGES</code></a> lets you set privileges for future objects. It doesn&rsquo;t affect existing objects or objects created by non-admin users.</p><p>In Pigsty, default privileges are defined for three roles:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dbsu</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_admin_username</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- For other business admins, they should SET ROLE dbrole_admin before executing DDL
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To maintain correct object permissions, you must execute DDL with <strong>admin users</strong>:</p><ol><li><a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>, defaults to <code>postgres</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>{{ pg_admin_username }}</code></a>, defaults to <code>dbuser_dba</code></li><li>Business admin users granted <code>dbrole_admin</code> role (using <code>SET ROLE</code> to switch to <code>dbrole_admin</code>)</li></ol><p>Using <code>postgres</code> as global object owner is wise. If creating objects as business admin, use <code>SET ROLE dbrole_admin</code> before creation to maintain correct permissions.</p><hr><h2 id=database-privileges>Database Privileges</h2><p>In Pigsty, database-level privileges are covered in <a href=#define-database>database definition</a>.</p><p>Databases have three privilege levels: <code>CONNECT</code>, <code>CREATE</code>, <code>TEMP</code>, and a special &lsquo;privilege&rsquo;: <code>OWNERSHIP</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Required, `name` is the only required field</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, database owner, defaults to postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Optional, allow connections, default true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Optional, revoke public connect privilege, default false</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>If <code>owner</code> parameter exists, it becomes database owner instead of <a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a></li><li>If <code>revokeconn</code> is <code>false</code>, all users have database <code>CONNECT</code> privilege (default behavior)</li><li>If <code>revokeconn</code> is explicitly <code>true</code>:<ul><li>Database <code>CONNECT</code> privilege is revoked from <code>PUBLIC</code></li><li><code>CONNECT</code> privilege is explicitly granted to <code>{{ pg_replication_username }}</code>, <code>{{ pg_monitor_username }}</code>, <code>{{ pg_admin_username }}</code></li><li><code>CONNECT</code> privilege with <code>GRANT OPTION</code> is granted to database owner</li></ul></li><li><code>revokeconn</code> can isolate cross-database access within the same cluster</li></ul><hr><h2 id=create-privilege>CREATE Privilege</h2><p>For security, Pigsty revokes <code>CREATE</code> privilege on databases from <code>PUBLIC</code> by default. This is also default behavior since PostgreSQL 15.</p><p>Database owners can always adjust CREATE privileges based on actual needs.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Email - Vonng" aria-label="Email - Vonng"><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label="Email - Vonng"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=WeChat aria-label=WeChat><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=WeChat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Discussion aria-label=Discussion><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=Discussion><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Repo aria-label=Repo><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=Repo><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>