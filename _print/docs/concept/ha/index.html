<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.io/docs/concept/ha/><link rel=alternate type=application/rss+xml href=https://pigsty.io/docs/concept/ha/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>High Availability | PIGSTY</title><meta name=description content="Pigsty uses Patroni to implement PostgreSQL high availability, ensuring automatic failover when the primary becomes unavailable."><meta property="og:url" content="https://pigsty.io/docs/concept/ha/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="High Availability"><meta property="og:description" content="Pigsty uses Patroni to implement PostgreSQL high availability, ensuring automatic failover when the primary becomes unavailable."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="High Availability"><meta itemprop=description content="Pigsty uses Patroni to implement PostgreSQL high availability, ensuring automatic failover when the primary becomes unavailable."><meta itemprop=dateModified content="2026-01-16T00:53:35+08:00"><meta itemprop=wordCount content="1376"><meta itemprop=keywords content="Concept,PIGSTY,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="High Availability"><meta name=twitter:description content="Pigsty uses Patroni to implement PostgreSQL high availability, ensuring automatic failover when the primary becomes unavailable."><link rel=preload href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css as=style integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><link href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css rel=stylesheet integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Ver</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.cc>Pigsty 中文网站</a></li><li><a class=dropdown-item href=https://doc.pgsty.com>Pigsty v3.7 Doc</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc>Pigsty v3.4 Doc</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 Doc</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 Doc</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch Language / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d757e151050fd40088751a74721d74f6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:window.location.href="https://pigsty.cc"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/concept/ha/>Return to the regular view of this page</a>.</p></div><h1 class=title>High Availability</h1><div class=lead>Pigsty uses Patroni to implement PostgreSQL high availability, ensuring automatic failover when the primary becomes unavailable.</div><ul><li>1: <a href=#pg-928294eb73615de574523762c3a1ab07>RPO Trade-offs</a></li><li>2: <a href=#pg-95882b9440d286103890671f368774b6>RTO Trade-offs</a></li><li>3: <a href=#pg-439a629138018b9fe8b5a1c8323745be>Failure Model</a></li><ul><li>3.1: <a href=#pg-358e309cdbb4cb46571e2cba4875ac34>Model of Patroni Passive Failure</a></li><li>3.2: <a href=#pg-42b7950723c66bacccc650303281acc3>Model of Patroni Active Failure</a></li></ul><li>4: <a href=#pg-895a94576239d65b824c6e6ae06deb76>Service Access</a></li></ul><div class=content><hr><h2 id=overview>Overview</h2><p>Pigsty&rsquo;s PostgreSQL clusters come with out-of-the-box high availability, powered by <a href=https://patroni.readthedocs.io/en/latest/><strong>Patroni</strong></a>, <a href=https://etcd.io/><strong>Etcd</strong></a>, and <a href=http://www.haproxy.org/><strong>HAProxy</strong></a>.</p><p>When your PostgreSQL cluster has two or more instances, you automatically have self-healing database high availability without any additional configuration — as long as any instance in the cluster survives, the cluster can provide complete service. Clients only need to connect to any node in the cluster to get full service without worrying about primary-replica topology changes.</p><p>With default configuration, the primary failure Recovery Time Objective (RTO) ≈ 45s, and Recovery Point Objective (RPO) &lt; 1MB; for replica failures, RPO = 0 and RTO ≈ 0 (brief interruption). In consistency-first mode, failover can guarantee zero data loss: RPO = 0. All these metrics can be <a href=#tradeoffs><strong>configured as needed</strong></a> based on your actual hardware conditions and reliability requirements.</p><p>Pigsty includes built-in HAProxy load balancers for automatic traffic switching, providing DNS/VIP/LVS and other access methods for clients. Failover and switchover are almost transparent to the business side except for brief interruptions - applications don&rsquo;t need to modify connection strings or restart.
The minimal maintenance window requirements bring great flexibility and convenience: you can perform rolling maintenance and upgrades on the entire cluster without application coordination. The feature that hardware failures can wait until the next day to handle lets developers, operations, and DBAs sleep well during incidents.</p><p><del><img src=/img/pigsty/ha.png alt=pigsty-ha></del></p><p>Many large organizations and core institutions have been using Pigsty in production for extended periods. The largest deployment has 25K CPU cores and 220+ PostgreSQL ultra-large instances (64c / 512g / 3TB NVMe SSD). In this deployment case, dozens of hardware failures and various incidents occurred over five years, yet overall availability of over <strong>99.999%</strong> was maintained.</p><hr><p><strong>What problems does High Availability solve?</strong></p><ul><li>Elevates data security C/IA availability to a new level: RPO ≈ 0, RTO &lt; 45s.</li><li>Gains seamless rolling maintenance capability, minimizing maintenance window requirements and bringing great convenience.</li><li>Hardware failures can self-heal immediately without human intervention, allowing operations and DBAs to sleep well.</li><li>Replicas can handle read-only requests, offloading primary load and fully utilizing resources.</li></ul><p><strong>What are the costs of High Availability?</strong></p><ul><li>Infrastructure dependency: HA requires DCS (etcd/zk/consul) for consensus.</li><li>Higher starting threshold: A meaningful HA deployment requires at least <strong>three nodes</strong>.</li><li>Extra resource consumption: Each new replica consumes additional resources, though this is usually not a major concern.</li><li>Significantly increased complexity: Backup costs increase significantly, requiring tools to manage complexity.</li></ul><p><strong>Limitations of High Availability</strong></p><p>Since replication happens in real-time, all changes are immediately applied to replicas. Therefore, streaming replication-based HA solutions cannot handle data deletion or modification caused by human errors and software defects. (e.g., <code>DROP TABLE</code> or <code>DELETE</code> data)
Such failures require using <a href=/docs/pgsql/config#delayed-cluster><strong>delayed clusters</strong></a> or performing <a href=/docs/concept/pitr><strong>point-in-time recovery</strong></a> using previous base backups and WAL archives.</p><table><thead><tr><th style=text-align:left>Configuration Strategy</th><th>RTO</th><th style=text-align:left>RPO</th></tr></thead><tbody><tr><td style=text-align:left>Standalone + <i class="fa-solid fa-music text-danger"></i> Nothing</td><td><i class="fas fa-circle-xmark text-danger"></i> <strong>Data permanently lost, unrecoverable</strong></td><td style=text-align:left><i class="fas fa-circle-xmark text-danger"></i> <strong>All data lost</strong></td></tr><tr><td style=text-align:left>Standalone + <i class="fa-solid fa-copy text-secondary"></i> Base Backup</td><td><i class="fa-solid fa-triangle-exclamation text-secondary"></i> Depends on backup size and bandwidth (hours)</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-secondary"></i> Lose data since last backup (hours to days)</td></tr><tr><td style=text-align:left>Standalone + <i class="fa-solid fa-copy text-primary"></i> Base Backup + <i class="fa-solid fa-clock-rotate-left text-primary"></i> WAL Archive</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> Depends on backup size and bandwidth (hours)</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-primary"></i> Lose unarchived data (tens of MB)</td></tr><tr><td style=text-align:left>Primary-Replica + <i class="fa-solid fa-wrench text-secondary"></i> Manual Failover</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> ~10 minutes</td><td style=text-align:left><i class="fa-solid fa-circle-check text-primary"></i> Lose data in replication lag (~100KB)</td></tr><tr><td style=text-align:left>Primary-Replica + <i class="fa-solid fa-infinity text-primary"></i> Auto Failover</td><td><i class="fa-solid fa-circle-check text-primary"></i> Within 1 minute</td><td style=text-align:left><i class="fa-solid fa-circle-check text-primary"></i> Lose data in replication lag (~100KB)</td></tr><tr><td style=text-align:left>Primary-Replica + <i class="fa-solid fa-infinity text-primary"></i> Auto Failover + <i class="fa-solid fa-rotate text-success"></i> Sync Commit</td><td><i class="fa-solid fa-circle-check text-success"></i> Within 1 minute</td><td style=text-align:left><i class="fa-solid fa-circle-check text-success"></i> No data loss</td></tr></tbody></table><hr><h2 id=how-it-works>How It Works</h2><p>In Pigsty, the high availability architecture works as follows:</p><ul><li>PostgreSQL uses standard streaming replication to build physical replicas; replicas take over when the primary fails.</li><li>Patroni manages PostgreSQL server processes and handles high availability matters.</li><li>Etcd provides distributed configuration storage (DCS) capability and is used for leader election after failures.</li><li>Patroni relies on Etcd to reach cluster leader consensus and provides health check interfaces externally.</li><li>HAProxy exposes cluster services externally and uses Patroni health check interfaces to automatically distribute traffic to healthy nodes.</li><li>vip-manager provides an optional Layer 2 VIP, retrieves leader information from Etcd, and binds the VIP to the node where the cluster primary resides.</li></ul><p>When the primary fails, a new round of leader election is triggered. The healthiest replica in the cluster (highest LSN position, minimum data loss) wins and is promoted to the new primary. After the winning replica is promoted, read-write traffic is immediately routed to the new primary.
The impact of primary failure is <strong>brief write service unavailability</strong>: write requests will be blocked or fail directly from primary failure until new primary promotion, with unavailability typically lasting 15 to 30 seconds, usually not exceeding 1 minute.</p><p>When a replica fails, read-only traffic is routed to other replicas. Only when all replicas fail will read-only traffic ultimately be handled by the primary.
The impact of replica failure is <strong>partial read-only query interruption</strong>: queries currently running on that replica will abort due to connection reset and be immediately taken over by other available replicas.</p><p>Failure detection is performed jointly by Patroni and Etcd. The cluster leader holds a lease; if the cluster leader fails to renew the lease in time (10s) due to failure, the lease is released, triggering a <strong>Failover</strong> and new cluster election.</p><p>Even without any failures, you can proactively change the cluster primary through <a href=/docs/pgsql/admin#switchover><strong>Switchover</strong></a>.
In this case, write queries on the primary will experience a brief interruption and be immediately routed to the new primary. This operation is typically used for rolling maintenance/upgrades of database servers.</p><hr><h2 id=tradeoffs>Tradeoffs</h2><p><strong>Recovery Time Objective (RTO)</strong> and <strong>Recovery Point Objective (RPO)</strong> are two parameters that require careful tradeoffs when designing high availability clusters.</p><p>The default <strong>RTO</strong> and <strong>RPO</strong> values used by Pigsty meet reliability requirements for most scenarios. You can adjust them based on your hardware level, network quality, and business requirements.</p><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>RTO and RPO are NOT always better when smaller!</div><p>Too small an RTO increases false positive rates; too small an RPO reduces the probability of successful automatic failover.</p></div><p>The upper limit of unavailability during failover is controlled by the <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> parameter. <strong>RTO</strong> defaults to <code>45s</code>. Increasing it will result in longer primary failure write unavailability, while decreasing it will increase the rate of false positive failovers (e.g., repeated switching due to brief network jitter).</p><p>The upper limit of potential data loss is controlled by the <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> parameter, defaulting to <code>1MB</code>. Reducing this value can lower the data loss ceiling during failover but also increases the probability of refusing automatic failover when replicas are not healthy enough (lagging too far behind).</p><p>Pigsty uses <strong>availability-first</strong> mode by default, meaning it will failover as quickly as possible when the primary fails, and data not yet replicated to replicas may be lost (under typical 10GbE networks, replication lag is usually a few KB to 100KB).</p><p>If you need to ensure zero data loss during failover, you can use the <a href=/docs/pgsql/param#pg_conf><strong><code>crit.yml</code></strong></a> template to ensure no data loss during failover, but this sacrifices some performance as a tradeoff.</p><hr><h2 id=related-parameters>Related Parameters</h2><h3 id=pg_rto><a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a></h3><p>Parameter name: <code>pg_rto</code>, Type: <code>int</code>, Level: <code>C</code></p><p>Recovery Time Objective (RTO) in seconds. This is used to calculate Patroni&rsquo;s TTL value, defaulting to <code>45</code> seconds.</p><p>If the primary instance is missing for this long, a new leader election will be triggered. This value is not always better when lower; it involves tradeoffs:
Reducing this value can decrease unavailability during cluster failover (inability to write), but makes the cluster more sensitive to short-term network jitter, increasing the probability of false positive failover triggers.
You need to configure this value based on network conditions and business constraints, making a <strong>tradeoff</strong> between <strong>failure probability</strong> and <strong>failure impact</strong>.</p><h3 id=pg_rpo><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a></h3><p>Parameter name: <code>pg_rpo</code>, Type: <code>int</code>, Level: <code>C</code></p><p>Recovery Point Objective (RPO) in bytes, default: <code>1048576</code>.</p><p>Defaults to 1MiB, meaning up to 1MiB of data loss can be tolerated during failover.</p><p>When the primary goes down and all replicas are lagging, you must make a difficult choice:
Either promote a replica to become the new primary immediately, accepting acceptable data loss (e.g., less than 1MB), and restore service as quickly as possible.
Or wait for the primary to come back online (which may never happen) to avoid any data loss, or abandon automatic failover and wait for human intervention to make the final decision.
You need to configure this value based on business preference, making a <strong>tradeoff</strong> between <strong>availability</strong> and <strong>consistency</strong>.</p><p>Additionally, you can always ensure RPO = 0 by enabling synchronous commit (e.g., using the <code>crit.yml</code> template), sacrificing some cluster latency/throughput performance to guarantee data consistency.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-928294eb73615de574523762c3a1ab07>1 - RPO Trade-offs</h1><div class=lead>Trade-off analysis for RPO (Recovery Point Objective), finding the optimal balance between availability and data loss.</div><p><strong>RPO</strong> (Recovery Point Objective) defines the <strong>maximum amount of data loss</strong> allowed when the primary fails.</p><p>For scenarios where data integrity is critical, such as financial transactions, RPO = 0 is typically required, meaning no data loss is allowed.</p><p>However, stricter RPO targets come at a cost: higher write latency, reduced system throughput, and the risk that replica failures may cause primary unavailability.
For typical scenarios, some data loss is acceptable (e.g., up to 1MB) in exchange for higher availability and performance.</p><hr><h2 id=trade-offs>Trade-offs</h2><p>In asynchronous replication scenarios, there is typically some replication lag between replicas and the primary (depending on network and throughput, normally in the range of 10KB-100KB / 100µs-10ms).
This means when the primary fails, replicas may not have fully synchronized with the latest data. If a failover occurs, the new primary may lose some unreplicated data.</p><p>The upper limit of potential data loss is controlled by the <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> parameter, which defaults to <code>1048576</code> (<code>1MB</code>), meaning up to 1MiB of data loss can be tolerated during failover.</p><p>When the cluster primary fails, if any replica has replication lag within this threshold, Pigsty will automatically promote that replica to be the new primary.
However, when all replicas exceed this threshold, Pigsty will refuse [<strong>automatic failover</strong>] to prevent data loss.
Manual intervention is then required to decide whether to wait for the primary to recover (which may never happen) or accept the data loss and force-promote a replica.</p><p>You need to configure this value based on your business requirements, making a <strong>trade-off</strong> between <strong>availability</strong> and <strong>consistency</strong>.
Increasing this value improves the success rate of automatic failover but also increases the upper limit of potential data loss.</p><p>When you set <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> = 0, Pigsty enables <strong>synchronous replication</strong>, ensuring the primary only returns write success after at least one replica has persisted the data.
This configuration ensures zero replication lag but introduces significant write latency and reduces overall throughput.</p><pre class=mermaid>flowchart LR
    A([Primary Failure]) --&gt; B{Synchronous&lt;br/&gt;Replication?}

    B --&gt;|No| C{Lag &lt; RPO?}
    B --&gt;|Yes| D{Sync Replica&lt;br/&gt;Available?}

    C --&gt;|Yes| E[Lossy Auto Failover&lt;br/&gt;RPO &lt; 1MB]
    C --&gt;|No| F[Refuse Auto Failover&lt;br/&gt;Wait for Primary Recovery&lt;br/&gt;or Manual Intervention]

    D --&gt;|Yes| G[Lossless Auto Failover&lt;br/&gt;RPO = 0]
    D --&gt;|No| H{Strict Mode?}

    H --&gt;|No| C
    H --&gt;|Yes| F

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#F0AD4E,stroke:#146c43,color:#fff
    style G fill:#198754,stroke:#146c43,color:#fff
    style F fill:#BE002F,stroke:#565e64,color:#fff</pre><hr><h2 id=protection-modes>Protection Modes</h2><p>Pigsty provides three protection modes to help users make trade-offs under different RPO requirements, similar to <a href=https://docs.oracle.com/en/database/oracle/oracle-database/21/sbydb/oracle-data-guard-protection-modes.html><strong>Oracle Data Guard</strong></a> protection modes.</p><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>Maximum Performance</div><ul><li><strong>Default mode</strong>, asynchronous replication, transactions commit with only local WAL persistence, no waiting for replicas, replica failures are completely transparent to the primary</li><li>Primary failure may lose unsent/unreceived WAL (typically &lt; 1MB, normally 10ms/100ms, 10KB/100KB range under normal network conditions)</li><li>Optimized for performance, suitable for typical business scenarios that tolerate minor data loss during failures</li></ul></div><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>Maximum Availability</div><ul><li>Configured with <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo = 0</code></strong></a>, enables Patroni synchronous commit mode: <code>synchronous_mode: true</code></li><li>Under normal conditions, waits for at least one replica confirmation, achieving zero data loss. When <strong>all</strong> sync replicas fail, <strong>automatically degrades to async mode to continue service</strong></li><li>Balances data safety and service availability, recommended configuration for production <strong>critical business</strong></li></ul></div><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Maximum Protection</div><ul><li>Uses <code>crit.yml</code> template, enables Patroni strict synchronous mode: <code>synchronous_mode: true</code> / <code>synchronous_mode_strict: true</code></li><li>When all sync replicas fail, <strong>primary refuses writes</strong> to prevent data loss, transactions must be persisted on at least one replica before returning success</li><li>Suitable for financial transactions, medical records, and other scenarios with extremely high data integrity requirements</li></ul></div><table class=full-width><thead><tr><th style=text-align:left><strong>Name</strong></th><th style=text-align:center><strong>Maximum Performance</strong></th><th style=text-align:center><strong>Maximum Availability</strong></th><th style=text-align:center><strong>Maximum Protection</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>Replication</strong></td><td style=text-align:center><strong>Asynchronous</strong></td><td style=text-align:center><strong>Synchronous</strong></td><td style=text-align:center><strong>Strict Synchronous</strong></td></tr><tr><td style=text-align:left><strong>Data Loss</strong></td><td style=text-align:center><span class=text-danger><strong>Possible</strong></span> (replication lag)</td><td style=text-align:center><span class=text-primary><strong>Zero normally, minor when degraded</strong></span></td><td style=text-align:center><span class=text-success><strong>Zero</strong></span></td></tr><tr><td style=text-align:left><strong>Write Latency</strong></td><td style=text-align:center><span class=text-success><strong>Lowest</strong></span></td><td style=text-align:center><span class=text-warning><strong>Medium</strong></span> (+1 network RTT)</td><td style=text-align:center><span class=text-warning><strong>Medium</strong></span> (+1 network RTT)</td></tr><tr><td style=text-align:left><strong>Throughput</strong></td><td style=text-align:center><span class=text-success><strong>Highest</strong></span></td><td style=text-align:center><span class=text-warning><strong>Reduced</strong></span></td><td style=text-align:center><span class=text-warning><strong>Reduced</strong></span></td></tr><tr><td style=text-align:left><strong>Replica Failure Impact</strong></td><td style=text-align:center><span class=text-success><strong>None</strong></span></td><td style=text-align:center><span class=text-primary><strong>Auto degrade, service continues</strong></span></td><td style=text-align:center><span class=text-danger><strong>Primary stops writes</strong></span></td></tr><tr><td style=text-align:left><strong>RPO</strong></td><td style=text-align:center><span class=text-warning><strong>&lt; 1MB</strong></span></td><td style=text-align:center><span class=text-primary><strong>= 0 (normal) / &lt; 1MB (degraded)</strong></span></td><td style=text-align:center><span class=text-success><strong>= 0</strong></span></td></tr><tr><td style=text-align:left><strong>Use Case</strong></td><td style=text-align:center>Typical business, performance first</td><td style=text-align:center>Critical business, safety first</td><td style=text-align:center>Financial core, compliance first</td></tr><tr><td style=text-align:left><strong>Configuration</strong></td><td style=text-align:center>Default config</td><td style=text-align:center><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> = <code>0</code></td><td style=text-align:center><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>: <code>crit.yml</code></td></tr></tbody></table><hr><h2 id=implementation>Implementation</h2><p>The three protection modes differ in how two core <strong>Patroni</strong> parameters are configured: <a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-mode><strong><code>synchronous_mode</code></strong></a> and <a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-mode><strong><code>synchronous_mode_strict</code></strong></a>:</p><ul><li><strong><code>synchronous_mode</code></strong>: Whether Patroni enables synchronous replication. If enabled, check if <strong><code>synchronous_mode_strict</code></strong> enables strict synchronous mode.</li><li><strong><code>synchronous_mode_strict = false</code></strong>: Default configuration, allows degradation to async mode when replicas fail, <strong>primary continues service</strong> (Maximum Availability)</li><li><strong><code>synchronous_mode_strict = true</code></strong>: Degradation forbidden, <strong>primary stops writes</strong> until sync replica recovers (Maximum Protection)</li></ul><table class=full-width><thead><tr><th style=text-align:center>Mode</th><th style=text-align:center><strong><code>synchronous_mode</code></strong></th><th style=text-align:center><strong><code>synchronous_mode_strict</code></strong></th><th>Replication Mode</th><th style=text-align:left>Replica Failure Behavior</th></tr></thead><tbody><tr><td style=text-align:center><strong>Max Performance</strong></td><td style=text-align:center><span class=text-danger><strong><code>false</code></strong></span></td><td style=text-align:center>-</td><td><strong>Async</strong></td><td style=text-align:left><span class=text-success><strong>No impact</strong></span></td></tr><tr><td style=text-align:center><strong>Max Availability</strong></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td style=text-align:center><span class=text-danger><strong><code>false</code></strong></span></td><td><strong>Synchronous</strong></td><td style=text-align:left><span class=text-primary><strong>Auto degrade to async</strong></span></td></tr><tr><td style=text-align:center><strong>Max Protection</strong></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td><strong>Strict Synchronous</strong></td><td style=text-align:left><span class=text-danger><strong>Primary refuses writes</strong></span></td></tr></tbody></table><p>Typically, you only need to set the <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> parameter to <code>0</code> to enable the <code>synchronous_mode</code> switch, activating <strong>Maximum Availability mode</strong>.
If you use <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <a href=/docs/pgsql/template/crit><strong><code>crit.yml</code></strong></a> template, it additionally enables the <code>synchronous_mode_strict</code> strict mode switch, activating <strong>Maximum Protection mode</strong>.</p><p>You can also directly <a href=/docs/pgsql/admin/patroni#modify-config><strong>configure</strong></a> these Patroni parameters as needed. Refer to Patroni and PostgreSQL documentation to achieve stronger data protection, such as:</p><ul><li>Specify the <a href=/docs/pgsql/config/cluster#quorum-commit><strong>synchronous replica list</strong></a>, configure more sync replicas to improve disaster tolerance, use quorum synchronous commit, or even require all replicas to perform synchronous commit.</li><li><a href=/docs/pgsql/admin/patroni#modify-config><strong>Configure</strong></a> <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT><strong><code>synchronous_commit</code></strong></a>: <code>'remote_apply'</code> to strictly ensure primary-replica read-write consistency. (Oracle Maximum Protection mode is equivalent to <code>remote_write</code>)</li></ul><hr><h2 id=recommendations>Recommendations</h2><p><strong>Maximum Performance mode</strong> (asynchronous replication) is the default mode used by Pigsty and is sufficient for the vast majority of workloads.
Tolerating minor data loss during failures (typically in the range of a few KB to hundreds of KB) in exchange for higher throughput and availability is the recommended configuration for typical business scenarios.
In this case, you can adjust the maximum allowed data loss through the <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> parameter to suit different business needs.</p><p><strong>Maximum Availability mode</strong> (synchronous replication) is suitable for scenarios with high data integrity requirements that cannot tolerate data loss.
In this mode, a minimum of two-node PostgreSQL cluster (one primary, one replica) is required.
Set <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> to 0 to enable this mode.</p><p><strong>Maximum Protection mode</strong> (strict synchronous replication) is suitable for financial transactions, medical records, and other scenarios with extremely high data integrity requirements. We recommend using at least a three-node cluster (one primary, two replicas),
because with only two nodes, if the replica fails, the primary will stop writes, causing service unavailability, which reduces overall system reliability. With three nodes, if only one replica fails, the primary can continue to serve.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-95882b9440d286103890671f368774b6>2 - RTO Trade-offs</h1><div class=lead>Trade-off analysis for RTO (Recovery Time Objective), finding the optimal balance between recovery speed and false failover risk.</div><p><strong>RTO</strong> (Recovery Time Objective) defines the <strong>maximum time required for the system to restore write capability</strong> when the primary fails.</p><p>For critical transaction systems where availability is paramount, the shortest possible RTO is typically required, such as under one minute.</p><p>However, shorter RTO comes at a cost: increased false failover risk. Network jitter may be misinterpreted as a failure, leading to unnecessary failovers.
For cross-datacenter/cross-region deployments, RTO requirements are typically relaxed (e.g., 1-2 minutes) to reduce false failover risk.</p><hr><h2 id=trade-offs>Trade-offs</h2><p>The upper limit of unavailability during failover is controlled by the <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> parameter. Pigsty provides four preset RTO modes:
<code>fast</code>, <code>norm</code>, <code>safe</code>, <code>wide</code>, each optimized for different network conditions and deployment scenarios. The default is <code>norm</code> mode (~45 seconds).
You can also specify the RTO upper limit directly in seconds, and the system will automatically map to the closest mode.</p><p>When the primary fails, the entire recovery process involves multiple phases: Patroni detects the failure, DCS lock expires, new primary election, promote execution, HAProxy detects the new primary.
Reducing RTO means shortening the timeout for each phase, which makes the cluster more sensitive to network jitter, thereby increasing false failover risk.</p><p>You need to choose the appropriate mode based on actual network conditions, balancing <strong>recovery speed</strong> and <strong>false failover risk</strong>.
The worse the network quality, the more conservative mode you should choose; the better the network quality, the more aggressive mode you can choose.</p><pre class=mermaid>flowchart LR
    A([Primary Failure]) --&gt; B{Patroni&lt;br/&gt;Detected?}

    B --&gt;|PG Crash| C[Attempt Local Restart]
    B --&gt;|Node Down| D[Wait TTL Expiration]

    C --&gt;|Success| E([Local Recovery])
    C --&gt;|Fail/Timeout| F[Release Leader Lock]

    D --&gt; F
    F --&gt; G[Replica Election]
    G --&gt; H[Execute Promote]
    H --&gt; I[HAProxy Detects]
    I --&gt; J([Service Restored])

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#198754,stroke:#146c43,color:#fff
    style J fill:#198754,stroke:#146c43,color:#fff</pre><hr><h2 id=four-modes>Four Modes</h2><p>Pigsty provides four RTO modes to help users make trade-offs under different network conditions.</p><table class=full-width><thead><tr><th style=text-align:left><strong>Name</strong></th><th style=text-align:center><strong>fast</strong></th><th style=text-align:center><strong>norm</strong></th><th style=text-align:center><strong>safe</strong></th><th style=text-align:center><strong>wide</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>Use Case</strong></td><td style=text-align:center>Same rack</td><td style=text-align:center>Same datacenter (default)</td><td style=text-align:center>Same region, cross-DC</td><td style=text-align:center>Cross-region/continent</td></tr><tr><td style=text-align:left><strong>Network</strong></td><td style=text-align:center>&lt; 1ms, very stable</td><td style=text-align:center>1-5ms, normal</td><td style=text-align:center>10-50ms, cross-DC</td><td style=text-align:center>100-200ms, public network</td></tr><tr><td style=text-align:left><strong>Target RTO</strong></td><td style=text-align:center><span class=text-success><strong>30s</strong></span></td><td style=text-align:center><span class=text-primary><strong>45s</strong></span></td><td style=text-align:center><span class=text-warning><strong>90s</strong></span></td><td style=text-align:center><span class=text-danger><strong>150s</strong></span></td></tr><tr><td style=text-align:left><strong>False Failover Risk</strong></td><td style=text-align:center><span class=text-secondary><strong>Higher</strong></span></td><td style=text-align:center><span class=text-primary><strong>Medium</strong></span></td><td style=text-align:center><span class=text-success><strong>Lower</strong></span></td><td style=text-align:center><span class=text-success><strong>Very Low</strong></span></td></tr><tr><td style=text-align:left><strong>Configuration</strong></td><td style=text-align:center><code>pg_rto: fast</code></td><td style=text-align:center><code>pg_rto: norm</code></td><td style=text-align:center><code>pg_rto: safe</code></td><td style=text-align:center><code>pg_rto: wide</code></td></tr></tbody></table><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>fast: Same Rack/Switch</div><ul><li>Suitable for scenarios with extremely low network latency (&lt; 1ms) and very stable networks, such as same-rack or same-switch deployments</li><li>Average RTO: <strong>14s</strong>, worst case: <strong>29s</strong>, TTL only 20s, check interval 5s</li><li>Highest network quality requirements, any jitter may trigger failover, <strong>higher false failover risk</strong></li></ul></div><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>norm: Same Datacenter (Default)</div><ul><li><strong>Default mode</strong>, suitable for same-datacenter deployment, network latency 1-5ms, normal quality, reasonable packet loss rate</li><li>Average RTO: <strong>21s</strong>, worst case: <strong>43s</strong>, TTL is 30s, provides reasonable tolerance window</li><li>Balances recovery speed and stability, suitable for most production environments</li></ul></div><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>safe: Same Region, Cross-Datacenter</div><ul><li>Suitable for same-region/same-area cross-datacenter deployment, network latency 10-50ms, occasional jitter possible</li><li>Average RTO: <strong>43s</strong>, worst case: <strong>91s</strong>, TTL is 60s, longer tolerance window</li><li>Primary restart wait time is longer (60s), gives more local recovery opportunities, <strong>lower false failover risk</strong></li></ul></div><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>wide: Cross-Region/Continent</div><ul><li>Suitable for cross-region or even cross-continent deployment, network latency 100-200ms, possible public-network-level packet loss</li><li>Average RTO: <strong>92s</strong>, worst case: <strong>207s</strong>, TTL is 120s, very wide tolerance window</li><li>Sacrifices recovery speed for extremely low false failover rate, suitable for geo-disaster recovery scenarios</li></ul></div><hr><h2 id=rto-timeline>RTO Timeline</h2><p>Patroni / PG HA has two critical failure paths. For detailed RTO timing analysis, see: <a href=/docs/concept/ha/failure/active><strong>Active Failure Detection</strong></a> and <a href=/docs/concept/ha/failure/passive><strong>Passive Lease Expiration</strong></a>.</p><div id=echarts-74af516d5864b02d2eb17471e66dde23 class="echarts-container td-max-width-on-larger-screens" style=height:820px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-74af516d5864b02d2eb17471e66dde23");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:110,right:24,top:40},legend:{data:["Lease Expiration","Failure Detection","Restart Timeout","Replica Detection","Lock & Promote","Health Check"],itemGap:10,top:0},series:[{barWidth:16,data:[120,110,100,"-","-","-","-",60,55,50,"-","-","-","-",30,27,25,"-","-","-","-",20,17,15,"-","-","-"],emphasis:{focus:"series"},itemStyle:{color:"#e15759"},name:"Lease Expiration",stack:"main",type:"bar",z:2},{data:["-","-","-",20,10,0,"-","-","-","-",10,5,0,"-","-","-","-",5,3,0,"-","-","-","-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#b07aa1"},name:"Failure Detection",stack:"main",type:"bar",z:2},{data:["-","-","-",95,95,0,"-","-","-","-",45,45,0,"-","-","-","-",25,25,0,"-","-","-","-",15,15,0],emphasis:{focus:"series"},itemStyle:{color:"#f28e2c"},name:"Restart Timeout",stack:"main",type:"bar",z:2},{data:[20,10,0,20,10,0,"-",10,5,0,10,5,0,"-",5,3,0,5,3,0,"-",5,3,0,5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"Replica Detection",stack:"main",type:"bar",z:2},{data:[2,1,0,2,1,0,"-",2,1,0,2,1,0,"-",2,1,0,2,1,0,"-",2,1,0,2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"Lock & Promote",stack:"main",type:"bar",z:2},{data:[8,6,4,8,6,4,"-",6,5,3,6,5,3,"-",4,3,2,4,3,2,"-",2,2,1,2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"Health Check",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:16,data:[150,127,104,145,122,4,"-",78,66,53,73,61,3,"-",41,34,27,41,35,2,"-",29,23,16,29,24,1],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO Total",type:"bar",z:1},{barGap:"-100%",barWidth:16,data:[150,150,150,150,150,150,"-",90,90,90,90,90,90,"-",45,45,45,45,45,45,"-",30,30,30,30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO Budget",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"Seconds",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:9},axisLine:{show:!0},axisTick:{show:!0},data:["wide-passive-max","wide-passive-avg","wide-passive-min","wide-active-max","wide-active-avg","wide-active-min","","safe-passive-max","safe-passive-avg","safe-passive-min","safe-active-max","safe-active-avg","safe-active-min","","norm-passive-max","norm-passive-avg","norm-passive-min","norm-active-max","norm-active-avg","norm-active-min","","fast-passive-max","fast-passive-avg","fast-passive-min","fast-active-max","fast-active-avg","fast-active-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=implementation>Implementation</h2><p>The four RTO modes differ in how the following 10 <strong>Patroni</strong> and <strong>HAProxy</strong> HA-related parameters are configured.</p><table class=full-width><thead><tr><th style=text-align:center>Component</th><th style=text-align:center>Parameter</th><th style=text-align:center><strong>fast</strong></th><th style=text-align:center><strong>norm</strong></th><th style=text-align:center><strong>safe</strong></th><th style=text-align:center><strong>wide</strong></th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>patroni</code></strong></td><td style=text-align:center><strong><code>ttl</code></strong></td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:center>60</td><td style=text-align:center>120</td><td style=text-align:left>Leader lock TTL (seconds)</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>loop_wait</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>20</td><td style=text-align:left>HA loop check interval (seconds)</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>retry_timeout</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:left>DCS operation retry timeout (seconds)</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>primary_start_timeout</code></strong></td><td style=text-align:center>15</td><td style=text-align:center>25</td><td style=text-align:center>45</td><td style=text-align:center>95</td><td style=text-align:left>Primary restart wait time (seconds)</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>safety_margin</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>15</td><td style=text-align:left>Watchdog safety margin (seconds)</td></tr><tr><td style=text-align:center><strong><code>haproxy</code></strong></td><td style=text-align:center><strong><code>inter</code></strong></td><td style=text-align:center>1s</td><td style=text-align:center>2s</td><td style=text-align:center>3s</td><td style=text-align:center>4s</td><td style=text-align:left>Normal state check interval</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>fastinter</code></strong></td><td style=text-align:center>0.5s</td><td style=text-align:center>1s</td><td style=text-align:center>1.5s</td><td style=text-align:center>2s</td><td style=text-align:left>State transition check interval</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>downinter</code></strong></td><td style=text-align:center>1s</td><td style=text-align:center>2s</td><td style=text-align:center>3s</td><td style=text-align:center>4s</td><td style=text-align:left>DOWN state check interval</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>rise</code></strong></td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:left>Consecutive successes to mark UP</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>fall</code></strong></td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:left>Consecutive failures to mark DOWN</td></tr></tbody></table><h3 id=patroni-parameters>Patroni Parameters</h3><ul><li><strong><code>ttl</code></strong>: Leader lock TTL. Primary must renew within this time, otherwise lock expires and triggers election. Directly determines passive failure detection delay.</li><li><strong><code>loop_wait</code></strong>: Patroni main loop interval. Each loop performs one health check and state sync, affects failure discovery timeliness.</li><li><strong><code>retry_timeout</code></strong>: DCS operation retry timeout. During network partition, Patroni retries continuously within this period; after timeout, primary actively demotes to prevent split-brain.</li><li><strong><code>primary_start_timeout</code></strong>: Wait time for Patroni to attempt local restart after PG crash. After timeout, releases Leader lock and triggers failover.</li><li><strong><code>safety_margin</code></strong>: Watchdog safety margin. Ensures sufficient time to trigger system restart during failures, avoiding split-brain.</li></ul><h3 id=haproxy-parameters>HAProxy Parameters</h3><ul><li><strong><code>inter</code></strong>: Health check interval in normal state, used when service status is stable.</li><li><strong><code>fastinter</code></strong>: Check interval during state transition, uses shorter interval to accelerate confirmation when state change detected.</li><li><strong><code>downinter</code></strong>: Check interval in DOWN state, uses this interval to probe recovery after service marked DOWN.</li><li><strong><code>rise</code></strong>: Consecutive successes required to mark UP. After new primary comes online, must pass <code>rise</code> consecutive checks before receiving traffic.</li><li><strong><code>fall</code></strong>: Consecutive failures required to mark DOWN. Service must fail <code>fall</code> consecutive times before being marked DOWN.</li></ul><h3 id=key-constraint>Key Constraint</h3><p><strong>Patroni core constraint</strong>: Ensures primary can complete demotion before TTL expires, preventing split-brain.</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi><mo>+</mo><mn>2</mn><mo>×</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>r</mi><mi>y</mi><mi mathvariant="normal">_</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mo>≤</mo><mi>t</mi><mi>t</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">loop\_wait + 2 \times retry\_timeout \leq ttl</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0044em;vertical-align:-.31em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord style=margin-right:.02778em>_</span><span class="mord mathnormal" style=margin-right:.02691em>w</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.9695em;vertical-align:-.31em></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.03588em>ry</span><span class=mord style=margin-right:.02778em>_</span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">eo</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≤</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6944em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span></span></span></span></span><hr><h2 id=recommendations>Recommendations</h2><p><strong>fast mode</strong> is suitable for scenarios with extremely high RTO requirements, but requires sufficiently good network quality (latency &lt; 1ms, very low packet loss).
Recommended only for same-rack or same-switch deployments, and should be thoroughly tested in production before enabling.</p><p><strong>norm mode</strong> (<strong>default</strong>) is Pigsty&rsquo;s default configuration, sufficient for the vast majority of same-datacenter deployments.
An average recovery time of 21 seconds is within acceptable range while providing a reasonable tolerance window to avoid false failovers from network jitter.</p><p><strong>safe mode</strong> is suitable for same-city cross-datacenter deployments with higher network latency or occasional jitter.
The longer tolerance window effectively prevents false failovers from network jitter, making it the recommended configuration for cross-datacenter disaster recovery.</p><p><strong>wide mode</strong> is suitable for cross-region or even cross-continent deployments with high network latency and possible public-network-level packet loss.
In such scenarios, stability is more important than recovery speed, so an extremely wide tolerance window ensures very low false failover rate.</p><table class=full-width><thead><tr><th style=text-align:left>Scenario</th><th style=text-align:left>Recommended Mode</th><th style=text-align:left>Rationale</th></tr></thead><tbody><tr><td style=text-align:left>Dev/Test environment</td><td style=text-align:left>fast</td><td style=text-align:left>Quick feedback, low impact from false failover</td></tr><tr><td style=text-align:left>Same-datacenter production</td><td style=text-align:left>norm</td><td style=text-align:left>Default choice, well-balanced</td></tr><tr><td style=text-align:left>Same-city active-active/cross-DC DR</td><td style=text-align:left>safe</td><td style=text-align:left>Tolerates network jitter, reduces false failover</td></tr><tr><td style=text-align:left>Geo-DR/cross-country deployment</td><td style=text-align:left>wide</td><td style=text-align:left>Adapts to high-latency public network, very low false failover rate</td></tr><tr><td style=text-align:left>Uncertain network quality</td><td style=text-align:left>safe</td><td style=text-align:left>Conservative choice, avoids false failover</td></tr></tbody></table><p>Typically you only need to set <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> to the mode name, and Pigsty will automatically configure Patroni and HAProxy parameters.
For backward compatibility, Pigsty still supports configuring RTO directly in seconds, but the effect is equivalent to specifying <code>norm</code> mode.</p><p>The mode configuration actually loads the corresponding parameter set from <a href=/docs/pgsql/param#pg_rto_plan><strong><code>pg_rto_plan</code></strong></a>. You can modify or override this configuration to implement custom RTO strategies.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-439a629138018b9fe8b5a1c8323745be>3 - Failure Model</h1><div class=lead>Detailed analysis of worst-case, best-case, and average RTO calculation logic and results across three classic failure detection/recovery paths</div><p>Patroni failures can be classified into 10 categories by failure target, and further consolidated into five categories based on detection path, which are detailed in this section.</p><table class=full-width><thead><tr><th>#</th><th>Failure Scenario</th><th>Description</th><th>Final Path</th></tr></thead><tbody><tr><td>1</td><td>PG process crash</td><td>crash, OOM killed</td><td><strong>Active Detection</strong></td></tr><tr><td>2</td><td>PG connection refused</td><td>max_connections</td><td><strong>Active Detection</strong></td></tr><tr><td>3</td><td>PG zombie</td><td>Process alive but unresponsive</td><td><strong>Active Detection</strong> (timeout)</td></tr><tr><td>4</td><td>Patroni process crash</td><td>kill -9, OOM</td><td><strong>Passive Detection</strong></td></tr><tr><td>5</td><td>Patroni zombie</td><td>Process alive but stuck</td><td><strong>Watchdog</strong></td></tr><tr><td>6</td><td>Node down</td><td>Power outage, hardware failure</td><td><strong>Passive Detection</strong></td></tr><tr><td>7</td><td>Node zombie</td><td>IO hang, CPU starvation</td><td><strong>Watchdog</strong></td></tr><tr><td>8</td><td>Primary ↔ DCS network failure</td><td>Firewall, switch failure</td><td><strong>Network Partition</strong></td></tr><tr><td>9</td><td>Storage failure</td><td>Disk failure, disk full, mount failure</td><td><strong>Active Detection</strong> or <strong>Watchdog</strong></td></tr><tr><td>10</td><td>Manual switchover</td><td>Switchover/Failover</td><td><strong>Manual Trigger</strong></td></tr></tbody></table><p>However, for RTO calculation purposes, all failures ultimately converge to two paths. This section explores the upper bound, lower bound, and average RTO for these two scenarios.</p><ul><li><a href=/docs/concept/ha/failure/passive><strong>Passive election triggered after Patroni loses contact</strong></a></li><li><a href=/docs/concept/ha/failure/active><strong>Patroni actively detects failure and triggers switchover</strong></a></li></ul><pre class=mermaid>flowchart LR
    A([Primary Failure]) --&gt; B{Patroni&lt;br/&gt;Detected?}

    B --&gt;|PG Crash| C[Attempt Local Restart]
    B --&gt;|Node Down| D[Wait TTL Expiration]

    C --&gt;|Success| E([Local Recovery])
    C --&gt;|Fail/Timeout| F[Release Leader Lock]

    D --&gt; F
    F --&gt; G[Replica Election]
    G --&gt; H[Execute Promote]
    H --&gt; I[HAProxy Detects]
    I --&gt; J([Service Restored])

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#198754,stroke:#146c43,color:#fff
    style J fill:#198754,stroke:#146c43,color:#fff</pre></div><div class=td-content style=page-break-before:always><h1 id=pg-358e309cdbb4cb46571e2cba4875ac34>3.1 - Model of Patroni Passive Failure</h1><div class=lead>Failover path triggered by node crash causing leader lease expiration and cluster election</div><div id=infographic-7de234be936c491ca38d917964899ac2 class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-7de234be936c491ca38d917964899ac2",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  
  desc Lease Expiration Stages
  items
    - label Lease Expiration
    - label Replica Detect
    - label Elect & Promote
    - label Haproxy Up
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-timeline>RTO Timeline</h2><div id=echarts-0f45ad1cb9c0c76384b068caaba7bbfe class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-0f45ad1cb9c0c76384b068caaba7bbfe");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["Lease Expiration","Replica Detection","Lock Contest & Promote","Health Check"],itemGap:12,top:0},series:[{barWidth:20,data:[120,110,100,"-",60,55,50,"-",30,27,25,"-",20,17,15],emphasis:{focus:"series"},itemStyle:{color:"#e15759"},name:"Lease Expire",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"Replica Detect",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"Elect & Promote",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"HAProxy Check",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[150,127,104,"-",78,66,53,"-",41,34,27,"-",29,23,16],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"Total RTO",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO Budget",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"Seconds",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=failure-model>Failure Model</h2><table class=full-width><thead><tr><th style=text-align:center>Phase</th><th style=text-align:center>Best</th><th style=text-align:center>Worst</th><th style=text-align:center>Average</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><strong>Lease Expiration</strong></td><td style=text-align:center><code>ttl - loop</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:center><code>ttl - loop/2</code></td><td style=text-align:left>Best: crash just before refresh<br>Worst: crash right after refresh</td></tr><tr><td style=text-align:center><strong>Replica Detect</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop / 2</code></td><td style=text-align:left>Best: exactly at check point<br>Worst: just missed check point</td></tr><tr><td style=text-align:center><strong>Election Promote</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>Best: direct lock and promote<br>Worst: API timeout + Promote</td></tr><tr><td style=text-align:center><strong>HAProxy Check</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>Best: state change before check<br>Worst: state change right after check</td></tr></tbody></table><p><strong>Key Difference Between Passive and Active Failover</strong>:</p><table class=full-width><thead><tr><th style=text-align:center>Scenario</th><th style=text-align:center>Patroni Status</th><th style=text-align:center>Lease Handling</th><th style=text-align:center>Primary Wait Time</th></tr></thead><tbody><tr><td style=text-align:center><strong>Active Failover</strong> (PG crash)</td><td style=text-align:center>Alive, healthy</td><td style=text-align:center>Actively tries to restart PG, releases lease on timeout</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>Passive Failover</strong> (Node crash)</td><td style=text-align:center>Dies with node</td><td style=text-align:center>Cannot actively release, must wait for TTL expiration</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>In passive failover scenarios, Patroni dies along with the node and <strong>cannot actively release the Leader Key</strong>.
The lease in DCS can only trigger cluster election after TTL naturally expires.</p><hr><h2 id=timeline-analysis>Timeline Analysis</h2><h3 id=phase-1-lease-expiration>Phase 1: Lease Expiration</h3><p>The Patroni primary refreshes the Leader Key every <code>loop_wait</code> cycle, resetting TTL to the configured value.</p><pre tabindex=0><code>Timeline:
     t-loop        t          t+ttl-loop    t+ttl
       |           |              |           |
    Last Refresh  Failure      Best Case   Worst Case
       |←── loop ──→|              |           |
       |←──────────── ttl ─────────────────────→|
</code></pre><ul><li><strong>Best case</strong>: Failure occurs just before lease refresh (elapsed <code>loop</code> since last refresh), remaining TTL = <code>ttl - loop</code></li><li><strong>Worst case</strong>: Failure occurs right after lease refresh, must wait full <code>ttl</code></li><li><strong>Average case</strong>: <code>ttl - loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mi>i</mi><mi>r</mi><mi>e</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{expire} = \begin{cases}
ttl - loop &amp; \text{Best} \\
ttl - loop/2 &amp; \text{Average} \\
ttl &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-2-replica-detection>Phase 2: Replica Detection</h3><p>Replicas wake up on <code>loop_wait</code> cycles and check the Leader Key status in DCS.</p><pre tabindex=0><code>Timeline:
    Lease Expired   Replica Wakes
       |            |
       |←── 0~loop ─→|
</code></pre><ul><li><strong>Best case</strong>: Replica happens to wake when lease expires, wait <code>0</code></li><li><strong>Worst case</strong>: Replica just entered sleep when lease expires, wait <code>loop</code></li><li><strong>Average case</strong>: <code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{Best} \\
loop/2 &amp; \text{Average} \\
loop &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-3-lock-contest--promote>Phase 3: Lock Contest & Promote</h3><p>When replicas detect Leader Key expiration, they start the election process. The replica that acquires the Leader Key executes <code>pg_ctl promote</code> to become the new primary.</p><ol><li>Via REST API, parallel queries to check each replica&rsquo;s replication position, typically 10ms, hardcoded 2s timeout.</li><li>Compare WAL positions to determine the best candidate, replicas attempt to create Leader Key (CAS atomic operation)</li><li>Execute <code>pg_ctl promote</code> to become primary (very fast, typically negligible)</li></ol><pre tabindex=0><code>Election Flow:
  ReplicaA ──→ Query replication position ──→ Compare ──→ Contest lock ──→ Success
  ReplicaB ──→ Query replication position ──→ Compare ──→ Contest lock ──→ Fail
</code></pre><ul><li><strong>Best case</strong>: Single replica or immediate lock acquisition and promotion, constant overhead <code>0.1s</code></li><li><strong>Worst case</strong>: DCS API call timeout: <code>2s</code></li><li><strong>Average case</strong>: <code>1s</code> constant overhead</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{Best} \\
1 &amp; \text{Average} \\
2 &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-4-health-check>Phase 4: Health Check</h3><p>HAProxy detects the new primary online, requiring <code>rise</code> consecutive successful health checks.</p><pre tabindex=0><code>Detection Timeline:
  New Primary    First Check   Second Check  Third Check (UP)
     |          |           |           |
     |←─ 0~inter ─→|←─ fast ─→|←─ fast ─→|
</code></pre><ul><li><strong>Best case</strong>: New primary promoted just before check, <code>(rise-1) × fastinter</code></li><li><strong>Worst case</strong>: New primary promoted right after check, <code>(rise-1) × fastinter + inter</code></li><li><strong>Average case</strong>: <code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{Best} \\
(rise-1) \times fastinter + inter/2 &amp; \text{Average} \\
(rise-1) \times fastinter + inter &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-formula>RTO Formula</h2><p>Sum all phase times to get total RTO:</p><p><strong>Best Case</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = ttl - loop + 0.1 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>Average Case</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = ttl + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>Worst Case</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = ttl + loop + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=model-calculation>Model Calculation</h2><p>Substitute the four RTO model parameters into the formulas above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Four Mode Calculation Results</strong> (unit: seconds, format: min / avg / max)</p><table class=full-width><thead><tr><th style=text-align:center>Phase</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>Lease Expiration</td><td style=text-align:center><code>15</code> / <code>17</code> / <code>20</code></td><td style=text-align:center><code>25</code> / <code>27</code> / <code>30</code></td><td style=text-align:center><code>50</code> / <code>55</code> / <code>60</code></td><td style=text-align:center><code>100</code> / <code>110</code> / <code>120</code></td></tr><tr><td style=text-align:center>Replica Detection</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>Lock Contest & Promote</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>Health Check</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>Total</strong></td><td style=text-align:center><code>16</code> / <code>23</code> / <code>29</code></td><td style=text-align:center><code>27</code> / <code>34</code> / <code>41</code></td><td style=text-align:center><code>53</code> / <code>66</code> / <code>78</code></td><td style=text-align:center><code>104</code> / <code>127</code> / <code>150</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-42b7950723c66bacccc650303281acc3>3.2 - Model of Patroni Active Failure</h1><div class=lead>PostgreSQL primary process crashes while Patroni stays alive and attempts restart, triggering failover after timeout</div><div id=infographic-83f086194aaa6ee6523bab9450341f7b class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-83f086194aaa6ee6523bab9450341f7b",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  desc When Patroni is healthy but PostgreSQL crashes
  items
    - label Crash Found
    - label Restart Timeout
    - label Replica Detect
    - label Elect Promote
    - label HAProxy Check
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-timeline>RTO Timeline</h2><div id=echarts-f4f61a909b7c83448b5c4f436a069fec class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-f4f61a909b7c83448b5c4f436a069fec");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["Crash Found","Restart Timeout","Replica Detection","Elect Promote","HAProxy Check"],itemGap:12,top:0},series:[{barWidth:20,data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#b07aa1"},name:"Crash Found",stack:"main",type:"bar",z:2},{data:[95,95,0,"-",45,45,0,"-",25,25,0,"-",15,15,0],emphasis:{focus:"series"},itemStyle:{color:"#f28e2c"},name:"Restart Timeout",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"Replica Detect",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"Elect Promote",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"HAProxy Check",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[145,122,4,"-",73,61,3,"-",41,35,2,"-",29,24,1],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO Total",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO Budget",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"Seconds",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=failure-model>Failure Model</h2><table class=full-width><thead><tr><th style=text-align:center>Item</th><th style=text-align:center>Best</th><th style=text-align:center>Worst</th><th style=text-align:center>Average</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center><strong>Crash Found</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>Best: PG crashes right before check<br>Worst: PG crashes right after check</td></tr><tr><td style=text-align:center><strong>Restart Timeout</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>start</code></td><td style=text-align:left>Best: PG recovers instantly<br>Worst: Wait full start timeout before releasing lease</td></tr><tr><td style=text-align:center><strong>Replica Detect</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>Best: Right at check point<br>Worst: Just missed check point</td></tr><tr><td style=text-align:center><strong>Elect Promote</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>Best: Acquire lock and promote directly<br>Worst: API timeout + Promote</td></tr><tr><td style=text-align:center><strong>HAProxy Check</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>Best: State changes before check<br>Worst: State changes right after check</td></tr></tbody></table><p><strong>Key Difference Between Active and Passive Failure</strong>:</p><table class=full-width><thead><tr><th style=text-align:center>Scenario</th><th style=text-align:center>Patroni Status</th><th style=text-align:center>Lease Handling</th><th style=text-align:center>Main Wait Time</th></tr></thead><tbody><tr><td style=text-align:center><strong>Active Failure</strong> (PG crash)</td><td style=text-align:center>Alive, healthy</td><td style=text-align:center>Actively tries to restart PG, releases lease after timeout</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>Passive Failure</strong> (node down)</td><td style=text-align:center>Dies with node</td><td style=text-align:center>Cannot actively release, must wait for TTL expiry</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>In active failure scenarios, Patroni remains alive and can <strong>actively detect PG crash and attempt restart</strong>.
If restart succeeds, service self-heals; if timeout expires without recovery, Patroni <strong>actively releases the Leader Key</strong>, triggering cluster election.</p><hr><h2 id=timing-analysis>Timing Analysis</h2><h3 id=phase-1-failure-detection>Phase 1: Failure Detection</h3><p>Patroni checks PostgreSQL status every <code>loop_wait</code> cycle (via <code>pg_isready</code> or process check).</p><pre tabindex=0><code>Timeline:
    Last check      PG crash      Next check
       |              |              |
       |←── 0~loop ──→|              |
</code></pre><ul><li><strong>Best case</strong>: PG crashes right before Patroni check, detected immediately, wait <code>0</code></li><li><strong>Worst case</strong>: PG crashes right after check, wait for next cycle, wait <code>loop</code></li><li><strong>Average case</strong>: <code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{Best} \\
loop/2 &amp; \text{Average} \\
loop &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-2-restart-timeout>Phase 2: Restart Timeout</h3><p>After Patroni detects PG crash, it attempts to restart PostgreSQL. This phase has two possible outcomes:</p><pre tabindex=0><code>Timeline:
  Crash detected     Restart attempt     Success/Timeout
      |                  |                    |
      |←──── 0 ~ start ─────────────────────→|
</code></pre><p><strong>Path A: Self-healing Success</strong> (Best case)</p><ul><li>PG restarts successfully, service recovers</li><li>No failover triggered, extremely short RTO</li><li>Wait time: <code>0</code> (relative to Failover path)</li></ul><p><strong>Path B: Failover Required</strong> (Average/Worst case)</p><ul><li>PG still not recovered after <code>primary_start_timeout</code></li><li>Patroni actively releases Leader Key</li><li>Wait time: <code>start</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best (self-healing success)</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average (failover required)</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{restart} = \begin{cases}
0 &amp; \text{Best (self-healing success)} \\
start &amp; \text{Average (failover required)} \\
start &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.2806em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">res</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.02778em>r</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best (self-healing success)</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average (failover required)</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><blockquote><p><strong>Note</strong>: Average case assumes failover is required. If PG can quickly self-heal, overall RTO will be significantly lower.</p></blockquote><h3 id=phase-3-standby-detection>Phase 3: Standby Detection</h3><p>Standbys wake up on <code>loop_wait</code> cycle and check Leader Key status in DCS. When primary Patroni releases the Leader Key, standbys discover this and begin election.</p><pre tabindex=0><code>Timeline:
    Lease released    Standby wakes
       |                  |
       |←── 0~loop ──────→|
</code></pre><ul><li><strong>Best case</strong>: Standby wakes right when lease is released, wait <code>0</code></li><li><strong>Worst case</strong>: Standby just went to sleep when lease released, wait <code>loop</code></li><li><strong>Average case</strong>: <code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>b</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{standby} = \begin{cases}
0 &amp; \text{Best} \\
loop/2 &amp; \text{Average} \\
loop &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">an</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-4-lock--promote>Phase 4: Lock & Promote</h3><p>After standbys discover Leader Key vacancy, election begins. The standby that acquires the Leader Key executes <code>pg_ctl promote</code> to become the new primary.</p><ol><li>Via REST API, parallel queries to check each standby&rsquo;s replication position, typically 10ms, hardcoded 2s timeout.</li><li>Compare WAL positions to determine best candidate, standbys attempt to create Leader Key (CAS atomic operation)</li><li>Execute <code>pg_ctl promote</code> to become primary (very fast, typically negligible)</li></ol><pre tabindex=0><code>Election process:
  StandbyA ──→ Query replication position ──→ Compare ──→ Try lock ──→ Success
  StandbyB ──→ Query replication position ──→ Compare ──→ Try lock ──→ Fail
</code></pre><ul><li><strong>Best case</strong>: Single standby or direct lock acquisition and promote, constant overhead <code>0.1s</code></li><li><strong>Worst case</strong>: DCS API call timeout: <code>2s</code></li><li><strong>Average case</strong>: <code>1s</code> constant overhead</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{Best} \\
1 &amp; \text{Average} \\
2 &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=phase-5-health-check>Phase 5: Health Check</h3><p>HAProxy detects new primary online, requires <code>rise</code> consecutive successful health checks.</p><pre tabindex=0><code>Check timeline:
  New primary    First check    Second check   Third check (UP)
     |              |               |               |
     |←─ 0~inter ──→|←─── fast ────→|←─── fast ────→|
</code></pre><ul><li><strong>Best case</strong>: New primary comes up right at check time, <code>(rise-1) × fastinter</code></li><li><strong>Worst case</strong>: New primary comes up right after check, <code>(rise-1) × fastinter + inter</code></li><li><strong>Average case</strong>: <code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Best</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Average</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>Worst</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{Best} \\
(rise-1) \times fastinter + inter/2 &amp; \text{Average} \\
(rise-1) \times fastinter + inter &amp; \text{Worst}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Best</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Average</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class=mord>Worst</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-formula>RTO Formula</h2><p>Sum all phase times to get total RTO:</p><p><strong>Best Case</strong> (PG instant self-healing)</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>≈</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = 0 + 0 + 0 + 0.1 + (rise-1) \times fastinter \approx (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>Average Case</strong> (Failover required)</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = loop + start + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>Worst Case</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>×</mo><mn>2</mn><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = loop \times 2 + start + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=model-calculation>Model Calculation</h2><p>Substituting the four RTO model parameters into the formulas above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Calculation Results for Four Modes</strong> (unit: seconds, format: min / avg / max)</p><table class=full-width><thead><tr><th style=text-align:center>Phase</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>Failure Detection</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>Restart Timeout</td><td style=text-align:center><code>0</code> / <code>15</code> / <code>15</code></td><td style=text-align:center><code>0</code> / <code>25</code> / <code>25</code></td><td style=text-align:center><code>0</code> / <code>45</code> / <code>45</code></td><td style=text-align:center><code>0</code> / <code>95</code> / <code>95</code></td></tr><tr><td style=text-align:center>Standby Detection</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>Lock & Promote</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>Health Check</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>Total</strong></td><td style=text-align:center><code>1</code> / <code>24</code> / <code>29</code></td><td style=text-align:center><code>2</code> / <code>35</code> / <code>41</code></td><td style=text-align:center><code>3</code> / <code>61</code> / <code>73</code></td><td style=text-align:center><code>4</code> / <code>122</code> / <code>145</code></td></tr></tbody></table><hr><h2 id=comparison-with-passive-failure>Comparison with Passive Failure</h2><table class=full-width><thead><tr><th style=text-align:center>Phase</th><th style=text-align:center>Active Failure (PG crash)</th><th style=text-align:center>Passive Failure (node down)</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center>Detection Mechanism</td><td style=text-align:center>Patroni active detection</td><td style=text-align:center>TTL passive expiry</td><td style=text-align:left>Active detection discovers failure faster</td></tr><tr><td style=text-align:center>Core Wait</td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:left>start is usually less than ttl, but requires additional failure detection time</td></tr><tr><td style=text-align:center>Lease Handling</td><td style=text-align:center>Active release</td><td style=text-align:center>Passive expiry</td><td style=text-align:left>Active release is more timely</td></tr><tr><td style=text-align:center>Self-healing Possible</td><td style=text-align:center>Yes</td><td style=text-align:center>No</td><td style=text-align:left>Active detection can attempt local recovery</td></tr></tbody></table><p><strong>RTO Comparison</strong> (Average case):</p><table class=full-width><thead><tr><th style=text-align:center>Mode</th><th style=text-align:center>Active Failure (PG crash)</th><th style=text-align:center>Passive Failure (node down)</th><th style=text-align:left>Difference</th></tr></thead><tbody><tr><td style=text-align:center>fast</td><td style=text-align:center>24s</td><td style=text-align:center>23s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>norm</td><td style=text-align:center>35s</td><td style=text-align:center>34s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>safe</td><td style=text-align:center>61s</td><td style=text-align:center>66s</td><td style=text-align:left>-5s</td></tr><tr><td style=text-align:center>wide</td><td style=text-align:center>122s</td><td style=text-align:center>127s</td><td style=text-align:left>-5s</td></tr></tbody></table><blockquote><p><strong>Analysis</strong>: In <code>fast</code> and <code>norm</code> modes, active failure RTO is slightly higher than passive failure because it waits for <code>primary_start_timeout</code> (<code>start</code>);
but in <code>safe</code> and <code>wide</code> modes, since <code>start &lt; ttl - loop</code>, active failure is actually faster.
However, active failure has the possibility of self-healing, with potentially extremely short RTO in best case scenarios.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-895a94576239d65b824c6e6ae06deb76>4 - Service Access</h1><div class=lead>Pigsty uses HAProxy to provide service access, with optional pgBouncer for connection pooling, and optional L2 VIP and DNS access.</div><blockquote><p>Split read and write operations, route traffic correctly, and deliver PostgreSQL cluster capabilities reliably.</p></blockquote><p><a href=#service-overview>Service</a> is an abstraction: it represents the form in which database clusters expose their capabilities externally, encapsulating underlying cluster details.</p><p>Services are crucial for <a href=#access-services>stable access</a> in production environments, showing their value during automatic failover in <a href=/docs/concept/ha>high availability</a> clusters. <a href=#personal-users>Personal users</a> typically don&rsquo;t need to worry about this concept.</p><hr><h2 id=personal-users>Personal Users</h2><p>The concept of &ldquo;service&rdquo; is for production environments. Personal users with single-node clusters can skip the complexity and directly use instance names or IP addresses to access the database.</p><p>For example, Pigsty&rsquo;s default single-node <code>pg-meta</code>.<code>meta</code> database can be connected directly using three different users:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># Connect directly with DBA superuser</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># Connect with default business admin user</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># Connect with default read-only user via instance domain name</span>
</span></span></code></pre></div><hr><h2 id=service-overview>Service Overview</h2><p>In real-world production environments, we use primary-replica database clusters based on replication. Within a cluster, one and only one instance serves as the leader (<a href=/docs/pgsql/config#primary>primary</a>) that can accept writes.
Other instances (<a href=/docs/pgsql/config#replica>replicas</a>) continuously fetch change logs from the cluster leader to stay synchronized. Replicas can also handle read-only requests, significantly offloading the primary in read-heavy, write-light scenarios.
Therefore, distinguishing write requests from read-only requests is a common practice.</p><p>Additionally, for production environments with high-frequency, short-lived connections, we pool requests through connection pool middleware (Pgbouncer) to reduce connection and backend process creation overhead. However, for scenarios like ETL and change execution, we need to bypass the connection pool and directly access the database.
Meanwhile, high-availability clusters may undergo failover during failures, causing cluster leadership changes. Therefore, high-availability database solutions require write traffic to automatically adapt to cluster leadership changes.
These varying access needs (read-write separation, pooled vs. direct connections, failover auto-adaptation) ultimately lead to the abstraction of the <strong>Service</strong> concept.</p><p>Typically, database clusters must provide this most basic service:</p><ul><li><strong>Read-write service (primary)</strong>: Can read from and write to the database</li></ul><p>For production database clusters, at least these two services should be provided:</p><ul><li><strong>Read-write service (primary)</strong>: Write data: Can only be served by the primary.</li><li><strong>Read-only service (replica)</strong>: Read data: Can be served by replicas; falls back to primary when no replicas are available</li></ul><p>Additionally, depending on specific business scenarios, there may be other services, such as:</p><ul><li><strong>Default direct service (default)</strong>: Allows (admin) users to bypass the connection pool and directly access the database</li><li><strong>Offline replica service (offline)</strong>: Dedicated replica not serving online read traffic, used for ETL and analytical queries</li><li><strong>Sync replica service (standby)</strong>: Read-only service with no replication delay, handled by <a href=/docs/pgsql/config#sync-standby>synchronous standby</a>/primary for read queries</li><li><strong>Delayed replica service (delayed)</strong>: Access data from the same cluster as it was some time ago, handled by <a href=/docs/pgsql/config#delayed-cluster>delayed replicas</a></li></ul><hr><h2 id=access-services>Access Services</h2><p>Pigsty&rsquo;s service delivery boundary stops at the cluster&rsquo;s HAProxy. Users can access these load balancers through various means.</p><p>The typical approach is to use DNS or VIP access, binding them to all or any number of load balancers in the cluster.</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>You can use different host & port combinations, which provide PostgreSQL service in different ways.</p><p><strong>Host</strong></p><table><thead><tr><th>Type</th><th>Sample</th><th>Description</th></tr></thead><tbody><tr><td>Cluster Domain Name</td><td><code>pg-test</code></td><td>Access via cluster domain name (resolved by dnsmasq @ infra nodes)</td></tr><tr><td>Cluster VIP Address</td><td><code>10.10.10.3</code></td><td>Access via L2 VIP address managed by <code>vip-manager</code>, bound to primary node</td></tr><tr><td>Instance Hostname</td><td><code>pg-test-1</code></td><td>Access via any instance hostname (resolved by dnsmasq @ infra nodes)</td></tr><tr><td>Instance IP Address</td><td><code>10.10.10.11</code></td><td>Access any instance&rsquo;s IP address</td></tr></tbody></table><p><strong>Port</strong></p><p>Pigsty uses different <strong>ports</strong> to distinguish <a href=#service-overview>pg services</a></p><table><thead><tr><th>Port</th><th>Service</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>Database</td><td>Direct access to postgres server</td></tr><tr><td>6432</td><td>pgbouncer</td><td>Middleware</td><td>Access postgres through connection pool middleware</td></tr><tr><td>5433</td><td>primary</td><td>Service</td><td>Access primary pgbouncer (or postgres)</td></tr><tr><td>5434</td><td>replica</td><td>Service</td><td>Access replica pgbouncer (or postgres)</td></tr><tr><td>5436</td><td>default</td><td>Service</td><td>Access primary postgres</td></tr><tr><td>5438</td><td>offline</td><td>Service</td><td>Access offline postgres</td></tr></tbody></table><p><strong>Combinations</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Access via cluster domain</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; primary direct connection</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; primary connection pool -&gt; primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; primary connection pool -&gt; primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; replica connection pool -&gt; replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; primary direct connection (for admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; offline direct connection (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Access via cluster VIP directly</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; primary direct access</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; primary connection pool -&gt; primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; primary connection pool -&gt; primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; replica connection pool -&gt; replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; primary direct connection (for admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; offline direct connection (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Directly specify any cluster instance name</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; database instance direct connection (singleton access)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; connection pool -&gt; database</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; connection pool -&gt; database read/write</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; connection pool -&gt; database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; database direct connection</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; database offline read/write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Directly specify any cluster instance IP access</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># Database instance direct connection (directly specify instance, no automatic traffic distribution)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># Connection pool -&gt; database</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; connection pool -&gt; database read/write</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; connection pool -&gt; database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; database direct connection</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; database offline read-write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Smart client: read/write separation via URL</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Email - Vonng" aria-label="Email - Vonng"><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label="Email - Vonng"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=WeChat aria-label=WeChat><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=WeChat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Discussion aria-label=Discussion><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=Discussion><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Repo aria-label=Repo><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=Repo><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>