<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.io/docs/pgsql/misc/><link rel=alternate type=application/rss+xml href=https://pigsty.io/docs/pgsql/misc/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Misc | PIGSTY</title><meta name=description content="Miscellaneous Topics"><meta property="og:url" content="https://pigsty.io/docs/pgsql/misc/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="Misc"><meta property="og:description" content="Miscellaneous Topics"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Misc"><meta itemprop=description content="Miscellaneous Topics"><meta itemprop=dateModified content="2026-01-08T18:48:49+08:00"><meta itemprop=keywords content="Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="Misc"><meta name=twitter:description content="Miscellaneous Topics"><link rel=preload href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css as=style integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><link href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css rel=stylesheet integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Ver</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.cc>Pigsty 中文网站</a></li><li><a class=dropdown-item href=https://doc.pgsty.com>Pigsty v3.7 Doc</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc>Pigsty v3.4 Doc</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 Doc</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 Doc</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch Language / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d757e151050fd40088751a74721d74f6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:window.location.href="https://pigsty.cc"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/pgsql/misc/>Return to the regular view of this page</a>.</p></div><h1 class=title>Misc</h1><div class=lead>Miscellaneous Topics</div><ul><li>1: <a href=#pg-3a18781032fdda789d5f38d1dd1c01a2>Service / Access</a></li><li>2: <a href=#pg-4d65100b9600fb960eb0de13b0e7c894>User / Role</a></li><li>3: <a href=#pg-e73c12463833eb5e14e27191b7858ef7>Database</a></li><li>4: <a href=#pg-ba271faa49ebb08213e3b4f058522cdb>Authentication / HBA</a></li><li>5: <a href=#pg-0b7772f5fffba0123e7353706362f45e>Access Control</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-3a18781032fdda789d5f38d1dd1c01a2>1 - Service / Access</h1><div class=lead>Separate read and write operations, route traffic correctly, and deliver PostgreSQL cluster capabilities reliably.</div><blockquote><p>Separate read and write operations, route traffic correctly, and deliver PostgreSQL cluster capabilities reliably.</p></blockquote><p><a href=#service-overview>Service</a> is an abstraction: it is the form in which database clusters provide capabilities to the outside world and encapsulates the details of the underlying cluster.</p><p>Services are critical for <a href=#accessing-services>stable access</a> in production environments and show their value when <a href=/docs/concept/ha>high availability</a> clusters automatically fail over. <a href=#single-node-users>Single-node users</a> typically don&rsquo;t need to worry about this concept.</p><hr><h2 id=single-node-users>Single-Node Users</h2><p>The concept of &ldquo;service&rdquo; is for production environments. Personal users/single-node clusters can simply access the database directly using instance name/IP address.</p><p>For example, Pigsty&rsquo;s default single-node <code>pg-meta</code>.<code>meta</code> database can be connected directly using three different users:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># Connect directly with DBA superuser</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># Connect with default business admin user</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># Connect with default read-only user via instance domain name</span>
</span></span></code></pre></div><hr><h2 id=service-overview>Service Overview</h2><p>In real-world production environments, we use replication-based primary-replica database clusters. In a cluster, there is one and only one instance as the leader (<a href=/docs/pgsql/config#primary>primary</a>) that can accept writes.
Other instances (<a href=/docs/pgsql/config#replica>replicas</a>) continuously fetch change logs from the cluster leader and stay consistent with it. At the same time, replicas can also handle read-only requests, significantly reducing the load on the primary in read-heavy scenarios.
Therefore, separating write requests and read-only requests to the cluster is a very common practice.</p><p>In addition, for production environments with high-frequency short connections, we also pool requests through a connection pool middleware (Pgbouncer) to reduce the overhead of creating connections and backend processes. But for scenarios such as ETL and change execution, we need to bypass the connection pool and access the database directly.
At the same time, high-availability clusters will experience failover when failures occur, and failover will cause changes to the cluster&rsquo;s leader. Therefore, high-availability database solutions require that write traffic can automatically adapt to changes in the cluster&rsquo;s leader.
These different access requirements (read-write separation, pooling and direct connection, automatic failover adaptation) ultimately abstract the concept of <strong>Service</strong>.</p><p>Typically, database clusters must provide this most basic service:</p><ul><li><strong>Read-Write Service (primary)</strong>: Can read and write to the database</li></ul><p>For production database clusters, at least these two services should be provided:</p><ul><li><strong>Read-Write Service (primary)</strong>: Write data: can only be carried by the primary.</li><li><strong>Read-Only Service (replica)</strong>: Read data: can be carried by replicas, or by the primary if there are no replicas</li></ul><p>In addition, depending on specific business scenarios, there may be other services, such as:</p><ul><li><strong>Default Direct Service (default)</strong>: Allows (admin) users to access the database directly, bypassing the connection pool</li><li><strong>Offline Replica Service (offline)</strong>: Dedicated replicas that do not handle online read-only traffic, used for ETL and analytical queries</li><li><strong>Standby Replica Service (standby)</strong>: Read-only service without replication lag, handled by <a href=/docs/pgsql/config#sync-standby>sync standby</a>/primary for read-only queries</li><li><strong>Delayed Replica Service (delayed)</strong>: Access old data from the same cluster at a previous point in time, handled by <a href=/docs/pgsql/config#delayed-cluster>delayed replica</a></li></ul><hr><h2 id=default-services>Default Services</h2><p>Pigsty provides four different services by default for each PostgreSQL database cluster. Here are the default services and their definitions:</p><table><thead><tr><th>Service</th><th>Port</th><th>Description</th></tr></thead><tbody><tr><td><a href=#primary-service>primary</a></td><td>5433</td><td>Production read-write, connects to primary connection pool (6432)</td></tr><tr><td><a href=#replica-service>replica</a></td><td>5434</td><td>Production read-only, connects to replica connection pool (6432)</td></tr><tr><td><a href=#default-service>default</a></td><td>5436</td><td>Admin, ETL writes, direct access to primary (5432)</td></tr><tr><td><a href=#offline-service>offline</a></td><td>5438</td><td>OLAP, ETL, personal users, interactive queries</td></tr></tbody></table><p>Taking the default <code>pg-meta</code> cluster as an example, it provides four default services:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5433/meta   <span style=color:#8f5902;font-style:italic># pg-meta-primary : production read-write via primary pgbouncer(6432)</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5434/meta   <span style=color:#8f5902;font-style:italic># pg-meta-replica : production read-only via replica pgbouncer(6432)</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@pg-meta:5436/meta     <span style=color:#8f5902;font-style:italic># pg-meta-default : direct connection via primary postgres(5432)</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_stats:DBUser.Stats@pg-meta:5438/meta <span style=color:#8f5902;font-style:italic># pg-meta-offline : direct connection via offline postgres(5432)</span>
</span></span></code></pre></div><p>You can see how these four services work from the sample cluster <a href=/docs/pgsql/config>architecture diagram</a>:</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>Note that the <code>pg-meta</code> domain name points to the cluster&rsquo;s L2 VIP, which in turn points to the haproxy load balancer on the cluster primary, which routes traffic to different instances. See <a href=#accessing-services>Accessing Services</a> for details.</p><hr><h2 id=service-implementation>Service Implementation</h2><p>In Pigsty, services are implemented using <a href=/docs/node/param#haproxy>haproxy</a> on <a href=/docs/node>nodes</a>, differentiated by different ports on host nodes.</p><p>Haproxy is enabled by default on each node managed by Pigsty to expose services, and database nodes are no exception.
Although nodes in a cluster have primary-replica distinctions from the database perspective, from the service perspective, each node is the same:
This means that even if you access a replica node, as long as you use the correct service port, you can still use the primary&rsquo;s read-write service.
This design can hide complexity: so as long as you can access any instance on a PostgreSQL cluster, you can completely access all services.</p><p>This design is similar to NodePort services in Kubernetes. Similarly, in Pigsty, each service includes the following two core elements:</p><ol><li>Access endpoints exposed through NodePort (port number, where to access?)</li><li>Target instances selected through Selectors (instance list, who carries the load?)</li></ol><p>Pigsty&rsquo;s service delivery boundary stops at the cluster&rsquo;s HAProxy, and users can access these load balancers in various ways. See <a href=#accessing-services>Accessing Services</a>.</p><p>All services are declared through configuration files. For example, the PostgreSQL default services are defined by the <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> parameter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can also define additional services in <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>. Both <code>pg_default_services</code> and <code>pg_services</code> are arrays of <a href=#defining-services>service definition</a> objects.</p><hr><h2 id=defining-services>Defining Services</h2><p>Pigsty allows you to define your own services:</p><ul><li><a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a>: Services uniformly exposed by all PostgreSQL clusters, four by default.</li><li><a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>: Additional PostgreSQL services, can be defined at global or cluster level as needed.</li><li><a href=/docs/node/param#haproxy_services><code>haproxy_services</code></a>: Directly customize HAProxy service content, can be used for accessing other components</li></ul><p>For PostgreSQL clusters, you typically only need to focus on the first two.
Each service definition generates a new configuration file in the configuration directory of all related HAProxy instances: <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/service.j2><code>/etc/haproxy/&lt;svcname>.cfg</code></a>
Here&rsquo;s a custom service example <code>standby</code>: when you want to provide a read-only service without replication lag, you can add this record to <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name: standby                   # Required, service name, final svc name uses `pg_cluster` as prefix, e.g.</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># Required, exposed service port (as kubernetes service node port mode)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># Optional, IP address the service binds to, all IP addresses by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># Required, service member selector, uses JMESPath to filter configuration manifest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Optional, service member selector (backup), instances selected here only carry the service when all default selector instances are down</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, target port, default|postgres|pgbouncer|&lt;port_number&gt;, defaults to &#39;default&#39;, Default means using pg_default_service_dest value to ultimately decide</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>check: /sync                    # Optional, health check URL path, defaults to /, here uses Patroni API</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync, only sync standby and primary return 200 healthy status code</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, maximum number of allowed frontend connections, defaults to 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>balance: roundrobin             # Optional, haproxy load balancing algorithm (defaults to roundrobin, other options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>leastconn)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The above service definition will be converted to haproxy configuration file <code>/etc/haproxy/pg-test-standby.conf</code> on the sample three-node <code>pg-test</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service: pg-test-standby @ 10.10.10.11:5435</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service instances 10.10.10.11, 10.10.10.13, 10.10.10.12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service backups   10.10.10.11</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>listen pg-test-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5435           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Binds port 5435 on all IP addresses</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Load balancer works on TCP protocol</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Maximum connections 5000, can be increased as needed</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Load balancing algorithm is rr round-robin, can also use leastconn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Enable HTTP health check</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Keep HTTP connection</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /sync  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- Here uses /sync, Patroni health check API, only sync standby and primary return 200 healthy status code</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- Health check return code 200 means normal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers: # All three instances of pg-test cluster are selected by selector: &#34;[]&#34;, since there are no filter conditions, they all become backend servers for pg-test-replica service. But due to /sync health check, only primary and sync standby can actually handle requests</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;----- Only primary satisfies condition pg_role == `primary`, selected by backup selector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100         #        Therefore serves as service fallback instance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>normally doesn&#39;t handle requests, only handles read-only requests when all other replicas fail, thus maximally avoiding read-write service being affected by read-only service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Here, all three instances of the <code>pg-test</code> cluster are selected by <code>selector: "[]"</code>, rendered into the backend server list of the <code>pg-test-replica</code> service. But due to the <code>/sync</code> health check, Patroni Rest API only returns healthy HTTP 200 status code on the primary and <a href=/docs/pgsql/config#sync-standby>sync standby</a>, so only the primary and sync standby can actually handle requests.
Additionally, the primary satisfies the condition <code>pg_role == primary</code>, is selected by the backup selector, and is marked as a backup server, only used when no other instances (i.e., sync standby) can meet the demand.</p><hr><h2 id=primary-service>Primary Service</h2><p>The Primary service is perhaps the most critical service in production environments. It provides read-write capability to the database cluster on port 5433. The service definition is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>The selector parameter <code>selector: "[]"</code> means all cluster members will be included in the Primary service</li><li>But only the primary can pass the health check (<code>check: /primary</code>) and actually carry Primary service traffic.</li><li>The destination parameter <code>dest: default</code> means the Primary service destination is affected by the <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> parameter</li><li>The default value <code>default</code> of <code>dest</code> will be replaced by the value of <code>pg_default_service_dest</code>, which defaults to <code>pgbouncer</code>.</li><li>By default, the Primary service destination is the connection pool on the primary, which is the port specified by <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a>, defaulting to 6432</li></ul><p>If the value of <code>pg_default_service_dest</code> is <code>postgres</code>, then the primary service destination will bypass the connection pool and use the PostgreSQL database port directly (<a href=/docs/pgsql/param#pg_port><code>pg_port</code></a>, default 5432). This parameter is very useful for scenarios that don&rsquo;t want to use a connection pool.</p><details><summary>Example: haproxy configuration for pg-test-primary</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>listen pg-test-primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5433        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary service defaults to port 5433</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /primary</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary service defaults to Patroni RestAPI /primary health check</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><p>Patroni&rsquo;s <a href=/docs/concept/ha>high availability</a> mechanism ensures that at most one instance&rsquo;s <code>/primary</code> health check is true at any time, so the Primary service will always route traffic to the primary instance.</p><p>One benefit of using the Primary service instead of direct database connection is that if the cluster has a split-brain situation for some reason (e.g., kill -9 killing the primary Patroni without watchdog), Haproxy can still avoid split-brain in this case, because it will only distribute traffic when Patroni is alive and returns primary status.</p><hr><h2 id=replica-service>Replica Service</h2><p>The Replica service is second only to the Primary service in importance in production environments. It provides read-only capability to the database cluster on port 5434. The service definition is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>The selector parameter <code>selector: "[]"</code> means all cluster members will be included in the Replica service</li><li>All instances can pass the health check (<code>check: /read-only</code>) and carry Replica service traffic.</li><li>Backup selector: <code>[? pg_role == 'primary' || pg_role == 'offline' ]</code> marks the primary and <a href=/docs/pgsql/config#offline-replica>offline replicas</a> as backup servers.</li><li>Only when all <a href=/docs/pgsql/config#replica>normal replicas</a> are down will the Replica service be carried by the primary or offline replicas.</li><li>The destination parameter <code>dest: default</code> means the Replica service destination is also affected by the <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> parameter</li><li>The default value <code>default</code> of <code>dest</code> will be replaced by the value of <code>pg_default_service_dest</code>, which defaults to <code>pgbouncer</code>, same as the <a href=#primary-service>Primary service</a></li><li>By default, the Replica service destination is the connection pool on the replicas, which is the port specified by <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a>, defaulting to 6432</li></ul><details><summary>Example: haproxy configuration for pg-test-replica</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5434</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /read-only</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><p>The Replica service is very flexible: if there are surviving dedicated Replica instances, it will prioritize using these instances to handle read-only requests. Only when all replica instances are down will the primary handle read-only requests. For the common one-primary-one-replica two-node cluster, this means: use the replica as long as it&rsquo;s alive, use the primary when the replica is down.</p><p>Additionally, unless all dedicated read-only instances are down, the Replica service will not use dedicated Offline instances, thus avoiding mixing online fast queries and offline slow queries together, interfering with each other.</p><hr><h2 id=default-service>Default Service</h2><p>The Default service provides services on port 5436. It is a variant of the Primary service.</p><p>The Default service always bypasses the connection pool and connects directly to PostgreSQL on the primary. This is useful for admin connections, ETL writes, CDC data change capture, etc.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If <code>pg_default_service_dest</code> is changed to <code>postgres</code>, then the Default service is completely equivalent to the Primary service except for port and name. In this case, you can consider removing Default from default services.</p><details><summary>Example: haproxy configuration for pg-test-default</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-default</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5436         # &lt;--- Except for listening port/target port and service name, other configurations are exactly the same as primary service</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><hr><h2 id=offline-service>Offline Service</h2><p>The Offline service provides services on port 5438. It also bypasses the connection pool to directly access the PostgreSQL database, typically used for slow queries/analytical queries/ETL reads/personal user interactive queries. Its service definition is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The Offline service routes traffic directly to dedicated <a href=/docs/pgsql/config#offline-replica>offline replicas</a>, or normal <a href=/docs/pgsql/config#replica>read-only instances</a> with the <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> flag.</p><ul><li>The selector parameter filters two types of instances from the cluster: offline replicas with <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code>, or normal <a href=/docs/pgsql/config#replica>read-only instances</a> with <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code></li><li>The main difference between dedicated offline replicas and flagged normal replicas is: the former does not handle <a href=#replica-service>Replica service</a> requests by default, avoiding mixing fast and slow requests together, while the latter does by default.</li><li>The backup selector parameter filters one type of instance from the cluster: normal replicas without offline flag. This means if offline instances or flagged normal replicas fail, other normal replicas can be used to carry the Offline service.</li><li>The health check <code>/replica</code> only returns 200 for replicas, the primary returns an error, so the Offline service will never distribute traffic to the primary instance, even if only this primary is left in the cluster.</li><li>At the same time, the primary instance is neither selected by the selector nor by the backup selector, so it will never carry the Offline service. Therefore, the Offline service can always avoid user access to the primary, thus avoiding impact on the primary.</li></ul><details><summary>Example: haproxy configuration for pg-test-offline</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-offline</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5438</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100 backup</span>
</span></span></code></pre></div></details><p>The Offline service provides limited read-only service, typically used for two types of queries: interactive queries (personal users), slow queries and long transactions (analytics/ETL).</p><p>The Offline service requires extra maintenance care: when the cluster experiences primary-replica switchover or automatic failover, the cluster&rsquo;s instance roles change, but Haproxy&rsquo;s configuration does not automatically change. For clusters with multiple replicas, this is usually not a problem.
However, for simplified small clusters with one primary and one replica running Offline queries, primary-replica switchover means the replica becomes the primary (health check fails), and the original primary becomes a replica (not in the Offline backend list), so no instance can carry the Offline service. Therefore, you need to manually <a href=/docs/pgsql/admin#reload-services>reload services</a> to make the changes effective.</p><p>If your business model is relatively simple, you can consider removing the Default service and Offline service, and use the Primary service and Replica service to connect directly to the database.</p><hr><h2 id=reload-services>Reload Services</h2><p>When cluster members change, such as adding/removing replicas, primary-replica switchover, or adjusting relative weights, you need to <a href=/docs/pgsql/admin#reload-services>reload services</a> to make the changes effective.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ip...<span style=color:#ce5c00;font-weight:700>]</span>         <span style=color:#8f5902;font-style:italic># Reload services for lb cluster or lb instance</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ./pgsql.yml -t pg_service         # Actual ansible task for reloading services</span>
</span></span></code></pre></div><hr><h2 id=accessing-services>Accessing Services</h2><p>Pigsty&rsquo;s service delivery boundary stops at the cluster&rsquo;s HAProxy. Users can access these load balancers in various ways.</p><p>The typical approach is to use DNS or VIP access, binding them to all or any number of load balancers in the cluster.</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>You can use different host & port combinations, which provide PostgreSQL services in different ways.</p><p><strong>Host</strong></p><table><thead><tr><th>Type</th><th>Example</th><th>Description</th></tr></thead><tbody><tr><td>Cluster Domain</td><td><code>pg-test</code></td><td>Access via cluster domain name (resolved by dnsmasq @ infra node)</td></tr><tr><td>Cluster VIP Address</td><td><code>10.10.10.3</code></td><td>Access via L2 VIP address managed by <code>vip-manager</code>, bound to primary node</td></tr><tr><td>Instance Hostname</td><td><code>pg-test-1</code></td><td>Access via any instance hostname (resolved by dnsmasq @ infra node)</td></tr><tr><td>Instance IP Address</td><td><code>10.10.10.11</code></td><td>Access any instance&rsquo;s IP address</td></tr></tbody></table><p><strong>Port</strong></p><p>Pigsty uses different <strong>ports</strong> to distinguish <a href=#service-overview>pg services</a></p><table><thead><tr><th>Port</th><th>Service</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>Database</td><td>Direct access to postgres server</td></tr><tr><td>6432</td><td>pgbouncer</td><td>Middleware</td><td>Access postgres via connection pool middleware</td></tr><tr><td>5433</td><td>primary</td><td>Service</td><td>Access primary pgbouncer (or postgres)</td></tr><tr><td>5434</td><td>replica</td><td>Service</td><td>Access replica pgbouncer (or postgres)</td></tr><tr><td>5436</td><td>default</td><td>Service</td><td>Access primary postgres</td></tr><tr><td>5438</td><td>offline</td><td>Service</td><td>Access offline postgres</td></tr></tbody></table><p><strong>Combinations</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Access via cluster domain name</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; Primary direct connection</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; Primary connection pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Primary connection pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Replica connection pool -&gt; Replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Primary direct connection (for admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Offline direct connection (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Direct access via cluster VIP</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; Primary direct access</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; Primary connection pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Primary connection pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Replica connection pool -&gt; Replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Primary direct connection (for admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Offline direct connection (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify any cluster instance name directly</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; Database instance direct connection (single instance access)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; Connection pool -&gt; Database</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; Connection pool -&gt; Database read/write</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; Connection pool -&gt; Database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; Database direct connection</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; Database offline read/write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify any cluster instance IP directly</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># Database instance direct connection (direct instance specification, no automatic traffic distribution)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># Connection pool -&gt; Database</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; Connection pool -&gt; Database read/write</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; Connection pool -&gt; Database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; Database direct connection</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; Database offline read-write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Smart client: automatic read-write separation</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div><hr><h2 id=overriding-services>Overriding Services</h2><p>You can override default service configuration in multiple ways. A common requirement is to have <a href=#primary-service>Primary service</a> and <a href=#replica-service>Replica service</a> bypass the Pgbouncer connection pool and access the PostgreSQL database directly.</p><p>To achieve this, you can change <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> to <code>postgres</code>, so all services with <code>svc.dest='default'</code> in their service definitions will use <code>postgres</code> instead of the default <code>pgbouncer</code> as the target.</p><p>If you have already pointed <a href=#primary-service>Primary service</a> to PostgreSQL, then <a href=#default-service>default service</a> becomes redundant and can be considered for removal.</p><p>If you don&rsquo;t need to distinguish between personal interactive queries and analytical/ETL slow queries, you can consider removing <a href=#offline-service>Offline service</a> from the default service list <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a>.</p><p>If you don&rsquo;t need read-only replicas to share online read-only traffic, you can also remove <a href=#replica-service>Replica service</a> from the default service list.</p><hr><h2 id=delegating-services>Delegating Services</h2><p>Pigsty exposes PostgreSQL services through haproxy on nodes. All haproxy instances in the entire cluster are configured with the same <a href=#defining-services>service definitions</a>.</p><p>However, you can delegate pg services to specific node groups (e.g., dedicated haproxy load balancer cluster) instead of haproxy on PostgreSQL cluster members.</p><p>To do this, you need to override the default service definitions using <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> and set <a href=/docs/pgsql/param#pg_service_provider><code>pg_service_provider</code></a> to the proxy group name.</p><p>For example, this configuration will expose the pg cluster&rsquo;s primary service on the <code>proxy</code> haproxy node group on port 10013.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>proxy      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use load balancer from `proxy` group on port 10013</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 10013 ,dest: postgres  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Users need to ensure that the port for each delegated service is <strong>unique</strong> in the proxy cluster.</p><p>An example of using a dedicated load balancer cluster is provided in the 43-node production environment simulation <a href=/docs/deploy/sandbox><strong>sandbox</strong></a>: <a href=https://github.com/pgsty/pigsty/blob/main/conf/prod.yml#L111>prod.yml</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4d65100b9600fb960eb0de13b0e7c894>2 - User / Role</h1><div class=lead>Users/roles refer to logical objects within a database cluster created using the SQL commands <code>CREATE USER/ROLE</code>.</div><blockquote><p>In this context, users refer to logical objects within a database cluster created using the SQL commands <code>CREATE USER/ROLE</code>.</p></blockquote><p>In PostgreSQL, users belong directly to the database cluster rather than to a specific database. Therefore, when creating business databases and business users, you should follow the principle of &ldquo;users first, then databases.&rdquo;</p><hr><h2 id=defining-users>Defining Users</h2><p>Pigsty defines roles and users in database clusters through two configuration parameters:</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>: Defines globally unified roles and users</li><li><a href=/docs/pgsql/param#pg_users><code>pg_users</code></a>: Defines business users and roles at the database cluster level</li></ul><p>The former defines roles and users shared across the entire environment, while the latter defines business roles and users specific to individual clusters. Both have the same format and are arrays of user definition objects.</p><p>You can define multiple users/roles, and they will be created sequentially—first global, then cluster-level, and finally in array order—so later users can belong to roles defined earlier.</p><p>Here is the business user definition for the default cluster <code>pg-meta</code> in the Pigsty demo environment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_noco     ,password: DBUser.Noco     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for nocodb service      }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Each user/role definition is an object that may include the following fields. Using <code>dbuser_meta</code> as an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Required, `name` is the only mandatory field in user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, password can be scram-sha-256 hash string or plaintext</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Optional, can login by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Optional, default is false, is this a superuser?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, default is false, can create databases?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Optional, default is false, can create roles?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, by default this role can use inherited privileges?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Optional, default is false, can this role perform replication?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Optional, default is false, can this role bypass row-level security?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, default is false, add this user to pgbouncer user list? (production users using connection pool should explicitly set to true)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, user connection limit, default -1 disables limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in: 3650                 # Optional, this role expires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>calculated from creation + n days (higher priority than expire_at)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Optional, when this role expires, use YYYY-MM-DD format string to specify a date (lower priority than expire_in)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, description and comment string for this user/role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles: [dbrole_admin]           # Optional, default roles are</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_{admin,readonly,readwrite,offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># Optional, use `ALTER ROLE SET` to configure role-level database parameters for this role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, pgbouncer pool mode defaulting to transaction, user level</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Optional, user-level maximum database connections, default -1 disables limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, key-value configuration parameters per postgresql documentation (e.g., use pigsty as default search_path)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>The only required field is <code>name</code>, which should be a valid and unique username in the PostgreSQL cluster.</li><li>Roles don&rsquo;t need a <code>password</code>, but for loginable business users, a password is usually required.</li><li><code>password</code> can be plaintext or scram-sha-256 / md5 hash string; please avoid using plaintext passwords.</li><li>Users/roles are created one by one in array order, so ensure roles/groups are defined before their members.</li><li><code>login</code>, <code>superuser</code>, <code>createdb</code>, <code>createrole</code>, <code>inherit</code>, <code>replication</code>, <code>bypassrls</code> are boolean flags.</li><li><code>pgbouncer</code> is disabled by default: to add business users to the pgbouncer user list, you should explicitly set it to <code>true</code>.</li></ul><p><strong>ACL System</strong></p><p>Pigsty has a built-in, out-of-the-box access control / <a href=/docs/concept/sec/ac/#default-roles>ACL</a> system. You can easily use it by simply assigning the following four default roles to business users:</p><ul><li><code>dbrole_readwrite</code>: Role with global read-write access (production accounts primarily used by business should have database read-write privileges)</li><li><code>dbrole_readonly</code>: Role with global read-only access (if other businesses need read-only access, use this role)</li><li><code>dbrole_admin</code>: Role with DDL privileges (business administrators, scenarios requiring table creation in applications)</li><li><code>dbrole_offline</code>: Restricted read-only access role (can only access <a href=/docs/pgsql/config#offline-replica>offline</a> instances, typically for individual users)</li></ul><p>If you want to redesign your own ACL system, consider customizing the following parameters and templates:</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>: System-wide roles and global users</li><li><a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a>: Default privileges for newly created objects</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-role.sql><code>roles/pgsql/templates/pg-init-role.sql</code></a>: Role creation SQL template</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>roles/pgsql/templates/pg-init-template.sql</code></a>: Privilege SQL template</li></ul><hr><h2 id=creating-users>Creating Users</h2><p>Users and roles <a href=#defining-users>defined</a> in <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> and <a href=/docs/pgsql/param#pg_users><code>pg_users</code></a> are automatically created one by one during the cluster initialization PROVISION phase.
If you want to <a href=/docs/pgsql/admin#create-user>create users</a> on an existing cluster, you can use the <code>bin/pgsql-user</code> tool.
Add the new user/role definition to <code>all.children.&lt;cls>.pg_users</code> and use the following method to create the user:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>Unlike databases, the user creation playbook is always idempotent. When the target user already exists, Pigsty will modify the target user&rsquo;s attributes to match the configuration. So running it repeatedly on existing clusters is usually not a problem.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Please Use Playbooks to Create Users</div><p>We don&rsquo;t recommend manually creating new business users, especially when you want the user to use the default pgbouncer connection pool: unless you&rsquo;re willing to manually maintain the user list in Pgbouncer and keep it consistent with PostgreSQL.
When creating new users with <strong><code>bin/pgsql-user</code></strong> tool or <a href=/docs/pgsql/playbook#pgsql-useryml><strong><code>pgsql-user.yml</code></strong></a> playbook, the user will also be added to the <a href=#pgbouncer-users>Pgbouncer Users</a> list.</p></div><hr><h2 id=modifying-users>Modifying Users</h2><p>The method for modifying PostgreSQL user attributes is the same as <a href=#creating-users><strong>Creating Users</strong></a>.</p><p>First, adjust your user definition, modify the attributes that need adjustment, then execute the following command to apply:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>Note that modifying users will not delete users, but modify user attributes through the <code>ALTER USER</code> command; it also won&rsquo;t revoke user privileges and groups, and will use the <code>GRANT</code> command to grant new roles.</p><hr><h2 id=pgbouncer-users>Pgbouncer Users</h2><p>Pgbouncer is enabled by default and serves as a connection pool middleware, with its users managed by default.</p><p>Pigsty adds all users in <a href=/docs/pgsql/param#pg_users><code>pg_users</code></a> that explicitly have the <code>pgbouncer: true</code> flag to the pgbouncer user list.</p><p>Users in the Pgbouncer connection pool are listed in <code>/etc/pgbouncer/userlist.txt</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>&#34;postgres&#34; &#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_wiki&#34; &#34;SCRAM-SHA-256$4096:+77dyhrPeFDT/TptHs7/7Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$KeatuohpKIYzHPCt/tqBu85vI11o9mar/by0hHYM2W8=:X9gig4JtjoS8Y/o1vQsIX/gY1Fns8ynTXkbWOjUfbRQ=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_view&#34; &#34;SCRAM-SHA-256$4096:DFoZHU/DXsHL8MJ8regdEw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$gx9sUGgpVpdSM4o6A2R9PKAUkAsRPLhLoBDLBUYtKS0=:MujSgKe6rxcIUMv4GnyXJmV0YNbf39uFRZv724+X1FE=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_monitor&#34; &#34;SCRAM-SHA-256$4096:fwU97ZMO/KR0ScHO5+UuBg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$CrNsmGrx1DkIGrtrD1Wjexb/aygzqQdirTO1oBZROPY=:L8+dJ+fqlMQh7y4PmVR/gbAOvYWOr+KINjeMZ8LlFww=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_meta&#34; &#34;SCRAM-SHA-256$4096:leB2RQPcw1OIiRnPnOMUEg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$eyC+NIMKeoTxshJu314+BmbMFpCcspzI3UFZ1RYfNyU=:fJgXcykVPvOfro2MWNkl5q38oz21nSl1dTtM65uYR1Q=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_kong&#34; &#34;SCRAM-SHA-256$4096:bK8sLXIieMwFDz67/0dqXQ</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$P/tCRgyKx9MC9LH3ErnKsnlOqgNd/nn2RyvThyiK6e4=:CDM8QZNHBdPf97ztusgnE7olaKDNHBN0WeAbP/nzu5A=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_grafana&#34; &#34;SCRAM-SHA-256$4096:HjLdGaGmeIAGdWyn2gDt/Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$jgoyOB8ugoce+Wqjr0EwFf8NaIEMtiTuQTg1iEJs9BM=:ed4HUFqLyB4YpRr+y25FBT7KnlFDnan6JPVT9imxzA4=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_gitea&#34; &#34;SCRAM-SHA-256$4096:l1DBGCc4dtircZ8O8Fbzkw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$tpmGwgLuWPDog8IEKdsaDGtiPAxD16z09slvu+rHE74=:pYuFOSDuWSofpD9OZhG7oWvyAR0PQjJBffgHZLpLHds=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_dba&#34; &#34;SCRAM-SHA-256$4096:zH8niABU7xmtblVUo2QFew</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$Zj7/pq+ICZx7fDcXikiN7GLqkKFA+X5NsvAX6CMshF0=:pqevR2WpizjRecPIQjMZOm+Ap+x0kgPL2Iv5zHZs0+g=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_bytebase&#34; &#34;SCRAM-SHA-256$4096:OMoTM9Zf8QcCCMD0svK5gg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$kMchqbf4iLK1U67pVOfGrERa/fY818AwqfBPhsTShNQ=:6HqWteN+AadrUnrgC0byr5A72noqnPugItQjOLFw0Wk=&#34;</span>
</span></span></code></pre></div><p>User-level connection pool parameters are maintained in a separate file: <code>/etc/pgbouncer/useropts.txt</code>, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>                  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>              <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><p>When you <a href=#creating-databases>create a database</a>, the Pgbouncer database list definition file will be refreshed and take effect through online configuration reload, without affecting existing connections.</p><p>Pgbouncer runs with the same <code>dbsu</code> as PostgreSQL, which defaults to the <code>postgres</code> operating system user. You can use the <code>pgb</code> alias to access pgbouncer management functions using the dbsu.</p><p>Pigsty also provides a utility function <code>pgb-route</code> that can quickly switch pgbouncer database traffic to other nodes in the cluster, useful for zero-downtime migration:</p><p>The connection pool user configuration files <code>userlist.txt</code> and <code>useropts.txt</code> are automatically refreshed when you <a href=#creating-users>create users</a>, and take effect through online configuration reload, normally without affecting existing connections.</p><p>Note that the <a href=/docs/pgsql/param#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a> parameter allows you to use dynamic queries to complete connection pool user authentication—this is a compromise when you don&rsquo;t want to manage users in the connection pool.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e73c12463833eb5e14e27191b7858ef7>3 - Database</h1><div class=lead>Database refers to the logical object created using the SQL command <code>CREATE DATABASE</code> within a database cluster.</div><blockquote><p>In this context, Database refers to the logical object created using the SQL command <code>CREATE DATABASE</code> within a database cluster.</p></blockquote><p>A PostgreSQL server can serve multiple <strong>databases</strong> simultaneously. In Pigsty, you can <a href=#define-database>define</a> the required databases in the cluster configuration.</p><p>Pigsty will modify and customize the default template database <code>template1</code>, creating default schemas, installing default extensions, and configuring default privileges. Newly created databases will inherit these settings from <code>template1</code> by default.</p><p>By default, all business databases will be added to the Pgbouncer connection pool in a 1:1 manner; <code>pg_exporter</code> will use an <strong>auto-discovery</strong> mechanism to find all business databases and monitor objects within them.</p><hr><h2 id=define-database>Define Database</h2><p>Business databases are defined in the database cluster parameter <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a>, which is an array of database definition objects.
Databases in the array are created sequentially according to the <strong>definition order</strong>, so later defined databases can use previously defined databases as <strong>templates</strong>.</p><p>Below is the database definition for the default <code>pg-meta</code> cluster in the Pigsty demo environment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: noco     ,owner: dbuser_noco     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>nocodb database }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Each database definition is an object that may include the following fields, using the <code>meta</code> database as an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database sql baseline path (relative path among ansible search path, e.g. files/)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this database to pgbouncer database list? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, additional schemas to be created, array of schema names</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions:                     # optional, additional extensions to be installed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>array of extension objects</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># can specify which schema to install the extension in, or leave it unspecified (will install in the first schema of search_path)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># for example, some extensions create and use fixed schemas, so no schema specification is needed.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database owner, postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, which template to use, template1 by default, target must be a template database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database encoding, UTF8 by default (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database locale, C by default (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database collate, C by default (MUST same as template database), no reason not to recommend changing.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database ctype, C by default (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, default tablespace, &#39;pg_default&#39; by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, allow connection, true by default. false will disable connect at all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, revoke public connection privilege. false by default, when set to true, CONNECT privilege will be revoked from users other than owner and admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># optional, register this database to grafana datasources? true by default, explicitly set to false to skip registration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, database connection limit, default -1 disable limit, set to positive integer will limit connections</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, all connections to this pgbouncer database will be authenticated using this user (only useful when pgbouncer_auth_query is enabled)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at database level, default transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size at database level, default 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size reserve at database level, default 32, when default pool is insufficient, can request at most this many burst connections</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size min at database level, default 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_max_db_conn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># optional, max database connections at database level, default 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The only required field is <code>name</code>, which should be a valid and unique database name in the current PostgreSQL cluster, other parameters have reasonable defaults.</p><ul><li><code>name</code>: Database name, <strong>required</strong>.</li><li><code>baseline</code>: SQL file path (Ansible search path, usually in <code>files</code>), used to initialize database content.</li><li><code>owner</code>: Database owner, default is <code>postgres</code></li><li><code>template</code>: Template used when creating the database, default is <code>template1</code></li><li><code>encoding</code>: Database default character encoding, default is <code>UTF8</code>, default is consistent with the instance. It is recommended not to configure and modify.</li><li><code>locale</code>: Database default locale, default is <code>C</code>, it is recommended not to configure, keep consistent with the instance.</li><li><code>lc_collate</code>: Database default locale string collation, default is same as instance setting, it is recommended not to modify, must be consistent with template database. It is strongly recommended not to configure, or configure to <code>C</code>.</li><li><code>lc_ctype</code>: Database default LOCALE, default is same as instance setting, it is recommended not to modify or set, must be consistent with template database. It is recommended to configure to C or <code>en_US.UTF8</code>.</li><li><code>allowconn</code>: Whether to allow connection to the database, default is <code>true</code>, not recommended to modify.</li><li><code>revokeconn</code>: Whether to revoke connection privilege to the database? Default is <code>false</code>. If <code>true</code>, <code>PUBLIC CONNECT</code> privilege on the database will be revoked. Only default users (<code>dbsu|monitor|admin|replicator|owner</code>) can connect. In addition, <code>admin|owner</code> will have GRANT OPTION, can grant connection privileges to other users.</li><li><code>tablespace</code>: Tablespace associated with the database, default is <code>pg_default</code>.</li><li><code>connlimit</code>: Database connection limit, default is <code>-1</code>, meaning no limit.</li><li><code>extensions</code>: Object array, each object defines an <strong>extension</strong> in the database, and the <strong>schema</strong> in which it is installed.</li><li><code>parameters</code>: KV object, each KV defines a parameter that needs to be modified for the database through <code>ALTER DATABASE</code>.</li><li><code>pgbouncer</code>: Boolean option, whether to add this database to Pgbouncer. All databases will be added to Pgbouncer list unless explicitly specified as <code>pgbouncer: false</code>.</li><li><code>comment</code>: Database comment information.</li><li><code>pool_auth_user</code>: When <a href=/docs/pgsql/param#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a> is enabled, all connections to this pgbouncer database will use the user specified here to execute authentication queries. You need to use a user with access to the <code>pg_shadow</code> table.</li><li><code>pool_mode</code>: Database level pgbouncer pool mode, default is transaction, i.e., transaction pooling. If left empty, will use <a href=/docs/pgsql/param#pgbouncer_poolmode><code>pgbouncer_poolmode</code></a> parameter as default value.</li><li><code>pool_size</code>: Database level pgbouncer default pool size, default is 64</li><li><code>pool_size_reserve</code>: Database level pgbouncer pool size reserve, default is 32, when default pool is insufficient, can request at most this many burst connections.</li><li><code>pool_size_min</code>: Database level pgbouncer pool size min, default is 0</li><li><code>pool_max_db_conn</code>: Database level pgbouncer connection pool max database connections, default is 100</li></ul><p>Newly created databases are forked from the <code>template1</code> database by default. This template database will be customized during the <a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a> phase:
configured with extensions, schemas, and default privileges, so newly created databases will also inherit these configurations unless you explicitly use another database as a template.</p><p>For database access privileges, refer to <a href=/docs/concept/sec/ac/#database-privileges>ACL: Database Privilege</a> section.</p><hr><h2 id=create-database>Create Database</h2><p>Databases <a href=#define-database>defined</a> in <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> will be automatically created during cluster initialization.
If you wish to <a href=/docs/pgsql/admin#create-database>create database</a> on an existing cluster, you can use the <code>bin/pgsql-db</code> wrapper script.
Add new database definition to <code>all.children.&lt;cls>.pg_databases</code>, and create that database with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style=color:#8f5902;font-style:italic># pgsql-db.yml -l &lt;cls&gt; -e dbname=&lt;dbname&gt;</span>
</span></span></code></pre></div><p>Here are some considerations when creating a new database:</p><p>The create database playbook is idempotent by default, however when you use <code>baseline</code> scripts, it may not be: in this case, it&rsquo;s usually not recommended to re-run this on existing databases unless you&rsquo;re sure the provided baseline SQL is also idempotent.</p><p>We don&rsquo;t recommend manually creating new databases, especially when you&rsquo;re using the default pgbouncer connection pool: unless you&rsquo;re willing to manually maintain the Pgbouncer database list and keep it consistent with PostgreSQL.
When creating new databases using the <code>pgsql-db</code> tool or <code>pgsql-db.yml</code> playbook, this database will also be added to the <a href=#pgbouncer-database>Pgbouncer Database</a> list.</p><p>If your database definition has a non-trivial <code>owner</code> (default is dbsu <code>postgres</code>), make sure the owner user exists before creating the database.
Best practice is always to <a href=/docs/pgsql/admin#create-user>create</a> <a href=/docs/pgsql/config/user>users</a> before creating databases.</p><hr><h2 id=pgbouncer-database>Pgbouncer Database</h2><p>Pigsty will configure and enable a Pgbouncer connection pool for PostgreSQL instances in a 1:1 manner by default, communicating via <code>/var/run/postgresql</code> Unix Socket.</p><p>Connection pools can optimize short connection performance, reduce concurrency contention, avoid overwhelming the database with too many connections, and provide additional flexibility during database migration.</p><p>Pigsty adds all databases in <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> to pgbouncer&rsquo;s database list by default.
You can disable pgbouncer connection pool support for a specific database by explicitly setting <code>pgbouncer: false</code> in the database <a href=#define-database>definition</a>.</p><p>The Pgbouncer database list is defined in <code>/etc/pgbouncer/database.txt</code>, and connection pool parameters from the database definition are reflected here:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>meta                        = host=/var/run/postgresql mode=session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>grafana                     = host=/var/run/postgresql mode=transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bytebase                    = host=/var/run/postgresql auth_user=dbuser_meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>kong                        = host=/var/run/postgresql pool_size=32 reserve_pool=64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>gitea                       = host=/var/run/postgresql min_pool_size=10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>wiki                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>noco                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>mongo                       = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When you <a href=#create-database>create databases</a>, the Pgbouncer database list definition file will be refreshed and take effect through online configuration reload, normally without affecting existing connections.</p><p>Pgbouncer runs with the same <code>dbsu</code> as PostgreSQL, defaulting to the <code>postgres</code> os user. You can use the <code>pgb</code> alias to access pgbouncer management functions using dbsu.</p><p>Pigsty also provides a utility function <code>pgb-route</code>, which can quickly switch pgbouncer database traffic to other nodes in the cluster for zero-downtime migration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># route pgbouncer traffic to another cluster member</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pgb-route<span style=color:#ce5c00;font-weight:700>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>local</span> <span style=color:#000>ip</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>1</span><span style=color:#000;font-weight:700>-</span><span style=color:#4e9a06>&#39;\/var\/run\/postgresql&#39;</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>  sed -ie <span style=color:#4e9a06>&#34;s/host=[^[:space:]]\+/host=</span><span style=color:#4e9a06>${</span><span style=color:#000>ip</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ba271faa49ebb08213e3b4f058522cdb>4 - Authentication / HBA</h1><div class=lead>Detailed explanation of Host-Based Authentication (HBA) in Pigsty.</div><blockquote><p>Detailed explanation of Host-Based Authentication (HBA) in Pigsty.</p></blockquote><p>Authentication is the foundation of <a href=/docs/concept/sec/ac/>Access Control</a> and the <a href=/docs/concept/sec/ac/#privilege-system>Privilege System</a>. PostgreSQL has multiple <a href=https://www.postgresql.org/docs/current/client-authentication.html>authentication</a> methods.</p><p>Here we mainly introduce HBA: Host Based Authentication. HBA rules define which users can access which databases from which locations and in which ways.</p><hr><h2 id=client-authentication>Client Authentication</h2><p>To connect to a PostgreSQL database, users must first be authenticated (password is used by default).</p><p>You can provide the password in the connection string (not secure), or pass it using the <code>PGPASSWORD</code> environment variable or <code>.pgpass</code> file. Refer to the <a href=https://www.postgresql.org/docs/current/app-psql.html#usage><code>psql</code></a> documentation and <a href=https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING>PostgreSQL Connection Strings</a> for more details.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;host=&lt;host&gt; port=&lt;port&gt; dbname=&lt;dbname&gt; user=&lt;username&gt; password=&lt;password&gt;&#39;</span>
</span></span><span style=display:flex><span>psql postgres://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;dbname&gt;
</span></span><span style=display:flex><span><span style=color:#000>PGPASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;password&gt;<span style=color:#000;font-weight:700>;</span> psql -U &lt;username&gt; -h &lt;host&gt; -p &lt;port&gt; -d &lt;dbname&gt;
</span></span></code></pre></div><p>For example, to connect to Pigsty&rsquo;s default <code>meta</code> database, you can use the following connection strings:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;host=10.10.10.10 port=5432 dbname=meta user=dbuser_dba password=DBUser.DBA&#39;</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta
</span></span><span style=display:flex><span><span style=color:#000>PGPASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>DBUser.DBA<span style=color:#000;font-weight:700>;</span> psql -U dbuser_dba -h 10.10.10.10 -p <span style=color:#0000cf;font-weight:700>5432</span> -d meta
</span></span></code></pre></div><p>By default, Pigsty enables server-side SSL encryption but does not verify client SSL certificates. To connect using client SSL certificates, you can provide client parameters using the <code>PGSSLCERT</code> and <code>PGSSLKEY</code> environment variables or <code>sslkey</code> and <code>sslcert</code> parameters.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta?sslkey=/path/to/dbuser_dba.key&amp;sslcert=/path/to/dbuser_dba.crt&#39;</span>
</span></span></code></pre></div><p>Client certificates (<code>CN</code> = username) can be signed using the local CA with the <a href=https://github.com/pgsty/pigsty/blob/main/cert.yml><code>cert.yml</code></a> playbook.</p><hr><h2 id=defining-hba>Defining HBA</h2><p>In Pigsty, there are four parameters related to HBA rules:</p><ul><li><a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a>: postgres HBA rules</li><li><a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a>: postgres global default HBA rules</li><li><a href=/docs/pgsql/param#pgb_hba_rules><code>pgb_hba_rules</code></a>: pgbouncer HBA rules</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a>: pgbouncer global default HBA rules</li></ul><p>These are all arrays of HBA rule objects. Each HBA rule is an object in one of the following two forms:</p><h3 id=1-raw-form>1. Raw Form</h3><p>The raw form of HBA is almost identical to the PostgreSQL <code>pg_hba.conf</code> format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  10.0.0.0/8      md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  172.16.0.0/12   md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  192.168.0.0/16  md5</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>In this form, the <code>rules</code> field is an array of strings, where each line is a raw <a href=https://www.postgresql.org/docs/current/auth-pg-hba-conf.html>HBA rule</a>. The <code>title</code> field is rendered as a comment explaining what the rules below do.</p><p>The <code>role</code> field specifies which instance roles the rule applies to. When an instance&rsquo;s <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> matches the <code>role</code>, the HBA rule will be added to that instance&rsquo;s HBA.</p><ul><li>HBA rules with <code>role: common</code> will be added to all instances.</li><li>HBA rules with <code>role: primary</code> will only be added to primary instances.</li><li>HBA rules with <code>role: replica</code> will only be added to replica instances.</li><li>HBA rules with <code>role: offline</code> will be added to offline instances (<a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code> or <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code>)</li></ul><h3 id=2-alias-form>2. Alias Form</h3><p>The alias form allows you to maintain HBA rules in a simpler, clearer, and more convenient way: it replaces the <code>rules</code> field with <code>addr</code>, <code>auth</code>, <code>user</code>, and <code>db</code> fields. The <code>title</code> and <code>role</code> fields still apply.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;intra&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># world|intra|infra|admin|local|localhost|cluster|&lt;cidr&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pwd&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># trust|pwd|ssl|cert|deny|&lt;official auth method&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># all|${dbsu}|${repl}|${admin}|${monitor}|&lt;user&gt;|&lt;group&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># all|replication|....</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># raw hba string precedence over above all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>addr</code>: <strong>where</strong> - Which IP address ranges are affected by this rule?<ul><li><code>world</code>: All IP addresses</li><li><code>intra</code>: All intranet IP address ranges: <code>'10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16'</code></li><li><code>infra</code>: IP addresses of Infra nodes</li><li><code>admin</code>: IP addresses of <code>admin_ip</code> management nodes</li><li><code>local</code>: Local Unix Socket</li><li><code>localhost</code>: Local Unix Socket and TCP 127.0.0.1/32 loopback address</li><li><code>cluster</code>: IP addresses of all members in the same PostgreSQL cluster</li><li><code>&lt;cidr></code>: A specific CIDR address block or IP address</li></ul></li><li><code>auth</code>: <strong>how</strong> - What authentication method does this rule specify?<ul><li><code>deny</code>: Deny access</li><li><code>trust</code>: Trust directly, no authentication required</li><li><code>pwd</code>: Password authentication, uses <code>md5</code> or <code>scram-sha-256</code> authentication based on the <a href=/docs/pgsql/param#pg_pwd_enc><code>pg_pwd_enc</code></a> parameter</li><li><code>sha</code>/<code>scram-sha-256</code>: Force use of <code>scram-sha-256</code> password authentication.</li><li><code>md5</code>: <code>md5</code> password authentication, but can also be compatible with <code>scram-sha-256</code> authentication, not recommended.</li><li><code>ssl</code>: On top of password authentication <code>pwd</code>, require SSL to be enabled</li><li><code>ssl-md5</code>: On top of password authentication <code>md5</code>, require SSL to be enabled</li><li><code>ssl-sha</code>: On top of password authentication <code>sha</code>, require SSL to be enabled</li><li><code>os</code>/<code>ident</code>: Use <code>ident</code> authentication with the operating system user identity</li><li><code>peer</code>: Use <code>peer</code> authentication method, similar to <code>os ident</code></li><li><code>cert</code>: Use client SSL certificate-based authentication, certificate CN is the username</li></ul></li><li><code>user</code>: <strong>who</strong>: Which users are affected by this rule?<ul><li><code>all</code>: All users</li><li><code>${dbsu}</code>: Default database superuser <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a></li><li><code>${repl}</code>: Default database replication user <a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a></li><li><code>${admin}</code>: Default database admin user <a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a></li><li><code>${monitor}</code>: Default database monitor user <a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a></li><li>Other specific users or roles</li></ul></li><li><code>db</code>: <strong>which</strong>: Which databases are affected by this rule?<ul><li><code>all</code>: All databases</li><li><code>replication</code>: Allow replication connections (not specifying a specific database)</li><li>A specific database</li></ul></li></ul><h3 id=3-definition-location>3. Definition Location</h3><p>Typically, global HBA is defined in <code>all.vars</code>. If you want to modify the global default HBA rules, you can copy one from the <a href=https://github.com/pgsty/pigsty/blob/main/conf/full.yml#L690><code>full.yml</code></a> template to <code>all.vars</code> and modify it.</p><ul><li><a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a>: postgres global default HBA rules</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a>: pgbouncer global default HBA rules</li></ul><p>Cluster-specific HBA rules are defined in the database cluster-level configuration:</p><ul><li><a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a>: postgres HBA rules</li><li><a href=/docs/pgsql/param#pgb_hba_rules><code>pgb_hba_rules</code></a>: pgbouncer HBA rules</li></ul><p>Here are some examples of cluster HBA rule definitions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_view ,db: all    ,addr: infra        ,auth: pwd  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;Allow dbuser_view password access to all databases from infrastructure nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: all         ,db: all    ,addr: 100.0.0.0/8  ,auth: pwd  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;Allow all users password access to all databases from K8S network&#39;</span><span style=color:#f8f8f8>          </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>,db: world  ,addr: 0.0.0.0/0    ,auth: cert ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;Allow admin user to login from anywhere with client certificate&#39;</span><span style=color:#f8f8f8>       </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=reloading-hba>Reloading HBA</h2><p>HBA is a static rule configuration file that needs to be reloaded to take effect after modification. The default HBA rule set typically doesn&rsquo;t need to be reloaded because it doesn&rsquo;t involve Role or cluster members.</p><p>If your HBA design uses specific instance role restrictions or cluster member restrictions, then when cluster instance members change (add/remove/failover), some HBA rules&rsquo; effective conditions/scope change, and you typically also need to <a href=/docs/pgsql/admin#reload-hba>reload HBA</a> to reflect the latest changes.</p><p>To reload postgres/pgbouncer hba rules:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;                 <span style=color:#8f5902;font-style:italic># Reload hba rules for cluster `&lt;cls&gt;`</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; ip1 ip2...      <span style=color:#8f5902;font-style:italic># Reload hba rules for specific instances</span>
</span></span></code></pre></div><p>The underlying Ansible playbook commands actually executed are:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -t pg_hba,pg_reload
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -t pgbouncer_hba,pgbouncer_reload
</span></span></code></pre></div><hr><h2 id=default-hba>Default HBA</h2><p>Pigsty has a default set of HBA rules that are secure enough for most scenarios. These rules use the alias form, so they are basically self-explanatory.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres global default HBA rules </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer global default HBA rules </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu local admin access with os ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user local access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor access via intranet with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other monitor access addr&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin access via intranet with pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other admin access addr&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user intra access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><details><summary>Example: Rendered pg_hba.conf</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># File      :   pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Desc      :   Postgres HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Time      :   2023-01-11 15:19</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Path      :   /pg/data/pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># License   :   AGPLv3</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># addr alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local     : /var/run/postgresql</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># infra     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># user alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu    :  postgres</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># repl    :  replicator</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor :  dbuser_monitor</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin   :  dbuser_dba</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu access via local os user ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                postgres                              ident</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu replication from local os ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    replication        postgres                              ident</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator replication from localhost [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    replication        replicator                            scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator replication from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator postgres db from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor from localhost with password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                dbuser_monitor                        scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor from infra host with password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     10.10.10.10/32     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin @ infra nodes with pwd &amp; ssl [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  all                dbuser_dba         10.10.10.10/32     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin @ everywhere with ssl &amp; pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  all                dbuser_dba         0.0.0.0/0          scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgbouncer read/write via local socket [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                +dbrole_readonly                      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># read/write biz user via password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow etl offline tasks from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow application database intranet access [common] [DISABLED]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    kong            dbuser_kong         10.0.0.0/8          md5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    bytebase        dbuser_bytebase     10.0.0.0/8          md5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    grafana         dbuser_grafana      10.0.0.0/8          md5</span>
</span></span></code></pre></div></details><details><summary>Example: Rendered pgb_hba.conf</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># File      :   pgb_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Desc      :   Pgbouncer HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Time      :   2023-01-11 15:28</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Path      :   /etc/pgbouncer/pgb_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># License   :   AGPLv3</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGBOUNCER HBA RULES FOR pg-meta-1 @ 10.10.10.10:6432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ansible managed: 2023-01-11 14:30:58</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># addr alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local     : /var/run/postgresql</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># infra     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># user alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu    :  postgres</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># repl    :  replicator</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor :  dbuser_monitor</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin   :  dbuser_dba</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu local admin access with os ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    pgbouncer          postgres                              peer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow all user local access with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                all                                   scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor access via intranet with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># reject all other monitor access addr [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     0.0.0.0/0          reject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin access via intranet with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># reject all other admin access addr [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         0.0.0.0/0          reject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow all user intra access with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                192.168.0.0/16     scram-sha-256</span>
</span></span></code></pre></div></details><hr><h2 id=security-hardening>Security Hardening</h2><p>For scenarios requiring higher security, we provide a security hardening configuration template <a href=https://github.com/pgsty/pigsty/blob/main/conf/safe.yml>security.yml</a>, which uses the following default HBA rule set:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres host-based auth rules by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: cert  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; cert&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer host-based authentication rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu local admin access with os ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user local access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor access via intranet with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other monitor access addr&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin access via intranet with pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other admin access addr&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user intra access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For more information, refer to the <a href=/docs/setup/security>Security Hardening</a> section.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0b7772f5fffba0123e7353706362f45e>5 - Access Control</h1><div class=lead>Default role system and privilege model provided by Pigsty</div><blockquote><p>Pigsty provides a battery-included access control model based on a <a href=#role-system>role system</a> and <a href=#privilege-system>privilege system</a>.</p></blockquote><p>Access control is important, but many users don&rsquo;t do it well. Therefore, Pigsty provides a simplified, ready-to-use access control model to provide a security baseline for your cluster.</p><hr><h2 id=role-system>Role System</h2><p>Pigsty&rsquo;s default role system includes four <a href=#default-roles>default roles</a> and four <a href=#default-users>default users</a>:</p><table><thead><tr><th>Role Name</th><th>Attributes</th><th>Member of</th><th>Description</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td></td><td>role for global read-only access</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>dbrole_readonly</td><td>role for global read-write access</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>pg_monitor,dbrole_readwrite</td><td>role for object creation</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td></td><td>role for restricted read-only access</td></tr><tr><td><code>postgres</code></td><td><code>SUPERUSER</code></td><td></td><td>system superuser</td></tr><tr><td><code>replicator</code></td><td><code>REPLICATION</code></td><td>pg_monitor,dbrole_readonly</td><td>system replicator</td></tr><tr><td><code>dbuser_dba</code></td><td><code>SUPERUSER</code></td><td>dbrole_admin</td><td>pgsql admin user</td></tr><tr><td><code>dbuser_monitor</code></td><td></td><td>pg_monitor</td><td>pgsql monitor user</td></tr></tbody></table><p>The detailed definitions of these <a href=/docs/pgsql/config/user#defining-users>roles and users</a> are as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=default-roles>Default Roles</h2><p>There are four default roles in Pigsty:</p><ul><li>Business Read-Only (<code>dbrole_readonly</code>): Role for global read-only access. If other businesses need read-only access to this database, they can use this role.</li><li>Business Read-Write (<code>dbrole_readwrite</code>): Role for global read-write access. Production accounts used by primary business should have database read-write privileges.</li><li>Business Admin (<code>dbrole_admin</code>): Role with DDL permissions, typically used for business administrators or scenarios requiring table creation in applications (such as various business software).</li><li>Offline Read-Only (<code>dbrole_offline</code>): Restricted read-only access role (can only access <a href=/docs/pgsql/config#offline-replica>offline</a> instances, typically for personal users and ETL tool accounts).</li></ul><p>Default roles are defined in <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>. Unless you really know what you&rsquo;re doing, it&rsquo;s recommended not to change the default role names.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  , login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access  }                           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># production read-only role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline ,   login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access (offline instance) }     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># restricted-read-only role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># production read-write role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># production DDL change role</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=default-users>Default Users</h2><p>Pigsty also has four default users (system users):</p><ul><li>Superuser (<code>postgres</code>), the owner and creator of the cluster, same as the OS dbsu.</li><li>Replication user (<code>replicator</code>), the system user used for primary-replica replication.</li><li>Monitor user (<code>dbuser_monitor</code>), a user used to monitor database and connection pool metrics.</li><li>Admin user (<code>dbuser_dba</code>), the admin user who performs daily operations and database changes.</li></ul><p>These four default users&rsquo; username/password are defined with four pairs of dedicated parameters, referenced in many places:</p><ul><li><a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a>: os dbsu name, postgres by default, better not change it</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>: dbsu password, empty string by default means no password is set for dbsu, best not to set it.</li><li><a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a>: postgres replication username, <code>replicator</code> by default</li><li><a href=/docs/pgsql/param#pg_replication_password><code>pg_replication_password</code></a>: postgres replication password, <code>DBUser.Replicator</code> by default</li><li><a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a>: postgres admin username, <code>dbuser_dba</code> by default</li><li><a href=/docs/pgsql/param#pg_admin_password><code>pg_admin_password</code></a>: postgres admin password in plain text, <code>DBUser.DBA</code> by default</li><li><a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a>: postgres monitor username, <code>dbuser_monitor</code> by default</li><li><a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a>: postgres monitor password, <code>DBUser.Monitor</code> by default</li></ul><blockquote><p><strong>Remember to change these passwords in production deployment! Don&rsquo;t use default values!</strong></p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database superuser name, it&#39;s recommended not to modify this username.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># database superuser password, it&#39;s recommended to leave this empty! Prohibit dbsu password login.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system replication username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system replication password, be sure to modify this password!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system monitor username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system monitor password, be sure to modify this password!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system admin username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system admin password, be sure to modify this password!</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If you modify the default user parameters, update the corresponding role <a href=/docs/pgsql/config/user#defining-user>definition</a> in <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true                                          ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=privilege-system>Privilege System</h2><p>Pigsty has a battery-included privilege model that works with <a href=#default-roles>default roles</a>.</p><ul><li>All users have access to all schemas.</li><li>Read-Only users (<code>dbrole_readonly</code>) can read from all tables. (SELECT, EXECUTE)</li><li>Read-Write users (<code>dbrole_readwrite</code>) can write to all tables and run DML. (INSERT, UPDATE, DELETE).</li><li>Admin users (<code>dbrole_admin</code>) can create objects and run DDL (CREATE, USAGE, TRUNCATE, REFERENCES, TRIGGER).</li><li>Offline users (<code>dbrole_offline</code>) are like Read-Only users, but with limited access, only allowed to access <a href=/docs/pgsql/config#offline-replica>offline instances</a> (<code>pg_role = 'offline'</code> or <code>pg_offline_query = true</code>)</li><li>Objects created by admin users will have correct privileges.</li><li>Default privileges are installed on all databases, including template databases.</li><li>Database connect privilege is covered by database <a href=/docs/pgsql/config/db#defining-database>definition</a>.</li><li><code>CREATE</code> privileges of database & public schema are revoked from <code>PUBLIC</code> by default.</li></ul><hr><h2 id=object-privilege>Object Privilege</h2><p>Default object privileges for newly created objects in the database are controlled by the <a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a> parameter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Newly <strong>created</strong> objects by admin users will have these privileges by default. Use <code>\ddp+</code> to view these default privileges:</p><table><thead><tr><th>Type</th><th>Access privileges</th></tr></thead><tbody><tr><td>function</td><td>=X</td></tr><tr><td></td><td>dbrole_readonly=X</td></tr><tr><td></td><td>dbrole_offline=X</td></tr><tr><td></td><td>dbrole_admin=X</td></tr><tr><td>schema</td><td>dbrole_readonly=U</td></tr><tr><td></td><td>dbrole_offline=U</td></tr><tr><td></td><td>dbrole_admin=UC</td></tr><tr><td>sequence</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=wU</td></tr><tr><td></td><td>dbrole_admin=rwU</td></tr><tr><td>table</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=awd</td></tr><tr><td></td><td>dbrole_admin=arwdDxt</td></tr></tbody></table><hr><h2 id=default-privilege>Default Privilege</h2><p><a href=https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html><code>ALTER DEFAULT PRIVILEGES</code></a> allows you to set the privileges that will be applied to objects created in the future. It does not affect privileges assigned to already-existing objects, nor does it affect objects created by non-admin users.</p><p>In Pigsty, default privileges are defined for three roles:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dbsu</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_admin_username</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- for additional business admin, they should SET ROLE dbrole_admin before executing DDL to use the corresponding default privilege configuration.
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>This content will be used by the PG cluster initialization template <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>pg-init-template.sql</code></a>, rendered during cluster initialization and output to <code>/pg/tmp/pg-init-template.sql</code>.
These commands will be executed on <code>template1</code> and <code>postgres</code> databases, and newly created databases will inherit these default privilege configurations from <code>template1</code>.</p><p>That is to say, to maintain correct object privileges, you must execute DDL with <strong>admin users</strong>, which could be:</p><ol><li><a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>, <code>postgres</code> by default</li><li><a href=/docs/pgsql/param#pg_admin_username><code>{{ pg_admin_username }}</code></a>, <code>dbuser_dba</code> by default</li><li>Business admin users granted with <code>dbrole_admin</code> role (by switching to <code>dbrole_admin</code> identity using <code>SET ROLE</code>)</li></ol><p>It&rsquo;s wise to use <code>postgres</code> as the global object owner. If you wish to create objects as business admin user, you MUST USE <code>SET ROLE dbrole_admin</code> before running that DDL to maintain the correct privileges.</p><p>You can also explicitly grant default privileges to business admin users in the database through <code>ALTER DEFAULT PRIVILEGE FOR ROLE &lt;some_biz_admin> XXX</code>.</p><hr><h2 id=database-privilege>Database Privilege</h2><p>In Pigsty, database-level privileges are covered in the <a href=#defining-database>database definition</a>.</p><p>There are three database level privileges: <code>CONNECT</code>, <code>CREATE</code>, <code>TEMP</code>, and a special &lsquo;privilege&rsquo;: <code>OWNERSHIP</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># required, `name` is the only mandatory field of a database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, specify a database owner, postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># optional, allow connection, true by default. false will disable connect at all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># optional, revoke public connection privilege. false by default. when set to true, CONNECT privilege will be revoked from users other than owner and admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>If <code>owner</code> exists, it will be used as the database owner instead of default <a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a> (which is usually <code>postgres</code>)</li><li>If <code>revokeconn</code> is <code>false</code>, all users have the <code>CONNECT</code> privilege of the database, this is the default behavior.</li><li>If <code>revokeconn</code> is explicitly set to <code>true</code>:<ul><li><code>CONNECT</code> privilege of the database will be revoked from <code>PUBLIC</code>: regular users cannot connect to this database</li><li><code>CONNECT</code> privilege will be explicitly granted to <code>{{ pg_replication_username }}</code>, <code>{{ pg_monitor_username }}</code> and <code>{{ pg_admin_username }}</code></li><li><code>CONNECT</code> privilege will be granted to the database owner with <code>GRANT OPTION</code>, the database owner can then grant connection privileges to other users.</li></ul></li><li><code>revokeconn</code> flag can be used for database access isolation. You can create different business users as owners for each database and set the <code>revokeconn</code> option for them.</li></ul><details><summary>Example: Database Isolation</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.40</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.41</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_confluence, password: mc2iohos , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_gitlab, password: sdf23g22sfdd , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_readwrite ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_jira, password: sdpijfsfdsfdfs , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: confluence , revokeconn: true, owner: dbuser_confluence , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitlab , revokeconn: true, owner: dbuser_gitlab, connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: jira , revokeconn: true, owner: dbuser_jira , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=create-privilege>CREATE Privilege</h2><p>For security reasons, Pigsty revokes the <code>CREATE</code> privilege on databases from <code>PUBLIC</code> by default, which is also the default behavior since PostgreSQL 15.</p><p>The database owner has the full ability to adjust CREATE privileges as they see fit.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Email - Vonng" aria-label="Email - Vonng"><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label="Email - Vonng"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=WeChat aria-label=WeChat><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=WeChat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Discussion aria-label=Discussion><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=Discussion><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Repo aria-label=Repo><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=Repo><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>