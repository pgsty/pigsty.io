<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.io/docs/pgsql/><link rel=alternate type=application/rss+xml href=https://pigsty.io/docs/pgsql/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Module: PGSQL | PIGSTY</title><meta name=description content="Deploy and manage world's most advanced open-source relational database — PostgreSQL, customizable and production-ready!"><meta property="og:url" content="https://pigsty.io/docs/pgsql/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="Module: PGSQL"><meta property="og:description" content="Deploy and manage world's most advanced open-source relational database — PostgreSQL, customizable and production-ready!"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Module: PGSQL"><meta itemprop=description content="Deploy and manage world's most advanced open-source relational database — PostgreSQL, customizable and production-ready!"><meta itemprop=dateModified content="2026-01-11T15:00:02+08:00"><meta itemprop=wordCount content="1841"><meta itemprop=keywords content="Reference,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="Module: PGSQL"><meta name=twitter:description content="Deploy and manage world's most advanced open-source relational database — PostgreSQL, customizable and production-ready!"><link rel=preload href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css as=style integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><link href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css rel=stylesheet integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Ver</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.cc>Pigsty 中文网站</a></li><li><a class=dropdown-item href=https://doc.pgsty.com>Pigsty v3.7 Doc</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc>Pigsty v3.4 Doc</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 Doc</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 Doc</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch Language / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d757e151050fd40088751a74721d74f6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:window.location.href="https://pigsty.cc"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/pgsql/>Return to the regular view of this page</a>.</p></div><h1 class=title>Module: PGSQL</h1><div class=lead>Deploy and manage world&rsquo;s most advanced open-source relational database — PostgreSQL, customizable and production-ready!</div><ul><li>1: <a href=#pg-9dfef2dab7a4f2eb42759587047ed179>Core Concepts</a></li><li>2: <a href=#pg-bf8af5ce90608b25fe15dcd42ae6f786>Configuration</a></li><ul><li>2.1: <a href=#pg-01e9f6eb810a0f6072913a962bfd631d>Cluster / Instance</a></li><li>2.2: <a href=#pg-64c78407e33d191b14a78a9a03369255>Kernel Version</a></li><li>2.3: <a href=#pg-ad5d6482cea01b850636a3033b3ec973>Package Alias</a></li><li>2.4: <a href=#pg-f3a29e30e1bcb1622450d4b2d3604bdc>User/Role</a></li><li>2.5: <a href=#pg-662c4a4a95a52da3073eeed2f4407af9>Database</a></li><li>2.6: <a href=#pg-be500246ccc4d0aea19a8d2e848cf128>HBA Rules</a></li><li>2.7: <a href=#pg-f26623b2f855e9bc5073aeb50aea422a>Access Control</a></li></ul><li>3: <a href=#pg-a5ab1e936057c396561d23f099852606>Service/Access</a></li><ul></ul><li>4: <a href=#pg-52d6aa237ebdf1b892ae495c94936fe3>Access Control</a></li><ul></ul><li>5: <a href=#pg-3d5c83e1f406be878a7cbcafe1e9c234>Administration</a></li><li>6: <a href=#pg-48b1bc6613befa103400a3961be086ff>Administration</a></li><ul><li>6.1: <a href=#pg-17b67ff7274e6ed5025cdb1b71ec35a4>Managing PostgreSQL Clusters</a></li><li>6.2: <a href=#pg-81e255f632d154a2662d19c783c4514a>Managing PostgreSQL Users</a></li><li>6.3: <a href=#pg-9dd15cada3b5a59a9375eadbdeec7bf7>Managing PostgreSQL Databases</a></li><li>6.4: <a href=#pg-0cd896e3522e4cf2db0a08ece91619f5>Patroni HA Management</a></li><li>6.5: <a href=#pg-289eefb8da504803e0c1952004777bb0>Pgbouncer Connection Pooling</a></li><li>6.6: <a href=#pg-ef5d737e5bae0aa77e9e8e5340965fd9>Managing PostgreSQL Component Services</a></li><li>6.7: <a href=#pg-d6d9a4c3d54ca40e435a862870043f19>Manage PostgreSQL Cron Jobs</a></li><li>6.8: <a href=#pg-2b2e08d4aed2707846688f2a5517519d>Managing PostgreSQL Extensions</a></li><li>6.9: <a href=#pg-fda28727166c3a3a755b7258c9071594>Upgrading PostgreSQL Major/Minor Versions</a></li></ul><li>7: <a href=#pg-efb2d1006e9f523db1ec2975456da71f>Backup & Restore</a></li><ul><li>7.1: <a href=#pg-4c34e733cec9746048fccac02c01fd36>Backup Policy</a></li><li>7.2: <a href=#pg-931bd9f9bf4846ff58a1265e886414d1>Backup Mechanism</a></li><li>7.3: <a href=#pg-e2aad9fad6e8fd1fba46059ad4ea7613>Backup Repository</a></li><li>7.4: <a href=#pg-bd9fc4fbfbb9e33698d751afa14c6077>Admin Commands</a></li><li>7.5: <a href=#pg-ee98f0d297c9a6847c501efbbbed8fa6>Restore Operations</a></li><li>7.6: <a href=#pg-f811d9356784e47cdedcf860a7ba394a>Clone PG Cluster</a></li><li>7.7: <a href=#pg-57c909cac5de1f311ae32e0421e66ee7>Clone Database</a></li></ul><li>8: <a href=#pg-9f140ff0db86673b0d243757b9f578fc>Data Migration</a></li><ul></ul><li>9: <a href=#pg-30aee675be8bae1bfec9459ffb30d160>Tutorials</a></li><ul><li>9.1: <a href=#pg-1a4c8e6cbd3b2738e6fb3dfc5e4011b5>Instance Recovery</a></li><li>9.2: <a href=#pg-39a4da4f2254a96928c0e56a6cb63c63>Troubleshooting</a></li><li>9.3: <a href=#pg-58aaa9e1f6e72722733819cd673913c3>Manual Recovery</a></li><li>9.4: <a href=#pg-ec3ed8119ef85413c277384f41ca7b27>Enabling HugePage for PostgreSQL</a></li><li>9.5: <a href=#pg-e6716a8d517caddd0851177927c9c69c>Accidental Deletion</a></li><li>9.6: <a href=#pg-677d9d9a118e237b46693da04151cde7>HA Drill: Handling 2-of-3 Node Failure</a></li><li>9.7: <a href=#pg-b4eeb541b5d47f6b2e5017106913ea72>Bind a L2 VIP to PostgreSQL Primary with VIP-Manager</a></li><li>9.8: <a href=#pg-1a6ecaf250187005e255b6c6eafd53e2>Deploy HA Citus Cluster</a></li></ul><li>10: <a href=#pg-ecaf10982eb41799d970bf83186f0f12>Reference</a></li><li>11: <a href=#pg-318a92a644bd3692615ad49e01f0f4e1>Monitoring</a></li><ul><li>11.1: <a href=#pg-536f1aee2f7b6fc9206c282f35fe3283>Dashboards</a></li><li>11.2: <a href=#pg-1a2bfc805794d27d84ef5f1f8f01644b>Metrics List</a></li></ul><li>12: <a href=#pg-a794a26bf3d40b2536adae3b38d29ef6>Dashboard</a></li><ul><li>12.1: <a href=#pg-c580a7d5af0c814a622cd05d2217ea00>Overview</a></li><ul><li>12.1.1: <a href=#pg-98c77cd5a40440bd2142743d9aa7e924>PGSQL Overview</a></li><li>12.1.2: <a href=#pg-c0d2340d281acc8b5f2c5c898b37729d>PGSQL Alert</a></li><li>12.1.3: <a href=#pg-c7ea59a32ca19d6b135cb915d738ec5f>PGSQL Shard</a></li></ul><li>12.2: <a href=#pg-71d11dac090b2845d43964a086c029e7>Cluster</a></li><ul><li>12.2.1: <a href=#pg-ac13540d2c30a80f1d60794c913740ab>PGSQL Cluster</a></li><li>12.2.2: <a href=#pg-777b02cba7b02a268aecc27250e0815d>PGRDS Cluster</a></li><li>12.2.3: <a href=#pg-f593ebcf5a965df4fb71075741e2b77e>PGSQL Activity</a></li><li>12.2.4: <a href=#pg-fc20a0ddfc32761378480d5e1617d77f>PGSQL Replication</a></li><li>12.2.5: <a href=#pg-5be6c72f3740f9ca61bbab9d0fb51474>PGSQL Service</a></li><li>12.2.6: <a href=#pg-49c9b74c56a741db1e680ea66c062840>PGSQL Databases</a></li><li>12.2.7: <a href=#pg-7c90bff16bde850becbc89a8ff49fa4d>PGSQL Patroni</a></li><li>12.2.8: <a href=#pg-3c35cf3066a9271b66140e3ae546cc97>PGSQL PITR</a></li></ul><li>12.3: <a href=#pg-0d3b46a9e4488b08a97e5a2cd93e8342>Instance</a></li><ul><li>12.3.1: <a href=#pg-efab5aa64980fd75bc6e3faafa448046>PGSQL Instance</a></li><li>12.3.2: <a href=#pg-745f68183713f01820b7036ca02434dc>PGRDS Instance</a></li><li>12.3.3: <a href=#pg-cc7ae26f510c83819e09f711ea4efd4c>PGCAT Instance</a></li><li>12.3.4: <a href=#pg-7e14c54a9f928b5211431714593ff1d7>PGSQL Persist</a></li><li>12.3.5: <a href=#pg-ab6bcd147d1f1aadd3cac0741c8d3885>PGSQL Proxy</a></li><li>12.3.6: <a href=#pg-7650b8f9f3f719c7343b60768a765bbe>PGSQL Pgbouncer</a></li><li>12.3.7: <a href=#pg-ca5931906d508cd9f75edfe7218e753c>PGSQL Session</a></li><li>12.3.8: <a href=#pg-9d9def57863d569d20a7a3193aa26c93>PGSQL Xacts</a></li><li>12.3.9: <a href=#pg-f25ea8d94e36ba9a5b3676cb12633bf2>PGSQL Exporter</a></li></ul><li>12.4: <a href=#pg-5ab1262c99945ca6857061b54141248e>Database</a></li><ul><li>12.4.1: <a href=#pg-8c17cc1092ed2d1e76d0b7d93b35bbf1>PGSQL Database</a></li><li>12.4.2: <a href=#pg-0ecd8fa92a2426ecb8dc9ceaff62f45b>PGCAT Database</a></li><li>12.4.3: <a href=#pg-357ff5497ef591ed19467aefaaf30b9d>PGSQL Tables</a></li><li>12.4.4: <a href=#pg-f9982c1d8e0198daa19cb19992ddc73b>PGSQL Table</a></li><li>12.4.5: <a href=#pg-c99501fec4430d07944e241ee98f8712>PGCAT Table</a></li><li>12.4.6: <a href=#pg-8cf1de3a04204d7b46c3b3846c17a033>PGSQL Query</a></li><li>12.4.7: <a href=#pg-0e025bec035b17c9d59be41163595514>PGCAT Query</a></li><li>12.4.8: <a href=#pg-0e05e1ef2b7aebfa9cc6f51275cc6cd8>PGCAT Locks</a></li><li>12.4.9: <a href=#pg-eba5c01f53f336bd71d4a7391ec48511>PGCAT Schema</a></li></ul></ul><li>13: <a href=#pg-1f69b3f46163cb973f38581bf88a88a8>Metrics</a></li><li>14: <a href=#pg-aecdecaf4fe39eee883ee97a664ab88f>Parameters</a></li><ul></ul><li>15: <a href=#pg-091b9f18681382583303e1ac5c7cea55>Playbook</a></li><li>16: <a href=#pg-f11dbaecba8ffad62c75360642541598>Extensions</a></li><ul><li>16.1: <a href=#pg-cb575384aee4c018fb0db527378640fd>Quick Start</a></li><li>16.2: <a href=#pg-37c08dbc246cb158947abfb17f172ecc>Introduction</a></li><li>16.3: <a href=#pg-6c21bc6ef6cf2173aeb9948071de953f>Packages</a></li><li>16.4: <a href=#pg-96a6a67c2f3d2429fabeed6f98b76c7f>Download</a></li><li>16.5: <a href=#pg-128bcfdba2d6b955af1661f0a806fd9e>Install</a></li><li>16.6: <a href=#pg-8c405665bb423ccc536997bd9c3a64ca>Config</a></li><li>16.7: <a href=#pg-5b462599a5e29b51a35ede5bb5e310a8>Create</a></li><li>16.8: <a href=#pg-aeb68b34de12844024f2519dd13df6f0>Update</a></li><li>16.9: <a href=#pg-13869765de25ae294c556ad54ac4ee27>Remove</a></li><li>16.10: <a href=#pg-cd40e09e16b398209123543c21e68960>Default Extensions</a></li><li>16.11: <a href=#pg-fef9a9d4af92d185f18fab30d92a530d>Repository</a></li></ul><li>17: <a href=#pg-a670d0bcea1364c05aff52997d9cdc42>Param Templates</a></li><ul><li>17.1: <a href=#pg-c343b4e12cd241ebdb244700f6f7ae20>Parameter Optimization Policy</a></li><li>17.2: <a href=#pg-04bbfb111fd00b28b14a77c5a5a92955>OLTP Template</a></li><li>17.3: <a href=#pg-571aa5133064fa24ac707a69e4d84659>OLAP Template</a></li><li>17.4: <a href=#pg-7cf828587f72da3b425e1bd025ccbacf>CRIT Template</a></li><li>17.5: <a href=#pg-609856237df74f1f0f6e5fba1111e545>TINY Template</a></li></ul><li>18: <a href=#pg-08a8dc2fb6ea8fd6936acfdf250bdc97>PG Kernels</a></li><ul><li>18.1: <a href=#pg-6b647bd80a1130f992c12a77393a87c3>PostgreSQL</a></li><li>18.2: <a href=#pg-2f9342f89a206383c945315b79c7967f>Supabase</a></li><li>18.3: <a href=#pg-5e2941fff6b5b682be30d52c9d82b986>Percona</a></li><li>18.4: <a href=#pg-8b89390bfb5e407f5413ce18cede184b>OpenHalo</a></li><li>18.5: <a href=#pg-311f723c83095a738bfb441159db0044>OrioleDB</a></li><li>18.6: <a href=#pg-7200791b1d0ca9c1c30f1e8d7dc9ece2>Citus</a></li><li>18.7: <a href=#pg-86f570780ad542823d4ed958af36ce0f>Babelfish</a></li><li>18.8: <a href=#pg-d4592799fc81bf53d57e017444a325f6>IvorySQL</a></li><li>18.9: <a href=#pg-293b566be2331c0d55a3457bdfb0a860>PolarDB PG</a></li><li>18.10: <a href=#pg-ffed78d77ebf7627086f9da938f9b9f6>PolarDB Oracle</a></li><li>18.11: <a href=#pg-e59a81d2edf1c2072f834e4d8ef376db>PostgresML</a></li><li>18.12: <a href=#pg-227e1bd7e26827efbe4f8ed91ee4c679>Greenplum</a></li><li>18.13: <a href=#pg-a970dfd99688547f0ffb0bf4d5c4de61>Cloudberry</a></li><li>18.14: <a href=#pg-2342a2eaca8515e616cb1dfa8c4db39d>Neon</a></li></ul><li>19: <a href=#pg-06a73ab7adbd73b0e635c3d9403cab4e>FAQ</a></li><li>20: <a href=#pg-ac541723370b0cdbf999a3eb82ccfc89>Misc</a></li><ul><li>20.1: <a href=#pg-3a18781032fdda789d5f38d1dd1c01a2>Service / Access</a></li><li>20.2: <a href=#pg-4d65100b9600fb960eb0de13b0e7c894>User / Role</a></li><li>20.3: <a href=#pg-e73c12463833eb5e14e27191b7858ef7>Database</a></li><li>20.4: <a href=#pg-ba271faa49ebb08213e3b4f058522cdb>Authentication / HBA</a></li><li>20.5: <a href=#pg-0b7772f5fffba0123e7353706362f45e>Access Control</a></li></ul></ul><div class=content><blockquote><p><strong>The world&rsquo;s most advanced open-source relational database!</strong></p><p>Pigsty brings it to full potential: batteries-included, reliable, observable, maintainable, and scalable! <a href=#config>Config</a> | <a href=/docs/pgsql/admin>Admin</a> | <a href=/docs/pgsql/playbook>Playbooks</a> | <a href=/docs/pgsql/monitor/dashboard>Dashboards</a> | <a href=#parameters>Parameters</a></p></blockquote><hr><h2 id=overview>Overview</h2><blockquote><p>Learn key topics and concepts about PostgreSQL.</p></blockquote><ul><li><a href=/docs/pgsql/config>Architecture</a></li><li><a href=/docs/pgsql/config>Cluster Config</a></li><li><a href=/docs/ref/extension>Extensions</a></li><li><a href=/docs/pgsql/config/user>Users/Roles</a></li><li><a href=/docs/pgsql/config/db>Databases</a></li><li><a href=/docs/pgsql/service/>Services/Access</a></li><li><a href=/docs/pgsql/config/hba>Auth/HBA</a></li><li><a href=/docs/concept/sec/ac/>Access Control</a></li><li><a href=/docs/pgsql/admin>Admin SOP</a></li><li><a href=/docs/pgsql/backup>Backup & Recovery</a></li><li><a href=/docs/pgsql/monitor>Monitoring</a></li><li><a href=/docs/pgsql/migration>Migration</a></li><li><a href=/docs/pgsql/monitor/dashboard>Dashboards</a></li></ul><hr><h2 id=config>Config</h2><blockquote><p><a href=/docs/pgsql/config>Describe</a> your desired PostgreSQL cluster</p></blockquote><ul><li><a href=/docs/pgsql/config#identity-parameters>Identity Params</a>: Define identity params for a PostgreSQL cluster</li><li><a href=/docs/pgsql/config#primary-instance>Primary Instance</a>: Create single-instance &ldquo;cluster&rdquo; with one primary</li><li><a href=/docs/pgsql/config#replica-instance>Replica Instance</a>: Create basic HA cluster with one primary and one replica</li><li><a href=/docs/pgsql/config#offline-instance>Offline Instance</a>: Create special read-only instance for OLAP/ETL/interactive queries</li><li><a href=/docs/pgsql/config#sync-standby>Sync Standby</a>: Enable sync commit to ensure zero data loss</li><li><a href=/docs/pgsql/config#quorum-commit>Quorum Commit</a>: Use quorum sync commit for higher consistency level</li><li><a href=/docs/pgsql/config#standby-cluster>Standby Cluster</a>: Clone existing cluster and keep in sync (DR cluster)</li><li><a href=/docs/pgsql/config#delayed-cluster>Delayed Cluster</a>: Clone existing cluster with delayed replay for emergency recovery</li><li><a href=/docs/pgsql/config#citus-cluster>Citus Cluster</a>: Define and create Citus distributed database cluster</li><li><a href=/docs/pgsql/config#major-version>Major Version</a>: Deploy cluster with different PostgreSQL major version</li></ul><hr><h2 id=admin>Admin</h2><blockquote><p><a href=/docs/pgsql/admin>Manage</a> your PostgreSQL clusters.</p></blockquote><ul><li><a href=/docs/pgsql/admin#cheatsheet>Cheatsheet</a></li><li><a href=/docs/pgsql/admin#create-cluster>Create Cluster</a></li><li><a href=/docs/pgsql/admin#create-user>Create User</a></li><li><a href=/docs/pgsql/admin#create-database>Create Database</a></li><li><a href=/docs/pgsql/admin#reload-service>Reload Service</a></li><li><a href=/docs/pgsql/admin#reload-hba>Reload HBA</a></li><li><a href=/docs/pgsql/admin#config-cluster>Config Cluster</a></li><li><a href=/docs/pgsql/admin#append-replica>Append Replica</a></li><li><a href=/docs/pgsql/admin#remove-replica>Remove Replica</a></li><li><a href=/docs/pgsql/admin#remove-cluster>Remove Cluster</a></li><li><a href=/docs/pgsql/admin#switchover>Switchover</a></li><li><a href=/docs/pgsql/admin#backup-cluster>Backup Cluster</a></li><li><a href=/docs/pgsql/admin#restore-cluster>Restore Cluster</a></li><li><a href=/docs/pgsql/faq/>Troubleshooting</a></li></ul><hr><h2 id=playbooks>Playbooks</h2><blockquote><p>Use idempotent <a href=/docs/pgsql/playbook>playbooks</a> to materialize your config.</p></blockquote><ul><li><a href=/docs/pgsql/playbook#pgsqlyml><code>pgsql.yml</code></a>: Init PostgreSQL cluster or add new replicas.</li><li><a href=/docs/pgsql/playbook#pgsql-rmyml><code>pgsql-rm.yml</code></a>: Remove PostgreSQL cluster or specific instance</li><li><a href=/docs/pgsql/playbook#pgsql-useryml><code>pgsql-user.yml</code></a>: Add new biz user to existing PostgreSQL cluster</li><li><a href=/docs/pgsql/playbook#pgsql-dbyml><code>pgsql-db.yml</code></a>: Add new biz database to existing PostgreSQL cluster</li><li><a href=/docs/pgsql/playbook#pgsql-monitoryml><code>pgsql-monitor.yml</code></a>: Monitor remote postgres instance</li><li><a href=/docs/pgsql/playbook#pgsql-migrationyml><code>pgsql-migration.yml</code></a>: Generate migration manual and scripts</li></ul><details><summary>Example: Install PGSQL Module</summary><p><a href=https://asciinema.org/a/566417><img src=https://asciinema.org/a/566417.svg alt=asciicast></a></p></details><details><summary>Example: Remove PGSQL Module</summary><p><a href=https://asciinema.org/a/566418><img src=https://asciinema.org/a/566418.svg alt=asciicast></a></p></details><hr><h2 id=monitoring>Monitoring</h2><blockquote><p>Check PostgreSQL status via Grafana <a href=/docs/pgsql/monitor/dashboard>dashboards</a>.</p></blockquote><p>Pigsty has 26 PostgreSQL-related dashboards:</p><table><thead><tr><th style=text-align:center>Overview</th><th style=text-align:center>Cluster</th><th style=text-align:center>Instance</th><th style=text-align:center>Database</th></tr></thead><tbody><tr><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-overview>PGSQL Overview</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-cluster>PGSQL Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-instance>PGSQL Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-database>PGSQL Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-alert>PGSQL Alert</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgrds-cluster>PGRDS Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgrds-instance>PGRDS Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-database>PGCAT Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-shard>PGSQL Shard</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-activity>PGSQL Activity</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-instance>PGCAT Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-tables>PGSQL Tables</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-replication>PGSQL Replication</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-persist>PGSQL Persist</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-table>PGSQL Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-service>PGSQL Service</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-proxy>PGSQL Proxy</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-table>PGCAT Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-databases>PGSQL Databases</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-pgbouncer>PGSQL Pgbouncer</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-query>PGSQL Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-patroni>PGSQL Patroni</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-session>PGSQL Session</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-query>PGCAT Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-pitr>PGSQL PITR</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-xacts>PGSQL Xacts</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-locks>PGCAT Locks</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-exporter>PGSQL Exporter</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-schema>PGCAT Schema</a></td></tr></tbody></table><hr><h2 id=parameters>Parameters</h2><blockquote><p>Config params for the <a href=/docs/pgsql/param#pgsql>PGSQL</a> module</p></blockquote><ul><li><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a>: Calculate & validate PostgreSQL instance identity</li><li><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a>: PostgreSQL biz object definitions</li><li><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a>: Install PostgreSQL kernel, pkgs & extensions</li><li><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a>: Init HA PostgreSQL cluster with Patroni</li><li><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a>: Create PostgreSQL users, databases & in-db objects</li><li><a href=/docs/pgsql/param#pg_backup><code>PG_BACKUP</code></a>: Setup backup repo with pgbackrest</li><li><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a>: Expose PostgreSQL services, bindVIP (optional), register DNS</li><li><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a>: Add monitoring for PostgreSQL instance and register to infra</li><li><a href=/docs/pgsql/param#pg_remove><code>PG_REMOVE</code></a>: Remove PostgreSQL cluster, instance and related resources</li></ul><details><summary>Full Parameter List</summary><table><thead><tr><th>Parameter</th><th>Section</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>pgsql cluster mode: pgsql,citus,gpsql</td></tr><tr><td><a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>pgsql cluster name, REQUIRED identity param</td></tr><tr><td><a href=/docs/pgsql/param#pg_seq><code>pg_seq</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>int</td><td style=text-align:center>I</td><td>pgsql instance seq number, REQUIRED identity param</td></tr><tr><td><a href=/docs/pgsql/param#pg_role><code>pg_role</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>I</td><td>pgsql role, REQUIRED, could be primary,replica,offline</td></tr><tr><td><a href=/docs/pgsql/param#pg_instances><code>pg_instances</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>dict</td><td style=text-align:center>I</td><td>define multiple pg instances on node in <code>{port:ins_vars}</code> format</td></tr><tr><td><a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>ip</td><td style=text-align:center>I</td><td>repl upstream ip for standby cluster or cascade replica</td></tr><tr><td><a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>pgsql shard name, optional identity for sharding clusters</td></tr><tr><td><a href=/docs/pgsql/param#pg_group><code>pg_group</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>int</td><td style=text-align:center>C</td><td>pgsql shard index number, optional identity for sharding clusters</td></tr><tr><td><a href=/docs/pgsql/param#gp_role><code>gp_role</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>greenplum role of this cluster, could be master or segment</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporters><code>pg_exporters</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>dict</td><td style=text-align:center>C</td><td>additional pg_exporters to monitor remote postgres instances</td></tr><tr><td><a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a></td><td><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>I</td><td>set true to enable offline query on this instance</td></tr><tr><td><a href=/docs/pgsql/param#pg_users><code>pg_users</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>user[]</td><td style=text-align:center>C</td><td>postgres biz users</td></tr><tr><td><a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>database[]</td><td style=text-align:center>C</td><td>postgres biz databases</td></tr><tr><td><a href=/docs/pgsql/param#pg_services><code>pg_services</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>service[]</td><td style=text-align:center>C</td><td>postgres biz services</td></tr><tr><td><a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>hba[]</td><td style=text-align:center>C</td><td>biz hba rules for postgres</td></tr><tr><td><a href=/docs/pgsql/param#pgb_hba_rules><code>pgb_hba_rules</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>hba[]</td><td style=text-align:center>C</td><td>biz hba rules for pgbouncer</td></tr><tr><td><a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>username</td><td style=text-align:center>G</td><td>postgres replication username, <code>replicator</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_replication_password><code>pg_replication_password</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>password</td><td style=text-align:center>G</td><td>postgres replication password, <code>DBUser.Replicator</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>username</td><td style=text-align:center>G</td><td>postgres admin username, <code>dbuser_dba</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_admin_password><code>pg_admin_password</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>password</td><td style=text-align:center>G</td><td>postgres admin password in plain text, <code>DBUser.DBA</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>username</td><td style=text-align:center>G</td><td>postgres monitor username, <code>dbuser_monitor</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>password</td><td style=text-align:center>G</td><td>postgres monitor password, <code>DBUser.Monitor</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a></td><td><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:center>password</td><td style=text-align:center>G/C</td><td>dbsu password, empty string means no dbsu password by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>username</td><td style=text-align:center>C</td><td>os dbsu name, postgres by default, better not change it</td></tr><tr><td><a href=/docs/pgsql/param#pg_dbsu_uid><code>pg_dbsu_uid</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>int</td><td style=text-align:center>C</td><td>os dbsu uid and gid, 26 for default postgres users and groups</td></tr><tr><td><a href=/docs/pgsql/param#pg_dbsu_sudo><code>pg_dbsu_sudo</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>dbsu sudo privilege, none,limit,all,nopass. limit by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_dbsu_home><code>pg_dbsu_home</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>postgresql home dir, <code>/var/lib/pgsql</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_dbsu_ssh_exchange><code>pg_dbsu_ssh_exchange</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>exchange postgres dbsu ssh key among same pgsql cluster</td></tr><tr><td><a href=/docs/pgsql/param#pg_version><code>pg_version</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>postgres major version to install, 18 by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_bin_dir><code>pg_bin_dir</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>postgres binary dir, <code>/usr/pgsql/bin</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_log_dir><code>pg_log_dir</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>postgres log dir, <code>/pg/log/postgres</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_packages><code>pg_packages</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>string[]</td><td style=text-align:center>C</td><td>pg pkgs to install, <code>${pg_version}</code> will be replaced</td></tr><tr><td><a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a></td><td><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:center>string[]</td><td style=text-align:center>C</td><td>pg extensions to install, <code>${pg_version}</code> will be replaced</td></tr><tr><td><a href=/docs/pgsql/param#pg_clean><code>pg_clean</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>G/C/A</td><td>purge existing postgres during pgsql init? true by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_data><code>pg_data</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>postgres data dir, <code>/pg/data</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_fs_main><code>pg_fs_main</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>mountpoint/path for postgres main data, <code>/data</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_fs_bkup><code>pg_fs_bkup</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>mountpoint/path for pg backup data, <code>/data/backup</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_storage_type><code>pg_storage_type</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>storage type for pg main data, SSD,HDD, SSD by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_dummy_filesize><code>pg_dummy_filesize</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>size</td><td style=text-align:center>C</td><td>size of <code>/pg/dummy</code>, hold 64MB disk space for emergency use</td></tr><tr><td><a href=/docs/pgsql/param#pg_listen><code>pg_listen</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>ip(s)</td><td style=text-align:center>C/I</td><td>postgres/pgbouncer listen addr, comma separated list</td></tr><tr><td><a href=/docs/pgsql/param#pg_port><code>pg_port</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>port</td><td style=text-align:center>C</td><td>postgres listen port, 5432 by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_localhost><code>pg_localhost</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>postgres unix socket dir for localhost connection</td></tr><tr><td><a href=/docs/pgsql/param#pg_namespace><code>pg_namespace</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>top level key namespace in etcd, used by patroni & vip</td></tr><tr><td><a href=/docs/pgsql/param#patroni_enabled><code>patroni_enabled</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>if disabled, no postgres cluster will be created during init</td></tr><tr><td><a href=/docs/pgsql/param#patroni_mode><code>patroni_mode</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>patroni working mode: default,pause,remove</td></tr><tr><td><a href=/docs/pgsql/param#patroni_port><code>patroni_port</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>port</td><td style=text-align:center>C</td><td>patroni listen port, 8008 by default</td></tr><tr><td><a href=/docs/pgsql/param#patroni_log_dir><code>patroni_log_dir</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>patroni log dir, <code>/pg/log/patroni</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#patroni_ssl_enabled><code>patroni_ssl_enabled</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>G</td><td>secure patroni RestAPI comms with SSL?</td></tr><tr><td><a href=/docs/pgsql/param#patroni_watchdog_mode><code>patroni_watchdog_mode</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>patroni watchdog mode: automatic,required,off. off by default</td></tr><tr><td><a href=/docs/pgsql/param#patroni_username><code>patroni_username</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>username</td><td style=text-align:center>C</td><td>patroni restapi username, <code>postgres</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#patroni_password><code>patroni_password</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>password</td><td style=text-align:center>C</td><td>patroni restapi password, <code>Patroni.API</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_etcd_password><code>pg_etcd_password</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>password</td><td style=text-align:center>C</td><td>etcd password for this pg cluster, empty to use pg_cluster</td></tr><tr><td><a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>primary database in this cluster, optional, postgres by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_parameters><code>pg_parameters</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>dict</td><td style=text-align:center>C</td><td>extra params in postgresql.auto.conf</td></tr><tr><td><a href=/docs/pgsql/param#pg_files><code>pg_files</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>path[]</td><td style=text-align:center>C</td><td>extra files to copy to postgres data dir</td></tr><tr><td><a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>config template: oltp,olap,crit,tiny. <code>oltp.yml</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_max_conn><code>pg_max_conn</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>int</td><td style=text-align:center>C</td><td>postgres max connections, <code>auto</code> will use recommended value</td></tr><tr><td><a href=/docs/pgsql/param#pg_shared_buffer_ratio><code>pg_shared_buffer_ratio</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>float</td><td style=text-align:center>C</td><td>postgres shared buffer mem ratio, 0.25 by default, 0.1~0.4</td></tr><tr><td><a href=/docs/pgsql/param#pg_io_method><code>pg_io_method</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>io method for postgres: auto,sync,worker,io_uring, worker by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_rto><code>pg_rto</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>int</td><td style=text-align:center>C</td><td>recovery time objective in seconds, <code>30s</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_rpo><code>pg_rpo</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>int</td><td style=text-align:center>C</td><td>recovery point objective in bytes, <code>1MiB</code> at most by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>preloaded libs, <code>timescaledb,pg_stat_statements,auto_explain</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_delay><code>pg_delay</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>interval</td><td style=text-align:center>I</td><td>replication apply delay for standby cluster leader</td></tr><tr><td><a href=/docs/pgsql/param#pg_checksum><code>pg_checksum</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>enable data checksum for postgres cluster?</td></tr><tr><td><a href=/docs/pgsql/param#pg_pwd_enc><code>pg_pwd_enc</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>password encryption algo: md5,scram-sha-256</td></tr><tr><td><a href=/docs/pgsql/param#pg_encoding><code>pg_encoding</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>database cluster encoding, <code>UTF8</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_locale><code>pg_locale</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>database cluster locale, <code>C</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_lc_collate><code>pg_lc_collate</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>database cluster collate, <code>C</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_lc_ctype><code>pg_lc_ctype</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>database char type, <code>C</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pgsodium_key><code>pgsodium_key</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>pgsodium key, 64 hex digit, default to sha256(pg_cluster)</td></tr><tr><td><a href=/docs/pgsql/param#pgsodium_getkey_script><code>pgsodium_getkey_script</code></a></td><td><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>pgsodium getkey script path</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_enabled><code>pgbouncer_enabled</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>if disabled, pgbouncer will not be launched on pgsql host</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>port</td><td style=text-align:center>C</td><td>pgbouncer listen port, 6432 by default</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_log_dir><code>pgbouncer_log_dir</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>pgbouncer log dir, <code>/pg/log/pgbouncer</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>query postgres to retrieve unlisted biz users?</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_poolmode><code>pgbouncer_poolmode</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>pooling mode: transaction,session,statement, transaction by default</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_sslmode><code>pgbouncer_sslmode</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>pgbouncer client ssl mode, disable by default</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_ignore_param><code>pgbouncer_ignore_param</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>string[]</td><td style=text-align:center>C</td><td>pgbouncer ignore_startup_parameters list</td></tr><tr><td><a href=/docs/pgsql/param#pg_provision><code>pg_provision</code></a></td><td><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>provision postgres cluster after bootstrap</td></tr><tr><td><a href=/docs/pgsql/param#pg_init><code>pg_init</code></a></td><td><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:center>string</td><td style=text-align:center>G/C</td><td>provision init script for cluster template, <code>pg-init</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a></td><td><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:center>role[]</td><td style=text-align:center>G/C</td><td>default roles and users in postgres cluster</td></tr><tr><td><a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a></td><td><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:center>string[]</td><td style=text-align:center>G/C</td><td>default privileges when created by admin user</td></tr><tr><td><a href=/docs/pgsql/param#pg_default_schemas><code>pg_default_schemas</code></a></td><td><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:center>string[]</td><td style=text-align:center>G/C</td><td>default schemas to be created</td></tr><tr><td><a href=/docs/pgsql/param#pg_default_extensions><code>pg_default_extensions</code></a></td><td><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:center>extension[]</td><td style=text-align:center>G/C</td><td>default extensions to be created</td></tr><tr><td><a href=/docs/pgsql/param#pg_reload><code>pg_reload</code></a></td><td><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>A</td><td>reload postgres after hba changes</td></tr><tr><td><a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a></td><td><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:center>hba[]</td><td style=text-align:center>G/C</td><td>postgres default host-based auth rules</td></tr><tr><td><a href=/docs/pgsql/param#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a></td><td><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:center>hba[]</td><td style=text-align:center>G/C</td><td>pgbouncer default host-based auth rules</td></tr><tr><td><a href=/docs/pgsql/param#pgbackrest_enabled><code>pgbackrest_enabled</code></a></td><td><a href=/docs/pgsql/param#pg_backup><code>PG_BACKUP</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>enable pgbackrest on pgsql host?</td></tr><tr><td><a href=/docs/pgsql/param#pgbackrest_clean><code>pgbackrest_clean</code></a></td><td><a href=/docs/pgsql/param#pg_backup><code>PG_BACKUP</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>remove pg backup data during init?</td></tr><tr><td><a href=/docs/pgsql/param#pgbackrest_log_dir><code>pgbackrest_log_dir</code></a></td><td><a href=/docs/pgsql/param#pg_backup><code>PG_BACKUP</code></a></td><td style=text-align:center>path</td><td style=text-align:center>C</td><td>pgbackrest log dir, <code>/pg/log/pgbackrest</code> by default</td></tr><tr><td><a href=/docs/pgsql/param#pgbackrest_method><code>pgbackrest_method</code></a></td><td><a href=/docs/pgsql/param#pg_backup><code>PG_BACKUP</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>pgbackrest repo method: local,minio,etc&mldr;</td></tr><tr><td><a href=/docs/pgsql/param#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a></td><td><a href=/docs/pgsql/param#pg_backup><code>PG_BACKUP</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>take a full backup after pgbackrest init?</td></tr><tr><td><a href=/docs/pgsql/param#pgbackrest_repo><code>pgbackrest_repo</code></a></td><td><a href=/docs/pgsql/param#pg_backup><code>PG_BACKUP</code></a></td><td style=text-align:center>dict</td><td style=text-align:center>G/C</td><td>pgbackrest repo: <a href=https://pgbackrest.org/configuration.html#section-repository>https://pgbackrest.org/configuration.html#section-repository</a></td></tr><tr><td><a href=/docs/pgsql/param#pg_weight><code>pg_weight</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>int</td><td style=text-align:center>I</td><td>relative load balance weight in service, 100 by default, 0-255</td></tr><tr><td><a href=/docs/pgsql/param#pg_service_provider><code>pg_service_provider</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>G/C</td><td>dedicated haproxy node group name, or empty string for local nodes by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>G/C</td><td>default service dest if svc.dest=&lsquo;default&rsquo;</td></tr><tr><td><a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>service[]</td><td style=text-align:center>G/C</td><td>postgres default service definitions</td></tr><tr><td><a href=/docs/pgsql/param#pg_vip_enabled><code>pg_vip_enabled</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>enable L2 VIP for pgsql primary? false by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_vip_address><code>pg_vip_address</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>cidr4</td><td style=text-align:center>C</td><td>vip addr in <code>&lt;ipv4>/&lt;mask></code> format, required if vip is enabled</td></tr><tr><td><a href=/docs/pgsql/param#pg_vip_interface><code>pg_vip_interface</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C/I</td><td>vip network interface to listen, eth0 by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_dns_suffix><code>pg_dns_suffix</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>pgsql dns suffix, &rsquo;&rsquo; by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_dns_target><code>pg_dns_target</code></a></td><td><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:center>enum</td><td style=text-align:center>C</td><td>auto, primary, vip, none, or ad hoc ip</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_enabled><code>pg_exporter_enabled</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>enable pg_exporter on pgsql hosts?</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_config><code>pg_exporter_config</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>pg_exporter config file name</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_cache_ttls><code>pg_exporter_cache_ttls</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>pg_exporter collector ttl stage in seconds, &lsquo;1,10,60,300&rsquo; by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_port><code>pg_exporter_port</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>port</td><td style=text-align:center>C</td><td>pg_exporter listen port, 9630 by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_params><code>pg_exporter_params</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>extra url params for pg_exporter dsn</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_url><code>pg_exporter_url</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>pgurl</td><td style=text-align:center>C</td><td>overwrite auto-gen pg dsn if specified</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_auto_discovery><code>pg_exporter_auto_discovery</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>enable auto database discovery? enabled by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_exclude_database><code>pg_exporter_exclude_database</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>csv of database that WILL NOT be monitored during auto-discovery</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_include_database><code>pg_exporter_include_database</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>string</td><td style=text-align:center>C</td><td>csv of database that WILL BE monitored during auto-discovery</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_connect_timeout><code>pg_exporter_connect_timeout</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>int</td><td style=text-align:center>C</td><td>pg_exporter connect timeout in ms, 200 by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_exporter_options><code>pg_exporter_options</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>arg</td><td style=text-align:center>C</td><td>overwrite extra options for pg_exporter</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_exporter_enabled><code>pgbouncer_exporter_enabled</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>enable pgbouncer_exporter on pgsql hosts?</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_exporter_port><code>pgbouncer_exporter_port</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>port</td><td style=text-align:center>C</td><td>pgbouncer_exporter listen port, 9631 by default</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_exporter_url><code>pgbouncer_exporter_url</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>pgurl</td><td style=text-align:center>C</td><td>overwrite auto-gen pgbouncer dsn if specified</td></tr><tr><td><a href=/docs/pgsql/param#pgbouncer_exporter_options><code>pgbouncer_exporter_options</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>arg</td><td style=text-align:center>C</td><td>overwrite extra options for pgbouncer_exporter</td></tr><tr><td><a href=/docs/pgsql/param#pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>C</td><td>enable pgbackrest_exporter on pgsql hosts?</td></tr><tr><td><a href=/docs/pgsql/param#pgbackrest_exporter_port><code>pgbackrest_exporter_port</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>port</td><td style=text-align:center>C</td><td>pgbackrest_exporter listen port, 9854 by default</td></tr><tr><td><a href=/docs/pgsql/param#pgbackrest_exporter_options><code>pgbackrest_exporter_options</code></a></td><td><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:center>arg</td><td style=text-align:center>C</td><td>overwrite extra options for pgbackrest_exporter</td></tr><tr><td><a href=/docs/pgsql/param#pg_safeguard><code>pg_safeguard</code></a></td><td><a href=/docs/pgsql/param#pg_remove><code>PG_REMOVE</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>G/C/A</td><td>prevent purging running postgres instance? false by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_rm_data><code>pg_rm_data</code></a></td><td><a href=/docs/pgsql/param#pg_remove><code>PG_REMOVE</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>G/C/A</td><td>remove postgres data during remove? true by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_rm_backup><code>pg_rm_backup</code></a></td><td><a href=/docs/pgsql/param#pg_remove><code>PG_REMOVE</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>G/C/A</td><td>remove pgbackrest backup during primary remove? true by default</td></tr><tr><td><a href=/docs/pgsql/param#pg_rm_pkg><code>pg_rm_pkg</code></a></td><td><a href=/docs/pgsql/param#pg_remove><code>PG_REMOVE</code></a></td><td style=text-align:center>bool</td><td style=text-align:center>G/C/A</td><td>uninstall postgres pkgs during remove? true by default</td></tr></tbody></table></details><hr><h2 id=tutorials>Tutorials</h2><blockquote><p>Tutorials for using/managing PostgreSQL in Pigsty.</p></blockquote><ul><li>Clone an existing PostgreSQL cluster</li><li>Create an online standby cluster of existing PostgreSQL cluster</li><li>Create a delayed standby cluster of existing PostgreSQL cluster</li><li>Monitor an existing postgres instance</li><li>Migrate from external PostgreSQL to Pigsty-managed PostgreSQL using logical replication</li><li>Use MinIO as centralized pgBackRest backup repo</li><li>Use dedicated etcd cluster as PostgreSQL / Patroni DCS</li><li>Use dedicated haproxy load balancer cluster to expose PostgreSQL services</li><li>Use pg-meta CMDB instead of pigsty.yml as inventory source</li><li>Use PostgreSQL as Grafana backend storage</li><li>Use PostgreSQL as Prometheus backend storage</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9dfef2dab7a4f2eb42759587047ed179>1 - Core Concepts</h1><p>Core concepts and architecture design</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bf8af5ce90608b25fe15dcd42ae6f786>2 - Configuration</h1><div class=lead>Choose the appropriate instance and cluster types based on your requirements to configure PostgreSQL database clusters that meet your needs.</div><p>Pigsty is a &ldquo;configuration-driven&rdquo; PostgreSQL platform: all behaviors come from the combination of inventory files in <code>~/pigsty/conf/*.yml</code> and <a href=/docs/pgsql/param><code>PGSQL</code> parameters</a>.
Once you&rsquo;ve written the configuration, you can replicate a customized cluster with instances, users, databases, access control, extensions, and tuning policies in just a few minutes.</p><hr><h2 id=configuration-entry>Configuration Entry</h2><ol><li><strong>Prepare Inventory</strong>: Copy a <code>pigsty/conf/*.yml</code> template or write an Ansible Inventory from scratch, placing cluster groups (<code>all.children.&lt;cls>.hosts</code>) and global variables (<code>all.vars</code>) in the same file.</li><li><strong>Define Parameters</strong>: Override the required <a href=/docs/pgsql/param><code>PGSQL</code> parameters</a> in the <code>vars</code> block. The override order from global → cluster → host determines the final value.</li><li><strong>Apply Configuration</strong>: Run <code>./configure -c &lt;conf></code> or <code>bin/pgsql-add &lt;cls></code> and other playbooks to apply the configuration. Pigsty will generate the configuration files needed for Patroni/pgbouncer/pgbackrest based on the parameters.</li></ol><p>Pigsty&rsquo;s default demo inventory <code>conf/pgsql.yml</code> is a minimal example: one <code>pg-meta</code> cluster, global <code>pg_version: 18</code>, and a few business user and database definitions. You can expand with more clusters from this base.</p><hr><h2 id=focus-areas--documentation-index>Focus Areas & Documentation Index</h2><p>Pigsty&rsquo;s PostgreSQL configuration can be organized from the following dimensions. Subsequent documentation will explain &ldquo;how to configure&rdquo; each:</p><ul><li><strong><a href=/docs/pgsql/config/cluster>Cluster & Instances</a></strong>: Define instance topology (standalone, primary-replica, standby cluster, delayed cluster, Citus, etc.) through <code>pg_cluster / pg_role / pg_seq / pg_upstream</code>.</li><li><strong><a href=/docs/pgsql/config/kernel>Kernel Version</a></strong>: Select the core version, flavor, and tuning templates using <code>pg_version</code>, <code>pg_mode</code>, <code>pg_packages</code>, <code>pg_extensions</code>, <code>pg_conf</code>, and other parameters.</li><li><strong><a href=/docs/pgsql/config/user>Users/Roles</a></strong>: Declare system roles, business accounts, password policies, and connection pool attributes in <code>pg_default_roles</code> and <code>pg_users</code>.</li><li><strong><a href=/docs/pgsql/config/db>Database Objects</a></strong>: Create databases as needed using <code>pg_databases</code>, <code>baseline</code>, <code>schemas</code>, <code>extensions</code>, <code>pool_*</code> fields and automatically integrate with pgbouncer/Grafana.</li><li><strong><a href=/docs/pgsql/config/hba>Access Control (HBA)</a></strong>: Maintain host-based authentication policies using <code>pg_default_hba_rules</code> and <code>pg_hba_rules</code> to ensure access boundaries for different roles/networks.</li><li><strong><a href=/docs/pgsql/config/acl>Privilege Model (ACL)</a></strong>: Converge object privileges through <code>pg_default_privileges</code>, <code>pg_default_roles</code>, <code>pg_revoke_public</code> parameters, providing an out-of-the-box layered role system.</li></ul><p>After understanding these parameters, you can write declarative inventory manifests as &ldquo;configuration as infrastructure&rdquo; for any business requirement. Pigsty will handle execution and ensure idempotency.</p><hr><h2 id=a-typical-example>A Typical Example</h2><p>The following snippet shows how to control instance topology, kernel version, extensions, users, and databases in the same configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-analytics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica, pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bi, owner: dbuser_bi, schemas: [mart], extensions: [timescaledb], pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_bi, password: DBUser.BI, roles: [dbrole_admin], pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main pgsql-common ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_bi, db: bi, addr: intra, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;BI only allows intranet SSL access&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>The <code>pg-analytics</code> cluster contains one primary and one offline replica.</li><li>Global settings specify <code>pg_version: 17</code> with a set of extension examples and load <code>olap.yml</code> tuning.</li><li>Declare business objects in <code>pg_databases</code> and <code>pg_users</code>, automatically generating schema/extension and connection pool entries.</li><li>Additional <code>pg_hba_rules</code> restrict access sources and authentication methods.</li></ul><p>Modify and apply this inventory to get a customized PostgreSQL cluster without manual configuration.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-01e9f6eb810a0f6072913a962bfd631d>2.1 - Cluster / Instance</h1><div class=lead>Choose the appropriate instance and cluster types based on your requirements to configure PostgreSQL database clusters that meet your needs.</div><blockquote><p>Choose the appropriate instance and cluster types based on your requirements to configure PostgreSQL database clusters that meet your needs.</p></blockquote><p>You can define different types of instances and clusters. Here are several common PostgreSQL instance/cluster types in Pigsty:</p><ul><li><a href=#primary>Primary</a>: Define a single instance cluster.</li><li><a href=#replica>Replica</a>: Define a basic HA cluster with one primary and one replica.</li><li><a href=#offline>Offline</a>: Define an instance dedicated to OLAP/ETL/interactive queries</li><li><a href=#sync-standby>Sync Standby</a>: Enable synchronous commit to ensure no data loss.</li><li><a href=#quorum-commit>Quorum Commit</a>: Use quorum sync commit for a higher consistency level.</li><li><a href=#standby-cluster>Standby Cluster</a>: Clone an existing cluster and follow it</li><li><a href=#delayed-cluster>Delayed Cluster</a>: Clone an existing cluster for emergency data recovery</li><li><a href=#citus-cluster>Citus Cluster</a>: Define a Citus distributed database cluster</li></ul><hr><h2 id=primary>Primary</h2><p>We start with the simplest case: a single instance cluster consisting of one primary:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>This configuration is concise and self-describing, consisting only of <a href=/docs/pgsql/config#identity-parameters><strong>identity parameters</strong></a>. Note that the Ansible Group name should match <a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a>.</p><p>Use the following command to create this cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test
</span></span></code></pre></div><p>For demos, development testing, hosting temporary requirements, or performing non-critical analytical tasks, a single database instance may not be a big problem. However, such a single-node cluster has no <a href=/docs/concept/ha>high availability</a>. When hardware failures occur, you&rsquo;ll need to use <a href=/docs/concept/pitr>PITR</a> or other recovery methods to ensure the cluster&rsquo;s RTO/RPO. For this reason, you may consider adding several <a href=#replica>read-only replicas</a> to the cluster.</p><hr><h2 id=replica>Replica</h2><p>To add a read-only replica instance, you can add a new node to <code>pg-test</code> and set its <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> to <code>replica</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- newly added replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If the entire cluster doesn&rsquo;t exist, you can directly <a href=/docs/pgsql/admin#create-cluster>create</a> the complete cluster. If the cluster primary has already been initialized, you can <a href=/docs/pgsql/admin#add-instance>add</a> a replica to the existing cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test               <span style=color:#8f5902;font-style:italic># initialize the entire cluster at once</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-test 10.10.10.12   <span style=color:#8f5902;font-style:italic># add replica to existing cluster</span>
</span></span></code></pre></div><p>When the cluster primary fails, the read-only instance (Replica) can take over the primary&rsquo;s work with the help of the high availability system. Additionally, read-only instances can be used to execute read-only queries: many businesses have far more read requests than write requests, and most read-only query loads can be handled by replica instances.</p><hr><h2 id=offline>Offline</h2><p>Offline instances are dedicated read-only replicas specifically for serving slow queries, ETL, OLAP traffic, and interactive queries. Slow queries/long transactions have adverse effects on the performance and stability of online business, so it&rsquo;s best to isolate them from online business.</p><p>To add an offline instance, assign it a new instance and set <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> to <code>offline</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- newly added offline replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Dedicated offline instances work similarly to common replica instances, but they serve as backup servers in the <code>pg-test-replica</code> service. That is, only when all <code>replica</code> instances are down will the offline and primary instances provide this read-only service.</p><p>In many cases, database resources are limited, and using a separate server as an offline instance is not economical. As a compromise, you can select an existing replica instance and mark it with the <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> flag to indicate it can handle &ldquo;offline queries&rdquo;. In this case, this read-only replica will handle both online read-only requests and offline queries. You can use <a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a> and <a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a> for additional access control on offline instances.</p><hr><h2 id=sync-standby>Sync Standby</h2><p>When Sync Standby is enabled, PostgreSQL will select one replica as the <strong>sync standby</strong>, with all other replicas as <strong>candidates</strong>. The primary database will wait for the standby instance to flush to disk before confirming commits. The standby instance always has the latest data with no replication lag, and primary-standby switchover to the sync standby will have no data loss.</p><p>PostgreSQL uses asynchronous streaming replication by default, which may have small replication lag (on the order of 10KB/10ms). When the primary fails, there may be a small data loss window (which can be controlled using <a href=/docs/pgsql/param#pg_rpo><code>pg_rpo</code></a>), but this is acceptable for most scenarios.</p><p>However, in some critical scenarios (e.g., financial transactions), data loss is completely unacceptable, or read replication lag is unacceptable. In such cases, you can use synchronous commit to solve this problem. To enable sync standby mode, you can simply use the <code>crit.yml</code> template in <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- use crit template</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To enable sync standby on an existing cluster, <a href=/docs/pgsql/admin#configure-cluster>configure the cluster</a> and enable <code>synchronous_mode</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test    <span style=color:#8f5902;font-style:italic># run as admin user on admin node</span>
</span></span><span style=display:flex><span>+++
</span></span><span style=display:flex><span>-synchronous_mode: <span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># &lt;--- old value</span>
</span></span><span style=display:flex><span>+synchronous_mode: <span style=color:#204a87>true</span>     <span style=color:#8f5902;font-style:italic># &lt;--- new value</span>
</span></span><span style=display:flex><span> synchronous_mode_strict: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>In this case, the PostgreSQL configuration parameter <a href=https://www.postgresql.org/docs/current/runtime-config-replication.html#synchronous_standby_names><code>synchronous_standby_names</code></a> is automatically managed by Patroni.
One replica will be elected as the sync standby, and its <code>application_name</code> will be written to the PostgreSQL primary configuration file and applied.</p><hr><h2 id=quorum-commit>Quorum Commit</h2><p>Quorum Commit provides more powerful control than sync standby: especially when you have multiple replicas, you can set criteria for successful commits, achieving higher/lower consistency levels (and trade-offs with availability).</p><p>If you want <strong>at least two replicas</strong> to confirm commits, you can adjust the <a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-replication-factor><code>synchronous_node_count</code></a> parameter through Patroni <a href=/docs/pgsql/admin#configure-cluster>cluster configuration</a> and apply it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># ensure synchronous commit is enabled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_node_count</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># specify &#34;at least&#34; how many replicas must successfully commit</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If you want to use more sync replicas, modify the <code>synchronous_node_count</code> value. When the cluster size changes, you should ensure this configuration is still valid to avoid service unavailability.</p><p>In this case, the PostgreSQL configuration parameter <a href=https://www.postgresql.org/docs/current/runtime-config-replication.html#synchronous_standby_names><code>synchronous_standby_names</code></a> is automatically managed by Patroni.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>synchronous_standby_names = &#39;2 (&#34;pg-test-3&#34;,&#34;pg-test-2&#34;)&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><details><summary>Example: Using multiple sync standbys</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>+synchronous_node_count: <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>After applying the configuration, two sync standbys appear.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7080814403632534854<span style=color:#ce5c00;font-weight:700>)</span> +---------+----+-----------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role         <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB <span style=color:#000;font-weight:700>|</span> Tags            <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span> Leader       <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Sync Standby <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Sync Standby <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span></code></pre></div></details><p>Another scenario is using <strong>any n</strong> replicas to confirm commits. In this case, the configuration is slightly different. For example, if we only need any one replica to confirm commits:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>quorum       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use quorum commit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>postgresql</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># modify PostgreSQL&#39;s configuration parameter synchronous_standby_names, using `ANY n ()` syntax</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>synchronous_standby_names</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;ANY 1 (*)&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># you can specify a specific replica list or use * to wildcard all replicas.</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><details><summary>Example: Enable ANY quorum commit</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>+    synchronous_standby_names: <span style=color:#4e9a06>&#39;ANY 1 (*)&#39;</span> <span style=color:#8f5902;font-style:italic># in ANY mode, this parameter is needed</span>
</span></span><span style=display:flex><span>- synchronous_node_count: <span style=color:#0000cf;font-weight:700>2</span>  <span style=color:#8f5902;font-style:italic># in ANY mode, this parameter is not needed</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>After applying, the configuration takes effect, and all standbys become regular replicas in Patroni. However, in <code>pg_stat_replication</code>, you can see <code>sync_state</code> becomes <code>quorum</code>.</p></details><hr><h2 id=standby-cluster>Standby Cluster</h2><p>You can clone an existing cluster and create a standby cluster for data migration, horizontal splitting, multi-region deployment, or disaster recovery.</p><p>Under normal circumstances, the standby cluster will follow the upstream cluster and keep content synchronized. You can promote the standby cluster to become a truly independent cluster.</p><p>The standby cluster definition is basically the same as a normal cluster definition, except that the <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a> parameter is additionally defined on the primary. The primary of the standby cluster is called the <strong>Standby Leader</strong>.</p><p>For example, below defines a <code>pg-test</code> cluster and its standby cluster <code>pg-test2</code>. The configuration inventory might look like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test is the original cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test2 is the standby cluster of pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- pg_upstream defined here</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test2 }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The primary node <code>pg-test2-1</code> of the <code>pg-test2</code> cluster will be a downstream replica of <code>pg-test</code> and serve as the Standby Leader in the <code>pg-test2</code> cluster.</p><p>Just ensure the <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a> parameter is configured on the standby cluster&rsquo;s primary node to automatically pull backups from the original upstream.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test     <span style=color:#8f5902;font-style:italic># create original cluster</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-test2    <span style=color:#8f5902;font-style:italic># create standby cluster</span>
</span></span></code></pre></div><details><summary>Example: Change replication upstream</summary><p>If necessary (e.g., upstream primary-standby switchover/failover), you can change the standby cluster&rsquo;s replication upstream through <a href=/docs/pgsql/admin#configure-cluster>cluster configuration</a>.</p><p>To do this, simply change <code>standby_cluster.host</code> to the new upstream IP address and apply.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.13     <span style=color:#8f5902;font-style:italic># &lt;--- old upstream</span>
</span></span><span style=display:flex><span>+  host: 10.10.10.12     <span style=color:#8f5902;font-style:italic># &lt;--- new upstream</span>
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><details><summary>Example: Promote standby cluster</summary><p>You can promote the standby cluster to an independent cluster at any time, so the cluster can independently handle write requests and diverge from the original cluster.</p><p>To do this, you must <a href=/docs/pgsql/admin#configure-cluster>configure</a> the cluster and completely erase the <code>standby_cluster</code> section, then apply.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>-standby_cluster:
</span></span><span style=display:flex><span>-  create_replica_methods:
</span></span><span style=display:flex><span>-  - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11
</span></span><span style=display:flex><span>-  port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><details><summary>Example: Cascade replication</summary><p>If you specify <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a> on a replica instead of the primary, you can configure <strong>cascade replication</strong> for the cluster.</p><p>When configuring cascade replication, you must use the IP address of an instance in the cluster as the parameter value, otherwise initialization will fail. The replica performs streaming replication from a specific instance rather than the primary.</p><p>The instance acting as a WAL relay is called a <strong>Bridge Instance</strong>. Using a bridge instance can share the burden of sending WAL from the primary. When you have dozens of replicas, using bridge instance cascade replication is a good idea.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg-test-1 ---&gt; pg-test-2 ---&gt; pg-test-3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- bridge instance</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica, pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ^--- replicate from pg-test-2 (bridge) instead of pg-test-1 (primary)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=delayed-cluster>Delayed Cluster</h2><p>A Delayed Cluster is a special type of <a href=#standby-cluster>standby cluster</a> used to quickly recover &ldquo;accidentally deleted&rdquo; data.</p><p>For example, if you want a cluster named <code>pg-testdelay</code> whose data content is the same as the <code>pg-test</code> cluster from one hour ago:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test is the original cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-testdelay is the delayed cluster of pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-testdelay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_upstream: 10.10.10.11, pg_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1d }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-testdelay }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can also <a href=/docs/pgsql/admin#configure-cluster>configure</a> a &ldquo;replication delay&rdquo; on an existing <a href=#standby-cluster>standby cluster</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-testdelay
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>   host: 10.10.10.11
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>+  recovery_min_apply_delay: 1h    <span style=color:#8f5902;font-style:italic># &lt;--- add delay duration here, e.g. 1 hour</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>When some tuples and tables are accidentally deleted, you can modify this parameter to advance this delayed cluster to an appropriate point in time, read data from it, and quickly fix the original cluster.</p><p>Delayed clusters require additional resources, but are much faster than <a href=/docs/concept/pitr#recovery>PITR</a> and have much less impact on the system. For very critical clusters, consider setting up delayed clusters.</p><hr><h2 id=citus-cluster>Citus Cluster</h2><p>Pigsty natively supports Citus. You can refer to <a href=https://github.com/pgsty/pigsty/blob/main/conf/citus.yml><code>files/pigsty/citus.yml</code></a> and <a href=https://github.com/pgsty/pigsty/blob/main/conf/prod.yml#L298><code>prod.yml</code></a> as examples.</p><p>To define a Citus cluster, you need to specify the following parameters:</p><ul><li><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a> must be set to <code>citus</code>, not the default <code>pgsql</code></li><li>The shard name <a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a> and shard number <a href=/docs/pgsql/param#pg_group><code>pg_group</code></a> must be defined on each shard cluster</li><li><a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a> must be defined to specify the database managed by Patroni.</li><li>If you want to use <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a> <code>postgres</code> instead of the default <a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a> to execute admin commands, then <a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a> must be set to a non-empty plaintext password</li></ul><p>Additionally, extra hba rules are needed to allow SSL access from localhost and other data nodes. As shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.14</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># global parameters for all Citus clusters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                    # pgsql cluster mode must be set to</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                # citus horizontal shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db: meta               # citus database name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># if using dbsu, need to configure a password for it</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>On the coordinator node, you can create distributed tables and reference tables and query them from any data node. Starting from 11.2, any Citus database node can act as a coordinator.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SELECT create_distributed_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_accounts&#39;</span>, <span style=color:#4e9a06>&#39;aid&#39;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_accounts<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>SELECT create_reference_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_branches&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>         <span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_branches<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>SELECT create_reference_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_history&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_history<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>SELECT create_reference_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_tellers&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_tellers<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-64c78407e33d191b14a78a9a03369255>2.2 - Kernel Version</h1><div class=lead>How to choose the appropriate PostgreSQL kernel and major version.</div><blockquote><p>Choosing a &ldquo;kernel&rdquo; in Pigsty means determining the PostgreSQL major version, mode/distribution, packages to install, and tuning templates to load.</p></blockquote><p>Pigsty supports PostgreSQL from version 10 onwards. The current version packages core software for versions 13-18 by default and provides a complete extension set for 17/18. The following content shows how to make these choices through configuration files.</p><hr><h2 id=major-version-and-packages>Major Version and Packages</h2><ul><li><code>pg_version</code>: Specify the PostgreSQL major version (default 18). Pigsty will automatically map to the correct package name prefix based on the version.</li><li><code>pg_packages</code>: Define the core package set to install, supports using <a href=/docs/pgsql/config/alias>package aliases</a> (default <code>pgsql-main pgsql-common</code>, includes kernel + patroni/pgbouncer/pgbackrest and other common tools).</li><li><code>pg_extensions</code>: List of additional extension packages to install, also supports aliases; defaults to empty meaning only core dependencies are installed.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main pgsql-common ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector, pgml ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>Effect: Ansible will pull packages corresponding to <code>pg_version=17</code> during installation, pre-install extensions to the system, and database initialization scripts can then directly <code>CREATE EXTENSION</code>.</p></blockquote><p>Extension support varies across versions in Pigsty&rsquo;s offline repository: 12/13 only provide core and tier-1 extensions, while 15/17/18 cover all extensions. If an extension is not pre-packaged, it can be added via <code>repo_packages_extra</code>.</p><hr><h2 id=kernel-mode-pg_mode>Kernel Mode (pg_mode)</h2><p><code>pg_mode</code> controls the kernel &ldquo;flavor&rdquo; to deploy. Default <code>pgsql</code> indicates standard PostgreSQL. Pigsty currently supports the following modes:</p><table><thead><tr><th>Mode</th><th>Scenario</th></tr></thead><tbody><tr><td><code>pgsql</code></td><td>Standard PostgreSQL, HA + replication</td></tr><tr><td><code>citus</code></td><td>Citus distributed cluster, requires additional <code>pg_shard / pg_group</code></td></tr><tr><td><code>gpsql</code></td><td>Greenplum / MatrixDB</td></tr><tr><td><code>mssql</code></td><td>Babelfish for PostgreSQL</td></tr><tr><td><code>mysql</code></td><td>OpenGauss/HaloDB compatible with MySQL protocol</td></tr><tr><td><code>polar</code></td><td>Alibaba PolarDB (based on pg <code>polar</code> distribution)</td></tr><tr><td><code>ivory</code></td><td>IvorySQL (Oracle-compatible syntax)</td></tr><tr><td><code>oriole</code></td><td>OrioleDB storage engine</td></tr><tr><td><code>oracle</code></td><td>PostgreSQL + ora compatibility (<code>pg_mode: oracle</code>)</td></tr></tbody></table><p>After selecting a mode, Pigsty will automatically load corresponding templates, dependency packages, and Patroni configurations. For example, deploying Citus:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0, pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1, pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_citus_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>Effect: All members will install Citus-related packages, Patroni writes to etcd in shard mode, and automatically <code>CREATE EXTENSION citus</code> in the <code>meta</code> database.</p></blockquote><hr><h2 id=extensions-and-pre-installed-objects>Extensions and Pre-installed Objects</h2><p>Besides system packages, you can control components automatically loaded after database startup through the following parameters:</p><ul><li><code>pg_libs</code>: List to write to <code>shared_preload_libraries</code>. For example: <code>pg_libs: 'timescaledb, pg_stat_statements, auto_explain'</code>.</li><li><code>pg_default_extensions</code> / <code>pg_default_schemas</code>: Control schemas and extensions pre-created in <code>template1</code> and <code>postgres</code> by initialization scripts.</li><li><code>pg_parameters</code>: Append <code>ALTER SYSTEM SET</code> for all instances (written to <code>postgresql.auto.conf</code>).</li></ul><p>Example: Enable TimescaleDB, pgvector and customize some system parameters.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-analytics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, pgml&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>timescaledb.max_background_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;&#39;timescaledb,pg_stat_statements,pgml&#39;&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>Effect: During initialization, <code>template1</code> creates extensions, Patroni&rsquo;s <code>postgresql.conf</code> injects corresponding parameters, and all business databases inherit these settings.</p></blockquote><hr><h2 id=tuning-template-pg_conf>Tuning Template (<code>pg_conf</code>)</h2><p><code>pg_conf</code> points to Patroni templates in <code>roles/pgsql/templates/*.yml</code>. Pigsty includes four built-in general templates:</p><table><thead><tr><th>Template</th><th>Applicable Scenario</th></tr></thead><tbody><tr><td><code>oltp.yml</code></td><td>Default template, for 4–128 core TP workload</td></tr><tr><td><code>olap.yml</code></td><td>Optimized for analytical scenarios</td></tr><tr><td><code>crit.yml</code></td><td>Emphasizes sync commit/minimal latency, suitable for zero-loss scenarios like finance</td></tr><tr><td><code>tiny.yml</code></td><td>Lightweight machines / edge scenarios / resource-constrained environments</td></tr></tbody></table><p>You can directly replace the template or customize a YAML file in <code>templates/</code>, then specify it in cluster <code>vars</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-ledger</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.21</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-ledger</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>synchronous_commit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;remote_apply&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>max_wal_senders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2GB&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>Effect: Copy <code>crit.yml</code> as Patroni configuration, overlay <code>pg_parameters</code> written to <code>postgresql.auto.conf</code>, making instances run immediately in synchronous commit mode.</p></blockquote><hr><h2 id=combined-instance-a-complete-example>Combined Instance: A Complete Example</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-rag</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.31</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.32</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-rag</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main pgsql-common ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, pgml, postgis ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, pgvector, pgml&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>max_parallel_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;32GB&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>First primary + one replica, using <code>olap.yml</code> tuning.</li><li>Install PG18 + RAG common extensions, automatically load <code>pgvector/pgml</code> at system level.</li><li>Patroni/pgbouncer/pgbackrest generated by Pigsty, no manual intervention needed.</li></ul><p>Replace the above parameters according to business needs to complete all kernel-level customization.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ad5d6482cea01b850636a3033b3ec973>2.3 - Package Alias</h1><div class=lead>Pigsty provides a package alias translation mechanism that shields the differences in binary package details across operating systems, making installation easier.</div><p>PostgreSQL package naming conventions vary significantly across different operating systems:</p><ul><li><strong>EL systems</strong> (RHEL/Rocky/Alma/&mldr;) use formats like <code>pgvector_17</code>, <code>postgis36_17*</code></li><li><strong>Debian/Ubuntu systems</strong> use formats like <code>postgresql-17-pgvector</code>, <code>postgresql-17-postgis-3</code></li></ul><p>This difference adds cognitive burden to users: you need to remember different package name rules for different systems, and handle the embedding of PostgreSQL version numbers.</p><h2 id=package-alias>Package Alias</h2><p>Pigsty solves this problem through the <strong>Package Alias</strong> mechanism: you only need to use unified aliases, and Pigsty will handle all the details:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Using aliases - simple, unified, cross-platform</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, pgvector, timescaledb ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Equivalent to actual package names on EL9 + PG17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis36_17*, pgvector_17*, timescaledb-tsl_17* ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Equivalent to actual package names on Ubuntu 24 + PG17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgresql-17-postgis-3, postgresql-17-pgvector, postgresql-17-timescaledb-tsl ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h2 id=alias-translation>Alias Translation</h2><p>Aliases can also group a set of packages as a whole. For example, Pigsty&rsquo;s default installed packages - the default value of <a href=/docs/pgsql/param#pg_packages><strong><code>pg_packages</code></strong></a> is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># pg packages to be installed, alias can be used</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty will query the current operating system alias list (assuming <a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el10.x86_64.yml#L105><strong><code>el10.x86_64</code></strong></a>) and translate it to PGSQL kernel, extensions, and toolkits:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgsql-main</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#4e9a06>&#34;postgresql$v postgresql$v-server postgresql$v-libs postgresql$v-contrib postgresql$v-plperl postgresql$v-plpython3 postgresql$v-pltcl postgresql$v-llvmjit pg_repack_$v* wal2json_$v* pgvector_$v*&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgsql-common</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;patroni patroni-etcd pgbouncer pgbackrest pg_exporter pgbackrest_exporter vip-manager&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Next, Pigsty further translates <code>pgsql-main</code> using the currently specified PG major version (assuming <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a> = <code>18</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg18-main</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#4e9a06>&#34;postgresql18 postgresql18-server postgresql18-libs postgresql18-contrib postgresql18-plperl postgresql18-plpython3 postgresql18-pltcl postgresql18-llvmjit pg_repack_18* wal2json_18* pgvector_18*&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Through this approach, Pigsty shields the complexity of packages, allowing users to simply specify the functional components they want.</p><hr><h2 id=which-variables-can-use-aliases>Which Variables Can Use Aliases?</h2><p>You can use package aliases in the following four parameters, and the aliases will be automatically converted to actual package names according to the translation process:</p><ul><li><a href=/docs/pgsql/param#pg_extensions><strong><code>pg_extensions</code></strong></a> - PG extension packages</li><li><a href=/docs/pgsql/param#pg_extensions><strong><code>pg_packages</code></strong></a> - PG kernel/base utility packages</li><li><a href=/docs/infra/param#repo_packages><strong><code>repo_packages</code></strong></a> - Package download parameter: packages to download to local repository</li><li><a href=/docs/pgsql/param#pg_extensions><strong><code>repo_packages_extra</code></strong></a> - Extension installation parameter: additional packages to download to local repository</li></ul><hr><h2 id=alias-list>Alias List</h2><p>You can find the alias mapping files for each operating system and architecture in the <a href=https://github.com/pgsty/pigsty/tree/main/roles/node_id/vars><code>roles/node_id/vars/</code></a> directory of the Pigsty project source code:</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el10.x86_64.yml#L85><code>el10.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el10.aarch64.yml#L85><code>el10.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el9.x86_64.yml#L85><code>el9.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el9.aarch64.yml#L85><code>el9.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el8.x86_64.yml#L85><code>el8.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el8.aarch64.yml#L85><code>el8.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u24.x86_64.yml#L78><code>u24.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u24.aarch64.yml#L78><code>u24.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u22.x86_64.yml#L78><code>u22.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u22.aarch64.yml#L78><code>u22.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d13.x86_64.yml#L78><code>d13.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d13.aarch64.yml#L78><code>d13.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d12.x86_64.yml#L78><code>d12.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d12.aarch64.yml#L78><code>d12.aarch64</code></a></li></ul><hr><h2 id=how-it-works>How It Works</h2><h3 id=alias-translation-process>Alias Translation Process</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>User config <span style=color:#204a87>alias</span> --&gt; Detect OS --&gt;  Find <span style=color:#204a87>alias</span> mapping table ---&gt; Replace <span style=color:#000>$v</span> placeholder ---&gt; Install actual packages
</span></span><span style=display:flex><span>     ↓                 ↓                   ↓                                   ↓
</span></span><span style=display:flex><span>  postgis          el9.x86_64         postgis36_<span style=color:#000>$v</span>*                   postgis36_17*
</span></span><span style=display:flex><span>  postgis          u24.x86_64         postgresql-<span style=color:#000>$v</span>-postgis-3         postgresql-17-postgis-3
</span></span></code></pre></div><h3 id=version-placeholder>Version Placeholder</h3><p>Pigsty&rsquo;s alias system uses <code>$v</code> as a placeholder for the PostgreSQL version number. When you specify a PostgreSQL version using <a href=/docs/pgsql/param#pg_version><code>pg_version</code></a>, all <code>$v</code> in aliases will be replaced with the actual version number.</p><p>For example, when <code>pg_version: 17</code>:</p><table><thead><tr><th>Alias Definition (EL)</th><th>Expanded Result</th></tr></thead><tbody><tr><td><code>postgresql$v*</code></td><td><code>postgresql17*</code></td></tr><tr><td><code>pgvector_$v*</code></td><td><code>pgvector_17*</code></td></tr><tr><td><code>timescaledb-tsl_$v*</code></td><td><code>timescaledb-tsl_17*</code></td></tr></tbody></table><table><thead><tr><th>Alias Definition (Debian/Ubuntu)</th><th>Expanded Result</th></tr></thead><tbody><tr><td><code>postgresql-$v</code></td><td><code>postgresql-17</code></td></tr><tr><td><code>postgresql-$v-pgvector</code></td><td><code>postgresql-17-pgvector</code></td></tr><tr><td><code>postgresql-$v-timescaledb-tsl</code></td><td><code>postgresql-17-timescaledb-tsl</code></td></tr></tbody></table><h3 id=wildcard-matching>Wildcard Matching</h3><p>On EL systems, many aliases use the <code>*</code> wildcard to match related subpackages. For example:</p><ul><li><code>postgis36_17*</code> will match <code>postgis36_17</code>, <code>postgis36_17-client</code>, <code>postgis36_17-utils</code>, etc.</li><li><code>postgresql17*</code> will match <code>postgresql17</code>, <code>postgresql17-server</code>, <code>postgresql17-libs</code>, <code>postgresql17-contrib</code>, etc.</li></ul><p>This design ensures you don&rsquo;t need to list each subpackage individually - one alias can install the complete extension.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f3a29e30e1bcb1622450d4b2d3604bdc>2.4 - User/Role</h1><div class=lead>How to define and customize PostgreSQL users and roles through configuration?</div><blockquote><p>In this document, &ldquo;user&rdquo; refers to a logical object within a database cluster created with <code>CREATE USER/ROLE</code>.</p></blockquote><p>In PostgreSQL, users belong directly to the database cluster rather than a specific database. Therefore, when creating business databases and users, follow the principle of &ldquo;users first, databases later&rdquo;.</p><p>Pigsty defines roles and users through two config parameters:</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a>: Define globally shared roles and users</li><li><a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a>: Define business users and roles at cluster level</li></ul><p>The former defines roles/users shared across the entire environment; the latter defines business roles/users specific to a single cluster. Both have the same format as arrays of user definition objects.
Users/roles are created sequentially in array order, so later users can belong to roles defined earlier.</p><p>By default, all users marked with <code>pgbouncer: true</code> are added to the <a href=/docs/concept/arch/pgsql#pgbouncer><strong>Pgbouncer</strong></a> connection pool user list.</p><hr><h2 id=define-users>Define Users</h2><p>Example from Pigsty demo <code>pg-meta</code> cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_noco     ,password: DBUser.Noco     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for nocodb service      }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_remove   ,state: absent }  # use state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent to delete user</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Each user/role definition is a complex object. Only <code>name</code> is required:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state: create                   # Optional, user state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>create (default), absent</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, password, can be scram-sha-256 hash or plaintext</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Optional, can login, default true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Optional, is superuser, default false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, can create databases, default false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Optional, can create roles, default false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, inherit role privileges, default true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Optional, can replicate, default false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Optional, bypass row-level security, default false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, connection limit, default -1 (unlimited)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, expire N days from creation (priority over expire_at)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Optional, expiration date in YYYY-MM-DD format</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, user comment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, roles array</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Optional, role-level config params</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, add to connection pool user list, default false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, pgbouncer pool mode, default transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Optional, user-level max pool connections, default -1</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=parameter-overview>Parameter Overview</h2><p>The only <strong>required</strong> field is <code>name</code> - a valid, unique username within the cluster. All other params have sensible defaults.</p><table class=full-width><thead><tr><th>Field</th><th>Category</th><th>Type</th><th>Attr</th><th>Description</th></tr></thead><tbody><tr><td><a href=#name><strong><code>name</code></strong></a></td><td>Basic</td><td><code>string</code></td><td>Required</td><td>Username, must be valid and unique</td></tr><tr><td><a href=#state><strong><code>state</code></strong></a></td><td>Basic</td><td><code>enum</code></td><td>Optional</td><td>State: <code>create</code> (default), <code>absent</code></td></tr><tr><td><a href=#password><strong><code>password</code></strong></a></td><td>Basic</td><td><code>string</code></td><td>Mutable</td><td>User password, plaintext or hash</td></tr><tr><td><a href=#comment><strong><code>comment</code></strong></a></td><td>Basic</td><td><code>string</code></td><td>Mutable</td><td>User comment</td></tr><tr><td><a href=#login><strong><code>login</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Can login, default <code>true</code></td></tr><tr><td><a href=#superuser><strong><code>superuser</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Is superuser, default <code>false</code></td></tr><tr><td><a href=#createdb><strong><code>createdb</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Can create databases, default <code>false</code></td></tr><tr><td><a href=#createrole><strong><code>createrole</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Can create roles, default <code>false</code></td></tr><tr><td><a href=#inherit><strong><code>inherit</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Inherit role privileges, default <code>true</code></td></tr><tr><td><a href=#replication><strong><code>replication</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Can replicate, default <code>false</code></td></tr><tr><td><a href=#bypassrls><strong><code>bypassrls</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Bypass RLS, default <code>false</code></td></tr><tr><td><a href=#connlimit><strong><code>connlimit</code></strong></a></td><td>Privilege</td><td><code>int</code></td><td>Mutable</td><td>Connection limit, <code>-1</code> unlimited</td></tr><tr><td><a href=#expire_in><strong><code>expire_in</code></strong></a></td><td>Validity</td><td><code>int</code></td><td>Mutable</td><td>Expire N days from now (priority)</td></tr><tr><td><a href=#expire_at><strong><code>expire_at</code></strong></a></td><td>Validity</td><td><code>string</code></td><td>Mutable</td><td>Expiration date, <code>YYYY-MM-DD</code> format</td></tr><tr><td><a href=#roles><strong><code>roles</code></strong></a></td><td>Role</td><td><code>array</code></td><td>Additive</td><td>Roles array, string or object format</td></tr><tr><td><a href=#parameters><strong><code>parameters</code></strong></a></td><td>Params</td><td><code>object</code></td><td>Mutable</td><td>Role-level parameters</td></tr><tr><td><a href=#pgbouncer><strong><code>pgbouncer</code></strong></a></td><td>Pool</td><td><code>bool</code></td><td>Mutable</td><td>Add to connection pool, default <code>false</code></td></tr><tr><td><a href=#pool_mode><strong><code>pool_mode</code></strong></a></td><td>Pool</td><td><code>enum</code></td><td>Mutable</td><td>Pool mode: <code>transaction</code> (default)</td></tr><tr><td><a href=#pool_connlimit><strong><code>pool_connlimit</code></strong></a></td><td>Pool</td><td><code>int</code></td><td>Mutable</td><td>Pool user max connections</td></tr></tbody></table><hr><h2 id=parameter-details>Parameter Details</h2><h3 id=name><code>name</code></h3><p>String, required. Username - must be unique within the cluster.</p><p>Must be a valid PostgreSQL identifier matching <strong><code>^[a-z_][a-z0-9_]{0,62}$</code></strong>: starts with lowercase letter or underscore, contains only lowercase letters, digits, underscores, max 63 chars.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Standard naming</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_readonly      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Underscore separated</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>_internal         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Underscore prefix (for internal roles)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=state><code>state</code></h3><p>Enum for user operation: <code>create</code> or <code>absent</code>. Default <code>create</code>.</p><table class=full-width><thead><tr><th>State</th><th>Description</th></tr></thead><tbody><tr><td><code>create</code></td><td>Default, create user, update if exists</td></tr><tr><td><code>absent</code></td><td>Delete user with <code>DROP ROLE</code></td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># state defaults to create</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_old</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Delete user</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>These system users cannot be deleted via <code>state: absent</code> (to prevent cluster failure):</p><ul><li><code>postgres</code>: Database superuser</li><li><code>replicator</code>: Replication user (or <a href=/docs/pgsql/param#pg_replication_username><strong><code>pg_replication_username</code></strong></a>)</li><li><code>dbuser_dba</code>: Admin user (or <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a>)</li><li><code>dbuser_monitor</code>: Monitor user (or <a href=/docs/pgsql/param#pg_monitor_username><strong><code>pg_monitor_username</code></strong></a>)</li></ul><h3 id=password><code>password</code></h3><p>String, mutable. User password - users without password can&rsquo;t login via password auth.</p><p>Password can be:</p><table class=full-width><thead><tr><th>Format</th><th>Example</th><th>Description</th></tr></thead><tbody><tr><td>Plaintext</td><td><code>DBUser.Meta</code></td><td>Not recommended, logged to config</td></tr><tr><td>SCRAM-SHA-256</td><td><code>SCRAM-SHA-256$4096:xxx$yyy:zzz</code></td><td>Recommended, PG10+ default</td></tr><tr><td>MD5 hash</td><td><code>md5...</code></td><td>Legacy compatibility</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Plaintext (not recommended, logged to config)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>MySecretPassword</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># SCRAM-SHA-256 hash (recommended)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;SCRAM-SHA-256$4096:xxx$yyy:zzz&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When setting password, Pigsty temporarily disables logging to prevent leakage:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_statement</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;none&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>PASSWORD</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;xxx&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_statement</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To generate SCRAM-SHA-256 hash:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Using PostgreSQL (requires pgcrypto extension)</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;SELECT encode(digest(&#39;password&#39; || &#39;username&#39;, &#39;sha256&#39;), &#39;hex&#39;)&#34;</span>
</span></span></code></pre></div><h3 id=comment><code>comment</code></h3><p>String, mutable. User comment, defaults to <code>business user {name}</code>.</p><p>Set via <code>COMMENT ON ROLE</code>, supports special chars (quotes auto-escaped).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;Main business application account&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;Main business application account&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=login><code>login</code></h3><p>Boolean, mutable. Can login, default <code>true</code>.</p><p>Setting <code>false</code> creates a <strong>Role</strong> rather than User - typically for permission grouping.</p><p>In PostgreSQL, <code>CREATE USER</code> equals <code>CREATE ROLE ... LOGIN</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create login-able user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create role (no login, for permission grouping)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_custom</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom permission role</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>LOGIN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_custom&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>NOLOGIN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=superuser><code>superuser</code></h3><p>Boolean, mutable. Is superuser, default <code>false</code>.</p><p>Superusers have full database privileges, bypassing all permission checks.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser: true            # Dangerous</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>full privileges</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>SUPERUSER</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty provides default superuser via <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a> (<code>dbuser_dba</code>). Don&rsquo;t create additional superusers unless necessary.</p><h3 id=createdb><code>createdb</code></h3><p>Boolean, mutable. Can create databases, default <code>false</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Allow create database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_dev&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CREATEDB</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Some applications (Gitea, Odoo, etc.) may require <code>CREATEDB</code> privilege for their admin users.</p><h3 id=createrole><code>createrole</code></h3><p>Boolean, mutable. Can create other roles, default <code>false</code>.</p><p>Users with <code>CREATEROLE</code> can create, modify, delete other non-superuser roles.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Allow manage other roles</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>CREATEROLE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=inherit><code>inherit</code></h3><p>Boolean, mutable. Auto-inherit privileges from member roles, default <code>true</code>.</p><p>Setting <code>false</code> requires explicit <code>SET ROLE</code> to use member role privileges.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Auto-inherit role privileges (default)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Requires explicit SET ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_special&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>NOINHERIT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- User must execute SET ROLE dbrole_admin to get privileges
</span></span></span></code></pre></div><h3 id=replication><code>replication</code></h3><p>Boolean, mutable. Can initiate streaming replication, default <code>false</code>.</p><p>Usually only replication users (<code>replicator</code>) need this. Normal users shouldn&rsquo;t have it unless for logical decoding subscriptions.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># Allow streaming replication</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pg_monitor, dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;replicator&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>REPLICATION</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=bypassrls><code>bypassrls</code></h3><p>Boolean, mutable. Bypass row-level security (RLS) policies, default <code>false</code>.</p><p>When enabled, user can access all rows even with RLS policies. Usually only for admins.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myappadmin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Bypass RLS policies</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_myappadmin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>BYPASSRLS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=connlimit><code>connlimit</code></h3><p>Integer, mutable. Max concurrent connections, default <code>-1</code> (unlimited).</p><p>Positive integer limits max simultaneous sessions for this user. Doesn&rsquo;t affect superusers.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Max 100 concurrent connections</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_batch</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Limit batch user connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=expire_in><code>expire_in</code></h3><p>Integer, mutable. Expire N days from current date.</p><p>This param has higher priority than <a href=#expire_at><strong><code>expire_at</code></strong></a>. Expiration recalculated on each playbook run - good for temp users needing periodic renewal.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Expire in 30 days</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Expire in 90 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Generates SQL:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- expire_in: 30, assuming current date is 2025-01-01
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;temp_user&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALID</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UNTIL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-01-31&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=expire_at><code>expire_at</code></h3><p>String, mutable. Expiration date in <code>YYYY-MM-DD</code> format, or special value <code>infinity</code>.</p><p>Lower priority than <a href=#expire_in><strong><code>expire_in</code></strong></a>. Use <code>infinity</code> for never-expiring users.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Expire on specific date</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>permanent_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Never expires</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;contractor_user&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALID</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UNTIL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;permanent_user&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALID</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UNTIL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=roles><code>roles</code></h3><p>Array, additive. Roles this user belongs to. Elements can be strings or objects.</p><p>Simple format - strings for role names:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>pg_read_all_data</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_readwrite&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg_read_all_data&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Full format - objects for fine-grained control:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>dbrole_readwrite                            # Simple string</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>GRANT role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># WITH ADMIN OPTION</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set: false }            # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disallow SET ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_signal_backend, inherit: false } # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>don&#39;t auto-inherit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Revoke role membership</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Object Format Parameters</strong>:</p><table class=full-width><thead><tr><th>Param</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td>string</td><td>Role name (required)</td></tr><tr><td><code>state</code></td><td>enum</td><td><code>grant</code> (default) or <code>absent</code>/<code>revoke</code>: control membership</td></tr><tr><td><code>admin</code></td><td>bool</td><td><code>true</code>: WITH ADMIN OPTION, <code>false</code>: REVOKE ADMIN</td></tr><tr><td><code>set</code></td><td>bool</td><td>PG16+: <code>true</code>: WITH SET TRUE, <code>false</code>: REVOKE SET</td></tr><tr><td><code>inherit</code></td><td>bool</td><td>PG16+: <code>true</code>: WITH INHERIT TRUE, <code>false</code>: REVOKE INHERIT</td></tr></tbody></table><p><strong>PostgreSQL 16+ New Features</strong>:</p><p>PostgreSQL 16 introduced finer-grained role membership control:</p><ul><li><strong>ADMIN OPTION</strong>: Allow granting role to other users</li><li><strong>SET OPTION</strong>: Allow using <code>SET ROLE</code> to switch to this role</li><li><strong>INHERIT OPTION</strong>: Auto-inherit this role&rsquo;s privileges</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PostgreSQL 16+ complete example</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Normal membership</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Can grant dbrole_admin to other users</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Cannot SET ROLE to pg_monitor (only inherit privileges)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Don&#39;t auto-inherit pg_execute_server_program (need explicit SET ROLE)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_execute_server_program, inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Revoke old_role membership</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>set</code> and <code>inherit</code> options only work in PG16+. On earlier versions they&rsquo;re ignored with warning comments.</p><h3 id=parameters><code>parameters</code></h3><p>Object, mutable. Role-level config params via <code>ALTER ROLE ... SET</code>. Applies to all sessions for this user.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;search_path&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;log_statement&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Use special value <code>DEFAULT</code> (case-insensitive) to reset to PostgreSQL default:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Reset to default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Set new value</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Common role-level params:</p><table class=full-width><thead><tr><th>Parameter</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td><code>work_mem</code></td><td>Query work memory</td><td><code>'64MB'</code></td></tr><tr><td><code>statement_timeout</code></td><td>Statement timeout</td><td><code>'30s'</code></td></tr><tr><td><code>lock_timeout</code></td><td>Lock wait timeout</td><td><code>'10s'</code></td></tr><tr><td><code>idle_in_transaction_session_timeout</code></td><td>Idle transaction timeout</td><td><code>'10min'</code></td></tr><tr><td><code>search_path</code></td><td>Schema search path</td><td><code>'app,public'</code></td></tr><tr><td><code>log_statement</code></td><td>Log level</td><td><code>'ddl'</code></td></tr><tr><td><code>temp_file_limit</code></td><td>Temp file size limit</td><td><code>'10GB'</code></td></tr></tbody></table><p>Query user-level params via <a href=https://www.postgresql.org/docs/current/view-pg-db-role-setting.html><strong><code>pg_db_role_setting</code></strong></a> system view.</p><h3 id=pgbouncer><code>pgbouncer</code></h3><p>Boolean, mutable. Add user to Pgbouncer user list, default <code>false</code>.</p><p>For prod users needing connection pool access, must explicitly set <code>pgbouncer: true</code>.
Default <code>false</code> prevents accidentally exposing internal users to the pool.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Prod user: needs connection pool</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Internal user: no connection pool needed</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Default, can be omitted</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Users with <code>pgbouncer: true</code> are added to <code>/etc/pgbouncer/userlist.txt</code>.</p><h3 id=pool_mode><code>pool_mode</code></h3><p>Enum, mutable. User-level pool mode: <code>transaction</code>, <code>session</code>, or <code>statement</code>. Default <code>transaction</code>.</p><table class=full-width><thead><tr><th>Mode</th><th>Description</th><th>Use Case</th></tr></thead><tbody><tr><td><code>transaction</code></td><td>Return connection after txn</td><td>Most OLTP apps, default</td></tr><tr><td><code>session</code></td><td>Return connection after session</td><td>Apps needing session state</td></tr><tr><td><code>statement</code></td><td>Return after each statement</td><td>Simple stateless queries</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># DBA user: session mode (may need SET commands etc.)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Normal business user: transaction mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>User-level pool params are configured via <code>/etc/pgbouncer/useropts.txt</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><h3 id=pool_connlimit><code>pool_connlimit</code></h3><p>Integer, mutable. User-level max pool connections, default <code>-1</code> (unlimited).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Max 50 pool connections for this user</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=acl-system>ACL System</h2><p>Pigsty provides a built-in, out-of-the-box access control / <a href=/docs/concept/sec/ac/#default-roles><strong>ACL</strong></a> system. Just assign these four default roles to business users:</p><table class=full-width><thead><tr><th>Role</th><th>Privileges</th><th>Typical Use Case</th></tr></thead><tbody><tr><td><code>dbrole_readwrite</code></td><td>Global read-write</td><td>Primary business prod accounts</td></tr><tr><td><code>dbrole_readonly</code></td><td>Global read-only</td><td>Other business read-only access</td></tr><tr><td><code>dbrole_admin</code></td><td>DDL privileges</td><td>Business admins, table creation</td></tr><tr><td><code>dbrole_offline</code></td><td>Restricted read-only (offline only)</td><td>Individual users, ETL/analytics</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Typical business user configuration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Prod account, read-write</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Read-only account</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Admin, can execute DDL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_etl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.ETL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_offline]     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Offline analytics account</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To redesign your own ACL system, customize:</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a>: System-wide roles and global users</li><li><a href=/docs/pgsql/param#pg_default_privileges><strong><code>pg_default_privileges</code></strong></a>: Default privileges for new objects</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-role.sql><strong><code>pg-init-role.sql</code></strong></a>: Role creation SQL template</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><strong><code>pg-init-template.sql</code></strong></a>: Privilege SQL template</li></ul><hr><h2 id=pgbouncer-users>Pgbouncer Users</h2><p>Pgbouncer is enabled by default as connection pool middleware. Pigsty adds all users in <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> with explicit <code>pgbouncer: true</code> flag to the pgbouncer user list.</p><p>Users in connection pool are listed in <code>/etc/pgbouncer/userlist.txt</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>&#34;postgres&#34; &#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_wiki&#34; &#34;SCRAM-SHA-256$4096:+77dyhrPeFDT/TptHs7/7Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$KeatuohpKIYzHPCt/tqBu85vI11o9mar/by0hHYM2W8=:X9gig4JtjoS8Y/o1vQsIX/gY1Fns8ynTXkbWOjUfbRQ=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_view&#34; &#34;SCRAM-SHA-256$4096:DFoZHU/DXsHL8MJ8regdEw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$gx9sUGgpVpdSM4o6A2R9PKAUkAsRPLhLoBDLBUYtKS0=:MujSgKe6rxcIUMv4GnyXJmV0YNbf39uFRZv724+X1FE=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_monitor&#34; &#34;SCRAM-SHA-256$4096:fwU97ZMO/KR0ScHO5+UuBg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$CrNsmGrx1DkIGrtrD1Wjexb/aygzqQdirTO1oBZROPY=:L8+dJ+fqlMQh7y4PmVR/gbAOvYWOr+KINjeMZ8LlFww=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_meta&#34; &#34;SCRAM-SHA-256$4096:leB2RQPcw1OIiRnPnOMUEg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$eyC+NIMKeoTxshJu314+BmbMFpCcspzI3UFZ1RYfNyU=:fJgXcykVPvOfro2MWNkl5q38oz21nSl1dTtM65uYR1Q=&#34;</span>
</span></span></code></pre></div><p>User-level pool params are maintained in <code>/etc/pgbouncer/useropts.txt</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><p>When <a href=/docs/pgsql/admin/user#create-user><strong>creating users</strong></a>, Pgbouncer user list is refreshed via online reload - doesn&rsquo;t affect existing connections.</p><p>Pgbouncer runs as same <code>dbsu</code> as PostgreSQL (default <code>postgres</code> OS user). Use <code>pgb</code> alias to access pgbouncer admin functions.</p><p><a href=/docs/pgsql/param#pgbouncer_auth_query><strong><code>pgbouncer_auth_query</code></strong></a> param allows dynamic query for pool user auth - convenient when you prefer not to manually manage pool users.</p><hr><h2 id=related-resources>Related Resources</h2><p>For user management operations, see <a href=/docs/pgsql/admin/user><strong>User Management</strong></a>.</p><p>For user access privileges, see <a href=/docs/concept/sec/ac/#default-roles><strong>ACL: Role Privileges</strong></a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-662c4a4a95a52da3073eeed2f4407af9>2.5 - Database</h1><div class=lead>How to define and customize PostgreSQL databases through configuration?</div><blockquote><p>In this document, &ldquo;database&rdquo; refers to a logical object within a database cluster created with <code>CREATE DATABASE</code>.</p></blockquote><p>A PostgreSQL cluster can serve multiple <strong>databases</strong> simultaneously. In Pigsty, you can <a href=#define-database><strong>define</strong></a> required databases in cluster configuration.</p><p>Pigsty customizes the <code>template1</code> template database - creating default schemas, installing default extensions, configuring default privileges. Newly created databases inherit these settings from <code>template1</code>.
You can also specify other template databases via <a href=#template><strong><code>template</code></strong></a> for instant <a href=/docs/pgsql/admin/db#clone-database><strong>database cloning</strong></a>.</p><p>By default, all business databases are 1:1 added to <a href=/docs/concept/arch/pgsql#pgbouncer><strong>Pgbouncer</strong></a> <a href=#connection-pool><strong>connection pool</strong></a>; <a href=/docs/concept/arch/pgsql#pg_exporter><strong><code>pg_exporter</code></strong></a> auto-discovers all business databases for in-database object monitoring.
All databases are also registered as PostgreSQL datasources in <a href=/docs/concept/arch/infra#grafana><strong>Grafana</strong></a> on all <a href=/docs/concept/arch/node#infra-node><strong>INFRA nodes</strong></a> for PGCAT dashboards.</p><hr><h2 id=define-database>Define Database</h2><p>Business databases are defined in cluster param <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a>, an array of database definition objects.
During cluster initialization, databases are created <strong>in definition order</strong>, so later databases can use earlier ones as <strong>templates</strong>.</p><p>Example from Pigsty demo <code>pg-meta</code> cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: noco     ,owner: dbuser_noco     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>nocodb database }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Each database definition is a complex object with fields below. Only <code>name</code> is required:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state: create                   # Optional, database state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>create (default), absent, recreate</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, SQL baseline file path (relative to Ansible search path, e.g., files/)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, add to pgbouncer database list? default true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, additional schemas to create, array of schema names</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions:                     # Optional, extensions to install</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>array of extension objects</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Can specify schema, or omit (installs to first schema in search_path)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Some extensions create and use fixed schemas</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, database comment/description</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, database owner, defaults to current user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, template to use, default template1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>strategy: FILE_COPY             # Optional, clone strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY or WAL_LOG (PG15+)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, inherits from template/cluster config (UTF8)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, inherits from template/cluster config (C)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, inherits from template/cluster config (C)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, inherits from template/cluster config (C)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider: libc           # Optional, locale provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>libc, icu, builtin (PG15+)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, ICU locale rules (PG15+)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, ICU collation rules (PG16+)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, builtin locale provider rules (PG17+)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, default tablespace</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>is_template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Optional, mark as template database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, allow connections, default true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Optional, revoke public CONNECT privilege, default false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Optional, register to grafana datasource? default true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, connection limit, -1 means unlimited</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Optional, database-level params via ALTER DATABASE SET</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;64MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, auth user for pgbouncer auth_query</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, database-level pgbouncer pool mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, database-level pgbouncer default pool size</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Optional, database-level pgbouncer reserve pool</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Optional, database-level pgbouncer min pool size</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Optional, database-level max database connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=parameter-overview>Parameter Overview</h2><p>The only <strong>required</strong> field is <code>name</code> - a valid, unique database name within the cluster. All other params have sensible defaults.
Parameters marked &ldquo;<strong>Immutable</strong>&rdquo; only take effect at creation; changing them requires database recreation.</p><table class=full-width><thead><tr><th>Field</th><th>Category</th><th>Type</th><th>Attr</th><th>Description</th></tr></thead><tbody><tr><td><a href=#name><strong><code>name</code></strong></a></td><td>Basic</td><td><code>string</code></td><td>Required</td><td>Database name, must be valid and unique</td></tr><tr><td><a href=#state><strong><code>state</code></strong></a></td><td>Basic</td><td><code>enum</code></td><td>Optional</td><td>State: <code>create</code> (default), <code>absent</code>, <code>recreate</code></td></tr><tr><td><a href=#owner><strong><code>owner</code></strong></a></td><td>Basic</td><td><code>string</code></td><td>Mutable</td><td>Database owner, defaults to <code>postgres</code></td></tr><tr><td><a href=#comment><strong><code>comment</code></strong></a></td><td>Basic</td><td><code>string</code></td><td>Mutable</td><td>Database comment</td></tr><tr><td><a href=#template><strong><code>template</code></strong></a></td><td>Template</td><td><code>string</code></td><td>Immutable</td><td>Template database, default <code>template1</code></td></tr><tr><td><a href=#strategy><strong><code>strategy</code></strong></a></td><td>Template</td><td><code>enum</code></td><td>Immutable</td><td>Clone strategy: <code>FILE_COPY</code> or <code>WAL_LOG</code> (PG15+)</td></tr><tr><td><a href=#encoding><strong><code>encoding</code></strong></a></td><td>Encoding</td><td><code>string</code></td><td>Immutable</td><td>Character encoding, default inherited (<code>UTF8</code>)</td></tr><tr><td><a href=#locale><strong><code>locale</code></strong></a></td><td>Encoding</td><td><code>string</code></td><td>Immutable</td><td>Locale setting, default inherited (<code>C</code>)</td></tr><tr><td><a href=#lc_collate><strong><code>lc_collate</code></strong></a></td><td>Encoding</td><td><code>string</code></td><td>Immutable</td><td>Collation rule, default inherited (<code>C</code>)</td></tr><tr><td><a href=#lc_ctype><strong><code>lc_ctype</code></strong></a></td><td>Encoding</td><td><code>string</code></td><td>Immutable</td><td>Character classification, default inherited (<code>C</code>)</td></tr><tr><td><a href=#locale_provider><strong><code>locale_provider</code></strong></a></td><td>Encoding</td><td><code>enum</code></td><td>Immutable</td><td>Locale provider: <code>libc</code>, <code>icu</code>, <code>builtin</code> (PG15+)</td></tr><tr><td><a href=#icu_locale><strong><code>icu_locale</code></strong></a></td><td>Encoding</td><td><code>string</code></td><td>Immutable</td><td>ICU locale rules (PG15+)</td></tr><tr><td><a href=#icu_rules><strong><code>icu_rules</code></strong></a></td><td>Encoding</td><td><code>string</code></td><td>Immutable</td><td>ICU collation customization (PG16+)</td></tr><tr><td><a href=#builtin_locale><strong><code>builtin_locale</code></strong></a></td><td>Encoding</td><td><code>string</code></td><td>Immutable</td><td>Builtin locale rules (PG17+)</td></tr><tr><td><a href=#tablespace><strong><code>tablespace</code></strong></a></td><td>Storage</td><td><code>string</code></td><td>Mutable</td><td>Default tablespace, change triggers data migration</td></tr><tr><td><a href=#is_template><strong><code>is_template</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Mark as template database</td></tr><tr><td><a href=#allowconn><strong><code>allowconn</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Allow connections, default <code>true</code></td></tr><tr><td><a href=#revokeconn><strong><code>revokeconn</code></strong></a></td><td>Privilege</td><td><code>bool</code></td><td>Mutable</td><td>Revoke PUBLIC CONNECT privilege</td></tr><tr><td><a href=#connlimit><strong><code>connlimit</code></strong></a></td><td>Privilege</td><td><code>int</code></td><td>Mutable</td><td>Connection limit, <code>-1</code> for unlimited</td></tr><tr><td><a href=#baseline><strong><code>baseline</code></strong></a></td><td>Init</td><td><code>string</code></td><td>Mutable</td><td>SQL baseline file path, runs only on first create</td></tr><tr><td><a href=#schemas><strong><code>schemas</code></strong></a></td><td>Init</td><td><code>(string|object)[]</code></td><td>Mutable</td><td>Schema definitions to create</td></tr><tr><td><a href=#extensions><strong><code>extensions</code></strong></a></td><td>Init</td><td><code>(string|object)[]</code></td><td>Mutable</td><td>Extension definitions to install</td></tr><tr><td><a href=#parameters><strong><code>parameters</code></strong></a></td><td>Init</td><td><code>object</code></td><td>Mutable</td><td>Database-level parameters</td></tr><tr><td><a href=#pgbouncer><strong><code>pgbouncer</code></strong></a></td><td>Pool</td><td><code>bool</code></td><td>Mutable</td><td>Add to connection pool, default <code>true</code></td></tr><tr><td><a href=#pool_mode><strong><code>pool_mode</code></strong></a></td><td>Pool</td><td><code>enum</code></td><td>Mutable</td><td>Pool mode: <code>transaction</code> (default)</td></tr><tr><td><a href=#pool_size><strong><code>pool_size</code></strong></a></td><td>Pool</td><td><code>int</code></td><td>Mutable</td><td>Default pool size, default <code>64</code></td></tr><tr><td><a href=#pool_size_min><strong><code>pool_size_min</code></strong></a></td><td>Pool</td><td><code>int</code></td><td>Mutable</td><td>Min pool size, default <code>0</code></td></tr><tr><td><a href=#pool_reserve><strong><code>pool_reserve</code></strong></a></td><td>Pool</td><td><code>int</code></td><td>Mutable</td><td>Reserve pool size, default <code>32</code></td></tr><tr><td><a href=#pool_connlimit><strong><code>pool_connlimit</code></strong></a></td><td>Pool</td><td><code>int</code></td><td>Mutable</td><td>Max database connections, default <code>100</code></td></tr><tr><td><a href=#pool_auth_user><strong><code>pool_auth_user</code></strong></a></td><td>Pool</td><td><code>string</code></td><td>Mutable</td><td>Auth query user</td></tr><tr><td><a href=#register_datasource><strong><code>register_datasource</code></strong></a></td><td>Monitor</td><td><code>bool</code></td><td>Mutable</td><td>Register to Grafana datasource, default <code>true</code></td></tr></tbody></table><hr><h2 id=parameter-details>Parameter Details</h2><h3 id=name><code>name</code></h3><p>String, required. Database name - must be unique within the cluster.</p><p>Must be a valid PostgreSQL identifier: max 63 chars, no SQL keywords, starts with letter or underscore, followed by letters, digits, or underscores. Must match: <strong><code>^[A-Za-z_][A-Za-z0-9_$]{0,62}$</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Simple naming</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>my_application    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Underscore separated</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_v2            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Version included</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=state><code>state</code></h3><p>Enum for database operation: <code>create</code>, <code>absent</code>, or <code>recreate</code>. Default <code>create</code>.</p><table class=full-width><thead><tr><th>State</th><th>Description</th></tr></thead><tbody><tr><td><code>create</code></td><td>Default, create or modify database, adjust mutable params if exists</td></tr><tr><td><code>absent</code></td><td>Delete database with <code>DROP DATABASE WITH (FORCE)</code></td></tr><tr><td><code>recreate</code></td><td>Drop then create, for database reset</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># state defaults to create</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olddb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Delete database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>testdb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>recreate           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Rebuild database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=owner><code>owner</code></h3><p>String. Database owner, defaults to <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> (<code>postgres</code>) if not specified.</p><p>Target user must exist. Changing owner executes (old owner retains existing privileges):</p><p>Database owner has full control including creating schemas, tables, extensions - useful for multi-tenant scenarios.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OWNER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;new_owner&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;new_owner&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=comment><code>comment</code></h3><p>String. Database comment, defaults to <code>business database {name}</code>.</p><p>Set via <code>COMMENT ON DATABASE</code>, supports Chinese and special chars (Pigsty auto-escapes quotes). Stored in <code>pg_database.datacl</code>, viewable via <code>\l+</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;my main application database&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>my main application database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=template><code>template</code></h3><p>String, <strong>immutable</strong>. Template database for creation, default <code>template1</code>.</p><p>PostgreSQL&rsquo;s <code>CREATE DATABASE</code> clones the template - new database inherits all objects, extensions, schemas, permissions. Pigsty customizes <code>template1</code> during cluster init, so new databases inherit these settings.</p><table class=full-width><thead><tr><th>Template</th><th>Description</th></tr></thead><tbody><tr><td><code>template1</code></td><td>Default, includes Pigsty pre-configured extensions/schemas/perms</td></tr><tr><td><code>template0</code></td><td>Clean template, required for non-default locale providers</td></tr><tr><td>Custom database</td><td>Use existing database as template for cloning</td></tr></tbody></table><p>When using <code>icu</code> or <code>builtin</code> locale provider, must specify <code>template: template0</code> since <code>template1</code> locale settings can&rsquo;t be overridden.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Required for ICU</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zh-Hans</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Using <code>template0</code> skips monitoring extensions/schemas and default privileges - allowing fully custom database.</p><h3 id=strategy><code>strategy</code></h3><p>Enum, immutable. Clone strategy: <code>FILE_COPY</code> or <code>WAL_LOG</code>. Available PG15+.</p><table class=full-width><thead><tr><th>Strategy</th><th>Description</th><th>Use Case</th></tr></thead><tbody><tr><td><code>FILE_COPY</code></td><td>Direct file copy, PG15+ default</td><td>Large templates, general</td></tr><tr><td><code>WAL_LOG</code></td><td>Clone via WAL logging</td><td>Small templates, non-blocking</td></tr></tbody></table><p><code>WAL_LOG</code> doesn&rsquo;t block template connections during clone but less efficient for large templates. Ignored on PG14 and earlier.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cloned_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>source_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>WAL_LOG         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># WAL-based cloning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=encoding><code>encoding</code></h3><p>String, immutable. Character encoding, inherits from template if unspecified (usually <code>UTF8</code>).</p><p>Strongly recommend <code>UTF8</code> unless special requirements. Cannot be changed after creation.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>legacy_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use template0 for non-default encoding</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>LATIN1</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=locale><code>locale</code></h3><p>String, immutable. Locale setting - sets both <code>lc_collate</code> and <code>lc_ctype</code>. Inherits from template (usually <code>C</code>).</p><p>Determines string sort order and character classification. Use <code>C</code> or <code>POSIX</code> for best performance and cross-platform consistency; use language-specific locales (e.g., <code>zh_CN.UTF-8</code>) for proper language sorting.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>chinese_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zh_CN.UTF-8       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Chinese locale</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=lc_collate><code>lc_collate</code></h3><p>String, immutable. String collation rule. Inherits from template (usually <code>C</code>).</p><p>Determines <code>ORDER BY</code> and comparison results. Common values: <code>C</code> (byte order, fastest), <code>C.UTF-8</code>, <code>en_US.UTF-8</code>, <code>zh_CN.UTF-8</code>. Cannot be changed after creation.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en_US.UTF-8   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># English collation</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en_US.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=lc_ctype><code>lc_ctype</code></h3><p>String, immutable. Character classification rule for upper/lower case, digits, letters. Inherits from template (usually <code>C</code>).</p><p>Affects <code>upper()</code>, <code>lower()</code>, regex <code>\w</code>, etc. Cannot be changed after creation.</p><h3 id=locale_provider><code>locale_provider</code></h3><p>Enum, immutable. Locale implementation provider: <code>libc</code>, <code>icu</code>, or <code>builtin</code>. Available PG15+, default <code>libc</code>.</p><table class=full-width><thead><tr><th>Provider</th><th>Version</th><th>Description</th></tr></thead><tbody><tr><td><code>libc</code></td><td>-</td><td>OS C library, traditional default, varies by system</td></tr><tr><td><code>icu</code></td><td>PG15+</td><td>ICU library, cross-platform consistent, more langs</td></tr><tr><td><code>builtin</code></td><td>PG17+</td><td>PostgreSQL builtin, most efficient, C/C.UTF-8 only</td></tr></tbody></table><p>Using <code>icu</code> or <code>builtin</code> requires <code>template: template0</code> with corresponding <code>icu_locale</code> or <code>builtin_locale</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>fast_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>builtin  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Builtin provider, most efficient</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=icu_locale><code>icu_locale</code></h3><p>String, immutable. ICU locale identifier. Available PG15+ when <code>locale_provider: icu</code>.</p><p>ICU identifiers follow BCP 47. Common values:</p><table class=full-width><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>en-US</code></td><td>US English</td></tr><tr><td><code>en-GB</code></td><td>British English</td></tr><tr><td><code>zh-Hans</code></td><td>Simplified Chinese</td></tr><tr><td><code>zh-Hant</code></td><td>Traditional Chinese</td></tr><tr><td><code>ja-JP</code></td><td>Japanese</td></tr><tr><td><code>ko-KR</code></td><td>Korean</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>chinese_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zh-Hans       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Simplified Chinese ICU collation</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=icu_rules><code>icu_rules</code></h3><p>String, immutable. Custom ICU collation rules. Available PG16+.</p><p>Allows fine-tuning default sort behavior using <a href=https://unicode-org.github.io/icu/userguide/collation/customization/><strong>ICU Collation Customization</strong></a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom_sort_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&amp;V &lt;&lt; w &lt;&lt;&lt; W&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Custom V/W sort order</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=builtin_locale><code>builtin_locale</code></h3><p>String, immutable. Builtin locale provider rules. Available PG17+ when <code>locale_provider: builtin</code>. Values: <code>C</code> or <code>C.UTF-8</code>.</p><p><code>builtin</code> provider is PG17&rsquo;s new builtin implementation - faster than <code>libc</code> with consistent cross-platform behavior. Suitable for C/C.UTF-8 collation only.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>fast_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>builtin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Builtin UTF-8 support</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=tablespace><code>tablespace</code></h3><p>String, mutable. Default tablespace, default <code>pg_default</code>.</p><p>Changing tablespace triggers physical data migration - PostgreSQL moves all objects to new tablespace. Can take long time for large databases, use cautiously.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>archive_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>slow_hdd      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Archive data on slow storage</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;archive_db&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>TABLESPACE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;slow_hdd&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=is_template><code>is_template</code></h3><p>Boolean, mutable. Mark database as template, default <code>false</code>.</p><p>When <code>true</code>, any user with <code>CREATEDB</code> privilege can use this database as template for cloning. Template databases typically pre-install standard schemas, extensions, and data.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>is_template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># Mark as template, allow user cloning</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>core, api]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>postgis, pg_trgm]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Deleting <code>is_template: true</code> databases: Pigsty first executes <code>ALTER DATABASE ... IS_TEMPLATE false</code> then drops.</p><h3 id=allowconn><code>allowconn</code></h3><p>Boolean, mutable. Allow connections, default <code>true</code>.</p><p>Setting <code>false</code> completely disables connections at database level - no user (including superuser) can connect. Used for maintenance or archival purposes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>archive_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Disallow all connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;archive_db&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>ALLOW_CONNECTIONS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=revokeconn><code>revokeconn</code></h3><p>Boolean, mutable. Revoke PUBLIC <code>CONNECT</code> privilege, default <code>false</code>.</p><p>When <code>true</code>, Pigsty executes:</p><ul><li>Revoke PUBLIC CONNECT, regular users can&rsquo;t connect</li><li>Grant connect to replication user (<code>replicator</code>) and monitor user (<code>dbuser_monitor</code>)</li><li>Grant connect to admin user (<code>dbuser_dba</code>) and owner with <code>WITH GRANT OPTION</code></li></ul><p>Setting <code>false</code> restores PUBLIC CONNECT privilege.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>secure_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_secure</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Revoke public connect, only specified users</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=connlimit><code>connlimit</code></h3><p>Integer, mutable. Max concurrent connections, default <code>-1</code> (unlimited).</p><p>Positive integer limits max simultaneous sessions. Doesn&rsquo;t affect superusers.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>limited_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Max 50 concurrent connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;limited_db&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=baseline><code>baseline</code></h3><p>String, one-time. SQL baseline file path executed after database creation.</p><p>Baseline files typically contain schema definitions, initial data, stored procedures. Path is relative to Ansible search path, usually in <code>files/</code>.</p><p>Baseline runs only on first creation; skipped if database exists. <code>state: recreate</code> re-runs baseline.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_schema.sql </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Looks for files/myapp_schema.sql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=schemas><code>schemas</code></h3><p>Array, mutable (add/remove). Schema definitions to create or drop. Elements can be strings or objects.</p><p>Simple format - strings for schema names (create only):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>api</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>core</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Full format - objects for owner and drop operations:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Schema name (required)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Schema owner (optional), generates AUTHORIZATION clause</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>deprecated</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Drop schema (CASCADE)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Create uses <code>IF NOT EXISTS</code>; drop uses <code>CASCADE</code> (deletes all objects in schema).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AUTHORIZATION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;deprecated&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=extensions><code>extensions</code></h3><p>Array, mutable (add/remove). Extension definitions to install or uninstall. Elements can be strings or objects.</p><p>Simple format - strings for extension names (install only):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgis</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pg_trgm</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>vector</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Full format - objects for schema, version, and uninstall:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>vector            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Extension name (required)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Install to schema (optional)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.5.1&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Specific version (optional)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>old_extension</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Uninstall extension (CASCADE)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Install uses <code>CASCADE</code> to auto-install dependencies; uninstall uses <code>CASCADE</code> (deletes dependent objects).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;vector&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;public&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VERSION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.5.1&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;old_extension&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=parameters><code>parameters</code></h3><p>Object, mutable. Database-level config params via <code>ALTER DATABASE ... SET</code>. Applies to all sessions connecting to this database.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;512MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Use special value <code>DEFAULT</code> (case-insensitive) to reset to PostgreSQL default:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Reset to default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Set new value</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgbouncer><code>pgbouncer</code></h3><p>Boolean, mutable. Add database to Pgbouncer pool list, default <code>true</code>.</p><p>Setting <code>false</code> excludes database from Pgbouncer - clients can&rsquo;t access via connection pool. For internal management databases or direct-connect scenarios.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>internal_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># No connection pool access</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_mode><code>pool_mode</code></h3><p>Enum, mutable. Pgbouncer pool mode: <code>transaction</code>, <code>session</code>, or <code>statement</code>. Default <code>transaction</code>.</p><table class=full-width><thead><tr><th>Mode</th><th>Description</th><th>Use Case</th></tr></thead><tbody><tr><td><code>transaction</code></td><td>Return connection after txn</td><td>Most OLTP apps, default</td></tr><tr><td><code>session</code></td><td>Return connection after session</td><td>Apps needing session state</td></tr><tr><td><code>statement</code></td><td>Return after each statement</td><td>Simple stateless queries</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Session-level pooling</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_size><code>pool_size</code></h3><p>Integer, mutable. Pgbouncer default pool size, default <code>64</code>.</p><p>Pool size determines backend connections reserved for this database. Adjust based on workload.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>high_load_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>128</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Larger pool for high load</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_size_min><code>pool_size_min</code></h3><p>Integer, mutable. Pgbouncer minimum pool size, default <code>0</code>.</p><p>Values > 0 pre-create specified backend connections for connection warming, reducing first-request latency.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latency_sensitive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># Pre-warm 10 connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_reserve><code>pool_reserve</code></h3><p>Integer, mutable. Pgbouncer reserve pool size, default <code>32</code>.</p><p>When default pool exhausted, Pgbouncer can allocate up to <code>pool_reserve</code> additional connections for burst traffic.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bursty_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Allow burst to 128 connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_connlimit><code>pool_connlimit</code></h3><p>Integer, mutable. Max connections via Pgbouncer pool, default <code>100</code>.</p><p>This is Pgbouncer-level limit, independent of database&rsquo;s <code>connlimit</code> param.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>limited_pool_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Pool max 50 connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_auth_user><code>pool_auth_user</code></h3><p>String, mutable. User for Pgbouncer auth query.</p><p>Requires <a href=/docs/pgsql/param#pgbouncer_auth_query><strong><code>pgbouncer_auth_query</code></strong></a> enabled. When set, all Pgbouncer connections to this database use specified user for auth query password verification.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use monitor user for auth query</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=register_datasource><code>register_datasource</code></h3><p>Boolean, mutable. Register database to Grafana as PostgreSQL datasource, default <code>true</code>.</p><p>Set <code>false</code> to skip Grafana registration. For temp databases, test databases, or internal databases not needed in monitoring.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Don&#39;t register to Grafana</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=template-inheritance>Template Inheritance</h2><p>Many parameters inherit from template database if not explicitly specified. Default template is <code>template1</code>, whose encoding settings are determined by cluster init params:</p><table class=full-width><thead><tr><th>Cluster Param</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/param#pg_encoding><strong><code>pg_encoding</code></strong></a></td><td><code>UTF8</code></td><td>Cluster encoding</td></tr><tr><td><a href=/docs/pgsql/param#pg_locale><strong><code>pg_locale</code></strong></a></td><td><code>C</code> / <code>C-UTF-8</code> (if supported)</td><td>Cluster locale</td></tr><tr><td><a href=/docs/pgsql/param#pg_lc_collate><strong><code>pg_lc_collate</code></strong></a></td><td><code>C</code> / <code>C-UTF-8</code> (if supported)</td><td>Cluster collation</td></tr><tr><td><a href=/docs/pgsql/param#pg_lc_ctype><strong><code>pg_lc_ctype</code></strong></a></td><td><code>C</code> / <code>C-UTF-8</code> (if supported)</td><td>Cluster ctype</td></tr></tbody></table><p>New databases fork from <code>template1</code>, which is customized during <a href=/docs/pgsql/param#pg_provision><strong><code>PG_PROVISION</code></strong></a> with extensions, schemas, and default privileges. Unless you explicitly use another template.</p><hr><h2 id=deep-customization>Deep Customization</h2><p>Pigsty provides rich customization params. To customize template database, refer to:</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a>: Default predefined roles and system users</li><li><a href=/docs/pgsql/param#pg_default_privileges><strong><code>pg_default_privileges</code></strong></a>: Default privileges for objects created by admin user</li><li><a href=/docs/pgsql/param#pg_default_schemas><strong><code>pg_default_schemas</code></strong></a>: Default schemas to create</li><li><a href=/docs/pgsql/param#pg_default_extensions><strong><code>pg_default_extensions</code></strong></a>: Default extensions to create</li><li><a href=/docs/pgsql/param#pg_default_hba_rules><strong><code>pg_default_hba_rules</code></strong></a>: Default PostgreSQL HBA rules</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><strong><code>pgb_default_hba_rules</code></strong></a>: Default Pgbouncer HBA rules</li></ul><p>If above configurations don&rsquo;t meet your needs, use <a href=/docs/pgsql/param#pg_init><strong><code>pg_init</code></strong></a> to specify custom cluster init scripts:</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init><strong><code>pg-init</code></strong></a>: Cluster init script</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><strong><code>pg-init-template.sql</code></strong></a>: Template customization SQL</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-roles.sql><strong><code>pg-init-roles.sql</code></strong></a>: Default roles SQL</li></ul><hr><h2 id=locale-providers>Locale Providers</h2><p>PostgreSQL 15+ introduced <strong><code>locale_provider</code></strong> for different locale implementations. These are immutable after creation.</p><p>Pigsty&rsquo;s <a href=/docs/concept/iac/configure><strong><code>configure</code></strong></a> wizard selects builtin C.UTF-8/C locale provider based on PG and OS versions.
Databases inherit cluster locale by default. To specify different locale provider, you must use <code>template0</code>.</p><p><strong>Using ICU provider (PG15+)</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ICU requires template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ICU locale rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Using builtin provider (PG17+)</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_builtin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>builtin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Builtin locale rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Provider comparison</strong>: <code>libc</code> (traditional, OS-dependent), <code>icu</code> (PG15+, cross-platform, feature-rich), <code>builtin</code> (PG17+, most efficient C/C.UTF-8).</p><hr><h2 id=connection-pool>Connection Pool</h2><p><a href=/docs/concept/arch/pgsql#pgbouncer><strong>Pgbouncer</strong></a> connection pool optimizes short-connection performance, reduces contention, prevents excessive connections from overwhelming database, and provides flexibility during migrations.</p><p>Pigsty configures 1:1 connection pool for each PostgreSQL instance, running as same <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> (default <code>postgres</code> OS user). Pool communicates with database via <code>/var/run/postgresql</code> Unix socket.</p><p>Pigsty adds all databases in <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> to pgbouncer by default.
Set <a href=#pgbouncer><strong><code>pgbouncer: false</code></strong></a> to exclude specific databases.
Pgbouncer database list and config params are defined in <code>/etc/pgbouncer/database.txt</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>meta                        = host=/var/run/postgresql mode=session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>grafana                     = host=/var/run/postgresql mode=transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bytebase                    = host=/var/run/postgresql auth_user=dbuser_meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>kong                        = host=/var/run/postgresql pool_size=32 reserve_pool=64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>gitea                       = host=/var/run/postgresql min_pool_size=10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>wiki                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>noco                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>mongo                       = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When <a href=/docs/pgsql/admin/db#create-database><strong>creating databases</strong></a>, Pgbouncer database list is refreshed via online reload - doesn&rsquo;t affect existing connections.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-be500246ccc4d0aea19a8d2e848cf128>2.6 - HBA Rules</h1><div class=lead>Detailed explanation of PostgreSQL and Pgbouncer Host-Based Authentication (HBA) rules configuration in Pigsty.</div><h2 id=overview>Overview</h2><p>HBA (Host-Based Authentication) controls &ldquo;who can connect to the database from where and how&rdquo;.
Pigsty manages HBA rules declaratively through <a href=#pg_default_hba_rules><strong><code>pg_default_hba_rules</code></strong></a> and <a href=#pg_hba_rules><strong><code>pg_hba_rules</code></strong></a>.</p><p>Pigsty renders the following config files during cluster init or HBA refresh:</p><table><thead><tr><th style=text-align:left>Config File</th><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>PostgreSQL HBA</td><td style=text-align:left><code>/pg/data/pg_hba.conf</code></td><td style=text-align:left>PostgreSQL server HBA rules</td></tr><tr><td style=text-align:left>Pgbouncer HBA</td><td style=text-align:left><code>/etc/pgbouncer/pgb_hba.conf</code></td><td style=text-align:left>Connection pool HBA rules</td></tr></tbody></table><p>HBA rules are controlled by these parameters:</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_default_hba_rules><code>pg_default_hba_rules</code></a></td><td style=text-align:left>G</td><td style=text-align:left>PostgreSQL global default HBA</td></tr><tr><td style=text-align:left><a href=#pg_hba_rules><code>pg_hba_rules</code></a></td><td style=text-align:left>G/C/I</td><td style=text-align:left>PostgreSQL cluster/instance add</td></tr><tr><td style=text-align:left><a href=#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a></td><td style=text-align:left>G</td><td style=text-align:left>Pgbouncer global default HBA</td></tr><tr><td style=text-align:left><a href=#pgb_hba_rules><code>pgb_hba_rules</code></a></td><td style=text-align:left>G/C/I</td><td style=text-align:left>Pgbouncer cluster/instance add</td></tr></tbody></table><p>Rule features:</p><ul><li><strong>Role filtering</strong>: Rules support <code>role</code> field, auto-filter based on instance&rsquo;s <code>pg_role</code></li><li><strong>Order sorting</strong>: Rules support <code>order</code> field, controls position in final config file</li><li><strong>Two syntaxes</strong>: Supports alias form (simplified) and raw form (direct HBA text)</li></ul><hr><h2 id=refresh-hba>Refresh HBA</h2><p>After modifying config, re-render config files and reload services:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;                   <span style=color:#8f5902;font-style:italic># Refresh entire cluster HBA (recommended)</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; &lt;ip&gt;...           <span style=color:#8f5902;font-style:italic># Refresh specific instances in cluster</span>
</span></span></code></pre></div><p>Script executes the following playbook:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><p><strong>PostgreSQL only</strong>: <code>./pgsql.yml -l &lt;cls> -t pg_hba,pg_reload -e pg_reload=true</code></p><p><strong>Pgbouncer only</strong>: <code>./pgsql.yml -l &lt;cls> -t pgbouncer_hba,pgbouncer_reload</code></p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Don't edit config files directly</div><p>Don&rsquo;t directly edit <code>/pg/data/pg_hba.conf</code> or <code>/etc/pgbouncer/pgb_hba.conf</code> - they&rsquo;ll be overwritten on next playbook run.
All changes should be made in <code>pigsty.yml</code>, then execute <code>bin/pgsql-hba</code> to refresh.</p></div><hr><h2 id=parameter-details>Parameter Details</h2><p><strong><code>pg_default_hba_rules</code></strong></p><p>PostgreSQL global default HBA rule list, usually defined in <code>all.vars</code>, provides base access control for all clusters.</p><ul><li>Type: <code>rule[]</code>, Level: Global (G)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title: &#39;admin @ everywhere with ssl &amp; pwd&#39;    ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong><code>pg_hba_rules</code></strong></p><p>PostgreSQL cluster/instance-level additional HBA rules, can override at cluster or instance level, merged with default rules and sorted by <code>order</code>.</p><ul><li>Type: <code>rule[]</code>, Level: Global/Cluster/Instance (G/C/I), Default: <code>[]</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: app_user, db: app_db, addr: intra, auth: pwd, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app user access&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong><code>pgb_default_hba_rules</code></strong></p><p>Pgbouncer global default HBA rule list, usually defined in <code>all.vars</code>.</p><ul><li>Type: <code>rule[]</code>, Level: Global (G)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong><code>pgb_hba_rules</code></strong></p><p>Pgbouncer cluster/instance-level additional HBA rules.</p><ul><li>Type: <code>rule[]</code>, Level: Global/Cluster/Instance (G/C/I), Default: <code>[]</code></li></ul><blockquote><p><strong>Note</strong>: Pgbouncer HBA does not support <code>db: replication</code>.</p></blockquote><hr><h2 id=rule-fields>Rule Fields</h2><p>Each HBA rule is a YAML dict supporting these fields:</p><table><thead><tr><th style=text-align:left>Field</th><th style=text-align:left>Type</th><th style=text-align:left>Required</th><th style=text-align:left>Default</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>user</code></td><td style=text-align:left>string</td><td style=text-align:left>No</td><td style=text-align:left><code>all</code></td><td style=text-align:left>Username, supports <code>all</code>, placeholders, <code>+rolename</code></td></tr><tr><td style=text-align:left><code>db</code></td><td style=text-align:left>string</td><td style=text-align:left>No</td><td style=text-align:left><code>all</code></td><td style=text-align:left>Database name, supports <code>all</code>, <code>replication</code>, db name</td></tr><tr><td style=text-align:left><code>addr</code></td><td style=text-align:left>string</td><td style=text-align:left>Yes*</td><td style=text-align:left>-</td><td style=text-align:left>Address alias or CIDR, see <a href=#address-aliases><strong>Address Aliases</strong></a></td></tr><tr><td style=text-align:left><code>auth</code></td><td style=text-align:left>string</td><td style=text-align:left>No</td><td style=text-align:left><code>pwd</code></td><td style=text-align:left>Auth method alias, see <a href=#auth-methods><strong>Auth Methods</strong></a></td></tr><tr><td style=text-align:left><code>title</code></td><td style=text-align:left>string</td><td style=text-align:left>No</td><td style=text-align:left>-</td><td style=text-align:left>Rule description, rendered as comment in config</td></tr><tr><td style=text-align:left><code>role</code></td><td style=text-align:left>string</td><td style=text-align:left>No</td><td style=text-align:left><code>common</code></td><td style=text-align:left>Instance role filter, see <a href=#role-filtering><strong>Role Filtering</strong></a></td></tr><tr><td style=text-align:left><code>order</code></td><td style=text-align:left>int</td><td style=text-align:left>No</td><td style=text-align:left><code>1000</code></td><td style=text-align:left>Sort weight, lower first, see <a href=#order-sorting><strong>Order Sorting</strong></a></td></tr><tr><td style=text-align:left><code>rules</code></td><td style=text-align:left>list</td><td style=text-align:left>Yes*</td><td style=text-align:left>-</td><td style=text-align:left>Raw HBA text lines, mutually exclusive with <code>addr</code></td></tr></tbody></table><blockquote><p>Either <code>addr</code> or <code>rules</code> must be specified. Use <code>rules</code> to write raw HBA format directly.</p></blockquote><hr><h2 id=address-aliases>Address Aliases</h2><p>Pigsty provides address aliases to simplify HBA rule writing:</p><table><thead><tr><th style=text-align:left>Alias</th><th style=text-align:left>Expands To</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>local</code></td><td style=text-align:left>Unix socket</td><td style=text-align:left>Local Unix socket</td></tr><tr><td style=text-align:left><code>localhost</code></td><td style=text-align:left>Unix socket + <code>127.0.0.1/32</code> + <code>::1/128</code></td><td style=text-align:left>Loopback addresses</td></tr><tr><td style=text-align:left><code>admin</code></td><td style=text-align:left><code>${admin_ip}/32</code></td><td style=text-align:left>Admin IP address</td></tr><tr><td style=text-align:left><code>infra</code></td><td style=text-align:left>All infra group node IPs</td><td style=text-align:left>Infrastructure nodes</td></tr><tr><td style=text-align:left><code>cluster</code></td><td style=text-align:left>All current cluster member IPs</td><td style=text-align:left>Same cluster instances</td></tr><tr><td style=text-align:left><code>intra</code> / <code>intranet</code></td><td style=text-align:left><code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code></td><td style=text-align:left>Intranet CIDRs</td></tr><tr><td style=text-align:left><code>world</code> / <code>all</code></td><td style=text-align:left><code>0.0.0.0/0</code> + <code>::/0</code></td><td style=text-align:left>Any address (IPv4 + IPv6)</td></tr><tr><td style=text-align:left><code>&lt;CIDR></code></td><td style=text-align:left>Direct use</td><td style=text-align:left>e.g., <code>192.168.1.0/24</code></td></tr></tbody></table><p>Intranet CIDRs can be customized via <code>node_firewall_intranet</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_firewall_intranet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>10.0.0.0</span><span style=color:#000>/8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>172.16.0.0</span><span style=color:#000>/12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>192.168.0.0</span><span style=color:#000>/16</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=auth-methods>Auth Methods</h2><p>Pigsty provides auth method aliases for simplified config:</p><table><thead><tr><th style=text-align:left>Alias</th><th style=text-align:left>Actual Method</th><th style=text-align:left>Connection Type</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>pwd</code></td><td style=text-align:left><code>scram-sha-256</code> or <code>md5</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>Auto-select based on <code>pg_pwd_enc</code></td></tr><tr><td style=text-align:left><code>ssl</code></td><td style=text-align:left><code>scram-sha-256</code> or <code>md5</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>Force SSL + password</td></tr><tr><td style=text-align:left><code>ssl-sha</code></td><td style=text-align:left><code>scram-sha-256</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>Force SSL + SCRAM-SHA-256</td></tr><tr><td style=text-align:left><code>ssl-md5</code></td><td style=text-align:left><code>md5</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>Force SSL + MD5</td></tr><tr><td style=text-align:left><code>cert</code></td><td style=text-align:left><code>cert</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>Client certificate auth</td></tr><tr><td style=text-align:left><code>trust</code></td><td style=text-align:left><code>trust</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>Unconditional trust (dangerous)</td></tr><tr><td style=text-align:left><code>deny</code> / <code>reject</code></td><td style=text-align:left><code>reject</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>Reject connection</td></tr><tr><td style=text-align:left><code>ident</code></td><td style=text-align:left><code>ident</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>OS user mapping (PostgreSQL)</td></tr><tr><td style=text-align:left><code>peer</code></td><td style=text-align:left><code>peer</code></td><td style=text-align:left><code>local</code></td><td style=text-align:left>OS user mapping (Pgbouncer/local)</td></tr></tbody></table><blockquote><p><code>pg_pwd_enc</code> defaults to <code>scram-sha-256</code>, can be set to <code>md5</code> for legacy client compatibility.</p></blockquote><hr><h2 id=user-variables>User Variables</h2><p>HBA rules support these user placeholders, auto-replaced with actual usernames during rendering:</p><table><thead><tr><th style=text-align:left>Placeholder</th><th style=text-align:left>Default</th><th style=text-align:left>Corresponding Param</th></tr></thead><tbody><tr><td style=text-align:left><code>${dbsu}</code></td><td style=text-align:left><code>postgres</code></td><td style=text-align:left><code>pg_dbsu</code></td></tr><tr><td style=text-align:left><code>${repl}</code></td><td style=text-align:left><code>replicator</code></td><td style=text-align:left><code>pg_replication_username</code></td></tr><tr><td style=text-align:left><code>${monitor}</code></td><td style=text-align:left><code>dbuser_monitor</code></td><td style=text-align:left><code>pg_monitor_username</code></td></tr><tr><td style=text-align:left><code>${admin}</code></td><td style=text-align:left><code>dbuser_dba</code></td><td style=text-align:left><code>pg_admin_username</code></td></tr></tbody></table><hr><h2 id=role-filtering>Role Filtering</h2><p>The <code>role</code> field in HBA rules controls which instances the rule applies to:</p><table><thead><tr><th style=text-align:left>Role</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>common</code></td><td style=text-align:left>Default, applies to all instances</td></tr><tr><td style=text-align:left><code>primary</code></td><td style=text-align:left>Primary instance only</td></tr><tr><td style=text-align:left><code>replica</code></td><td style=text-align:left>Replica instance only</td></tr><tr><td style=text-align:left><code>offline</code></td><td style=text-align:left>Offline instance only (<code>pg_role: offline</code> or <code>pg_offline_query: true</code>)</td></tr><tr><td style=text-align:left><code>standby</code></td><td style=text-align:left>Standby instance</td></tr><tr><td style=text-align:left><code>delayed</code></td><td style=text-align:left>Delayed replica instance</td></tr></tbody></table><p>Role filtering matches based on instance&rsquo;s <code>pg_role</code> variable. Non-matching rules are commented out (prefixed with <code>#</code>).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Only applies on primary: writer can only connect to primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: writer, db: all, addr: intra, auth: pwd, role: primary, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;writer only on primary&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Only applies on offline instances: ETL dedicated network</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39;, db: all, addr: &#39;172.20.0.0/16&#39;, auth: ssl, role: offline, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;offline dedicated&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=order-sorting>Order Sorting</h2><p>PostgreSQL HBA is <strong>first-match-wins</strong>, rule order is critical. Pigsty controls rule rendering order via the <code>order</code> field.</p><p><strong>Order Interval Convention</strong></p><table><thead><tr><th style=text-align:left>Interval</th><th style=text-align:left>Usage</th></tr></thead><tbody><tr><td style=text-align:left><code>0 - 99</code></td><td style=text-align:left>User high-priority rules (before all defaults)</td></tr><tr><td style=text-align:left><code>100 - 650</code></td><td style=text-align:left>Default rule zone (spaced by 50 for insertion)</td></tr><tr><td style=text-align:left><code>1000+</code></td><td style=text-align:left>User rule default (rules without <code>order</code>)</td></tr></tbody></table><p><strong>PostgreSQL Default Rules Order</strong></p><table><thead><tr><th style=text-align:left>Order</th><th style=text-align:left>Rule Description</th></tr></thead><tbody><tr><td style=text-align:left>100</td><td style=text-align:left>dbsu local ident</td></tr><tr><td style=text-align:left>150</td><td style=text-align:left>dbsu replication local</td></tr><tr><td style=text-align:left>200</td><td style=text-align:left>replicator localhost</td></tr><tr><td style=text-align:left>250</td><td style=text-align:left>replicator intra replication</td></tr><tr><td style=text-align:left>300</td><td style=text-align:left>replicator intra postgres</td></tr><tr><td style=text-align:left>350</td><td style=text-align:left>monitor localhost</td></tr><tr><td style=text-align:left>400</td><td style=text-align:left>monitor infra</td></tr><tr><td style=text-align:left>450</td><td style=text-align:left>admin infra ssl</td></tr><tr><td style=text-align:left>500</td><td style=text-align:left>admin world ssl</td></tr><tr><td style=text-align:left>550</td><td style=text-align:left>dbrole_readonly localhost</td></tr><tr><td style=text-align:left>600</td><td style=text-align:left>dbrole_readonly intra</td></tr><tr><td style=text-align:left>650</td><td style=text-align:left>dbrole_offline intra</td></tr></tbody></table><p><strong>Pgbouncer Default Rules Order</strong></p><table><thead><tr><th style=text-align:left>Order</th><th style=text-align:left>Rule Description</th></tr></thead><tbody><tr><td style=text-align:left>100</td><td style=text-align:left>dbsu local peer</td></tr><tr><td style=text-align:left>150</td><td style=text-align:left>all localhost pwd</td></tr><tr><td style=text-align:left>200</td><td style=text-align:left>monitor pgbouncer intra</td></tr><tr><td style=text-align:left>250</td><td style=text-align:left>monitor world deny</td></tr><tr><td style=text-align:left>300</td><td style=text-align:left>admin intra pwd</td></tr><tr><td style=text-align:left>350</td><td style=text-align:left>admin world deny</td></tr><tr><td style=text-align:left>400</td><td style=text-align:left>all intra pwd</td></tr></tbody></table><hr><h2 id=syntax-examples>Syntax Examples</h2><p><strong>Alias Form</strong>: Using Pigsty simplified syntax</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow grafana view access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_view</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Rendered result:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow grafana view access [primary]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  meta               dbuser_view        10.10.10.10/32     scram-sha-256</span>
</span></span></code></pre></div><p><strong>Raw Form</strong>: Using PostgreSQL HBA syntax directly</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>host all all 10.0.0.0/8 scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>host all all 172.16.0.0/12 scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>host all all 192.168.0.0/16 scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Rendered result:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow intranet password access [common]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host all all 10.0.0.0/8 scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host all all 172.16.0.0/12 scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host all all 192.168.0.0/16 scram-sha-256</span>
</span></span></code></pre></div><hr><h2 id=common-scenarios>Common Scenarios</h2><p><strong>Blacklist IP</strong>: Use <code>order: 0</code> to ensure first match</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: all, db: all, addr: &#39;10.1.1.100/32&#39;, auth: deny, order: 0, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;block bad ip&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Whitelist App Server</strong>: High priority for specific IP</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: app_user, db: app_db, addr: &#39;192.168.1.10/32&#39;, auth: ssl, order: 50, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app server&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Admin Force Certificate</strong>: Override default SSL password auth</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#204a87;font-weight:700>, db: all, addr: world, auth: cert, order: 10, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin cert only&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Offline Instance Dedicated Network</strong>: Only on offline instances</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39;, db: all, addr: &#39;172.20.0.0/16&#39;, auth: ssl-sha, role: offline, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etl network&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Restrict Access by Database</strong>: Sensitive databases limited to specific networks</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: fin_user, db: finance_db, addr: &#39;10.20.0.0/16&#39;, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;finance only&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: hr_user, db: hr_db, addr: &#39;10.30.0.0/16&#39;, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;hr only&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Pgbouncer Dedicated Rules</strong>: Note no <code>db: replication</code> support</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readwrite&#39;, db: all, addr: world, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app via pgbouncer&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=complete-cluster-example>Complete Cluster Example</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-prod</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-prod</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Blacklist: known malicious IP (highest priority)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: all, db: all, addr: &#39;10.1.1.100/32&#39;, auth: deny, order: 0, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;blacklist&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># App server whitelist (high priority)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: app_user, db: app_db, addr: &#39;192.168.1.0/24&#39;, auth: ssl, order: 50, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app servers&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># ETL tasks: offline instances only</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: etl_user, db: all, addr: &#39;172.20.0.0/16&#39;, auth: pwd, role: offline, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etl tasks&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Cluster internal monitoring</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#204a87;font-weight:700>, db: all, addr: cluster, auth: pwd, order: 380, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;cluster monitor&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgb_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># App via connection pool</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readwrite&#39;, db: all, addr: &#39;192.168.1.0/24&#39;, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app via pgbouncer&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=verification--troubleshooting>Verification & Troubleshooting</h2><p><strong>View Current HBA Rules</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;TABLE pg_hba_file_rules&#34;</span>         <span style=color:#8f5902;font-style:italic># View via SQL (recommended)</span>
</span></span><span style=display:flex><span>cat /pg/data/pg_hba.conf                  <span style=color:#8f5902;font-style:italic># View PostgreSQL HBA file</span>
</span></span><span style=display:flex><span>cat /etc/pgbouncer/pgb_hba.conf           <span style=color:#8f5902;font-style:italic># View Pgbouncer HBA file</span>
</span></span><span style=display:flex><span>grep <span style=color:#4e9a06>&#39;^#&#39;</span> /pg/data/pg_hba.conf <span style=color:#000;font-weight:700>|</span> head -20 <span style=color:#8f5902;font-style:italic># View rule titles (verify order)</span>
</span></span></code></pre></div><p><strong>Test Connection Auth</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -h &lt;host&gt; -p <span style=color:#0000cf;font-weight:700>5432</span> -U &lt;user&gt; -d &lt;db&gt; -c <span style=color:#4e9a06>&#34;SELECT 1&#34;</span>
</span></span></code></pre></div><p><strong>Common Issues</strong></p><table><thead><tr><th style=text-align:left>Error Message</th><th style=text-align:left>Possible Cause</th><th style=text-align:left>Solution</th></tr></thead><tbody><tr><td style=text-align:left><code>no pg_hba.conf entry for host...</code></td><td style=text-align:left>No matching HBA rule</td><td style=text-align:left>Add corresponding rule and refresh</td></tr><tr><td style=text-align:left><code>password authentication failed</code></td><td style=text-align:left>Wrong password or enc</td><td style=text-align:left>Check password and <code>pg_pwd_enc</code></td></tr><tr><td style=text-align:left>Rule not taking effect</td><td style=text-align:left>Not refreshed or order</td><td style=text-align:left>Run <code>bin/pgsql-hba</code>, check order</td></tr></tbody></table><hr><h2 id=important-notes>Important Notes</h2><ol><li><strong>Order sensitive</strong>: PostgreSQL HBA is first-match-wins, use <code>order</code> wisely</li><li><strong>Role matching</strong>: Ensure <code>role</code> field matches target instance&rsquo;s <code>pg_role</code></li><li><strong>Address format</strong>: CIDR must be correct, e.g., <code>10.0.0.0/8</code> not <code>10.0.0.0/255.0.0.0</code></li><li><strong>Pgbouncer limitation</strong>: Does not support <code>db: replication</code></li><li><strong>SSL prerequisite</strong>: Ensure SSL is configured before using <code>ssl</code>, <code>cert</code> auth</li><li><strong>Test first</strong>: Validate in test environment before modifying HBA</li><li><strong>Refresh on scale</strong>: Rules using <code>addr: cluster</code> need refresh after cluster membership changes</li></ol><hr><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=/docs/pgsql/admin/hba/><strong>HBA Management</strong></a>: Daily HBA rule management operations</li><li><a href=/docs/pgsql/config/user/><strong>User Config</strong></a>: User and role configuration</li><li><a href=/docs/pgsql/config/acl/><strong>Access Control</strong></a>: Role system and permission model</li><li><a href=/docs/concept/sec/><strong>Security & Compliance</strong></a>: PostgreSQL cluster security features</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f26623b2f855e9bc5073aeb50aea422a>2.7 - Access Control</h1><div class=lead>Default role system and privilege model provided by Pigsty</div><blockquote><p>Access control is determined by the combination of &ldquo;role system + privilege templates + HBA&rdquo;. This section focuses on how to declare roles and object privileges through configuration parameters.</p></blockquote><p>Pigsty provides a streamlined ACL model, fully described by the following parameters:</p><ul><li><code>pg_default_roles</code>: System roles and system users.</li><li><code>pg_users</code>: Business users and roles.</li><li><code>pg_default_privileges</code>: Default privileges for objects created by administrators/owners.</li><li><code>pg_revoke_public</code>, <code>pg_default_schemas</code>, <code>pg_default_extensions</code>: Control the default behavior of <code>template1</code>.</li></ul><p>After understanding these parameters, you can write fully reproducible privilege configurations.</p><hr><h2 id=default-role-system-pg_default_roles>Default Role System (pg_default_roles)</h2><p>By default, it includes 4 business roles + 4 system users:</p><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td>Shared by all business, has SELECT/USAGE</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>Inherits read-only role, with INSERT/UPDATE/DELETE</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>Inherits <code>pg_monitor</code> + read-write role, can create objects and triggers</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td>Restricted read-only role, only allowed to access offline instances</td></tr><tr><td><code>postgres</code></td><td>User</td><td>System superuser, same as <code>pg_dbsu</code></td></tr><tr><td><code>replicator</code></td><td>User</td><td>Used for streaming replication and backup, inherits monitoring and read-only privileges</td></tr><tr><td><code>dbuser_dba</code></td><td>User</td><td>Primary admin account, also synced to pgbouncer</td></tr><tr><td><code>dbuser_monitor</code></td><td>User</td><td>Monitoring account, has <code>pg_monitor</code> privilege, records slow SQL by default</td></tr></tbody></table><p>These definitions are in <code>pg_default_roles</code>. They can theoretically be customized, but if you replace names, you must synchronize updates in HBA/ACL/script references.</p><p>Example: Add an additional <code>dbrole_etl</code> for offline tasks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_etl, login: false, roles: [dbrole_offline], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etl read-only role&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, login: false, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pg_monitor, dbrole_readwrite, dbrole_etl] }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>Effect: All users inheriting <code>dbrole_admin</code> automatically have <code>dbrole_etl</code> privileges, can access offline instances and execute ETL.</p></blockquote><hr><h2 id=default-users-and-credential-parameters>Default Users and Credential Parameters</h2><p>System user usernames/passwords are controlled by the following parameters:</p><table><thead><tr><th>Parameter</th><th>Default Value</th><th>Purpose</th></tr></thead><tbody><tr><td><code>pg_dbsu</code></td><td><code>postgres</code></td><td>Database/system superuser</td></tr><tr><td><code>pg_dbsu_password</code></td><td>Empty string</td><td>dbsu password (disabled by default)</td></tr><tr><td><code>pg_replication_username</code></td><td><code>replicator</code></td><td>Replication username</td></tr><tr><td><code>pg_replication_password</code></td><td><code>DBUser.Replicator</code></td><td>Replication user password</td></tr><tr><td><code>pg_admin_username</code></td><td><code>dbuser_dba</code></td><td>Admin username</td></tr><tr><td><code>pg_admin_password</code></td><td><code>DBUser.DBA</code></td><td>Admin password</td></tr><tr><td><code>pg_monitor_username</code></td><td><code>dbuser_monitor</code></td><td>Monitoring user</td></tr><tr><td><code>pg_monitor_password</code></td><td><code>DBUser.Monitor</code></td><td>Monitoring user password</td></tr></tbody></table><blockquote><p>If you modify these parameters, please synchronize updates to the corresponding user definitions in <code>pg_default_roles</code> to avoid role attribute inconsistencies.</p></blockquote><hr><h2 id=business-roles-and-authorization-pg_users>Business Roles and Authorization (pg_users)</h2><p>Business users are declared through <code>pg_users</code> (see <a href=/docs/pgsql/config/user>User Configuration</a> for detailed fields), where the <code>roles</code> field controls the granted business roles.</p><p>Example: Create one read-only and one read-write user:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: app_reader,  password: DBUser.Reader,  roles: [dbrole_readonly],  pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: app_writer,  password: DBUser.Writer,  roles: [dbrole_readwrite], pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>By inheriting <code>dbrole_*</code> to control access privileges, no need to GRANT for each database separately. Combined with <a href=/docs/pgsql/config/hba><code>pg_hba_rules</code></a>, you can distinguish access sources.</p></blockquote><p>For finer-grained ACL, you can use standard <code>GRANT/REVOKE</code> in <code>baseline</code> SQL or subsequent playbooks. Pigsty won&rsquo;t prevent you from granting additional privileges.</p><hr><h2 id=default-privilege-templates-pg_default_privileges>Default Privilege Templates (pg_default_privileges)</h2><p><code>pg_default_privileges</code> will set DEFAULT PRIVILEGE on <code>postgres</code>, <code>dbuser_dba</code>, <code>dbrole_admin</code> (after business admin <code>SET ROLE</code>). The default template is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>As long as objects are created by the above administrators, they will automatically carry the corresponding privileges without manual GRANT. If business needs a custom template, simply replace this array.</p></blockquote><p>Additional notes:</p><ul><li><code>pg_revoke_public</code> defaults to <code>true</code>, meaning automatic revocation of <code>PUBLIC</code>&rsquo;s <code>CREATE</code> privilege on databases and the <code>public</code> schema.</li><li><code>pg_default_schemas</code> and <code>pg_default_extensions</code> control pre-created schemas/extensions in <code>template1/postgres</code>, typically used for monitoring objects (<code>monitor</code> schema, <code>pg_stat_statements</code>, etc.).</li></ul><hr><h2 id=common-configuration-scenarios>Common Configuration Scenarios</h2><h3 id=provide-read-only-account-for-partners>Provide Read-Only Account for Partners</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>partner_ro</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Partner.Read</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: partner_ro, db: analytics, addr: 203.0.113.0/24, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>Effect: Partner account only has default read-only privileges after login, and can only access the <code>analytics</code> database via TLS from the specified network segment.</p></blockquote><h3 id=grant-ddl-capability-to-business-administrators>Grant DDL Capability to Business Administrators</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.AppAdmin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>Business administrators can inherit the default DDL privilege template by <code>SET ROLE dbrole_admin</code> or logging in directly as <code>app_admin</code>.</p></blockquote><h3 id=customize-default-privileges>Customize Default Privileges</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT,UPDATE,DELETE ON TABLES TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT,UPDATE ON SEQUENCES TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT ON TABLES TO reporting_group</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>After replacing the default template, all objects created by administrators will carry the new privilege definitions, avoiding per-object authorization.</p></blockquote><hr><h2 id=coordination-with-other-components>Coordination with Other Components</h2><ul><li><strong>HBA Rules</strong>: Use <code>pg_hba_rules</code> to bind roles with sources (e.g., only allow <code>dbrole_offline</code> to access offline instances).</li><li><strong>Pgbouncer</strong>: Users with <code>pgbouncer: true</code> will be written to <code>userlist.txt</code>, and <code>pool_mode/pool_connlimit</code> can control connection pool-level quotas.</li><li><strong>Grafana/Monitoring</strong>: <code>dbuser_monitor</code>&rsquo;s privileges come from <code>pg_default_roles</code>. If you add a new monitoring user, remember to grant <code>pg_monitor</code> + access to the <code>monitor</code> schema.</li></ul><p>Through these parameters, you can version the privilege system along with code, truly achieving &ldquo;configuration as policy&rdquo;.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a5ab1e936057c396561d23f099852606>3 - Service/Access</h1><div class=lead>Split read and write operations, route traffic correctly, and reliably deliver PostgreSQL cluster capabilities.</div><blockquote><p>Split read and write operations, route traffic correctly, and reliably deliver PostgreSQL cluster capabilities.</p></blockquote><p><a href=#service-overview>Service</a> is an abstraction: it is the form in which database clusters provide capabilities externally, encapsulating the details of the underlying cluster.</p><p>Service is critical for <a href=#access-service>stable access</a> in production environments, showing its value during <a href=/docs/concept/ha>high availability</a> cluster automatic failovers. <a href=#personal-user>Personal users</a> typically don&rsquo;t need to worry about this concept.</p><hr><h2 id=personal-user>Personal User</h2><p>The concept of &ldquo;service&rdquo; is for production environments. Personal users/single-machine clusters can skip the complexity and directly access the database using instance names/IP addresses.</p><p>For example, Pigsty&rsquo;s default single-node <code>pg-meta</code>.<code>meta</code> database can be directly connected using three different users:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># Direct connection with DBA superuser</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># Connect with default business admin user</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># Connect with default read-only user via instance domain name</span>
</span></span></code></pre></div><hr><h2 id=service-overview>Service Overview</h2><p>In real-world production environments, we use primary-replica database clusters based on replication. Within the cluster, there is one and only one instance as the leader (<a href=/docs/pgsql/config#read-write-primary>primary</a>) that can accept writes.
Other instances (<a href=/docs/pgsql/config#read-only-replica>replicas</a>) continuously fetch change logs from the cluster leader to stay synchronized. Additionally, replicas can handle read-only requests, significantly offloading the primary in read-heavy, write-light scenarios.
Therefore, distinguishing between write requests and read-only requests to the cluster is a very common practice.</p><p>Moreover, for production environments with high-frequency short connections, we pool requests through connection pooling middleware (Pgbouncer) to reduce the overhead of connection and backend process creation. But for scenarios like ETL and change execution, we need to bypass the connection pool and directly access the database.
At the same time, high-availability clusters may experience failover during failures, which causes a change in the cluster leader. Therefore, high-availability database solutions require write traffic to automatically adapt to cluster leader changes.
These different access requirements (read-write separation, pooling vs. direct connection, automatic adaptation to failovers) ultimately abstract the concept of <strong>Service</strong>.</p><p>Typically, database clusters must provide this most basic service:</p><ul><li><strong>Read-write service (primary)</strong>: Can read and write to the database</li></ul><p>For production database clusters, at least these two services should be provided:</p><ul><li><strong>Read-write service (primary)</strong>: Write data: Only carried by the primary.</li><li><strong>Read-only service (replica)</strong>: Read data: Can be carried by replicas, but can also be carried by the primary if no replicas are available</li></ul><p>Additionally, depending on specific business scenarios, there might be other services, such as:</p><ul><li><strong>Default direct access service (default)</strong>: Service that allows (admin) users to bypass the connection pool and directly access the database</li><li><strong>Offline replica service (offline)</strong>: Dedicated replica that doesn&rsquo;t handle online read-only traffic, used for ETL and analytical queries</li><li><strong>Synchronous replica service (standby)</strong>: Read-only service with no replication delay, handled by <a href=/docs/pgsql/config#sync-standby>synchronous standby</a>/primary for read-only queries</li><li><strong>Delayed replica service (delayed)</strong>: Access older data from the same cluster from a certain time ago, handled by <a href=/docs/pgsql/config#delayed-cluster>delayed replicas</a></li></ul><hr><h2 id=default-service>Default Service</h2><p>Pigsty provides four different services by default for each PostgreSQL database cluster. Here are the default services and their definitions:</p><table><thead><tr><th>Service</th><th>Port</th><th>Description</th></tr></thead><tbody><tr><td><a href=#primary-service>primary</a></td><td>5433</td><td>Production read-write, connect to primary pool (6432)</td></tr><tr><td><a href=#replica-service>replica</a></td><td>5434</td><td>Production read-only, connect to replica pool (6432)</td></tr><tr><td><a href=#default-service>default</a></td><td>5436</td><td>Admin, ETL writes, direct access to primary (5432)</td></tr><tr><td><a href=#offline-service>offline</a></td><td>5438</td><td>OLAP, ETL, personal users, interactive queries</td></tr></tbody></table><p>Taking the default <code>pg-meta</code> cluster as an example, it provides four default services:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5433/meta   <span style=color:#8f5902;font-style:italic># pg-meta-primary : production read-write via primary pgbouncer(6432)</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5434/meta   <span style=color:#8f5902;font-style:italic># pg-meta-replica : production read-only via replica pgbouncer(6432)</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@pg-meta:5436/meta     <span style=color:#8f5902;font-style:italic># pg-meta-default : direct connection via primary postgres(5432)</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_stats:DBUser.Stats@pg-meta:5438/meta <span style=color:#8f5902;font-style:italic># pg-meta-offline : direct connection via offline postgres(5432)</span>
</span></span></code></pre></div><p>From the sample cluster <a href=/docs/pgsql/config>architecture diagram</a>, you can see how these four services work:</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>Note that the <code>pg-meta</code> domain name points to the cluster&rsquo;s L2 VIP, which in turn points to the haproxy load balancer on the cluster primary, responsible for routing traffic to different instances. See <a href=#access-service>Access Service</a> for details.</p><hr><h2 id=service-implementation>Service Implementation</h2><p>In Pigsty, services are implemented using <a href=/docs/node/param#haproxy>haproxy</a> on <a href=/docs/node>nodes</a>, differentiated by different ports on the host node.</p><p>Haproxy is enabled by default on every node managed by Pigsty to expose services, and database nodes are no exception.
Although nodes in the cluster have primary-replica distinctions from the database perspective, from the service perspective, all nodes are the same:
This means even if you access a replica node, as long as you use the correct service port, you can still use the primary&rsquo;s read-write service.
This design seals the complexity: as long as you can access any instance on the PostgreSQL cluster, you can fully access all services.</p><p>This design is similar to the NodePort service in Kubernetes. Similarly, in Pigsty, every service includes these two core elements:</p><ol><li>Access endpoints exposed via NodePort (port number, from where to access?)</li><li>Target instances chosen through Selectors (list of instances, who will handle it?)</li></ol><p>The boundary of Pigsty&rsquo;s service delivery stops at the cluster&rsquo;s HAProxy. Users can access these load balancers in various ways. Please refer to <a href=#access-service>Access Service</a>.</p><p>All services are declared through configuration files. For instance, the default PostgreSQL service is defined by the <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> parameter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can also define additional services in <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>. Both <code>pg_default_services</code> and <code>pg_services</code> are arrays of <a href=#define-service>Service Definition</a> objects.</p><hr><h2 id=define-service>Define Service</h2><p>Pigsty allows you to define your own services:</p><ul><li><a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a>: Services uniformly exposed by all PostgreSQL clusters, with four by default.</li><li><a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>: Additional PostgreSQL services, can be defined at global or cluster level as needed.</li><li><a href=/docs/node/param#haproxy_services><code>haproxy_services</code></a>: Directly customize HAProxy service content, can be used for other component access</li></ul><p>For PostgreSQL clusters, you typically only need to focus on the first two.
Each service definition will generate a new configuration file in the configuration directory of all related HAProxy instances: <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/service.j2><code>/etc/haproxy/&lt;svcname>.cfg</code></a>
Here&rsquo;s a custom service example <code>standby</code>: When you want to provide a read-only service with no replication delay, you can add this record in <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name: standby                   # required, service name, the actual svc name will be prefixed with `pg_cluster`, e.g</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># required, service exposed port (work as kubernetes service node port mode)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># optional, service bind ip address, `*` for all ip by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># required, service member selector, use JMESPath to filter inventory</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># optional, backup server selector, these instances will only be used when default selector instances are all down</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, destination port, default|postgres|pgbouncer|&lt;port_number&gt;, &#39;default&#39; by default, which means use pg_default_service_dest value</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>check: /sync                    # optional, health check url path, / by default, here using Patroni API</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync, only sync standby and primary will return 200 healthy status</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, max allowed front-end connection, default 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>balance: roundrobin             # optional, haproxy load balance algorithm (roundrobin by default, other options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>leastconn)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The service definition above will be translated to a haproxy config file <code>/etc/haproxy/pg-test-standby.conf</code> on the sample three-node <code>pg-test</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service: pg-test-standby @ 10.10.10.11:5435</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service instances 10.10.10.11, 10.10.10.13, 10.10.10.12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service backups   10.10.10.11</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>listen pg-test-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5435           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Binds to port 5435 on all IP addresses</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Load balancer works on TCP protocol</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Max connections 5000, can be increased as needed</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Load balance algorithm is rr round-robin, can also use leastconn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Enable HTTP health check</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Keep HTTP connections</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /sync  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- Using /sync here, Patroni health check API, only sync standby and primary will return 200 healthy status</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- Health check return code 200 means healthy</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers: All three instances of pg-test cluster are selected by selector: &#34;[]&#34;, as there are no filtering conditions, they will all be backend servers for pg-test-replica service. But due to /sync health check, only primary and sync standby can actually serve requests.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;----- Only primary satisfies condition pg_role == `primary`, selected by backup selector.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100         #        Therefore acts as fallback instance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>normally doesn&#39;t serve requests, only serves read-only requests after all other replicas are down, maximizing avoidance of read-write service being affected by read-only service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Here, all three instances of the <code>pg-test</code> cluster are selected by <code>selector: "[]"</code> and rendered into the backend server list of the <code>pg-test-replica</code> service. But due to the <code>/sync</code> health check, the Patroni Rest API only returns HTTP 200 status code representing healthy on the primary and <a href=/docs/pgsql/config#sync-standby>synchronous standby</a>, so only the primary and sync standby can actually serve requests.
Additionally, the primary satisfies the condition <code>pg_role == primary</code> and is selected by the backup selector, marked as a backup server, and will only be used when no other instances (i.e., sync standby) can satisfy the requirement.</p><hr><h2 id=primary-service>Primary Service</h2><p>The Primary service is probably the most critical service in production environments. It provides read-write capability to the database cluster on port 5433, with the service definition as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>The selector parameter <code>selector: "[]"</code> means all cluster members will be included in the Primary service</li><li>But only the primary can pass the health check (<code>check: /primary</code>), actually serving Primary service traffic.</li><li>The destination parameter <code>dest: default</code> means the Primary service destination is affected by the <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> parameter</li><li>The default value of <code>dest</code> is <code>default</code> which will be replaced with the value of <code>pg_default_service_dest</code>, defaulting to <code>pgbouncer</code>.</li><li>By default, the Primary service destination is the connection pool on the primary, i.e., the port specified by <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a>, defaulting to 6432</li></ul><p>If the value of <code>pg_default_service_dest</code> is <code>postgres</code>, then the primary service destination will bypass the connection pool and directly use the PostgreSQL database port (<a href=/docs/pgsql/param#pg_port><code>pg_port</code></a>, default value 5432), which is very useful for scenarios where you don&rsquo;t want to use a connection pool.</p><details><summary>Example: pg-test-primary haproxy configuration</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>listen pg-test-primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5433        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary service defaults to port 5433</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /primary</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary service defaults to using Patroni RestAPI /primary health check</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><p>Patroni&rsquo;s <a href=/docs/concept/ha>high availability</a> mechanism ensures that at most one instance&rsquo;s <code>/primary</code> health check is true at any time, so the Primary service will always route traffic to the primary instance.</p><p>One benefit of using the Primary service instead of directly connecting to the database is that if the cluster experiences a split-brain situation (for example, killing the primary Patroni with kill -9 without watchdog), Haproxy can still avoid split-brain in this situation, because it only distributes traffic when Patroni is alive and returns primary status.</p><hr><h2 id=replica-service>Replica Service</h2><p>The Replica service is second only to the Primary service in importance in production environments. It provides read-only capability to the database cluster on port 5434, with the service definition as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>The selector parameter <code>selector: "[]"</code> means all cluster members will be included in the Replica service</li><li>All instances can pass the health check (<code>check: /read-only</code>), serving Replica service traffic.</li><li>Backup selector: <code>[? pg_role == 'primary' || pg_role == 'offline' ]</code> marks the primary and <a href=/docs/pgsql/config#offline-replica>offline replicas</a> as backup servers.</li><li>Only when all <a href=/docs/pgsql/config#read-only-replica>regular replicas</a> are down will the Replica service be served by the primary or offline replicas.</li><li>The destination parameter <code>dest: default</code> means the Replica service destination is also affected by the <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> parameter</li><li>The default value of <code>dest</code> is <code>default</code> which will be replaced with the value of <code>pg_default_service_dest</code>, defaulting to <code>pgbouncer</code>, same as the <a href=#primary-service>Primary service</a></li><li>By default, the Replica service destination is the connection pool on replicas, i.e., the port specified by <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a>, defaulting to 6432</li></ul><details><summary>Example: pg-test-replica haproxy configuration</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5434</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /read-only</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><p>The Replica service is very flexible: If there are living dedicated Replica instances, it will prioritize using these instances to serve read-only requests. Only when all replica instances are down will the primary serve as a fallback for read-only requests. For the common one-primary-one-replica two-node cluster: use the replica as long as it&rsquo;s alive, use the primary only when the replica is down.</p><p>Additionally, unless all dedicated read-only instances are down, the Replica service will not use dedicated Offline instances, thus avoiding mixing online fast queries with offline slow queries and their mutual interference.</p><hr><h3 id=default-service-1>Default Service</h3><p>The Default service provides service on port 5436, and it&rsquo;s a variant of the Primary service.</p><p>The Default service always bypasses the connection pool and directly connects to PostgreSQL on the primary, which is useful for admin connections, ETL writes, CDC change data capture, etc.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If <code>pg_default_service_dest</code> is changed to <code>postgres</code>, then the Default service is completely equivalent to the Primary service except for port and name. In this case, you can consider removing Default from default services.</p><details><summary>Example: pg-test-default haproxy configuration</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-default</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5436         # &lt;--- Except for listening port/target port and service name, other configurations are the same as primary service</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><hr><h3 id=offline-service>Offline Service</h3><p>The Offline service provides service on port 5438, and it also bypasses the connection pool to directly access PostgreSQL database, typically used for slow queries/analytical queries/ETL reads/personal user interactive queries, with service definition as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The Offline service routes traffic directly to dedicated <a href=/docs/pgsql/config#offline-replica>offline replicas</a>, or regular <a href=/docs/pgsql/config#read-only-replica>read-only instances</a> marked with <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a>.</p><ul><li>The selector parameter filters two types of instances from the cluster: offline replicas with <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code>, or regular <a href=/docs/pgsql/config#read-only-replica>read-only instances</a> marked with <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code></li><li>The main difference between dedicated offline replicas and marked regular replicas is: the former doesn&rsquo;t serve <a href=#replica-service>Replica service</a> requests by default, avoiding mixing fast and slow queries, while the latter does serve by default.</li><li>The backup selector parameter filters one type of instance from the cluster: regular replicas without the offline mark, which means if offline instances or marked regular replicas are down, other regular replicas can be used to serve Offline service.</li><li>Health check <code>/replica</code> only returns 200 for replicas, primary returns error, so Offline service will never distribute traffic to the primary instance, even if only the primary remains in the cluster.</li><li>At the same time, the primary instance is neither selected by the selector nor by the backup selector, so it will never serve Offline service. Therefore, Offline service can always avoid users accessing the primary, thus avoiding impact on the primary.</li></ul><details><summary>Example: pg-test-offline haproxy configuration</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-offline</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5438</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100 backup</span>
</span></span></code></pre></div></details><p>The Offline service provides restricted read-only service, typically used for two types of queries: interactive queries (personal users), slow queries and long transactions (analytics/ETL).</p><p>The Offline service requires extra maintenance care: When the cluster undergoes primary-replica switchover or automatic failover, the instance roles will change, but Haproxy configuration won&rsquo;t automatically change. For clusters with multiple replicas, this is usually not a problem.
However, for streamlined small clusters with one-primary-one-replica where the replica runs Offline queries, primary-replica switchover means the replica becomes primary (health check fails), and the original primary becomes replica (not in Offline backend list), so no instance can serve Offline service, requiring manual <a href=/docs/pgsql/admin#reload-service>reload service</a> to make changes effective.</p><p>If your business model is relatively simple, you can consider removing Default service and Offline service, using Primary service and Replica service to directly connect to the database.</p><hr><h2 id=reload-service>Reload Service</h2><p>When cluster membership changes, such as adding/removing replicas, switchover/failover, or adjusting relative weights, you need to <a href=/docs/pgsql/admin#reload-service>reload service</a> to make the changes take effect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ip...<span style=color:#ce5c00;font-weight:700>]</span>         <span style=color:#8f5902;font-style:italic># reload service for lb cluster or lb instance</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ./pgsql.yml -t pg_service         # the actual ansible task to reload service</span>
</span></span></code></pre></div><hr><h2 id=access-service>Access Service</h2><p>The boundary of Pigsty&rsquo;s service delivery stops at the cluster&rsquo;s HAProxy. Users can access these load balancers in various ways.</p><p>The typical approach is to use DNS or VIP access, binding to all or any number of load balancers in the cluster.</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>You can use different host & port combinations, which provide PostgreSQL services in different ways.</p><p><strong>Host</strong></p><table><thead><tr><th>Type</th><th>Example</th><th>Description</th></tr></thead><tbody><tr><td>Cluster Domain Name</td><td><code>pg-test</code></td><td>Access via cluster domain name (resolved by dnsmasq @ infra nodes)</td></tr><tr><td>Cluster VIP Address</td><td><code>10.10.10.3</code></td><td>Access via L2 VIP address managed by <code>vip-manager</code>, bound to primary</td></tr><tr><td>Instance Hostname</td><td><code>pg-test-1</code></td><td>Access via any instance hostname (resolved by dnsmasq @ infra nodes)</td></tr><tr><td>Instance IP Address</td><td><code>10.10.10.11</code></td><td>Access any instance IP address</td></tr></tbody></table><p><strong>Port</strong></p><p>Pigsty uses different <strong>ports</strong> to distinguish <a href=#service-overview>pg services</a></p><table><thead><tr><th>Port</th><th>Service</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>database</td><td>Direct access to postgres server</td></tr><tr><td>6432</td><td>pgbouncer</td><td>middleware</td><td>Go through connection pool middleware before postgres</td></tr><tr><td>5433</td><td>primary</td><td>service</td><td>Access primary pgbouncer (or postgres)</td></tr><tr><td>5434</td><td>replica</td><td>service</td><td>Access replica pgbouncer (or postgres)</td></tr><tr><td>5436</td><td>default</td><td>service</td><td>Access primary postgres</td></tr><tr><td>5438</td><td>offline</td><td>service</td><td>Access offline postgres</td></tr></tbody></table><p><strong>Combinations</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Access via cluster domain</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; primary direct connection</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; primary connection pool -&gt; primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Primary Connection Pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Replica Connection Pool -&gt; Replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Primary direct connection (for Admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; offline direct connection (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Direct access via cluster VIP</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; Primary direct access</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; Primary Connection Pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Primary Connection Pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Replica Connection Pool -&gt; Replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Primary direct connection (for Admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; offline direct connect (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify any cluster instance name directly</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; Database Instance Direct Connect (singleton access)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; connection pool -&gt; database</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; connection pool -&gt; database read/write</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; connection pool -&gt; database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; database direct connect</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; database offline read/write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Directly specify any cluster instance IP access</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># Database instance direct connection (directly specify instance, no automatic traffic distribution)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># Connection Pool -&gt; Database</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; connection pool -&gt; database read/write</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; connection pool -&gt; database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; Database Direct Connections</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; database offline read-write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Smart client automatic read/write separation</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div><hr><h2 id=override-service>Override Service</h2><p>You can override the default service configuration in several ways. A common requirement is to have <a href=#primary-service>Primary service</a> and <a href=#replica-service>Replica service</a> bypass Pgbouncer connection pool and directly access PostgreSQL database.</p><p>To achieve this, you can change <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> to <code>postgres</code>, so all services with <code>svc.dest='default'</code> in the service definition will use <code>postgres</code> instead of the default <code>pgbouncer</code> as the target.</p><p>If you&rsquo;ve already pointed <a href=#primary-service>Primary service</a> to PostgreSQL, then the <a href=#default-service>default service</a> becomes redundant and can be removed.</p><p>If you don&rsquo;t need to distinguish between personal interactive queries and analytics/ETL slow queries, you can consider removing the <a href=#offline-service>Offline service</a> from the default service list <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a>.</p><p>If you don&rsquo;t need read-only replicas to share online read-only traffic, you can also remove <a href=#replica-service>Replica service</a> from the default service list.</p><hr><h2 id=delegate-service>Delegate Service</h2><p>Pigsty exposes PostgreSQL services with haproxy on nodes. All haproxy instances in the cluster are configured with the same <a href=#define-service>service definition</a>.</p><p>However, you can delegate pg service to a specific node group (e.g., dedicated haproxy lb cluster) rather than haproxy on PostgreSQL cluster members.</p><p>To do so, you need to override the default service definition with <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> and set <a href=/docs/pgsql/param#pg_service_provider><code>pg_service_provider</code></a> to the proxy group name.</p><p>For example, this configuration will expose pg cluster primary service on haproxy node group <code>proxy</code> with port 10013.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>proxy      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use load balancer on group `proxy` with port 10013</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 10013 ,dest: postgres  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>It&rsquo;s user&rsquo;s responsibility to make sure each delegate service port is <strong>unique</strong> among the proxy cluster.</p><p>A dedicated load balancer cluster example is provided in the 43-node production environment simulation <a href=/docs/deploy/install#sandbox-environment>sandbox</a>: <a href=https://github.com/pgsty/pigsty/blob/main/conf/prod.yml#L111>prod.yml</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-52d6aa237ebdf1b892ae495c94936fe3>4 - Access Control</h1><div class=lead>Default role system and privilege model provided by Pigsty</div><blockquote><p>Pigsty provides a battery-included access control model based on <a href=#role-system>role system</a> and <a href=#privilege-system>privilege system</a>.</p></blockquote><p>Access control is crucial, yet many users struggle to implement it properly. Therefore, Pigsty provides a streamlined, battery-included access control model to provide a safety net for your cluster security.</p><hr><h2 id=role-system>Role System</h2><p>Pigsty&rsquo;s default role system includes four <a href=#default-roles>default roles</a> and four <a href=#default-users>default users</a>:</p><table><thead><tr><th>Role Name</th><th>Attributes</th><th>Member of</th><th>Description</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td></td><td>role for global read-only access</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>dbrole_readonly</td><td>role for global read-write access</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>pg_monitor,dbrole_readwrite</td><td>role for admin/object creation</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td></td><td>role for restricted read-only access</td></tr><tr><td><code>postgres</code></td><td><code>SUPERUSER</code></td><td></td><td>system superuser</td></tr><tr><td><code>replicator</code></td><td><code>REPLICATION</code></td><td>pg_monitor,dbrole_readonly</td><td>system replicator</td></tr><tr><td><code>dbuser_dba</code></td><td><code>SUPERUSER</code></td><td>dbrole_admin</td><td>pgsql admin user</td></tr><tr><td><code>dbuser_monitor</code></td><td></td><td>pg_monitor</td><td>pgsql monitor user</td></tr></tbody></table><p>The detailed definitions of these <a href=/docs/pgsql/config/user#define-users>roles and users</a> are as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=default-roles>Default Roles</h2><p>There are four default roles in Pigsty:</p><ul><li>Read-Only (<code>dbrole_readonly</code>): Role for global read-only access. If other business applications need read-only access to this database, they can use this role.</li><li>Read-Write (<code>dbrole_readwrite</code>): Role for global read-write access, the primary business production account should have database read-write privileges.</li><li>Admin (<code>dbrole_admin</code>): Role with DDL privileges, typically used for business administrators or scenarios requiring table creation in applications (such as various business software).</li><li>Offline (<code>dbrole_offline</code>): Restricted read-only access role (can only access <a href=/docs/pgsql/config#offline-replica>offline</a> instances, typically for personal users and ETL tool accounts).</li></ul><p>Default roles are defined in <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>. Unless you really know what you&rsquo;re doing, it&rsquo;s recommended not to change the default role names.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  , login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access  }                           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># production read-only role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline ,   login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access (offline instance) }     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># restricted read-only role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># production read-write role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># production DDL change role</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=default-users>Default Users</h2><p>Pigsty also has four default users (system users):</p><ul><li>Superuser (<code>postgres</code>), the owner and creator of the cluster, same name as the OS dbsu.</li><li>Replication user (<code>replicator</code>), the system user used for primary-replica replication.</li><li>Monitor user (<code>dbuser_monitor</code>), a user used to monitor database and connection pool metrics.</li><li>Admin user (<code>dbuser_dba</code>), the admin user who performs daily operations and database changes.</li></ul><p>The usernames/passwords for these 4 default users are defined through 4 pairs of dedicated parameters, referenced in many places:</p><ul><li><a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a>: OS dbsu name, defaults to postgres, better not to change it</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>: dbsu password, empty string by default means no password is set for dbsu, best not to set it.</li><li><a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a>: postgres replication username, defaults to <code>replicator</code></li><li><a href=/docs/pgsql/param#pg_replication_password><code>pg_replication_password</code></a>: postgres replication password, defaults to <code>DBUser.Replicator</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a>: postgres admin username, defaults to <code>dbuser_dba</code></li><li><a href=/docs/pgsql/param#pg_admin_password><code>pg_admin_password</code></a>: postgres admin password in plain text, defaults to <code>DBUser.DBA</code></li><li><a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a>: postgres monitor username, defaults to <code>dbuser_monitor</code></li><li><a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a>: postgres monitor password, defaults to <code>DBUser.Monitor</code></li></ul><blockquote><p><strong>Remember to change these passwords in production deployment! Do not use the default values!</strong></p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database superuser name, better not to change this username.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># database superuser password, it&#39;s recommended to leave this empty! Disable dbsu password login.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system replication username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system replication password, must change this password!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system monitor username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system monitor password, must change this password!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system admin username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system admin password, must change this password!</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If you modify the default user parameters, modify the corresponding role <a href=/docs/pgsql/config/user#define-users>definitions</a> in <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true                                          ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=privilege-system>Privilege System</h2><p>Pigsty has a battery-included privilege model that works with <a href=#default-roles>default roles</a>.</p><ul><li>All users have access to all schemas.</li><li>Read-Only users (<code>dbrole_readonly</code>) can read from all tables. (SELECT, EXECUTE)</li><li>Read-Write users (<code>dbrole_readwrite</code>) can write to all tables and run DML. (INSERT, UPDATE, DELETE).</li><li>Admin users (<code>dbrole_admin</code>) can create objects and run DDL (CREATE, USAGE, TRUNCATE, REFERENCES, TRIGGER).</li><li>Offline users (<code>dbrole_offline</code>) are similar to read-only users but with restricted access, only allowed to access <a href=/docs/pgsql/config#offline-replica>offline instances</a> (<code>pg_role = 'offline'</code> or <code>pg_offline_query = true</code>)</li><li>Objects created by admin users will have correct privileges.</li><li>Default privileges are configured on all databases, including template databases.</li><li>Database connect privileges are managed by database <a href=/docs/pgsql/config/db#define-database>definitions</a>.</li><li>The <code>CREATE</code> privilege on database and <code>public</code> schema is revoked from <code>PUBLIC</code> by default.</li></ul><hr><h2 id=object-privileges>Object Privileges</h2><p>Default privileges for newly created objects in the database are controlled by the parameter <a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Objects <strong>newly created</strong> by admin users will have the above privileges by default. Use <code>\ddp+</code> to view these default privileges:</p><table><thead><tr><th>Type</th><th>Access privileges</th></tr></thead><tbody><tr><td>function</td><td>=X</td></tr><tr><td></td><td>dbrole_readonly=X</td></tr><tr><td></td><td>dbrole_offline=X</td></tr><tr><td></td><td>dbrole_admin=X</td></tr><tr><td>schema</td><td>dbrole_readonly=U</td></tr><tr><td></td><td>dbrole_offline=U</td></tr><tr><td></td><td>dbrole_admin=UC</td></tr><tr><td>sequence</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=wU</td></tr><tr><td></td><td>dbrole_admin=rwU</td></tr><tr><td>table</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=awd</td></tr><tr><td></td><td>dbrole_admin=arwdDxt</td></tr></tbody></table><hr><h2 id=default-privileges>Default Privileges</h2><p><a href=https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html><code>ALTER DEFAULT PRIVILEGES</code></a> allows you to set the privileges that will be applied to objects created in the future. It does not affect privileges assigned to already-existing objects, nor objects created by non-admin users.</p><p>In Pigsty, default privileges are defined for three roles:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dbsu</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_admin_username</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- For other business administrators, they should execute SET ROLE dbrole_admin before running DDL to use the corresponding default privilege configuration.
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>These contents will be used by the PG cluster initialization template <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>pg-init-template.sql</code></a>, rendered and output to <code>/pg/tmp/pg-init-template.sql</code> during cluster initialization.
This command will be executed on <code>template1</code> and <code>postgres</code> databases, and newly created databases will inherit these default privilege configurations through template <code>template1</code>.</p><p>That is to say, to maintain correct object privileges, you must run DDL with <strong>admin users</strong>, which could be:</p><ol><li><a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>, defaults to <code>postgres</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>{{ pg_admin_username }}</code></a>, defaults to <code>dbuser_dba</code></li><li>Business admin users granted with <code>dbrole_admin</code> role (switch to <code>dbrole_admin</code> identity via <code>SET ROLE</code>)</li></ol><p>It&rsquo;s wise to use <code>postgres</code> as the global object owner. If you wish to create objects with business admin user, you must use <code>SET ROLE dbrole_admin</code> before running DDL to maintain correct privileges.</p><p>Of course, you can also explicitly grant default privileges to business admins in the database with <code>ALTER DEFAULT PRIVILEGE FOR ROLE &lt;some_biz_admin> XXX</code>.</p><hr><h2 id=database-privileges>Database Privileges</h2><p>In Pigsty, database-level privileges are covered in <a href=#define-database>database definitions</a>.</p><p>There are 3 database-level privileges: <code>CONNECT</code>, <code>CREATE</code>, <code>TEMP</code>, and a special &lsquo;privilege&rsquo;: <code>OWNERSHIP</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># required, `name` is the only mandatory field in database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database owner, defaults to postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># optional, allow connection, true by default. false will completely disable connection to this database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># optional, revoke public connection privilege. false by default, when set to true, CONNECT privilege will be revoked from users other than owner and admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>If <code>owner</code> parameter exists, it will be used as the database owner instead of the default <a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a> (usually <code>postgres</code>)</li><li>If <code>revokeconn</code> is <code>false</code>, all users have the database&rsquo;s <code>CONNECT</code> privilege, this is the default behavior.</li><li>If <code>revokeconn</code> is explicitly set to <code>true</code>:<ul><li>The database&rsquo;s <code>CONNECT</code> privilege will be revoked from <code>PUBLIC</code>: ordinary users cannot connect to this database</li><li><code>CONNECT</code> privilege will be explicitly granted to <code>{{ pg_replication_username }}</code>, <code>{{ pg_monitor_username }}</code> and <code>{{ pg_admin_username }}</code></li><li><code>CONNECT</code> privilege will be granted to the database owner with <code>GRANT OPTION</code>, the database owner can then grant connection privileges to other users.</li></ul></li><li>The <code>revokeconn</code> option can be used to isolate cross-database access within the same cluster. You can create different business users as owners for each database and set the <code>revokeconn</code> option for them.</li></ul><details><summary>Example: Database Isolation</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.40</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.41</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_confluence, password: mc2iohos , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_gitlab, password: sdf23g22sfdd , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_readwrite ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_jira, password: sdpijfsfdsfdfs , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: confluence , revokeconn: true, owner: dbuser_confluence , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitlab , revokeconn: true, owner: dbuser_gitlab, connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: jira , revokeconn: true, owner: dbuser_jira , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=create-privileges>CREATE Privileges</h2><p>For security considerations, Pigsty revokes the <code>CREATE</code> privilege on database from <code>PUBLIC</code> by default, and this has been the default behavior since PostgreSQL 15.</p><p>The database owner can always adjust CREATE privileges as needed based on actual requirements.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3d5c83e1f406be878a7cbcafe1e9c234>5 - Administration</h1><p>Database administration and operation tasks</p></div><div class=td-content style=page-break-before:always><h1 id=pg-48b1bc6613befa103400a3961be086ff>6 - Administration</h1><div class=lead>Standard Operating Procedures (SOP) for database administration tasks</div></div><div class=td-content><h1 id=pg-17b67ff7274e6ed5025cdb1b71ec35a4>6.1 - Managing PostgreSQL Clusters</h1><div class=lead>Create/destroy PostgreSQL clusters, scale existing clusters, and clone clusters.</div><h2 id=quick-reference>Quick Reference</h2><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#create-cluster><strong>Create Cluster</strong></a></td><td style=text-align:left><code>bin/pgsql-add &lt;cls></code></td><td style=text-align:left>Create a new PostgreSQL cluster</td></tr><tr><td style=text-align:left><a href=#scale-out><strong>Expand Cluster</strong></a></td><td style=text-align:left><code>bin/pgsql-add &lt;cls> &lt;ip...></code></td><td style=text-align:left>Add replica to existing cluster</td></tr><tr><td style=text-align:left><a href=#scale-in><strong>Shrink Cluster</strong></a></td><td style=text-align:left><code>bin/pgsql-rm &lt;cls> &lt;ip...></code></td><td style=text-align:left>Remove instance from cluster</td></tr><tr><td style=text-align:left><a href=#remove-cluster><strong>Remove Cluster</strong></a></td><td style=text-align:left><code>bin/pgsql-rm &lt;cls></code></td><td style=text-align:left>Destroy entire PostgreSQL cluster</td></tr><tr><td style=text-align:left><a href=#reload-service><strong>Reload Service</strong></a></td><td style=text-align:left><code>bin/pgsql-svc &lt;cls> [ip...]</code></td><td style=text-align:left>Reload cluster load balancer config</td></tr><tr><td style=text-align:left><a href=#reload-hba><strong>Reload HBA</strong></a></td><td style=text-align:left><code>bin/pgsql-hba &lt;cls> [ip...]</code></td><td style=text-align:left>Reload cluster HBA access rules</td></tr><tr><td style=text-align:left><a href=#clone-cluster><strong>Clone Cluster</strong></a></td><td style=text-align:left>-</td><td style=text-align:left>Clone via standby cluster or PITR</td></tr></tbody></table><p>For other management tasks, see: <a href=/docs/pgsql/admin/patroni><strong>HA Management</strong></a>, <a href=/docs/pgsql/admin/user/><strong>Manage Users</strong></a>, <a href=/docs/pgsql/admin/db/><strong>Manage Databases</strong></a>.</p><hr><h2 id=create-cluster>Create Cluster</h2><p>To create a new PostgreSQL cluster, first <a href=/docs/pgsql/config/cluster><strong>define the cluster</strong></a> in the <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>, then <a href=/docs/node/admin#add-node><strong>add nodes</strong></a> and initialize:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=script aria-controls=tabs-00-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-00-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=example aria-controls=tabs-00-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add  &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># Add nodes in group &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml  -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># Use Ansible playbook to add nodes in group &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># Add nodes in pg-test group, runs ./node.yml -l pg-test</span>
</span></span></code></pre></div></div></div><p>On managed nodes, create the cluster with: (Execute <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> playbook on <strong><code>&lt;cls></code></strong> group)</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=script aria-controls=tabs-01-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-01-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=example aria-controls=tabs-01-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># Create PostgreSQL cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># Use Ansible playbook to create PostgreSQL cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># Create pg-test cluster</span>
</span></span></code></pre></div></div></div><p><strong>Example: Create 3-node PG cluster <code>pg-test</code></strong></p><div id=asciinema-942dc186323899bcee0f4643447fbd01 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-942dc186323899bcee0f4643447fbd01",o="/demo/pgsql.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[4,"Execute"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Risk: Re-running create on existing cluster</div><p>If you re-run create on an existing cluster, Pigsty won&rsquo;t remove existing data files, but service configs will be overwritten and the cluster will <strong>restart</strong>!
Additionally, if you specified a <code>baseline</code> SQL in <a href=/docs/pgsql/config/db#baseline><strong>database definition</strong></a>, it will re-execute - if it contains delete/overwrite logic, <strong>data loss</strong> may occur.</p></div><hr><h2 id=expand-cluster>Expand Cluster</h2><p>To add a new replica to an <strong>existing PostgreSQL cluster</strong>, add the <a href=/docs/pgsql/config/cluster><strong>instance definition</strong></a> to <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>: <code>all.children.&lt;cls>.hosts</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># existing member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># existing member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- new member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Scaling out is similar to <a href=#create-cluster><strong>creating a cluster</strong></a>. First add the new node to Pigsty: <a href=/docs/node/admin#add-node><strong>Add Node</strong></a>:</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=script aria-controls=tabs-04-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-04-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=example aria-controls=tabs-04-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add &lt;ip&gt;       <span style=color:#8f5902;font-style:italic># Add node with IP &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -l &lt;ip&gt;      <span style=color:#8f5902;font-style:italic># Use Ansible playbook to add node &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add 10.10.10.13    <span style=color:#8f5902;font-style:italic># Add node 10.10.10.13, runs ./node.yml -l 10.10.10.13</span>
</span></span></code></pre></div></div></div><p>Then run the following on the new node to scale out (Install <a href=/docs/pgsql><strong>PGSQL module</strong></a> on new node with same <a href=/docs/pgsql/param#pg_cluster><strong><code>pg_cluster</code></strong></a>):</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=script aria-controls=tabs-05-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-05-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab data-td-tp-persist=example aria-controls=tabs-05-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add &lt;cls&gt; &lt;ip&gt;  <span style=color:#8f5902;font-style:italic># Add node &lt;ip&gt; to cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;       <span style=color:#8f5902;font-style:italic># Core: Use Ansible playbook to install PGSQL module on &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test 10.10.10.13   <span style=color:#8f5902;font-style:italic># Scale out pg-test with node 10.10.10.13</span>
</span></span></code></pre></div></div></div><p>After scaling, you should <a href=/docs/pgsql/admin/service#reload-service><strong>Reload Service</strong></a> to add the new member to load balancer.</p><p><strong>Example: Add replica <code>10.10.10.13</code> to 2-node cluster <code>pg-test</code></strong></p><div id=asciinema-05fce5eacdeb3446795df8299bfa61bb class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-05fce5eacdeb3446795df8299bfa61bb",o="/demo/pgsql-append.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=shrink-cluster>Shrink Cluster</h2><p>To remove a replica from an <strong>existing PostgreSQL cluster</strong>, remove the <a href=/docs/pgsql/config/cluster><strong>instance definition</strong></a> from <a href=/docs/concept/iac/inventory><strong>inventory</strong></a> <code>all.children.&lt;cls>.hosts</code>.</p><p>First uninstall PGSQL module from target node (Execute <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> on <strong><code>&lt;ip></code></strong>):</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist=script aria-controls=tabs-07-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-07-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab data-td-tp-persist=example aria-controls=tabs-07-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm &lt;cls&gt; &lt;ip&gt;   <span style=color:#8f5902;font-style:italic># Remove PostgreSQL instance on &lt;ip&gt; from cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;ip&gt;    <span style=color:#8f5902;font-style:italic># Use Ansible playbook to remove PostgreSQL instance on &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-test 10.10.10.13  <span style=color:#8f5902;font-style:italic># Remove 10.10.10.13 from pg-test cluster</span>
</span></span></code></pre></div></div></div><p>After removing PGSQL module, optionally remove the node from Pigsty: <a href=/docs/node/admin#remove-node><strong>Remove Node</strong></a>:</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=script aria-controls=tabs-08-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-08-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab data-td-tp-persist=example aria-controls=tabs-08-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm &lt;ip&gt;          <span style=color:#8f5902;font-style:italic># Remove node &lt;ip&gt; from Pigsty management</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node-rm.yml -l &lt;ip&gt;     <span style=color:#8f5902;font-style:italic># Use Ansible playbook to remove node &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm 10.10.10.13   <span style=color:#8f5902;font-style:italic># Remove node 10.10.10.13 from Pigsty</span>
</span></span></code></pre></div></div></div><p>After scaling in, remove the instance from <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>, then <a href=/docs/pgsql/admin/service#reload-service><strong>Reload Service</strong></a> to remove it from load balancer.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- remove after execution</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Example: Remove replica <code>10.10.10.13</code> from 3-node cluster <code>pg-test</code></strong></p><div id=asciinema-89bfaa9d26b25502fcaa59352090b5f0 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-89bfaa9d26b25502fcaa59352090b5f0",o="/demo/pgsql-shrink.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=remove-cluster>Remove Cluster</h2><p>To destroy a cluster, uninstall PGSQL module from all nodes (Execute <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> on <strong><code>&lt;cls></code></strong>):</p><ul class="nav nav-tabs" id=tabs-10 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-10-00-tab data-bs-toggle=tab data-bs-target=#tabs-10-00 role=tab data-td-tp-persist=script aria-controls=tabs-10-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-10-01-tab data-bs-toggle=tab data-bs-target=#tabs-10-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-10-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-10-02-tab data-bs-toggle=tab data-bs-target=#tabs-10-02 role=tab data-td-tp-persist=example aria-controls=tabs-10-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-10-content><div class="tab-body tab-pane fade show active" id=tabs-10-00 role=tabpanel aria-labelled-by=tabs-10-00-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm &lt;cls&gt;        <span style=color:#8f5902;font-style:italic># Destroy entire PostgreSQL cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-01 role=tabpanel aria-labelled-by=tabs-10-01-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook to destroy cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-02 role=tabpanel aria-labelled-by=tabs-10-02-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-test      <span style=color:#8f5902;font-style:italic># Destroy pg-test cluster</span>
</span></span></code></pre></div></div></div><p>After destroying PGSQL, optionally remove all nodes from Pigsty: <a href=/docs/node/admin#remove-node><strong>Remove Node</strong></a> (optional if other services exist):</p><ul class="nav nav-tabs" id=tabs-11 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-11-00-tab data-bs-toggle=tab data-bs-target=#tabs-11-00 role=tab data-td-tp-persist=script aria-controls=tabs-11-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-11-01-tab data-bs-toggle=tab data-bs-target=#tabs-11-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-11-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-11-02-tab data-bs-toggle=tab data-bs-target=#tabs-11-02 role=tab data-td-tp-persist=example aria-controls=tabs-11-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-11-content><div class="tab-body tab-pane fade show active" id=tabs-11-00 role=tabpanel aria-labelled-by=tabs-11-00-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm &lt;cls&gt;         <span style=color:#8f5902;font-style:italic># Remove all nodes in group &lt;cls&gt; from Pigsty</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-01 role=tabpanel aria-labelled-by=tabs-11-01-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node-rm.yml -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># Use Ansible playbook to remove nodes in group &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-02 role=tabpanel aria-labelled-by=tabs-11-02-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm pg-test       <span style=color:#8f5902;font-style:italic># Remove all pg-test nodes from Pigsty</span>
</span></span></code></pre></div></div></div><p>After removal, delete the entire <a href=/docs/pgsql/config/cluster><strong>cluster definition</strong></a> from <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># remove this cluster definition group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Example: Destroy 3-node PG cluster <code>pg-test</code></strong></p><div id=asciinema-4b148718963c7bab646e97087cabccda class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-4b148718963c7bab646e97087cabccda",o="/demo/pgsql-rm.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><p>Note: If <a href=/docs/pgsql/param#pg_safeguard><strong><code>pg_safeguard</code></strong></a> is configured (or globally <code>true</code>), <code>pgsql-rm.yml</code> will abort to prevent accidental removal.
Override with playbook command line to force removal.
By default, cluster backup repo is deleted with the cluster. To preserve backups (e.g., with centralized repo), set <a href=/docs/pgsql/param#pg_rm_backup><strong><code>pg_rm_backup=false</code></strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l pg-meta -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># force remove protected cluster pg-meta</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-meta -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># preserve backup repo during removal</span>
</span></span></code></pre></div><hr><h2 id=reload-service>Reload Service</h2><p>PostgreSQL clusters expose <a href=/docs/pgsql/service/><strong>services</strong></a> via <a href=/docs/concept/arch/pgsql#haproxy><strong>HAProxy</strong></a> on host nodes.
When service definitions change, instance weights change, or cluster membership changes (e.g., <a href=#scale-out><strong>scale out</strong></a>/<a href=#scale-in><strong>scale in</strong></a>, switchover/failover), reload services to update load balancer config.</p><p>To reload service config on entire cluster or specific instances (Execute <code>pg_service</code> subtask of <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> on <strong><code>&lt;cls></code></strong> or <strong><code>&lt;ip></code></strong>):</p><ul class="nav nav-tabs" id=tabs-13 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-13-00-tab data-bs-toggle=tab data-bs-target=#tabs-13-00 role=tab data-td-tp-persist=script aria-controls=tabs-13-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-13-01-tab data-bs-toggle=tab data-bs-target=#tabs-13-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-13-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-13-02-tab data-bs-toggle=tab data-bs-target=#tabs-13-02 role=tab data-td-tp-persist=example aria-controls=tabs-13-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-13-content><div class="tab-body tab-pane fade show active" id=tabs-13-00 role=tabpanel aria-labelled-by=tabs-13-00-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># Reload service config for entire cluster &lt;cls&gt;</span>
</span></span><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; &lt;ip...&gt;   <span style=color:#8f5902;font-style:italic># Reload service config for specific instances</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-13-01 role=tabpanel aria-labelled-by=tabs-13-01-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_service -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>        <span style=color:#8f5902;font-style:italic># Reload entire cluster</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;  -t pg_service -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>        <span style=color:#8f5902;font-style:italic># Reload specific instance</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-13-02 role=tabpanel aria-labelled-by=tabs-13-02-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc pg-test                 <span style=color:#8f5902;font-style:italic># Reload pg-test cluster service config</span>
</span></span><span style=display:flex><span>bin/pgsql-svc pg-test 10.10.10.13     <span style=color:#8f5902;font-style:italic># Reload pg-test 10.10.10.13 instance service config</span>
</span></span></code></pre></div></div></div><blockquote><p>Note: If using dedicated load balancer cluster (<a href=/docs/pgsql/param#pg_service_provider><strong><code>pg_service_provider</code></strong></a>), only reloading cluster primary updates the LB config.</p></blockquote><p><strong>Example: Reload <code>pg-test</code> cluster service config</strong></p><div id=asciinema-d04ae8e428be2e84e61f51c21cb4556e class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-d04ae8e428be2e84e61f51c21cb4556e",o="/demo/pgsql-svc.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><details><summary>Example: Reload PG Service to Remove Instance</summary><p><a href=https://asciinema.org/a/568815><img src=https://asciinema.org/a/568815.svg alt=asciicast></a></p></details><hr><h2 id=reload-hba>Reload HBA</h2><p>When HBA configs change, reload HBA rules to apply. (<a href=/docs/pgsql/param#pg_hba_rules><strong><code>pg_hba_rules</code></strong></a> / <a href=/docs/pgsql/param#pgb_hba_rules><strong><code>pgb_hba_rules</code></strong></a>)
If you have role-specific HBA rules or IP ranges referencing cluster member aliases, reload HBA after switchover/scaling.</p><p>To reload PG and Pgbouncer HBA rules on entire cluster or specific instances (Execute HBA subtasks of <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> on <strong><code>&lt;cls></code></strong> or <strong><code>&lt;ip></code></strong>):</p><ul class="nav nav-tabs" id=tabs-15 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-15-00-tab data-bs-toggle=tab data-bs-target=#tabs-15-00 role=tab data-td-tp-persist=script aria-controls=tabs-15-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-15-01-tab data-bs-toggle=tab data-bs-target=#tabs-15-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-15-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-15-02-tab data-bs-toggle=tab data-bs-target=#tabs-15-02 role=tab data-td-tp-persist=example aria-controls=tabs-15-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-15-content><div class="tab-body tab-pane fade show active" id=tabs-15-00 role=tabpanel aria-labelled-by=tabs-15-00-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># Reload HBA rules for entire cluster &lt;cls&gt;</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; &lt;ip...&gt;   <span style=color:#8f5902;font-style:italic># Reload HBA rules for specific instances</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-15-01 role=tabpanel aria-labelled-by=tabs-15-01-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>   <span style=color:#8f5902;font-style:italic># Reload entire cluster</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;  -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>   <span style=color:#8f5902;font-style:italic># Reload specific instance</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-15-02 role=tabpanel aria-labelled-by=tabs-15-02-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba pg-test                 <span style=color:#8f5902;font-style:italic># Reload pg-test cluster HBA rules</span>
</span></span><span style=display:flex><span>bin/pgsql-hba pg-test 10.10.10.13     <span style=color:#8f5902;font-style:italic># Reload pg-test 10.10.10.13 instance HBA rules</span>
</span></span></code></pre></div></div></div><p><strong>Example: Reload <code>pg-test</code> cluster HBA rules</strong></p><div id=asciinema-ff9b13ed062434f2b3b348cc9909ad10 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ff9b13ed062434f2b3b348cc9909ad10",o="/demo/pgsql-hba.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=config-cluster>Config Cluster</h2><p>PostgreSQL config params are managed by Patroni. Initial params are specified by <a href=/docs/pgsql/template/><strong>Patroni config template</strong></a>.
After cluster init, config is stored in Etcd, dynamically managed and synced by Patroni.
Most Patroni <a href=/docs/pgsql/admin/patroni#edit-config><strong>config params</strong></a> can be modified via <code>patronictl</code>.
Other params (e.g., etcd DCS config, log/RestAPI config) can be updated via subtasks. For example, when <a href=/docs/etcd><strong>etcd</strong></a> cluster membership changes, refresh Patroni config:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-test -t pg_conf                   <span style=color:#8f5902;font-style:italic># Update Patroni config file</span>
</span></span><span style=display:flex><span>ansible pg-test -b -a <span style=color:#4e9a06>&#39;systemctl reload patroni&#39;</span>    <span style=color:#8f5902;font-style:italic># Reload Patroni service</span>
</span></span></code></pre></div><p>You can override Patroni-managed defaults at different levels: <a href=/docs/pgsql/param#pg_parameters><strong>specify params per instance</strong></a>,
<a href=/docs/pgsql/admin/user><strong>specify params per user</strong></a>, or <a href=/docs/pgsql/admin/db><strong>specify params per database</strong></a>.</p><hr><h2 id=clone-cluster>Clone Cluster</h2><p>Two ways to clone a cluster: use <a href=/docs/pgsql/config/cluster#standby-cluster><strong>Standby Cluster</strong></a>, or use <a href=/docs/pgsql/backup/restore#quick-start><strong>Point-in-Time Recovery</strong></a>.
The former is simple with no dependencies but only clones latest state; the latter requires centralized <a href=/docs/pgsql/backup/repository><strong>backup repository</strong></a> (e.g., MinIO) but can clone to any point within retention period.</p><table><thead><tr><th style=text-align:left>Method</th><th style=text-align:left>Pros</th><th style=text-align:left>Cons</th><th style=text-align:left>Use Cases</th></tr></thead><tbody><tr><td style=text-align:left>Standby Cluster</td><td style=text-align:left>Simple, no dependencies</td><td style=text-align:left>Only clones latest state</td><td style=text-align:left>DR, read-write separation, migration</td></tr><tr><td style=text-align:left>PITR</td><td style=text-align:left>Recover to any point</td><td style=text-align:left>Requires centralized backup</td><td style=text-align:left>Undo mistakes, data audit</td></tr></tbody></table><h3 id=clone-via-standby-cluster>Clone via Standby Cluster</h3><p>Standby Cluster continuously syncs from upstream cluster via streaming replication - the simplest cloning method.
Specify <a href=/docs/pgsql/param#pg_upstream><strong><code>pg_upstream</code></strong></a> on the new cluster primary to auto-pull data from upstream.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test is the original cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test2 is standby cluster (clone) of pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># specify upstream</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test2 }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Create standby cluster with:</p><ul class="nav nav-tabs" id=tabs-17 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-17-00-tab data-bs-toggle=tab data-bs-target=#tabs-17-00 role=tab data-td-tp-persist=script aria-controls=tabs-17-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-17-01-tab data-bs-toggle=tab data-bs-target=#tabs-17-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-17-01 aria-selected=false>
Playbook</button></li></ul><div class=tab-content id=tabs-17-content><div class="tab-body tab-pane fade show active" id=tabs-17-00 role=tabpanel aria-labelled-by=tabs-17-00-tab tabindex=17><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test2    <span style=color:#8f5902;font-style:italic># Create standby cluster, auto-clone from upstream pg-test</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-17-01 role=tabpanel aria-labelled-by=tabs-17-01-tab tabindex=17><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-test2   <span style=color:#8f5902;font-style:italic># Use Ansible playbook to create standby cluster</span>
</span></span></code></pre></div></div></div><p>Standby cluster follows upstream, keeping data in sync. <strong>Promote</strong> to independent cluster anytime:</p><details><summary>Example: Promote Standby to Independent Cluster</summary><p>Via <a href=#config-cluster><strong>Config Cluster</strong></a>, remove <code>standby_cluster</code> config to promote:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>-standby_cluster:
</span></span><span style=display:flex><span>-  create_replica_methods:
</span></span><span style=display:flex><span>-  - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11
</span></span><span style=display:flex><span>-  port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>After promotion, <code>pg-test2</code> becomes independent cluster accepting writes, forked from <code>pg-test</code>.</p></details><details><summary>Example: Change Replication Upstream</summary><p>If upstream cluster switchover occurs, change standby cluster upstream via <a href=#config-cluster><strong>Config Cluster</strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11     <span style=color:#8f5902;font-style:italic># &lt;--- old upstream</span>
</span></span><span style=display:flex><span>+  host: 10.10.10.14     <span style=color:#8f5902;font-style:italic># &lt;--- new upstream</span>
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><h3 id=clone-via-pitr>Clone via PITR</h3><p><a href=/docs/pgsql/backup/restore><strong>Point-in-Time Recovery</strong></a> (PITR) allows recovery to any point within backup retention.
Requires centralized <a href=/docs/pgsql/backup/repository><strong>backup repository</strong></a> (MinIO/S3), but more powerful.</p><p>To clone via PITR, add <a href=/docs/pgsql/param#pg_pitr><strong><code>pg_pitr</code></strong></a> param specifying recovery target:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Clone new cluster pg-meta2 from pg-meta backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Recover from pg-meta backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-01-10 10:00:00+00&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Recover to specific time</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Execute clone with <code>pgsql-pitr.yml</code> playbook:</p><ul class="nav nav-tabs" id=tabs-18 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-18-00-tab data-bs-toggle=tab data-bs-target=#tabs-18-00 role=tab data-td-tp-persist=playbook aria-controls=tabs-18-00 aria-selected=true>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-18-01-tab data-bs-toggle=tab data-bs-target=#tabs-18-01 role=tab data-td-tp-persist=cli aria-controls=tabs-18-01 aria-selected=false>
CLI</button></li></ul><div class=tab-content id=tabs-18-content><div class="tab-body tab-pane fade show active" id=tabs-18-00 role=tabpanel aria-labelled-by=tabs-18-00-tab tabindex=18><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2    <span style=color:#8f5902;font-style:italic># Clone pg-meta2 from pg-meta backup</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-18-01 role=tabpanel aria-labelled-by=tabs-18-01-tab tabindex=18><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify PITR options via command line</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-01-10 10:00:00+00&#34;}}&#39;</span>
</span></span></code></pre></div></div></div><p>PITR supports multiple recovery target types:</p><table><thead><tr><th style=text-align:left>Target Type</th><th style=text-align:left>Example</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>Time</td><td style=text-align:left><code>time: "2025-01-10 10:00:00+00"</code></td><td style=text-align:left>Recover to specific timestamp</td></tr><tr><td style=text-align:left>XID</td><td style=text-align:left><code>xid: "250000"</code></td><td style=text-align:left>Recover to before/after txn</td></tr><tr><td style=text-align:left>Name</td><td style=text-align:left><code>name: "before_migration"</code></td><td style=text-align:left>Recover to named restore point</td></tr><tr><td style=text-align:left>LSN</td><td style=text-align:left><code>lsn: "0/4001C80"</code></td><td style=text-align:left>Recover to specific WAL pos</td></tr><tr><td style=text-align:left>Latest</td><td style=text-align:left><code>type: "latest"</code></td><td style=text-align:left>Recover to end of WAL archive</td></tr></tbody></table><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>Post-PITR Processing</div><p>Recovered cluster has <code>archive_mode</code> <strong>disabled</strong> to prevent accidental WAL overwrites.
If recovered data is correct, enable archiving and perform new full backup:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode; SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>pg-backup full    <span style=color:#8f5902;font-style:italic># Execute new full backup</span>
</span></span></code></pre></div></div><p>For detailed PITR usage, see <a href=/docs/pgsql/backup/restore><strong>Restore Operations</strong></a> documentation.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-81e255f632d154a2662d19c783c4514a>6.2 - Managing PostgreSQL Users</h1><div class=lead>User management - create, modify, delete users, manage role membership, connection pool config</div><h2 id=quick-start>Quick Start</h2><p>Pigsty uses declarative management: first <a href=/docs/pgsql/config/user><strong>define users</strong></a> in the <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>, then use <code>bin/pgsql-user &lt;cls> &lt;username></code> to create or modify.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_app, password: &#39;DBUser.App&#39;, pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># &lt;--- Define user list here!</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=script aria-controls=tabs-00-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-00-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=example aria-controls=tabs-00-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># Create/modify &lt;username&gt; user on &lt;cls&gt; cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l pg-meta -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_app    <span style=color:#8f5902;font-style:italic># Use playbook to create/modify user</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># Create/modify dbuser_app user on pg-meta cluster</span>
</span></span></code></pre></div></div></div><p>For complete user definition reference, see <a href=/docs/pgsql/config/user><strong>User Configuration</strong></a>. For access permissions, see <a href=/docs/concept/sec/ac/#default-roles><strong>ACL: Role Privileges</strong></a>.</p><p>Note: User <code>name</code> cannot be modified after creation. To rename, delete the old user and create new one.</p><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#create-user><strong>Create User</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>Create new business user or role</td></tr><tr><td style=text-align:left><a href=#modify-user><strong>Modify User</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>Modify existing user properties</td></tr><tr><td style=text-align:left><a href=#delete-user><strong>Delete User</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>Safe delete user (requires <code>state: absent</code>)</td></tr></tbody></table><div id=asciinema-ea4542a7c787faec4a82af4534ee61d2 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ea4542a7c787faec4a82af4534ee61d2",o="/demo/pgsql-user.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=create-user>Create User</h2><p>Users defined in <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> are auto-created during PostgreSQL <a href=/docs/pgsql/admin/cluster#create-cluster><strong>cluster creation</strong></a> in the <code>pg_user</code> task.</p><p>To create a new user on an existing cluster, add <a href=/docs/pgsql/config/user><strong>user definition</strong></a> to <code>all.children.&lt;cls>.pg_users</code>, then execute:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=script aria-controls=tabs-02-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-02-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=example aria-controls=tabs-02-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;   <span style=color:#8f5902;font-style:italic># Create user &lt;username&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;username&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># Create dbuser_app user in pg-meta cluster</span>
</span></span></code></pre></div></div></div><p><strong>Example: Create business user <code>dbuser_app</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars.pg_users:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>application user for myapp</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Result</strong>: Creates <code>dbuser_app</code> user on primary, sets password, grants <code>dbrole_readwrite</code> role, adds to Pgbouncer pool, reloads Pgbouncer config on all instances.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Recommendation: Use playbook</div><p>For manual user creation, you must ensure Pgbouncer user list sync yourself.</p></div><hr><h2 id=modify-user>Modify User</h2><p>Same command as create - playbook is idempotent. When target user exists, Pigsty modifies properties to match config.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=script aria-controls=tabs-04-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-04-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=example aria-controls=tabs-04-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;user&gt;   <span style=color:#8f5902;font-style:italic># Modify user &lt;user&gt; properties</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;user&gt;   <span style=color:#8f5902;font-style:italic># Idempotent, can repeat</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># Modify dbuser_app to match config</span>
</span></span></code></pre></div></div></div><p><strong>Immutable properties</strong>: User <code>name</code> can&rsquo;t be modified after creation - requires delete and recreate.</p><p>All other properties can be modified. Common examples:</p><p><strong>Modify password</strong>: Update <code>password</code> field. Logging is temporarily disabled during password change to prevent leakage.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>NewSecretPassword    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># New password</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Modify privilege attributes</strong>: Configure boolean flags for user privileges.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Superuser (use carefully!)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Allow CREATE DATABASE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># Allow CREATE ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Auto-inherit role privileges</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Allow streaming replication</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Bypass row-level security</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Connection limit, -1 unlimited</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Modify expiration</strong>: Use <code>expire_in</code> for relative expiry (N days), or <code>expire_at</code> for absolute date. <code>expire_in</code> takes priority and recalculates on each playbook run - good for temp users needing periodic renewal.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Expires in 30 days (relative)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Expires on date (absolute)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>permanent_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Never expires</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Modify role membership</strong>: Use <code>roles</code> array with simple or extended format. Role membership is additive - won&rsquo;t remove undeclared existing roles. Use <code>state: absent</code> to explicitly revoke.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>dbrole_readwrite                      # Simple form</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grant role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># With ADMIN OPTION</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set: false }      # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disallow SET ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Revoke role membership</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manage user parameters</strong>: Use <code>parameters</code> dict for user-level params, generates <code>ALTER USER ... SET</code>. Use <code>DEFAULT</code> to reset.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Reset to default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Connection pool config</strong>: Set <code>pgbouncer: true</code> to add user to pool. Optional <code>pool_mode</code> and <code>pool_connlimit</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Add to pool</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Pool mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Max user connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=delete-user>Delete User</h2><p>To delete a user, set <code>state</code> to <code>absent</code> and execute:</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=script aria-controls=tabs-05-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-05-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab data-td-tp-persist=example aria-controls=tabs-05-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;user&gt;   <span style=color:#8f5902;font-style:italic># Delete &lt;user&gt; (config must have state: absent)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;user&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_old    <span style=color:#8f5902;font-style:italic># Delete dbuser_old (config has state: absent)</span>
</span></span></code></pre></div></div></div><p><strong>Config example</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_old</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Deletion process</strong>: Uses <code>pg-drop-role</code> script for safe deletion; auto-disables login and terminates connections; transfers database/tablespace ownership to <code>postgres</code>; handles object ownership in all databases; revokes all role memberships; creates audit log; removes from Pgbouncer and reloads config.</p><p><strong>Protection</strong>: These system users cannot be deleted and are auto-skipped: <code>postgres</code> (superuser), <code>replicator</code> (or <a href=/docs/pgsql/param#pg_replication_username><strong><code>pg_replication_username</code></strong></a>), <code>dbuser_dba</code> (or <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a>), <code>dbuser_monitor</code> (or <a href=/docs/pgsql/param#pg_monitor_username><strong><code>pg_monitor_username</code></strong></a>).</p><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>Safe Deletion</div><p>Pigsty uses <code>pg-drop-role</code> for safe deletion, auto-handling owned databases, tablespaces, schemas, tables, etc. Terminates active connections, transfers ownership to <code>postgres</code>, creates audit log at <code>/tmp/pg_drop_role_&lt;user>_&lt;timestamp>.log</code>. No manual dependency handling needed.</p></div><hr><h2 id=manual-deletion>Manual Deletion</h2><p>For manual user deletion, use <code>pg-drop-role</code> script directly:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check dependencies (read-only)</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --check
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Preview deletion (don&#39;t execute)</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --dry-run -v
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete user, transfer objects to postgres</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Force delete (terminate connections)</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete user, transfer to specific user</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old dbuser_new
</span></span></code></pre></div><hr><h2 id=common-use-cases>Common Use Cases</h2><p>Common user configuration examples:</p><p><strong>Basic business user</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>application user</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Read-only user</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Admin user (can execute DDL)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Temp user (expires in 30 days)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_contractor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>TempPassword</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Role (no login, for permission grouping)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom_role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom role for special permissions</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>User with advanced role options (PG16+)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_execute_server_program, inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=query-users>Query Users</h2><p>Common SQL queries for user info:</p><p><strong>List all users</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolsuper</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolinherit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolcreaterole</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolcreatedb</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>rolcanlogin</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolreplication</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolbypassrls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolconnlimit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_%&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View user role membership</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>member</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>admin_option</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_option</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inherit_option</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_auth_members</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>roleid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbuser_app&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View user-level parameters</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>setconfig</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_db_role_setting</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setrole</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setdatabase</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View expiring users</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>time_remaining</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87>INTERVAL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30 days&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=connection-pool-management>Connection Pool Management</h2><p><a href=/docs/pgsql/config/user#pgbouncer><strong>Connection pool params</strong></a> in user definitions are applied to Pgbouncer when creating/modifying users.</p><p>Users with <code>pgbouncer: true</code> are added to <code>/etc/pgbouncer/userlist.txt</code>. User-level pool params (<code>pool_mode</code>, <code>pool_connlimit</code>) are configured via <code>/etc/pgbouncer/useropts.txt</code>.</p><p>Use <code>postgres</code> OS user with <code>pgb</code> alias to access Pgbouncer admin database. For more pool management, see <a href=/docs/pgsql/admin/pgbouncer><strong>Pgbouncer Management</strong></a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9dd15cada3b5a59a9375eadbdeec7bf7>6.3 - Managing PostgreSQL Databases</h1><div class=lead>Database management - create, modify, delete, rebuild, and clone databases using templates</div><h2 id=quick-start>Quick Start</h2><p>Pigsty uses declarative management: first <a href=/docs/pgsql/config/db><strong>define databases</strong></a> in the <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>, then use <code>bin/pgsql-db &lt;cls> &lt;dbname></code> to create or modify.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>some_db }] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Define database list here!</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=script aria-controls=tabs-00-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-00-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=example aria-controls=tabs-00-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style=color:#8f5902;font-style:italic># Create/modify &lt;dbname&gt; database on &lt;cls&gt; cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l pg-meta -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>some_db    <span style=color:#8f5902;font-style:italic># Use playbook to create/modify database</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta some_db    <span style=color:#8f5902;font-style:italic># Create/modify some_db database on pg-meta cluster</span>
</span></span></code></pre></div></div></div><p>For complete database definition reference, see <a href=/docs/pgsql/config/db><strong>Database Configuration</strong></a>. For access permissions, see <a href=/docs/concept/sec/ac/#database-privileges><strong>ACL: Database Privileges</strong></a>.</p><p>Note: Some parameters can only be specified at <strong>creation time</strong>. Modifying these requires recreating the database (use <code>state: recreate</code>).</p><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#create-database><strong>Create Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Create new business database</td></tr><tr><td style=text-align:left><a href=#modify-database><strong>Modify Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Modify existing database properties</td></tr><tr><td style=text-align:left><a href=#delete-database><strong>Delete Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Delete database (requires <code>state: absent</code>)</td></tr><tr><td style=text-align:left><a href=#rebuild-database><strong>Rebuild Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Drop and recreate (requires <code>state: recreate</code>)</td></tr><tr><td style=text-align:left><a href=#clone-database><strong>Clone Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Clone database using template</td></tr></tbody></table><div id=asciinema-cd66826a3d08fab10d21e9ac82d386f7 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-cd66826a3d08fab10d21e9ac82d386f7",o="/demo/pgsql-db.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=create-database>Create Database</h2><p>Databases defined in <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> are auto-created during PostgreSQL <a href=/docs/pgsql/admin/cluster#create-cluster><strong>cluster creation</strong></a> in the <code>pg_db</code> task.</p><p>To create a new database on an existing cluster, add <a href=/docs/pgsql/config/db><strong>database definition</strong></a> to <code>all.children.&lt;cls>.pg_databases</code>, then execute:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=script aria-controls=tabs-02-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-02-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=example aria-controls=tabs-02-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;   <span style=color:#8f5902;font-style:italic># Create database &lt;dbname&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;dbname&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta myapp    <span style=color:#8f5902;font-style:italic># Create myapp database in pg-meta cluster</span>
</span></span></code></pre></div></div></div><p><strong>Example: Create business database <code>myapp</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars.pg_databases:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>app]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_trgm }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>btree_gin }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>my application database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Result</strong>: Creates <code>myapp</code> database on primary, sets owner to <code>dbuser_myapp</code>, creates <code>app</code> schema, enables <code>pg_trgm</code> and <code>btree_gin</code> extensions. Database is auto-added to Pgbouncer pool and registered as Grafana datasource.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Recommendation: Use playbook</div><p>For manual database creation, you must ensure Pgbouncer pool and Grafana datasource sync yourself.</p></div><hr><h2 id=modify-database>Modify Database</h2><p>Same command as create - playbook is idempotent when no <code>baseline</code> SQL is defined.</p><p>When target database exists, Pigsty modifies properties to match config. However, some properties can only be set at creation.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=script aria-controls=tabs-04-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-04-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=example aria-controls=tabs-04-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># Modify database &lt;db&gt; properties</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># Idempotent, can repeat</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta myapp    <span style=color:#8f5902;font-style:italic># Modify myapp database to match config</span>
</span></span></code></pre></div></div></div><p><strong>Immutable properties</strong>: These can&rsquo;t be modified after creation, require <code>state: recreate</code>:</p><ul><li><code>name</code> (database name), <code>template</code>, <code>strategy</code> (clone strategy)</li><li><code>encoding</code>, <code>locale</code>/<code>lc_collate</code>/<code>lc_ctype</code>, <code>locale_provider</code>/<code>icu_locale</code>/<code>icu_rules</code>/<code>builtin_locale</code></li></ul><p>All other properties can be modified. Common examples:</p><p><strong>Modify owner</strong>: Update <code>owner</code> field, executes <code>ALTER DATABASE ... OWNER TO</code> and grants permissions.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_new_owner    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># New owner</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Modify connection limit</strong>: Use <code>connlimit</code> to limit max connections.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Max 100 connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Revoke public connect</strong>: Setting <code>revokeconn: true</code> revokes PUBLIC CONNECT privilege, allowing only owner, DBA, monitor, and replication users.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Revoke PUBLIC CONNECT</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manage parameters</strong>: Use <code>parameters</code> dict for database-level params, generates <code>ALTER DATABASE ... SET</code>. Use special value <code>DEFAULT</code> to reset.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;512MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Reset to default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manage schemas</strong>: Use <code>schemas</code> array with simple or extended format. Use <code>state: absent</code> to drop (CASCADE).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>app                                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Simple form</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: core, owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp }  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Specify owner</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: deprecated, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Drop schema</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manage extensions</strong>: Use <code>extensions</code> array with simple or extended format. Use <code>state: absent</code> to uninstall (CASCADE).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>postgis                                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Simple form</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: vector, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Specify schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_trgm, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Uninstall extension</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>CASCADE Warning</div><p>Dropping schemas or uninstalling extensions uses <code>CASCADE</code>, deleting all dependent objects. Understand impact before executing.</p></div><p><strong>Connection pool config</strong>: By default all databases are added to Pgbouncer. Configure <code>pgbouncer</code>, <code>pool_mode</code>, <code>pool_size</code>, <code>pool_reserve</code>, <code>pool_connlimit</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Add to pool (default true)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode: transaction       # Pool mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction/session/statement</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Default pool size</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># Max database connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=delete-database>Delete Database</h2><p>To delete a database, set <code>state</code> to <code>absent</code> and execute:</p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist=script aria-controls=tabs-06-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-06-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-06-02-tab data-bs-toggle=tab data-bs-target=#tabs-06-02 role=tab data-td-tp-persist=example aria-controls=tabs-06-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># Delete &lt;db&gt; (config must have state: absent)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-02 role=tabpanel aria-labelled-by=tabs-06-02-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta olddb    <span style=color:#8f5902;font-style:italic># Delete olddb (config has state: absent)</span>
</span></span></code></pre></div></div></div><p><strong>Config example</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olddb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Deletion process</strong>: If <code>is_template: true</code>, first executes <code>ALTER DATABASE ... IS_TEMPLATE false</code>; uses <code>DROP DATABASE ... WITH (FORCE)</code> (PG13+) to force drop and terminate all connections; removes from Pgbouncer pool; unregisters from Grafana datasource.</p><p><strong>Protection</strong>: System databases <code>postgres</code>, <code>template0</code>, <code>template1</code> cannot be deleted. Deletion only runs on primary - streaming replication syncs to replicas.</p><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>Danger Warning</div><p>Database deletion is <strong>irreversible</strong> - permanently deletes all data. Before executing: ensure recent backup exists, confirm no business uses the database, notify stakeholders.
Pigsty is not responsible for any data loss from database deletion. Use at your own risk.</p></div><hr><h2 id=rebuild-database>Rebuild Database</h2><p><code>recreate</code> state rebuilds database (drop then create):</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=script aria-controls=tabs-08-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-08-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab data-td-tp-persist=example aria-controls=tabs-08-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># Rebuild &lt;db&gt; (config must have state: recreate)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta testdb    <span style=color:#8f5902;font-style:italic># Rebuild testdb (config has state: recreate)</span>
</span></span></code></pre></div></div></div><p><strong>Config example</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>testdb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>recreate</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test_init.sql   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Execute after rebuild</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Use cases</strong>: Test environment reset, clear dev database, modify immutable properties (encoding, locale), restore to initial state.</p><p><strong>Difference from manual DROP + CREATE</strong>: Single command; auto-preserves Pgbouncer and Grafana config; auto-loads <code>baseline</code> init script.</p><hr><h2 id=clone-database>Clone Database</h2><p>Clone PostgreSQL databases using PG template mechanism. During cloning, no active connections to template database are allowed.</p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist=script aria-controls=tabs-09-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-09-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-09-02-tab data-bs-toggle=tab data-bs-target=#tabs-09-02 role=tab data-td-tp-persist=example aria-controls=tabs-09-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># Clone &lt;db&gt; (config must specify template)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-02 role=tabpanel aria-labelled-by=tabs-09-02-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta meta_dev    <span style=color:#8f5902;font-style:italic># Clone meta_dev (config has template: meta)</span>
</span></span></code></pre></div></div></div><p><strong>Config example</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Source database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use meta as template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PG15+ clone strategy, instant on PG18</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Instant Clone (PG18+)</strong>: If using PostgreSQL 18+, Pigsty defaults <a href=https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-FILE-COPY-METHOD><strong><code>file_copy_method</code></strong></a>. With <code>strategy: FILE_COPY</code>, database clone completes in ~200ms without copying data files. E.g., cloning 30GB database: normal takes 18s, instant takes 200ms.</p><p><strong>Manual clone</strong>: Ensure all connections to template are terminated:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_terminate_backend</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TEMPLATE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8> </span><span style=color:#000>STRATEGY</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Limitations</strong>: Instant clone only available on supported filesystems (xfs, brtfs, zfs, apfs); don&rsquo;t use <code>postgres</code> database as template; in high-concurrency environments, all template connections must be cleared within clone window (~200ms).</p><hr><h2 id=connection-pool-management>Connection Pool Management</h2><p><a href=/docs/pgsql/config/db#connection-pool><strong>Connection pool params</strong></a> in database definitions are applied to Pgbouncer when creating/modifying databases.</p><p>By default all databases are added to Pgbouncer pool (<code>pgbouncer: true</code>). Databases are added to <code>/etc/pgbouncer/database.txt</code>. Database-level pool params (<code>pool_mode</code>, <code>pool_size</code>, etc.) are configured via this file.</p><p>Use <code>postgres</code> OS user with <code>pgb</code> alias to access Pgbouncer admin database. For more pool management, see <a href=/docs/pgsql/admin/pgbouncer><strong>Pgbouncer Management</strong></a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0cd896e3522e4cf2db0a08ece91619f5>6.4 - Patroni HA Management</h1><div class=lead>Manage PostgreSQL cluster HA with Patroni, including config changes, status check, switchover, restart, and reinit replica.</div><h2 id=overview>Overview</h2><p>Pigsty uses Patroni to manage PostgreSQL clusters. It handles config changes, status checks, switchover, restart, reinit replicas, and more.</p><p>To use Patroni for management, you need one of the following identities:</p><ul><li>From <a href=/docs/concept/node#admin-node><strong>INFRA node</strong></a> as <a href=/docs/deploy/admin><strong>admin user</strong></a>, managing all clusters in the environment.</li><li>From <a href=/docs/concept/node#pgsql-node><strong>PGSQL node</strong></a> as <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> (default <code>postgres</code>), managing the current cluster only.</li></ul><p>Patroni provides <a href=https://patroni.readthedocs.io/en/latest/patronictl.html><strong><code>patronictl</code></strong></a> CLI for management. Pigsty provides a wrapper alias <code>pg</code> to simplify operations.</p><details><summary>Using patronictl via pg alias</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg <span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>patroni_conf</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/infra/conf/patronictl.yml&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -r <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#000>patroni_conf</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/etc/patroni/patroni.yml&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -r <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;error: patronictl config not found&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> 1<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    patronictl -c <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$@</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></details><hr><h2 id=available-commands>Available Commands</h2><table class=full-width><thead><tr><th>Command</th><th>Function</th><th>Description</th></tr></thead><tbody><tr><td><a href=#edit-config><strong><code>edit-config</code></strong></a></td><td>Edit Config</td><td>Interactively edit cluster Patroni/PostgreSQL config</td></tr><tr><td><a href=#list-status><strong><code>list</code></strong></a></td><td>List Status</td><td>List cluster members and their status</td></tr><tr><td><a href=#switchover><strong><code>switchover</code></strong></a></td><td>Switchover</td><td>Switch primary role to specified replica (planned)</td></tr><tr><td><a href=#failover><strong><code>failover</code></strong></a></td><td>Failover</td><td>Force failover to specified replica (emergency)</td></tr><tr><td><a href=#restart><strong><code>restart</code></strong></a></td><td>Restart</td><td>Restart PostgreSQL instance to apply restart-required params</td></tr><tr><td><a href=#reload><strong><code>reload</code></strong></a></td><td>Reload</td><td>Reload Patroni config (no restart needed)</td></tr><tr><td><a href=#reinit-replica><strong><code>reinit</code></strong></a></td><td>Reinit Replica</td><td>Reinitialize replica (wipe data and re-clone)</td></tr><tr><td><a href=#pause><strong><code>pause</code></strong></a></td><td>Pause Auto-Failover</td><td>Pause Patroni automatic failover</td></tr><tr><td><a href=#resume><strong><code>resume</code></strong></a></td><td>Resume Auto-Failover</td><td>Resume Patroni automatic failover</td></tr><tr><td><a href=#history><strong><code>history</code></strong></a></td><td>View History</td><td>Show cluster failover history</td></tr><tr><td><a href=#show-config><strong><code>show-config</code></strong></a></td><td>Show Config</td><td>Display current cluster config (read-only)</td></tr><tr><td><a href=#query><strong><code>query</code></strong></a></td><td>Execute Query</td><td>Execute SQL query on cluster members</td></tr><tr><td><a href=#topology><strong><code>topology</code></strong></a></td><td>View Topology</td><td>Display cluster replication topology</td></tr><tr><td><a href=#version><strong><code>version</code></strong></a></td><td>View Version</td><td>Display Patroni version info</td></tr><tr><td><a href=#remove><strong><code>remove</code></strong></a></td><td>Remove Member</td><td>Remove cluster member from DCS (dangerous)</td></tr></tbody></table><hr><h2 id=edit-config>Edit Config</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-edit-config><strong><code>edit-config</code></strong></a> to interactively edit cluster Patroni and PostgreSQL config. This opens an editor to modify config stored in DCS, automatically applying changes to all members. You can change Patroni params (<code>ttl</code>, <code>loop_wait</code>, <code>synchronous_mode</code>, etc.) and PostgreSQL params in <code>postgresql.parameters</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># Interactive edit cluster config</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; --force          <span style=color:#8f5902;font-style:italic># Skip confirmation and apply directly</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; -p &lt;k&gt;<span style=color:#ce5c00;font-weight:700>=</span>&lt;v&gt;       <span style=color:#8f5902;font-style:italic># Modify PostgreSQL param (--pg shorthand)</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; -s &lt;k&gt;<span style=color:#ce5c00;font-weight:700>=</span>&lt;v&gt;       <span style=color:#8f5902;font-style:italic># Modify Patroni param (--set shorthand)</span>
</span></span></code></pre></div><div id=asciinema-7f7700930ae8f7d432a1cae8fb8bc426 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-7f7700930ae8f7d432a1cae8fb8bc426",o="/demo/pgsql-config.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[7,"Edit Config"],[9,"Apply"],[11,"Verify"],[13,"API Edit"],[14,"API Verify"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><p>Common config modification examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify PostgreSQL param: slow query threshold (prompts for confirmation)</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify PostgreSQL param, skip confirmation</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify multiple PostgreSQL params</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>work_mem</span><span style=color:#ce5c00;font-weight:700>=</span>256MB -p <span style=color:#000>maintenance_work_mem</span><span style=color:#ce5c00;font-weight:700>=</span>1GB --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify Patroni params: increase failure detection window (increase RTO)</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>loop_wait</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>15</span> -s <span style=color:#000>ttl</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify Patroni param: enable synchronous replication mode</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>synchronous_mode</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify Patroni param: enable strict synchronous mode (require at least one sync replica for writes)</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>synchronous_mode_strict</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify restart-required params (need pg restart after)</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>shared_buffers</span><span style=color:#ce5c00;font-weight:700>=</span>4GB --force
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements&#39;</span> --force
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>max_connections</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>200</span> --force
</span></span></code></pre></div><p>Some params require PostgreSQL restart to take effect. Use <code>pg list</code> to check - instances marked with <code>*</code> need restart. Then use <code>pg restart</code> to apply.
You can also use <code>curl</code> or programs to call Patroni <a href=https://patroni.readthedocs.io/en/latest/rest_api.html><strong>REST API</strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View current config</span>
</span></span><span style=display:flex><span>curl -s 10.10.10.11:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify params via API (requires auth)</span>
</span></span><span style=display:flex><span>curl -u <span style=color:#4e9a06>&#39;postgres:Patroni.API&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>     -d <span style=color:#4e9a06>&#39;{&#34;postgresql&#34;:{&#34;parameters&#34;: {&#34;log_min_duration_statement&#34;:200}}}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>     -s -X PATCH http://10.10.10.11:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span></code></pre></div><hr><h2 id=list-status>List Status</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-list><strong><code>list</code></strong></a> to view cluster members and status. Output shows each instance&rsquo;s name, host, role, state, timeline, and replication lag. This is the most commonly used command for checking cluster health.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list &lt;cls&gt;                         <span style=color:#8f5902;font-style:italic># List specified cluster status</span>
</span></span><span style=display:flex><span>pg list                               <span style=color:#8f5902;font-style:italic># List all clusters (on admin node)</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -e                      <span style=color:#8f5902;font-style:italic># Show extended info (--extended)</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -t                      <span style=color:#8f5902;font-style:italic># Show timestamp (--timestamp)</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -f json                 <span style=color:#8f5902;font-style:italic># Output as JSON (--format)</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -W <span style=color:#0000cf;font-weight:700>5</span>                    <span style=color:#8f5902;font-style:italic># Refresh every 5 seconds (--watch)</span>
</span></span></code></pre></div><p>Example output:</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) -----+----+--------------+
| Member    | Host        | Role    | State   | TL | Lag in MB    |
+-----------+-------------+---------+---------+----+--------------+
| pg-test-1 | 10.10.10.11 | Leader  | running |  1 |              |
| pg-test-2 | 10.10.10.12 | Replica | running |  1 |            0 |
| pg-test-3 | 10.10.10.13 | Replica | running |  1 |            0 |
+-----------+-------------+---------+---------+----+--------------+
</code></pre><p>Column descriptions: <strong>Member</strong> is instance name, composed of <code>pg_cluster</code>-<code>pg_seq</code>; <strong>Host</strong> is instance IP; <strong>Role</strong> is role type - Leader (primary), Replica, Sync Standby, Standby Leader (cascade primary); <strong>State</strong> is running state - <code>running</code>, <code>streaming</code>, <code>in archive recovery</code>, <code>starting</code>, <code>stopped</code>, etc.; <strong>TL</strong> is timeline number, incremented after each switchover; <strong>Lag in MB</strong> is replication lag in MB (not shown for primary).</p><p>Instances requiring restart show <code>*</code> after the name:</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) -------+----+--------------+
| Member      | Host        | Role    | State   | TL | Lag in MB    |
+-------------+-------------+---------+---------+----+--------------+
| pg-test-1 * | 10.10.10.11 | Leader  | running |  1 |              |
| pg-test-2 * | 10.10.10.12 | Replica | running |  1 |            0 |
+-------------+-------------+---------+---------+----+--------------+
</code></pre><hr><h2 id=switchover>Switchover</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-switchover><strong><code>switchover</code></strong></a> for planned primary-replica switchover. Switchover is graceful: Patroni ensures replica is fully synced, demotes primary, then promotes target replica. Takes seconds with brief write unavailability. Use for primary host maintenance, upgrades, or migrating primary to better nodes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg switchover &lt;cls&gt;                   <span style=color:#8f5902;font-style:italic># Interactive switchover, prompts for target replica</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --leader &lt;old&gt;    <span style=color:#8f5902;font-style:italic># Specify current primary name</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --candidate &lt;new&gt; <span style=color:#8f5902;font-style:italic># Specify target replica name</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --scheduled &lt;time&gt; <span style=color:#8f5902;font-style:italic># Scheduled switchover, format: 2024-12-01T03:00</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --force           <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span></code></pre></div><p>Before switchover, ensure all replicas are healthy (<code>running</code> or <code>streaming</code>), replication lag is acceptable, and stakeholders are notified.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Interactive switchover (recommended, shows topology and prompts for selection)</span>
</span></span><span style=display:flex><span>$ pg switchover pg-test
</span></span><span style=display:flex><span>Current cluster topology
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -----+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span>Primary <span style=color:#ce5c00;font-weight:700>[</span>pg-test-1<span style=color:#ce5c00;font-weight:700>]</span>:
</span></span><span style=display:flex><span>Candidate <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;pg-test-2&#39;</span>, <span style=color:#4e9a06>&#39;pg-test-3&#39;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[]</span>: pg-test-2
</span></span><span style=display:flex><span>When should the switchover take place <span style=color:#ce5c00;font-weight:700>(</span>e.g. 2024-01-01T12:00<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>[</span>now<span style=color:#ce5c00;font-weight:700>]</span>:
</span></span><span style=display:flex><span>Are you sure you want to switchover cluster pg-test, demoting current leader pg-test-1? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Non-interactive switchover (specify primary and candidate)</span>
</span></span><span style=display:flex><span>pg switchover pg-test --leader pg-test-1 --candidate pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Scheduled switchover (at 3 AM, for maintenance window)</span>
</span></span><span style=display:flex><span>pg switchover pg-test --leader pg-test-1 --candidate pg-test-2 --scheduled <span style=color:#4e9a06>&#34;2024-12-01T03:00&#34;</span>
</span></span></code></pre></div><p>After switchover, use <code>pg list</code> to confirm new cluster topology.</p><hr><h2 id=failover>Failover</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-failover><strong><code>failover</code></strong></a> for emergency failover. Unlike <code>switchover</code>, <code>failover</code> is for when primary is unavailable. It directly promotes a replica without waiting for original primary confirmation. Since replicas may not be fully synced, <code>failover</code> may cause minor data loss. Use <code>switchover</code> for non-emergency situations.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg failover &lt;cls&gt;                     <span style=color:#8f5902;font-style:italic># Interactive failover</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --leader &lt;old&gt;      <span style=color:#8f5902;font-style:italic># Specify original primary (for verification, optional)</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --candidate &lt;new&gt;   <span style=color:#8f5902;font-style:italic># Specify replica to promote</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --force             <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span></code></pre></div><p>Failover examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Interactive failover</span>
</span></span><span style=display:flex><span>$ pg failover pg-test
</span></span><span style=display:flex><span>Candidate <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;pg-test-2&#39;</span>, <span style=color:#4e9a06>&#39;pg-test-3&#39;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[]</span>: pg-test-2
</span></span><span style=display:flex><span>Are you sure you want to failover cluster pg-test? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>Successfully failed over to <span style=color:#4e9a06>&#34;pg-test-2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Non-interactive failover (for emergencies)</span>
</span></span><span style=display:flex><span>pg failover pg-test --candidate pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify original primary for verification (errors if name mismatch)</span>
</span></span><span style=display:flex><span>pg failover pg-test --leader pg-test-1 --candidate pg-test-2 --force
</span></span></code></pre></div><p><strong>Switchover vs Failover</strong>: Switchover is for planned maintenance, requires original primary online, ensures full sync before switching, no data loss; Failover is for emergency recovery, original primary can be offline, directly promotes replica, may lose unsynced data. Use Switchover for daily maintenance/upgrades; use Failover only when primary is completely down and unrecoverable.</p><hr><h2 id=restart>Restart</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-restart><strong><code>restart</code></strong></a> to restart PostgreSQL instances, typically to apply restart-required param changes. Patroni coordinates restarts - for full cluster restart, it uses rolling restart: replicas first, then primary, minimizing downtime.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart &lt;cls&gt;                      <span style=color:#8f5902;font-style:italic># Restart all instances in cluster</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; &lt;member&gt;             <span style=color:#8f5902;font-style:italic># Restart specific instance</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --role leader        <span style=color:#8f5902;font-style:italic># Restart primary only</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --role replica       <span style=color:#8f5902;font-style:italic># Restart all replicas</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --pending            <span style=color:#8f5902;font-style:italic># Restart only instances marked for restart</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --scheduled &lt;time&gt;   <span style=color:#8f5902;font-style:italic># Scheduled restart</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --timeout &lt;sec&gt;      <span style=color:#8f5902;font-style:italic># Set restart timeout (seconds)</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --force              <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span></code></pre></div><p>After modifying restart-required params (<code>shared_buffers</code>, <code>shared_preload_libraries</code>, <code>max_connections</code>, <code>max_worker_processes</code>, etc.), use this command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check which instances need restart (marked with *)</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 * <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 * <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart single replica</span>
</span></span><span style=display:flex><span>pg restart pg-test pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart entire cluster (rolling restart, replicas then primary)</span>
</span></span><span style=display:flex><span>pg restart pg-test --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart only pending instances</span>
</span></span><span style=display:flex><span>pg restart pg-test --pending --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart all replicas only</span>
</span></span><span style=display:flex><span>pg restart pg-test --role replica --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Scheduled restart (for maintenance window)</span>
</span></span><span style=display:flex><span>pg restart pg-test --scheduled <span style=color:#4e9a06>&#34;2024-12-01T03:00&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set restart timeout to 300 seconds</span>
</span></span><span style=display:flex><span>pg restart pg-test --timeout <span style=color:#0000cf;font-weight:700>300</span> --force
</span></span></code></pre></div><hr><h2 id=reload>Reload</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-reload><strong><code>reload</code></strong></a> to reload Patroni config without restarting PostgreSQL. This re-reads config files and applies non-restart params via <code>pg_reload_conf()</code>. Lighter than <code>restart</code> - doesn&rsquo;t interrupt connections or running queries.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg reload &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># Reload entire cluster config</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; &lt;member&gt;              <span style=color:#8f5902;font-style:italic># Reload specific instance config</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --role leader         <span style=color:#8f5902;font-style:italic># Reload primary only</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --role replica        <span style=color:#8f5902;font-style:italic># Reload all replicas</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --force               <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span></code></pre></div><p>Most PostgreSQL params work via <code>reload</code>. Only postmaster-context params (<code>shared_buffers</code>, <code>max_connections</code>, <code>shared_preload_libraries</code>, <code>archive_mode</code>, etc.) require restart.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload entire cluster</span>
</span></span><span style=display:flex><span>pg reload pg-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload single instance</span>
</span></span><span style=display:flex><span>pg reload pg-test pg-test-1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Force reload, skip confirmation</span>
</span></span><span style=display:flex><span>pg reload pg-test --force
</span></span></code></pre></div><hr><h2 id=reinit-replica>Reinit Replica</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-reinit><strong><code>reinit</code></strong></a> to reinitialize a replica. This deletes all data on the replica and performs fresh <code>pg_basebackup</code> from primary. Use when replica data is corrupted, replica is too far behind (WAL already purged), or replica config needs reset.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt;              <span style=color:#8f5902;font-style:italic># Reinitialize specified replica</span>
</span></span><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt; --force      <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt; --wait       <span style=color:#8f5902;font-style:italic># Wait for rebuild to complete</span>
</span></span></code></pre></div><blockquote><p>Warning: This operation <strong>deletes all data</strong> on target instance! Can only be run on replicas, not primary.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reinitialize replica (prompts for confirmation)</span>
</span></span><span style=display:flex><span>$ pg reinit pg-test pg-test-2
</span></span><span style=display:flex><span>Are you sure you want to reinitialize members pg-test-2? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>Success: reinitialize <span style=color:#204a87;font-weight:700>for</span> member pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Force reinitialize, skip confirmation</span>
</span></span><span style=display:flex><span>pg reinit pg-test pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reinitialize and wait for completion</span>
</span></span><span style=display:flex><span>pg reinit pg-test pg-test-2 --force --wait
</span></span></code></pre></div><p>During rebuild, use <code>pg list</code> to check progress. Replica state shows <code>creating replica</code>:</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) --------------+----+------+
| Member    | Host        | Role    | State            | TL | Lag  |
+-----------+-------------+---------+------------------+----+------+
| pg-test-1 | 10.10.10.11 | Leader  | running          |  2 |      |
| pg-test-2 | 10.10.10.12 | Replica | creating replica |    |    ? |
+-----------+-------------+---------+------------------+----+------+
</code></pre><hr><h2 id=pause>Pause</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-pause><strong><code>pause</code></strong></a> to pause Patroni automatic failover. When paused, Patroni won&rsquo;t auto-promote replicas even if primary fails. Use for planned maintenance windows (prevent accidental triggers), debugging (prevent cluster state changes), or manual switchover timing control.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg pause &lt;cls&gt;                        <span style=color:#8f5902;font-style:italic># Pause automatic failover</span>
</span></span><span style=display:flex><span>pg pause &lt;cls&gt; --wait                 <span style=color:#8f5902;font-style:italic># Pause and wait for all members to confirm</span>
</span></span></code></pre></div><blockquote><p>Warning: During pause, cluster <strong>won&rsquo;t auto-recover</strong> if primary fails! Remember to <code>resume</code> after maintenance.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pause automatic failover</span>
</span></span><span style=display:flex><span>$ pg pause pg-test
</span></span><span style=display:flex><span>Success: cluster management is paused
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check cluster status (shows Maintenance mode: on)</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -----+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span> Maintenance mode: on
</span></span></code></pre></div><hr><h2 id=resume>Resume</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-resume><strong><code>resume</code></strong></a> to resume Patroni automatic failover. Execute immediately after maintenance to ensure cluster auto-recovers on primary failure.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># Resume automatic failover</span>
</span></span><span style=display:flex><span>pg resume &lt;cls&gt; --wait                <span style=color:#8f5902;font-style:italic># Resume and wait for all members to confirm</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Resume automatic failover</span>
</span></span><span style=display:flex><span>$ pg resume pg-test
</span></span><span style=display:flex><span>Success: cluster management is resumed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Confirm resumed (Maintenance mode prompt disappears)</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span></code></pre></div><hr><h2 id=history>History</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-history><strong><code>history</code></strong></a> to view cluster failover history. Each switchover (auto or manual) creates a new timeline record.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt;                      <span style=color:#8f5902;font-style:italic># Show failover history</span>
</span></span><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt; -f json              <span style=color:#8f5902;font-style:italic># Output as JSON</span>
</span></span><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt; -f yaml              <span style=color:#8f5902;font-style:italic># Output as YAML</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg <span style=color:#204a87>history</span> pg-test
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span>       LSN <span style=color:#000;font-weight:700>|</span> Reason                       <span style=color:#000;font-weight:700>|</span> Timestamp                 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 0/5000060 <span style=color:#000;font-weight:700>|</span> no recovery target specified <span style=color:#000;font-weight:700>|</span> 2024-01-15T10:30:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 0/6000000 <span style=color:#000;font-weight:700>|</span> switchover to pg-test-2      <span style=color:#000;font-weight:700>|</span> 2024-01-20T14:00:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span> 0/7000028 <span style=color:#000;font-weight:700>|</span> failover to pg-test-1        <span style=color:#000;font-weight:700>|</span> 2024-01-25T09:15:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span></code></pre></div><p>Column descriptions: <strong>TL</strong> is timeline number, incremented after each switchover, distinguishes primary histories; <strong>LSN</strong> is Log Sequence Number at switchover, marks WAL position; <strong>Reason</strong> is switchover reason - <code>switchover to xxx</code> (manual), <code>failover to xxx</code> (failure), or <code>no recovery target specified</code> (init); <strong>Timestamp</strong> is when switchover occurred.</p><hr><h2 id=show-config>Show Config</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-show-config><strong><code>show-config</code></strong></a> to view current cluster config stored in DCS. This is read-only; use <code>edit-config</code> to modify.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg show-config &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># Show cluster config</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg show-config pg-test
</span></span><span style=display:flex><span>loop_wait: <span style=color:#0000cf;font-weight:700>10</span>
</span></span><span style=display:flex><span>maximum_lag_on_failover: <span style=color:#0000cf;font-weight:700>1048576</span>
</span></span><span style=display:flex><span>postgresql:
</span></span><span style=display:flex><span>  parameters:
</span></span><span style=display:flex><span>    archive_command: pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-test archive-push %p
</span></span><span style=display:flex><span>    max_connections: <span style=color:#0000cf;font-weight:700>100</span>
</span></span><span style=display:flex><span>    shared_buffers: 256MB
</span></span><span style=display:flex><span>    log_min_duration_statement: <span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>  use_pg_rewind: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>  use_slots: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>retry_timeout: <span style=color:#0000cf;font-weight:700>10</span>
</span></span><span style=display:flex><span>ttl: <span style=color:#0000cf;font-weight:700>30</span>
</span></span><span style=display:flex><span>synchronous_mode: <span style=color:#204a87>false</span>
</span></span></code></pre></div><hr><h2 id=query>Query</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-query><strong><code>query</code></strong></a> to quickly execute SQL on cluster members. Convenient for debugging - for complex production queries, use <code>psql</code> or applications.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span>             <span style=color:#8f5902;font-style:italic># Execute on primary</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -m &lt;member&gt; <span style=color:#8f5902;font-style:italic># Execute on specific instance (--member)</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -r leader   <span style=color:#8f5902;font-style:italic># Execute on primary (--role)</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -r replica  <span style=color:#8f5902;font-style:italic># Execute on all replicas</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -f &lt;file&gt;              <span style=color:#8f5902;font-style:italic># Execute SQL from file</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -U &lt;user&gt;   <span style=color:#8f5902;font-style:italic># Specify username (--username)</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -d &lt;db&gt;     <span style=color:#8f5902;font-style:italic># Specify database (--dbname)</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> --format json  <span style=color:#8f5902;font-style:italic># Output as JSON</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check primary connection count</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT count(*) FROM pg_stat_activity&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check PostgreSQL version</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT version()&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check replication status on all replicas</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT pg_is_in_recovery(), pg_last_wal_replay_lsn()&#34;</span> -r replica
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Execute on specific instance</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT pg_is_in_recovery()&#34;</span> -m pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use specific user and database</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT current_user, current_database()&#34;</span> -U postgres -d postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Output as JSON</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT * FROM pg_stat_replication&#34;</span> --format json
</span></span></code></pre></div><hr><h2 id=topology>Topology</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-topology><strong><code>topology</code></strong></a> to view cluster replication topology as a tree. More intuitive than <code>list</code> for showing primary-replica relationships, especially for cascading replication.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg topology &lt;cls&gt;                     <span style=color:#8f5902;font-style:italic># Show replication topology</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg topology pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1   <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> + pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> + pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span></code></pre></div><p>In cascading replication, topology clearly shows replication hierarchy - e.g., <code>pg-test-3</code> replicates from <code>pg-test-2</code>, which replicates from primary <code>pg-test-1</code>.</p><hr><h2 id=version>Version</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-version><strong><code>version</code></strong></a> to view patronictl version.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg version                            <span style=color:#8f5902;font-style:italic># Show patronictl version</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg version
</span></span><span style=display:flex><span>patronictl version 4.1.0
</span></span></code></pre></div><hr><h2 id=remove>Remove</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-remove><strong><code>remove</code></strong></a> to remove cluster or member metadata from DCS. This is dangerous - only removes DCS metadata, doesn&rsquo;t stop PostgreSQL or delete data files. Misuse may cause cluster state inconsistency.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg remove &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># Remove entire cluster metadata from DCS</span>
</span></span></code></pre></div><p>Normally you don&rsquo;t need this command. To properly remove clusters/instances, use Pigsty&rsquo;s <a href=/docs/pgsql/admin/cluster#remove-cluster><strong><code>bin/pgsql-rm</code></strong></a> script or <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> playbook.
Only consider <code>remove</code> for: orphaned DCS metadata (node physically removed but metadata remains), or cluster destroyed via other means requiring metadata cleanup.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove entire cluster metadata (requires multiple confirmations)</span>
</span></span><span style=display:flex><span>$ pg remove pg-test
</span></span><span style=display:flex><span>Please confirm the cluster name to remove: pg-test
</span></span><span style=display:flex><span>You are about to remove all information in DCS <span style=color:#204a87;font-weight:700>for</span> pg-test, please type: <span style=color:#4e9a06>&#34;Yes I am aware&#34;</span>: Yes I am aware
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-289eefb8da504803e0c1952004777bb0>6.5 - Pgbouncer Connection Pooling</h1><div class=lead>Manage Pgbouncer connection pool, including pause, resume, disable, enable, reconnect, kill, and reload operations.</div><h2 id=overview>Overview</h2><p>Pigsty uses <a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> as PostgreSQL connection pooling middleware, listening on port <code>6432</code> by default, proxying access to local PostgreSQL on port <code>5432</code>.</p><p>This is an <strong>optional component</strong>. If you don&rsquo;t have massive connections or need transaction pooling and query metrics, you can disable it, connect directly to the database, or keep it unused.</p><hr><h2 id=user--database-management>User & Database Management</h2><p>Pgbouncer users and databases are auto-managed by Pigsty, applying <a href=/docs/pgsql/config/db><strong>database config</strong></a> and <a href=/docs/pgsql/config/user><strong>user config</strong></a> when <a href=/docs/pgsql/admin/db><strong>creating databases</strong></a> and <a href=/docs/pgsql/admin/user><strong>creating users</strong></a>.</p><p><strong>Database Management</strong>: Databases defined in <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> are auto-added to Pgbouncer by default. Set <a href=/docs/pgsql/admin/db#pgbouncer><strong><code>pgbouncer: false</code></strong></a> to exclude specific databases.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mydb               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Added to connection pool by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Database-level pool mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Default pool size</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># Excluded from connection pool</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>User Management</strong>: Users defined in <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> need explicit <a href=/docs/pgsql/admin/user#pgbouncer><strong><code>pgbouncer: true</code></strong></a> to be added to connection pool user list.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Add to connection pool user list</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># User-level pool mode</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=service-management>Service Management</h2><p>In Pigsty, PostgreSQL cluster <a href=/docs/concept/ha/svc#primary-service><strong>Primary Service</strong></a> and Replica Service default to Pgbouncer port 6432.
To bypass connection pool and access PostgreSQL directly, customize <a href=/docs/pgsql/param#pg_services><strong><code>pg_services</code></strong></a>, or set <a href=/docs/pgsql/param#pg_default_service_dest><strong><code>pg_default_service_dest</code></strong></a> to <code>postgres</code>.</p><hr><h2 id=config-management>Config Management</h2><p>Pgbouncer config files are in <code>/etc/pgbouncer/</code>, generated and managed by Pigsty:</p><table class=full-width><thead><tr><th>File</th><th>Description</th></tr></thead><tbody><tr><td><code>pgbouncer.ini</code></td><td>Main config, pool-level params</td></tr><tr><td><code>database.txt</code></td><td>Database list, database-level params</td></tr><tr><td><code>userlist.txt</code></td><td>User password list</td></tr><tr><td><code>useropts.txt</code></td><td>User-level pool params</td></tr><tr><td><code>pgb_hba.conf</code></td><td>HBA access control rules</td></tr></tbody></table><p>Pigsty auto-manages <code>database.txt</code> and <code>userlist.txt</code>, updating them when <a href=/docs/pgsql/admin/db#create-database><strong>creating databases</strong></a> or <a href=/docs/pgsql/admin/user#create-user><strong>creating users</strong></a>.</p><p>You can manually edit config then <code>RELOAD</code> to apply:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Edit config</span>
</span></span><span style=display:flex><span>$ vim /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload via systemctl</span>
</span></span><span style=display:flex><span>$ sudo systemctl reload pgbouncer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload as pg_dbsu / postgres user</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>
</span></span></code></pre></div><hr><h2 id=pool-management>Pool Management</h2><p>Pgbouncer runs as the same <code>dbsu</code> as PostgreSQL, default <code>postgres</code> OS user. Pigsty provides <code>pgb</code> alias for easy management:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>alias</span> <span style=color:#000>pgb</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;psql -p 6432 -d pgbouncer -U postgres&#34;</span>
</span></span></code></pre></div><p>Use <code>pgb</code> on database nodes to connect to Pgbouncer admin console for management commands and monitoring queries.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW POOLS;</span>
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW CLIENTS;</span>
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW SERVERS;</span>
</span></span></code></pre></div><table class=full-width><thead><tr><th>Command</th><th>Function</th><th>Description</th></tr></thead><tbody><tr><td><a href=#pause><strong><code>PAUSE</code></strong></a></td><td>Pause</td><td>Pause database, wait for txn completion then disconnect</td></tr><tr><td><a href=#resume><strong><code>RESUME</code></strong></a></td><td>Resume</td><td>Resume database paused by PAUSE/KILL/SUSPEND</td></tr><tr><td><a href=#disable><strong><code>DISABLE</code></strong></a></td><td>Disable</td><td>Reject new client connections for database</td></tr><tr><td><a href=#enable><strong><code>ENABLE</code></strong></a></td><td>Enable</td><td>Allow new client connections for database</td></tr><tr><td><a href=#reconnect><strong><code>RECONNECT</code></strong></a></td><td>Reconnect</td><td>Gracefully close and rebuild server connections</td></tr><tr><td><a href=#kill><strong><code>KILL</code></strong></a></td><td>Kill</td><td>Immediately disconnect all client and server connections</td></tr><tr><td><a href=#kill_client><strong><code>KILL_CLIENT</code></strong></a></td><td>Kill Client</td><td>Terminate specific client connection</td></tr><tr><td><a href=#suspend><strong><code>SUSPEND</code></strong></a></td><td>Suspend</td><td>Flush buffers and stop listening, for online restart</td></tr><tr><td><a href=#shutdown><strong><code>SHUTDOWN</code></strong></a></td><td>Shutdown</td><td>Shutdown Pgbouncer process</td></tr><tr><td><a href=#reload><strong><code>RELOAD</code></strong></a></td><td>Reload</td><td>Reload config files</td></tr><tr><td><a href=#wait_close><strong><code>WAIT_CLOSE</code></strong></a></td><td>Wait Close</td><td>Wait for server connections to close after RECONNECT/RELOAD</td></tr><tr><td><a href=#monitoring><strong>Monitor Commands</strong></a></td><td>Monitor</td><td>View pool status, clients, servers, etc.</td></tr></tbody></table><hr><h3 id=pause>PAUSE</h3><p>Use <code>PAUSE</code> to pause database connections. Pgbouncer waits for active txn/session to complete based on pool mode, then disconnects server connections. New client requests are blocked until <code>RESUME</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>PAUSE</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Pause specified database, or all if not specified
</span></span></span></code></pre></div><p>Typical use cases:</p><ul><li>Online backend database switch (e.g., update connection target after switchover)</li><li>Maintenance operations requiring all connections disconnected</li><li>Combined with <code>SUSPEND</code> for Pgbouncer online restart</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;PAUSE mydb;&#34;</span>        <span style=color:#8f5902;font-style:italic># Pause mydb database</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;PAUSE;&#34;</span>             <span style=color:#8f5902;font-style:italic># Pause all databases</span>
</span></span></code></pre></div><p>After pause, <code>SHOW DATABASES</code> shows <code>paused</code> status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=#</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>DATABASES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>   </span><span style=color:#000>name</span><span style=color:#f8f8f8>   </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8>    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>port</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>paused</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------+-----------+------+----------+-----+--------+----------
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8> </span><span style=color:#000>mydb</span><span style=color:#f8f8f8>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>run</span><span style=color:#f8f8f8>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>mydb</span><span style=color:#f8f8f8>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>      </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h3 id=resume>RESUME</h3><p>Use <code>RESUME</code> to restore databases paused by <code>PAUSE</code>, <code>KILL</code>, or <code>SUSPEND</code>, allowing new connections and resuming normal service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RESUME</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- Resume specified database, or all if not specified
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RESUME mydb;&#34;</span>       <span style=color:#8f5902;font-style:italic># Resume mydb database</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RESUME;&#34;</span>            <span style=color:#8f5902;font-style:italic># Resume all databases</span>
</span></span></code></pre></div><hr><h3 id=disable>DISABLE</h3><p>Use <code>DISABLE</code> to disable a database, rejecting all new client connection requests. Existing connections are unaffected.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>DISABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Disable specified database (database name required)
</span></span></span></code></pre></div><p>Typical use cases:</p><ul><li>Temporarily offline a database for maintenance</li><li>Block new connections for safe database migration</li><li>Gradually decommission a database being removed</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;DISABLE mydb;&#34;</span>      <span style=color:#8f5902;font-style:italic># Disable mydb, new connections rejected</span>
</span></span></code></pre></div><hr><h3 id=enable>ENABLE</h3><p>Use <code>ENABLE</code> to enable a database previously disabled by <code>DISABLE</code>, accepting new client connections again.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ENABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>-- Enable specified database (database name required)
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;ENABLE mydb;&#34;</span>       <span style=color:#8f5902;font-style:italic># Enable mydb, allow new connections</span>
</span></span></code></pre></div><hr><h3 id=reconnect>RECONNECT</h3><p>Use <code>RECONNECT</code> to gracefully rebuild server connections. Pgbouncer closes connections when released back to pool, creating new ones when needed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RECONNECT</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- Rebuild server connections for database, or all if not specified
</span></span></span></code></pre></div><p>Typical use cases:</p><ul><li>Refresh connections after backend database IP change</li><li>Reroute traffic after switchover</li><li>Rebuild connections after DNS update</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT mydb;&#34;</span>    <span style=color:#8f5902;font-style:italic># Rebuild mydb server connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT;&#34;</span>         <span style=color:#8f5902;font-style:italic># Rebuild all server connections</span>
</span></span></code></pre></div><p>After <code>RECONNECT</code>, use <code>WAIT_CLOSE</code> to wait for old connections to fully release.</p><hr><h3 id=kill>KILL</h3><p>Use <code>KILL</code> to immediately disconnect all client and server connections for a database. Unlike <code>PAUSE</code>, <code>KILL</code> doesn&rsquo;t wait for transaction completion - forces immediate disconnect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>KILL</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>-- Kill all connections for database, or all (except admin) if not specified
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL mydb;&#34;</span>         <span style=color:#8f5902;font-style:italic># Force disconnect all mydb connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL;&#34;</span>              <span style=color:#8f5902;font-style:italic># Force disconnect all database connections (except admin)</span>
</span></span></code></pre></div><p>After <code>KILL</code>, new connections are blocked until <code>RESUME</code>.</p><hr><h3 id=kill_client>KILL_CLIENT</h3><p>Use <code>KILL_CLIENT</code> to terminate a specific client connection. Client ID can be obtained from <code>SHOW CLIENTS</code> output.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>KILL_CLIENT</span><span style=color:#f8f8f8> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- Terminate client connection with specified ID
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View client connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW CLIENTS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Terminate specific client (assuming ptr column shows ID 0x1234567890)</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL_CLIENT 0x1234567890;&#34;</span>
</span></span></code></pre></div><hr><h3 id=suspend>SUSPEND</h3><p>Use <code>SUSPEND</code> to suspend Pgbouncer. Flushes all socket buffers and stops listening until <code>RESUME</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SUSPEND</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- Suspend Pgbouncer
</span></span></span></code></pre></div><p><code>SUSPEND</code> is mainly for Pgbouncer online restart (zero-downtime upgrade):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Suspend current Pgbouncer</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SUSPEND;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Start new Pgbouncer process (with -R option to take over sockets)</span>
</span></span><span style=display:flex><span>$ pgbouncer -R /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. New process takes over, old process exits automatically</span>
</span></span></code></pre></div><hr><h3 id=shutdown>SHUTDOWN</h3><p>Use <code>SHUTDOWN</code> to shut down Pgbouncer process. Multiple shutdown modes supported:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic>-- Immediate shutdown
</span></span></span><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#f8f8f8> </span><span style=color:#000>WAIT_FOR_SERVERS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic>-- Wait for server connections to release
</span></span></span><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#f8f8f8> </span><span style=color:#000>WAIT_FOR_CLIENTS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic>-- Wait for clients to disconnect (zero-downtime rolling restart)
</span></span></span></code></pre></div><table class=full-width><thead><tr><th>Mode</th><th>Description</th></tr></thead><tbody><tr><td><code>SHUTDOWN</code></td><td>Immediately shutdown Pgbouncer</td></tr><tr><td><code>WAIT_FOR_SERVERS</code></td><td>Stop accepting new connections, wait for server release</td></tr><tr><td><code>WAIT_FOR_CLIENTS</code></td><td>Stop accepting new connections, wait for all clients disconnect, for rolling restart</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHUTDOWN WAIT_FOR_CLIENTS;&#34;</span>   <span style=color:#8f5902;font-style:italic># Graceful shutdown, wait for clients</span>
</span></span></code></pre></div><hr><h3 id=reload>RELOAD</h3><p>Use <code>RELOAD</code> to reload Pgbouncer config files. Dynamically updates most config params without process restart.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RELOAD</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic>-- Reload config files
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>              <span style=color:#8f5902;font-style:italic># Reload via admin console</span>
</span></span><span style=display:flex><span>$ systemctl reload pgbouncer    <span style=color:#8f5902;font-style:italic># Reload via systemd</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGHUP <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Reload via signal</span>
</span></span></code></pre></div><p>Pigsty provides playbook task to reload Pgbouncer config:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pgbouncer_reload    <span style=color:#8f5902;font-style:italic># Reload cluster Pgbouncer config</span>
</span></span></code></pre></div><hr><h3 id=wait_close>WAIT_CLOSE</h3><p>Use <code>WAIT_CLOSE</code> to wait for server connections to finish closing. Typically used after <code>RECONNECT</code> or <code>RELOAD</code> to ensure old connections are fully released.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>WAIT_CLOSE</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- Wait for server connections to close, or all if not specified
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Complete connection rebuild flow</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT mydb;&#34;</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;WAIT_CLOSE mydb;&#34;</span>    <span style=color:#8f5902;font-style:italic># Wait for old connections to release</span>
</span></span></code></pre></div><hr><h3 id=monitoring>Monitoring</h3><p>Pgbouncer provides rich <code>SHOW</code> commands for monitoring pool status:</p><table class=full-width><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td><code>SHOW HELP</code></td><td>Show available commands</td></tr><tr><td><code>SHOW DATABASES</code></td><td>Show database config and status</td></tr><tr><td><code>SHOW POOLS</code></td><td>Show pool statistics</td></tr><tr><td><code>SHOW CLIENTS</code></td><td>Show client connection list</td></tr><tr><td><code>SHOW SERVERS</code></td><td>Show server connection list</td></tr><tr><td><code>SHOW USERS</code></td><td>Show user config</td></tr><tr><td><code>SHOW STATS</code></td><td>Show statistics (requests, bytes)</td></tr><tr><td><code>SHOW STATS_TOTALS</code></td><td>Show cumulative statistics</td></tr><tr><td><code>SHOW STATS_AVERAGES</code></td><td>Show average statistics</td></tr><tr><td><code>SHOW CONFIG</code></td><td>Show current config params</td></tr><tr><td><code>SHOW MEM</code></td><td>Show memory usage</td></tr><tr><td><code>SHOW DNS_HOSTS</code></td><td>Show DNS cached hostnames</td></tr><tr><td><code>SHOW DNS_ZONES</code></td><td>Show DNS cached zones</td></tr><tr><td><code>SHOW SOCKETS</code></td><td>Show open socket info</td></tr><tr><td><code>SHOW ACTIVE_SOCKETS</code></td><td>Show active sockets</td></tr><tr><td><code>SHOW LISTS</code></td><td>Show internal list counts</td></tr><tr><td><code>SHOW FDS</code></td><td>Show file descriptor usage</td></tr><tr><td><code>SHOW STATE</code></td><td>Show Pgbouncer running state</td></tr><tr><td><code>SHOW VERSION</code></td><td>Show Pgbouncer version</td></tr></tbody></table><p>Common monitoring examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View pool status</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW POOLS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View client connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW CLIENTS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View server connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW SERVERS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View statistics</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW STATS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View database status</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW DATABASES;&#34;</span>
</span></span></code></pre></div><p>For more monitoring command details, see <a href=https://www.pgbouncer.org/usage.html><strong>Pgbouncer official docs</strong></a>.</p><hr><h3 id=unix-signals>Unix Signals</h3><p>Pgbouncer supports Unix signal control, useful when admin console is unavailable:</p><table class=full-width><thead><tr><th>Signal</th><th>Equivalent Command</th><th>Description</th></tr></thead><tbody><tr><td><code>SIGHUP</code></td><td><code>RELOAD</code></td><td>Reload config files</td></tr><tr><td><code>SIGTERM</code></td><td><code>SHUTDOWN WAIT_FOR_CLIENTS</code></td><td>Graceful shutdown, wait clients</td></tr><tr><td><code>SIGINT</code></td><td><code>SHUTDOWN WAIT_FOR_SERVERS</code></td><td>Graceful shutdown, wait servers</td></tr><tr><td><code>SIGQUIT</code></td><td><code>SHUTDOWN</code></td><td>Immediate shutdown</td></tr><tr><td><code>SIGUSR1</code></td><td><code>PAUSE</code></td><td>Pause all databases</td></tr><tr><td><code>SIGUSR2</code></td><td><code>RESUME</code></td><td>Resume all databases</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload config via signal</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGHUP <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Graceful shutdown via signal</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGTERM <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pause via signal</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGUSR1 <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Resume via signal</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGUSR2 <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><hr><h2 id=traffic-switching>Traffic Switching</h2><p>Pigsty provides <code>pgb-route</code> utility function to quickly switch Pgbouncer traffic to other nodes for zero-downtime migration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Definition (already in /etc/profile.d/pg-alias.sh)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pgb-route<span style=color:#ce5c00;font-weight:700>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>local</span> <span style=color:#000>ip</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>1</span><span style=color:#000;font-weight:700>-</span><span style=color:#4e9a06>&#39;\/var\/run\/postgresql&#39;</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>  sed -ie <span style=color:#4e9a06>&#34;s/host=[^[:space:]]\+/host=</span><span style=color:#4e9a06>${</span><span style=color:#000>ip</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Usage: Route traffic to 10.10.10.12</span>
</span></span><span style=display:flex><span>$ pgb-route 10.10.10.12
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT; WAIT_CLOSE;&#34;</span>
</span></span></code></pre></div><p>Complete zero-downtime switching flow:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Modify route target</span>
</span></span><span style=display:flex><span>$ pgb-route 10.10.10.12
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Reload config</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. Rebuild connections and wait for old connections to release</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT;&#34;</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;WAIT_CLOSE;&#34;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ef5d737e5bae0aa77e9e8e5340965fd9>6.6 - Managing PostgreSQL Component Services</h1><div class=lead>Use systemctl to manage PostgreSQL cluster component services - start, stop, restart, reload, and status check.</div><h2 id=overview>Overview</h2><p>Pigsty&rsquo;s PGSQL module consists of multiple components, each running as a systemd service on nodes. (<a href=/docs/concept/arch/pgsql#pgbackrest><strong>pgbackrest</strong></a> is an exception)</p><p>Understanding these components and their management is essential for maintaining production PostgreSQL clusters.</p><table class=full-width><thead><tr><th style=text-align:left>Component</th><th style=text-align:left>Port</th><th style=text-align:left>Service Name</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>Patroni</td><td style=text-align:left><strong><code>8008</code></strong></td><td style=text-align:left><code>patroni</code></td><td style=text-align:left>HA manager, manages PostgreSQL lifecycle</td></tr><tr><td style=text-align:left>PostgreSQL</td><td style=text-align:left><strong><code>5432</code></strong></td><td style=text-align:left><code>postgres</code></td><td style=text-align:left>Placeholder service, not used, for emergency</td></tr><tr><td style=text-align:left>Pgbouncer</td><td style=text-align:left><strong><code>6432</code></strong></td><td style=text-align:left><code>pgbouncer</code></td><td style=text-align:left>Connection pooling middleware, traffic entry</td></tr><tr><td style=text-align:left>PgBackRest</td><td style=text-align:left>-</td><td style=text-align:left>-</td><td style=text-align:left>pgBackRest has no daemon service</td></tr><tr><td style=text-align:left>HAProxy</td><td style=text-align:left><strong><code>543x</code></strong></td><td style=text-align:left><code>haproxy</code></td><td style=text-align:left>Load balancer, exposes database services</td></tr><tr><td style=text-align:left>pg_exporter</td><td style=text-align:left><strong><code>9630</code></strong></td><td style=text-align:left><code>pg_exporter</code></td><td style=text-align:left>PostgreSQL metrics exporter</td></tr><tr><td style=text-align:left>pgbouncer_exporter</td><td style=text-align:left><strong><code>9631</code></strong></td><td style=text-align:left><code>pgbouncer_exporter</code></td><td style=text-align:left>Pgbouncer metrics exporter</td></tr><tr><td style=text-align:left>vip-manager</td><td style=text-align:left>-</td><td style=text-align:left><code>vip-manager</code></td><td style=text-align:left>Optional, manages L2 VIP address floating</td></tr></tbody></table><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Important</div><p><strong>Do NOT use systemctl directly to manage PostgreSQL service</strong>. PostgreSQL is managed by Patroni - use <a href=/docs/pgsql/admin/patroni><strong><code>patronictl</code></strong></a> commands instead.
Direct PostgreSQL operations may cause Patroni state inconsistency and trigger unexpected failover. The <code>postgres</code> service is an emergency escape hatch when Patroni fails.</p></div><hr><h2 id=quick-reference>Quick Reference</h2><table><thead><tr><th style=text-align:left>Operation</th><th style=text-align:left>Command</th></tr></thead><tbody><tr><td style=text-align:left>Start</td><td style=text-align:left><code>systemctl start &lt;service></code></td></tr><tr><td style=text-align:left>Stop</td><td style=text-align:left><code>systemctl stop &lt;service></code></td></tr><tr><td style=text-align:left>Restart</td><td style=text-align:left><code>systemctl restart &lt;service></code></td></tr><tr><td style=text-align:left>Reload</td><td style=text-align:left><code>systemctl reload &lt;service></code></td></tr><tr><td style=text-align:left>Status</td><td style=text-align:left><code>systemctl status &lt;service></code></td></tr><tr><td style=text-align:left>Logs</td><td style=text-align:left><code>journalctl -u &lt;service> -f</code></td></tr><tr><td style=text-align:left>Enable</td><td style=text-align:left><code>systemctl enable &lt;service></code></td></tr><tr><td style=text-align:left>Disable</td><td style=text-align:left><code>systemctl disable &lt;service></code></td></tr></tbody></table><p>Common service names: <code>patroni</code>, <code>pgbouncer</code>, <code>haproxy</code>, <code>pg_exporter</code>, <code>pgbouncer_exporter</code>, <code>vip-manager</code></p><hr><h2 id=patroni>Patroni</h2><p><a href=https://patroni.readthedocs.io/><strong>Patroni</strong></a> is PostgreSQL&rsquo;s HA manager, handling startup, shutdown, failure detection, and automatic failover.
It&rsquo;s the core PGSQL module component. PostgreSQL process is managed by Patroni - don&rsquo;t use systemctl to manage postgres service directly.</p><p><strong>Start Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start patroni     <span style=color:#8f5902;font-style:italic># Start Patroni (also starts PostgreSQL)</span>
</span></span></code></pre></div><p>After starting, Patroni auto-launches PostgreSQL. On first start, behavior depends on role:</p><ul><li>Primary: Initialize or recover data directory</li><li>Replica: Clone data from primary and establish replication</li></ul><p><strong>Stop Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop patroni      <span style=color:#8f5902;font-style:italic># Stop Patroni (also stops PostgreSQL)</span>
</span></span></code></pre></div><p>Stopping Patroni gracefully shuts down PostgreSQL. Note: If this is primary and auto-failover isn&rsquo;t paused, may trigger failover.</p><p><strong>Restart Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni   <span style=color:#8f5902;font-style:italic># Restart Patroni (also restarts PostgreSQL)</span>
</span></span></code></pre></div><p>Restart causes brief service interruption. For production, use <code>pg restart</code> for rolling restart.</p><p><strong>Reload Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload patroni    <span style=color:#8f5902;font-style:italic># Reload Patroni config</span>
</span></span></code></pre></div><p>Reload re-reads config file and applies hot-reloadable params to PostgreSQL.</p><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status patroni    <span style=color:#8f5902;font-style:italic># View Patroni service status</span>
</span></span><span style=display:flex><span>journalctl -u patroni -f    <span style=color:#8f5902;font-style:italic># Real-time Patroni logs</span>
</span></span><span style=display:flex><span>journalctl -u patroni -n <span style=color:#0000cf;font-weight:700>100</span> --no-pager  <span style=color:#8f5902;font-style:italic># Last 100 lines</span>
</span></span></code></pre></div><p><strong>Config file</strong>: <code>/etc/patroni/patroni.yml</code></p><blockquote><p><strong>Best Practice</strong>: Use <a href=/docs/pgsql/admin/patroni><strong><code>patronictl</code></strong></a> instead of systemctl to manage PostgreSQL clusters.</p></blockquote><hr><h2 id=pgbouncer>Pgbouncer</h2><p><a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> is a lightweight PostgreSQL connection pooling middleware.
Business traffic typically goes through Pgbouncer (6432) rather than directly to PostgreSQL (5432) for connection reuse and database protection.</p><p><strong>Start Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pgbouncer
</span></span></code></pre></div><p><strong>Stop Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pgbouncer
</span></span></code></pre></div><p>Note: Stopping Pgbouncer disconnects all pooled business connections.</p><p><strong>Restart Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart pgbouncer
</span></span></code></pre></div><p>Restart disconnects all existing connections. For config changes only, use <code>reload</code>.</p><p><strong>Reload Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload pgbouncer
</span></span></code></pre></div><p>Reload re-reads config files (user list, pool params, etc.) without disconnecting existing connections.</p><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pgbouncer
</span></span><span style=display:flex><span>journalctl -u pgbouncer -f
</span></span></code></pre></div><p><strong>Config files</strong>:</p><ul><li>Main config: <code>/etc/pgbouncer/pgbouncer.ini</code></li><li>HBA rules: <code>/etc/pgbouncer/pgb_hba.conf</code></li><li>User list: <code>/etc/pgbouncer/userlist.txt</code></li><li>Database list: <code>/etc/pgbouncer/database.txt</code></li></ul><p><strong>Admin Console</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>6432</span> -U postgres -d pgbouncer  <span style=color:#8f5902;font-style:italic># Connect to Pgbouncer admin console</span>
</span></span></code></pre></div><p>Common admin commands:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>POOLS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- View pool status
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>CLIENTS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- View client connections
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>SERVERS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- View backend server connections
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>STATS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- View statistics
</span></span></span><span style=display:flex><span><span style=color:#000>RELOAD</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- Reload config
</span></span></span><span style=display:flex><span><span style=color:#000>PAUSE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Pause all pools
</span></span></span><span style=display:flex><span><span style=color:#000>RESUME</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- Resume all pools
</span></span></span></code></pre></div><hr><h2 id=haproxy>HAProxy</h2><p><a href=https://www.haproxy.org/><strong>HAProxy</strong></a> is a high-performance load balancer that routes traffic to correct PostgreSQL instances.
Pigsty uses HAProxy to expose <a href=/docs/pgsql/service/><strong>services</strong></a>, routing traffic based on role (primary/replica) and health status.</p><p><strong>Start HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start haproxy
</span></span></code></pre></div><p><strong>Stop HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop haproxy
</span></span></code></pre></div><p>Note: Stopping HAProxy disconnects all load-balanced connections.</p><p><strong>Restart HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart haproxy
</span></span></code></pre></div><p><strong>Reload HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload haproxy
</span></span></code></pre></div><p>HAProxy supports graceful reload without disconnecting existing connections. Use <code>reload</code> for config changes.</p><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status haproxy
</span></span><span style=display:flex><span>journalctl -u haproxy -f
</span></span></code></pre></div><p><strong>Config file</strong>: <code>/etc/haproxy/haproxy.cfg</code></p><p><strong>Admin Interface</strong></p><p>HAProxy provides a web admin interface, default port 9101:</p><pre tabindex=0><code>http://&lt;node_ip&gt;:9101/haproxy
</code></pre><p>Default auth: username <code>admin</code>, password configured by <a href=/docs/node/param#haproxy_admin_password><strong><code>haproxy_admin_password</code></strong></a>.</p><hr><h2 id=pg_exporter>pg_exporter</h2><p><a href=https://github.com/pgsty/pg_exporter><strong>pg_exporter</strong></a> is PostgreSQL&rsquo;s Prometheus metrics exporter for collecting database performance metrics.</p><p><strong>Start pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pg_exporter
</span></span></code></pre></div><p><strong>Stop pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pg_exporter
</span></span></code></pre></div><p>After stopping, Prometheus can&rsquo;t collect PostgreSQL metrics from this instance.</p><p><strong>Restart pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart pg_exporter
</span></span></code></pre></div><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pg_exporter
</span></span><span style=display:flex><span>journalctl -u pg_exporter -f
</span></span></code></pre></div><p><strong>Config file</strong>: <code>/etc/pg_exporter.yml</code></p><p><strong>Verify Metrics</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s localhost:9630/metrics <span style=color:#000;font-weight:700>|</span> head -20
</span></span></code></pre></div><hr><h2 id=pgbouncer_exporter>pgbouncer_exporter</h2><p><strong>pgbouncer_exporter</strong> is Pgbouncer&rsquo;s Prometheus metrics exporter.</p><p><strong>Start/Stop/Restart</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pgbouncer_exporter
</span></span><span style=display:flex><span>systemctl stop pgbouncer_exporter
</span></span><span style=display:flex><span>systemctl restart pgbouncer_exporter
</span></span></code></pre></div><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pgbouncer_exporter
</span></span><span style=display:flex><span>journalctl -u pgbouncer_exporter -f
</span></span></code></pre></div><p><strong>Verify Metrics</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s localhost:9631/metrics <span style=color:#000;font-weight:700>|</span> head -20
</span></span></code></pre></div><hr><h2 id=vip-manager>vip-manager</h2><p><a href=https://github.com/cybertec-postgresql/vip-manager><strong>vip-manager</strong></a> is an optional component for managing L2 VIP address floating.
When <a href=/docs/pgsql/param#pg_vip_enabled><strong><code>pg_vip_enabled</code></strong></a> is enabled, vip-manager binds VIP to current primary node.</p><p><strong>Start vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start vip-manager
</span></span></code></pre></div><p><strong>Stop vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop vip-manager
</span></span></code></pre></div><p>After stopping, VIP address is released from current node.</p><p><strong>Restart vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart vip-manager
</span></span></code></pre></div><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status vip-manager
</span></span><span style=display:flex><span>journalctl -u vip-manager -f
</span></span></code></pre></div><p><strong>Config file</strong>: <code>/etc/default/vip-manager</code></p><p><strong>Verify VIP Binding</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip addr show           <span style=color:#8f5902;font-style:italic># Check network interfaces, verify VIP binding</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt;          <span style=color:#8f5902;font-style:italic># Confirm primary location</span>
</span></span></code></pre></div><hr><h2 id=startup-order--dependencies>Startup Order & Dependencies</h2><p>Recommended PGSQL module component startup order:</p><pre tabindex=0><code>1. patroni          # Start Patroni first (auto-starts PostgreSQL)
2. pgbouncer        # Then start connection pool
3. haproxy          # Start load balancer
4. pg_exporter      # Start metrics exporters
5. pgbouncer_exporter
6. vip-manager      # Finally start VIP manager (if enabled)
</code></pre><p>Stop order should be reversed. Pigsty playbooks handle these dependencies automatically.</p><p><strong>Batch Start All Services</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start patroni pgbouncer haproxy pg_exporter pgbouncer_exporter
</span></span></code></pre></div><p><strong>Batch Stop All Services</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pgbouncer_exporter pg_exporter haproxy pgbouncer patroni
</span></span></code></pre></div><hr><h2 id=common-troubleshooting>Common Troubleshooting</h2><p><strong>Service Startup Failure</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status &lt;service&gt;        <span style=color:#8f5902;font-style:italic># View service status</span>
</span></span><span style=display:flex><span>journalctl -u &lt;service&gt; -n <span style=color:#0000cf;font-weight:700>50</span>     <span style=color:#8f5902;font-style:italic># View recent logs</span>
</span></span><span style=display:flex><span>journalctl -u &lt;service&gt; --since <span style=color:#4e9a06>&#34;5 min ago&#34;</span>  <span style=color:#8f5902;font-style:italic># Last 5 minutes logs</span>
</span></span></code></pre></div><p><strong>Patroni Won&rsquo;t Start</strong></p><table><thead><tr><th style=text-align:left>Symptom</th><th style=text-align:left>Possible Cause</th><th style=text-align:left>Solution</th></tr></thead><tbody><tr><td style=text-align:left>Can&rsquo;t connect to etcd</td><td style=text-align:left>etcd cluster unavailable</td><td style=text-align:left>Check etcd service status</td></tr><tr><td style=text-align:left>Data dir permission error</td><td style=text-align:left>File ownership not postgres</td><td style=text-align:left><code>chown -R postgres:postgres /pg/data</code></td></tr><tr><td style=text-align:left>Port in use</td><td style=text-align:left>Leftover PostgreSQL process</td><td style=text-align:left><code>pg_ctl stop -D /pg/data</code> or <code>kill</code></td></tr></tbody></table><p><strong>Pgbouncer Won&rsquo;t Start</strong></p><table><thead><tr><th style=text-align:left>Symptom</th><th style=text-align:left>Possible Cause</th><th style=text-align:left>Solution</th></tr></thead><tbody><tr><td style=text-align:left>Config syntax error</td><td style=text-align:left>INI format error</td><td style=text-align:left>Check <code>/etc/pgbouncer/pgbouncer.ini</code></td></tr><tr><td style=text-align:left>Port in use</td><td style=text-align:left>Port 6432 already used</td><td style=text-align:left><code>lsof -i :6432</code></td></tr><tr><td style=text-align:left>userlist.txt permissions</td><td style=text-align:left>Incorrect file permissions</td><td style=text-align:left><code>chmod 600 /etc/pgbouncer/userlist.txt</code></td></tr></tbody></table><p><strong>HAProxy Won&rsquo;t Start</strong></p><table><thead><tr><th style=text-align:left>Symptom</th><th style=text-align:left>Possible Cause</th><th style=text-align:left>Solution</th></tr></thead><tbody><tr><td style=text-align:left>Config syntax error</td><td style=text-align:left>haproxy.cfg format error</td><td style=text-align:left><code>haproxy -c -f /etc/haproxy/haproxy.cfg</code></td></tr><tr><td style=text-align:left>Port in use</td><td style=text-align:left>Service port conflict</td><td style=text-align:left><code>lsof -i :5433</code></td></tr></tbody></table><hr><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni Management</strong></a>: Manage PostgreSQL HA with patronictl</li><li><a href=/docs/pgsql/admin/cluster/><strong>Cluster Management</strong></a>: Create, scale, destroy clusters</li><li><a href=/docs/pgsql/service/><strong>Service Configuration</strong></a>: HAProxy service definition and config</li><li><a href=/docs/pgsql/monitor/><strong>Monitoring System</strong></a>: PostgreSQL monitoring and alerting</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d6d9a4c3d54ca40e435a862870043f19>6.7 - Manage PostgreSQL Cron Jobs</h1><div class=lead>Configure crontab to schedule PostgreSQL backups, vacuum freeze, and bloat maintenance tasks</div><p>Pigsty uses crontab to manage scheduled tasks for routine backups, freezing aging transactions, and reorganizing bloated tables and indexes.</p><h2 id=quick-reference>Quick Reference</h2><table class=full-width><thead><tr><th style=text-align:left>Operation</th><th style=text-align:left>Quick Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#configure-cron-jobs><strong>Configure Cron Jobs</strong></a></td><td style=text-align:left><code>./pgsql.yml -t pg_crontab -l &lt;cls></code></td><td style=text-align:left>Apply pg_crontab config</td></tr><tr><td style=text-align:left><a href=#view-cron-jobs><strong>View Cron Jobs</strong></a></td><td style=text-align:left><code>crontab -l</code></td><td style=text-align:left>View as postgres user</td></tr><tr><td style=text-align:left><a href=#pg-backup><strong>Physical Backup</strong></a></td><td style=text-align:left><code>pg-backup [full|diff|incr]</code></td><td style=text-align:left>Execute backup with pgBackRest</td></tr><tr><td style=text-align:left><a href=#pg-vacuum><strong>Transaction Freeze</strong></a></td><td style=text-align:left><code>pg-vacuum [database...]</code></td><td style=text-align:left>Freeze aging transactions, prevent XID wraparound</td></tr><tr><td style=text-align:left><a href=#pg-repack><strong>Bloat Maintenance</strong></a></td><td style=text-align:left><code>pg-repack [database...]</code></td><td style=text-align:left>Online reorganize bloated tables and indexes</td></tr></tbody></table><p>For other management tasks, see: <a href=/docs/pgsql/backup/><strong>Backup Management</strong></a>, <a href=/docs/pgsql/monitor/><strong>Monitoring System</strong></a>, <a href=/docs/pgsql/admin/patroni><strong>HA Management</strong></a>.</p><hr><h2 id=configure-cron-jobs>Configure Cron Jobs</h2><p>Use the <a href=/docs/pgsql/param/#pg_crontab><strong><code>pg_crontab</code></strong></a> parameter to configure cron jobs for the PostgreSQL database superuser (<a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a>, default <code>postgres</code>).</p><p><strong>Example Configuration</strong></p><p>The following <code>pg-meta</code> cluster configures a daily full backup at 1:00 AM, while <code>pg-test</code> configures weekly full backup on Monday with incremental backups on other days.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Recommended Maintenance Schedule</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Daily full backup at 1:00 AM</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 03 * * 0 /pg/bin/pg-vacuum&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Weekly vacuum freeze on Sunday at 3:00 AM</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 04 * * 1 /pg/bin/pg-repack&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Weekly repack on Monday at 4:00 AM</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:left>Task</th><th style=text-align:left>Frequency</th><th style=text-align:left>Timing</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>pg-backup</code></td><td style=text-align:left>Daily</td><td style=text-align:left>Early morning</td><td style=text-align:left>Full or incremental backup, depending on business needs</td></tr><tr><td style=text-align:left><code>pg-vacuum</code></td><td style=text-align:left>Weekly</td><td style=text-align:left>Sunday early morning</td><td style=text-align:left>Freeze aging transactions, prevent XID wraparound</td></tr><tr><td style=text-align:left><code>pg-repack</code></td><td style=text-align:left>Weekly/Monthly</td><td style=text-align:left>Off-peak hours</td><td style=text-align:left>Reorganize bloated tables/indexes, reclaim space</td></tr></tbody></table><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Primary Only Execution</div><p>The <code>pg-backup</code>, <code>pg-vacuum</code>, and <code>pg-repack</code> scripts automatically detect the current node role. Only the primary will actually execute; replicas will exit directly. Therefore, you can safely configure the same cron jobs on all nodes, and after failover, the new primary will automatically continue executing maintenance tasks.</p></div><hr><h2 id=apply-cron-jobs>Apply Cron Jobs</h2><p>Cron jobs are automatically written to the default location for the corresponding OS distribution when the <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> playbook executes (the <code>pg_crontab</code> task):</p><ul><li>EL (RHEL/Rocky/Alma): <code>/var/spool/cron/postgres</code></li><li>Debian/Ubuntu: <code>/var/spool/cron/crontabs/postgres</code></li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=playbook aria-controls=tabs-01-00 aria-selected=true>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=manual aria-controls=tabs-01-01 aria-selected=false>
Manual</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_crontab     <span style=color:#8f5902;font-style:italic># Apply pg_crontab config to specified cluster</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.10 -t pg_crontab <span style=color:#8f5902;font-style:italic># Target specific host only</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Edit cron jobs as postgres user</span>
</span></span><span style=display:flex><span>sudo -u postgres crontab -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Or edit crontab file directly</span>
</span></span><span style=display:flex><span>sudo vi /var/spool/cron/postgres           <span style=color:#8f5902;font-style:italic># EL series</span>
</span></span><span style=display:flex><span>sudo vi /var/spool/cron/crontabs/postgres  <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><p>Each playbook execution will <strong>fully overwrite</strong> the cron job configuration.</p><hr><h2 id=view-cron-jobs>View Cron Jobs</h2><p>Execute the following command as the <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> OS user to view cron jobs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pigsty Managed Crontab for postgres</span>
</span></span><span style=display:flex><span><span style=color:#000>SHELL</span><span style=color:#ce5c00;font-weight:700>=</span>/bin/bash
</span></span><span style=display:flex><span><span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span>/usr/pgsql/bin:/pg/bin:/usr/local/bin:/usr/bin:/usr/sbin:/bin:/sbin
</span></span><span style=display:flex><span><span style=color:#000>MAILTO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>01</span> * * * /pg/bin/pg-backup
</span></span></code></pre></div><p>If you&rsquo;re not familiar with crontab syntax, refer to <a href=https://crontab.guru/>Crontab Guru</a> for explanations.</p><hr><h2 id=pg-backup>pg-backup</h2><p><code>pg-backup</code> is Pigsty&rsquo;s physical backup script based on <a href=https://pgbackrest.org/><strong>pgBackRest</strong></a>, supporting full, differential, and incremental backup modes.</p><p><strong>Basic Usage</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup                <span style=color:#8f5902;font-style:italic># Execute incremental backup (default), auto full if no existing full backup</span>
</span></span><span style=display:flex><span>pg-backup full           <span style=color:#8f5902;font-style:italic># Execute full backup</span>
</span></span><span style=display:flex><span>pg-backup diff           <span style=color:#8f5902;font-style:italic># Execute differential backup (based on most recent full backup)</span>
</span></span><span style=display:flex><span>pg-backup incr           <span style=color:#8f5902;font-style:italic># Execute incremental backup (based on most recent any backup)</span>
</span></span></code></pre></div><p><strong>Backup Types</strong></p><table class=full-width><thead><tr><th style=text-align:left>Type</th><th style=text-align:left>Parameter</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>Full Backup</td><td style=text-align:left><code>full</code></td><td style=text-align:left>Complete backup of all data, only this backup needed for recovery</td></tr><tr><td style=text-align:left>Differential</td><td style=text-align:left><code>diff</code></td><td style=text-align:left>Backup changes since last full backup, recovery needs full + diff</td></tr><tr><td style=text-align:left>Incremental</td><td style=text-align:left><code>incr</code></td><td style=text-align:left>Backup changes since last any backup, recovery needs complete chain</td></tr></tbody></table><p><strong>Execution Requirements</strong></p><ul><li>Script must run on <strong>primary</strong> as <strong>postgres</strong> user</li><li>Script auto-detects current node role, exits (exit 1) when run on replica</li><li>Auto-retrieves stanza name from <code>/etc/pgbackrest/pgbackrest.conf</code></li></ul><p><strong>Common Cron Configurations</strong></p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="daily full" aria-controls=tabs-02-00 aria-selected=true>
Daily Full</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="weekly full + daily incr" aria-controls=tabs-02-01 aria-selected=false>
Weekly Full + Daily Incr</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist="weekly full + daily diff" aria-controls=tabs-02-02 aria-selected=false>
Weekly Full + Daily Diff</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Daily full backup at 1:00 AM</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Monday full backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Other days incremental</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Monday full backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup diff&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Other days differential</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p>For more backup and recovery operations, see the <a href=/docs/pgsql/backup/><strong>Backup Management</strong></a> section.</p><hr><h2 id=pg-vacuum>pg-vacuum</h2><p><code>pg-vacuum</code> is Pigsty&rsquo;s transaction freeze script for executing <code>VACUUM FREEZE</code> operations to prevent database shutdown from transaction ID (XID) wraparound.</p><p><strong>Basic Usage</strong></p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist=basic aria-controls=tabs-03-00 aria-selected=true>
Basic</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist=options aria-controls=tabs-03-01 aria-selected=false>
Options</button></li><li class=nav-item><button class=nav-link id=tabs-03-02-tab data-bs-toggle=tab data-bs-target=#tabs-03-02 role=tab data-td-tp-persist="manual sql" aria-controls=tabs-03-02 aria-selected=false>
Manual SQL</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-vacuum                    <span style=color:#8f5902;font-style:italic># Freeze aging tables in all databases</span>
</span></span><span style=display:flex><span>pg-vacuum mydb               <span style=color:#8f5902;font-style:italic># Process specified database only</span>
</span></span><span style=display:flex><span>pg-vacuum mydb1 mydb2        <span style=color:#8f5902;font-style:italic># Process multiple databases</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-vacuum -n mydb            <span style=color:#8f5902;font-style:italic># Dry run mode, display only without executing</span>
</span></span><span style=display:flex><span>pg-vacuum -a <span style=color:#0000cf;font-weight:700>80000000</span> mydb   <span style=color:#8f5902;font-style:italic># Use custom age threshold (default 100M)</span>
</span></span><span style=display:flex><span>pg-vacuum -r <span style=color:#0000cf;font-weight:700>50</span> mydb         <span style=color:#8f5902;font-style:italic># Use custom aging ratio threshold (default 40%)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-02 role=tabpanel aria-labelled-by=tabs-03-02-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Execute VACUUM FREEZE on entire database
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VACUUM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FREEZE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Execute VACUUM FREEZE on specific table
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VACUUM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FREEZE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p><strong>Command Options</strong></p><table class=full-width><thead><tr><th style=text-align:left>Option</th><th style=text-align:left>Description</th><th style=text-align:left>Default</th></tr></thead><tbody><tr><td style=text-align:left><code>-h, --help</code></td><td style=text-align:left>Show help message</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>-n, --dry-run</code></td><td style=text-align:left>Dry run mode, display only</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-a, --age</code></td><td style=text-align:left>Age threshold, tables exceeding need freeze</td><td style=text-align:left>100000000</td></tr><tr><td style=text-align:left><code>-r, --ratio</code></td><td style=text-align:left>Aging ratio threshold, full freeze if exceeded (%)</td><td style=text-align:left>40</td></tr></tbody></table><p><strong>Logic</strong></p><ol><li>Check database <code>datfrozenxid</code> age, skip database if below threshold</li><li>Calculate aging page ratio (percentage of table pages exceeding age threshold of total pages)</li><li>If aging ratio > 40%, execute full database <code>VACUUM FREEZE ANALYZE</code></li><li>Otherwise, only execute <code>VACUUM FREEZE ANALYZE</code> on tables exceeding age threshold</li></ol><p>Script sets <code>vacuum_cost_limit = 10000</code> and <code>vacuum_cost_delay = 1ms</code> to control I/O impact.</p><p><strong>Execution Requirements</strong></p><ul><li>Script must run on <strong>primary</strong> as <strong>postgres</strong> user</li><li>Uses file lock <code>/tmp/pg-vacuum.lock</code> to prevent concurrent execution</li><li>Auto-skips <code>template0</code>, <code>template1</code>, <code>postgres</code> system databases</li></ul><p><strong>Common Cron Configuration</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 03 * * 0 /pg/bin/pg-vacuum&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># Weekly Sunday at 3:00 AM</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=pg-repack>pg-repack</h2><p><code>pg-repack</code> is Pigsty&rsquo;s bloat maintenance script based on the <a href=https://reorg.github.io/pg_repack/><strong>pg_repack</strong></a> extension for online reorganization of bloated tables and indexes.</p><p><strong>Basic Usage</strong></p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=basic aria-controls=tabs-04-00 aria-selected=true>
Basic</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=options aria-controls=tabs-04-01 aria-selected=false>
Options</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=manual aria-controls=tabs-04-02 aria-selected=false>
Manual</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-repack                    <span style=color:#8f5902;font-style:italic># Reorganize bloated tables and indexes in all databases</span>
</span></span><span style=display:flex><span>pg-repack mydb               <span style=color:#8f5902;font-style:italic># Reorganize specified database only</span>
</span></span><span style=display:flex><span>pg-repack mydb1 mydb2        <span style=color:#8f5902;font-style:italic># Reorganize multiple databases</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-repack -n mydb            <span style=color:#8f5902;font-style:italic># Dry run mode, display only without executing</span>
</span></span><span style=display:flex><span>pg-repack -t mydb            <span style=color:#8f5902;font-style:italic># Reorganize tables only</span>
</span></span><span style=display:flex><span>pg-repack -i mydb            <span style=color:#8f5902;font-style:italic># Reorganize indexes only</span>
</span></span><span style=display:flex><span>pg-repack -T <span style=color:#0000cf;font-weight:700>30</span> -j <span style=color:#0000cf;font-weight:700>4</span> mydb    <span style=color:#8f5902;font-style:italic># Custom lock timeout (seconds) and parallelism</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use pg_repack command directly to reorganize specific table</span>
</span></span><span style=display:flex><span>pg_repack dbname -t schema.table
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use pg_repack command directly to reorganize specific index</span>
</span></span><span style=display:flex><span>pg_repack dbname -i schema.index
</span></span></code></pre></div></div></div><p><strong>Command Options</strong></p><table class=full-width><thead><tr><th style=text-align:left>Option</th><th style=text-align:left>Description</th><th style=text-align:left>Default</th></tr></thead><tbody><tr><td style=text-align:left><code>-h, --help</code></td><td style=text-align:left>Show help message</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>-n, --dry-run</code></td><td style=text-align:left>Dry run mode, display only</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-t, --table</code></td><td style=text-align:left>Reorganize tables only</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-i, --index</code></td><td style=text-align:left>Reorganize indexes only</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-T, --timeout</code></td><td style=text-align:left>Lock wait timeout (seconds)</td><td style=text-align:left>10</td></tr><tr><td style=text-align:left><code>-j, --jobs</code></td><td style=text-align:left>Parallel jobs</td><td style=text-align:left>2</td></tr></tbody></table><p><strong>Auto-Selection Thresholds</strong></p><p>Script auto-selects objects to reorganize based on table/index size and bloat ratio:</p><p><strong>Table Bloat Thresholds</strong></p><table class=full-width><thead><tr><th style=text-align:left>Size Range</th><th style=text-align:center>Bloat Threshold</th><th style=text-align:center>Max Count</th></tr></thead><tbody><tr><td style=text-align:left>&lt; 256MB</td><td style=text-align:center>> 40%</td><td style=text-align:center>64</td></tr><tr><td style=text-align:left>256MB - 2GB</td><td style=text-align:center>> 30%</td><td style=text-align:center>16</td></tr><tr><td style=text-align:left>2GB - 8GB</td><td style=text-align:center>> 20%</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>8GB - 64GB</td><td style=text-align:center>> 15%</td><td style=text-align:center>1</td></tr></tbody></table><p><strong>Index Bloat Thresholds</strong></p><table class=full-width><thead><tr><th style=text-align:left>Size Range</th><th style=text-align:center>Bloat Threshold</th><th style=text-align:center>Max Count</th></tr></thead><tbody><tr><td style=text-align:left>&lt; 128MB</td><td style=text-align:center>> 40%</td><td style=text-align:center>64</td></tr><tr><td style=text-align:left>128MB - 1GB</td><td style=text-align:center>> 35%</td><td style=text-align:center>16</td></tr><tr><td style=text-align:left>1GB - 8GB</td><td style=text-align:center>> 30%</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>8GB - 64GB</td><td style=text-align:center>> 20%</td><td style=text-align:center>1</td></tr></tbody></table><p>Tables/indexes over 64GB are skipped with a warning and require manual handling.</p><p><strong>Execution Requirements</strong></p><ul><li>Script must run on <strong>primary</strong> as <strong>postgres</strong> user</li><li>Requires <code>pg_repack</code> extension installed (installed by default in Pigsty)</li><li>Requires <code>pg_table_bloat</code> and <code>pg_index_bloat</code> views in <code>monitor</code> schema</li><li>Uses file lock <code>/tmp/pg-repack.lock</code> to prevent concurrent execution</li><li>Auto-skips <code>template0</code>, <code>template1</code>, <code>postgres</code> system databases</li></ul><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>Lock Waiting</div><p>Normal reads/writes are not affected during reorganization, but the <strong>final switch moment</strong> requires acquiring AccessExclusive lock on the table, blocking all access. For high-throughput workloads, recommend running during off-peak hours or maintenance windows.</p></div><p><strong>Common Cron Configuration</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 04 * * 1 /pg/bin/pg-repack&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># Weekly Monday at 4:00 AM</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can confirm database bloat through Pigsty&rsquo;s <a href=https://demo.pigsty.io/d/pgcat-database><strong>PGCAT Database - Table Bloat</strong></a> panel and select high-bloat tables and indexes for reorganization.</p><p>For more details see: <a href=https://vonng.com/pg/bloat/><strong>Managing Relation Bloat</strong></a></p><hr><h2 id=remove-cron-jobs>Remove Cron Jobs</h2><p>When using the <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> playbook to remove a PostgreSQL cluster, it automatically deletes the postgres user&rsquo;s crontab file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt; -t pg_crontab    <span style=color:#8f5902;font-style:italic># Remove cron jobs only</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># Remove entire cluster (including cron jobs)</span>
</span></span></code></pre></div><hr><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=/docs/pgsql/backup/><strong>Backup Management</strong></a>: PostgreSQL backup and recovery</li><li><a href=/docs/pgsql/monitor/><strong>Monitoring System</strong></a>: PostgreSQL monitoring and alerting</li><li><a href=/docs/pgsql/admin/cluster/><strong>Cluster Management</strong></a>: Cluster creation, scaling, and teardown</li><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni Management</strong></a>: HA cluster management</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2b2e08d4aed2707846688f2a5517519d>6.8 - Managing PostgreSQL Extensions</h1><div class=lead>Extension management - download, install, configure, enable, update, and remove extensions</div><h2 id=quick-start>Quick Start</h2><p>Pigsty provides <a href=https://pgext.cloud/list><strong>440+ extensions</strong></a>. Using extensions involves four steps: <strong>Download</strong>, <strong>Install</strong>, <strong>Configure</strong>, <strong>Enable</strong>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Install extension packages</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- Configure preload extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, vector ]           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Enable in database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=script aria-controls=tabs-00-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-00-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=example aria-controls=tabs-00-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># Install extensions defined in config on &lt;cls&gt; cluster</span>
</span></span><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ext...<span style=color:#ce5c00;font-weight:700>]</span>  <span style=color:#8f5902;font-style:italic># Install extensions specified on command line</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_ext    <span style=color:#8f5902;font-style:italic># Use playbook to install extensions</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta                         <span style=color:#8f5902;font-style:italic># Install defined extensions on pg-meta cluster</span>
</span></span><span style=display:flex><span>bin/pgsql-ext pg-meta pg_duckdb pg_mooncake   <span style=color:#8f5902;font-style:italic># Install specified extensions</span>
</span></span></code></pre></div></div></div><p>For complete extension reference, see <a href=/docs/pgsql/ext/><strong>Extensions</strong></a>. For available extensions, see <a href=https://pgext.cloud/list><strong>Extension Catalog</strong></a>.</p><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#download-extensions><strong>Download Extensions</strong></a></td><td style=text-align:left><code>./infra.yml -t repo_build</code></td><td style=text-align:left>Download extensions to local repo</td></tr><tr><td style=text-align:left><a href=#install-extensions><strong>Install Extensions</strong></a></td><td style=text-align:left><code>bin/pgsql-ext &lt;cls></code></td><td style=text-align:left>Install extension packages on cluster</td></tr><tr><td style=text-align:left><a href=#configure-extensions><strong>Configure Extensions</strong></a></td><td style=text-align:left><code>pg edit-config &lt;cls> -p</code></td><td style=text-align:left>Add to preload libs (requires restart)</td></tr><tr><td style=text-align:left><a href=#enable-extensions><strong>Enable Extensions</strong></a></td><td style=text-align:left><code>psql -c 'CREATE EXT ...'</code></td><td style=text-align:left>Create extension objects in database</td></tr><tr><td style=text-align:left><a href=#update-extensions><strong>Update Extensions</strong></a></td><td style=text-align:left><code>ALTER EXTENSION UPDATE</code></td><td style=text-align:left>Update packages and extension objects</td></tr><tr><td style=text-align:left><a href=#remove-extensions><strong>Remove Extensions</strong></a></td><td style=text-align:left><code>DROP EXTENSION</code></td><td style=text-align:left>Drop extension objects, uninstall pkgs</td></tr></tbody></table><div id=asciinema-ec8f712cd845ce138b45a5d9d91243a9 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ec8f712cd845ce138b45a5d9d91243a9",o="/demo/pgsql-ext.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=install-extensions>Install Extensions</h2><p>Extensions defined in <a href=/docs/pgsql/param#pg_extensions><strong><code>pg_extensions</code></strong></a> are auto-installed during PostgreSQL <a href=/docs/pgsql/admin/cluster#create-cluster><strong>cluster creation</strong></a> in the <code>pg_extension</code> task.</p><p>To install extensions on an existing cluster, add extensions to <code>all.children.&lt;cls>.pg_extensions</code>, then execute:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=script aria-controls=tabs-02-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-02-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=example aria-controls=tabs-02-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt;   <span style=color:#8f5902;font-style:italic># Install extensions on &lt;cls&gt; cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_extension   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta    <span style=color:#8f5902;font-style:italic># Install extensions defined in config on pg-meta</span>
</span></span></code></pre></div></div></div><p><strong>Example: Install PostGIS, TimescaleDB and PGVector on cluster</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Result</strong>: Installs extension packages on all cluster nodes. Pigsty auto-translates <a href=/docs/pgsql/config/alias><strong>package aliases</strong></a> to actual package names for OS and PG version.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Ensure repos available before install</div><p>Before installing, ensure nodes have correct repos configured - extensions <a href=#download-extensions><strong>downloaded</strong></a> to local repo, or <a href=#configure-repos><strong>upstream repos configured</strong></a>.</p></div><hr><h2 id=manual-install>Manual Install</h2><p>If you don&rsquo;t want to use Pigsty config to manage extensions, pass extension list directly on command line:</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=script aria-controls=tabs-04-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-04-01 aria-selected=false>
Playbook</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta pg_duckdb pg_mooncake   <span style=color:#8f5902;font-style:italic># Install specified extensions on pg-meta</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_ext -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;: [&#34;pg_duckdb&#34;, &#34;pg_mooncake&#34;]}&#39;</span>
</span></span></code></pre></div></div></div><p>You can also use <a href=/docs/pig><strong>pig</strong></a> package manager CLI to install extensions on single node, with auto <a href=/docs/pgsql/config/alias><strong>package alias</strong></a> resolution.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig install postgis timescaledb       <span style=color:#8f5902;font-style:italic># Install multiple extensions</span>
</span></span><span style=display:flex><span>pig install pgvector -v <span style=color:#0000cf;font-weight:700>17</span>            <span style=color:#8f5902;font-style:italic># Install for specific PG major version</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ansible pg-test -b -a <span style=color:#4e9a06>&#39;pig install pg_duckdb&#39;</span>   <span style=color:#8f5902;font-style:italic># Batch install on cluster with Ansible</span>
</span></span></code></pre></div><p>You can also <strong>use OS package manager directly</strong> (<code>apt/dnf</code>), but you must know the exact RPM/DEB package name for your OS/PG:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL systems (RHEL, Rocky, Alma, Oracle Linux)</span>
</span></span><span style=display:flex><span>sudo yum install -y pgvector_17*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian / Ubuntu</span>
</span></span><span style=display:flex><span>sudo apt install -y postgresql-17-pgvector
</span></span></code></pre></div><hr><h2 id=download-extensions>Download Extensions</h2><p>To install extensions, ensure node&rsquo;s <a href=/docs/repo/pgsql><strong>extension repos</strong></a> contain the extension:</p><ul><li><a href=/docs/setup/install><strong>Standalone install</strong></a>: No worries, upstream repos already added to node.</li><li><a href=/docs/setup/offline><strong>Offline install</strong></a>: No worries, most extensions included in offline package, few require online install.</li><li><a href=/docs/deploy/install><strong>Production multi-node deployment</strong></a> with local repo: depends - if extension was in <a href=/docs/infra/param/#repo_packages><code>repo_packages</code></a> / <a href=/docs/infra/param/#repo_extra_packages><code>repo_extra_packages</code></a> when creating local repo, it&rsquo;s already downloaded. Otherwise download first or <a href=#configure-repos><strong>configure upstream repos</strong></a> for online install.</li></ul><p>Pigsty&rsquo;s default config auto-downloads mainstream extensions during installation. For additional extensions, add to <a href=/docs/infra/param#repo_extra_packages><strong><code>repo_extra_packages</code></strong></a> and rebuild repo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>repo_extra_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, postgis, timescaledb ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=script aria-controls=tabs-05-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-05-01 aria-selected=false>
Playbook</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make repo         <span style=color:#8f5902;font-style:italic># Shortcut = repo-build + node-repo</span>
</span></span><span style=display:flex><span>make repo-build   <span style=color:#8f5902;font-style:italic># Rebuild Infra repo (download packages and deps)</span>
</span></span><span style=display:flex><span>make node-repo    <span style=color:#8f5902;font-style:italic># Refresh node repo cache, update Infra repo reference</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy.yml -t repo_build,node_repo  <span style=color:#8f5902;font-style:italic># Execute both tasks at once</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build     <span style=color:#8f5902;font-style:italic># Re-download packages to local repo</span>
</span></span><span style=display:flex><span>./node.yml  -t node_repo      <span style=color:#8f5902;font-style:italic># Refresh node repo cache</span>
</span></span></code></pre></div></div></div><hr><h2 id=configure-repos>Configure Repos</h2><p>You can also let all nodes use upstream repos directly (not recommended for production), skipping download and installing from <a href=/docs/repo/pgsql><strong>upstream extension repos</strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql   <span style=color:#8f5902;font-style:italic># Add PGDG and Pigsty upstream repos</span>
</span></span></code></pre></div><hr><h2 id=configure-extensions>Configure Extensions</h2><p>Some extensions require preloading to <a href=https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-SHARED-PRELOAD-LIBRARIES><strong><code>shared_preload_libraries</code></strong></a>, requiring <strong>database restart</strong> after modification.</p><p>Use <a href=/docs/pgsql/param#pg_libs><strong><code>pg_libs</code></strong></a> as its default value to configure preload extensions, but this only takes effect during cluster init - later modifications are ineffective.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Preload extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb, postgis, pgvector ]         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Install packages</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For existing clusters, refer to <a href=/docs/pgsql/admin/patroni#edit-config><strong>Modify Config</strong></a> to modify <code>shared_preload_libraries</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>pg restart pg-meta   <span style=color:#8f5902;font-style:italic># Modify pg-meta params and restart to apply</span>
</span></span></code></pre></div><p>Ensure extension packages are correctly installed before adding preload config. If extension in <code>shared_preload_libraries</code> doesn&rsquo;t exist or fails to load, PostgreSQL <strong>won&rsquo;t start</strong>.
Also, manage cluster config changes through Patroni - avoid using <code>ALTER SYSTEM</code> or <a href=/docs/pgsql/param#pg_parameters><strong><code>pg_parameters</code></strong></a> to modify instance config separately.
If primary and replica configs differ, it may cause startup failure or replication interruption.</p><hr><h2 id=enable-extensions>Enable Extensions</h2><p>After installing packages, execute <code>CREATE EXTENSION</code> in database to use extension features.</p><p><strong>Enable during cluster init</strong></p><p>Declare extensions to enable in <a href=/docs/pgsql/config/db><strong>database definition</strong></a> via <code>extensions</code> array:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>vector                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Simple form</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Specify schema</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manual enable</strong></p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist=sql aria-controls=tabs-06-00 aria-selected=true>
SQL</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist=psql aria-controls=tabs-06-01 aria-selected=false>
psql</button></li><li class=nav-item><button class=nav-link id=tabs-06-02-tab data-bs-toggle=tab data-bs-target=#tabs-06-02 role=tab data-td-tp-persist=playbook aria-controls=tabs-06-02 aria-selected=false>
Playbook</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic>-- Create extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- Specify schema
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- Idempotent creation
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- Auto-install dependencies
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION vector;&#39;</span>                  <span style=color:#8f5902;font-style:italic># Create extension in meta database</span>
</span></span><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION postgis SCHEMA public;&#39;</span>   <span style=color:#8f5902;font-style:italic># Specify schema</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-02 role=tabpanel aria-labelled-by=tabs-06-02-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># After modifying database definition, use playbook to enable extensions</span>
</span></span><span style=display:flex><span>bin/pgsql-db pg-meta meta    <span style=color:#8f5902;font-style:italic># Creating/modifying database auto-enables defined extensions</span>
</span></span></code></pre></div></div></div><p><strong>Result</strong>: Creates extension objects (functions, types, operators, index methods, etc.) in database, enabling use of extension features.</p><hr><h2 id=update-extensions>Update Extensions</h2><p>Extension updates involve two layers: <strong>package update</strong> and <strong>extension object update</strong>.</p><p><strong>Update packages</strong></p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist=pig aria-controls=tabs-07-00 aria-selected=true>
pig</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist=yum aria-controls=tabs-07-01 aria-selected=false>
yum</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab data-td-tp-persist=apt aria-controls=tabs-07-02 aria-selected=false>
apt</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig update pgvector                           <span style=color:#8f5902;font-style:italic># Update extension with pig</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum update pgvector_18 <span style=color:#8f5902;font-style:italic># EL</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt upgrade postgresql-18-pgvector  <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><p><strong>Update extension objects</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View upgradeable extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Update extension to latest version
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Update to specific version
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.8.1&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>Update Notes</div><p>Backup database before updating extensions. Preloaded extensions may require PostgreSQL restart after update. Some extension version upgrades may be incompatible - check extension docs.</p></div><hr><h2 id=remove-extensions>Remove Extensions</h2><p>Removing extensions involves two layers: <strong>drop extension objects</strong> and <strong>uninstall packages</strong>.</p><p><strong>Drop extension objects</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- Drop extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- Cascade drop (drops dependent objects)
</span></span></span></code></pre></div><p><strong>Remove from preload</strong></p><p>For preloaded extensions, remove from <code>shared_preload_libraries</code> and restart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>pg restart pg-meta   <span style=color:#8f5902;font-style:italic># Restart to apply config</span>
</span></span></code></pre></div><p><strong>Uninstall packages (optional)</strong></p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist=pig aria-controls=tabs-09-00 aria-selected=true>
pig</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist=yum aria-controls=tabs-09-01 aria-selected=false>
yum</button></li><li class=nav-item><button class=nav-link id=tabs-09-02-tab data-bs-toggle=tab data-bs-target=#tabs-09-02 role=tab data-td-tp-persist=apt aria-controls=tabs-09-02 aria-selected=false>
apt</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig remove pgvector                           <span style=color:#8f5902;font-style:italic># Uninstall with pig</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum remove pgvector_17*                  <span style=color:#8f5902;font-style:italic># EL systems</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-02 role=tabpanel aria-labelled-by=tabs-09-02-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt remove postgresql-17-pgvector        <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>CASCADE Warning</div><p>Using <code>CASCADE</code> to drop extensions also drops all objects depending on that extension (tables, indexes, views, etc.). Check dependencies before executing.</p></div><hr><h2 id=query-extensions>Query Extensions</h2><p>Common SQL queries for extension info:</p><p><strong>View enabled extensions</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#f8f8f8> </span><span style=color:#000>n</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extnamespace</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>n</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View available extensions</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- Only show installed
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Check if extension is available</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View extension dependencies</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>refobjid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>depends_on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>objid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>deptype</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;e&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgis_topology&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View extension objects</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>classid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>objid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>deptype</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>refobjid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>psql shortcuts</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#4e9a06>\d</span>x                    <span style=color:#8f5902;font-style:italic># List enabled extensions</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>\d</span>x+ vector            <span style=color:#8f5902;font-style:italic># Show extension details</span>
</span></span></code></pre></div><hr><h2 id=add-repos>Add Repos</h2><p>To install directly from upstream, manually add repos.</p><p><strong>Using Pigsty playbook</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql        <span style=color:#8f5902;font-style:italic># Add PGDG and Pigsty repos</span>
</span></span><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql,local  <span style=color:#8f5902;font-style:italic># Including local repo</span>
</span></span></code></pre></div><p><strong>YUM repos (EL systems)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pigsty repo</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># China mainland mirror</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span></code></pre></div><p><strong>APT repos (Debian/Ubuntu)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/pigsty.gpg
</span></span><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/pgsql $(lsb_release -cs) main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># China mainland mirror: replace repo.pigsty.io with repo.pigsty.cc</span>
</span></span></code></pre></div><hr><h2 id=faq>FAQ</h2><p><strong>Difference between extension name and package name</strong></p><table class=full-width><thead><tr><th style=text-align:left>Name</th><th style=text-align:left>Description</th><th style=text-align:left>Example</th></tr></thead><tbody><tr><td style=text-align:left>Extension name</td><td style=text-align:left>Name used with <code>CREATE EXTENSION</code></td><td style=text-align:left><code>vector</code></td></tr><tr><td style=text-align:left>Package alias</td><td style=text-align:left>Standardized name in Pigsty config</td><td style=text-align:left><code>pgvector</code></td></tr><tr><td style=text-align:left>Package name</td><td style=text-align:left>Actual OS package name</td><td style=text-align:left><code>pgvector_17*</code> or <code>postgresql-17-pgvector</code></td></tr></tbody></table><p><strong>Preloaded extension prevents startup</strong></p><p>If extension in <code>shared_preload_libraries</code> doesn&rsquo;t exist or fails to load, PostgreSQL won&rsquo;t start. Solutions:</p><ol><li>Ensure extension package is correctly installed</li><li>Or remove extension from <code>shared_preload_libraries</code> (edit <code>/pg/data/postgresql.conf</code>)</li></ol><p><strong>Extension dependencies</strong></p><p>Some extensions depend on others, requiring sequential creation or using <code>CASCADE</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic>-- Create base extension first
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Then create dependent extension
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Or
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- Auto-create dependencies
</span></span></span></code></pre></div><p><strong>Extension version incompatibility</strong></p><p>View extension versions supported by current PostgreSQL:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extension_versions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=related-resources>Related Resources</h2><ul><li><a href=/docs/pgsql/ext/><strong>Extensions</strong></a>: Detailed extension management documentation</li><li><a href=https://pgext.cloud/list><strong>Extension Catalog</strong></a>: Browse 440+ available extensions</li><li><a href=https://pgext.cloud/pig><strong>pig Package Manager</strong></a>: Extension installation CLI tool</li><li><a href=/docs/pgsql/admin/db/><strong>Database Management</strong></a>: Enable extensions in databases</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fda28727166c3a3a755b7258c9071594>6.9 - Upgrading PostgreSQL Major/Minor Versions</h1><div class=lead>Version upgrade - minor version rolling upgrade, major version migration, extension upgrade</div><h2 id=quick-start>Quick Start</h2><p>PostgreSQL version upgrades fall into two types: <strong>minor version upgrade</strong> and <strong>major version upgrade</strong>, with very different risk and complexity.</p><table class=full-width><thead><tr><th style=text-align:left>Type</th><th style=text-align:left>Example</th><th style=text-align:left>Downtime</th><th style=text-align:left>Data Compatibility</th><th style=text-align:left>Risk</th></tr></thead><tbody><tr><td style=text-align:left>Minor upgrade</td><td style=text-align:left>17.2 → 17.3</td><td style=text-align:left>Seconds (rolling)</td><td style=text-align:left>Fully compatible</td><td style=text-align:left>Low</td></tr><tr><td style=text-align:left>Major upgrade</td><td style=text-align:left>17 → 18</td><td style=text-align:left>Minutes</td><td style=text-align:left>Requires data dir upgrade</td><td style=text-align:left>Medium</td></tr></tbody></table><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=minor aria-controls=tabs-00-00 aria-selected=true>
Minor</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=major aria-controls=tabs-00-01 aria-selected=false>
Major</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=extension aria-controls=tabs-00-02 aria-selected=false>
Extension</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Rolling upgrade: replicas first, then primary</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span><span style=display:flex><span>pg restart --role replica --force &lt;cls&gt;
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt;
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; &lt;old-primary&gt; --force
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recommended: Logical replication migration</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-new              <span style=color:#8f5902;font-style:italic># Create new version cluster</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure logical replication to sync data...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Switch traffic to new cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgis36_17*&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER EXTENSION postgis UPDATE;&#39;</span>
</span></span></code></pre></div></div></div><p>For detailed online migration process, see <a href=/docs/pgsql/migration><strong>Online Migration</strong></a> documentation.</p><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Description</th><th style=text-align:left>Risk</th></tr></thead><tbody><tr><td style=text-align:left><a href=#minor-version-upgrade><strong>Minor Version Upgrade</strong></a></td><td style=text-align:left>Update packages, rolling restart</td><td style=text-align:left>Low</td></tr><tr><td style=text-align:left><a href=#minor-version-downgrade><strong>Minor Version Downgrade</strong></a></td><td style=text-align:left>Rollback to previous minor version</td><td style=text-align:left>Low</td></tr><tr><td style=text-align:left><a href=#major-version-upgrade><strong>Major Version Upgrade</strong></a></td><td style=text-align:left>Logical replication or pg_upgrade</td><td style=text-align:left>Medium</td></tr><tr><td style=text-align:left><a href=#extension-upgrade><strong>Extension Upgrade</strong></a></td><td style=text-align:left>Upgrade extension packages and objects</td><td style=text-align:left>Low</td></tr></tbody></table><hr><h2 id=minor-version-upgrade>Minor Version Upgrade</h2><p>Minor version upgrades (e.g., 17.2 → 17.3) are the most common upgrade scenario, typically for security patches and bug fixes. Data directory is fully compatible, completed via rolling restart.</p><p><strong>Strategy</strong>: Recommended <strong>rolling upgrade</strong>: upgrade replicas first, then switchover to upgrade original primary - minimizes service interruption.</p><pre tabindex=0><code>1. Update repo → 2. Upgrade replica packages → 3. Restart replicas
4. Switchover → 5. Upgrade original primary packages → 6. Restart original primary
</code></pre><p><strong>Step 1: Prepare packages</strong></p><p>Ensure local repo has latest PostgreSQL packages and refresh node cache:</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=repo aria-controls=tabs-01-00 aria-selected=true>
Repo</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=el aria-controls=tabs-01-01 aria-selected=false>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=debian aria-controls=tabs-01-02 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty
</span></span><span style=display:flex><span>./infra.yml -t repo_upstream      <span style=color:#8f5902;font-style:italic># Add upstream repos (needs internet)</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build         <span style=color:#8f5902;font-style:italic># Rebuild local repo</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum clean all&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum makecache&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt clean&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt update&#39;</span>
</span></span></code></pre></div></div></div><p><strong>Step 2: Upgrade replicas</strong></p><p>Upgrade packages on all replicas and verify version:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=el aria-controls=tabs-02-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=debian aria-controls=tabs-02-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;/usr/pgsql/bin/pg_ctl --version&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;/usr/lib/postgresql/17/bin/pg_ctl --version&#39;</span>
</span></span></code></pre></div></div></div><p>Restart all replicas to apply new version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart --role replica --force &lt;cls&gt;
</span></span></code></pre></div><p><strong>Step 3: Switchover</strong></p><p>Execute switchover to transfer primary role to upgraded replica:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg switchover &lt;cls&gt;
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Or non-interactive:</span>
</span></span><span style=display:flex><span>pg switchover --leader &lt;old-primary&gt; --candidate &lt;new-primary&gt; --scheduled<span style=color:#ce5c00;font-weight:700>=</span>now --force &lt;cls&gt;
</span></span></code></pre></div><p><strong>Step 4: Upgrade original primary</strong></p><p>Original primary is now replica - upgrade packages and restart:</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist=el aria-controls=tabs-03-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist=debian aria-controls=tabs-03-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;old-primary-ip&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;old-primary-ip&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17&#39;</span>
</span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart &lt;cls&gt; &lt;old-primary-name&gt; --force
</span></span></code></pre></div><p><strong>Step 5: Verify</strong></p><p>Confirm all instances have consistent version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list &lt;cls&gt;
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;SELECT version()&#34;</span>
</span></span></code></pre></div><hr><h2 id=minor-version-downgrade>Minor Version Downgrade</h2><p>In rare cases (e.g., new version introduces bugs), may need to downgrade PostgreSQL to previous version.</p><p><strong>Step 1: Get old version packages</strong></p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=el aria-controls=tabs-04-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="refresh cache" aria-controls=tabs-04-01 aria-selected=false>
Refresh Cache</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span> ./infra.yml -t repo_upstream     <span style=color:#8f5902;font-style:italic># Add upstream repos</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> /www/pigsty<span style=color:#000;font-weight:700>;</span> repotrack postgresql17-*-17.1 <span style=color:#8f5902;font-style:italic># Download specific version packages</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span> ./infra.yml -t repo_create       <span style=color:#8f5902;font-style:italic># Rebuild repo metadata</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum clean all&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum makecache&#39;</span>
</span></span></code></pre></div></div></div><p><strong>Step 2: Execute downgrade</strong></p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=el aria-controls=tabs-05-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=debian aria-controls=tabs-05-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum downgrade -y postgresql17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17=17.1*&#39;</span>
</span></span></code></pre></div></div></div><p><strong>Step 3: Restart cluster</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart --force &lt;cls&gt;
</span></span></code></pre></div><hr><h2 id=major-version-upgrade>Major Version Upgrade</h2><p>Major version upgrades (e.g., 17 → 18) involve data format changes, requiring specialized tools for data migration.</p><table class=full-width><thead><tr><th style=text-align:left>Method</th><th style=text-align:left>Downtime</th><th style=text-align:left>Complexity</th><th style=text-align:left>Use Case</th></tr></thead><tbody><tr><td style=text-align:left><a href=#logical-replication-migration><strong>Logical Replication Migration</strong></a></td><td style=text-align:left>Seconds (switch)</td><td style=text-align:left>High</td><td style=text-align:left>Production, minimal downtime required</td></tr><tr><td style=text-align:left><a href=#pg_upgrade-in-place-upgrade><strong>pg_upgrade In-Place Upgrade</strong></a></td><td style=text-align:left>Minutes~Hours</td><td style=text-align:left>Medium</td><td style=text-align:left>Test env, smaller data</td></tr></tbody></table><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>Recommended Approach</div><p>For production, we recommend <strong>logical replication migration</strong>: create new version cluster, sync data via logical replication, then blue-green switch. Shortest downtime and rollback-ready. See <a href=/docs/pgsql/migration><strong>Online Migration</strong></a>.</p></div><h3 id=logical-replication-migration>Logical Replication Migration</h3><p>Logical replication is the recommended approach for production major version upgrades. Core steps:</p><pre tabindex=0><code>1. Create new version target cluster → 2. Configure logical replication → 3. Verify data consistency
4. Switch app traffic to new cluster → 5. Decommission old cluster
</code></pre><p><strong>Step 1: Create new version cluster</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta-new</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-new</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># New version</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-meta-new
</span></span></code></pre></div><p><strong>Step 2: Configure logical replication</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Source cluster (old version) primary: create publication
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>PUBLICATION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_pub</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#000>TABLES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Target cluster (new version) primary: create subscription
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>SUBSCRIPTION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_sub</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;host=10.10.10.11 port=5432 dbname=mydb user=replicator password=xxx&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#000>PUBLICATION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_pub</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Step 3: Wait for sync completion</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Target cluster: check subscription status
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_subscription</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Source cluster: check replication slot LSN
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>slot_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>confirmed_flush_lsn</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_replication_slots</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Step 4: Switch traffic</strong></p><p>After confirming data sync complete: stop app writes to source → wait for final sync → switch app connections to new cluster → drop subscription, decommission source.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Target cluster: drop subscription
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>SUBSCRIPTION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_sub</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For detailed migration process, see <a href=/docs/pgsql/migration><strong>Online Migration</strong></a> documentation.</p><h3 id=pg_upgrade-in-place-upgrade>pg_upgrade In-Place Upgrade</h3><p><code>pg_upgrade</code> is PostgreSQL&rsquo;s official major version upgrade tool, suitable for test environments or scenarios accepting longer downtime.</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Important Warning</div><p>In-place upgrade causes longer downtime and is difficult to rollback. For production, prefer logical replication migration.</p></div><p><strong>Step 1: Install new version packages</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_pkg -e <span style=color:#000>pg_version</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>18</span>
</span></span></code></pre></div><p><strong>Step 2: Stop Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg pause &lt;cls&gt;                        <span style=color:#8f5902;font-style:italic># Pause auto-failover</span>
</span></span><span style=display:flex><span>systemctl stop patroni                <span style=color:#8f5902;font-style:italic># Stop Patroni (stops PostgreSQL)</span>
</span></span></code></pre></div><p><strong>Step 3: Run pg_upgrade</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres
</span></span><span style=display:flex><span>mkdir -p /data/postgres/pg-meta-18/data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pre-check (-c parameter: check only, don&#39;t execute)</span>
</span></span><span style=display:flex><span>/usr/pgsql-18/bin/pg_upgrade <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -b /usr/pgsql-17/bin -B /usr/pgsql-18/bin <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -d /data/postgres/pg-meta-17/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -D /data/postgres/pg-meta-18/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -v -c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Execute upgrade</span>
</span></span><span style=display:flex><span>/usr/pgsql-18/bin/pg_upgrade <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -b /usr/pgsql-17/bin -B /usr/pgsql-18/bin <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -d /data/postgres/pg-meta-17/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -D /data/postgres/pg-meta-18/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --link -j <span style=color:#0000cf;font-weight:700>8</span> -v
</span></span></code></pre></div><p><strong>Step 4: Update links and start</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf /usr/pgsql <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ln -s /usr/pgsql-18 /usr/pgsql
</span></span><span style=display:flex><span>rm -rf /pg <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ln -s /data/postgres/pg-meta-18 /pg
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Edit /etc/patroni/patroni.yml to update paths</span>
</span></span><span style=display:flex><span>systemctl start patroni
</span></span><span style=display:flex><span>pg resume &lt;cls&gt;
</span></span></code></pre></div><p><strong>Step 5: Post-processing</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/pgsql-18/bin/vacuumdb --all --analyze-in-stages
</span></span><span style=display:flex><span>./delete_old_cluster.sh   <span style=color:#8f5902;font-style:italic># Cleanup script generated by pg_upgrade</span>
</span></span></code></pre></div><hr><h2 id=extension-upgrade>Extension Upgrade</h2><p>When upgrading PostgreSQL version, typically also need to upgrade related extensions.</p><p><strong>Upgrade extension packages</strong></p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=el aria-controls=tabs-08-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=debian aria-controls=tabs-08-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgis36_17 timescaledb-2-postgresql-17* pgvector_17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17-postgis-3 postgresql-17-pgvector&#39;</span>
</span></span></code></pre></div></div></div><p><strong>Upgrade extension objects</strong></p><p>After package upgrade, execute extension upgrade in database:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View upgradeable extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Upgrade extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Check extension versions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Extension Compatibility</div><p>Before major version upgrade, confirm all extensions support target PostgreSQL version. Some extensions may require uninstall/reinstall - check extension documentation.</p></div><hr><h2 id=important-notes>Important Notes</h2><ol><li><strong>Backup first</strong>: Always perform complete backup before any upgrade</li><li><strong>Test verify</strong>: Verify upgrade process in test environment first</li><li><strong>Extension compatibility</strong>: Confirm all extensions support target version</li><li><strong>Rollback plan</strong>: Prepare rollback plan, especially for major upgrades</li><li><strong>Monitor closely</strong>: Monitor database performance and error logs after upgrade</li><li><strong>Document</strong>: Record all operations and issues during upgrade</li></ol><hr><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=/docs/pgsql/migration/><strong>Online Migration</strong></a>: Zero-downtime migration using logical replication</li><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni Management</strong></a>: Manage cluster with patronictl</li><li><a href=/docs/pgsql/admin/cluster/><strong>Cluster Management</strong></a>: Cluster creation, scaling, destruction</li><li><a href=/docs/pgsql/backup/><strong>Backup Recovery</strong></a>: PostgreSQL backup and recovery</li><li><a href=/docs/pgsql/admin/ext/><strong>Extension Management</strong></a>: Extension installation and management</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-efb2d1006e9f523db1ec2975456da71f>7 - Backup & Restore</h1><div class=lead>Point-in-Time Recovery (PITR) Backup and Restore</div><p>Pigsty uses <a href=https://pgbackrest.org/>pgBackRest</a> to manage PostgreSQL backups, arguably the most powerful open-source backup tool in the ecosystem.
It supports incremental/parallel backup and restore, encryption, <a href=/docs/minio>MinIO</a>/S3, and many other features. Pigsty configures backup functionality by default for each <a href=/docs/pgsql>PGSQL</a> cluster.</p><table><thead><tr><th>Section</th><th>Content</th></tr></thead><tbody><tr><td><a href=mechanism>Mechanism</a></td><td>Backup scripts, cron jobs, pgbackrest, repository and management</td></tr><tr><td><a href=policy>Policy</a></td><td>Backup strategy, disk planning, recovery window tradeoffs</td></tr><tr><td><a href=repository>Repository</a></td><td>Configuring backup repositories: local, MinIO, S3</td></tr><tr><td><a href=admin>Admin</a></td><td>Common backup management commands</td></tr><tr><td><a href=restore>Restore</a></td><td>Restore to a specific point in time using playbooks</td></tr><tr><td><a href=example>Example</a></td><td>Sandbox example: performing restore operations manually</td></tr></tbody></table><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Disclaimer</div><blockquote><p>Pigsty makes every effort to provide a reliable PITR solution, but we accept no responsibility for data loss resulting from PITR operations. Use at your own risk. If you need professional support, please consider our <a href=/docs/about/service>professional services</a>.</p></blockquote></div><hr><h2 id=quick-start>Quick Start</h2><ol><li><a href=mechanism>Backup Policy</a>: Schedule base backups using Crontab</li><li><a href=policy>WAL Archiving</a>: Continuously record write activity</li><li><a href=restore>Restore & Recovery</a>: Recover from backups and WAL archives</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;time&#34;: &#34;2025-07-13 10:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4c34e733cec9746048fccac02c01fd36>7.1 - Backup Policy</h1><div class=lead>Design backup policies according to your needs</div><ul><li><strong>When</strong>: Backup schedule</li><li><strong>Where</strong>: Backup repository</li><li><strong>How</strong>: Backup method</li></ul><hr><h2 id=when-to-backup>When to Backup</h2><p>The first question is <strong>when</strong> to backup your database - this is a tradeoff between backup frequency and recovery time.
Since you need to replay WAL logs from the last backup to the recovery target point, the more frequent the backups, the less WAL logs need to be replayed, and the faster the recovery.</p><h3 id=daily-full-backup>Daily Full Backup</h3><p>For production databases, it&rsquo;s recommended to start with the simplest daily full backup strategy.
This is also Pigsty&rsquo;s default backup strategy, implemented via <a href=mechanism#scheduled-backups>crontab</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method: local          # Choose backup repository method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>`local`, `minio`, or other custom repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Default pgbackrest repository using local POSIX filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Local backup directory, defaults to `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Keep 2, up to 3 full backups when using local filesystem repository</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When used with the default <code>local</code> local filesystem backup repository, this provides a 24~48 hour recovery window.</p><p><img src=/img/pigsty/pitr-scope.png alt=pitr-scope></p><p>Assuming your database size is 100GB and writes 10GB of data per day, the backup size is as follows:</p><p><img src=/img/pigsty/pitr-space.png alt=pitr-space></p><p>This will consume <code>2~3</code> times the database size in space, plus 2 days of WAL logs.
Therefore, in practice, you may need to prepare at least <code>3~5</code> times the database size for backup disk to use the default backup strategy.</p><h3 id=full--incremental-backup>Full + Incremental Backup</h3><p>You can optimize backup space usage by adjusting these parameters.</p><p>If using MinIO / S3 as a centralized backup repository, you can use storage space beyond local disk limitations.
In this case, consider using full + incremental backup with a 2-week retention policy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Full backup at 1 AM on Monday, incremental backups on weekdays</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Optional minio repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio is S3 compatible</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio endpoint domain, defaults to `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio region, defaults to us-east-1, meaningless for minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio bucket name, defaults to `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user access key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user secret for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio uses path-style URIs instead of host-style</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio backup path, defaults to `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio port, defaults to 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA certificate path, defaults to `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># Enable block-level incremental backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Bundle small files into a single file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle size limit, recommended 20MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle target size, recommended 128MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Enable AES encryption for remote backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, defaults to &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Keep full backups from the last 14 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When used with the built-in <code>minio</code> backup repository, this provides a guaranteed 1-week PITR recovery window.</p><p><img src=/img/pigsty/pitr-scope2.png alt=pitr-scope2></p><p>Assuming your database size is 100GB and writes 10GB of data per day, the backup size is as follows:</p><p><img src=/img/pigsty/pitr-space2.png alt=pitr-space2></p><hr><h2 id=backup-location>Backup Location</h2><p>By default, Pigsty provides two default backup repository definitions: <code>local</code> and <code>minio</code> backup repositories.</p><ul><li><code>local</code>: <strong>Default option</strong>, uses local <code>/pg/backup</code> directory (symlink to <a href=/docs/pgsql/param/#pg_fs_backup><code>pg_fs_backup</code></a>: <code>/data/backups</code>)</li><li><code>minio</code>: Uses SNSD single-node MinIO cluster (supported by Pigsty, but not enabled by default)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method: local          # Choose backup repository method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>`local`, `minio`, or other custom repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Default pgbackrest repository using local POSIX filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Local backup directory, defaults to `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Keep 2, up to 3 full backups when using local filesystem repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Optional minio repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio is S3 compatible</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio endpoint domain, defaults to `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio region, defaults to us-east-1, meaningless for minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio bucket name, defaults to `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user access key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user secret for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio uses path-style URIs instead of host-style</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio backup path, defaults to `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio port, defaults to 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA certificate path, defaults to `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># Enable block-level incremental backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Bundle small files into a single file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle size limit, recommended 20MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle target size, recommended 128MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Enable AES encryption for remote backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, defaults to &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Keep full backups from the last 14 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-931bd9f9bf4846ff58a1265e886414d1>7.2 - Backup Mechanism</h1><div class=lead>Backup scripts, cron jobs, backup repository and infrastructure</div><p>Backups can be invoked via built-in <a href=#scripts>scripts</a>, scheduled using node <a href=#scheduled-backups>crontab</a>,
managed by <a href=https://pgbackrest.org/>pgbackrest</a>, and stored in backup repositories,
which can be local disk filesystems or MinIO / S3, supporting different <a href=#retention-policy>retention</a> policies.</p><hr><h2 id=scripts>Scripts</h2><p>You can create backups using the <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a> user (defaults to <code>postgres</code>) to execute <code>pgbackrest</code> commands:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
Backup Commands</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
backup</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
full</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
diff</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
incr</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
info</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>full backup   <span style=color:#8f5902;font-style:italic># Create full backup for cluster pg-meta</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>full backup
</span></span><span style=display:flex><span>2025-07-15 01:36:57.007 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: --annotation<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>pg_cluster</span><span style=color:#ce5c00;font-weight:700>=</span>pg-meta ...
</span></span><span style=display:flex><span>2025-07-15 01:36:57.030 P00   INFO: execute non-exclusive backup start: backup begins after the requested immediate checkpoint completes
</span></span><span style=display:flex><span>2025-07-15 01:36:57.105 P00   INFO: backup start <span style=color:#000>archive</span> <span style=color:#ce5c00;font-weight:700>=</span> 000000010000000000000006, <span style=color:#000>lsn</span> <span style=color:#ce5c00;font-weight:700>=</span> 0/6000028
</span></span><span style=display:flex><span>2025-07-15 01:36:58.540 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F
</span></span><span style=display:flex><span>2025-07-15 01:36:58.588 P00   INFO: full backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 44.5MB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:36:58.589 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1584ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>diff backup
</span></span><span style=display:flex><span>2025-07-15 01:37:24.952 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-15 01:37:24.985 P00   INFO: last backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F, <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> 2.54.2
</span></span><span style=display:flex><span>2025-07-15 01:37:26.337 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013724D
</span></span><span style=display:flex><span>2025-07-15 01:37:26.381 P00   INFO: diff backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 424.3KB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:37:26.381 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1431ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>incr backup
</span></span><span style=display:flex><span>2025-07-15 01:37:30.305 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-15 01:37:30.337 P00   INFO: last backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013724D, <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> 2.54.2
</span></span><span style=display:flex><span>2025-07-15 01:37:31.356 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013730I
</span></span><span style=display:flex><span>2025-07-15 01:37:31.403 P00   INFO: incr backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 8.3KB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:37:31.403 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1099ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta info
</span></span><span style=display:flex><span>stanza: pg-meta
</span></span><span style=display:flex><span>    status: ok
</span></span><span style=display:flex><span>    cipher: aes-256-cbc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    db <span style=color:#ce5c00;font-weight:700>(</span>current<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        wal archive min/max <span style=color:#ce5c00;font-weight:700>(</span>17<span style=color:#ce5c00;font-weight:700>)</span>: 000000010000000000000001/00000001000000000000000A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        full backup: 20250715-013657F
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:36:57+00 / 2025-07-15 01:36:58+00
</span></span><span style=display:flex><span>            wal start/stop: <span style=color:#0000cf;font-weight:700>000000010000000000000006</span> / <span style=color:#0000cf;font-weight:700>000000010000000000000006</span>
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 44.5MB
</span></span><span style=display:flex><span>            repo1: backup size: 8.7MB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        diff backup: 20250715-013657F_20250715-013724D
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:37:24+00 / 2025-07-15 01:37:26+00
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 424.3KB
</span></span><span style=display:flex><span>            repo1: backup size: 94KB
</span></span><span style=display:flex><span>            backup reference total: <span style=color:#0000cf;font-weight:700>1</span> full
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        incr backup: 20250715-013657F_20250715-013730I
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:37:30+00 / 2025-07-15 01:37:31+00
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 8.3KB
</span></span><span style=display:flex><span>            repo1: backup size: 504B
</span></span><span style=display:flex><span>            backup reference total: <span style=color:#0000cf;font-weight:700>1</span> full, <span style=color:#0000cf;font-weight:700>1</span> diff</span></span></code></pre></div></div></div><p>Here the <code>stanza</code> is the database cluster name: <a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a>, which is <code>pg-meta</code> in the default configuration.</p><p>Pigsty provides the <code>pb</code> alias and <code>pg-backup</code> wrapper script, which automatically fills in the current cluster name as the stanza:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pb<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>stanza</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>grep -o <span style=color:#4e9a06>&#39;\[[^][]*]&#39;</span> /etc/pgbackrest/pgbackrest.conf <span style=color:#000;font-weight:700>|</span> head -n1 <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/.*\[\([^]]*\)].*/\1/&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$stanza</span> <span style=color:#000>$@</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>pb ...    <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta ...</span>
</span></span><span style=display:flex><span>pb info   <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta info</span>
</span></span><span style=display:flex><span>pb backup <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta backup</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># Perform full backup         = pgbackrest --stanza=pg-meta --type=full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># Perform incremental backup  = pgbackrest --stanza=pg-meta --type=incr backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># Perform differential backup = pgbackrest --stanza=pg-meta --type=diff backup</span>
</span></span></code></pre></div><hr><h2 id=scheduled-backups>Scheduled Backups</h2><p>Pigsty uses Linux crontab to schedule backup tasks. You can use it to define backup policies.</p><p>For example, most single-node configuration templates have the following <a href=/docs/node/param#node_crontab><code>node_crontab</code></a> for backups:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can design more complex backup strategies using crontab and the <code>pg-backup</code> script, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Full backup at 1 AM on Monday, incremental backups on weekdays</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To apply crontab changes, use <a href=/docs/node/playbook/#nodeyml><code>node.yml</code></a> to update crontab on all nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_crontab -l pg-meta    <span style=color:#8f5902;font-style:italic># Apply crontab changes to pg-meta group</span>
</span></span></code></pre></div><hr><h2 id=pgbackrest>pgbackrest</h2><p>Here are the configuration details for pgbackrest in Pigsty:</p><ul><li>pgbackrest backup tool is enabled and configured by default (<a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a>)</li><li>Installed in the <code>pg_install</code> task of the <a href=/docs/pgsql/playbook/#pgsqlyml><code>pgsql.yml</code></a> playbook, defined in <a href=/docs/pgsql/param/#pg_packages><code>pg_packages</code></a></li><li>Configured in the <code>pg_backup</code> task of the <a href=/docs/pgsql/playbook/#pgsqlyml><code>pgsql.yml</code></a> playbook, see <a href=/docs/pgsql/param/#pg_backup>Parameters: PG_BACKUP</a></li><li>Backup repository initialized in the <code>pgbackrest_init</code> task, which will fail if the repository already exists (error can be ignored)</li><li>Initial backup created in the <code>pgbackrest_backup</code> task, controlled by <a href=/docs/pgsql/param/#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a></li></ul><h3 id=file-hierarchy>File Hierarchy</h3><ul><li>bin: <code>/usr/bin/pgbackrest</code>, from PGDG&rsquo;s <code>pgbackrest</code> package, in group alias <code>pgsql-common</code>.</li><li>conf: <code>/etc/pgbackrest</code>, main configuration file is <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pgbackrest.conf><code>/etc/pgbackrest/pgbackrest.conf</code></a>.</li><li>logs: <code>/pg/log/pgbackrest/*</code>, controlled by <a href=/docs/pgsql/param/#pgbackrest_log_dir><code>pgbackrest_log_dir</code></a></li><li>tmp: <code>/pg/spool</code> used as temporary spool directory for pgbackrest</li><li>data: <code>/pg/backup</code> used to store data (when using the default <code>local</code> filesystem backup repository)</li></ul><p>Additionally, during <a href=/docs/pgsql/backup/restore>PITR recovery</a>, Pigsty creates a temporary <code>/pg/conf/pitr.conf</code> pgbackrest configuration file,
and writes postgres recovery logs to the <code>/pg/tmp/recovery.log</code> file.</p><h3 id=monitoring>Monitoring</h3><p>There is a <code>pgbackrest_exporter</code> service running on <a href=/docs/pgsql/param/#pgbackrest_exporter_port><code>pgbackrest_exporter_port</code></a> (<code>9854</code>) port for exporting pgbackrest metrics.
You can customize it via <a href=/docs/pgsql/param/#pgbackrest_exporter_options><code>pgbackrest_exporter_options</code></a>,
or set <a href=/docs/pgsql/param/#pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></a> to <code>false</code> to disable it.</p><h3 id=initial-backup>Initial Backup</h3><p>When creating a postgres cluster, Pigsty automatically creates an initial backup.
Since the new cluster is almost empty, this is a very small backup.
It leaves a <code>/etc/pgbackrest/initial.done</code> marker file to avoid recreating the initial backup.
If you don&rsquo;t want an initial backup, set <a href=/docs/pgsql/param/#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a> to <code>false</code>.</p><hr><h2 id=management>Management</h2><h3 id=enable-backup>Enable Backup</h3><p>If <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> is set to <code>true</code> when the database cluster is created, backups will be automatically enabled.</p><p>If this value was <code>false</code> at creation time, you can enable the pgbackrest component with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># Run pgbackrest subtask</span>
</span></span></code></pre></div><h3 id=remove-backup>Remove Backup</h3><p>When removing the primary instance (<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>), Pigsty will delete the pgbackrest backup stanza.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># Keep backups</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># Remove backups only</span>
</span></span></code></pre></div><p>Use the <code>pg_backup</code> subtask to remove backups only, and the <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> parameter (set to <code>false</code>) to preserve backups.</p><p>If your backup repository is <strong>locked</strong> (e.g., S3 / MinIO has locking options), this operation will fail.</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Backup Deletion</div><p>Deleting backups may result in permanent data loss. This is a dangerous operation, please proceed with caution.</p></div><h3 id=list-backups>List Backups</h3><p>This command will list all backups in the pgbackrest repository (shared across all clusters)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><h3 id=manual-backup>Manual Backup</h3><p>Pigsty provides a built-in script <code>/pg/bin/pg-backup</code> that wraps the <code>pgbackrest</code> backup command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># Perform full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># Perform differential backup</span>
</span></span></code></pre></div><h3 id=base-backup>Base Backup</h3><p>Pigsty provides an alternative backup script <code>/pg/bin/pg-basebackup</code> that does not depend on <code>pgbackrest</code> and directly provides a physical copy of the database cluster.
The default backup directory is <code>/pg/backup</code>.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     Backup <span style=color:#204a87>source</span> URL, optional, defaults to <span style=color:#4e9a06>&#34;postgres:///&#34;</span>, password should be provided in url, ENV, or .pgpass <span style=color:#204a87;font-weight:700>if</span> required
</span></span><span style=display:flex><span>-d, --dst, --dir     Location to store backup file, defaults to <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           Override default backup filename, <span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         Remove .lz4 files older than n minutes, defaults to <span style=color:#0000cf;font-weight:700>1200</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span> hours<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-t, --tag            Backup file tag, uses target cluster name or <span style=color:#204a87>local</span> IP address <span style=color:#204a87;font-weight:700>if</span> not set, also used <span style=color:#204a87;font-weight:700>for</span> default filename
</span></span><span style=display:flex><span>-k, --key            Encryption key when --encrypt is specified, defaults to <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         Upload backup file to cloud storage <span style=color:#ce5c00;font-weight:700>(</span>needs to be implemented by yourself<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-e, --encryption     Use OpenSSL RC4 encryption, uses tag as key <span style=color:#204a87;font-weight:700>if</span> not specified
</span></span><span style=display:flex><span>-h, --help           Print this <span style=color:#204a87>help</span> information</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>The backup uses <code>lz4</code> compression. You can decompress and extract the tarball with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># Extract backup to this directory</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><h3 id=logical-backup>Logical Backup</h3><p>You can also perform logical backups using the <code>pg_dump</code> command.</p><p>Logical backups cannot be used for PITR (Point-in-Time Recovery), but are very useful for migrating data between different major versions or implementing flexible data export logic.</p><h3 id=bootstrap-from-repository>Bootstrap from Repository</h3><p>Suppose you have an existing cluster <code>pg-meta</code> and want to <strong>clone</strong> it as <code>pg-meta2</code>:</p><p>You need to create a new <code>pg-meta2</code> cluster branch and then run <code>pitr</code> on it.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e2aad9fad6e8fd1fba46059ad4ea7613>7.3 - Backup Repository</h1><div class=lead>PostgreSQL backup storage repository configuration</div><p>You can configure the backup <strong>storage location</strong> by specifying the <a href=/docs/pgsql/param/#pgbackrest_repo><code>pgbackrest_repo</code></a> parameter.
You can define multiple repositories here, and Pigsty will choose which one to use based on the value of <a href=/docs/pgsql/param/#pgbackrest_method><code>pgbackrest_method</code></a>.</p><h2 id=default-repositories>Default Repositories</h2><p>By default, Pigsty provides two default backup repository definitions: <code>local</code> and <code>minio</code> backup repositories.</p><ul><li><code>local</code>: <strong>Default option</strong>, uses local <code>/pg/backup</code> directory (symlink to <a href=/docs/pgsql/param/#pg_fs_backup><code>pg_fs_backup</code></a>: <code>/data/backups</code>)</li><li><code>minio</code>: Uses SNSD single-node MinIO cluster (supported by Pigsty, but not enabled by default)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method: local          # Choose backup repository method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>`local`, `minio`, or other custom repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Default pgbackrest repository using local POSIX filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Local backup directory, defaults to `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Keep 2, up to 3 full backups when using local filesystem repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Optional minio repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio is S3 compatible</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio endpoint domain, defaults to `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio region, defaults to us-east-1, meaningless for minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio bucket name, defaults to `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user access key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user secret for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio uses path-style URIs instead of host-style</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio backup path, defaults to `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio port, defaults to 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA certificate path, defaults to `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># Enable block-level incremental backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Bundle small files into a single file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle size limit, recommended 20MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle target size, recommended 128MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Enable AES encryption for remote backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, defaults to &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Keep full backups from the last 14 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=repository-retention-policy>Repository Retention Policy</h2><p>If you backup daily but don&rsquo;t delete old backups, the backup repository will grow indefinitely and exhaust disk space.
You need to define a retention policy to keep only a limited number of backups.</p><p>The default backup policy is defined in the <a href=/docs/pgsql/param/#pgbackrest_repo><code>pgbackrest_repo</code></a> parameter and can be adjusted as needed.</p><ul><li><code>local</code>: Keep the latest <strong>2</strong> full backups, allowing up to 3 during backup</li><li><code>minio</code>: Keep all full backups from the last <strong>14</strong> days</li></ul><hr><h2 id=space-planning>Space Planning</h2><p>Object storage provides almost unlimited storage capacity, so there&rsquo;s no need to worry about disk space.
You can use a hybrid full + differential backup strategy to optimize space usage.</p><p>For local disk backup repositories, Pigsty recommends using a policy that keeps the latest <strong>2</strong> full backups,
meaning the disk will retain the two most recent full backups (there may be a third copy while running a new backup).</p><p>This guarantees at least a 24-hour recovery window. See <a href=policy>Backup Policy</a> for details.</p><hr><h2 id=other-repository-options>Other Repository Options</h2><p>You can also use other services as backup repositories, refer to the <a href=https://pgbackrest.org/user-guide.html>pgbackrest documentation</a> for details:</p><ul><li><a href=https://pgbackrest.org/user-guide.html#s3-support>S3 Compatible Object Storage</a></li><li><a href=https://pgbackrest.org/user-guide.html#azure-support>Azure Compatible Object Storage</a></li><li><a href=https://pgbackrest.org/user-guide.html#gcs-support>GCS Compatible Object Storage</a></li><li><a href=https://pgbackrest.org/user-guide.html#sftp-support>SFTP Support</a></li></ul><hr><h2 id=repository-versioning>Repository Versioning</h2><p>You can even specify <a href=https://pgbackrest.org/user-guide.html#sftp-support#repo-target-time>repo target time</a> to get snapshots of object storage.</p><p>You can enable MinIO versioning by adding the <code>versioning</code> flag in <a href=/docs/minio/param#minio_buckets><code>minio_buckets</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_buckets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgsql ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta  ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>data }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=repository-locking>Repository Locking</h2><p>Some object storage services (S3, MinIO, etc.) support <strong>locking</strong> functionality, which can prevent backups from being deleted, even by the DBA.</p><ul><li><a href=https://min.io/docs/minio/linux/administration/object-management/object-retention.html>MinIO Object Locking</a></li><li><a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html>AWS S3: Locking Objects with Object Lock</a></li></ul><p>You can enable MinIO locking by adding the <code>lock</code> flag in <a href=/docs/minio/param#minio_buckets><code>minio_buckets</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_buckets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgsql , lock</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>data }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=using-object-storage>Using Object Storage</h2><p>Object storage services provide almost unlimited storage capacity and provide remote disaster recovery capability for your system.
If you don&rsquo;t have an object storage service, Pigsty has built-in <a href=/docs/minio>MinIO</a> support.</p><h3 id=minio>MinIO</h3><p>You can enable the MinIO backup repository by uncommenting the following settings.
Note that pgbackrest only supports HTTPS / domain names, so you must run MinIO with domain names and HTTPS endpoints.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use minio as default backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># Define a single-node minio SNSD cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq: 1 }} ,vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio }}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=s3>S3</h3><p>If you only have <strong>one</strong> node, a meaningful backup strategy would be to use cloud provider object storage services like AWS S3, Alibaba Cloud OSS, or Google Cloud, etc.
To do this, you can define a new repository:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use &#39;pgbackrest_repo.s3&#39; as backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>s3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># Alibaba Cloud OSS (S3 compatible) object storage service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># oss is S3 compatible</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oss-cn-beijing-internal.aliyuncs.com</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oss-cn-beijing</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_bucket_name&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_access_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_secret_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Bundle small files into a single file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle size limit, recommended 20MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle target size, recommended 128MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Enable AES encryption for remote backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, defaults to &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Keep full backups from the last 14 days</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Default pgbackrest repository using local POSIX filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Local backup directory, defaults to `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Keep 2, up to 3 full backups when using local filesystem repository</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=managing-backups>Managing Backups</h2><h3 id=enable-backup>Enable Backup</h3><p>If <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> is set to <code>true</code> when the database cluster is created, backups will be automatically enabled.</p><p>If this value was <code>false</code> at creation time, you can enable the pgbackrest component with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># Run pgbackrest subtask</span>
</span></span></code></pre></div><h3 id=remove-backup>Remove Backup</h3><p>When removing the primary instance (<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>), Pigsty will delete the pgbackrest backup stanza.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># Keep backups</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># Remove backups only</span>
</span></span></code></pre></div><p>Use the <code>pg_backup</code> subtask to remove backups only, and the <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> parameter (set to <code>false</code>) to preserve backups.</p><p>If your backup repository is <strong>locked</strong> (e.g., S3 / MinIO has locking options), this operation will fail.</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Backup Deletion</div><p>Deleting backups may result in permanent data loss. This is a dangerous operation, please proceed with caution.</p></div><h3 id=list-backups>List Backups</h3><p>This command will list all backups in the pgbackrest repository (shared across all clusters)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><h3 id=manual-backup>Manual Backup</h3><p>Pigsty provides a built-in script <code>/pg/bin/pg-backup</code> that wraps the <code>pgbackrest</code> backup command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># Perform full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># Perform differential backup</span>
</span></span></code></pre></div><h3 id=base-backup>Base Backup</h3><p>Pigsty provides an alternative backup script <code>/pg/bin/pg-basebackup</code> that does not depend on <code>pgbackrest</code> and directly provides a physical copy of the database cluster.
The default backup directory is <code>/pg/backup</code>.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     Backup <span style=color:#204a87>source</span> URL, optional, defaults to <span style=color:#4e9a06>&#34;postgres:///&#34;</span>, password should be provided in url, ENV, or .pgpass <span style=color:#204a87;font-weight:700>if</span> required
</span></span><span style=display:flex><span>-d, --dst, --dir     Location to store backup file, defaults to <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           Override default backup filename, <span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         Remove .lz4 files older than n minutes, defaults to <span style=color:#0000cf;font-weight:700>1200</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span> hours<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-t, --tag            Backup file tag, uses target cluster name or <span style=color:#204a87>local</span> IP address <span style=color:#204a87;font-weight:700>if</span> not set, also used <span style=color:#204a87;font-weight:700>for</span> default filename
</span></span><span style=display:flex><span>-k, --key            Encryption key when --encrypt is specified, defaults to <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         Upload backup file to cloud storage <span style=color:#ce5c00;font-weight:700>(</span>needs to be implemented by yourself<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-e, --encryption     Use OpenSSL RC4 encryption, uses tag as key <span style=color:#204a87;font-weight:700>if</span> not specified
</span></span><span style=display:flex><span>-h, --help           Print this <span style=color:#204a87>help</span> information</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>The backup uses <code>lz4</code> compression. You can decompress and extract the tarball with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># Extract backup to this directory</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><h3 id=logical-backup>Logical Backup</h3><p>You can also perform logical backups using the <code>pg_dump</code> command.</p><p>Logical backups cannot be used for PITR (Point-in-Time Recovery), but are very useful for migrating data between different major versions or implementing flexible data export logic.</p><h3 id=bootstrap-from-repository>Bootstrap from Repository</h3><p>Suppose you have an existing cluster <code>pg-meta</code> and want to <strong>clone</strong> it as <code>pg-meta2</code>:</p><p>You need to create a new <code>pg-meta2</code> cluster branch and then run <code>pitr</code> on it.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bd9fc4fbfbb9e33698d751afa14c6077>7.4 - Admin Commands</h1><div class=lead>Managing backup repositories and backups</div><h2 id=enable-backup>Enable Backup</h2><p>If <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> is set to <code>true</code> when the database cluster is created, backups will be automatically enabled.</p><p>If this value was <code>false</code> at creation time, you can enable the pgbackrest component with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># Run pgbackrest subtask</span>
</span></span></code></pre></div><hr><h2 id=remove-backup>Remove Backup</h2><p>When removing the primary instance (<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>), Pigsty will delete the pgbackrest backup stanza.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># Keep backups</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># Remove backups only</span>
</span></span></code></pre></div><p>Use the <code>pg_backup</code> subtask to remove backups only, and the <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> parameter (set to <code>false</code>) to preserve backups.</p><p>If your backup repository is <strong>locked</strong> (e.g., S3 / MinIO has locking options), this operation will fail.</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Backup Deletion</div><p>Deleting backups may result in permanent data loss. This is a dangerous operation, please proceed with caution.</p></div><hr><h2 id=list-backups>List Backups</h2><p>This command will list all backups in the pgbackrest repository (shared across all clusters)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><hr><h2 id=manual-backup>Manual Backup</h2><p>Pigsty provides a built-in script <code>/pg/bin/pg-backup</code> that wraps the <code>pgbackrest</code> backup command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># Perform full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># Perform differential backup</span>
</span></span></code></pre></div><hr><h2 id=base-backup>Base Backup</h2><p>Pigsty provides an alternative backup script <code>/pg/bin/pg-basebackup</code> that does not depend on <code>pgbackrest</code> and directly provides a physical copy of the database cluster.
The default backup directory is <code>/pg/backup</code>.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     Backup <span style=color:#204a87>source</span> URL, optional, defaults to <span style=color:#4e9a06>&#34;postgres:///&#34;</span>, password should be provided in url, ENV, or .pgpass <span style=color:#204a87;font-weight:700>if</span> required
</span></span><span style=display:flex><span>-d, --dst, --dir     Location to store backup file, defaults to <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           Override default backup filename, <span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         Remove .lz4 files older than n minutes, defaults to <span style=color:#0000cf;font-weight:700>1200</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span> hours<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-t, --tag            Backup file tag, uses target cluster name or <span style=color:#204a87>local</span> IP address <span style=color:#204a87;font-weight:700>if</span> not set, also used <span style=color:#204a87;font-weight:700>for</span> default filename
</span></span><span style=display:flex><span>-k, --key            Encryption key when --encrypt is specified, defaults to <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         Upload backup file to cloud storage <span style=color:#ce5c00;font-weight:700>(</span>needs to be implemented by yourself<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-e, --encryption     Use OpenSSL RC4 encryption, uses tag as key <span style=color:#204a87;font-weight:700>if</span> not specified
</span></span><span style=display:flex><span>-h, --help           Print this <span style=color:#204a87>help</span> information</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>The backup uses <code>lz4</code> compression. You can decompress and extract the tarball with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># Extract backup to this directory</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><hr><h2 id=logical-backup>Logical Backup</h2><p>You can also perform logical backups using the <code>pg_dump</code> command.</p><p>Logical backups cannot be used for PITR (Point-in-Time Recovery), but are very useful for migrating data between different major versions or implementing flexible data export logic.</p><hr><h2 id=bootstrap-from-repository>Bootstrap from Repository</h2><p>Suppose you have an existing cluster <code>pg-meta</code> and want to <strong>clone</strong> it as <code>pg-meta2</code>:</p><p>You need to create a new <code>pg-meta2</code> cluster branch and then run <code>pitr</code> on it.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ee98f0d297c9a6847c501efbbbed8fa6>7.5 - Restore Operations</h1><div class=lead>Restore PostgreSQL from backups</div><p>You can perform Point-in-Time Recovery (PITR) in Pigsty using pre-configured pgbackrest.</p><ul><li><a href=#manual-approach><strong>Manual Approach</strong></a>: Manually execute PITR using <code>pg-pitr</code> prompt scripts, more flexible but more complex.</li><li><a href=#playbook-approach><strong>Playbook Approach</strong></a>: Automatically execute PITR using <code>pgsql-pitr.yml</code> playbook, highly automated but less flexible and error-prone.</li></ul><p>If you are very familiar with the configuration, you can use the fully automated playbook, otherwise manual step-by-step operation is recommended.</p><hr><h2 id=quick-start>Quick Start</h2><p>If you want to roll back the <code>pg-meta</code> cluster to a previous point in time, add the <code>pg_pitr</code> parameter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-07-13 10:00:00+00&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Recover from latest backup</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Then run the <code>pgsql-pitr.yml</code> playbook, which will roll back the <code>pg-meta</code> cluster to the specified point in time.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta
</span></span></code></pre></div><hr><h2 id=post-recovery>Post-Recovery</h2><p>The recovered cluster will have <code>archive_mode</code> <strong>disabled</strong> to prevent accidental WAL writes.
If the recovered database state is normal, you can enable <code>archive_mode</code> and perform a full backup.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode; SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>pg-backup full    <span style=color:#8f5902;font-style:italic># Perform new full backup</span>
</span></span></code></pre></div><hr><h2 id=recovery-target>Recovery Target</h2><p>You can specify different types of recovery targets in <code>pg_pitr</code>, but they are mutually exclusive:</p><ul><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TIME><code>time</code></a>: To which point in time to recover?</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-NAME><code>name</code></a>: Recover to a named restore point (created by <code>pg_create_restore_point</code>)</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-XID><code>xid</code></a>: Recover to a specific transaction ID (TXID/XID)</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-LSN><code>lsn</code></a>: Recover to a specific LSN (Log Sequence Number) point</li></ul><p>If any of the above parameters are specified, the recovery <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TYPE><code>type</code></a> will be set accordingly,
otherwise it will be set to <code>latest</code> (end of WAL archive stream).
The special <code>immediate</code> type can be used to instruct pgbackrest to minimize recovery time by stopping at the first consistent point.</p><h3 id=target-types>Target Types</h3><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
Recovery Target Types</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
latest</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
time</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
lsn</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
xid</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
name</button></li><li class=nav-item><button class=nav-link id=tabs-00-06-tab data-bs-toggle=tab data-bs-target=#tabs-00-06 role=tab aria-controls=tabs-00-06 aria-selected=false>
immediate</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Recover to latest state (end of WAL archive stream)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-07-13 10:00:00+00&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;0/4001C80&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;250000&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-06 role=tabpanel aria-labelled-by=tabs-00-06-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;immediate&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div></div><h3 id=recover-by-time>Recover by Time</h3><p>The most commonly used target is a point in time; you can specify the time point to recover to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;time&#34;: &#34;2025-07-13 10:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div><p>Time should be in valid PostgreSQL <a href=https://www.postgresql.org/docs/17/datatype-datetime.html#DATATYPE-DATETIME-INPUT-TIME-STAMPS><code>TIMESTAMP</code></a> format, <code>YYYY-MM-DD HH:MM:SS+TZ</code> is recommended.</p><h3 id=recover-by-name>Recover by Name</h3><p>You can create named restore points using <a href=https://www.postgresql.org/docs/current/functions-admin.html#id-1.5.8.34.5.5.2.2.1.1.1.1><code>pg_create_restore_point</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_create_restore_point</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;shit_incoming&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Then use that named restore point in PITR:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;name&#34;: &#34;shit_incoming&#34; }}&#39;</span>
</span></span></code></pre></div><h3 id=recover-by-xid>Recover by XID</h3><p>If you have a transaction that accidentally deleted some data, the best way to recover is to restore the database to the state before that transaction.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;xid&#34;: &#34;250000&#34;, exclusive: true }}&#39;</span>
</span></span></code></pre></div><p>You can find the exact transaction ID from monitoring dashboards or from the <code>TXID</code> field in CSVLOG.</p><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>Inclusive vs Exclusive</div><p>Target parameters are &ldquo;inclusive&rdquo; by default, meaning recovery will include the target point.
The <code>exclusive</code> flag will exclude that exact target, e.g., xid 24999 will be the last transaction replayed.</p><p>This only applies to <code>time</code>, <code>xid</code>, <code>lsn</code> recovery targets, see <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-INCLUSIVE><code>recovery_target_inclusive</code></a> for details.</p></div><h3 id=recover-by-lsn>Recover by LSN</h3><p>PostgreSQL uses <a href=https://www.postgresql.org/docs/current/datatype-pg-lsn.html>LSN</a> (Log Sequence Number) to identify the location of WAL records.
You can find it in many places, such as the PG LSN panel in Pigsty dashboards.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;lsn&#34;: &#34;0/4001C80&#34;, timeline: &#34;1&#34; }}&#39;</span>
</span></span></code></pre></div><p>To recover to an exact position in the WAL stream, you can also specify the <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TIMELINE><code>timeline</code></a> parameter (defaults to <code>latest</code>)</p><hr><h2 id=recovery-source>Recovery Source</h2><ul><li><code>cluster</code>: From which cluster to recover? Defaults to current <code>pg_cluster</code>, you can use any other cluster in the same pgbackrest repository</li><li><code>repo</code>: Override backup repository, uses same format as <code>pgbackrest_repo</code></li><li><code>set</code>: Defaults to <code>latest</code> backup set, but you can specify a specific pgbackrest backup by label</li></ul><p>Pigsty will recover from the pgbackrest backup repository. If you use a centralized backup repository (like MinIO/S3),
you can specify another &ldquo;stanza&rdquo; (another cluster&rsquo;s backup directory) as the recovery source.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Recover from pg-meta cluster backup</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The above configuration will mark the PITR process to use the <code>pg-meta</code> stanza.
You can also pass the <code>pg_pitr</code> parameter via CLI arguments:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34; }}&#39;</span>
</span></span></code></pre></div><p>You can also use these targets when PITR from another cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-07-14 08:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div><hr><h2 id=step-by-step-execution>Step-by-Step Execution</h2><p>This approach is semi-automatic, you will participate in the PITR process to make critical decisions.</p><p>For example, this configuration will restore the <code>pg-meta</code> cluster itself to the specified point in time:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-07-13 10:00:00+00&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Recover from latest backup</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Let&rsquo;s execute step by step:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t down     <span style=color:#8f5902;font-style:italic># Pause patroni high availability</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t pitr     <span style=color:#8f5902;font-style:italic># Run pitr process</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t up       <span style=color:#8f5902;font-style:italic># Generate pgbackrest config and recovery script</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># down                 : # Stop high availability and shutdown patroni and postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pause            : # Pause patroni auto-failover</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - stop             : # Stop patroni and postgres services</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_patroni   : # Stop patroni service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_postgres  : # Stop postgres service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pitr                 : # Perform PITR process</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - config           : # Generate pgbackrest config and recovery script</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - restore          : # Run pgbackrest restore command</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - recovery         : # Start postgres and complete recovery</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - verify           : # Verify recovered cluster control data</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># up:                  : # Start postgres / patroni and restore high availability</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - etcd             : # Clean etcd metadata before starting</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - start            : # Start patroni and postgres services</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_postgres : # Start postgres service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_patroni  : # Start patroni service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - resume           : # Resume patroni auto-failover</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=pitr-parameter-definition>PITR Parameter Definition</h2><p>The <code>pg_pitr</code> parameter has more options available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># Define PITR task</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_pg_cls_name&#34;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Source cluster name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type: latest                   # Recovery target type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time, xid, name, lsn, immediate, latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-01 10:00:00+00&#34;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Recovery target: time, mutually exclusive with xid, name, lsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># Recovery target: named restore point, mutually exclusive with time, xid, lsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;100000&#34;</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Recovery target: transaction ID, mutually exclusive with time, name, lsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;0/3000000&#34;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Recovery target: log sequence number, mutually exclusive with time, name, xid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>timeline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latest              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Target timeline, can be integer, defaults to latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>exclusive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Whether to exclude target point, defaults to false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>action: pause                  # Post-recovery action</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pause, promote, shutdown</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>archive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Whether to keep archive settings? Defaults to false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db_exclude</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>template0, template1 ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db_include</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>link_map</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_wal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/wal&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_xact</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/pg_xact&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>process</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Number of parallel recovery processes</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># Recovery source repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/data                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Data recovery location</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Listening port for recovered instance</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f811d9356784e47cdedcf860a7ba394a>7.6 - Clone PG Cluster</h1><div class=lead>How to use PITR to create a new PostgreSQL cluster and restore to a specified point in time?</div><h2 id=quick-start>Quick Start</h2><ul><li>Create an online replica of an existing cluster using Standby Cluster</li><li>Create a point-in-time snapshot of an existing cluster using PITR</li><li>Perform post-PITR cleanup to ensure the new cluster&rsquo;s backup process works properly</li></ul><p>You can use the PG PITR mechanism to clone an entire database cluster.</p><h2 id=reset-a-clusters-state>Reset a Cluster&rsquo;s State</h2><p>You can also consider creating a brand new empty cluster, then use PITR to reset it to a specific state of the <code>pg-meta</code> cluster.</p><p>Using this technique, you can clone any point-in-time (within backup retention period) state of the existing cluster <code>pg-meta</code> to a new cluster.</p><p>Using the Pigsty 4-node sandbox environment as an example, use the following command to reset the <code>pg-test</code> cluster to the latest state of the <code>pg-meta</code> cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34; }}&#39;</span>
</span></span></code></pre></div><h2 id=post-pitr-cleanup>Post-PITR Cleanup</h2><p>When you restore a cluster using PITR, the new cluster&rsquo;s PITR functionality is disabled. This is because if it also tries to generate backups and archive WAL, it could dirty the backup repository of the previous cluster.</p><p>Therefore, after confirming that the state of this PITR-restored new cluster meets expectations, you need to perform the following cleanup:</p><ul><li>Upgrade the backup repository Stanza to accept new backups from different clusters (only when restoring from another cluster)</li><li>Enable <code>archive_mode</code> to allow the new cluster to archive WAL logs (requires cluster restart)</li><li>Perform a new full backup to ensure the new cluster&rsquo;s data is included (optional, can also wait for crontab scheduled execution)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pb stanza-upgrade
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode;&#39;</span>
</span></span><span style=display:flex><span>pg-backup full
</span></span></code></pre></div><p>Through these operations, your new cluster will have its own backup history starting from the first full backup. If you skip these steps, the new cluster&rsquo;s backups will not work, and WAL archiving will not take effect, meaning you cannot perform any backup or PITR operations on the new cluster.</p><h2 id=consequences-of-not-cleaning-up>Consequences of Not Cleaning Up</h2><p>Suppose you performed PITR recovery on the <code>pg-test</code> cluster using data from another cluster <code>pg-meta</code>, but did not perform cleanup.</p><p>Then at the next routine backup, you will see the following error:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-test-1:~$ pb backup
</span></span><span style=display:flex><span>2025-12-27 10:20:29.336 P00   INFO: backup <span style=color:#204a87>command</span> begin...
</span></span><span style=display:flex><span>2025-12-27 10:20:29.357 P00  ERROR: <span style=color:#ce5c00;font-weight:700>[</span>051<span style=color:#ce5c00;font-weight:700>]</span>: PostgreSQL version 18, system-id <span style=color:#0000cf;font-weight:700>7588470953413201282</span> <span style=color:#204a87;font-weight:700>do</span> not match stanza version 18, system-id <span style=color:#0000cf;font-weight:700>7588470974940466058</span>
</span></span><span style=display:flex><span>                                    HINT: is this the correct stanza?
</span></span></code></pre></div><h2 id=clone-a-new-cluster>Clone a New Cluster</h2><p>For example, suppose you have a cluster <code>pg-meta</code>, and now you want to clone a new cluster <code>pg-meta2</code> from <code>pg-meta</code>.</p><p>You can consider using the <a href=/docs/pgsql/config/cluster#standby_cluster><strong>Standby Cluster</strong></a> method to create a new cluster <code>pg-meta2</code>.</p><p>pgBackrest supports incremental backup/restore, so if you have already pulled <code>pg-meta</code>&rsquo;s data through physical replication, the incremental PITR restore is usually very fast.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pb stop --force
</span></span><span style=display:flex><span>pb stanza-delete --force
</span></span><span style=display:flex><span>pb start
</span></span><span style=display:flex><span>pb stanza-create
</span></span></code></pre></div><p>If you want to reset the <code>pg-test</code> cluster to the state of <code>pg-meta</code> cluster at 15:30 on December 26, 2025, you can use the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-12-27 17:50:00+08&#34; ,archive: true }}&#39;</span>
</span></span></code></pre></div><p>Using this technique, you can not only clone the latest state of the <code>pg-meta</code> cluster, but also clone to any point in time.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-57c909cac5de1f311ae32e0421e66ee7>7.7 - Clone Database</h1><div class=lead>How to clone an existing database within a PostgreSQL cluster using instant XFS cloning</div><h2 id=clone-database>Clone Database</h2><p>You can copy a PostgreSQL database through the template mechanism, but no active connections to the template database are allowed during this period.</p><p>If you want to clone the <code>postgres</code> database, you must execute the following two statements at the same time. Ensure all connections to the <code>postgres</code> database are cleaned up before executing Clone:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_terminate_backend</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgcopy</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TEMPLATE</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8> </span><span style=color:#000>STRATEGY</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=instant-clone>Instant Clone</h3><p>If you are using PostgreSQL 18 or higher, Pigsty sets <a href=https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-FILE-COPY-METHOD><code>file_copy_method</code></a> by default. This parameter allows you to clone a database in O(1) (~200ms) time complexity without copying data files.</p><p>However, you must explicitly use the <a href=https://www.postgresql.org/docs/current/sql-createdatabase.html#CREATE-DATABASE-STRATEGY><code>FILE_COPY</code></a> strategy to create the database. Since the <code>STRATEGY</code> parameter of <code>CREATE DATABASE</code> was introduced in PostgreSQL 15, the default value has been <code>WAL_LOG</code>. You need to explicitly specify <code>FILE_COPY</code> for instant cloning.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_terminate_backend</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgcopy</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TEMPLATE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8> </span><span style=color:#000>STRATEGY</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For example, cloning a 30 GB database: normal clone (<code>WAL_LOG</code>) takes 18 seconds, while instant clone (<code>FILE_COPY</code>) only needs constant time of 200 milliseconds.</p><p>However, you still need to ensure no active connections to the template database during cloning, but this time can be very short, making it practical for production environments.</p><p>If you need a new database copy for testing or development, instant cloning is an excellent choice. It doesn&rsquo;t introduce additional storage overhead because it uses the file system&rsquo;s CoW (Copy on Write) mechanism.</p><p>Since Pigsty v4.0, you can use <code>strategy: FILE_COPY</code> in the <a href=/docs/pgsql/param#pg_databases/><code>pg_databases</code></a> parameter to achieve instant database cloning.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- Introduced in PG 15, instant in PG18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>#comment: &#34;meta clone&#34;      # &lt;---- Database comment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>#pgbouncer: false           # &lt;---- Not added to connection pool?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>#register_datasource: false # &lt;---- Not added to Grafana datasource?</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>After configuration, use the standard database creation SOP to create the database:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta meta_dev
</span></span></code></pre></div><h3 id=limitations-and-notes>Limitations and Notes</h3><p>This feature is only available on supported file systems (xfs, btrfs, zfs, apfs). If the file system doesn&rsquo;t support it, PostgreSQL will fail with an error.</p><p>By default, mainstream OS distributions&rsquo; xfs have <code>reflink=1</code> enabled by default, so you don&rsquo;t need to worry about this in most cases.</p><p>OpenZFS requires explicit configuration to support CoW, but due to prior data corruption incidents, it&rsquo;s not recommended for production use.</p><p>If your PostgreSQL version is below 15, specifying <code>strategy</code> will have no effect.</p><p>Please don&rsquo;t use the <code>postgres</code> database as a template database for cloning, as management connections typically connect to the <code>postgres</code> database, which prevents the cloning operation.</p><p>Use instant cloning with caution in extremely high concurrency/throughput production environments, as it requires clearing all connections to the template database within the cloning window (200ms), otherwise the clone will fail.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9f140ff0db86673b0d243757b9f578fc>8 - Data Migration</h1><div class=lead>How to migrate an existing PostgreSQL cluster to a new Pigsty-managed PostgreSQL cluster with minimal downtime?</div><p>Pigsty includes a built-in playbook <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-migration.yml><code>pgsql-migration.yml</code></a> that implements online database migration based on logical replication.</p><p>With pre-generated automation scripts, application downtime can be reduced to just a few seconds. However, note that logical replication requires PostgreSQL 10 or later to work.</p><p>Of course, if you have sufficient downtime budget, you can always use the <code>pg_dump | psql</code> approach for offline migration.</p><hr><h2 id=defining-migration-tasks>Defining Migration Tasks</h2><p>To use Pigsty&rsquo;s online migration playbook, you need to create a definition file that describes the migration task details.</p><p>Refer to the task definition file example: <a href=https://github.com/pgsty/pigsty/blob/main/files/migration/pg-meta.yml><code>files/migration/pg-meta.yml</code></a>.</p><p>This migration task will online migrate <code>pg-meta.meta</code> to <code>pg-test.test</code>, where the former is called the <strong>Source Cluster (SRC)</strong> and the latter is called the <strong>Destination Cluster (DST)</strong>.</p><pre tabindex=0><code>pg-meta-1	10.10.10.10  --&gt; pg-test-1	10.10.10.11 (10.10.10.12,10.10.10.13)
</code></pre><p>Logical replication-based migration works on a per-database basis. You need to specify the database name to migrate, as well as the IP addresses of the source and destination cluster primary nodes and superuser connection information.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PG_MIGRATION</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>context_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~/migration </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Directory for migration manual &amp; scripts</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># SRC Cluster (Old Cluster)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_cls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Source cluster name                  &lt;Required&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Source database name                 &lt;Required&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Source cluster primary IP            &lt;Required&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#src_pg: &#39;&#39;            # If defined, use this as source dbsu pgurl instead of:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # postgres://{{ pg_admin_username }}@{{ src_ip }}/{{ src_db }}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # e.g.: &#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#sub_conn: &#39;&#39;          # If defined, use this as subscription connection string instead of:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # host={{ src_ip }} dbname={{ src_db }} user={{ pg_replication_username }}&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # e.g.: &#39;host=10.10.10.10 dbname=meta user=replicator password=DBUser.Replicator&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># DST Cluster (New Cluster)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_cls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Destination cluster name             &lt;Required&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Destination database name            &lt;Required&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Destination cluster primary IP       &lt;Required&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#dst_pg: &#39;&#39;            # If defined, use this as destination dbsu pgurl instead of:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # postgres://{{ pg_admin_username }}@{{ dst_ip }}/{{ dst_db }}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # e.g.: &#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.11:5432/test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>...</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>By default, the superuser connection strings on both source and destination sides are constructed using the global admin user and the respective primary IP addresses, but you can always override these defaults through the <code>src_pg</code> and <code>dst_pg</code> parameters.
Similarly, you can override the subscription connection string default through the <code>sub_conn</code> parameter.</p><hr><h2 id=generating-migration-plan>Generating Migration Plan</h2><p>This playbook does not actively perform cluster migration, but it generates the operation manual and automation scripts needed for migration.</p><p>By default, you will find the migration context directory at <code>~/migration/pg-meta.meta</code>.
Follow the instructions in <code>README.md</code> and execute these scripts in sequence to complete the database migration!</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Activate migration context: enable related environment variables</span>
</span></span><span style=display:flex><span>. ~/migration/pg-meta.meta/activate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># These scripts check src cluster status and help generate new cluster definitions in pigsty</span>
</span></span><span style=display:flex><span>./check-user     <span style=color:#8f5902;font-style:italic># Check src users</span>
</span></span><span style=display:flex><span>./check-db       <span style=color:#8f5902;font-style:italic># Check src databases</span>
</span></span><span style=display:flex><span>./check-hba      <span style=color:#8f5902;font-style:italic># Check src hba rules</span>
</span></span><span style=display:flex><span>./check-repl     <span style=color:#8f5902;font-style:italic># Check src replication identity</span>
</span></span><span style=display:flex><span>./check-misc     <span style=color:#8f5902;font-style:italic># Check src special objects</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># These scripts establish logical replication between existing src cluster and pigsty-managed dst cluster, data except sequences will sync in real-time</span>
</span></span><span style=display:flex><span>./copy-schema    <span style=color:#8f5902;font-style:italic># Copy schema to destination</span>
</span></span><span style=display:flex><span>./create-pub     <span style=color:#8f5902;font-style:italic># Create publication on src</span>
</span></span><span style=display:flex><span>./create-sub     <span style=color:#8f5902;font-style:italic># Create subscription on dst</span>
</span></span><span style=display:flex><span>./copy-progress  <span style=color:#8f5902;font-style:italic># Print logical replication progress</span>
</span></span><span style=display:flex><span>./copy-diff      <span style=color:#8f5902;font-style:italic># Quick compare src and dst differences by counting tables</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># These scripts run during online migration, which stops src cluster and copies sequence numbers (logical replication doesn&#39;t replicate sequences!)</span>
</span></span><span style=display:flex><span>./copy-seq <span style=color:#ce5c00;font-weight:700>[</span>n<span style=color:#ce5c00;font-weight:700>]</span>   <span style=color:#8f5902;font-style:italic># Sync sequence numbers, if n is given, apply additional offset</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># You must switch application traffic to the new cluster based on your access method (dns,vip,haproxy,pgbouncer,etc.)!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#./disable-src   # Restrict src cluster access to admin nodes and new cluster (your implementation)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#./re-routing    # Re-route application traffic from SRC to DST! (your implementation)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Then cleanup to remove subscription and publication</span>
</span></span><span style=display:flex><span>./drop-sub       <span style=color:#8f5902;font-style:italic># Drop subscription on dst after migration</span>
</span></span><span style=display:flex><span>./drop-pub       <span style=color:#8f5902;font-style:italic># Drop publication on src after migration</span>
</span></span></code></pre></div><p><strong>Notes</strong></p><p>If you&rsquo;re worried about primary key conflicts when copying sequence numbers, you can advance all sequences forward by some distance when copying, for example +1000. You can use <code>./copy-seq</code> with a parameter <code>1000</code> to achieve this.</p><p>You must implement your own <code>./re-routing</code> script to route your application traffic from src to dst. Because we don&rsquo;t know how your traffic is routed (e.g., dns, VIP, haproxy, or pgbouncer). Of course, you can also do this manually&mldr;</p><p>You can implement a <code>./disable-src</code> script to restrict application access to the src cluster—this is optional: if you can ensure all application traffic is cleanly switched in <code>./re-routing</code>, you don&rsquo;t really need this step.</p><p>But if you have various access from unknown sources that can&rsquo;t be cleanly sorted out, it&rsquo;s better to use more thorough methods: change HBA rules and reload to implement (recommended), or simply stop the postgres, pgbouncer, or haproxy processes on the source primary.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-30aee675be8bae1bfec9459ffb30d160>9 - Tutorials</h1><div class=lead>Step-by-step guides for common PostgreSQL tasks and scenarios.</div><p>This section provides step-by-step tutorials for common PostgreSQL tasks and scenarios.</p><ul><li><a href=citus/><strong>Citus Cluster</strong></a>: Deploy and manage Citus distributed clusters</li><li><a href=drill/><strong>Disaster Drill</strong></a>: Emergency recovery when 2 of 3 nodes fail</li><li><a href=pg-vip/><strong>PG VIP</strong></a>: Configure L2 VIP for PostgreSQL clusters</li></ul></div><div class=td-content><h1 id=pg-1a4c8e6cbd3b2738e6fb3dfc5e4011b5>9.1 - Instance Recovery</h1><div class=lead>Clone instances and perform point-in-time recovery on the same machine</div><p>Pigsty provides two utility scripts for quickly cloning instances and performing point-in-time recovery on the same machine:</p><ul><li><a href=#pg-fork><code>pg-fork</code></a>: Quickly clone a new PostgreSQL instance on the same machine</li><li><a href=#pg-pitr><code>pg-pitr</code></a>: Manually perform point-in-time recovery using pgbackrest</li></ul><p>These two scripts can be used together: first use <code>pg-fork</code> to clone the instance, then use <code>pg-pitr</code> to restore the cloned instance to a specified point in time.</p><hr><h2 id=pg-fork>pg-fork</h2><p><a href=https://github.com/pgsty/pigsty/blob/main/files/postgres/pg-fork><code>pg-fork</code></a> can quickly clone a new PostgreSQL instance on the same machine.</p><h3 id=quick-start>Quick Start</h3><p>Execute the following command as the <code>postgres</code> user (dbsu) to create a new instance:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span>                         <span style=color:#8f5902;font-style:italic># Clone from /pg/data to /pg/data1, port 15432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>2</span> -d /pg/data1            <span style=color:#8f5902;font-style:italic># Clone from /pg/data1 to /pg/data2, port 25432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>3</span> -D /tmp/test -P <span style=color:#0000cf;font-weight:700>5555</span>    <span style=color:#8f5902;font-style:italic># Clone to custom directory and port</span>
</span></span></code></pre></div><p>After cloning, start and access the new instance:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_ctl -D /pg/data1 start         <span style=color:#8f5902;font-style:italic># Start cloned instance</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span>                     <span style=color:#8f5902;font-style:italic># Connect to cloned instance</span>
</span></span></code></pre></div><h3 id=command-syntax>Command Syntax</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-fork &lt;FORK_ID&gt; <span style=color:#ce5c00;font-weight:700>[</span>options<span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><p><strong>Required Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td><code>&lt;FORK_ID></code></td><td>Clone instance number (1-9), determines default port and data directory</td></tr></tbody></table><p><strong>Optional Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>-d, --data &lt;datadir></code></td><td>Source instance data directory</td><td><code>/pg/data</code> or <code>$PG_DATA</code></td></tr><tr><td><code>-D, --dst &lt;dst_dir></code></td><td>Target data directory</td><td><code>/pg/data&lt;FORK_ID></code></td></tr><tr><td><code>-p, --port &lt;port></code></td><td>Source instance port</td><td><code>5432</code> or <code>$PG_PORT</code></td></tr><tr><td><code>-P, --dst-port &lt;port></code></td><td>Target instance port</td><td><code>&lt;FORK_ID>5432</code></td></tr><tr><td><code>-s, --skip</code></td><td>Skip backup API, use cold copy mode</td><td>-</td></tr><tr><td><code>-y, --yes</code></td><td>Skip confirmation prompts</td><td>-</td></tr><tr><td><code>-h, --help</code></td><td>Show help information</td><td>-</td></tr></tbody></table><h3 id=how-it-works>How It Works</h3><p><code>pg-fork</code> supports two working modes:</p><p><strong>Hot Backup Mode</strong> (default, source instance running):</p><ol><li>Call <code>pg_backup_start()</code> to start backup</li><li>Use <code>cp --reflink=auto</code> to copy data directory</li><li>Call <code>pg_backup_stop()</code> to end backup</li><li>Modify configuration files to avoid conflicts with source instance</li></ol><p><strong>Cold Copy Mode</strong> (using <code>-s</code> parameter or source instance not running):</p><ol><li>Directly use <code>cp --reflink=auto</code> to copy data directory</li><li>Modify configuration files</li></ol><p>If you use XFS (with reflink enabled), Btrfs, or ZFS file systems, <code>pg-fork</code> will leverage <strong>Copy-on-Write</strong> features. The data directory copy completes in a few hundred milliseconds and takes almost no additional storage space.</p><hr><h2 id=pg-pitr>pg-pitr</h2><p><a href=https://github.com/pgsty/pigsty/blob/main/files/postgres/pg-pitr><code>pg-pitr</code></a> is a script for manually performing point-in-time recovery, based on pgbackrest.</p><h3 id=quick-start-1>Quick Start</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr -d                                  <span style=color:#8f5902;font-style:italic># Restore to latest state</span>
</span></span><span style=display:flex><span>pg-pitr -i                                  <span style=color:#8f5902;font-style:italic># Restore to backup completion time</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-01-01 12:00:00+08&#34;</span>         <span style=color:#8f5902;font-style:italic># Restore to specified time point</span>
</span></span><span style=display:flex><span>pg-pitr -n my-savepoint                     <span style=color:#8f5902;font-style:italic># Restore to named restore point</span>
</span></span><span style=display:flex><span>pg-pitr -l <span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span>                      <span style=color:#8f5902;font-style:italic># Restore to specified LSN</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>12345678</span> -X                      <span style=color:#8f5902;font-style:italic># Restore to before transaction</span>
</span></span><span style=display:flex><span>pg-pitr -b 20251225-120000F                 <span style=color:#8f5902;font-style:italic># Restore to specified backup set</span>
</span></span></code></pre></div><h3 id=command-syntax-1>Command Syntax</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr <span style=color:#ce5c00;font-weight:700>[</span>options<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>recovery_target<span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><p><strong>Recovery Target (choose one):</strong></p><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td><code>-d, --default</code></td><td>Restore to end of WAL archive stream (latest state)</td></tr><tr><td><code>-i, --immediate</code></td><td>Restore to database consistency point (fastest recovery)</td></tr><tr><td><code>-t, --time &lt;timestamp></code></td><td>Restore to specified time point</td></tr><tr><td><code>-n, --name &lt;restore_point></code></td><td>Restore to named restore point</td></tr><tr><td><code>-l, --lsn &lt;lsn></code></td><td>Restore to specified LSN</td></tr><tr><td><code>-x, --xid &lt;xid></code></td><td>Restore to specified transaction ID</td></tr><tr><td><code>-b, --backup &lt;label></code></td><td>Restore to specified backup set</td></tr></tbody></table><p><strong>Optional Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>-D, --data &lt;path></code></td><td>Recovery target data directory</td><td><code>/pg/data</code></td></tr><tr><td><code>-s, --stanza &lt;name></code></td><td>pgbackrest stanza name</td><td>Auto-detect</td></tr><tr><td><code>-X, --exclusive</code></td><td>Exclude target point (restore to before target)</td><td>-</td></tr><tr><td><code>-P, --promote</code></td><td>Auto-promote after recovery (default pauses)</td><td>-</td></tr><tr><td><code>-c, --check</code></td><td>Dry run mode, only print commands</td><td>-</td></tr><tr><td><code>-y, --yes</code></td><td>Skip confirmation and countdown</td><td>-</td></tr></tbody></table><h3 id=post-recovery-processing>Post-Recovery Processing</h3><p>After recovery completes, the instance will be in <strong>recovery paused</strong> state (unless <code>-P</code> parameter is used). You need to:</p><ol><li><strong>Start instance</strong>: <code>pg_ctl -D /pg/data start</code></li><li><strong>Verify data</strong>: Check if data meets expectations</li><li><strong>Promote instance</strong>: <code>pg_ctl -D /pg/data promote</code></li><li><strong>Enable archiving</strong>: <code>psql -c "ALTER SYSTEM SET archive_mode = on;"</code></li><li><strong>Restart instance</strong>: <code>pg_ctl -D /pg/data restart</code></li><li><strong>Execute backup</strong>: <code>pg-backup full</code></li></ol><hr><h2 id=combined-usage>Combined Usage</h2><p><code>pg-fork</code> and <code>pg-pitr</code> can be combined for a safe PITR verification workflow:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Clone current instance</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Execute PITR on cloned instance (doesn&#39;t affect production)</span>
</span></span><span style=display:flex><span>pg-pitr -D /pg/data1 -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. Start cloned instance</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. Verify recovery results</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span> -c <span style=color:#4e9a06>&#34;SELECT count(*) FROM orders WHERE created_at &lt; &#39;2025-12-27 10:00:00&#39;;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. After confirmation, you can choose:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#    - Option A: Execute the same PITR on production instance</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#    - Option B: Promote cloned instance as new production instance</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 6. Clean up test instance</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 stop
</span></span><span style=display:flex><span>rm -rf /pg/data1
</span></span></code></pre></div><hr><h2 id=notes>Notes</h2><h3 id=runtime-requirements>Runtime Requirements</h3><ul><li>Must be executed as <code>postgres</code> user (or postgres group member)</li><li><code>pg-pitr</code> requires stopping target instance&rsquo;s PostgreSQL before execution</li><li><code>pg-fork</code> hot backup mode requires source instance to be running</li></ul><h3 id=file-system>File System</h3><ul><li>XFS (with reflink enabled) or Btrfs file system recommended</li><li>Cloning on CoW file systems is almost instant and takes no extra space</li><li>Non-CoW file systems will perform full copy, taking longer</li></ul><h3 id=port-planning>Port Planning</h3><table><thead><tr><th>FORK_ID</th><th>Default Port</th><th>Default Data Directory</th></tr></thead><tbody><tr><td>1</td><td>15432</td><td>/pg/data1</td></tr><tr><td>2</td><td>25432</td><td>/pg/data2</td></tr><tr><td>3</td><td>35432</td><td>/pg/data3</td></tr><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr><tr><td>9</td><td>95432</td><td>/pg/data9</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-39a4da4f2254a96928c0e56a6cb63c63>9.2 - Troubleshooting</h1><div class=lead>Common failures and analysis troubleshooting approaches</div><p>This document lists potential failures in PostgreSQL and Pigsty, as well as SOPs for locating, handling, and analyzing issues.</p><hr><h2 id=disk-space-exhausted>Disk Space Exhausted</h2><p>Disk space exhaustion is the most common type of failure.</p><h3 id=symptoms>Symptoms</h3><p>When the disk space where the database resides is exhausted, PostgreSQL will not work normally and may exhibit the following symptoms: database logs repeatedly report &ldquo;no space left on device&rdquo; errors, new data cannot be written, and PostgreSQL may even trigger a PANIC and force shutdown.</p><p>Pigsty includes a NodeFsSpaceFull alert rule that triggers when filesystem available space is less than 10%.
Use the monitoring system&rsquo;s NODE Instance panel to review the FS metrics panel to locate the issue.</p><h3 id=diagnosis>Diagnosis</h3><p>You can also log into the database node and use <code>df -h</code> to view the usage of each mounted partition to determine which partition is full.
For database nodes, focus on checking the following directories and their sizes to determine which category of files has filled up the space:</p><ul><li><strong>Data directory</strong> (<code>/pg/data/base</code>): Stores data files for tables and indexes; pay attention to heavy writes and temporary files</li><li><strong>WAL directory</strong> (e.g., <code>pg/data/pg_wal</code>): Stores PG WAL; WAL accumulation/replication slot retention is a common cause of disk exhaustion.</li><li><strong>Database log directory</strong> (e.g., <code>pg/log</code>): If PG logs are not rotated in time and large amounts of errors are written, they may also consume significant space.</li><li><strong>Local backup directory</strong> (e.g., <code>data/backups</code>): When using pgBackRest or similar tools to save backups locally, this may also fill up the disk.</li></ul><p>If the issue occurs on the Pigsty admin node or monitoring node, also consider:</p><ul><li><strong>Monitoring data</strong>: VictoriaMetrics time-series metrics and VictoriaLogs log storage both consume disk space; check retention policies.</li><li><strong>Object storage data</strong>: Pigsty&rsquo;s integrated MinIO object storage may be used for PG backup storage.</li></ul><p>After identifying the directory consuming the most space, you can further use <code>du -sh &lt;directory></code> to drill down and find specific large files or subdirectories.</p><h3 id=resolution>Resolution</h3><p>Disk exhaustion is an emergency issue requiring immediate action to free up space and ensure the database continues to operate.
When the data disk is not separated from the system disk, a full disk may prevent shell commands from executing. In this case, you can delete the <code>/pg/dummy</code> placeholder file to free up a small amount of emergency space so shell commands can work again.
If the database has crashed due to pg_wal filling up, you need to restart the database service after clearing space and carefully check data integrity.</p><hr><h2 id=transaction-id-wraparound>Transaction ID Wraparound</h2><p>PostgreSQL cyclically uses 32-bit transaction IDs (XIDs), and when exhausted, a &ldquo;transaction ID wraparound&rdquo; failure occurs (XID Wraparound).</p><h3 id=symptoms-1>Symptoms</h3><p>The typical sign in the first phase is when the age saturation in the <a href=https://demo.pigsty.io/d/pgsql-persist>PGSQL Persist - Age Usage</a> panel enters the warning zone.
Database logs begin to show messages like: <code>WARNING: database "postgres" must be vacuumed within xxxxxxxx transactions</code>.</p><p>If the problem continues to worsen, PostgreSQL enters protection mode: when remaining transaction IDs drop to about 1 million, the database switches to read-only mode; when reaching the limit of about 2.1 billion (2^31), it refuses any new transactions and forces the server to shut down to avoid data corruption.</p><h3 id=diagnosis-1>Diagnosis</h3><p>PostgreSQL and Pigsty enable automatic garbage collection (AutoVacuum) by default, so the occurrence of this type of failure usually has deeper root causes.
Common causes include: very long transactions (SAGE), misconfigured Autovacuum, replication slot blockage, insufficient resources, storage engine/extension bugs, disk bad blocks.</p><p>First identify the database with the highest age, then use the Pigsty PGCAT Database - Tables panel to confirm the age distribution of tables.
Also review the database error logs, which usually contain clues to locate the root cause.</p><h3 id=resolution-1>Resolution</h3><ol><li><strong>Immediately freeze old transactions</strong>: If the database has not yet entered read-only protection mode, immediately execute a manual VACUUM FREEZE on the affected database. You can start by freezing the most severely aged tables one by one rather than doing the entire database at once to accelerate the effect. Connect to the database as a superuser and run <code>VACUUM FREEZE table_name;</code> on tables identified with the largest <code>relfrozenxid</code>, prioritizing tables with the highest XID age. This can quickly reclaim large amounts of transaction ID space.</li><li><strong>Single-user mode rescue</strong>: If the database is already refusing writes or has crashed for protection, you need to start the database in single-user mode to perform freeze operations. In single-user mode, run <code>VACUUM FREEZE database_name;</code> to freeze and clean the entire database. After completion, restart the database in multi-user mode. This can lift the wraparound lock and make the database writable again. Be very careful when operating in single-user mode and ensure sufficient transaction ID margin to complete the freeze.</li><li><strong>Standby node takeover</strong>: In some complex scenarios (e.g., when hardware issues prevent vacuum from completing), consider promoting a read-only standby node in the cluster to primary to obtain a relatively clean environment for handling the freeze. For example, if the primary cannot vacuum due to bad blocks, you can manually failover to promote the standby to the new primary, then perform emergency vacuum freeze on it. After ensuring the new primary has frozen old transactions, switch the load back.</li></ol><hr><h2 id=connection-exhaustion>Connection Exhaustion</h2><p>PostgreSQL has a maximum connections configuration (<code>max_connections</code>). When client connections exceed this limit, new connection requests will be rejected. The typical symptom is that applications cannot connect to the database and report errors like
<strong>FATAL: remaining connection slots are reserved for non-replication superuser connections</strong> or <strong>too many clients already</strong>.
This indicates that regular connections are exhausted, leaving only slots reserved for superusers or replication.</p><h3 id=diagnosis-2>Diagnosis</h3><p>Connection exhaustion is usually caused by a large number of concurrent client requests. You can directly review the database&rsquo;s current active sessions through PGCAT Instance / PGCAT Database / PGCAT Locks.
Determine what types of queries are filling the system and proceed with further handling. Pay special attention to whether there are many connections in the &ldquo;Idle in Transaction&rdquo; state and long-running transactions (as well as slow queries).</p><h3 id=resolution-2>Resolution</h3><p><strong>Kill queries</strong>: For situations where exhaustion has already blocked business operations, typically use <code>pg_terminate_backend(pid)</code> immediately for emergency pressure relief.
For cases using connection pooling, you can adjust the connection pool size parameters and execute a reload to reduce the number of connections at the database level.</p><p>You can also modify the <code>max_connections</code> parameter to a larger value, but this parameter requires a database restart to take effect.</p><hr><h2 id=etcd-quota-exhausted>etcd Quota Exhausted</h2><p>An exhausted etcd quota will cause the PG high availability control plane to fail and prevent configuration changes.</p><h3 id=diagnosis-3>Diagnosis</h3><p>Pigsty uses etcd as the distributed configuration store (DCS) when implementing high availability. etcd itself has a storage quota (default is about 2GB).
When etcd storage usage reaches the quota limit, etcd will refuse write operations and report &ldquo;<strong>etcdserver: mvcc: database space exceeded</strong>&rdquo;. In this case, Patroni cannot write heartbeats or update configuration to etcd, causing cluster management functions to fail.</p><h3 id=resolution-3>Resolution</h3><p>Versions between Pigsty v2.0.0 and v2.5.1 are affected by this issue by default. Pigsty v2.6.0 added auto-compaction configuration for deployed etcd. If you only use it for PG high availability leases, this issue will no longer occur in regular use cases.</p><hr><h2 id=defective-storage-engine>Defective Storage Engine</h2><p>Currently, TimescaleDB&rsquo;s experimental storage engine Hypercore has been proven to have defects, with cases of VACUUM being unable to reclaim leading to XID wraparound failures.
Users using this feature should migrate to PostgreSQL native tables or TimescaleDB&rsquo;s default engine promptly.</p><p>Detailed introduction: <a href=https://mp.weixin.qq.com/s/LdZVVyOj4BA9C892I25lQw>PG New Storage Engine Failure Case</a> (Chinese)</p></div><div class=td-content style=page-break-before:always><h1 id=pg-58aaa9e1f6e72722733819cd673913c3>9.3 - Manual Recovery</h1><div class=lead>Manually perform PITR following prompt scripts in sandbox environment</div><p>You can use the <code>pgsql-pitr.yml</code> playbook to perform PITR, but in some cases, you may want to manually execute PITR using pgbackrest primitives directly for fine-grained control.
We will use a <a href=/docs/deploy/sandbox><strong>four-node sandbox</strong></a> cluster with MinIO backup repository to demonstrate the process.</p><p><img src=/img/pigsty/sandbox.png alt=pigsty-sandbox></p><hr><h2 id=initialize-sandbox>Initialize Sandbox</h2><p>Use <a href=/docs/deploy/vagrant><strong>vagrant</strong></a> or <a href=/docs/deploy/terraform><strong>terraform</strong></a> to prepare a four-node sandbox environment, then:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty/
</span></span><span style=display:flex><span>./configure -c full
</span></span><span style=display:flex><span>./install
</span></span></code></pre></div><p>Now operate as the admin user (or dbsu) on the admin node.</p><hr><h2 id=check-backup>Check Backup</h2><p>To check backup status, you need to switch to the <code>postgres</code> user and use the <code>pb</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres    <span style=color:#8f5902;font-style:italic># Switch to dbsu: postgres user</span>
</span></span><span style=display:flex><span>pb info               <span style=color:#8f5902;font-style:italic># Print pgbackrest backup info</span>
</span></span></code></pre></div><p><code>pb</code> is an alias for <code>pgbackrest</code> that automatically retrieves the <code>stanza</code> name from pgbackrest configuration.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pb<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>stanza</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>grep -o <span style=color:#4e9a06>&#39;\[[^][]*]&#39;</span> /etc/pgbackrest/pgbackrest.conf <span style=color:#000;font-weight:700>|</span> head -n1 <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/.*\[\([^]]*\)].*/\1/&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$stanza</span> <span style=color:#000>$@</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>You can see the initial backup information, which is a full backup:</p><pre tabindex=0><code>root@pg-meta-1:~# pb info
stanza: pg-meta
    status: ok
    cipher: aes-256-cbc

    db (current)
        wal archive min/max (17): 000000010000000000000001/000000010000000000000007

        full backup: 20250713-022731F
            timestamp start/stop: 2025-07-13 02:27:31+00 / 2025-07-13 02:27:33+00
            wal start/stop: 000000010000000000000004 / 000000010000000000000004
            database size: 44MB, database backup size: 44MB
            repo1: backup size: 8.4MB
</code></pre><p>The backup completed at <code>2025-07-13 02:27:33+00</code>, which is the earliest time you can restore to.
Since WAL archiving is active, you can restore to any point in time after the backup, up to the end of WAL (i.e., now).</p><hr><h2 id=generate-heartbeats>Generate Heartbeats</h2><p>You can generate some heartbeats to simulate workload. <code>/pg-bin/pg-heartbeat</code> is for this purpose,
it writes a heartbeat timestamp to the <code>monitor.heartbeat</code> table every second.</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
Heartbeat Generation</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
alias</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
pgbench</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make rh     <span style=color:#8f5902;font-style:italic># Run heartbeat: ssh 10.10.10.10 &#39;sudo -iu postgres /pg/bin/pg-heartbeat&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh 10.10.10.10 <span style=color:#4e9a06>&#39;sudo -iu postgres /pg/bin/pg-heartbeat&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>   cls   <span style=color:#000;font-weight:700>|</span>              ts               <span style=color:#000;font-weight:700>|</span>    lsn     <span style=color:#000;font-weight:700>|</span>  lsn_int  <span style=color:#000;font-weight:700>|</span> txid <span style=color:#000;font-weight:700>|</span> status  <span style=color:#000;font-weight:700>|</span>       now       <span style=color:#000;font-weight:700>|</span>  elapse
</span></span><span style=display:flex><span>---------+-------------------------------+------------+-----------+------+---------+-----------------+----------
</span></span><span style=display:flex><span> pg-meta <span style=color:#000;font-weight:700>|</span> 2025-07-13 03:01:20.318234+00 <span style=color:#000;font-weight:700>|</span> 0/115BF5C0 <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>291239360</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4812</span> <span style=color:#000;font-weight:700>|</span> leading <span style=color:#000;font-weight:700>|</span> 03:01:20.318234 <span style=color:#000;font-weight:700>|</span> 00:00:00</span></span></code></pre></div></div></div><p>You can even add more workload to the cluster. Let&rsquo;s use <code>pgbench</code> to generate some random writes:</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pgbench Workload</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
alias</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
pgbench</button></li><li class=nav-item><button class=nav-link id=tabs-01-03-tab data-bs-toggle=tab data-bs-target=#tabs-01-03 role=tab aria-controls=tabs-01-03 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make ri     <span style=color:#8f5902;font-style:italic># Initialize pgbench</span>
</span></span><span style=display:flex><span>make rw     <span style=color:#8f5902;font-style:italic># Run pgbench read-write workload</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -is10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> pgbench -nv -P1 -c4 --rate<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> -T10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-03 role=tabpanel aria-labelled-by=tabs-01-03-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> pgbench -nv -P1 -c4 --rate<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> -T10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>pgbench <span style=color:#ce5c00;font-weight:700>(</span>17.5 <span style=color:#ce5c00;font-weight:700>(</span>Homebrew<span style=color:#ce5c00;font-weight:700>)</span>, server 17.4 <span style=color:#ce5c00;font-weight:700>(</span>Ubuntu 17.4-1.pgdg24.04+2<span style=color:#ce5c00;font-weight:700>))</span>
</span></span><span style=display:flex><span>progress: 1.0 s, 60.9 tps, lat 7.295 ms stddev 4.219, <span style=color:#0000cf;font-weight:700>0</span> failed, lag 1.818 ms
</span></span><span style=display:flex><span>progress: 2.0 s, 69.1 tps, lat 6.296 ms stddev 1.983, <span style=color:#0000cf;font-weight:700>0</span> failed, lag 1.397 ms
</span></span><span style=display:flex><span>...</span></span></code></pre></div></div></div><hr><h2 id=pitr-manual>PITR Manual</h2><p>Now let&rsquo;s choose a recovery point in time, such as <code>2025-07-13 03:03:03+00</code>, which is a point after the initial backup (and heartbeat).
To perform manual PITR, use the <code>pg-pitr</code> tool:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg-pitr -t <span style=color:#4e9a06>&#34;2025-07-13 03:03:00+00&#34;</span>
</span></span></code></pre></div><p>It will generate instructions for performing the recovery, typically requiring four steps:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Perform <span style=color:#204a87>time</span> PITR on pg-meta
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>1. Stop PostgreSQL<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   1.1 Pause Patroni <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> there are any replicas<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ pg pause &lt;cls&gt;  <span style=color:#8f5902;font-style:italic># Pause patroni auto-failover</span>
</span></span><span style=display:flex><span>   1.2 Shutdown Patroni
</span></span><span style=display:flex><span>       $ pt-stop         <span style=color:#8f5902;font-style:italic># sudo systemctl stop patroni</span>
</span></span><span style=display:flex><span>   1.3 Shutdown Postgres
</span></span><span style=display:flex><span>       $ pg-stop         <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data stop -m fast</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2. Perform PITR<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   2.1 Restore Backup
</span></span><span style=display:flex><span>       $ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>   2.2 Start PG to Replay WAL
</span></span><span style=display:flex><span>       $ pg-start        <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data start</span>
</span></span><span style=display:flex><span>   2.3 Validate and Promote
</span></span><span style=display:flex><span>     - If database content is ok, promote it to finish recovery, otherwise goto 2.1
</span></span><span style=display:flex><span>       $ pg-promote      <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data promote</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>3. Restore Primary<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   3.1 Enable Archive Mode <span style=color:#ce5c00;font-weight:700>(</span>Restart Required<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM SET archive_mode = on;&#39;</span>
</span></span><span style=display:flex><span>   3.1 Restart Postgres to Apply Changes
</span></span><span style=display:flex><span>       $ pg-restart      <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data restart</span>
</span></span><span style=display:flex><span>   3.3 Restart Patroni
</span></span><span style=display:flex><span>       $ pt-restart      <span style=color:#8f5902;font-style:italic># sudo systemctl restart patroni</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>4. Restore Cluster<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   4.1 Re-Init All <span style=color:#ce5c00;font-weight:700>[</span>**REPLICAS**<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> any<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       - 4.1.1 option 1: restore replicas with same pgbackrest cmd <span style=color:#ce5c00;font-weight:700>(</span>require central backup repo<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           $ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>       - 4.1.2 option 2: nuke the replica data dir and restart patroni <span style=color:#ce5c00;font-weight:700>(</span>may take long <span style=color:#204a87>time</span> to restore<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           $ rm -rf /pg/data/*<span style=color:#000;font-weight:700>;</span> pt-restart
</span></span><span style=display:flex><span>       - 4.1.3 option 3: reinit with patroni, which may fail <span style=color:#204a87;font-weight:700>if</span> primary lsn &lt; replica lsn
</span></span><span style=display:flex><span>           $ pg reinit pg-meta
</span></span><span style=display:flex><span>   4.2 Resume Patroni
</span></span><span style=display:flex><span>       $ pg resume pg-meta
</span></span><span style=display:flex><span>   4.3 Full Backup <span style=color:#ce5c00;font-weight:700>(</span>optional<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ pg-backup full      <span style=color:#8f5902;font-style:italic># Recommended to perform new full backup after PITR</span>
</span></span></code></pre></div><hr><h2 id=single-node-example>Single Node Example</h2><p>Let&rsquo;s start with the simple single-node <code>pg-meta</code> cluster as a simpler example.</p><h3 id=shutdown-database>Shutdown Database</h3><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
Shutdown Services</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
shutdown patroni</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
shutdown postgres</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pt-stop         <span style=color:#8f5902;font-style:italic># sudo systemctl stop patroni, shutdown patroni (and postgres)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Optional, because postgres will be shutdown by patroni if patroni is not paused</span>
</span></span><span style=display:flex><span>$ pg_stop        <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data stop -m fast, shutdown postgres</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg_ctl: PID file <span style=color:#4e9a06>&#34;/pg/data/postmaster.pid&#34;</span> does not exist
</span></span><span style=display:flex><span>Is server running?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ pg-ps           <span style=color:#8f5902;font-style:italic># Print postgres related processes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> UID         PID   PPID  C STIME TTY      STAT   TIME CMD
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>31048</span>      <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0</span> 02:27 ?        Ssl    0:19 /usr/sbin/pgbouncer /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>32026</span>      <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0</span> 02:28 ?        Ssl    0:03 /usr/bin/pg_exporter ...
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>35510</span>  <span style=color:#0000cf;font-weight:700>35480</span>  <span style=color:#0000cf;font-weight:700>0</span> 03:01 pts/2    S+     0:00 /bin/bash /pg/bin/pg-heartbeat</span></span></code></pre></div></div></div><p>Make sure local postgres is not running, then execute the recovery commands given in the manual:</p><h3 id=restore-backup>Restore Backup</h3><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab aria-controls=tabs-03-00 aria-selected=false>
Restore Backup</button></li><li class=nav-item><button class="nav-link active" id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab aria-controls=tabs-03-01 aria-selected=true>
restore</button></li><li class=nav-item><button class=nav-link id=tabs-03-02-tab data-bs-toggle=tab data-bs-target=#tabs-03-02 role=tab aria-controls=tabs-03-02 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-pane fade" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-03-02 role=tabpanel aria-labelled-by=tabs-03-02-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>2025-07-13 03:17:07.443 P00   INFO: restore <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-13 03:17:07.470 P00   INFO: repo1: restore backup <span style=color:#204a87>set</span> 20250713-022731F, recovery will start at 2025-07-13 02:27:31
</span></span><span style=display:flex><span>2025-07-13 03:17:07.471 P00   INFO: remove invalid files/links/paths from <span style=color:#4e9a06>&#39;/pg/data&#39;</span>
</span></span><span style=display:flex><span>2025-07-13 03:17:08.523 P00   INFO: write updated /pg/data/postgresql.auto.conf
</span></span><span style=display:flex><span>2025-07-13 03:17:08.527 P00   INFO: restore <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 44MB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1436</span>
</span></span><span style=display:flex><span>2025-07-13 03:17:08.527 P00   INFO: restore <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1087ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div></div><h3 id=verify-data>Verify Data</h3><p>We don&rsquo;t want patroni HA to take over until we&rsquo;re sure the data is correct, so start postgres manually:</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab aria-controls=tabs-04-00 aria-selected=false>
Verify Data</button></li><li class=nav-item><button class="nav-link active" id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab aria-controls=tabs-04-01 aria-selected=true>
start postgres</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab aria-controls=tabs-04-02 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-pane fade" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-start</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>waiting <span style=color:#204a87;font-weight:700>for</span> server to start....2025-07-13 03:19:33.133 UTC <span style=color:#ce5c00;font-weight:700>[</span>39294<span style=color:#ce5c00;font-weight:700>]</span> LOG:  redirecting log output to logging collector process
</span></span><span style=display:flex><span>2025-07-13 03:19:33.133 UTC <span style=color:#ce5c00;font-weight:700>[</span>39294<span style=color:#ce5c00;font-weight:700>]</span> HINT:  Future log output will appear in directory <span style=color:#4e9a06>&#34;/pg/log/postgres&#34;</span>.
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>server started</span></span></code></pre></div></div></div><p>Now you can check the data to see if it&rsquo;s at the point in time you want.
You can verify by checking the latest timestamp in business tables, or in this case, check via the heartbeat table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ psql -c <span style=color:#4e9a06>&#39;table monitor.heartbeat&#39;</span>
</span></span><span style=display:flex><span>   id    <span style=color:#000;font-weight:700>|</span>              ts               <span style=color:#000;font-weight:700>|</span>    lsn    <span style=color:#000;font-weight:700>|</span> txid
</span></span><span style=display:flex><span>---------+-------------------------------+-----------+------
</span></span><span style=display:flex><span> pg-meta <span style=color:#000;font-weight:700>|</span> 2025-07-13 03:02:59.214104+00 <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>302005504</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4912</span>
</span></span></code></pre></div><p>The timestamp is just before our specified point in time! (<code>2025-07-13 03:03:00+00</code>).
If this is not the point in time you want, you can repeat the recovery with a different time point.
Since recovery is performed incrementally and in parallel, it&rsquo;s very fast.
You can retry until you find the correct point in time.</p><h3 id=promote-primary>Promote Primary</h3><p>The recovered postgres cluster is in <code>recovery</code> mode, so it will reject any write operations until promoted to primary.
These recovery parameters are generated by pgBackRest in the configuration file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>postgres@pg-meta-1:~$ cat /pg/data/postgresql.auto.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Do not edit this file or use ALTER SYSTEM manually!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># It is managed by Pigsty &amp; Ansible automatically!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recovery settings generated by pgBackRest restore on 2025-07-13 03:17:08</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>archive_mode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;off&#39;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>restore_command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;pgbackrest --stanza=pg-meta archive-get %f &#34;%p&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>recovery_target_time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span>
</span></span></code></pre></div><p>If the data is correct, you can <strong>promote</strong> it to primary, marking it as the new leader and ready to accept writes.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab aria-controls=tabs-05-00 aria-selected=false>
Promote Primary</button></li><li class=nav-item><button class="nav-link active" id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab aria-controls=tabs-05-01 aria-selected=true>
promote</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab aria-controls=tabs-05-02 aria-selected=false>
check</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-pane fade" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-promote
</span></span><span style=display:flex><span>waiting <span style=color:#204a87;font-weight:700>for</span> server to promote.... <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>server promoted</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_is_in_recovery()&#39;</span>   <span style=color:#8f5902;font-style:italic># &#39;f&#39; means promoted to primary</span>
</span></span><span style=display:flex><span> pg_is_in_recovery
</span></span><span style=display:flex><span>-------------------
</span></span><span style=display:flex><span> f
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> row<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>New Timeline and Split Brain</div><p>Once promoted, the database cluster will enter a new timeline (leader epoch).
If there is any write traffic, it will be written to the new timeline.</p></div><h3 id=restore-cluster>Restore Cluster</h3><p>Finally, not only do you need to restore data, but also restore cluster state, such as:</p><ul><li>patroni takeover</li><li>archive mode</li><li>backup set</li><li>replicas</li></ul><h4 id=patroni-takeover>Patroni Takeover</h4><p>Your postgres was started directly. To restore HA takeover, you need to start the patroni service:</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab aria-controls=tabs-07-00 aria-selected=false>
Patroni Takeover</button></li><li class=nav-item><button class="nav-link active" id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab aria-controls=tabs-07-01 aria-selected=true>
launch patroni</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab aria-controls=tabs-07-02 aria-selected=false>
resume patroni</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-pane fade" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pt-start   <span style=color:#8f5902;font-style:italic># sudo systemctl start patroni</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume pg-meta      <span style=color:#8f5902;font-style:italic># Resume patroni auto-failover (if previously paused)</span></span></span></code></pre></div></div></div><h4 id=archive-mode>Archive Mode</h4><p><code>archive_mode</code> is disabled during recovery by pgbackrest.
If you want new leader writes to be archived to the backup repository, you also need to enable the <code>archive_mode</code> configuration.</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab aria-controls=tabs-08-00 aria-selected=false>
Archive Mode</button></li><li class=nav-item><button class="nav-link active" id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab aria-controls=tabs-08-01 aria-selected=true>
check archive_mode</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab aria-controls=tabs-08-02 aria-selected=false>
reset archive_mode</button></li><li class=nav-item><button class=nav-link id=tabs-08-03-tab data-bs-toggle=tab data-bs-target=#tabs-08-03 role=tab aria-controls=tabs-08-03 aria-selected=false>
edit directly</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-pane fade" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;show archive_mode&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> archive_mode
</span></span><span style=display:flex><span>--------------
</span></span><span style=display:flex><span> off</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode;&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;show archive_mode&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-08-03 role=tabpanel aria-labelled-by=tabs-08-03-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># You can also directly edit postgresql.auto.conf and reload with pg_ctl</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;/archive_mode/d&#39;</span> /pg/data/postgresql.auto.conf
</span></span><span style=display:flex><span>pg_ctl -D /pg/data reload</span></span></code></pre></div></div></div><h4 id=backup-set>Backup Set</h4><p>It&rsquo;s generally recommended to perform a new full backup after PITR, but this is optional.</p><h4 id=replicas>Replicas</h4><p>If your postgres cluster has replicas, you also need to perform PITR on each replica.
Alternatively, a simpler approach is to remove the replica data directory and restart patroni, which will reinitialize the replica from the primary.
We&rsquo;ll cover this scenario in the next multi-node cluster example.</p><hr><h2 id=multi-node-example>Multi-Node Example</h2><p>Now let&rsquo;s use the three-node <code>pg-test</code> cluster as a PITR example.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ec3ed8119ef85413c277384f41ca7b27>9.4 - Enabling HugePage for PostgreSQL</h1><div class=lead>Enabling HugePage for PostgreSQL to reduce memory fragmentation and improve performance.</div><blockquote><p>Use <code>node_hugepage_count</code> and <code>node_hugepage_ratio</code> or <code>/pg/bin/pg-tune-hugepage</code></p></blockquote><p>If you plan to enable HugePages, consider using <a href=/docs/node/param#node_hugepage_count><code>node_hugepage_count</code></a> and <a href=/docs/node/param#node_hugepage_ratio><code>node_hugepage_ratio</code></a>, and apply with <code>./node.yml -t node_tune</code>.</p><p>HugePages have pros and cons for databases. The advantage is that memory is managed exclusively, eliminating concerns about being reallocated and reducing database OOM risk. The disadvantage is that it may negatively impact performance in certain scenarios.</p><p>Before PostgreSQL starts, you need to allocate <strong>enough</strong> huge pages. The wasted portion can be reclaimed using the <code>pg-tune-hugepage</code> script, but this script is only available for PostgreSQL 15+.</p><p>If your PostgreSQL is already running, you can enable huge pages using the following method (PG15+ only):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sync<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>3</span> &gt; /proc/sys/vm/drop_caches   <span style=color:#8f5902;font-style:italic># Flush disk, release system cache (be prepared for database perf impact)</span>
</span></span><span style=display:flex><span>sudo /pg/bin/pg-tune-hugepage             <span style=color:#8f5902;font-style:italic># Write nr_hugepages to /etc/sysctl.d/hugepage.conf</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt;                          <span style=color:#8f5902;font-style:italic># Restart postgres to use hugepage</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e6716a8d517caddd0851177927c9c69c>9.5 - Accidental Deletion</h1><div class=lead>Handling accidental data deletion, table deletion, and database deletion</div><h2 id=accidental-data-deletion>Accidental Data Deletion</h2><p>If it&rsquo;s a small-scale <code>DELETE</code> misoperation, you can consider using the <a href=https://pgext.cloud/e/pg_surgery><code>pg_surgery</code></a> or <a href=https://pgext.cloud/e/pg_dirtyread><code>pg_dirtyread</code></a> extension for in-place surgical recovery.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Immediately disable Auto Vacuum on this table and abort Auto Vacuum worker processes for this table
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>some_table</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>autovacuum_enabled</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>autovacuum_enabled</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dirtyread</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dirtyread</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;tablename&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#f8f8f8> </span><span style=color:#000>type1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>col2</span><span style=color:#f8f8f8> </span><span style=color:#000>type2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If the deleted data has already been reclaimed by VACUUM, then use the general accidental deletion recovery process.</p><h2 id=accidental-object-deletion>Accidental Object Deletion</h2><p>When <code>DROP/DELETE</code> type misoperations occur, typically decide on a recovery plan according to the following process:</p><ol><li>Confirm whether this data can be recovered from the business system or other data systems. If yes, recover directly from the business side.</li><li>Confirm whether there is a delayed replica. If yes, advance the delayed replica to the time point before deletion and query the data for recovery.</li><li>If the data has been confirmed deleted, confirm backup information and whether the backup range covers the deletion time point. If it does, start PITR.</li><li>Confirm whether to perform in-place cluster <a href=/docs/pgsql/backup/restore>PITR rollback</a>, or start a new server for replay, or use a replica for replay, and execute the recovery strategy.</li></ol><h2 id=accidental-cluster-deletion>Accidental Cluster Deletion</h2><p>If an entire database cluster is accidentally deleted through Pigsty management commands, for example, incorrectly executing the <a href=/docs/pgsql/playbook#pgsql-rmyml><code>pgsql-rm.yml</code></a> playbook or the <code>bin/pgsql-rm</code> command.
Unless you have set the <a href=/docs/pgsql/param#pg_rm_backup><code>pg_rm_backup</code></a> parameter to <code>false</code>, the backup will be deleted along with the database cluster.</p><blockquote><p><strong>Warning</strong>: In this situation, your data will be unrecoverable! <strong>Please think three times before proceeding!</strong></p></blockquote><p>Recommendation: For production environments, you can globally configure this parameter to <code>false</code> in the configuration manifest to preserve backups when removing clusters.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-677d9d9a118e237b46693da04151cde7>9.6 - HA Drill: Handling 2-of-3 Node Failure</h1><div class=lead>HA scenario response plan: When two of three nodes fail and auto-failover doesn&rsquo;t work, how to recover from the emergency state?</div><p>If a classic 3-node HA deployment experiences simultaneous failure of two nodes (majority), the system typically cannot complete automatic failover and requires manual intervention.</p><p>First, assess the status of the other two servers. If they can be brought up quickly, prioritize recovering those two servers. Otherwise, enter the <strong>Emergency Recovery Procedure</strong>.</p><p><strong>The Emergency Recovery Procedure assumes your admin node has failed</strong> and only a single regular database node survives. In this case, the fastest recovery process is:</p><ul><li>Adjust HAProxy configuration to direct traffic to the primary.</li><li>Stop Patroni and manually promote the PostgreSQL replica to primary.</li></ul><hr><h2 id=adjust-haproxy-configuration>Adjust HAProxy Configuration</h2><p>If you access the cluster bypassing HAProxy, you can skip this step. If you access the database cluster through HAProxy, you need to adjust the load balancer configuration to manually direct read/write traffic to the primary.</p><ul><li>Edit the <code>/etc/haproxy/&lt;pg_cluster>-primary.cfg</code> configuration file, where <code>&lt;pg_cluster></code> is your PostgreSQL cluster name, e.g., <code>pg-meta</code>.</li><li>Comment out the health check configuration options to stop health checks.</li><li>Comment out the other two failed machines in the server list, keeping only the current primary server.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-meta-primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5433</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Comment out the following four health check lines</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#option httpchk                               # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#option http-keep-alive                       # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#http-check send meth OPTIONS uri /primary    # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#http-check expect status 200                 # &lt;---- remove this</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-meta-1 10.10.10.10:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Comment out the other two failed machines</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#server pg-meta-2 10.10.10.11:6432 check port 8008 weight 100 &lt;---- comment this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#server pg-meta-3 10.10.10.12:6432 check port 8008 weight 100 &lt;---- comment this</span>
</span></span></code></pre></div><p>After adjusting the configuration, don&rsquo;t rush to execute <code>systemctl reload haproxy</code> to reload. Wait until after promoting the primary, then execute together. The effect of this configuration is that HAProxy will no longer perform primary health checks (which by default use Patroni), but will directly direct write traffic to the current primary.</p><hr><h2 id=manually-promote-replica>Manually Promote Replica</h2><p>Log in to the target server, switch to the dbsu user, execute <code>CHECKPOINT</code> to flush to disk, stop Patroni, restart PostgreSQL, and execute Promote.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres                     <span style=color:#8f5902;font-style:italic># Switch to database dbsu user</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;checkpoint; checkpoint;&#39;</span>      <span style=color:#8f5902;font-style:italic># Two Checkpoints to flush dirty pages, avoid long PG restart</span>
</span></span><span style=display:flex><span>sudo systemctl stop patroni            <span style=color:#8f5902;font-style:italic># Stop Patroni</span>
</span></span><span style=display:flex><span>pg-restart                             <span style=color:#8f5902;font-style:italic># Restart PostgreSQL</span>
</span></span><span style=display:flex><span>pg-promote                             <span style=color:#8f5902;font-style:italic># Promote PostgreSQL replica to primary</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_is_in_recovery();&#39;</span>  <span style=color:#8f5902;font-style:italic># If result is f, it has been promoted to primary</span>
</span></span></code></pre></div><p>If you adjusted the HAProxy configuration above, you can now execute <code>systemctl reload haproxy</code> to reload the HAProxy configuration and direct traffic to the new primary.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload haproxy                <span style=color:#8f5902;font-style:italic># Reload HAProxy configuration to direct write traffic to current instance</span>
</span></span></code></pre></div><hr><h2 id=avoid-split-brain>Avoid Split Brain</h2><p>After emergency recovery, the second priority is: <strong>Avoid Split Brain</strong>. Users should prevent the other two servers from coming back online and forming a split brain with the current primary, causing data inconsistency.</p><p>Simple approaches:</p><ul><li><strong>Power off/disconnect network</strong> the other two servers to ensure they don&rsquo;t come online uncontrollably.</li><li>Adjust the database connection string used by applications to point directly to the surviving server&rsquo;s primary.</li></ul><p>Then decide the next steps based on the specific situation:</p><ul><li>A: The two servers have temporary failures (e.g., network/power outage) and can be repaired in place to continue service.</li><li>B: The two failed servers have permanent failures (e.g., hardware damage) and will be removed and decommissioned.</li></ul><hr><h2 id=recovery-after-temporary-failure>Recovery After Temporary Failure</h2><p>If the other two servers have temporary failures and can be repaired to continue service, follow these steps for repair and rebuild:</p><ul><li>Handle one failed server at a time, prioritize the admin node / INFRA node.</li><li>Start the failed server and stop Patroni after startup.</li></ul><p>After the ETCD cluster quorum is restored, it will resume work. Then start Patroni on the surviving server (current primary) to take over the existing PostgreSQL and regain cluster leadership. After Patroni starts, enter maintenance mode.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni
</span></span><span style=display:flex><span>pg pause &lt;pg_cluster&gt;
</span></span></code></pre></div><p>On the other two instances, create the <code>touch /pg/data/standby.signal</code> marker file as the <code>postgres</code> user to mark them as replicas, then start Patroni:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni
</span></span></code></pre></div><p>After confirming Patroni cluster identity/roles are correct, exit maintenance mode:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume &lt;pg_cluster&gt;
</span></span></code></pre></div><hr><h2 id=recovery-after-permanent-failure>Recovery After Permanent Failure</h2><p>After permanent failure, first recover the <code>~/pigsty</code> directory on the admin node. The key files needed are <code>pigsty.yml</code> and <code>files/pki/ca/ca.key</code>.</p><blockquote><p>If you cannot retrieve or don&rsquo;t have backups of these two files, you can deploy a new Pigsty and migrate the existing cluster to the new deployment via <a href=/docs/pgsql/config/#backup-cluster>Backup Cluster</a>.</p><p>Please regularly backup the <code>pigsty</code> directory (e.g., using Git for version control). Learn from this and avoid such mistakes in the future.</p></blockquote><h4 id=configuration-repair>Configuration Repair</h4><p>You can use the surviving node as the new admin node, copy the <code>~/pigsty</code> directory to the new admin node, then start adjusting the configuration. For example, replace the original default admin node <code>10.10.10.10</code> with the surviving node <code>10.10.10.12</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Use new admin node address</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_etc_hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span><span style=color:#000>h.pigsty a.pigsty p.pigsty g.pigsty sss.pigsty]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># Also modify other configs referencing old admin IP (10.10.10.10)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                              </span><span style=color:#8f5902;font-style:italic># Adjust Infra cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># 10.10.10.10: { infra_seq: 1 } # Old Infra node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># New Infra node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># Adjust ETCD cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.10: { etcd_seq: 1 }   # Comment out this failed node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { etcd_seq: 2 }   # Comment out this failed node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Keep surviving node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># Adjust PGSQL cluster configuration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.10: { pg_seq: 1, pg_role: primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { pg_seq: 2, pg_role: replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.12: { pg_seq: 3, pg_role: replica , pg_offline_query: true }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: primary , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h4 id=etcd-repair>ETCD Repair</h4><p>Then execute the following command to reset ETCD to a single-node cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml -e <span style=color:#000>etcd_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> -e <span style=color:#000>etcd_clean</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><p>Follow the instructions in <a href=/docs/etcd/admin#reload-config>ETCD Reload Configuration</a> to adjust ETCD Endpoint references.</p><h4 id=infra-repair>INFRA Repair</h4><p>If the surviving node doesn&rsquo;t have the INFRA module, configure and install a new INFRA module on the current node. Execute the following command to deploy the INFRA module to the surviving node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -l 10.10.10.12
</span></span></code></pre></div><p>Repair monitoring on the current node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_monitor
</span></span></code></pre></div><h4 id=pgsql-repair>PGSQL Repair</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_conf                            <span style=color:#8f5902;font-style:italic># Regenerate PG configuration files</span>
</span></span><span style=display:flex><span>systemctl reload patroni                          <span style=color:#8f5902;font-style:italic># Reload Patroni configuration on surviving node</span>
</span></span></code></pre></div><p>After repairing each module, you can follow the standard expansion process to add new nodes to the cluster and restore cluster high availability.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b4eeb541b5d47f6b2e5017106913ea72>9.7 - Bind a L2 VIP to PostgreSQL Primary with VIP-Manager</h1><p>You can define an <strong>OPTIONAL</strong> L2 VIP on a PostgreSQL cluster, provided that all nodes in the cluster are in the same L2 network.</p><p>This VIP works on Master-Backup mode and always points to the node where the primary instance of the database cluster is located.</p><p>This VIP is managed by the <a href=https://github.com/cybertec-postgresql/vip-manager>VIP-Manager</a>, which reads the Leader Key written by Patroni from DCS (etcd) to determine whether it is the master.</p><hr><h2 id=enable-vip>Enable VIP</h2><p>Define <a href=/docs/pgsql/param#pg_vip_enabled><code>pg_vip_enabled</code></a> parameter as <code>true</code> in the cluster level to enable the VIP component on the cluster. You can also enable this configuration in the global configuration.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgsql 3 node ha cluster: pg-test</span>
</span></span><span style=display:flex><span>pg-test:
</span></span><span style=display:flex><span>  hosts:
</span></span><span style=display:flex><span>    10.10.10.11: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 1, pg_role: primary <span style=color:#ce5c00;font-weight:700>}</span>   <span style=color:#8f5902;font-style:italic># primary instance, leader of cluster</span>
</span></span><span style=display:flex><span>    10.10.10.12: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 2, pg_role: replica <span style=color:#ce5c00;font-weight:700>}</span>   <span style=color:#8f5902;font-style:italic># replica instance, follower of leader</span>
</span></span><span style=display:flex><span>    10.10.10.13: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 3, pg_role: replica, pg_offline_query: <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic># replica with offline access</span>
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    pg_cluster: pg-test           <span style=color:#8f5902;font-style:italic># define pgsql cluster name</span>
</span></span><span style=display:flex><span>    pg_users:  <span style=color:#ce5c00;font-weight:700>[{</span> name: <span style=color:#204a87>test</span> , password: <span style=color:#204a87>test</span> , pgbouncer: <span style=color:#204a87>true</span> , roles: <span style=color:#ce5c00;font-weight:700>[</span> dbrole_admin <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>}]</span>
</span></span><span style=display:flex><span>    pg_databases: <span style=color:#ce5c00;font-weight:700>[{</span> name: <span style=color:#204a87>test</span> <span style=color:#ce5c00;font-weight:700>}]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Enable L2 VIP</span>
</span></span><span style=display:flex><span>    pg_vip_enabled: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>    pg_vip_address: 10.10.10.3/24
</span></span><span style=display:flex><span>    pg_vip_interface: eth1
</span></span></code></pre></div><p>Beware that <a href=/docs/pgsql/param#pg_vip_address><code>pg_vip_address</code></a> must be a valid IP address with subnet and available in the current L2 network.</p><p>Beware that <a href=/docs/pgsql/param#pg_vip_interface><code>pg_vip_interface</code></a> must be a valid network interface name and should be the same as the one using IPv4 address in the inventory.</p><p>If the network interface name is different among cluster members, users should explicitly specify the <code>pg_vip_interface</code> parameter for each instance, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth0  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ens33 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># define pgsql cluster name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: test , password: test , pgbouncer: true , roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Enable L2 VIP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.3</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#pg_vip_interface: eth1</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To refresh the VIP configuration and restart the VIP-Manager, use the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_vip
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1a6ecaf250187005e255b6c6eafd53e2>9.8 - Deploy HA Citus Cluster</h1><div class=lead>How to deploy a Citus high-availability distributed cluster?</div><p>Citus is a PostgreSQL extension that transforms PostgreSQL into a distributed database, enabling horizontal scaling across multiple nodes to handle large amounts of data and queries.</p><p>Patroni v3.0+ provides native high-availability support for Citus, simplifying the setup of Citus clusters. Pigsty also provides native support for this.</p><ul><li><a href=https://docs.citusdata.com/en/stable/get_started/what_is_citus.html>What is Citus</a></li><li><a href=https://patroni.readthedocs.io/en/latest/citus.html>Patroni Citus Support</a></li></ul><blockquote><p>Note: The current Citus version (13.0) supports PostgreSQL 17, 16, 15, and 14. Pigsty extension repo provides Citus ARM64 packages.</p></blockquote><hr><h2 id=citus-cluster>Citus Cluster</h2><p>Pigsty natively supports Citus. See <a href=https://github.com/pgsty/pigsty/blob/main/conf/citus.yml><code>conf/citus.yml</code></a> for reference.</p><p>Here we use the Pigsty 4-node sandbox to define a Citus cluster <code>pg-citus</code>, which includes a 2-node coordinator cluster <code>pg-citus0</code> and two Worker clusters <code>pg-citus1</code> and <code>pg-citus2</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.2/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.2/24 ,pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.3/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.4/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                            # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># citus 13.0 supports PG 14-17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                        # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable vip for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip interface for all members</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, postgis, pgvector, topn, pg_cron, hll ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install these extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, pg_cron, pg_stat_statements&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_citus ,password: DBUser.Citus ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ]    }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: citus ,owner: dbuser_citus ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, vector, topn, pg_cron, hll ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>citus.node_conninfo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslmode=require sslrootcert=/pg/cert/ca.crt sslmode=verify-full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Compared to standard PostgreSQL clusters, Citus cluster configuration has some special requirements. First, you need to ensure the Citus extension is downloaded, installed, loaded, and enabled, which involves the following four parameters:</p><ul><li><a href=/docs/infra/param#repo_packages><code>repo_packages</code></a>: Must include the <code>citus</code> extension, or you need to use a PostgreSQL offline package that includes Citus.</li><li><a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a>: Must include the <code>citus</code> extension, i.e., you must install the <code>citus</code> extension on each node.</li><li><a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a>: Must include the <code>citus</code> extension at the first position, though Patroni now handles this automatically.</li><li><a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a>: Define a primary database that must have the <code>citus</code> extension installed.</li></ul><p>Second, you need to ensure the Citus cluster is configured correctly:</p><ul><li><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a>: Must be set to <code>citus</code> to tell Patroni to use Citus mode.</li><li><a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a>: Must specify the name of the primary database with <code>citus</code> extension, named <code>citus</code> here.</li><li><a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a>: Must specify a unified name as the cluster name prefix for all horizontal shard PG clusters, <code>pg-citus</code> here.</li><li><a href=/docs/pgsql/param#pg_group><code>pg_group</code></a>: Must specify a shard number, integers starting from zero. <code>0</code> represents the coordinator cluster, others are Worker clusters.</li><li><a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a>: Must correspond to the combination of <a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a> and <a href=/docs/pgsql/param#pg_group><code>pg_group</code></a>.</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>: Must be set to a non-empty plaintext password, otherwise Citus will not work properly.</li><li><a href=/docs/pgsql/param#pg_parameters><code>pg_parameters</code></a>: Recommended to set <code>citus.node_conninfo</code> to enforce SSL access and require node-to-node client certificate verification.</li></ul><p>After configuration, you can deploy the Citus cluster using <code>pgsql.yml</code> just like a regular PostgreSQL cluster.</p><hr><h2 id=manage-citus-cluster>Manage Citus Cluster</h2><p>After defining the Citus cluster, deploy it using the <code>pgsql.yml</code> playbook:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-citus    <span style=color:#8f5902;font-style:italic># Deploy Citus cluster pg-citus</span>
</span></span></code></pre></div><p>Using any member&rsquo;s DBSU (<code>postgres</code>) user, you can list the Citus cluster status with <code>patronictl</code> (alias: <code>pg</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg list
</span></span><span style=display:flex><span>+ Citus cluster: pg-citus ----------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Group <span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State     <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB <span style=color:#000;font-weight:700>|</span> Tags               <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> pg-citus0-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 20C.40G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> pg-citus1-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> pg-citus2-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> pg-citus2-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> streaming <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span></code></pre></div><p>You can treat each horizontal shard cluster as an independent PGSQL cluster and manage them with the <code>pg</code> (<code>patronictl</code>) command. Note that when using the <code>pg</code> command to manage Citus clusters, you need to use the <code>--group</code> parameter to specify the cluster shard number:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list pg-citus --group <span style=color:#0000cf;font-weight:700>0</span>   <span style=color:#8f5902;font-style:italic># Use --group 0 to specify cluster shard number</span>
</span></span></code></pre></div><p>Citus has a system table called <code>pg_dist_node</code> that records Citus cluster node information. Patroni automatically maintains this table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PGURL</span><span style=color:#ce5c00;font-weight:700>=</span>postgres://postgres:DBUser.Postgres@10.10.10.10/citus
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql <span style=color:#000>$PGURL</span> -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_node;&#39;</span>       <span style=color:#8f5902;font-style:italic># View node information</span>
</span></span><span style=display:flex><span> nodeid <span style=color:#000;font-weight:700>|</span> groupid <span style=color:#000;font-weight:700>|</span>  nodename   <span style=color:#000;font-weight:700>|</span> nodeport <span style=color:#000;font-weight:700>|</span> noderack <span style=color:#000;font-weight:700>|</span> hasmetadata <span style=color:#000;font-weight:700>|</span> isactive <span style=color:#000;font-weight:700>|</span> noderole  <span style=color:#000;font-weight:700>|</span> nodecluster <span style=color:#000;font-weight:700>|</span> metadatasynced <span style=color:#000;font-weight:700>|</span> shouldhaveshards
</span></span><span style=display:flex><span>--------+---------+-------------+----------+----------+-------------+----------+-----------+-------------+----------------+------------------
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> secondary <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span></code></pre></div><p>You can also view user authentication information (superuser access only):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ psql <span style=color:#000>$PGURL</span> -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_authinfo;&#39;</span>   <span style=color:#8f5902;font-style:italic># View node auth info (superuser only)</span>
</span></span></code></pre></div><p>Then you can use a regular business user (e.g., <code>dbuser_citus</code> with DDL privileges) to access the Citus cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_node;&#39;</span>
</span></span></code></pre></div><hr><h2 id=using-citus-cluster>Using Citus Cluster</h2><p>When using Citus clusters, we strongly recommend reading the <a href=https://docs.citusdata.com/en/stable/get_started/concepts.html>Citus official documentation</a> to understand its architecture and core concepts.</p><p>The key is understanding the five types of tables in Citus and their characteristics and use cases:</p><ul><li>Distributed Table</li><li>Reference Table</li><li>Local Table</li><li>Local Management Table</li><li>Schema Table</li></ul><p>On the coordinator node, you can create distributed tables and reference tables and query them from any data node. Since 11.2, any Citus database node can act as a coordinator.</p><p>We can use pgbench to create some tables and distribute the main table (<code>pgbench_accounts</code>) across nodes, then use other small tables as reference tables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PGURL</span><span style=color:#ce5c00;font-weight:700>=</span>postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus
</span></span><span style=display:flex><span>pgbench -i <span style=color:#000>$PGURL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql <span style=color:#000>$PGURL</span> <span style=color:#4e9a06>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_distributed_table(&#39;pgbench_accounts&#39;, &#39;aid&#39;); SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_accounts&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_branches&#39;)         ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_branches&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_history&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_history&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_tellers&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_tellers&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Run read/write tests:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus      <span style=color:#8f5902;font-style:italic># Direct connect to coordinator port 5432</span>
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.10:6432/citus <span style=color:#8f5902;font-style:italic># Through connection pool, reduce client connection pressure</span>
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.13/citus      <span style=color:#8f5902;font-style:italic># Any primary node can act as coordinator</span>
</span></span><span style=display:flex><span>pgbench --select-only -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.11/citus <span style=color:#8f5902;font-style:italic># Read-only queries</span>
</span></span></code></pre></div><hr><h2 id=production-deployment>Production Deployment</h2><p>For production use of Citus, you typically need to set up streaming replication physical replicas for the Coordinator and each Worker cluster.</p><p>For example, <a href=https://github.com/pgsty/pigsty/blob/main/conf/simu.yml><code>simu.yml</code></a> defines a 10-node Citus cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.50</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.51</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.52</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.53</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.54</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.55</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.56</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.57</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.58</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.59</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                            # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># citus 13.0 supports PG 14-17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                        # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable vip for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip interface for all members</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># enable dbsu password access for citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, postgis, pgvector, topn, pg_cron, hll ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install these extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, pg_cron, pg_stat_statements&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_citus ,password: DBUser.Citus ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ]    }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: citus ,owner: dbuser_citus ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, vector, topn, pg_cron, hll ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>citus.node_conninfo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslrootcert=/pg/cert/ca.crt sslmode=verify-full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>We will cover a series of advanced Citus topics in subsequent tutorials:</p><ul><li>Read/write separation</li><li>Failure handling</li><li>Consistent backup and recovery</li><li>Advanced monitoring and diagnostics</li><li>Connection pooling</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ecaf10982eb41799d970bf83186f0f12>10 - Reference</h1><p>Parameters and reference documentation</p></div><div class=td-content style=page-break-before:always><h1 id=pg-318a92a644bd3692615ad49e01f0f4e1>11 - Monitoring</h1><div class=lead>Overview of Pigsty&rsquo;s monitoring system architecture and how to monitor existing PostgreSQL instances</div><p>This document introduces Pigsty&rsquo;s monitoring system architecture, including metrics, logs, and target management. It also covers how to <a href=#monitor-existing-cluster>monitor existing PG clusters</a> and remote <a href=#monitor-rds>RDS services</a>.</p><hr><h2 id=monitoring-overview>Monitoring Overview</h2><p>Pigsty uses a modern observability stack for PostgreSQL monitoring:</p><ul><li>Grafana for metrics visualization and PostgreSQL datasource</li><li>VictoriaMetrics for collecting metrics from PostgreSQL / Pgbouncer / Patroni / HAProxy / Node</li><li>VictoriaLogs for logging PostgreSQL / Pgbouncer / Patroni / pgBackRest and host component logs</li><li>Battery-included Grafana <a href=/docs/pgsql/monitor/dashboard>dashboards</a> showcasing all aspects of PostgreSQL</li></ul><p><strong>Metrics</strong></p><p>PostgreSQL monitoring metrics are fully defined by the pg_exporter configuration file: <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg_exporter.yml><code>pg_exporter.yml</code></a>
They are further processed by Prometheus recording rules and alert rules: <a href=https://github.com/pgsty/pigsty/blob/main/files/prometheus/rules/pgsql.yml><code>files/prometheus/rules/pgsql.yml</code></a>.</p><p>Pigsty uses three identity labels: <code>cls</code>, <code>ins</code>, <code>ip</code>, which are attached to all metrics and logs. Additionally, metrics from Pgbouncer, host nodes (NODE), and load balancers are also used by Pigsty, with the same labels used whenever possible for correlation analysis.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-meta-1, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-test-1, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-test-2, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-test-3, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.13</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Logs</strong></p><p>PostgreSQL-related logs are collected by Vector and sent to the VictoriaLogs log storage/query service on infra nodes.</p><ul><li><a href=/docs/pgsql/param#pg_log_dir><code>pg_log_dir</code></a>: postgres log directory, defaults to <code>/pg/log/postgres</code></li><li><a href=/docs/pgsql/param#pgbouncer_log_dir><code>pgbouncer_log_dir</code></a>: pgbouncer log directory, defaults to <code>/pg/log/pgbouncer</code></li><li><a href=/docs/pgsql/param#patroni_log_dir><code>patroni_log_dir</code></a>: patroni log directory, defaults to <code>/pg/log/patroni</code></li><li><a href=/docs/pgsql/param#pgbackrest_log_dir><code>pgbackrest_log_dir</code></a>: pgbackrest log directory, defaults to <code>/pg/log/pgbackrest</code></li></ul><p><strong>Target Management</strong></p><p>Prometheus monitoring targets are defined in static files under <code>/etc/prometheus/targets/pgsql/</code>, with each instance having a corresponding file. Taking <code>pg-meta-1</code> as an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-meta-1 [primary] @ 10.10.10.10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-meta-1, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>targets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- pg_exporter for PostgreSQL metrics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9631</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- pg_exporter for pgbouncer metrics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>8008</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- patroni metrics (when API SSL is not enabled)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When the global flag <a href=/docs/pgsql/param#patroni_ssl_enabled><code>patroni_ssl_enabled</code></a> is set, patroni targets will be moved to a separate file <code>/etc/prometheus/targets/patroni/&lt;ins>.yml</code>, as it uses the https scrape endpoint. When <a href=#monitor-rds>monitoring RDS</a> instances, monitoring targets are placed separately in the <code>/etc/prometheus/targets/pgrds/</code> directory and managed by <strong>cluster</strong>.</p><p>When removing a cluster using <code>bin/pgsql-rm</code> or <code>pgsql-rm.yml</code>, the Prometheus monitoring targets will be removed. You can also remove them manually or use subtasks from the playbook:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-rm &lt;cls<span style=color:#000;font-weight:700>|</span>ins&gt;    <span style=color:#8f5902;font-style:italic># Remove prometheus monitoring targets from all infra nodes</span>
</span></span></code></pre></div><p>Remote RDS monitoring targets are placed in <code>/etc/prometheus/targets/pgrds/&lt;cls>.yml</code>, created by the <a href=/docs/pgsql/playbook#pgsql-monitor><code>pgsql-monitor.yml</code></a> playbook or <code>bin/pgmon-add</code> script.</p><hr><h2 id=monitoring-modes>Monitoring Modes</h2><p>Pigsty provides three monitoring modes to suit different monitoring needs.</p><table><thead><tr><th style=text-align:center>Item \ Level</th><th style=text-align:center>L1</th><th style=text-align:center>L2</th><th style=text-align:center>L3</th></tr></thead><tbody><tr><td style=text-align:center>Name</td><td style=text-align:center><a href=#monitor-rds>Basic</a></td><td style=text-align:center><a href=#monitor-existing-cluster>Managed</a></td><td style=text-align:center><strong>Standard</strong></td></tr><tr><td style=text-align:center>Abbr</td><td style=text-align:center><strong>RDS</strong></td><td style=text-align:center><strong>MANAGED</strong></td><td style=text-align:center><strong>FULL</strong></td></tr><tr><td style=text-align:center>Scenario</td><td style=text-align:center>Connection string only, e.g., RDS</td><td style=text-align:center>Existing DB, nodes manageable</td><td style=text-align:center>Instances created by Pigsty</td></tr><tr><td style=text-align:center>PGCAT Features</td><td style=text-align:center>✅ Fully Available</td><td style=text-align:center>✅ Fully Available</td><td style=text-align:center>✅ Fully Available</td></tr><tr><td style=text-align:center>PGSQL Features</td><td style=text-align:center>✅ PG metrics only</td><td style=text-align:center>✅ PG & node metrics only</td><td style=text-align:center>✅ Full Features</td></tr><tr><td style=text-align:center>Connection Pool Metrics</td><td style=text-align:center>❌ Not Available</td><td style=text-align:center>⚠️ Optional</td><td style=text-align:center>✅ Pre-installed</td></tr><tr><td style=text-align:center>Load Balancer Metrics</td><td style=text-align:center>❌ Not Available</td><td style=text-align:center>⚠️ Optional</td><td style=text-align:center>✅ Pre-installed</td></tr><tr><td style=text-align:center>PGLOG Features</td><td style=text-align:center>❌ Not Available</td><td style=text-align:center>⚠️ Optional</td><td style=text-align:center>✅ Pre-installed</td></tr><tr><td style=text-align:center>PG Exporter</td><td style=text-align:center>⚠️ On infra nodes</td><td style=text-align:center>✅ On DB nodes</td><td style=text-align:center>✅ On DB nodes</td></tr><tr><td style=text-align:center>Node Exporter</td><td style=text-align:center>❌ Not deployed</td><td style=text-align:center>✅ On DB nodes</td><td style=text-align:center>✅ On DB nodes</td></tr><tr><td style=text-align:center>Intrusiveness</td><td style=text-align:center>✅ Non-intrusive</td><td style=text-align:center>⚠️ Install Exporter</td><td style=text-align:center>⚠️ Fully managed by Pigsty</td></tr><tr><td style=text-align:center>Monitor Existing Instances</td><td style=text-align:center>✅ Supported</td><td style=text-align:center>✅ Supported</td><td style=text-align:center>❌ For Pigsty-managed only</td></tr><tr><td style=text-align:center>Monitoring Users & Views</td><td style=text-align:center>Manual setup</td><td style=text-align:center>Manual setup</td><td style=text-align:center>Auto-created by Pigsty</td></tr><tr><td style=text-align:center>Deployment Playbook</td><td style=text-align:center><code>bin/pgmon-add &lt;cls></code></td><td style=text-align:center>Partial <code>pgsql.yml</code>/<code>node.yml</code></td><td style=text-align:center><code>pgsql.yml</code></td></tr><tr><td style=text-align:center>Required Permissions</td><td style=text-align:center>Connectable PGURL from infra</td><td style=text-align:center>SSH & sudo on DB nodes</td><td style=text-align:center>SSH & sudo on DB nodes</td></tr><tr><td style=text-align:center>Feature Summary</td><td style=text-align:center>PGCAT + PGRDS</td><td style=text-align:center>Most features</td><td style=text-align:center>Full features</td></tr></tbody></table><p>Databases fully managed by Pigsty are automatically monitored with the best support and typically require no configuration. For existing PostgreSQL clusters or RDS services, if the target DB nodes <strong>can be managed by Pigsty</strong> (ssh accessible, sudo available), you can consider <a href=#monitor-existing-cluster>managed deployment</a> for a monitoring experience similar to native Pigsty. If you <strong>can only access the target database via PGURL</strong> (database connection string), such as remote RDS services, you can use <a href=#monitor-rds>basic mode</a> to monitor the target database.</p><hr><h2 id=monitor-existing-cluster>Monitor Existing Cluster</h2><p><strong>If the target DB nodes can be managed by Pigsty</strong> (<code>ssh</code> accessible and <code>sudo</code> available), you can use the <code>pg_exporter</code> task in the <a href=/docs/pgsql/playbook#pgsqlyml><code>pgsql.yml</code></a> playbook to deploy monitoring components (PG Exporter) on target nodes in the same way as standard deployments. You can also use the <code>pgbouncer</code> and <code>pgbouncer_exporter</code> tasks from that playbook to deploy connection pools and their monitoring on existing instance nodes. Additionally, you can use <code>node_exporter</code>, <code>haproxy</code>, and <code>vector</code> from <a href=/docs/node/playbook#nodeyml><strong><code>node.yml</code></strong></a> to deploy host monitoring, load balancing, and log collection components, achieving an experience identical to native Pigsty database instances.</p><p>The definition method for existing clusters is exactly the same as for clusters managed by Pigsty. You selectively execute partial tasks from the <code>pgsql.yml</code> playbook instead of running the entire playbook.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml  -l &lt;cls&gt; -t node_repo,node_pkg           <span style=color:#8f5902;font-style:italic># Add YUM repos from INFRA nodes and install packages on host nodes</span>
</span></span><span style=display:flex><span>./node.yml  -l &lt;cls&gt; -t node_exporter,node_register  <span style=color:#8f5902;font-style:italic># Configure host monitoring and add to VictoriaMetrics</span>
</span></span><span style=display:flex><span>./node.yml  -l &lt;cls&gt; -t vector                       <span style=color:#8f5902;font-style:italic># Configure host log collection and send to VictoriaLogs</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_exporter,pg_register      <span style=color:#8f5902;font-style:italic># Configure PostgreSQL monitoring and register with VictoriaMetrics/Grafana</span>
</span></span></code></pre></div><p>Since the target database cluster already exists, you need to manually <a href=#monitor-setup>create monitoring users, schemas, and extensions</a> on the target database cluster.</p><hr><h2 id=monitor-rds>Monitor RDS</h2><p>If you <strong>can only access the target database via PGURL</strong> (database connection string), you can configure according to the instructions here. In this mode, Pigsty deploys corresponding PG Exporters on <a href=/docs/concept/arch/node#infra-node><strong>INFRA nodes</strong></a> to scrape remote database metrics, as shown below:</p><pre tabindex=0><code>------ infra ------
|                 |
|   prometheus    |            v---- pg-foo-1 ----v
|       ^         |  metrics   |         ^        |
|   pg_exporter &lt;-|------------|----  postgres    |
|   (port: 20001) |            | 10.10.10.10:5432 |
|       ^         |            ^------------------^
|       ^         |                      ^
|       ^         |            v---- pg-foo-2 ----v
|       ^         |  metrics   |         ^        |
|   pg_exporter &lt;-|------------|----  postgres    |
|   (port: 20002) |            | 10.10.10.11:5433 |
-------------------            ^------------------^
</code></pre><p>In this mode, the monitoring system will not have metrics from hosts, connection pools, load balancers, or high availability components, but the database itself and real-time status information from the data catalog are still available. Pigsty provides two dedicated monitoring dashboards focused on PostgreSQL metrics: <a href=https://demo.pigsty.io/d/pgrds-cluster>PGRDS Cluster</a> and <a href=https://demo.pigsty.io/d/pgrds-instance>PGRDS Instance</a>, while overview and database-level monitoring reuses existing dashboards. Since Pigsty cannot manage your RDS, users need to <a href=#monitor-setup>configure monitoring objects</a> on the target database in advance.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Limitations when monitoring external Postgres instances</div><ul><li>pgBouncer connection pool metrics are not available</li><li>Patroni high availability component metrics are not available</li><li>Host node monitoring metrics are not available, including node HAProxy and Keepalived metrics</li><li>Log collection and log-derived metrics are not available</li></ul></div><p>Here we use the sandbox environment as an example: suppose the <code>pg-meta</code> cluster is an RDS instance <code>pg-foo-1</code> to be monitored, and the <code>pg-test</code> cluster is an RDS cluster <code>pg-bar</code> to be monitored:</p><ol><li><p>Create monitoring schemas, users, and permissions on the target. Refer to <a href=#monitor-setup>Monitor Setup</a> for details</p></li><li><p>Declare the cluster in the configuration inventory. For example, if we want to monitor &ldquo;remote&rdquo; <code>pg-meta</code> & <code>pg-test</code> clusters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Infra cluster for proxies, monitoring, alerts, etc.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Install pg_exporter on group &#39;infra&#39; for remote postgres RDS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># List all remote instances here, assign a unique unused local port for k</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 1, pg_host: 10.10.10.10 , pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta }] }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Register meta database as Grafana datasource</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20002</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 1, pg_host: 10.10.10.11 , pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Different connection string methods</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20003</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 2, pg_host: 10.10.10.12 , pg_exporter_url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres://dbuser_monitor:DBUser.Monitor@10.10.10.12:5432/postgres?sslmode=disable&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20004</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 3, pg_host: 10.10.10.13 , pg_monitor_username: dbuser_monitor, pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Databases listed in the <code>pg_databases</code> field will be registered in Grafana as PostgreSQL datasources, providing data support for PGCAT monitoring dashboards. If you don&rsquo;t want to use PGCAT and register databases in Grafana, simply set <code>pg_databases</code> to an empty array or leave it blank.</p><p><img src=/img/pigsty/monitor.jpg alt=pigsty-monitor.jpg></p></li><li><p>Execute the add monitoring command: <code>bin/pgmon-add &lt;clsname></code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-add pg-foo  <span style=color:#8f5902;font-style:italic># Bring pg-foo cluster into monitoring</span>
</span></span><span style=display:flex><span>bin/pgmon-add pg-bar  <span style=color:#8f5902;font-style:italic># Bring pg-bar cluster into monitoring</span>
</span></span></code></pre></div></li><li><p>To remove remote cluster monitoring targets, use <code>bin/pgmon-rm &lt;clsname></code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-rm pg-foo  <span style=color:#8f5902;font-style:italic># Remove pg-foo from Pigsty monitoring</span>
</span></span><span style=display:flex><span>bin/pgmon-rm pg-bar  <span style=color:#8f5902;font-style:italic># Remove pg-bar from Pigsty monitoring</span>
</span></span></code></pre></div></li></ol><p>You can use more parameters to override default <code>pg_exporter</code> options. Here&rsquo;s an example configuration for monitoring Aliyun RDS for PostgreSQL and PolarDB with Pigsty:</p><details><summary>Example: Monitoring Aliyun RDS for PostgreSQL and PolarDB</summary><p>For details, refer to: <a href=https://github.com/pgsty/pigsty/blob/main/conf/demo/remote.yml>remote.yml</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Infra cluster for proxies, monitoring, alerts, etc.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># List all remote RDS PG instances to be monitored here</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># Assign a unique unused local port for local monitoring agent, this is a PolarDB primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-polar                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS cluster name (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS instance number (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pc-2ze379wb1d4irc18x.polardbpg.rds.aliyuncs.com</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS host address</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1921</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS port (from console connection info)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Disable new database auto-discovery feature</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;test&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Only monitor databases in this list (comma-separated)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Monitoring username, overrides global config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser_Monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Monitoring password, overrides global config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test }]       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># List of databases to enable PGCAT for, only name field needed, set register_datasource to false to not register</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20002</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># This is a PolarDB standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-polar                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS cluster name (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS instance number (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pe-2ze7tg620e317ufj4.polarpgmxs.rds.aliyuncs.com</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS host address</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1521</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS port (from console connection info)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Disable new database auto-discovery feature</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;test,postgres&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Only monitor databases in this list (comma-separated)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Monitoring username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser_Monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Monitoring password</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test } ]       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># List of databases to enable PGCAT for, only name field needed, set register_datasource to false to not register</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20004</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># This is a basic single-node RDS for PostgreSQL instance</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-rds                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS cluster name (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS instance number (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgm-2zern3d323fe9ewk.pg.rds.aliyuncs.com </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS host address</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS port (from console connection info)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Disable new database auto-discovery feature</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;rds&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Only monitor databases in this list (comma-separated)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Monitoring username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser_Monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Monitoring password</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>rds } ]      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># List of databases to enable PGCAT for, only name field needed, set register_datasource to false to not register</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20005</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># This is a high-availability RDS for PostgreSQL cluster primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-rdsha                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS cluster name (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS instance number (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgm-2ze3d35d27bq08wu.pg.rds.aliyuncs.com </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS host address</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS port (from console connection info)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;rds&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Only monitor databases in this list (comma-separated)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>rds }, {name : test} ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Include these two databases in PGCAT management, register as Grafana datasources</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20006</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># This is a high-availability RDS for PostgreSQL cluster read-only instance (standby)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-rdsha                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS cluster name (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS instance number (identity parameter, manually assigned name in monitoring system)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgr-2zexqxalk7d37edt.pg.rds.aliyuncs.com </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS host address</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS port (from console connection info)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;rds&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Only monitor databases in this list (comma-separated)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>rds }, {name : test} ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Include these two databases in PGCAT management, register as Grafana datasources</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=monitor-setup>Monitor Setup</h2><p>When you want to monitor existing instances, whether RDS or self-built PostgreSQL instances, you need to configure the target database so that Pigsty can access them.</p><p>To monitor an external existing PostgreSQL instance, you need a connection string that can access that instance/cluster. Any accessible connection string (business user, superuser) can be used, but we recommend using a dedicated monitoring user to avoid permission leaks.</p><ul><li><input disabled type=checkbox> <a href=#monitor-user>Monitor User</a>: The default username is <code>dbuser_monitor</code>, which should belong to the <code>pg_monitor</code> role group or have access to relevant views</li><li><input disabled type=checkbox> <a href=#monitor-authentication>Monitor Authentication</a>: Default password authentication is used; ensure HBA policies allow the monitoring user to access databases from the admin node or DB node locally</li><li><input disabled type=checkbox> <a href=#monitor-schema>Monitor Schema</a>: Fixed schema name <code>monitor</code> is used for installing additional <strong>monitoring views</strong> and extension plugins; optional but recommended</li><li><input disabled type=checkbox> <a href=#monitor-extension>Monitor Extension</a>: <strong>Strongly recommended</strong> to enable the built-in monitoring extension <code>pg_stat_statements</code></li><li><input disabled type=checkbox> <a href=#monitor-views>Monitor Views</a>: Monitoring views are optional but can provide additional metric support</li></ul><h3 id=monitor-user>Monitor User</h3><p>Using the default monitoring user <code>dbuser_monitor</code> as an example, create the following user on the target database cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                                       </span><span style=color:#8f5902;font-style:italic>-- Create monitoring user
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;system monitor user&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- Comment on monitoring user
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic>-- Grant pg_monitor privilege to monitoring user, otherwise some metrics cannot be collected
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#000>PASSWORD</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;DBUser.Monitor&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- Modify monitoring user password as needed (strongly recommended! but keep consistent with Pigsty config)
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_min_duration_statement</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- Recommended to avoid logs filling up with monitoring slow queries
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>search_path</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- Recommended to ensure pg_stat_statements extension works properly
</span></span></span></code></pre></div><p>Please note that the monitoring user and password created here should be consistent with <a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a> and <a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a>.</p><hr><h3 id=monitor-authentication>Monitor Authentication</h3><p>Configure the database <code>pg_hba.conf</code> file, adding the following rules to allow the monitoring user to access all databases from localhost and the admin machine using password authentication.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow local role monitor with password</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local   all  dbuser_monitor                    md5</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host    all  dbuser_monitor  127.0.0.1/32      md5</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host    all  dbuser_monitor  &lt;admin_machine_IP&gt;/32 md5</span>
</span></span></code></pre></div><p>If your RDS doesn&rsquo;t support defining HBA, simply whitelist the internal IP address of the machine running Pigsty.</p><hr><h3 id=monitor-schema>Monitor Schema</h3><p>The monitoring schema is <strong>optional</strong>; even without it, the main functionality of Pigsty&rsquo;s monitoring system can work properly, but we strongly recommend creating this schema.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic>-- Create dedicated monitoring schema
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USAGE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- Allow monitoring user to use it
</span></span></span></code></pre></div><hr><h3 id=monitor-extension>Monitor Extension</h3><p>The monitoring extension is optional, but we strongly recommend enabling the <code>pg_stat_statements</code> extension, which provides important data about query performance.</p><p>Note: This extension must be listed in the database parameter <code>shared_preload_libraries</code> to take effect, and modifying that parameter requires a database restart.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg_stat_statements&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;monitor&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Please note that you should install this extension in the default admin database <code>postgres</code>. Sometimes RDS doesn&rsquo;t allow you to create a monitoring schema in the <code>postgres</code> database. In such cases, you can install the <code>pg_stat_statements</code> plugin in the default <code>public</code> schema, as long as you ensure the monitoring user&rsquo;s search_path is configured as above so it can find the <code>pg_stat_statements</code> view.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg_stat_statements&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>search_path</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>-- Recommended to ensure pg_stat_statements extension works properly
</span></span></span></code></pre></div><hr><h3 id=monitor-views>Monitor Views</h3><p>Monitoring views provide several commonly used pre-processed results and encapsulate permissions for monitoring metrics that require high privileges (such as shared memory allocation), making them convenient for querying and use. Strongly recommended to create in all databases requiring monitoring.</p><details><summary>Monitoring schema and monitoring view definitions</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Table bloat estimate : monitor.pg_table_bloat
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>CURRENT_CATALOG</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>relname</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>tblpages</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>tblpages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>est_tblpages_ff</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tblpages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>est_tblpages_ff</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tblpages</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>FLOAT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ratio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>ceil</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000>reltuples</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bs</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>page_hdr</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>fillfactor</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tpl_size</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>ceil</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000>toasttuples</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>est_tblpages_ff</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000>tblpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>fillfactor</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>is_na</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                  </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_hdr_size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_data_size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                          </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_hdr_size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_hdr_size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                          </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ceil</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tpl_data_size</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>INT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>ceil</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tpl_data_size</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>INT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                          </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>heappages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>toastpages</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>heappages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#000>toastpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>toasttuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>page_hdr</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>fillfactor</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>is_na</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                  </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ns</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relpages</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>heappages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>toastpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>toasttuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>substring</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>array_to_string</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reloptions</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39; &#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;fillfactor=([0-9]+)&#39;</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>smallint</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>fillfactor</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>current_setting</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;block_size&#39;</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>numeric</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>~</span><span style=color:#4e9a06>&#39;mingw32&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>~</span><span style=color:#4e9a06>&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>page_hdr</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>MAX</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>null_frac</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>int</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                   </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>bool_or</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;oid&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_hdr_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>null_frac</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>avg_width</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_data_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>bool_or</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>atttypid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_catalog.name&#39;</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regtype</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                   </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>is_na</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                    </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                    </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ns</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>ns</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relnamespace</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                    </span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>schemaname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>ns</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tablename</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inherited</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                    </span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reltoastrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attisdropped</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relkind</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;r&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg_catalog&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;information_schema&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                       </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>              </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>s2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#000>is_na</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres table bloat estimate&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Index bloat estimate : monitor.pg_index_bloat
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>CURRENT_CATALOG</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>idxid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>BIGINT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>COALESCE</span><span style=color:#000;font-weight:700>((</span><span style=color:#000>relpages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000>reltuples</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>index_tuple_hdr</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>index_tuple_hdr</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                               </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>nulldatawidth</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>nulldatawidth</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>nulldatawidth</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                  </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bs</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>pagehdr</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>FLOAT</span><span style=color:#f8f8f8>  </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>FLOAT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ratio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>idxname</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>indrelid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>indexrelid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idxid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000>current_setting</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;block_size&#39;</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>INTEGER</span><span style=color:#f8f8f8>                                                               </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>~</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;mingw32&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>~</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8>                                                                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>pagehdr</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>COALESCE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>null_frac</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                               </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>index_tuple_hdr</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>((</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>COALESCE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>null_frac</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>COALESCE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>avg_width</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>))::</span><span style=color:#204a87>INTEGER</span><span style=color:#f8f8f8>                                                     </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>nulldatawidth</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                  </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8>                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indrelid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indexrelid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>tc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8>                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tablename</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>regexp_split_to_table</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indkey</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>TEXT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39; &#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>::</span><span style=color:#f8f8f8> </span><span style=color:#204a87>INTEGER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>attnum</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indexrelid</span><span style=color:#f8f8f8>                                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>index_oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_index</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indexrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#000>tc</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relnamespace</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_am</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relam</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_am</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_am</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>amname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;btree&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relpages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg_catalog&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;information_schema&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indexrelid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                  </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>schemaname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>((</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tablename</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tablename</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_get_indexdef</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attrelid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TRUE</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                 </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tablename</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>idxname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>est</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres index bloat estimate (btree-only)&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Relation Bloat : monitor.pg_bloat
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                                                       </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>RegClass</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#f8f8f8>                                                                            </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>                 </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>BIGINT</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>idxid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8>                                                    </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#f8f8f8>                                                                            </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>                 </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>BIGINT</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_wasted</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>FULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OUTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres relation bloat detail&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- monitor.pg_index_bloat_human
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#f8f8f8>                            </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>tblname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>idx_wasted</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres index bloat info in human-readable format&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- monitor.pg_table_bloat_human
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>tblname</span><span style=color:#f8f8f8>                                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>idx_wasted</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#f8f8f8>                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>all_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                       </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                       </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_ratio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>tblname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>tblname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres table bloat info in human-readable format&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Activity Overview: monitor.pg_session
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_session</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_session</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>numbackends</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>active</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>idle</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ixact</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>max_duration</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>max_tx_duration</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>max_conn_duration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>numbackends</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>FILTER</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;active&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>       </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>active</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>FILTER</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;idle&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idle</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>FILTER</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;idle in transaction&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;idle in transaction (aborted)&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ixact</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>extract</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>epoch</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>state_change</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000>FILTER</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;active&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>max_duration</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>extract</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>epoch</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>xact_start</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>max_tx_duration</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>extract</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>epoch</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>backend_start</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>max_conn_duration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>backend_type</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;client backend&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>           </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>pid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_backend_pid</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLLUP</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#000>NULLS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FIRST</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_session</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres activity group by session&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_session</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Sequential Scan: monitor.pg_seq_scan
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>schemaname</span><span style=color:#f8f8f8>                                                        </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>seq_scan</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>seq_tup_read</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>seq_tup_read</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000>seq_scan</span><span style=color:#f8f8f8>                                           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>seq_tup_avg</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>idx_scan</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>n_live_tup</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>n_dead_tup</span><span style=color:#f8f8f8>                                           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n_live_tup</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n_live_tup</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>n_dead_tup</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>live_ratio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_user_tables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n_live_tup</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>n_dead_tup</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;table that have seq scan&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><details><summary>Function for viewing shared memory allocation (PG13 and above)</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RETURNS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SETOF</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>pg_shmem_allocations</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#a40000>$$</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_shmem_allocations</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>$$</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LANGUAGE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SQL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SECURITY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFINER</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;security wrapper for system view pg_shmem&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>REVOKE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PUBLIC</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXECUTE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details></div><div class=td-content style=page-break-before:always><h1 id=pg-536f1aee2f7b6fc9206c282f35fe3283>11.1 - Dashboards</h1><div class=lead>Pigsty provides many out-of-the-box Grafana monitoring dashboards for PostgreSQL</div><blockquote><p>Pigsty provides many out-of-the-box Grafana monitoring dashboards for PostgreSQL: <a href=https://demo.pigsty.io/d/pgsql-overview>Demo</a> & <a href=https://github.com/pgsty/pigsty/wiki/Gallery>Gallery</a>.</p></blockquote><p>There are 26 PostgreSQL-related monitoring dashboards in Pigsty, organized hierarchically into Overview, Cluster, Instance, and Database categories, and by data source into <a href=#overview>PGSQL</a>, <a href=#pgcat>PGCAT</a>, and <a href=#pglog>PGLOG</a> categories.</p><p><img src=/img/pigsty/dashboard.jpg alt=pigsty-dashboard.jpg></p><hr><h2 id=overview>Overview</h2><table><thead><tr><th style=text-align:center>Overview</th><th style=text-align:center>Cluster</th><th style=text-align:center>Instance</th><th style=text-align:center>Database</th></tr></thead><tbody><tr><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-overview>PGSQL Overview</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-cluster>PGSQL Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-instance>PGSQL Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-database>PGSQL Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-alert>PGSQL Alert</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgrds-cluster>PGRDS Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgrds-instance>PGRDS Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-database>PGCAT Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-shard>PGSQL Shard</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-activity>PGSQL Activity</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-instance>PGCAT Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-tables>PGSQL Tables</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-replication>PGSQL Replication</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-persist>PGSQL Persist</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-table>PGSQL Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-service>PGSQL Service</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-proxy>PGSQL Proxy</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-table>PGCAT Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-databases>PGSQL Databases</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-pgbouncer>PGSQL Pgbouncer</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-query>PGSQL Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-patroni>PGSQL Patroni</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-session>PGSQL Session</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-query>PGCAT Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-pitr>PGSQL PITR</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-xacts>PGSQL Xacts</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-locks>PGCAT Locks</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-exporter>PGSQL Exporter</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-schema>PGCAT Schema</a></td></tr></tbody></table><p><strong>Overview</strong></p><ul><li><a href=https://demo.pigsty.io/d/pgsql-overview>pgsql-overview</a>: Main dashboard for the PGSQL module</li><li><a href=https://demo.pigsty.io/d/pgsql-alert>pgsql-alert</a>: Global critical metrics and alert events for PGSQL</li><li><a href=https://demo.pigsty.io/d/pgsql-shard>pgsql-shard</a>: Overview of horizontally sharded PGSQL clusters, such as Citus / GPSQL clusters</li></ul><p><strong>Cluster</strong></p><ul><li><a href=https://demo.pigsty.io/d/pgsql-cluster>pgsql-cluster</a>: Main dashboard for a PGSQL cluster</li><li><a href=https://demo.pigsty.io/d/pgrds-cluster>pgrds-cluster</a>: RDS version of PGSQL Cluster, focused on all PostgreSQL-specific metrics</li><li><a href=https://demo.pigsty.io/d/pgsql-activity>pgsql-activity</a>: Focus on PGSQL cluster sessions/load/QPS/TPS/locks</li><li><a href=https://demo.pigsty.io/d/pgsql-replication>pgsql-replication</a>: Focus on PGSQL cluster replication, slots, and pub/sub</li><li><a href=https://demo.pigsty.io/d/pgsql-service>pgsql-service</a>: Focus on PGSQL cluster services, proxies, routing, and load balancing</li><li><a href=https://demo.pigsty.io/d/pgsql-databases>pgsql-databases</a>: Focus on database CRUD, slow queries, and table statistics across all instances</li><li><a href=https://demo.pigsty.io/d/pgsql-patroni>pgsql-patroni</a>: Focus on cluster high availability status and Patroni component status</li><li><a href=https://demo.pigsty.io/d/pgsql-pitr>pgsql-pitr</a>: Focus on cluster PITR process context for point-in-time recovery assistance</li></ul><p><strong>Instance</strong></p><ul><li><a href=https://demo.pigsty.io/d/pgsql-instance>pgsql-instance</a>: Main dashboard for a single PGSQL instance</li><li><a href=https://demo.pigsty.io/d/pgrds-instance>pgrds-instance</a>: RDS version of PGSQL Instance, focused on all PostgreSQL-specific metrics</li><li><a href=https://demo.pigsty.io/d/pgcat-instance>pgcat-instance</a>: Instance information retrieved directly from the database catalog</li><li><a href=https://demo.pigsty.io/d/pgsql-proxy>pgsql-proxy</a>: Detailed metrics for a single HAProxy load balancer</li><li><a href=https://demo.pigsty.io/d/pgsql-pgbouncer>pgsql-pgbouncer</a>: Metrics overview in a single Pgbouncer connection pool instance</li><li><a href=https://demo.pigsty.io/d/pgsql-persist>pgsql-persist</a>: Persistence metrics: WAL, XID, checkpoints, archiving, IO</li><li><a href=https://demo.pigsty.io/d/pgsql-session>pgsql-session</a>: Session and active/idle time metrics in a single instance</li><li><a href=https://demo.pigsty.io/d/pgsql-xacts>pgsql-xacts</a>: Metrics related to transactions, locks, TPS/QPS</li><li><a href=https://demo.pigsty.io/d/pgsql-exporter>pgsql-exporter</a>: Self-monitoring metrics for Postgres and Pgbouncer monitoring components</li></ul><p><strong>Database</strong></p><ul><li><a href=https://demo.pigsty.io/d/pgsql-database>pgsql-database</a>: Main dashboard for a single PGSQL database</li><li><a href=https://demo.pigsty.io/d/pgcat-database>pgcat-database</a>: Database information retrieved directly from the database catalog</li><li><a href=https://demo.pigsty.io/d/pgsql-tables>pgsql-tables</a>: Table/index access metrics within a single database</li><li><a href=https://demo.pigsty.io/d/pgsql-table>pgsql-table</a>: Details of a single table (QPS/RT/index/sequences&mldr;)</li><li><a href=https://demo.pigsty.io/d/pgcat-table>pgcat-table</a>: Details of a single table retrieved directly from the database catalog (stats/bloat&mldr;)</li><li><a href=https://demo.pigsty.io/d/pgsql-query>pgsql-query</a>: Details of a single query (QPS/RT)</li><li><a href=https://demo.pigsty.io/d/pgcat-query>pgcat-query</a>: Details of a single query retrieved directly from the database catalog (SQL/stats)</li><li><a href=https://demo.pigsty.io/d/pgcat-schema>pgcat-schema</a>: Information about schemas retrieved directly from the database catalog (tables/indexes/sequences&mldr;)</li><li><a href=https://demo.pigsty.io/d/pgcat-locks>pgcat-locks</a>: Information about activities and lock waits retrieved directly from the database catalog</li></ul><hr><h2 id=overview-1>Overview</h2><p><a href=https://demo.pigsty.io/d/pgsql-overview>PGSQL Overview</a>: Main dashboard for the PGSQL module</p><details><summary>PGSQL Overview</summary><p><a href=https://demo.pigsty.io/d/pgsql-overview><img src=/img/dashboard/pgsql-overview.jpg alt=pgsql-overview.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-alert>PGSQL Alert</a>: Global critical metrics overview and alert event listing for PGSQL</p><details><summary>PGSQL Alert</summary><p><a href=https://demo.pigsty.io/d/pgsql-alert><img src=/img/dashboard/pgsql-alert.jpg alt=pgsql-alert.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-shard>PGSQL Shard</a>: Shows horizontal metric comparisons within a PGSQL horizontally sharded cluster, such as CITUS / GPSQL clusters</p><details><summary>PGSQL Shard</summary><p><a href=https://demo.pigsty.io/d/pgsql-shard><img src=/img/dashboard/pgsql-shard.jpg alt=pgsql-shard.jpg></a></p></details><hr><h2 id=cluster>Cluster</h2><p><a href=https://demo.pigsty.io/d/pgsql-cluster>PGSQL Cluster</a>: Main dashboard for a PGSQL cluster</p><details><summary>PGSQL Cluster</summary><p><a href=https://demo.pigsty.io/d/pgsql-cluster><img src=/img/dashboard/pgsql-cluster.jpg alt=pgsql-cluster.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgrds-cluster>PGRDS Cluster</a>: RDS version of PGSQL Cluster, focused on all PostgreSQL-specific metrics</p><details><summary>PGRDS Cluster</summary><p><a href=https://demo.pigsty.io/d/pgrds-cluster><img src=/img/dashboard/pgrds-cluster.jpg alt=pgrds-cluster.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-service>PGSQL Service</a>: Focus on PGSQL cluster services, proxies, routing, and load balancing</p><details><summary>PGSQL Service</summary><p><a href=https://demo.pigsty.io/d/pgsql-service><img src=/img/dashboard/pgsql-service.jpg alt=pgsql-service.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-activity>PGSQL Activity</a>: Focus on PGSQL cluster sessions/load/QPS/TPS/locks</p><details><summary>PGSQL Activity</summary><p><a href=https://demo.pigsty.io/d/pgsql-activity><img src=/img/dashboard/pgsql-activity.jpg alt=pgsql-activity.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-replication>PGSQL Replication</a>: Focus on PGSQL cluster replication, slots, and pub/sub</p><details><summary>PGSQL Replication</summary><p><a href=https://demo.pigsty.io/d/pgsql-replication><img src=/img/dashboard/pgsql-replication.jpg alt=pgsql-replication.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-databases>PGSQL Databases</a>: Focus on database CRUD, slow queries, and table statistics across all instances</p><details><summary>PGSQL Databases</summary><p><a href=https://demo.pigsty.io/d/pgsql-databases><img src=/img/dashboard/pgsql-databases.jpg alt=pgsql-databases.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-patroni>PGSQL Patroni</a>: Focus on cluster high availability status and Patroni component status</p><details><summary>PGSQL Patroni</summary><p><a href=https://demo.pigsty.io/d/pgsql-patroni><img src=/img/dashboard/pgsql-patroni.jpg alt=pgsql-patroni.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-pitr>PGSQL PITR</a>: Focus on cluster PITR process context for point-in-time recovery assistance</p><details><summary>PGSQL PITR</summary><p><a href=https://demo.pigsty.io/d/pgsql-pitr><img src=/img/dashboard/pgsql-pitr.jpg alt=pgsql-patroni.jpg></a></p></details><hr><h2 id=instance>Instance</h2><p><a href=https://demo.pigsty.io/d/pgsql-instance>PGSQL Instance</a>: Main dashboard for a single PGSQL instance</p><details><summary>PGSQL Instance</summary><p><a href=https://demo.pigsty.io/d/pgsql-instance><img src=/img/dashboard/pgsql-instance.jpg alt=pgsql-instance.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgrds-instance>PGRDS Instance</a>: RDS version of PGSQL Instance, focused on all PostgreSQL-specific metrics</p><details><summary>PGRDS Instance</summary><p><a href=https://demo.pigsty.io/d/pgrds-instance><img src=/img/dashboard/pgrds-instance.jpg alt=pgrds-instance.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-proxy>PGSQL Proxy</a>: Detailed metrics for a single HAProxy load balancer</p><details><summary>PGSQL Proxy</summary><p><a href=https://demo.pigsty.io/d/pgsql-proxy><img src=/img/dashboard/pgsql-proxy.jpg alt=pgsql-proxy.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-pgbouncer>PGSQL Pgbouncer</a>: Metrics overview in a single Pgbouncer connection pool instance</p><details><summary>PGSQL Pgbouncer</summary><p><a href=https://demo.pigsty.io/d/pgsql-pgbouncer><img src=/img/dashboard/pgsql-pgbouncer.jpg alt=pgsql-pgbouncer.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-persist>PGSQL Persist</a>: Persistence metrics: WAL, XID, checkpoints, archiving, IO</p><details><summary>PGSQL Persist</summary><p><a href=https://demo.pigsty.io/d/pgsql-persist><img src=/img/dashboard/pgsql-persist.jpg alt=pgsql-persist.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-xacts>PGSQL Xacts</a>: Metrics related to transactions, locks, TPS/QPS</p><details><summary>PGSQL Xacts</summary><p><a href=https://demo.pigsty.io/d/pgsql-xacts><img src=/img/dashboard/pgsql-xacts.jpg alt=pgsql-xacts.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-session>PGSQL Session</a>: Session and active/idle time metrics in a single instance</p><details><summary>PGSQL Session</summary><p><a href=https://demo.pigsty.io/d/pgsql-session><img src=/img/dashboard/pgsql-session.jpg alt=pgsql-session.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-exporter>PGSQL Exporter</a>: Self-monitoring metrics for Postgres/Pgbouncer monitoring components</p><details><summary>PGSQL Exporter</summary><p><a href=https://demo.pigsty.io/d/pgsql-exporter><img src=/img/dashboard/pgsql-exporter.jpg alt=pgsql-exporter.jpg></a></p></details><hr><h2 id=database>Database</h2><p><a href=https://demo.pigsty.io/d/pgsql-database>PGSQL Database</a>: Main dashboard for a single PGSQL database</p><details><summary>PGSQL Database</summary><p><a href=https://demo.pigsty.io/d/pgsql-database><img src=/img/dashboard/pgsql-database.jpg alt=pgsql-database.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-tables>PGSQL Tables</a>: Table/index access metrics within a single database</p><details><summary>PGSQL Tables</summary><p><a href=https://demo.pigsty.io/d/pgsql-tables><img src=/img/dashboard/pgsql-tables.jpg alt=pgsql-tables.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-table>PGSQL Table</a>: Details of a single table (QPS/RT/index/sequences&mldr;)</p><details><summary>PGSQL Table</summary><p><a href=https://demo.pigsty.io/d/pgsql-table><img src=/img/dashboard/pgsql-table.jpg alt=pgsql-table.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-query>PGSQL Query</a>: Details of a single query (QPS/RT)</p><details><summary>PGSQL Query</summary><p><a href=https://demo.pigsty.io/d/pgsql-query><img src=/img/dashboard/pgsql-query.jpg alt=pgsql-query.jpg></a></p></details><hr><h2 id=pgcat>PGCAT</h2><p><a href=https://demo.pigsty.io/d/pgcat-instance>PGCAT Instance</a>: Instance information retrieved directly from the database catalog</p><details><summary>PGCAT Instance</summary><p><a href=https://demo.pigsty.io/d/pgcat-instance><img src=/img/dashboard/pgcat-instance.jpg alt=pgcat-instance.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-database>PGCAT Database</a>: Database information retrieved directly from the database catalog</p><details><summary>PGCAT Database</summary><p><a href=https://demo.pigsty.io/d/pgcat-database><img src=/img/dashboard/pgcat-database.jpg alt=pgcat-database.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-schema>PGCAT Schema</a>: Information about schemas retrieved directly from the database catalog (tables/indexes/sequences&mldr;)</p><details><summary>PGCAT Schema</summary><p><a href=https://demo.pigsty.io/d/pgcat-schema><img src=/img/dashboard/pgcat-schema.jpg alt=pgcat-schema.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-table>PGCAT Table</a>: Details of a single table retrieved directly from the database catalog (stats/bloat&mldr;)</p><details><summary>PGCAT Table</summary><p><a href=https://demo.pigsty.io/d/pgcat-table><img src=/img/dashboard/pgcat-table.jpg alt=pgcat-table.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-query>PGCAT Query</a>: Details of a single query retrieved directly from the database catalog (SQL/stats)</p><details><summary>PGCAT Query</summary><p><a href=https://demo.pigsty.io/d/pgcat-query><img src=/img/dashboard/pgcat-query.jpg alt=pgcat-query.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-locks>PGCAT Locks</a>: Information about activities and lock waits retrieved directly from the database catalog</p><details><summary>PGCAT Locks</summary><p><a href=https://demo.pigsty.io/d/pgcat-locks><img src=/img/dashboard/pgcat-locks.jpg alt=pgcat-locks.jpg></a></p></details><hr><h2 id=pglog>PGLOG</h2><p><a href=https://demo.pigsty.io/d/pglog-overview>PGLOG Overview</a>: Overview of CSV log samples in Pigsty CMDB</p><details><summary>PGLOG Overview</summary><p><a href=https://demo.pigsty.io/d/pglog-overview><img src=/img/dashboard/pglog-overview.jpg alt=pglog-overview.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pglog-session>PGLOG Session</a>: Log details of a session in CSV log samples in Pigsty CMDB</p><details><summary>PGLOG Session</summary><p><a href=https://demo.pigsty.io/d/pglog-session><img src=/img/dashboard/pglog-session.jpg alt=pglog-session.jpg></a></p></details><hr><h2 id=gallery>Gallery</h2><p>For details, refer to <a href=https://github.com/pgsty/pigsty/wiki/Gallery>pigsty/wiki/gallery</a>.</p><details><summary>PGSQL Overview</summary><p><a href=https://demo.pigsty.io/d/pgsql-overview><img src=/img/dashboard/pgsql-overview.jpg alt=pgsql-overview.jpg></a></p></details><details><summary>PGSQL Shard</summary><p><a href=https://demo.pigsty.io/d/pgsql-shard><img src=/img/dashboard/pgsql-shard.jpg alt=pgsql-shard.jpg></a></p></details><details><summary>PGSQL Cluster</summary><p><a href=https://demo.pigsty.io/d/pgsql-cluster><img src=/img/dashboard/pgsql-cluster.jpg alt=pgsql-cluster.jpg></a></p></details><details><summary>PGSQL Service</summary><p><a href=https://demo.pigsty.io/d/pgsql-service><img src=/img/dashboard/pgsql-service.jpg alt=pgsql-service.jpg></a></p></details><details><summary>PGSQL Activity</summary><p><a href=https://demo.pigsty.io/d/pgsql-activity><img src=/img/dashboard/pgsql-activity.jpg alt=pgsql-activity.jpg></a></p></details><details><summary>PGSQL Replication</summary><p><a href=https://demo.pigsty.io/d/pgsql-replication><img src=/img/dashboard/pgsql-replication.jpg alt=pgsql-replication.jpg></a></p></details><details><summary>PGSQL Databases</summary><p><a href=https://demo.pigsty.io/d/pgsql-databases><img src=/img/dashboard/pgsql-databases.jpg alt=pgsql-databases.jpg></a></p></details><details><summary>PGSQL Instance</summary><p><a href=https://demo.pigsty.io/d/pgsql-instance><img src=/img/dashboard/pgsql-instance.jpg alt=pgsql-instance.jpg></a></p></details><details><summary>PGSQL Proxy</summary><p><a href=https://demo.pigsty.io/d/pgsql-proxy><img src=/img/dashboard/pgsql-proxy.jpg alt=pgsql-proxy.jpg></a></p></details><details><summary>PGSQL Pgbouncer</summary><p><a href=https://demo.pigsty.io/d/pgsql-pgbouncer><img src=/img/dashboard/pgsql-pgbouncer.jpg alt=pgsql-pgbouncer.jpg></a></p></details><details><summary>PGSQL Session</summary><p><a href=https://demo.pigsty.io/d/pgsql-session><img src=/img/dashboard/pgsql-session.jpg alt=pgsql-session.jpg></a></p></details><details><summary>PGSQL Xacts</summary><p><a href=https://demo.pigsty.io/d/pgsql-xacts><img src=/img/dashboard/pgsql-xacts.jpg alt=pgsql-xacts.jpg></a></p></details><details><summary>PGSQL Persist</summary><p><a href=https://demo.pigsty.io/d/pgsql-persist><img src=/img/dashboard/pgsql-persist.jpg alt=pgsql-persist.jpg></a></p></details><details><summary>PGSQL Database</summary><p><a href=https://demo.pigsty.io/d/pgsql-database><img src=/img/dashboard/pgsql-database.jpg alt=pgsql-database.jpg></a></p></details><details><summary>PGSQL Tables</summary><p><a href=https://demo.pigsty.io/d/pgsql-tables><img src=/img/dashboard/pgsql-tables.jpg alt=pgsql-tables.jpg></a></p></details><details><summary>PGSQL Table</summary><p><a href=https://demo.pigsty.io/d/pgsql-table><img src=/img/dashboard/pgsql-table.jpg alt=pgsql-table.jpg></a></p></details><details><summary>PGSQL Query</summary><p><a href=https://demo.pigsty.io/d/pgsql-query><img src=/img/dashboard/pgsql-query.jpg alt=pgsql-query.jpg></a></p></details><details><summary>PGCAT Instance</summary><p><a href=https://demo.pigsty.io/d/pgcat-instance><img src=/img/dashboard/pgcat-instance.jpg alt=pgcat-instance.jpg></a></p></details><details><summary>PGCAT Database</summary><p><a href=https://demo.pigsty.io/d/pgcat-database><img src=/img/dashboard/pgcat-database.jpg alt=pgcat-database.jpg></a></p></details><details><summary>PGCAT Schema</summary><p><a href=https://demo.pigsty.io/d/pgcat-schema><img src=/img/dashboard/pgcat-schema.jpg alt=pgcat-schema.jpg></a></p></details><details><summary>PGCAT Table</summary><p><a href=https://demo.pigsty.io/d/pgcat-table><img src=/img/dashboard/pgcat-table.jpg alt=pgcat-table.jpg></a></p></details><details><summary>PGCAT Lock</summary><p><a href=https://demo.pigsty.io/d/pgcat-locks><img src=/img/dashboard/pgcat-locks.jpg alt=pgcat-locks.jpg></a></p></details><details><summary>PGCAT Query</summary><p><a href=https://demo.pigsty.io/d/pgcat-query><img src=/img/dashboard/pgcat-query.jpg alt=pgcat-query.jpg></a></p></details><details><summary>PGLOG Overview</summary><p><a href=https://demo.pigsty.io/d/pglog-overview><img src=/img/dashboard/pglog-overview.jpg alt=pglog-overview.jpg></a></p></details><details><summary>PGLOG Session</summary><p><a href=https://demo.pigsty.io/d/pglog-session><img src=/img/dashboard/pglog-session.jpg alt=pglog-session.jpg></a></p></details></div><div class=td-content style=page-break-before:always><h1 id=pg-1a2bfc805794d27d84ef5f1f8f01644b>11.2 - Metrics List</h1><div class=lead>Complete list and explanation of monitoring metrics provided by the Pigsty PGSQL module</div><p>The <a href=/docs/pgsql><strong><code>PGSQL</code></strong></a> module contains 638 types of available monitoring metrics.</p><table><thead><tr><th>Metric Name</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody><tr><td>ALERTS</td><td>Unknown</td><td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>alertstate</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>ALERTS_FOR_STATE</td><td>Unknown</td><td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>cls:pressure1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>cls:pressure15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>cls:pressure5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>go_gc_duration_seconds</td><td>summary</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>quantile</code>, <code>cls</code></td><td>A summary of the pause duration of garbage collection cycles.</td></tr><tr><td>go_gc_duration_seconds_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>go_gc_duration_seconds_sum</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>go_goroutines</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of goroutines that currently exist.</td></tr><tr><td>go_info</td><td>gauge</td><td><code>version</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Information about the Go environment.</td></tr><tr><td>go_memstats_alloc_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes allocated and still in use.</td></tr><tr><td>go_memstats_alloc_bytes_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of bytes allocated, even if freed.</td></tr><tr><td>go_memstats_buck_hash_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used by the profiling bucket hash table.</td></tr><tr><td>go_memstats_frees_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of frees.</td></tr><tr><td>go_memstats_gc_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for garbage collection system metadata.</td></tr><tr><td>go_memstats_heap_alloc_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes allocated and still in use.</td></tr><tr><td>go_memstats_heap_idle_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes waiting to be used.</td></tr><tr><td>go_memstats_heap_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes that are in use.</td></tr><tr><td>go_memstats_heap_objects</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of allocated objects.</td></tr><tr><td>go_memstats_heap_released_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes released to OS.</td></tr><tr><td>go_memstats_heap_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes obtained from system.</td></tr><tr><td>go_memstats_last_gc_time_seconds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of seconds since 1970 of last garbage collection.</td></tr><tr><td>go_memstats_lookups_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of pointer lookups.</td></tr><tr><td>go_memstats_mallocs_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of mallocs.</td></tr><tr><td>go_memstats_mcache_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes in use by mcache structures.</td></tr><tr><td>go_memstats_mcache_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for mcache structures obtained from system.</td></tr><tr><td>go_memstats_mspan_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes in use by mspan structures.</td></tr><tr><td>go_memstats_mspan_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for mspan structures obtained from system.</td></tr><tr><td>go_memstats_next_gc_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes when next garbage collection will take place.</td></tr><tr><td>go_memstats_other_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for other system allocations.</td></tr><tr><td>go_memstats_stack_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes in use by the stack allocator.</td></tr><tr><td>go_memstats_stack_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes obtained from system for stack allocator.</td></tr><tr><td>go_memstats_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes obtained from system.</td></tr><tr><td>go_threads</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of OS threads created.</td></tr><tr><td>ins:pressure1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>ins:pressure15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>ins:pressure5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>patroni_cluster_unlocked</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if the cluster is unlocked, 0 if locked.</td></tr><tr><td>patroni_dcs_last_seen</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Epoch timestamp when DCS was last contacted successfully by Patroni.</td></tr><tr><td>patroni_failsafe_mode_is_active</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if failsafe mode is active, 0 if inactive.</td></tr><tr><td>patroni_is_paused</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if auto failover is disabled, 0 otherwise.</td></tr><tr><td>patroni_master</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is the leader, 0 otherwise.</td></tr><tr><td>patroni_pending_restart</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if the node needs a restart, 0 otherwise.</td></tr><tr><td>patroni_postgres_in_archive_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if Postgres is replicating from archive, 0 otherwise.</td></tr><tr><td>patroni_postgres_running</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if Postgres is running, 0 otherwise.</td></tr><tr><td>patroni_postgres_server_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Version of Postgres (if running), 0 otherwise.</td></tr><tr><td>patroni_postgres_streaming</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if Postgres is streaming, 0 otherwise.</td></tr><tr><td>patroni_postgres_timeline</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Postgres timeline of this node (if running), 0 otherwise.</td></tr><tr><td>patroni_postmaster_start_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Epoch seconds since Postgres started.</td></tr><tr><td>patroni_primary</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is the leader, 0 otherwise.</td></tr><tr><td>patroni_replica</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is a replica, 0 otherwise.</td></tr><tr><td>patroni_standby_leader</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is the standby_leader, 0 otherwise.</td></tr><tr><td>patroni_sync_standby</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is a sync standby replica, 0 otherwise.</td></tr><tr><td>patroni_up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>patroni_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Patroni semver without periods.</td></tr><tr><td>patroni_xlog_location</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current location of the Postgres transaction log, 0 if this node is not the leader.</td></tr><tr><td>patroni_xlog_paused</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if the Postgres xlog is paused, 0 otherwise.</td></tr><tr><td>patroni_xlog_received_location</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current location of the received Postgres transaction log, 0 if this node is not a replica.</td></tr><tr><td>patroni_xlog_replayed_location</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current location of the replayed Postgres transaction log, 0 if this node is not a replica.</td></tr><tr><td>patroni_xlog_replayed_timestamp</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current timestamp of the replayed Postgres transaction log, 0 if null.</td></tr><tr><td>pg:cls:active_backends</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:active_time_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:active_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:active_time_rate5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:age</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_alloc_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_clean_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_flush_backend_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_flush_checkpoint_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage_15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage_1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage_5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:db_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:file_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:ixact_backends</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:ixact_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lag_bytes</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lag_seconds</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:leader</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:load1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:load15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:load5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lock_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:locks</td><td>Unknown</td><td><code>job</code>, <code>cls</code>, <code>mode</code></td><td>N/A</td></tr><tr><td>pg:cls:log_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lsn_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:members</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:num_backends</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:partition</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:receiver</td><td>Unknown</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>appname</code>, <code>ip</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>N/A</td></tr><tr><td>pg:cls:rlock_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:saturation1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:saturation15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:saturation5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:sender</td><td>Unknown</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:session_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:slot_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:slot_retained_bytes</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:standby_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:sync_state</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:timeline</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_deleted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_fetched_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_inserted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_modified_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_returned_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:wal_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_commit_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_commit_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_commit_rate5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_rollback_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_rollback_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_rollback_rate5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_total_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_total_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_total_sigma15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xlock_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_backends</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_time_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_time_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_time_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:age</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:age_deriv1h</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:age_exhaust</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blk_io_time_seconds_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blk_read_time_seconds_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blk_write_time_seconds_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_access_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_hit_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_hit_ratio1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_read_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:conn_limit</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:conn_usage</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:db_size</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:ixact_backends</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:ixact_time_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:lock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:num_backends</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:rlock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:session_time_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:temp_bytes_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:temp_files_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_deleted_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_fetched_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_inserted_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_modified_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_returned_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:wlock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_commit_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_commit_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_commit_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_rollback_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_rollback_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_rollback_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_sigma15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xlock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:env:active_backends</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:active_time_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:active_time_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:active_time_rate5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:age</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_count</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage_15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage_1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage_5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:ixact_backends</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:ixact_time_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:lag_bytes</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:lag_seconds</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:lsn_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:session_time_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_deleted_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_fetched_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_inserted_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_modified_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_returned_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_commit_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_commit_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_commit_rate5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_rollback_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_rollback_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_rollback_rate5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_total_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_total_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_total_sigma15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:ins:active_backends</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:active_time_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:active_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:active_time_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:age</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:blks_hit_ratio1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_alloc_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_clean_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_flush_backend_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_flush_checkpoint_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ckpt_1h</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ckpt_req_1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ckpt_timed_1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:conn_limit</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:conn_usage</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage_15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage_1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage_5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:db_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:file_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:fs_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:is_leader</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ixact_backends</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ixact_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lag_bytes</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lag_seconds</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:load1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:load15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:load5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:locks</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:log_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lsn_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:mem_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:num_backends</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:rlock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:saturation1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:saturation15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:saturation5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:session_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:slot_retained_bytes</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:space_usage</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:status</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:sync_state</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:target_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code>, <code>ins</code></td><td>N/A</td></tr><tr><td>pg:ins:timeline</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_deleted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_fetched_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_inserted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_modified_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_returned_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:wal_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:wlock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_commit_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_commit_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_commit_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_rollback_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_rollback_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_rollback_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_sigma15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xlock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:query:call_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:query:rt_1m</td><td>Unknown</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:table:scan_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg_activity_count</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Count of connection among (datname,state)</td></tr><tr><td>pg_activity_max_conn_duration</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Max backend session duration since state change among (datname, state)</td></tr><tr><td>pg_activity_max_duration</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Max duration since last state change among (datname, state)</td></tr><tr><td>pg_activity_max_tx_duration</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Max transaction duration since state change among (datname, state)</td></tr><tr><td>pg_archiver_failed_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of failed attempts for archiving WAL files</td></tr><tr><td>pg_archiver_finish_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of WAL files that have been successfully archived</td></tr><tr><td>pg_archiver_last_failed_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time of the last failed archival operation</td></tr><tr><td>pg_archiver_last_finish_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time of the last successful archive operation</td></tr><tr><td>pg_archiver_reset_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which archive statistics were last reset</td></tr><tr><td>pg_backend_count</td><td>gauge</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Database backend process count by backend_type</td></tr><tr><td>pg_bgwriter_buffers_alloc</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers allocated</td></tr><tr><td>pg_bgwriter_buffers_backend</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers written directly by a backend</td></tr><tr><td>pg_bgwriter_buffers_backend_fsync</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times a backend had to execute its own fsync call</td></tr><tr><td>pg_bgwriter_buffers_checkpoint</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers written during checkpoints</td></tr><tr><td>pg_bgwriter_buffers_clean</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers written by the background writer</td></tr><tr><td>pg_bgwriter_checkpoint_sync_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time that has been spent in the portion of checkpoint processing where files are synchronized to disk, in seconds</td></tr><tr><td>pg_bgwriter_checkpoint_write_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time that has been spent in the portion of checkpoint processing where files are written to disk, in seconds</td></tr><tr><td>pg_bgwriter_checkpoints_req</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of requested checkpoints that have been performed</td></tr><tr><td>pg_bgwriter_checkpoints_timed</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of scheduled checkpoints that have been performed</td></tr><tr><td>pg_bgwriter_maxwritten_clean</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times the background writer stopped a cleaning scan because it had written too many buffers</td></tr><tr><td>pg_bgwriter_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which bgwriter statistics were last reset</td></tr><tr><td>pg_boot_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>unix timestamp when postmaster boot</td></tr><tr><td>pg_checkpoint_checkpoint_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint location</td></tr><tr><td>pg_checkpoint_elapse</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Seconds elapsed since latest checkpoint in seconds</td></tr><tr><td>pg_checkpoint_full_page_writes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s full_page_writes enabled</td></tr><tr><td>pg_checkpoint_newest_commit_ts_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s newestCommitTsXid</td></tr><tr><td>pg_checkpoint_next_multi_offset</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextMultiOffset</td></tr><tr><td>pg_checkpoint_next_multixact_id</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextMultiXactId</td></tr><tr><td>pg_checkpoint_next_oid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextOID</td></tr><tr><td>pg_checkpoint_next_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextXID xid</td></tr><tr><td>pg_checkpoint_next_xid_epoch</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextXID epoch</td></tr><tr><td>pg_checkpoint_oldest_active_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestActiveXID</td></tr><tr><td>pg_checkpoint_oldest_commit_ts_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestCommitTsXid</td></tr><tr><td>pg_checkpoint_oldest_multi_dbid</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestMulti&rsquo;s DB OID</td></tr><tr><td>pg_checkpoint_oldest_multi_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestMultiXid</td></tr><tr><td>pg_checkpoint_oldest_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestXID</td></tr><tr><td>pg_checkpoint_oldest_xid_dbid</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestXID&rsquo;s DB OID</td></tr><tr><td>pg_checkpoint_prev_tli</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s PrevTimeLineID</td></tr><tr><td>pg_checkpoint_redo_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s REDO location</td></tr><tr><td>pg_checkpoint_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time of latest checkpoint</td></tr><tr><td>pg_checkpoint_tli</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s TimeLineID</td></tr><tr><td>pg_conf_reload_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since last configuration reload</td></tr><tr><td>pg_db_active_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent executing SQL statements in this database, in seconds</td></tr><tr><td>pg_db_age</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Age of database calculated from datfrozenxid</td></tr><tr><td>pg_db_allow_conn</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>If false(0) then no one can connect to this database.</td></tr><tr><td>pg_db_blk_read_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent reading data file blocks by backends in this database, in seconds</td></tr><tr><td>pg_db_blk_write_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent writing data file blocks by backends in this database, in seconds</td></tr><tr><td>pg_db_blks_access</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times disk blocks that accessed read+hit</td></tr><tr><td>pg_db_blks_hit</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times disk blocks were found already in the buffer cache</td></tr><tr><td>pg_db_blks_read</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read in this database</td></tr><tr><td>pg_db_cks_fail_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which the last data page checksum failure was detected in this database</td></tr><tr><td>pg_db_cks_fails</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of data page checksum failures detected in this database, -1 for not enabled</td></tr><tr><td>pg_db_confl_confl_bufferpin</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to pinned buffers</td></tr><tr><td>pg_db_confl_confl_deadlock</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to deadlocks</td></tr><tr><td>pg_db_confl_confl_lock</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to lock timeouts</td></tr><tr><td>pg_db_confl_confl_snapshot</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to old snapshots</td></tr><tr><td>pg_db_confl_confl_tablespace</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to dropped tablespaces</td></tr><tr><td>pg_db_conflicts</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries canceled due to conflicts with recovery in this database</td></tr><tr><td>pg_db_conn_limit</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Sets maximum number of concurrent connections that can be made to this database. -1 means no limit.</td></tr><tr><td>pg_db_datid</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>OID of the database</td></tr><tr><td>pg_db_deadlocks</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of deadlocks detected in this database</td></tr><tr><td>pg_db_frozen_xid</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>All transaction IDs before this one have been frozened</td></tr><tr><td>pg_db_is_template</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>If true(1), then this database can be cloned by any user with CREATEDB privileges</td></tr><tr><td>pg_db_ixact_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent idling while in a transaction in this database, in seconds</td></tr><tr><td>pg_db_numbackends</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of backends currently connected to this database</td></tr><tr><td>pg_db_reset_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which database statistics were last reset</td></tr><tr><td>pg_db_session_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent by database sessions in this database, in seconds</td></tr><tr><td>pg_db_sessions</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of sessions established to this database</td></tr><tr><td>pg_db_sessions_abandoned</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of database sessions to this database that were terminated because connection to the client was lost</td></tr><tr><td>pg_db_sessions_fatal</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of database sessions to this database that were terminated by fatal errors</td></tr><tr><td>pg_db_sessions_killed</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of database sessions to this database that were terminated by operator intervention</td></tr><tr><td>pg_db_temp_bytes</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of data written to temporary files by queries in this database.</td></tr><tr><td>pg_db_temp_files</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of temporary files created by queries in this database</td></tr><tr><td>pg_db_tup_deleted</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows deleted by queries in this database</td></tr><tr><td>pg_db_tup_fetched</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows fetched by queries in this database</td></tr><tr><td>pg_db_tup_inserted</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows inserted by queries in this database</td></tr><tr><td>pg_db_tup_modified</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows modified by queries in this database</td></tr><tr><td>pg_db_tup_returned</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows returned by queries in this database</td></tr><tr><td>pg_db_tup_updated</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows updated by queries in this database</td></tr><tr><td>pg_db_xact_commit</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of transactions in this database that have been committed</td></tr><tr><td>pg_db_xact_rollback</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of transactions in this database that have been rolled back</td></tr><tr><td>pg_db_xact_total</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of transactions in this database</td></tr><tr><td>pg_downstream_count</td><td>gauge</td><td><code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Count of corresponding state</td></tr><tr><td>pg_exporter_agent_up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg_exporter_last_scrape_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pg_exporter_query_cache_ttl</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times to live of query cache</td></tr><tr><td>pg_exporter_query_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds query spending on scrapping</td></tr><tr><td>pg_exporter_query_scrape_error_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times the query failed</td></tr><tr><td>pg_exporter_query_scrape_hit_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers been scrapped from this query</td></tr><tr><td>pg_exporter_query_scrape_metric_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers of metrics been scrapped from this query</td></tr><tr><td>pg_exporter_query_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pg_exporter_scrape_duration</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pg_exporter_scrape_error_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics and failed</td></tr><tr><td>pg_exporter_scrape_total_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics</td></tr><tr><td>pg_exporter_server_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pg_exporter_server_scrape_error_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg_exporter_server_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pg_exporter_server_scrape_total_seconds</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pg_exporter_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>always be 1 if your could retrieve metrics</td></tr><tr><td>pg_exporter_uptime</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since exporter primary server inited</td></tr><tr><td>pg_flush_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>primary only, location of current wal syncing</td></tr><tr><td>pg_func_calls</td><td>counter</td><td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this function has been called</td></tr><tr><td>pg_func_self_time</td><td>counter</td><td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time spent in this function itself, not including other functions called by it, in ms</td></tr><tr><td>pg_func_total_time</td><td>counter</td><td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time spent in this function and all other functions called by it, in ms</td></tr><tr><td>pg_in_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server is in recovery mode? 1 for yes 0 for no</td></tr><tr><td>pg_index_idx_blks_hit</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of buffer hits in this index</td></tr><tr><td>pg_index_idx_blks_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of disk blocks read from this index</td></tr><tr><td>pg_index_idx_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of index scans initiated on this index</td></tr><tr><td>pg_index_idx_tup_fetch</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of live table rows fetched by simple index scans using this index</td></tr><tr><td>pg_index_idx_tup_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of index entries returned by scans on this index</td></tr><tr><td>pg_index_relpages</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Size of the on-disk representation of this index in pages</td></tr><tr><td>pg_index_reltuples</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Estimate relation tuples</td></tr><tr><td>pg_insert_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>primary only, location of current wal inserting</td></tr><tr><td>pg_io_evictions</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of times a block has been written out from a shared or local buffer</td></tr><tr><td>pg_io_extend_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in extend operations in seconds</td></tr><tr><td>pg_io_extends</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of relation extend operations, each of the size specified in op_bytes.</td></tr><tr><td>pg_io_fsync_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in fsync operations in seconds</td></tr><tr><td>pg_io_fsyncs</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of fsync calls. These are only tracked in context normal</td></tr><tr><td>pg_io_hits</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>The number of times a desired block was found in a shared buffer.</td></tr><tr><td>pg_io_op_bytes</td><td>gauge</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>The number of bytes per unit of I/O read, written, or extended. 8192 by default</td></tr><tr><td>pg_io_read_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in read operations in seconds</td></tr><tr><td>pg_io_reads</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of read operations, each of the size specified in op_bytes.</td></tr><tr><td>pg_io_reset_time</td><td>gauge</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Timestamp at which these statistics were last reset</td></tr><tr><td>pg_io_reuses</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>The number of times an existing buffer in reused</td></tr><tr><td>pg_io_write_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in write operations in seconds</td></tr><tr><td>pg_io_writeback_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in writeback operations in seconds</td></tr><tr><td>pg_io_writebacks</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of units of size op_bytes which the process requested the kernel write out to permanent storage.</td></tr><tr><td>pg_io_writes</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of write operations, each of the size specified in op_bytes.</td></tr><tr><td>pg_is_in_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>1 if in recovery mode</td></tr><tr><td>pg_is_wal_replay_paused</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>1 if wal play paused</td></tr><tr><td>pg_lag</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>replica only, replication lag in seconds</td></tr><tr><td>pg_last_replay_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>time when last transaction been replayed</td></tr><tr><td>pg_lock_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td><td>Number of locks of corresponding mode and database</td></tr><tr><td>pg_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>log sequence number, current write location</td></tr><tr><td>pg_meta_info</td><td>gauge</td><td><code>cls</code>, <code>extensions</code>, <code>version</code>, <code>job</code>, <code>ins</code>, <code>primary_conninfo</code>, <code>conf_path</code>, <code>hba_path</code>, <code>ip</code>, <code>cluster_id</code>, <code>instance</code>, <code>listen_port</code>, <code>wal_level</code>, <code>ver_num</code>, <code>cluster_name</code>, <code>data_dir</code></td><td>constant 1</td></tr><tr><td>pg_query_calls</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times the statement was executed</td></tr><tr><td>pg_query_exec_time</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time spent executing the statement, in seconds</td></tr><tr><td>pg_query_io_time</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time the statement spent reading and writing blocks, in seconds</td></tr><tr><td>pg_query_rows</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of rows retrieved or affected by the statement</td></tr><tr><td>pg_query_sblk_dirtied</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared blocks dirtied by the statement</td></tr><tr><td>pg_query_sblk_hit</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared block cache hits by the statement</td></tr><tr><td>pg_query_sblk_read</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared blocks read by the statement</td></tr><tr><td>pg_query_sblk_written</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared blocks written by the statement</td></tr><tr><td>pg_query_wal_bytes</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of WAL bytes generated by the statement</td></tr><tr><td>pg_receive_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>replica only, location of wal synced to disk</td></tr><tr><td>pg_recovery_backup_end_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Backup end location</td></tr><tr><td>pg_recovery_backup_start_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Backup start location</td></tr><tr><td>pg_recovery_min_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Minimum recovery ending location</td></tr><tr><td>pg_recovery_min_timeline</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Min recovery ending loc&rsquo;s timeline</td></tr><tr><td>pg_recovery_prefetch_block_distance</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>How many blocks ahead the prefetcher is looking</td></tr><tr><td>pg_recovery_prefetch_hit</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they were already in the buffer pool</td></tr><tr><td>pg_recovery_prefetch_io_depth</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>How many prefetches have been initiated but are not yet known to have completed</td></tr><tr><td>pg_recovery_prefetch_prefetch</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks prefetched because they were not in the buffer pool</td></tr><tr><td>pg_recovery_prefetch_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which these recovery prefetch statistics were last reset</td></tr><tr><td>pg_recovery_prefetch_skip_fpw</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because a full page image was included in the WAL</td></tr><tr><td>pg_recovery_prefetch_skip_init</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they would be zero-initialized</td></tr><tr><td>pg_recovery_prefetch_skip_new</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they didn&rsquo;t exist yet</td></tr><tr><td>pg_recovery_prefetch_skip_rep</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they were already recently prefetched</td></tr><tr><td>pg_recovery_prefetch_wal_distance</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>How many bytes ahead the prefetcher is looking</td></tr><tr><td>pg_recovery_require_record</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>End-of-backup record required</td></tr><tr><td>pg_recv_flush_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Last write-ahead log location already received and flushed to disk</td></tr><tr><td>pg_recv_flush_tli</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Timeline number of last write-ahead log location received and flushed to disk</td></tr><tr><td>pg_recv_init_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>First write-ahead log location used when WAL receiver is started</td></tr><tr><td>pg_recv_init_tli</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>First timeline number used when WAL receiver is started</td></tr><tr><td>pg_recv_msg_recv_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Receipt time of last message received from origin WAL sender</td></tr><tr><td>pg_recv_msg_send_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Send time of last message received from origin WAL sender</td></tr><tr><td>pg_recv_pid</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Process ID of the WAL receiver process</td></tr><tr><td>pg_recv_reported_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Last write-ahead log location reported to origin WAL sender</td></tr><tr><td>pg_recv_reported_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Time of last write-ahead log location reported to origin WAL sender</td></tr><tr><td>pg_recv_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Time of current snapshot</td></tr><tr><td>pg_recv_write_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Last write-ahead log location already received and written to disk, but not flushed.</td></tr><tr><td>pg_relkind_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>relkind</code></td><td>Number of relations of corresponding relkind</td></tr><tr><td>pg_repl_backend_xmin</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>This standby&rsquo;s xmin horizon reported by hot_standby_feedback.</td></tr><tr><td>pg_repl_client_port</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>TCP port number that the client is using for communication with this WAL sender, or -1 if a Unix socket is used</td></tr><tr><td>pg_repl_flush_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position flushed to disk by this standby server diff with current lsn</td></tr><tr><td>pg_repl_flush_lag</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written and flushed it</td></tr><tr><td>pg_repl_flush_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location flushed to disk by this standby server</td></tr><tr><td>pg_repl_launch_time</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time when this process was started, i.e., when the client connected to this WAL sender</td></tr><tr><td>pg_repl_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current log position on this server</td></tr><tr><td>pg_repl_replay_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position replayed into the database on this standby server diff with current lsn</td></tr><tr><td>pg_repl_replay_lag</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written, flushed and applied it</td></tr><tr><td>pg_repl_replay_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location replayed into the database on this standby server</td></tr><tr><td>pg_repl_reply_time</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Send time of last reply message received from standby server</td></tr><tr><td>pg_repl_sent_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position sent to this standby server diff with current lsn</td></tr><tr><td>pg_repl_sent_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location sent on this connection</td></tr><tr><td>pg_repl_state</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current WAL sender encoded state 0-4 for streaming startup catchup backup stopping</td></tr><tr><td>pg_repl_sync_priority</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Priority of this standby server for being chosen as the synchronous standby</td></tr><tr><td>pg_repl_sync_state</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Encoded synchronous state of this standby server, 0-3 for async potential sync quorum</td></tr><tr><td>pg_repl_time</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current timestamp in unix epoch</td></tr><tr><td>pg_repl_write_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position written to disk by this standby server diff with current lsn</td></tr><tr><td>pg_repl_write_lag</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written it</td></tr><tr><td>pg_repl_write_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location written to disk by this standby server</td></tr><tr><td>pg_replay_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>replica only, location of wal applied</td></tr><tr><td>pg_seq_blks_hit</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td><td>Number of buffer hits in this sequence</td></tr><tr><td>pg_seq_blks_read</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td><td>Number of disk blocks read from this sequence</td></tr><tr><td>pg_seq_last_value</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td><td>The last sequence value written to disk</td></tr><tr><td>pg_setting_block_size</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>pg page block size, 8192 by default</td></tr><tr><td>pg_setting_data_checksums</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>whether data checksum is enabled, 1 enabled 0 disabled</td></tr><tr><td>pg_setting_max_connections</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>number of concurrent connections to the database server</td></tr><tr><td>pg_setting_max_locks_per_transaction</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>no more than this many distinct objects can be locked at any one time</td></tr><tr><td>pg_setting_max_prepared_transactions</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of transactions that can be in the prepared state simultaneously</td></tr><tr><td>pg_setting_max_replication_slots</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of replication slots</td></tr><tr><td>pg_setting_max_wal_senders</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of concurrent connections from standby servers</td></tr><tr><td>pg_setting_max_worker_processes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of background processes that the system can support</td></tr><tr><td>pg_setting_wal_log_hints</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>whether wal_log_hints is enabled, 1 enabled 0 disabled</td></tr><tr><td>pg_size_bytes</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>File size in bytes</td></tr><tr><td>pg_slot_active</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>True(1) if this slot is currently actively being used</td></tr><tr><td>pg_slot_catalog_xmin</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The oldest transaction affecting the system catalogs that this slot needs the database to retain.</td></tr><tr><td>pg_slot_confirm_lsn</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The address (LSN) up to which the logical slot&rsquo;s consumer has confirmed receiving data.</td></tr><tr><td>pg_slot_reset_time</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>When statistics were last reset</td></tr><tr><td>pg_slot_restart_lsn</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The address (LSN) of oldest WAL which still might be required by the consumer of this slot</td></tr><tr><td>pg_slot_retained_bytes</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Size of bytes that retained for this slot</td></tr><tr><td>pg_slot_safe_wal_size</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>bytes that can be written to WAL which will not make slot into lost</td></tr><tr><td>pg_slot_spill_bytes</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes that spilled to disk due to logical decode mem exceeding</td></tr><tr><td>pg_slot_spill_count</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that spilled to disk due to logical decode mem exceeding (a xact can be spilled multiple times)</td></tr><tr><td>pg_slot_spill_txns</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that spilled to disk due to logical decode mem exceeding (subtrans included)</td></tr><tr><td>pg_slot_stream_bytes</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes that streamed to decoding output plugin after mem exceed</td></tr><tr><td>pg_slot_stream_count</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that streamed to decoding output plugin after mem exceed (a xact can be streamed multiple times)</td></tr><tr><td>pg_slot_stream_txns</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that streamed to decoding output plugin after mem exceed</td></tr><tr><td>pg_slot_temporary</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>True(1) if this is a temporary replication slot.</td></tr><tr><td>pg_slot_total_bytes</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of decoded bytes sent to the decoding output plugin for this slot</td></tr><tr><td>pg_slot_total_txns</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of decoded xacts sent to the decoding output plugin for this slot</td></tr><tr><td>pg_slot_wal_status</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>WAL reserve status 0-3 means reserved,extended,unreserved,lost, -1 means other</td></tr><tr><td>pg_slot_xmin</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The oldest transaction that this slot needs the database to retain.</td></tr><tr><td>pg_slru_blks_exists</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks checked for existence for this SLRU</td></tr><tr><td>pg_slru_blks_hit</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times disk blocks were found already in the SLRU, so that a read was not necessary</td></tr><tr><td>pg_slru_blks_read</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read for this SLRU</td></tr><tr><td>pg_slru_blks_written</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks written for this SLRU</td></tr><tr><td>pg_slru_blks_zeroed</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks zeroed during initializations</td></tr><tr><td>pg_slru_flushes</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of flushes of dirty data for this SLRU</td></tr><tr><td>pg_slru_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which these statistics were last reset</td></tr><tr><td>pg_slru_truncates</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of truncates for this SLRU</td></tr><tr><td>pg_ssl_disabled</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of client connection that does not use ssl</td></tr><tr><td>pg_ssl_enabled</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of client connection that use ssl</td></tr><tr><td>pg_sync_standby_enabled</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>names</code>, <code>instance</code>, <code>cls</code></td><td>Synchronous commit enabled, 1 if enabled, 0 if disabled</td></tr><tr><td>pg_table_age</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Age of this table in vacuum cycles</td></tr><tr><td>pg_table_analyze_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been manually analyzed</td></tr><tr><td>pg_table_autoanalyze_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been analyzed by the autovacuum daemon</td></tr><tr><td>pg_table_autovacuum_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been vacuumed by the autovacuum daemon</td></tr><tr><td>pg_table_frozenxid</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>All txid before this have been frozen on this table</td></tr><tr><td>pg_table_heap_blks_hit</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffer hits in this table</td></tr><tr><td>pg_table_heap_blks_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read from this table</td></tr><tr><td>pg_table_idx_blks_hit</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffer hits in all indexes on this table</td></tr><tr><td>pg_table_idx_blks_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read from all indexes on this table</td></tr><tr><td>pg_table_idx_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of index scans initiated on this table</td></tr><tr><td>pg_table_idx_tup_fetch</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of live rows fetched by index scans</td></tr><tr><td>pg_table_kind</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Relation kind r/table/114</td></tr><tr><td>pg_table_n_dead_tup</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of dead rows</td></tr><tr><td>pg_table_n_ins_since_vacuum</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of rows inserted since this table was last vacuumed</td></tr><tr><td>pg_table_n_live_tup</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of live rows</td></tr><tr><td>pg_table_n_mod_since_analyze</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of rows modified since this table was last analyzed</td></tr><tr><td>pg_table_n_tup_del</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows deleted</td></tr><tr><td>pg_table_n_tup_hot_upd</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows HOT updated (i.e with no separate index update required)</td></tr><tr><td>pg_table_n_tup_ins</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows inserted</td></tr><tr><td>pg_table_n_tup_mod</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows modified (insert + update + delete)</td></tr><tr><td>pg_table_n_tup_newpage_upd</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows updated where the successor version goes onto a new heap page</td></tr><tr><td>pg_table_n_tup_upd</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows updated (includes HOT updated rows)</td></tr><tr><td>pg_table_ncols</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of columns in the table</td></tr><tr><td>pg_table_pages</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Size of the on-disk representation of this table in pages</td></tr><tr><td>pg_table_relid</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Relation oid of this table</td></tr><tr><td>pg_table_seq_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of sequential scans initiated on this table</td></tr><tr><td>pg_table_seq_tup_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of live rows fetched by sequential scans</td></tr><tr><td>pg_table_size_bytes</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total bytes of this table (including toast, index, toast index)</td></tr><tr><td>pg_table_size_indexsize</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes of all related indexes of this table</td></tr><tr><td>pg_table_size_relsize</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes of this table itself (main, vm, fsm)</td></tr><tr><td>pg_table_size_toastsize</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes of toast tables of this table</td></tr><tr><td>pg_table_tbl_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of scans initiated on this table</td></tr><tr><td>pg_table_tup_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of live rows fetched by scans</td></tr><tr><td>pg_table_tuples</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>All txid before this have been frozen on this table</td></tr><tr><td>pg_table_vacuum_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been manually vacuumed (not counting VACUUM FULL)</td></tr><tr><td>pg_timestamp</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>database current timestamp</td></tr><tr><td>pg_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>last scrape was able to connect to the server: 1 for yes, 0 for no</td></tr><tr><td>pg_uptime</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since postmaster start</td></tr><tr><td>pg_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server version number</td></tr><tr><td>pg_wait_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>event</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Count of WaitEvent on target database</td></tr><tr><td>pg_wal_buffers_full</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times WAL data was written to disk because WAL buffers became full</td></tr><tr><td>pg_wal_bytes</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of WAL generated in bytes</td></tr><tr><td>pg_wal_fpi</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of WAL full page images generated</td></tr><tr><td>pg_wal_records</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of WAL records generated</td></tr><tr><td>pg_wal_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>When statistics were last reset</td></tr><tr><td>pg_wal_sync</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times WAL files were synced to disk via issue_xlog_fsync request</td></tr><tr><td>pg_wal_sync_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time spent syncing WAL files to disk via issue_xlog_fsync request, in seconds</td></tr><tr><td>pg_wal_write</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times WAL buffers were written out to disk via XLogWrite request.</td></tr><tr><td>pg_wal_write_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time spent writing WAL buffers to disk via XLogWrite request in seconds</td></tr><tr><td>pg_write_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>primary only, location of current wal writing</td></tr><tr><td>pg_xact_xmax</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>First as-yet-unassigned txid. txid >= this are invisible.</td></tr><tr><td>pg_xact_xmin</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Earliest txid that is still active</td></tr><tr><td>pg_xact_xnum</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current active transaction count</td></tr><tr><td>pgbouncer:cls:load1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:cls:load15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:cls:load5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:conn_usage</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:conn_usage_reserve</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_current_conn</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_disabled</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_max_conn</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_paused</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_reserve_size</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_size</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:free_clients</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:free_servers</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:load1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:load15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:load5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:login_clients</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:pool_databases</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:pool_users</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:pools</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:used_clients</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer_database_current_connections</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Current number of connections for this database</td></tr><tr><td>pgbouncer_database_disabled</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>True(1) if this database is currently disabled, else 0</td></tr><tr><td>pgbouncer_database_max_connections</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Maximum number of allowed connections for this database</td></tr><tr><td>pgbouncer_database_min_pool_size</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Minimum number of server connections</td></tr><tr><td>pgbouncer_database_paused</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>True(1) if this database is currently paused, else 0</td></tr><tr><td>pgbouncer_database_pool_size</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Maximum number of server connections</td></tr><tr><td>pgbouncer_database_reserve_pool</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Maximum number of additional connections for this database</td></tr><tr><td>pgbouncer_exporter_agent_up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer_exporter_last_scrape_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pgbouncer_exporter_query_cache_ttl</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times to live of query cache</td></tr><tr><td>pgbouncer_exporter_query_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds query spending on scrapping</td></tr><tr><td>pgbouncer_exporter_query_scrape_error_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times the query failed</td></tr><tr><td>pgbouncer_exporter_query_scrape_hit_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers been scrapped from this query</td></tr><tr><td>pgbouncer_exporter_query_scrape_metric_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers of metrics been scrapped from this query</td></tr><tr><td>pgbouncer_exporter_query_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pgbouncer_exporter_scrape_duration</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pgbouncer_exporter_scrape_error_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics and failed</td></tr><tr><td>pgbouncer_exporter_scrape_total_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics</td></tr><tr><td>pgbouncer_exporter_server_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pgbouncer_exporter_server_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pgbouncer_exporter_server_scrape_total_seconds</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pgbouncer_exporter_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>always be 1 if your could retrieve metrics</td></tr><tr><td>pgbouncer_exporter_uptime</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since exporter primary server inited</td></tr><tr><td>pgbouncer_in_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server is in recovery mode? 1 for yes 0 for no</td></tr><tr><td>pgbouncer_list_items</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>list</code>, <code>cls</code></td><td>Number of corresponding pgbouncer object</td></tr><tr><td>pgbouncer_pool_active_cancel_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that have forwarded query cancellations to the server and are waiting for the server response.</td></tr><tr><td>pgbouncer_pool_active_cancel_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are currently forwarding a cancel request</td></tr><tr><td>pgbouncer_pool_active_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that are linked to server connection and can process queries</td></tr><tr><td>pgbouncer_pool_active_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are linked to a client</td></tr><tr><td>pgbouncer_pool_cancel_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that have not forwarded query cancellations to the server yet.</td></tr><tr><td>pgbouncer_pool_cancel_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>cancel requests have completed that were sent to cancel a query on this server</td></tr><tr><td>pgbouncer_pool_idle_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are unused and immediately usable for client queries</td></tr><tr><td>pgbouncer_pool_login_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections currently in the process of logging in</td></tr><tr><td>pgbouncer_pool_maxwait</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>How long the first(oldest) client in the queue has waited, in seconds, key metric</td></tr><tr><td>pgbouncer_pool_maxwait_us</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Microsecond part of the maximum waiting time.</td></tr><tr><td>pgbouncer_pool_tested_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are currently running reset or check query</td></tr><tr><td>pgbouncer_pool_used_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that have been idle for more than server_check_delay (means have to run check query)</td></tr><tr><td>pgbouncer_pool_waiting_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that have sent queries but have not yet got a server connection</td></tr><tr><td>pgbouncer_stat_avg_query_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average queries per second in last stat period</td></tr><tr><td>pgbouncer_stat_avg_query_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average query duration, in seconds</td></tr><tr><td>pgbouncer_stat_avg_recv</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average received (from clients) bytes per second</td></tr><tr><td>pgbouncer_stat_avg_sent</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average sent (to clients) bytes per second</td></tr><tr><td>pgbouncer_stat_avg_wait_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent by clients waiting for a server, in seconds (average per second).</td></tr><tr><td>pgbouncer_stat_avg_xact_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average transactions per second in last stat period</td></tr><tr><td>pgbouncer_stat_avg_xact_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average transaction duration, in seconds</td></tr><tr><td>pgbouncer_stat_total_query_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of SQL queries pooled by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_query_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of seconds spent when executing queries</td></tr><tr><td>pgbouncer_stat_total_received</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total volume in bytes of network traffic received by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_sent</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total volume in bytes of network traffic sent by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_wait_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent by clients waiting for a server, in seconds</td></tr><tr><td>pgbouncer_stat_total_xact_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of SQL transactions pooled by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_xact_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of seconds spent when in a transaction</td></tr><tr><td>pgbouncer_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>last scrape was able to connect to the server: 1 for yes, 0 for no</td></tr><tr><td>pgbouncer_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server version number</td></tr><tr><td>process_cpu_seconds_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total user and system CPU time spent in seconds.</td></tr><tr><td>process_max_fds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Maximum number of open file descriptors.</td></tr><tr><td>process_open_fds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of open file descriptors.</td></tr><tr><td>process_resident_memory_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Resident memory size in bytes.</td></tr><tr><td>process_start_time_seconds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Start time of the process since unix epoch in seconds.</td></tr><tr><td>process_virtual_memory_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Virtual memory size in bytes.</td></tr><tr><td>process_virtual_memory_max_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Maximum amount of virtual memory available in bytes.</td></tr><tr><td>promhttp_metric_handler_requests_in_flight</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current number of scrapes being served.</td></tr><tr><td>promhttp_metric_handler_requests_total</td><td>counter</td><td><code>code</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of scrapes by HTTP status code.</td></tr><tr><td>scrape_duration_seconds</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>scrape_samples_post_metric_relabeling</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>scrape_samples_scraped</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>scrape_series_added</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-a794a26bf3d40b2536adae3b38d29ef6>12 - Dashboard</h1><div class=lead>Pigsty provides numerous out-of-the-box Grafana monitoring dashboards for PostgreSQL</div><blockquote><p>Pigsty provides numerous out-of-the-box Grafana monitoring dashboards for PostgreSQL: <a href=https://demo.pigsty.io/d/pgsql-overview>Demo</a> & <a href=https://github.com/Vonng/pigsty/wiki/Gallery>Gallery</a>.</p></blockquote><p>Pigsty has 26 PostgreSQL-related monitoring dashboards, organized by hierarchy into Overview, Cluster, Instance, and Database categories, and by data source into <a href=#overview>PGSQL</a>, <a href=#pgcat>PGCAT</a>, and <a href=#pglog>PGLOG</a> categories.</p><p><img src=/img/pigsty/dashboard.jpg alt=pigsty-dashboard.jpg></p><hr><h2 id=overview>Overview</h2><table class=full-width><thead><tr><th style=text-align:center>Overview</th><th style=text-align:center>Cluster</th><th style=text-align:center>Instance</th><th style=text-align:center>Database</th></tr></thead><tbody><tr><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-overview>PGSQL Overview</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-cluster>PGSQL Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-instance>PGSQL Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-database>PGSQL Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-alert>PGSQL Alert</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgrds-cluster>PGRDS Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgrds-instance>PGRDS Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-database>PGCAT Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-shard>PGSQL Shard</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-activity>PGSQL Activity</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-instance>PGCAT Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-tables>PGSQL Tables</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-replication>PGSQL Replication</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-persist>PGSQL Persist</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-table>PGSQL Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-service>PGSQL Service</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-proxy>PGSQL Proxy</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-table>PGCAT Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-databases>PGSQL Databases</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-pgbouncer>PGSQL Pgbouncer</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-query>PGSQL Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-patroni>PGSQL Patroni</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-session>PGSQL Session</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-query>PGCAT Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-pitr>PGSQL PITR</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-xacts>PGSQL Xacts</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-locks>PGCAT Locks</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgsql-exporter>PGSQL Exporter</a></td><td style=text-align:center><a href=https://demo.pigsty.io/d/pgcat-schema>PGCAT Schema</a></td></tr></tbody></table><p><strong>Overview</strong></p><ul><li><a href=https://demo.pigsty.io/d/pgsql-overview>pgsql-overview</a>: Main dashboard for the PGSQL module</li><li><a href=https://demo.pigsty.io/d/pgsql-alert>pgsql-alert</a>: Global key metrics and alert events for PGSQL</li><li><a href=https://demo.pigsty.io/d/pgsql-shard>pgsql-shard</a>: Overview of horizontally sharded PGSQL clusters (e.g., Citus/GPSQL)</li></ul><p><strong>Cluster</strong></p><ul><li><a href=https://demo.pigsty.io/d/pgsql-cluster>pgsql-cluster</a>: Main dashboard for a PGSQL cluster</li><li><a href=https://demo.pigsty.io/d/pgrds-cluster>pgrds-cluster</a>: RDS version of PGSQL Cluster, focusing on PostgreSQL-native metrics</li><li><a href=https://demo.pigsty.io/d/pgsql-activity>pgsql-activity</a>: Session/load/QPS/TPS/locks for PGSQL cluster</li><li><a href=https://demo.pigsty.io/d/pgsql-replication>pgsql-replication</a>: Replication, slots, and pub/sub for PGSQL cluster</li><li><a href=https://demo.pigsty.io/d/pgsql-service>pgsql-service</a>: Service, proxy, routing, and load balancing for PGSQL cluster</li><li><a href=https://demo.pigsty.io/d/pgsql-databases>pgsql-databases</a>: Database CRUD, slow queries, and table statistics across all instances</li><li><a href=https://demo.pigsty.io/d/pgsql-patroni>pgsql-patroni</a>: HA status and Patroni component status for cluster</li><li><a href=https://demo.pigsty.io/d/pgsql-pitr>pgsql-pitr</a>: PITR context for point-in-time recovery assistance</li></ul><p><strong>Instance</strong></p><ul><li><a href=https://demo.pigsty.io/d/pgsql-instance>pgsql-instance</a>: Main dashboard for a single PGSQL instance</li><li><a href=https://demo.pigsty.io/d/pgrds-instance>pgrds-instance</a>: RDS version of PGSQL Instance, focusing on PostgreSQL-native metrics</li><li><a href=https://demo.pigsty.io/d/pgcat-instance>pgcat-instance</a>: Instance info retrieved directly from database catalog</li><li><a href=https://demo.pigsty.io/d/pgsql-proxy>pgsql-proxy</a>: Detailed metrics for a single HAProxy load balancer</li><li><a href=https://demo.pigsty.io/d/pgsql-pgbouncer>pgsql-pgbouncer</a>: Metrics overview for a single Pgbouncer connection pooler</li><li><a href=https://demo.pigsty.io/d/pgsql-persist>pgsql-persist</a>: Persistence metrics: WAL, XID, checkpoint, archive, IO</li><li><a href=https://demo.pigsty.io/d/pgsql-session>pgsql-session</a>: Session and active/idle time metrics for a single instance</li><li><a href=https://demo.pigsty.io/d/pgsql-xacts>pgsql-xacts</a>: Transaction, lock, TPS/QPS related metrics</li><li><a href=https://demo.pigsty.io/d/pgsql-exporter>pgsql-exporter</a>: Self-monitoring metrics for Postgres and Pgbouncer exporters</li></ul><p><strong>Database</strong></p><ul><li><a href=https://demo.pigsty.io/d/pgsql-database>pgsql-database</a>: Main dashboard for a single PGSQL database</li><li><a href=https://demo.pigsty.io/d/pgcat-database>pgcat-database</a>: Database info retrieved directly from database catalog</li><li><a href=https://demo.pigsty.io/d/pgsql-tables>pgsql-tables</a>: Table/index access metrics within a single database</li><li><a href=https://demo.pigsty.io/d/pgsql-table>pgsql-table</a>: Detailed info for a single table (QPS/RT/index/sequence&mldr;)</li><li><a href=https://demo.pigsty.io/d/pgcat-table>pgcat-table</a>: Detailed table info from database catalog (stats/bloat&mldr;)</li><li><a href=https://demo.pigsty.io/d/pgsql-query>pgsql-query</a>: Detailed info for a query type (QPS/RT)</li><li><a href=https://demo.pigsty.io/d/pgcat-query>pgcat-query</a>: Query details from database catalog (SQL/stats)</li><li><a href=https://demo.pigsty.io/d/pgcat-schema>pgcat-schema</a>: Schema info from database catalog (tables/indexes/sequences&mldr;)</li><li><a href=https://demo.pigsty.io/d/pgcat-locks>pgcat-locks</a>: Activity and lock wait info from database catalog</li></ul><hr><h2 id=overview-1>Overview</h2><p><a href=https://demo.pigsty.io/d/pgsql-overview>PGSQL Overview</a>: Main dashboard for the PGSQL module</p><details><summary>PGSQL Overview</summary><p><a href=https://demo.pigsty.io/d/pgsql-overview><img src=/img/dashboard/pgsql-overview.jpg alt=pgsql-overview.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-alert>PGSQL Alert</a>: Global core metrics overview and alert events</p><details><summary>PGSQL Alert</summary><p><a href=https://demo.pigsty.io/d/pgsql-alert><img src=/img/dashboard/pgsql-alert.jpg alt=pgsql-alert.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-shard>PGSQL Shard</a>: Cross-shard metric comparison for horizontally sharded PGSQL clusters (e.g., CITUS/GPSQL)</p><details><summary>PGSQL Shard</summary><p><a href=https://demo.pigsty.io/d/pgsql-shard><img src=/img/dashboard/pgsql-shard.jpg alt=pgsql-shard.jpg></a></p></details><hr><h2 id=cluster>Cluster</h2><p><a href=https://demo.pigsty.io/d/pgsql-cluster>PGSQL Cluster</a>: Main dashboard for a PGSQL cluster</p><details><summary>PGSQL Cluster</summary><p><a href=https://demo.pigsty.io/d/pgsql-cluster><img src=/img/dashboard/pgsql-cluster.jpg alt=pgsql-cluster.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgrds-cluster>PGRDS Cluster</a>: RDS version of PGSQL Cluster, focusing on PostgreSQL-native metrics</p><details><summary>PGRDS Cluster</summary><p><a href=https://demo.pigsty.io/d/pgrds-cluster><img src=/img/dashboard/pgrds-cluster.jpg alt=pgrds-cluster.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-service>PGSQL Service</a>: Service, proxy, routing, and load balancing for PGSQL cluster</p><details><summary>PGSQL Service</summary><p><a href=https://demo.pigsty.io/d/pgsql-service><img src=/img/dashboard/pgsql-service.jpg alt=pgsql-service.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-activity>PGSQL Activity</a>: Session/load/QPS/TPS/locks for PGSQL cluster</p><details><summary>PGSQL Activity</summary><p><a href=https://demo.pigsty.io/d/pgsql-activity><img src=/img/dashboard/pgsql-activity.jpg alt=pgsql-activity.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-replication>PGSQL Replication</a>: Replication, slots, and pub/sub for PGSQL cluster</p><details><summary>PGSQL Replication</summary><p><a href=https://demo.pigsty.io/d/pgsql-replication><img src=/img/dashboard/pgsql-replication.jpg alt=pgsql-replication.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-databases>PGSQL Databases</a>: Database CRUD, slow queries, and table statistics across all instances</p><details><summary>PGSQL Databases</summary><p><a href=https://demo.pigsty.io/d/pgsql-databases><img src=/img/dashboard/pgsql-databases.jpg alt=pgsql-databases.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-patroni>PGSQL Patroni</a>: HA status and Patroni component status for cluster</p><details><summary>PGSQL Patroni</summary><p><a href=https://demo.pigsty.io/d/pgsql-patroni><img src=/img/dashboard/pgsql-patroni.jpg alt=pgsql-patroni.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-pitr>PGSQL PITR</a>: PITR context for point-in-time recovery assistance</p><details><summary>PGSQL PITR</summary><p><a href=https://demo.pigsty.io/d/pgsql-pitr><img src=/img/dashboard/pgsql-pitr.jpg alt=pgsql-patroni.jpg></a></p></details><hr><h2 id=instance>Instance</h2><p><a href=https://demo.pigsty.io/d/pgsql-instance>PGSQL Instance</a>: Main dashboard for a single PGSQL instance</p><details><summary>PGSQL Instance</summary><p><a href=https://demo.pigsty.io/d/pgsql-instance><img src=/img/dashboard/pgsql-instance.jpg alt=pgsql-instance.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgrds-instance>PGRDS Instance</a>: RDS version of PGSQL Instance, focusing on PostgreSQL-native metrics</p><details><summary>PGRDS Instance</summary><p><a href=https://demo.pigsty.io/d/pgrds-instance><img src=/img/dashboard/pgrds-instance.jpg alt=pgrds-instance.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-proxy>PGSQL Proxy</a>: Detailed metrics for a single HAProxy load balancer</p><details><summary>PGSQL Proxy</summary><p><a href=https://demo.pigsty.io/d/pgsql-proxy><img src=/img/dashboard/pgsql-proxy.jpg alt=pgsql-proxy.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-pgbouncer>PGSQL Pgbouncer</a>: Metrics overview for a single Pgbouncer connection pooler</p><details><summary>PGSQL Pgbouncer</summary><p><a href=https://demo.pigsty.io/d/pgsql-pgbouncer><img src=/img/dashboard/pgsql-pgbouncer.jpg alt=pgsql-pgbouncer.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-persist>PGSQL Persist</a>: Persistence metrics: WAL, XID, checkpoint, archive, IO</p><details><summary>PGSQL Persist</summary><p><a href=https://demo.pigsty.io/d/pgsql-persist><img src=/img/dashboard/pgsql-persist.jpg alt=pgsql-persist.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-xacts>PGSQL Xacts</a>: Transaction, lock, TPS/QPS related metrics</p><details><summary>PGSQL Xacts</summary><p><a href=https://demo.pigsty.io/d/pgsql-xacts><img src=/img/dashboard/pgsql-xacts.jpg alt=pgsql-xacts.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-session>PGSQL Session</a>: Session and active/idle time metrics for a single instance</p><details><summary>PGSQL Session</summary><p><a href=https://demo.pigsty.io/d/pgsql-session><img src=/img/dashboard/pgsql-session.jpg alt=pgsql-session.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-exporter>PGSQL Exporter</a>: Self-monitoring metrics for Postgres/Pgbouncer exporters</p><details><summary>PGSQL Exporter</summary><p><a href=https://demo.pigsty.io/d/pgsql-exporter><img src=/img/dashboard/pgsql-exporter.jpg alt=pgsql-exporter.jpg></a></p></details><hr><h2 id=database>Database</h2><p><a href=https://demo.pigsty.io/d/pgsql-database>PGSQL Database</a>: Main dashboard for a single PGSQL database</p><details><summary>PGSQL Database</summary><p><a href=https://demo.pigsty.io/d/pgsql-database><img src=/img/dashboard/pgsql-database.jpg alt=pgsql-database.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-tables>PGSQL Tables</a>: Table/index access metrics within a single database</p><details><summary>PGSQL Tables</summary><p><a href=https://demo.pigsty.io/d/pgsql-tables><img src=/img/dashboard/pgsql-tables.jpg alt=pgsql-tables.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-table>PGSQL Table</a>: Detailed info for a single table (QPS/RT/index/sequence&mldr;)</p><details><summary>PGSQL Table</summary><p><a href=https://demo.pigsty.io/d/pgsql-table><img src=/img/dashboard/pgsql-table.jpg alt=pgsql-table.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgsql-query>PGSQL Query</a>: Detailed info for a query type (QPS/RT)</p><details><summary>PGSQL Query</summary><p><a href=https://demo.pigsty.io/d/pgsql-query><img src=/img/dashboard/pgsql-query.jpg alt=pgsql-query.jpg></a></p></details><hr><h2 id=pgcat>PGCAT</h2><p><a href=https://demo.pigsty.io/d/pgcat-instance>PGCAT Instance</a>: Instance info retrieved directly from database catalog</p><details><summary>PGCAT Instance</summary><p><a href=https://demo.pigsty.io/d/pgcat-instance><img src=/img/dashboard/pgcat-instance.jpg alt=pgcat-instance.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-database>PGCAT Database</a>: Database info retrieved directly from database catalog</p><details><summary>PGCAT Database</summary><p><a href=https://demo.pigsty.io/d/pgcat-database><img src=/img/dashboard/pgcat-database.jpg alt=pgcat-database.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-schema>PGCAT Schema</a>: Schema info from database catalog (tables/indexes/sequences&mldr;)</p><details><summary>PGCAT Schema</summary><p><a href=https://demo.pigsty.io/d/pgcat-schema><img src=/img/dashboard/pgcat-schema.jpg alt=pgcat-schema.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-table>PGCAT Table</a>: Detailed table info from database catalog (stats/bloat&mldr;)</p><details><summary>PGCAT Table</summary><p><a href=https://demo.pigsty.io/d/pgcat-table><img src=/img/dashboard/pgcat-table.jpg alt=pgcat-table.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-query>PGCAT Query</a>: Query details from database catalog (SQL/stats)</p><details><summary>PGCAT Query</summary><p><a href=https://demo.pigsty.io/d/pgcat-query><img src=/img/dashboard/pgcat-query.jpg alt=pgcat-query.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pgcat-locks>PGCAT Locks</a>: Activity and lock wait info from database catalog</p><details><summary>PGCAT Locks</summary><p><a href=https://demo.pigsty.io/d/pgcat-locks><img src=/img/dashboard/pgcat-locks.jpg alt=pgcat-locks.jpg></a></p></details><hr><h2 id=pglog>PGLOG</h2><p><a href=https://demo.pigsty.io/d/pglog-overview>PGLOG Overview</a>: Overview of CSV log samples in Pigsty CMDB</p><details><summary>PGLOG Overview</summary><p><a href=https://demo.pigsty.io/d/pglog-overview><img src=/img/dashboard/pglog-overview.jpg alt=pglog-overview.jpg></a></p></details><p><a href=https://demo.pigsty.io/d/pglog-session>PGLOG Session</a>: Log details for a single session in CSV log samples</p><details><summary>PGLOG Session</summary><p><a href=https://demo.pigsty.io/d/pglog-session><img src=/img/dashboard/pglog-session.jpg alt=pglog-session.jpg></a></p></details><hr><h2 id=gallery>Gallery</h2><p>See <a href=https://github.com/Vonng/pigsty/wiki/Gallery>pigsty/wiki/gallery</a> for details.</p><details><summary>PGSQL Overview</summary><p><a href=https://demo.pigsty.io/d/pgsql-overview><img src=/img/dashboard/pgsql-overview.jpg alt=pgsql-overview.jpg></a></p></details><details><summary>PGSQL Shard</summary><p><a href=https://demo.pigsty.io/d/pgsql-shard><img src=/img/dashboard/pgsql-shard.jpg alt=pgsql-shard.jpg></a></p></details><details><summary>PGSQL Cluster</summary><p><a href=https://demo.pigsty.io/d/pgsql-cluster><img src=/img/dashboard/pgsql-cluster.jpg alt=pgsql-cluster.jpg></a></p></details><details><summary>PGSQL Service</summary><p><a href=https://demo.pigsty.io/d/pgsql-service><img src=/img/dashboard/pgsql-service.jpg alt=pgsql-service.jpg></a></p></details><details><summary>PGSQL Activity</summary><p><a href=https://demo.pigsty.io/d/pgsql-activity><img src=/img/dashboard/pgsql-activity.jpg alt=pgsql-activity.jpg></a></p></details><details><summary>PGSQL Replication</summary><p><a href=https://demo.pigsty.io/d/pgsql-replication><img src=/img/dashboard/pgsql-replication.jpg alt=pgsql-replication.jpg></a></p></details><details><summary>PGSQL Databases</summary><p><a href=https://demo.pigsty.io/d/pgsql-databases><img src=/img/dashboard/pgsql-databases.jpg alt=pgsql-databases.jpg></a></p></details><details><summary>PGSQL Instance</summary><p><a href=https://demo.pigsty.io/d/pgsql-instance><img src=/img/dashboard/pgsql-instance.jpg alt=pgsql-instance.jpg></a></p></details><details><summary>PGSQL Proxy</summary><p><a href=https://demo.pigsty.io/d/pgsql-proxy><img src=/img/dashboard/pgsql-proxy.jpg alt=pgsql-proxy.jpg></a></p></details><details><summary>PGSQL Pgbouncer</summary><p><a href=https://demo.pigsty.io/d/pgsql-pgbouncer><img src=/img/dashboard/pgsql-pgbouncer.jpg alt=pgsql-pgbouncer.jpg></a></p></details><details><summary>PGSQL Session</summary><p><a href=https://demo.pigsty.io/d/pgsql-session><img src=/img/dashboard/pgsql-session.jpg alt=pgsql-session.jpg></a></p></details><details><summary>PGSQL Xacts</summary><p><a href=https://demo.pigsty.io/d/pgsql-xacts><img src=/img/dashboard/pgsql-xacts.jpg alt=pgsql-xacts.jpg></a></p></details><details><summary>PGSQL Persist</summary><p><a href=https://demo.pigsty.io/d/pgsql-persist><img src=/img/dashboard/pgsql-persist.jpg alt=pgsql-persist.jpg></a></p></details><details><summary>PGSQL Database</summary><p><a href=https://demo.pigsty.io/d/pgsql-database><img src=/img/dashboard/pgsql-database.jpg alt=pgsql-database.jpg></a></p></details><details><summary>PGSQL Tables</summary><p><a href=https://demo.pigsty.io/d/pgsql-tables><img src=/img/dashboard/pgsql-tables.jpg alt=pgsql-tables.jpg></a></p></details><details><summary>PGSQL Table</summary><p><a href=https://demo.pigsty.io/d/pgsql-table><img src=/img/dashboard/pgsql-table.jpg alt=pgsql-table.jpg></a></p></details><details><summary>PGSQL Query</summary><p><a href=https://demo.pigsty.io/d/pgsql-query><img src=/img/dashboard/pgsql-query.jpg alt=pgsql-query.jpg></a></p></details><details><summary>PGCAT Instance</summary><p><a href=https://demo.pigsty.io/d/pgcat-instance><img src=/img/dashboard/pgcat-instance.jpg alt=pgcat-instance.jpg></a></p></details><details><summary>PGCAT Database</summary><p><a href=https://demo.pigsty.io/d/pgcat-database><img src=/img/dashboard/pgcat-database.jpg alt=pgcat-database.jpg></a></p></details><details><summary>PGCAT Schema</summary><p><a href=https://demo.pigsty.io/d/pgcat-schema><img src=/img/dashboard/pgcat-schema.jpg alt=pgcat-schema.jpg></a></p></details><details><summary>PGCAT Table</summary><p><a href=https://demo.pigsty.io/d/pgcat-table><img src=/img/dashboard/pgcat-table.jpg alt=pgcat-table.jpg></a></p></details><details><summary>PGCAT Lock</summary><p><a href=https://demo.pigsty.io/d/pgcat-locks><img src=/img/dashboard/pgcat-locks.jpg alt=pgcat-locks.jpg></a></p></details><details><summary>PGCAT Query</summary><p><a href=https://demo.pigsty.io/d/pgcat-query><img src=/img/dashboard/pgcat-query.jpg alt=pgcat-query.jpg></a></p></details><details><summary>PGLOG Overview</summary><p><a href=https://demo.pigsty.io/d/pglog-overview><img src=/img/dashboard/pglog-overview.jpg alt=pglog-overview.jpg></a></p></details><details><summary>PGLOG Session</summary><p><a href=https://demo.pigsty.io/d/pglog-session><img src=/img/dashboard/pglog-session.jpg alt=pglog-session.jpg></a></p></details></div><div class=td-content style=page-break-before:always><h1 id=pg-c580a7d5af0c814a622cd05d2217ea00>12.1 - Overview</h1><div class=lead>PostgreSQL module global overview monitoring dashboards</div><p>PostgreSQL module global overview monitoring dashboards, including:</p><ul><li><a href=pgsql-overview>PGSQL Overview</a>: Main dashboard for the PGSQL module</li><li><a href=pgsql-alert>PGSQL Alert</a>: Global key metrics and alert events for PGSQL</li><li><a href=pgsql-shard>PGSQL Shard</a>: Overview of horizontally sharded PGSQL clusters</li></ul></div><div class=td-content><h1 id=pg-98c77cd5a40440bd2142743d9aa7e924>12.1.1 - PGSQL Overview</h1><div class=lead>Main dashboard for the PGSQL module</div><blockquote><p>Main dashboard for the PGSQL module: <a href=https://demo.pigsty.io/d/pgsql-overview>Demo</a></p></blockquote><p>PGSQL Overview is the main dashboard for the PostgreSQL module, providing a global overview of the entire PGSQL module.</p><p><a href=https://demo.pigsty.io/d/pgsql-overview><img src=/img/panel/pgsql-overview.webp alt=pgsql-overview></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c0d2340d281acc8b5f2c5c898b37729d>12.1.2 - PGSQL Alert</h1><div class=lead>Global key metrics and alert events for PGSQL</div><blockquote><p>Global key metrics and alert events for PGSQL: <a href=https://demo.pigsty.io/d/pgsql-alert>Demo</a></p></blockquote><p>PGSQL Alert provides a global overview of core metrics and alert events for PostgreSQL clusters.</p><p><a href=https://demo.pigsty.io/d/pgsql-alert><img src=/img/panel/pgsql-alert.webp alt=pgsql-alert></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c7ea59a32ca19d6b135cb915d738ec5f>12.1.3 - PGSQL Shard</h1><div class=lead>Overview of horizontally sharded PGSQL clusters</div><blockquote><p>Overview of horizontally sharded PGSQL clusters: <a href=https://demo.pigsty.io/d/pgsql-shard>Demo</a></p></blockquote><p>PGSQL Shard provides cross-shard metric comparison for horizontally sharded PGSQL clusters such as CITUS or GPSQL.</p><p><a href=https://demo.pigsty.io/d/pgsql-shard><img src=/img/panel/pgsql-shard.webp alt=pgsql-shard></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-71d11dac090b2845d43964a086c029e7>12.2 - Cluster</h1><div class=lead>PostgreSQL cluster-level monitoring dashboards</div><p>PostgreSQL cluster-level monitoring dashboards, including:</p><ul><li><a href=pgsql-cluster>PGSQL Cluster</a>: Main dashboard for a PGSQL cluster</li><li><a href=pgrds-cluster>PGRDS Cluster</a>: RDS version of PGSQL Cluster, focusing on PostgreSQL-native metrics</li><li><a href=pgsql-activity>PGSQL Activity</a>: Session/load/QPS/TPS/locks for PGSQL cluster</li><li><a href=pgsql-replication>PGSQL Replication</a>: Replication, slots, and pub/sub for PGSQL cluster</li><li><a href=pgsql-service>PGSQL Service</a>: Service, proxy, routing, and load balancing for PGSQL cluster</li><li><a href=pgsql-databases>PGSQL Databases</a>: Database CRUD, slow queries, and table statistics across all instances</li><li><a href=pgsql-patroni>PGSQL Patroni</a>: HA status and Patroni component status for cluster</li><li><a href=pgsql-pitr>PGSQL PITR</a>: PITR context for point-in-time recovery assistance</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ac13540d2c30a80f1d60794c913740ab>12.2.1 - PGSQL Cluster</h1><div class=lead>Main dashboard for a PGSQL cluster</div><blockquote><p>Main dashboard for a PGSQL cluster: <a href=https://demo.pigsty.io/d/pgsql-cluster>Demo</a></p></blockquote><p>PGSQL Cluster is the main dashboard for a single PostgreSQL cluster, providing cluster-level core metrics overview.</p><p><a href=https://demo.pigsty.io/d/pgsql-cluster><img src=/img/panel/pgsql-cluster.webp alt=pgsql-cluster></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-777b02cba7b02a268aecc27250e0815d>12.2.2 - PGRDS Cluster</h1><div class=lead>RDS version of PGSQL Cluster focusing on PostgreSQL-native metrics</div><blockquote><p>RDS version of PGSQL Cluster: <a href=https://demo.pigsty.io/d/pgrds-cluster>Demo</a></p></blockquote><p>PGRDS Cluster is the RDS version of PGSQL Cluster, focusing on PostgreSQL-native metrics without host-level metrics.</p><p><a href=https://demo.pigsty.io/d/pgrds-cluster><img src=/img/panel/pgrds-cluster.webp alt=pgrds-cluster></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f593ebcf5a965df4fb71075741e2b77e>12.2.3 - PGSQL Activity</h1><div class=lead>Session/load/QPS/TPS/locks for PGSQL cluster</div><blockquote><p>Session/load/QPS/TPS/locks for PGSQL cluster: <a href=https://demo.pigsty.io/d/pgsql-activity>Demo</a></p></blockquote><p>PGSQL Activity focuses on session activity, load, QPS, TPS, and lock status for a PostgreSQL cluster.</p><p><a href=https://demo.pigsty.io/d/pgsql-activity><img src=/img/panel/pgsql-activity.webp alt=pgsql-activity></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-fc20a0ddfc32761378480d5e1617d77f>12.2.4 - PGSQL Replication</h1><div class=lead>Replication, slots, and pub/sub for PGSQL cluster</div><blockquote><p>Replication, slots, and pub/sub for PGSQL cluster: <a href=https://demo.pigsty.io/d/pgsql-replication>Demo</a></p></blockquote><p>PGSQL Replication focuses on replication status, replication slots, and logical replication (pub/sub) for a PostgreSQL cluster.</p><p><a href=https://demo.pigsty.io/d/pgsql-replication><img src=/img/panel/pgsql-replication.webp alt=pgsql-replication></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5be6c72f3740f9ca61bbab9d0fb51474>12.2.5 - PGSQL Service</h1><div class=lead>Service, proxy, routing, and load balancing for PGSQL cluster</div><blockquote><p>Service, proxy, routing, and load balancing for PGSQL cluster: <a href=https://demo.pigsty.io/d/pgsql-service>Demo</a></p></blockquote><p>PGSQL Service focuses on service endpoints, proxy routing, and load balancing status for a PostgreSQL cluster.</p><p><a href=https://demo.pigsty.io/d/pgsql-service><img src=/img/panel/pgsql-service.webp alt=pgsql-service></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-49c9b74c56a741db1e680ea66c062840>12.2.6 - PGSQL Databases</h1><div class=lead>Database CRUD, slow queries, and table statistics across all instances</div><blockquote><p>Database CRUD, slow queries, and table statistics: <a href=https://demo.pigsty.io/d/pgsql-databases>Demo</a></p></blockquote><p>PGSQL Databases focuses on database-level CRUD operations, slow queries, and table statistics across all instances in a cluster.</p><p><a href=https://demo.pigsty.io/d/pgsql-databases><img src=/img/panel/pgsql-databases.webp alt=pgsql-databases></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7c90bff16bde850becbc89a8ff49fa4d>12.2.7 - PGSQL Patroni</h1><div class=lead>HA status and Patroni component status for cluster</div><blockquote><p>HA status and Patroni component status: <a href=https://demo.pigsty.io/d/pgsql-patroni>Demo</a></p></blockquote><p>PGSQL Patroni focuses on high-availability status and Patroni component health for a PostgreSQL cluster.</p><p><a href=https://demo.pigsty.io/d/pgsql-patroni><img src=/img/panel/pgsql-patroni.webp alt=pgsql-patroni></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-3c35cf3066a9271b66140e3ae546cc97>12.2.8 - PGSQL PITR</h1><div class=lead>PITR context for point-in-time recovery assistance</div><blockquote><p>PITR context for point-in-time recovery: <a href=https://demo.pigsty.io/d/pgsql-pitr>Demo</a></p></blockquote><p>PGSQL PITR provides context information for point-in-time recovery operations, showing backup status and WAL timeline.</p><p><a href=https://demo.pigsty.io/d/pgsql-pitr><img src=/img/panel/pgsql-pitr.webp alt=pgsql-pitr></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0d3b46a9e4488b08a97e5a2cd93e8342>12.3 - Instance</h1><div class=lead>PostgreSQL instance-level monitoring dashboards</div><p>PostgreSQL instance-level monitoring dashboards, including:</p><ul><li><a href=pgsql-instance>PGSQL Instance</a>: Main dashboard for a single PGSQL instance</li><li><a href=pgrds-instance>PGRDS Instance</a>: RDS version of PGSQL Instance, focusing on PostgreSQL-native metrics</li><li><a href=pgcat-instance>PGCAT Instance</a>: Instance info retrieved directly from database catalog</li><li><a href=pgsql-persist>PGSQL Persist</a>: Persistence metrics: WAL, XID, checkpoint, archive, IO</li><li><a href=pgsql-proxy>PGSQL Proxy</a>: Detailed metrics for a single HAProxy load balancer</li><li><a href=pgsql-pgbouncer>PGSQL Pgbouncer</a>: Metrics overview for a single Pgbouncer connection pooler</li><li><a href=pgsql-session>PGSQL Session</a>: Session and active/idle time metrics for a single instance</li><li><a href=pgsql-xacts>PGSQL Xacts</a>: Transaction, lock, TPS/QPS related metrics</li><li><a href=pgsql-exporter>PGSQL Exporter</a>: Self-monitoring metrics for Postgres and Pgbouncer exporters</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-efab5aa64980fd75bc6e3faafa448046>12.3.1 - PGSQL Instance</h1><div class=lead>Main dashboard for a single PGSQL instance</div><blockquote><p>Main dashboard for a single PGSQL instance: <a href=https://demo.pigsty.io/d/pgsql-instance>Demo</a></p></blockquote><p>PGSQL Instance is the main dashboard for a single PostgreSQL instance, providing comprehensive instance-level metrics.</p><p><a href=https://demo.pigsty.io/d/pgsql-instance><img src=/img/panel/pgsql-instance.webp alt=pgsql-instance></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-745f68183713f01820b7036ca02434dc>12.3.2 - PGRDS Instance</h1><div class=lead>RDS version of PGSQL Instance focusing on PostgreSQL-native metrics</div><blockquote><p>RDS version of PGSQL Instance: <a href=https://demo.pigsty.io/d/pgrds-instance>Demo</a></p></blockquote><p>PGRDS Instance is the RDS version of PGSQL Instance, focusing on PostgreSQL-native metrics without host-level metrics.</p><p><a href=https://demo.pigsty.io/d/pgrds-instance><img src=/img/panel/pgrds-instance.webp alt=pgrds-instance></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-cc7ae26f510c83819e09f711ea4efd4c>12.3.3 - PGCAT Instance</h1><div class=lead>Instance info retrieved directly from database catalog</div><blockquote><p>Instance info from database catalog: <a href=https://demo.pigsty.io/d/pgcat-instance>Demo</a></p></blockquote><p>PGCAT Instance shows instance-level information retrieved directly from PostgreSQL system catalog.</p><p><a href=https://demo.pigsty.io/d/pgcat-instance><img src=/img/panel/pgcat-instance.webp alt=pgcat-instance></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7e14c54a9f928b5211431714593ff1d7>12.3.4 - PGSQL Persist</h1><div class=lead>Persistence metrics - WAL, XID, checkpoint, archive, IO</div><blockquote><p>Persistence metrics for PGSQL instance: <a href=https://demo.pigsty.io/d/pgsql-persist>Demo</a></p></blockquote><p>PGSQL Persist focuses on persistence-related metrics: WAL generation, XID consumption, checkpoints, archiving, and I/O patterns.</p><p><a href=https://demo.pigsty.io/d/pgsql-persist><img src=/img/panel/pgsql-persist.webp alt=pgsql-persist></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ab6bcd147d1f1aadd3cac0741c8d3885>12.3.5 - PGSQL Proxy</h1><div class=lead>Detailed metrics for a single HAProxy load balancer</div><blockquote><p>Detailed metrics for HAProxy: <a href=https://demo.pigsty.io/d/pgsql-proxy>Demo</a></p></blockquote><p>PGSQL Proxy shows detailed metrics for a single HAProxy load balancer instance serving PostgreSQL traffic.</p><p><a href=https://demo.pigsty.io/d/pgsql-proxy><img src=/img/panel/pgsql-proxy.webp alt=pgsql-proxy></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7650b8f9f3f719c7343b60768a765bbe>12.3.6 - PGSQL Pgbouncer</h1><div class=lead>Metrics overview for a single Pgbouncer connection pooler</div><blockquote><p>Metrics overview for Pgbouncer: <a href=https://demo.pigsty.io/d/pgsql-pgbouncer>Demo</a></p></blockquote><p>PGSQL Pgbouncer shows connection pooling metrics for a single Pgbouncer instance.</p><p><a href=https://demo.pigsty.io/d/pgsql-pgbouncer><img src=/img/panel/pgsql-pgbouncer.webp alt=pgsql-pgbouncer></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ca5931906d508cd9f75edfe7218e753c>12.3.7 - PGSQL Session</h1><div class=lead>Session and active/idle time metrics for a single instance</div><blockquote><p>Session and active/idle time metrics: <a href=https://demo.pigsty.io/d/pgsql-session>Demo</a></p></blockquote><p>PGSQL Session focuses on session statistics and active/idle time distribution for a single PostgreSQL instance.</p><p><a href=https://demo.pigsty.io/d/pgsql-session><img src=/img/panel/pgsql-session.webp alt=pgsql-session></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9d9def57863d569d20a7a3193aa26c93>12.3.8 - PGSQL Xacts</h1><div class=lead>Transaction, lock, TPS/QPS related metrics</div><blockquote><p>Transaction, lock, TPS/QPS metrics: <a href=https://demo.pigsty.io/d/pgsql-xacts>Demo</a></p></blockquote><p>PGSQL Xacts focuses on transaction processing, lock activity, and TPS/QPS metrics for a single PostgreSQL instance.</p><p><a href=https://demo.pigsty.io/d/pgsql-xacts><img src=/img/panel/pgsql-xacts.webp alt=pgsql-xacts></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f25ea8d94e36ba9a5b3676cb12633bf2>12.3.9 - PGSQL Exporter</h1><div class=lead>Self-monitoring metrics for Postgres and Pgbouncer exporters</div><blockquote><p>Self-monitoring metrics for exporters: <a href=https://demo.pigsty.io/d/pgsql-exporter>Demo</a></p></blockquote><p>PGSQL Exporter shows self-monitoring metrics for the Postgres exporter and Pgbouncer exporter components.</p><p><a href=https://demo.pigsty.io/d/pgsql-exporter><img src=/img/panel/pgsql-exporter.webp alt=pgsql-exporter></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5ab1262c99945ca6857061b54141248e>12.4 - Database</h1><div class=lead>PostgreSQL database-level monitoring dashboards</div><p>PostgreSQL database-level monitoring dashboards, including:</p><ul><li><a href=pgsql-database>PGSQL Database</a>: Main dashboard for a single PGSQL database</li><li><a href=pgcat-database>PGCAT Database</a>: Database info retrieved directly from database catalog</li><li><a href=pgsql-tables>PGSQL Tables</a>: Table/index access metrics within a single database</li><li><a href=pgsql-table>PGSQL Table</a>: Detailed info for a single table (QPS/RT/index/sequence&mldr;)</li><li><a href=pgcat-table>PGCAT Table</a>: Detailed table info from database catalog</li><li><a href=pgsql-query>PGSQL Query</a>: Detailed info for a query type (QPS/RT)</li><li><a href=pgcat-query>PGCAT Query</a>: Query details from database catalog</li><li><a href=pgcat-locks>PGCAT Locks</a>: Activity and lock wait info from database catalog</li><li><a href=pgcat-schema>PGCAT Schema</a>: Schema info from database catalog</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8c17cc1092ed2d1e76d0b7d93b35bbf1>12.4.1 - PGSQL Database</h1><div class=lead>Main dashboard for a single PGSQL database</div><blockquote><p>Main dashboard for a single PGSQL database: <a href=https://demo.pigsty.io/d/pgsql-database>Demo</a></p></blockquote><p>PGSQL Database is the main dashboard for a single PostgreSQL database, providing comprehensive database-level metrics.</p><p><a href=https://demo.pigsty.io/d/pgsql-database><img src=/img/panel/pgsql-database.webp alt=pgsql-database></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0ecd8fa92a2426ecb8dc9ceaff62f45b>12.4.2 - PGCAT Database</h1><div class=lead>Database info retrieved directly from database catalog</div><blockquote><p>Database info from database catalog: <a href=https://demo.pigsty.io/d/pgcat-database>Demo</a></p></blockquote><p>PGCAT Database shows database-level information retrieved directly from PostgreSQL system catalog.</p><p><a href=https://demo.pigsty.io/d/pgcat-database><img src=/img/panel/pgcat-database.webp alt=pgcat-database></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-357ff5497ef591ed19467aefaaf30b9d>12.4.3 - PGSQL Tables</h1><div class=lead>Table/index access metrics within a single database</div><blockquote><p>Table/index access metrics: <a href=https://demo.pigsty.io/d/pgsql-tables>Demo</a></p></blockquote><p>PGSQL Tables shows table and index access metrics for all objects within a single PostgreSQL database.</p><p><a href=https://demo.pigsty.io/d/pgsql-tables><img src=/img/panel/pgsql-tables.webp alt=pgsql-tables></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f9982c1d8e0198daa19cb19992ddc73b>12.4.4 - PGSQL Table</h1><div class=lead>Detailed info for a single table (QPS/RT/index/sequence)</div><blockquote><p>Detailed info for a single table: <a href=https://demo.pigsty.io/d/pgsql-table>Demo</a></p></blockquote><p>PGSQL Table shows detailed metrics for a single table including QPS, response time, index usage, and sequence info.</p><p><a href=https://demo.pigsty.io/d/pgsql-table><img src=/img/panel/pgsql-table.webp alt=pgsql-table></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c99501fec4430d07944e241ee98f8712>12.4.5 - PGCAT Table</h1><div class=lead>Detailed table info from database catalog</div><blockquote><p>Detailed table info from catalog: <a href=https://demo.pigsty.io/d/pgcat-table>Demo</a></p></blockquote><p>PGCAT Table shows detailed table information from database catalog including statistics and bloat analysis.</p><p><a href=https://demo.pigsty.io/d/pgcat-table><img src=/img/panel/pgcat-table.webp alt=pgcat-table></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8cf1de3a04204d7b46c3b3846c17a033>12.4.6 - PGSQL Query</h1><div class=lead>Detailed info for a query type (QPS/RT)</div><blockquote><p>Detailed info for a query type: <a href=https://demo.pigsty.io/d/pgsql-query>Demo</a></p></blockquote><p>PGSQL Query shows detailed metrics for a specific query type including QPS and response time distribution.</p><p><a href=https://demo.pigsty.io/d/pgsql-query><img src=/img/panel/pgsql-query.webp alt=pgsql-query></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0e025bec035b17c9d59be41163595514>12.4.7 - PGCAT Query</h1><div class=lead>Query details from database catalog</div><blockquote><p>Query details from database catalog: <a href=https://demo.pigsty.io/d/pgcat-query>Demo</a></p></blockquote><p>PGCAT Query shows query details from database catalog including SQL text and execution statistics.</p><p><a href=https://demo.pigsty.io/d/pgcat-query><img src=/img/panel/pgcat-query.webp alt=pgcat-query></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0e05e1ef2b7aebfa9cc6f51275cc6cd8>12.4.8 - PGCAT Locks</h1><div class=lead>Activity and lock wait info from database catalog</div><blockquote><p>Activity and lock wait info: <a href=https://demo.pigsty.io/d/pgcat-locks>Demo</a></p></blockquote><p>PGCAT Locks shows active sessions and lock wait information from database catalog.</p><p><a href=https://demo.pigsty.io/d/pgcat-locks><img src=/img/panel/pgcat-locks.webp alt=pgcat-locks></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-eba5c01f53f336bd71d4a7391ec48511>12.4.9 - PGCAT Schema</h1><div class=lead>Schema info from database catalog</div><blockquote><p>Schema info from database catalog: <a href=https://demo.pigsty.io/d/pgcat-schema>Demo</a></p></blockquote><p>PGCAT Schema shows schema-level information from database catalog including tables, indexes, and sequences.</p><p><a href=https://demo.pigsty.io/d/pgcat-schema><img src=/img/panel/pgcat-schema.webp alt=pgcat-schema></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-1f69b3f46163cb973f38581bf88a88a8>13 - Metrics</h1><div class=lead>Complete monitoring metrics reference for the Pigsty PGSQL module</div><p>The <a href=/docs/pgsql><strong><code>PGSQL</code></strong></a> module provides 638 available monitoring metrics.</p><table class=full-width><thead><tr><th>Metric Name</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody><tr><td>ALERTS</td><td>Unknown</td><td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>alertstate</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>ALERTS_FOR_STATE</td><td>Unknown</td><td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>cls:pressure1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>cls:pressure15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>cls:pressure5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>go_gc_duration_seconds</td><td>summary</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>quantile</code>, <code>cls</code></td><td>A summary of the pause duration of garbage collection cycles.</td></tr><tr><td>go_gc_duration_seconds_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>go_gc_duration_seconds_sum</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>go_goroutines</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of goroutines that currently exist.</td></tr><tr><td>go_info</td><td>gauge</td><td><code>version</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Information about the Go environment.</td></tr><tr><td>go_memstats_alloc_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes allocated and still in use.</td></tr><tr><td>go_memstats_alloc_bytes_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of bytes allocated, even if freed.</td></tr><tr><td>go_memstats_buck_hash_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used by the profiling bucket hash table.</td></tr><tr><td>go_memstats_frees_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of frees.</td></tr><tr><td>go_memstats_gc_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for garbage collection system metadata.</td></tr><tr><td>go_memstats_heap_alloc_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes allocated and still in use.</td></tr><tr><td>go_memstats_heap_idle_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes waiting to be used.</td></tr><tr><td>go_memstats_heap_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes that are in use.</td></tr><tr><td>go_memstats_heap_objects</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of allocated objects.</td></tr><tr><td>go_memstats_heap_released_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes released to OS.</td></tr><tr><td>go_memstats_heap_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes obtained from system.</td></tr><tr><td>go_memstats_last_gc_time_seconds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of seconds since 1970 of last garbage collection.</td></tr><tr><td>go_memstats_lookups_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of pointer lookups.</td></tr><tr><td>go_memstats_mallocs_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of mallocs.</td></tr><tr><td>go_memstats_mcache_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes in use by mcache structures.</td></tr><tr><td>go_memstats_mcache_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for mcache structures obtained from system.</td></tr><tr><td>go_memstats_mspan_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes in use by mspan structures.</td></tr><tr><td>go_memstats_mspan_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for mspan structures obtained from system.</td></tr><tr><td>go_memstats_next_gc_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes when next garbage collection will take place.</td></tr><tr><td>go_memstats_other_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for other system allocations.</td></tr><tr><td>go_memstats_stack_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes in use by the stack allocator.</td></tr><tr><td>go_memstats_stack_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes obtained from system for stack allocator.</td></tr><tr><td>go_memstats_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes obtained from system.</td></tr><tr><td>go_threads</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of OS threads created.</td></tr><tr><td>ins:pressure1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>ins:pressure15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>ins:pressure5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>patroni_cluster_unlocked</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if the cluster is unlocked, 0 if locked.</td></tr><tr><td>patroni_dcs_last_seen</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Epoch timestamp when DCS was last contacted successfully by Patroni.</td></tr><tr><td>patroni_failsafe_mode_is_active</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if failsafe mode is active, 0 if inactive.</td></tr><tr><td>patroni_is_paused</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if auto failover is disabled, 0 otherwise.</td></tr><tr><td>patroni_master</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is the leader, 0 otherwise.</td></tr><tr><td>patroni_pending_restart</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if the node needs a restart, 0 otherwise.</td></tr><tr><td>patroni_postgres_in_archive_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if Postgres is replicating from archive, 0 otherwise.</td></tr><tr><td>patroni_postgres_running</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if Postgres is running, 0 otherwise.</td></tr><tr><td>patroni_postgres_server_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Version of Postgres (if running), 0 otherwise.</td></tr><tr><td>patroni_postgres_streaming</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if Postgres is streaming, 0 otherwise.</td></tr><tr><td>patroni_postgres_timeline</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Postgres timeline of this node (if running), 0 otherwise.</td></tr><tr><td>patroni_postmaster_start_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Epoch seconds since Postgres started.</td></tr><tr><td>patroni_primary</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is the leader, 0 otherwise.</td></tr><tr><td>patroni_replica</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is a replica, 0 otherwise.</td></tr><tr><td>patroni_standby_leader</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is the standby_leader, 0 otherwise.</td></tr><tr><td>patroni_sync_standby</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is a sync standby replica, 0 otherwise.</td></tr><tr><td>patroni_up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>patroni_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Patroni semver without periods.</td></tr><tr><td>patroni_xlog_location</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current location of the Postgres transaction log, 0 if this node is not the leader.</td></tr><tr><td>patroni_xlog_paused</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if the Postgres xlog is paused, 0 otherwise.</td></tr><tr><td>patroni_xlog_received_location</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current location of the received Postgres transaction log, 0 if this node is not a replica.</td></tr><tr><td>patroni_xlog_replayed_location</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current location of the replayed Postgres transaction log, 0 if this node is not a replica.</td></tr><tr><td>patroni_xlog_replayed_timestamp</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current timestamp of the replayed Postgres transaction log, 0 if null.</td></tr><tr><td>pg:cls:active_backends</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:active_time_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:active_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:active_time_rate5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:age</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_alloc_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_clean_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_flush_backend_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_flush_checkpoint_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage_15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage_1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage_5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:db_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:file_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:ixact_backends</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:ixact_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lag_bytes</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lag_seconds</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:leader</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:load1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:load15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:load5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lock_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:locks</td><td>Unknown</td><td><code>job</code>, <code>cls</code>, <code>mode</code></td><td>N/A</td></tr><tr><td>pg:cls:log_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lsn_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:members</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:num_backends</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:partition</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:receiver</td><td>Unknown</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>appname</code>, <code>ip</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>N/A</td></tr><tr><td>pg:cls:rlock_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:saturation1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:saturation15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:saturation5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:sender</td><td>Unknown</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:session_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:slot_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:slot_retained_bytes</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:standby_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:sync_state</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:timeline</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_deleted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_fetched_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_inserted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_modified_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_returned_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:wal_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_commit_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_commit_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_commit_rate5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_rollback_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_rollback_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_rollback_rate5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_total_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_total_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_total_sigma15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xlock_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_backends</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_time_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_time_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_time_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:age</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:age_deriv1h</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:age_exhaust</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blk_io_time_seconds_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blk_read_time_seconds_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blk_write_time_seconds_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_access_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_hit_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_hit_ratio1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_read_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:conn_limit</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:conn_usage</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:db_size</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:ixact_backends</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:ixact_time_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:lock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:num_backends</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:rlock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:session_time_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:temp_bytes_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:temp_files_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_deleted_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_fetched_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_inserted_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_modified_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_returned_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:wlock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_commit_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_commit_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_commit_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_rollback_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_rollback_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_rollback_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_sigma15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xlock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:env:active_backends</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:active_time_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:active_time_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:active_time_rate5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:age</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_count</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage_15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage_1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage_5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:ixact_backends</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:ixact_time_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:lag_bytes</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:lag_seconds</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:lsn_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:session_time_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_deleted_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_fetched_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_inserted_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_modified_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_returned_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_commit_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_commit_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_commit_rate5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_rollback_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_rollback_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_rollback_rate5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_total_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_total_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_total_sigma15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:ins:active_backends</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:active_time_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:active_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:active_time_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:age</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:blks_hit_ratio1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_alloc_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_clean_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_flush_backend_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_flush_checkpoint_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ckpt_1h</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ckpt_req_1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ckpt_timed_1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:conn_limit</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:conn_usage</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage_15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage_1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage_5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:db_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:file_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:fs_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:is_leader</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ixact_backends</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ixact_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lag_bytes</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lag_seconds</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:load1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:load15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:load5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:locks</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:log_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lsn_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:mem_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:num_backends</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:rlock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:saturation1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:saturation15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:saturation5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:session_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:slot_retained_bytes</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:space_usage</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:status</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:sync_state</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:target_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code>, <code>ins</code></td><td>N/A</td></tr><tr><td>pg:ins:timeline</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_deleted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_fetched_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_inserted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_modified_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_returned_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:wal_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:wlock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_commit_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_commit_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_commit_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_rollback_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_rollback_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_rollback_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_sigma15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xlock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:query:call_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:query:rt_1m</td><td>Unknown</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:table:scan_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg_activity_count</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Count of connection among (datname,state)</td></tr><tr><td>pg_activity_max_conn_duration</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Max backend session duration since state change among (datname, state)</td></tr><tr><td>pg_activity_max_duration</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Max duration since last state change among (datname, state)</td></tr><tr><td>pg_activity_max_tx_duration</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Max transaction duration since state change among (datname, state)</td></tr><tr><td>pg_archiver_failed_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of failed attempts for archiving WAL files</td></tr><tr><td>pg_archiver_finish_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of WAL files that have been successfully archived</td></tr><tr><td>pg_archiver_last_failed_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time of the last failed archival operation</td></tr><tr><td>pg_archiver_last_finish_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time of the last successful archive operation</td></tr><tr><td>pg_archiver_reset_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which archive statistics were last reset</td></tr><tr><td>pg_backend_count</td><td>gauge</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Database backend process count by backend_type</td></tr><tr><td>pg_bgwriter_buffers_alloc</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers allocated</td></tr><tr><td>pg_bgwriter_buffers_backend</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers written directly by a backend</td></tr><tr><td>pg_bgwriter_buffers_backend_fsync</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times a backend had to execute its own fsync call</td></tr><tr><td>pg_bgwriter_buffers_checkpoint</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers written during checkpoints</td></tr><tr><td>pg_bgwriter_buffers_clean</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers written by the background writer</td></tr><tr><td>pg_bgwriter_checkpoint_sync_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time that has been spent in the portion of checkpoint processing where files are synchronized to disk, in seconds</td></tr><tr><td>pg_bgwriter_checkpoint_write_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time that has been spent in the portion of checkpoint processing where files are written to disk, in seconds</td></tr><tr><td>pg_bgwriter_checkpoints_req</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of requested checkpoints that have been performed</td></tr><tr><td>pg_bgwriter_checkpoints_timed</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of scheduled checkpoints that have been performed</td></tr><tr><td>pg_bgwriter_maxwritten_clean</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times the background writer stopped a cleaning scan because it had written too many buffers</td></tr><tr><td>pg_bgwriter_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which bgwriter statistics were last reset</td></tr><tr><td>pg_boot_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>unix timestamp when postmaster boot</td></tr><tr><td>pg_checkpoint_checkpoint_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint location</td></tr><tr><td>pg_checkpoint_elapse</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Seconds elapsed since latest checkpoint in seconds</td></tr><tr><td>pg_checkpoint_full_page_writes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s full_page_writes enabled</td></tr><tr><td>pg_checkpoint_newest_commit_ts_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s newestCommitTsXid</td></tr><tr><td>pg_checkpoint_next_multi_offset</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextMultiOffset</td></tr><tr><td>pg_checkpoint_next_multixact_id</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextMultiXactId</td></tr><tr><td>pg_checkpoint_next_oid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextOID</td></tr><tr><td>pg_checkpoint_next_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextXID xid</td></tr><tr><td>pg_checkpoint_next_xid_epoch</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextXID epoch</td></tr><tr><td>pg_checkpoint_oldest_active_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestActiveXID</td></tr><tr><td>pg_checkpoint_oldest_commit_ts_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestCommitTsXid</td></tr><tr><td>pg_checkpoint_oldest_multi_dbid</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestMulti&rsquo;s DB OID</td></tr><tr><td>pg_checkpoint_oldest_multi_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestMultiXid</td></tr><tr><td>pg_checkpoint_oldest_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestXID</td></tr><tr><td>pg_checkpoint_oldest_xid_dbid</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestXID&rsquo;s DB OID</td></tr><tr><td>pg_checkpoint_prev_tli</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s PrevTimeLineID</td></tr><tr><td>pg_checkpoint_redo_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s REDO location</td></tr><tr><td>pg_checkpoint_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time of latest checkpoint</td></tr><tr><td>pg_checkpoint_tli</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s TimeLineID</td></tr><tr><td>pg_conf_reload_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since last configuration reload</td></tr><tr><td>pg_db_active_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent executing SQL statements in this database, in seconds</td></tr><tr><td>pg_db_age</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Age of database calculated from datfrozenxid</td></tr><tr><td>pg_db_allow_conn</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>If false(0) then no one can connect to this database.</td></tr><tr><td>pg_db_blk_read_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent reading data file blocks by backends in this database, in seconds</td></tr><tr><td>pg_db_blk_write_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent writing data file blocks by backends in this database, in seconds</td></tr><tr><td>pg_db_blks_access</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times disk blocks that accessed read+hit</td></tr><tr><td>pg_db_blks_hit</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times disk blocks were found already in the buffer cache</td></tr><tr><td>pg_db_blks_read</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read in this database</td></tr><tr><td>pg_db_cks_fail_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which the last data page checksum failure was detected in this database</td></tr><tr><td>pg_db_cks_fails</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of data page checksum failures detected in this database, -1 for not enabled</td></tr><tr><td>pg_db_confl_confl_bufferpin</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to pinned buffers</td></tr><tr><td>pg_db_confl_confl_deadlock</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to deadlocks</td></tr><tr><td>pg_db_confl_confl_lock</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to lock timeouts</td></tr><tr><td>pg_db_confl_confl_snapshot</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to old snapshots</td></tr><tr><td>pg_db_confl_confl_tablespace</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to dropped tablespaces</td></tr><tr><td>pg_db_conflicts</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries canceled due to conflicts with recovery in this database</td></tr><tr><td>pg_db_conn_limit</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Sets maximum number of concurrent connections that can be made to this database. -1 means no limit.</td></tr><tr><td>pg_db_datid</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>OID of the database</td></tr><tr><td>pg_db_deadlocks</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of deadlocks detected in this database</td></tr><tr><td>pg_db_frozen_xid</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>All transaction IDs before this one have been frozened</td></tr><tr><td>pg_db_is_template</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>If true(1), then this database can be cloned by any user with CREATEDB privileges</td></tr><tr><td>pg_db_ixact_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent idling while in a transaction in this database, in seconds</td></tr><tr><td>pg_db_numbackends</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of backends currently connected to this database</td></tr><tr><td>pg_db_reset_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which database statistics were last reset</td></tr><tr><td>pg_db_session_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent by database sessions in this database, in seconds</td></tr><tr><td>pg_db_sessions</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of sessions established to this database</td></tr><tr><td>pg_db_sessions_abandoned</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of database sessions to this database that were terminated because connection to the client was lost</td></tr><tr><td>pg_db_sessions_fatal</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of database sessions to this database that were terminated by fatal errors</td></tr><tr><td>pg_db_sessions_killed</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of database sessions to this database that were terminated by operator intervention</td></tr><tr><td>pg_db_temp_bytes</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of data written to temporary files by queries in this database.</td></tr><tr><td>pg_db_temp_files</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of temporary files created by queries in this database</td></tr><tr><td>pg_db_tup_deleted</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows deleted by queries in this database</td></tr><tr><td>pg_db_tup_fetched</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows fetched by queries in this database</td></tr><tr><td>pg_db_tup_inserted</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows inserted by queries in this database</td></tr><tr><td>pg_db_tup_modified</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows modified by queries in this database</td></tr><tr><td>pg_db_tup_returned</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows returned by queries in this database</td></tr><tr><td>pg_db_tup_updated</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows updated by queries in this database</td></tr><tr><td>pg_db_xact_commit</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of transactions in this database that have been committed</td></tr><tr><td>pg_db_xact_rollback</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of transactions in this database that have been rolled back</td></tr><tr><td>pg_db_xact_total</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of transactions in this database</td></tr><tr><td>pg_downstream_count</td><td>gauge</td><td><code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Count of corresponding state</td></tr><tr><td>pg_exporter_agent_up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg_exporter_last_scrape_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pg_exporter_query_cache_ttl</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times to live of query cache</td></tr><tr><td>pg_exporter_query_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds query spending on scrapping</td></tr><tr><td>pg_exporter_query_scrape_error_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times the query failed</td></tr><tr><td>pg_exporter_query_scrape_hit_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers been scrapped from this query</td></tr><tr><td>pg_exporter_query_scrape_metric_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers of metrics been scrapped from this query</td></tr><tr><td>pg_exporter_query_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pg_exporter_scrape_duration</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pg_exporter_scrape_error_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics and failed</td></tr><tr><td>pg_exporter_scrape_total_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics</td></tr><tr><td>pg_exporter_server_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pg_exporter_server_scrape_error_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg_exporter_server_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pg_exporter_server_scrape_total_seconds</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pg_exporter_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>always be 1 if your could retrieve metrics</td></tr><tr><td>pg_exporter_uptime</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since exporter primary server inited</td></tr><tr><td>pg_flush_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>primary only, location of current wal syncing</td></tr><tr><td>pg_func_calls</td><td>counter</td><td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this function has been called</td></tr><tr><td>pg_func_self_time</td><td>counter</td><td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time spent in this function itself, not including other functions called by it, in ms</td></tr><tr><td>pg_func_total_time</td><td>counter</td><td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time spent in this function and all other functions called by it, in ms</td></tr><tr><td>pg_in_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server is in recovery mode? 1 for yes 0 for no</td></tr><tr><td>pg_index_idx_blks_hit</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of buffer hits in this index</td></tr><tr><td>pg_index_idx_blks_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of disk blocks read from this index</td></tr><tr><td>pg_index_idx_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of index scans initiated on this index</td></tr><tr><td>pg_index_idx_tup_fetch</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of live table rows fetched by simple index scans using this index</td></tr><tr><td>pg_index_idx_tup_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of index entries returned by scans on this index</td></tr><tr><td>pg_index_relpages</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Size of the on-disk representation of this index in pages</td></tr><tr><td>pg_index_reltuples</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Estimate relation tuples</td></tr><tr><td>pg_insert_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>primary only, location of current wal inserting</td></tr><tr><td>pg_io_evictions</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of times a block has been written out from a shared or local buffer</td></tr><tr><td>pg_io_extend_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in extend operations in seconds</td></tr><tr><td>pg_io_extends</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of relation extend operations, each of the size specified in op_bytes.</td></tr><tr><td>pg_io_fsync_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in fsync operations in seconds</td></tr><tr><td>pg_io_fsyncs</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of fsync calls. These are only tracked in context normal</td></tr><tr><td>pg_io_hits</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>The number of times a desired block was found in a shared buffer.</td></tr><tr><td>pg_io_op_bytes</td><td>gauge</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>The number of bytes per unit of I/O read, written, or extended. 8192 by default</td></tr><tr><td>pg_io_read_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in read operations in seconds</td></tr><tr><td>pg_io_reads</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of read operations, each of the size specified in op_bytes.</td></tr><tr><td>pg_io_reset_time</td><td>gauge</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Timestamp at which these statistics were last reset</td></tr><tr><td>pg_io_reuses</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>The number of times an existing buffer in reused</td></tr><tr><td>pg_io_write_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in write operations in seconds</td></tr><tr><td>pg_io_writeback_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in writeback operations in seconds</td></tr><tr><td>pg_io_writebacks</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of units of size op_bytes which the process requested the kernel write out to permanent storage.</td></tr><tr><td>pg_io_writes</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of write operations, each of the size specified in op_bytes.</td></tr><tr><td>pg_is_in_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>1 if in recovery mode</td></tr><tr><td>pg_is_wal_replay_paused</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>1 if wal play paused</td></tr><tr><td>pg_lag</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>replica only, replication lag in seconds</td></tr><tr><td>pg_last_replay_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>time when last transaction been replayed</td></tr><tr><td>pg_lock_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td><td>Number of locks of corresponding mode and database</td></tr><tr><td>pg_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>log sequence number, current write location</td></tr><tr><td>pg_meta_info</td><td>gauge</td><td><code>cls</code>, <code>extensions</code>, <code>version</code>, <code>job</code>, <code>ins</code>, <code>primary_conninfo</code>, <code>conf_path</code>, <code>hba_path</code>, <code>ip</code>, <code>cluster_id</code>, <code>instance</code>, <code>listen_port</code>, <code>wal_level</code>, <code>ver_num</code>, <code>cluster_name</code>, <code>data_dir</code></td><td>constant 1</td></tr><tr><td>pg_query_calls</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times the statement was executed</td></tr><tr><td>pg_query_exec_time</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time spent executing the statement, in seconds</td></tr><tr><td>pg_query_io_time</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time the statement spent reading and writing blocks, in seconds</td></tr><tr><td>pg_query_rows</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of rows retrieved or affected by the statement</td></tr><tr><td>pg_query_sblk_dirtied</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared blocks dirtied by the statement</td></tr><tr><td>pg_query_sblk_hit</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared block cache hits by the statement</td></tr><tr><td>pg_query_sblk_read</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared blocks read by the statement</td></tr><tr><td>pg_query_sblk_written</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared blocks written by the statement</td></tr><tr><td>pg_query_wal_bytes</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of WAL bytes generated by the statement</td></tr><tr><td>pg_receive_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>replica only, location of wal synced to disk</td></tr><tr><td>pg_recovery_backup_end_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Backup end location</td></tr><tr><td>pg_recovery_backup_start_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Backup start location</td></tr><tr><td>pg_recovery_min_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Minimum recovery ending location</td></tr><tr><td>pg_recovery_min_timeline</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Min recovery ending loc&rsquo;s timeline</td></tr><tr><td>pg_recovery_prefetch_block_distance</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>How many blocks ahead the prefetcher is looking</td></tr><tr><td>pg_recovery_prefetch_hit</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they were already in the buffer pool</td></tr><tr><td>pg_recovery_prefetch_io_depth</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>How many prefetches have been initiated but are not yet known to have completed</td></tr><tr><td>pg_recovery_prefetch_prefetch</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks prefetched because they were not in the buffer pool</td></tr><tr><td>pg_recovery_prefetch_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which these recovery prefetch statistics were last reset</td></tr><tr><td>pg_recovery_prefetch_skip_fpw</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because a full page image was included in the WAL</td></tr><tr><td>pg_recovery_prefetch_skip_init</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they would be zero-initialized</td></tr><tr><td>pg_recovery_prefetch_skip_new</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they didn&rsquo;t exist yet</td></tr><tr><td>pg_recovery_prefetch_skip_rep</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they were already recently prefetched</td></tr><tr><td>pg_recovery_prefetch_wal_distance</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>How many bytes ahead the prefetcher is looking</td></tr><tr><td>pg_recovery_require_record</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>End-of-backup record required</td></tr><tr><td>pg_recv_flush_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Last write-ahead log location already received and flushed to disk</td></tr><tr><td>pg_recv_flush_tli</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Timeline number of last write-ahead log location received and flushed to disk</td></tr><tr><td>pg_recv_init_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>First write-ahead log location used when WAL receiver is started</td></tr><tr><td>pg_recv_init_tli</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>First timeline number used when WAL receiver is started</td></tr><tr><td>pg_recv_msg_recv_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Receipt time of last message received from origin WAL sender</td></tr><tr><td>pg_recv_msg_send_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Send time of last message received from origin WAL sender</td></tr><tr><td>pg_recv_pid</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Process ID of the WAL receiver process</td></tr><tr><td>pg_recv_reported_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Last write-ahead log location reported to origin WAL sender</td></tr><tr><td>pg_recv_reported_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Time of last write-ahead log location reported to origin WAL sender</td></tr><tr><td>pg_recv_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Time of current snapshot</td></tr><tr><td>pg_recv_write_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Last write-ahead log location already received and written to disk, but not flushed.</td></tr><tr><td>pg_relkind_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>relkind</code></td><td>Number of relations of corresponding relkind</td></tr><tr><td>pg_repl_backend_xmin</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>This standby&rsquo;s xmin horizon reported by hot_standby_feedback.</td></tr><tr><td>pg_repl_client_port</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>TCP port number that the client is using for communication with this WAL sender, or -1 if a Unix socket is used</td></tr><tr><td>pg_repl_flush_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position flushed to disk by this standby server diff with current lsn</td></tr><tr><td>pg_repl_flush_lag</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written and flushed it</td></tr><tr><td>pg_repl_flush_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location flushed to disk by this standby server</td></tr><tr><td>pg_repl_launch_time</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time when this process was started, i.e., when the client connected to this WAL sender</td></tr><tr><td>pg_repl_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current log position on this server</td></tr><tr><td>pg_repl_replay_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position replayed into the database on this standby server diff with current lsn</td></tr><tr><td>pg_repl_replay_lag</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written, flushed and applied it</td></tr><tr><td>pg_repl_replay_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location replayed into the database on this standby server</td></tr><tr><td>pg_repl_reply_time</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Send time of last reply message received from standby server</td></tr><tr><td>pg_repl_sent_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position sent to this standby server diff with current lsn</td></tr><tr><td>pg_repl_sent_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location sent on this connection</td></tr><tr><td>pg_repl_state</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current WAL sender encoded state 0-4 for streaming startup catchup backup stopping</td></tr><tr><td>pg_repl_sync_priority</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Priority of this standby server for being chosen as the synchronous standby</td></tr><tr><td>pg_repl_sync_state</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Encoded synchronous state of this standby server, 0-3 for async potential sync quorum</td></tr><tr><td>pg_repl_time</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current timestamp in unix epoch</td></tr><tr><td>pg_repl_write_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position written to disk by this standby server diff with current lsn</td></tr><tr><td>pg_repl_write_lag</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written it</td></tr><tr><td>pg_repl_write_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location written to disk by this standby server</td></tr><tr><td>pg_replay_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>replica only, location of wal applied</td></tr><tr><td>pg_seq_blks_hit</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td><td>Number of buffer hits in this sequence</td></tr><tr><td>pg_seq_blks_read</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td><td>Number of disk blocks read from this sequence</td></tr><tr><td>pg_seq_last_value</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td><td>The last sequence value written to disk</td></tr><tr><td>pg_setting_block_size</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>pg page block size, 8192 by default</td></tr><tr><td>pg_setting_data_checksums</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>whether data checksum is enabled, 1 enabled 0 disabled</td></tr><tr><td>pg_setting_max_connections</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>number of concurrent connections to the database server</td></tr><tr><td>pg_setting_max_locks_per_transaction</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>no more than this many distinct objects can be locked at any one time</td></tr><tr><td>pg_setting_max_prepared_transactions</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of transactions that can be in the prepared state simultaneously</td></tr><tr><td>pg_setting_max_replication_slots</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of replication slots</td></tr><tr><td>pg_setting_max_wal_senders</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of concurrent connections from standby servers</td></tr><tr><td>pg_setting_max_worker_processes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of background processes that the system can support</td></tr><tr><td>pg_setting_wal_log_hints</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>whether wal_log_hints is enabled, 1 enabled 0 disabled</td></tr><tr><td>pg_size_bytes</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>File size in bytes</td></tr><tr><td>pg_slot_active</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>True(1) if this slot is currently actively being used</td></tr><tr><td>pg_slot_catalog_xmin</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The oldest transaction affecting the system catalogs that this slot needs the database to retain.</td></tr><tr><td>pg_slot_confirm_lsn</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The address (LSN) up to which the logical slot&rsquo;s consumer has confirmed receiving data.</td></tr><tr><td>pg_slot_reset_time</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>When statistics were last reset</td></tr><tr><td>pg_slot_restart_lsn</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The address (LSN) of oldest WAL which still might be required by the consumer of this slot</td></tr><tr><td>pg_slot_retained_bytes</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Size of bytes that retained for this slot</td></tr><tr><td>pg_slot_safe_wal_size</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>bytes that can be written to WAL which will not make slot into lost</td></tr><tr><td>pg_slot_spill_bytes</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes that spilled to disk due to logical decode mem exceeding</td></tr><tr><td>pg_slot_spill_count</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that spilled to disk due to logical decode mem exceeding (a xact can be spilled multiple times)</td></tr><tr><td>pg_slot_spill_txns</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that spilled to disk due to logical decode mem exceeding (subtrans included)</td></tr><tr><td>pg_slot_stream_bytes</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes that streamed to decoding output plugin after mem exceed</td></tr><tr><td>pg_slot_stream_count</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that streamed to decoding output plugin after mem exceed (a xact can be streamed multiple times)</td></tr><tr><td>pg_slot_stream_txns</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that streamed to decoding output plugin after mem exceed</td></tr><tr><td>pg_slot_temporary</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>True(1) if this is a temporary replication slot.</td></tr><tr><td>pg_slot_total_bytes</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of decoded bytes sent to the decoding output plugin for this slot</td></tr><tr><td>pg_slot_total_txns</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of decoded xacts sent to the decoding output plugin for this slot</td></tr><tr><td>pg_slot_wal_status</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>WAL reserve status 0-3 means reserved,extended,unreserved,lost, -1 means other</td></tr><tr><td>pg_slot_xmin</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The oldest transaction that this slot needs the database to retain.</td></tr><tr><td>pg_slru_blks_exists</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks checked for existence for this SLRU</td></tr><tr><td>pg_slru_blks_hit</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times disk blocks were found already in the SLRU, so that a read was not necessary</td></tr><tr><td>pg_slru_blks_read</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read for this SLRU</td></tr><tr><td>pg_slru_blks_written</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks written for this SLRU</td></tr><tr><td>pg_slru_blks_zeroed</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks zeroed during initializations</td></tr><tr><td>pg_slru_flushes</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of flushes of dirty data for this SLRU</td></tr><tr><td>pg_slru_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which these statistics were last reset</td></tr><tr><td>pg_slru_truncates</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of truncates for this SLRU</td></tr><tr><td>pg_ssl_disabled</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of client connection that does not use ssl</td></tr><tr><td>pg_ssl_enabled</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of client connection that use ssl</td></tr><tr><td>pg_sync_standby_enabled</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>names</code>, <code>instance</code>, <code>cls</code></td><td>Synchronous commit enabled, 1 if enabled, 0 if disabled</td></tr><tr><td>pg_table_age</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Age of this table in vacuum cycles</td></tr><tr><td>pg_table_analyze_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been manually analyzed</td></tr><tr><td>pg_table_autoanalyze_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been analyzed by the autovacuum daemon</td></tr><tr><td>pg_table_autovacuum_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been vacuumed by the autovacuum daemon</td></tr><tr><td>pg_table_frozenxid</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>All txid before this have been frozen on this table</td></tr><tr><td>pg_table_heap_blks_hit</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffer hits in this table</td></tr><tr><td>pg_table_heap_blks_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read from this table</td></tr><tr><td>pg_table_idx_blks_hit</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffer hits in all indexes on this table</td></tr><tr><td>pg_table_idx_blks_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read from all indexes on this table</td></tr><tr><td>pg_table_idx_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of index scans initiated on this table</td></tr><tr><td>pg_table_idx_tup_fetch</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of live rows fetched by index scans</td></tr><tr><td>pg_table_kind</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Relation kind r/table/114</td></tr><tr><td>pg_table_n_dead_tup</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of dead rows</td></tr><tr><td>pg_table_n_ins_since_vacuum</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of rows inserted since this table was last vacuumed</td></tr><tr><td>pg_table_n_live_tup</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of live rows</td></tr><tr><td>pg_table_n_mod_since_analyze</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of rows modified since this table was last analyzed</td></tr><tr><td>pg_table_n_tup_del</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows deleted</td></tr><tr><td>pg_table_n_tup_hot_upd</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows HOT updated (i.e with no separate index update required)</td></tr><tr><td>pg_table_n_tup_ins</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows inserted</td></tr><tr><td>pg_table_n_tup_mod</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows modified (insert + update + delete)</td></tr><tr><td>pg_table_n_tup_newpage_upd</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows updated where the successor version goes onto a new heap page</td></tr><tr><td>pg_table_n_tup_upd</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows updated (includes HOT updated rows)</td></tr><tr><td>pg_table_ncols</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of columns in the table</td></tr><tr><td>pg_table_pages</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Size of the on-disk representation of this table in pages</td></tr><tr><td>pg_table_relid</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Relation oid of this table</td></tr><tr><td>pg_table_seq_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of sequential scans initiated on this table</td></tr><tr><td>pg_table_seq_tup_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of live rows fetched by sequential scans</td></tr><tr><td>pg_table_size_bytes</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total bytes of this table (including toast, index, toast index)</td></tr><tr><td>pg_table_size_indexsize</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes of all related indexes of this table</td></tr><tr><td>pg_table_size_relsize</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes of this table itself (main, vm, fsm)</td></tr><tr><td>pg_table_size_toastsize</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes of toast tables of this table</td></tr><tr><td>pg_table_tbl_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of scans initiated on this table</td></tr><tr><td>pg_table_tup_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of live rows fetched by scans</td></tr><tr><td>pg_table_tuples</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>All txid before this have been frozen on this table</td></tr><tr><td>pg_table_vacuum_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been manually vacuumed (not counting VACUUM FULL)</td></tr><tr><td>pg_timestamp</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>database current timestamp</td></tr><tr><td>pg_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>last scrape was able to connect to the server: 1 for yes, 0 for no</td></tr><tr><td>pg_uptime</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since postmaster start</td></tr><tr><td>pg_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server version number</td></tr><tr><td>pg_wait_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>event</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Count of WaitEvent on target database</td></tr><tr><td>pg_wal_buffers_full</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times WAL data was written to disk because WAL buffers became full</td></tr><tr><td>pg_wal_bytes</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of WAL generated in bytes</td></tr><tr><td>pg_wal_fpi</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of WAL full page images generated</td></tr><tr><td>pg_wal_records</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of WAL records generated</td></tr><tr><td>pg_wal_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>When statistics were last reset</td></tr><tr><td>pg_wal_sync</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times WAL files were synced to disk via issue_xlog_fsync request</td></tr><tr><td>pg_wal_sync_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time spent syncing WAL files to disk via issue_xlog_fsync request, in seconds</td></tr><tr><td>pg_wal_write</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times WAL buffers were written out to disk via XLogWrite request.</td></tr><tr><td>pg_wal_write_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time spent writing WAL buffers to disk via XLogWrite request in seconds</td></tr><tr><td>pg_write_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>primary only, location of current wal writing</td></tr><tr><td>pg_xact_xmax</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>First as-yet-unassigned txid. txid >= this are invisible.</td></tr><tr><td>pg_xact_xmin</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Earliest txid that is still active</td></tr><tr><td>pg_xact_xnum</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current active transaction count</td></tr><tr><td>pgbouncer:cls:load1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:cls:load15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:cls:load5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:conn_usage</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:conn_usage_reserve</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_current_conn</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_disabled</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_max_conn</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_paused</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_reserve_size</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_size</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:free_clients</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:free_servers</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:load1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:load15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:load5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:login_clients</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:pool_databases</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:pool_users</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:pools</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:used_clients</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer_database_current_connections</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Current number of connections for this database</td></tr><tr><td>pgbouncer_database_disabled</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>True(1) if this database is currently disabled, else 0</td></tr><tr><td>pgbouncer_database_max_connections</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Maximum number of allowed connections for this database</td></tr><tr><td>pgbouncer_database_min_pool_size</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Minimum number of server connections</td></tr><tr><td>pgbouncer_database_paused</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>True(1) if this database is currently paused, else 0</td></tr><tr><td>pgbouncer_database_pool_size</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Maximum number of server connections</td></tr><tr><td>pgbouncer_database_reserve_pool</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Maximum number of additional connections for this database</td></tr><tr><td>pgbouncer_exporter_agent_up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer_exporter_last_scrape_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pgbouncer_exporter_query_cache_ttl</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times to live of query cache</td></tr><tr><td>pgbouncer_exporter_query_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds query spending on scrapping</td></tr><tr><td>pgbouncer_exporter_query_scrape_error_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times the query failed</td></tr><tr><td>pgbouncer_exporter_query_scrape_hit_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers been scrapped from this query</td></tr><tr><td>pgbouncer_exporter_query_scrape_metric_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers of metrics been scrapped from this query</td></tr><tr><td>pgbouncer_exporter_query_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pgbouncer_exporter_scrape_duration</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pgbouncer_exporter_scrape_error_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics and failed</td></tr><tr><td>pgbouncer_exporter_scrape_total_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics</td></tr><tr><td>pgbouncer_exporter_server_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pgbouncer_exporter_server_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pgbouncer_exporter_server_scrape_total_seconds</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pgbouncer_exporter_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>always be 1 if your could retrieve metrics</td></tr><tr><td>pgbouncer_exporter_uptime</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since exporter primary server inited</td></tr><tr><td>pgbouncer_in_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server is in recovery mode? 1 for yes 0 for no</td></tr><tr><td>pgbouncer_list_items</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>list</code>, <code>cls</code></td><td>Number of corresponding pgbouncer object</td></tr><tr><td>pgbouncer_pool_active_cancel_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that have forwarded query cancellations to the server and are waiting for the server response.</td></tr><tr><td>pgbouncer_pool_active_cancel_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are currently forwarding a cancel request</td></tr><tr><td>pgbouncer_pool_active_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that are linked to server connection and can process queries</td></tr><tr><td>pgbouncer_pool_active_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are linked to a client</td></tr><tr><td>pgbouncer_pool_cancel_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that have not forwarded query cancellations to the server yet.</td></tr><tr><td>pgbouncer_pool_cancel_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>cancel requests have completed that were sent to cancel a query on this server</td></tr><tr><td>pgbouncer_pool_idle_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are unused and immediately usable for client queries</td></tr><tr><td>pgbouncer_pool_login_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections currently in the process of logging in</td></tr><tr><td>pgbouncer_pool_maxwait</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>How long the first(oldest) client in the queue has waited, in seconds, key metric</td></tr><tr><td>pgbouncer_pool_maxwait_us</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Microsecond part of the maximum waiting time.</td></tr><tr><td>pgbouncer_pool_tested_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are currently running reset or check query</td></tr><tr><td>pgbouncer_pool_used_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that have been idle for more than server_check_delay (means have to run check query)</td></tr><tr><td>pgbouncer_pool_waiting_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that have sent queries but have not yet got a server connection</td></tr><tr><td>pgbouncer_stat_avg_query_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average queries per second in last stat period</td></tr><tr><td>pgbouncer_stat_avg_query_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average query duration, in seconds</td></tr><tr><td>pgbouncer_stat_avg_recv</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average received (from clients) bytes per second</td></tr><tr><td>pgbouncer_stat_avg_sent</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average sent (to clients) bytes per second</td></tr><tr><td>pgbouncer_stat_avg_wait_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent by clients waiting for a server, in seconds (average per second).</td></tr><tr><td>pgbouncer_stat_avg_xact_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average transactions per second in last stat period</td></tr><tr><td>pgbouncer_stat_avg_xact_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average transaction duration, in seconds</td></tr><tr><td>pgbouncer_stat_total_query_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of SQL queries pooled by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_query_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of seconds spent when executing queries</td></tr><tr><td>pgbouncer_stat_total_received</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total volume in bytes of network traffic received by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_sent</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total volume in bytes of network traffic sent by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_wait_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent by clients waiting for a server, in seconds</td></tr><tr><td>pgbouncer_stat_total_xact_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of SQL transactions pooled by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_xact_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of seconds spent when in a transaction</td></tr><tr><td>pgbouncer_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>last scrape was able to connect to the server: 1 for yes, 0 for no</td></tr><tr><td>pgbouncer_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server version number</td></tr><tr><td>process_cpu_seconds_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total user and system CPU time spent in seconds.</td></tr><tr><td>process_max_fds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Maximum number of open file descriptors.</td></tr><tr><td>process_open_fds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of open file descriptors.</td></tr><tr><td>process_resident_memory_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Resident memory size in bytes.</td></tr><tr><td>process_start_time_seconds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Start time of the process since unix epoch in seconds.</td></tr><tr><td>process_virtual_memory_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Virtual memory size in bytes.</td></tr><tr><td>process_virtual_memory_max_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Maximum amount of virtual memory available in bytes.</td></tr><tr><td>promhttp_metric_handler_requests_in_flight</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current number of scrapes being served.</td></tr><tr><td>promhttp_metric_handler_requests_total</td><td>counter</td><td><code>code</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of scrapes by HTTP status code.</td></tr><tr><td>scrape_duration_seconds</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>scrape_samples_post_metric_relabeling</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>scrape_samples_scraped</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>scrape_series_added</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-aecdecaf4fe39eee883ee97a664ab88f>14 - Parameters</h1><div class=lead>Customize PostgreSQL clusters with 120 parameters in the PGSQL module</div><p>The <a href=/docs/pgsql><code>PGSQL</code></a> module needs to be installed on nodes managed by Pigsty (i.e., nodes that have the <a href=/docs/node><code>NODE</code></a> module configured), and also requires an available <a href=/docs/etcd><code>ETCD</code></a> cluster in your deployment to store cluster metadata.</p><p>Installing the <code>PGSQL</code> module on a single node will create a standalone PGSQL server/instance, i.e., a <a href=/docs/pgsql/config#primary>primary</a> instance.
Installing on additional nodes will create <a href=/docs/pgsql/config#replica>read replicas</a>, which can serve as standby instances and handle read-only requests.
You can also create <a href=/docs/pgsql/config#offline>offline</a> instances for ETL/OLAP/interactive queries, use <a href=/docs/pgsql/config#sync-standby>sync standby</a> and <a href=/docs/pgsql/config#quorum-commit>quorum commit</a> to improve data consistency,
or even set up <a href=/docs/pgsql/config#standby-cluster>standby clusters</a> and <a href=/docs/pgsql/config#delayed-cluster>delayed clusters</a> to quickly respond to data loss caused by human errors and software defects.</p><p>You can define multiple PGSQL clusters and further organize them into a horizontal sharding cluster: Pigsty natively supports <a href=/docs/pgsql/config#citus-cluster>Citus cluster groups</a>, allowing you to upgrade your standard PGSQL cluster in-place to a distributed database cluster.</p><blockquote><p>Pigsty v4.0 uses PostgreSQL 18 by default and introduces new parameters such as <code>pg_io_method</code> and <code>pgbackrest_exporter</code>.</p></blockquote><hr><table><thead><tr><th style=text-align:left>Section</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_id><code>PG_ID</code></a></td><td style=text-align:left>PostgreSQL cluster and instance identity parameters</td></tr><tr><td style=text-align:left><a href=#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:left>Business users, databases, services and access control rule definition</td></tr><tr><td style=text-align:left><a href=#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:left>PostgreSQL installation: version, paths, packages</td></tr><tr><td style=text-align:left><a href=#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:left>PostgreSQL cluster initialization: Patroni high availability</td></tr><tr><td style=text-align:left><a href=#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:left>PostgreSQL cluster template provisioning: roles, privileges, extensions</td></tr><tr><td style=text-align:left><a href=#pg_backup><code>PG_BACKUP</code></a></td><td style=text-align:left>pgBackRest backup and recovery configuration</td></tr><tr><td style=text-align:left><a href=#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:left>Service exposure, connection pooling, VIP, DNS client access config</td></tr><tr><td style=text-align:left><a href=#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:left>PostgreSQL monitoring exporter configuration</td></tr><tr><td style=text-align:left><a href=#pg_remove><code>PG_REMOVE</code></a></td><td style=text-align:left>PostgreSQL instance cleanup and uninstall configuration</td></tr></tbody></table><hr><h2 id=parameter-overview>Parameter Overview</h2><hr><p><a href=#pg_id><code>PG_ID</code></a> parameters are used to define PostgreSQL cluster and instance identity, including cluster name, instance sequence number, role, shard, and other core identity parameters.</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_mode><code>pg_mode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql cluster mode: pgsql,citus,mssql,mysql,polar,ivory,oracle,gpsql</td></tr><tr><td style=text-align:left><a href=#pg_cluster><code>pg_cluster</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql cluster name, REQUIRED identity parameter</td></tr><tr><td style=text-align:left><a href=#pg_seq><code>pg_seq</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>pgsql instance seq number, REQUIRED identity parameter</td></tr><tr><td style=text-align:left><a href=#pg_role><code>pg_role</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>pgsql instance role, REQUIRED, could be primary, replica, offline</td></tr><tr><td style=text-align:left><a href=#pg_instances><code>pg_instances</code></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>define multiple pg instances on node in <code>{port:ins_vars}</code> format</td></tr><tr><td style=text-align:left><a href=#pg_upstream><code>pg_upstream</code></a></td><td style=text-align:center><code>ip</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>repl upstream ip addr for standby cluster or cascade replica</td></tr><tr><td style=text-align:left><a href=#pg_shard><code>pg_shard</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql shard name, REQUIRED identity for sharding clusters like citus</td></tr><tr><td style=text-align:left><a href=#pg_group><code>pg_group</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql shard index, REQUIRED identity for sharding clusters like citus</td></tr><tr><td style=text-align:left><a href=#gp_role><code>gp_role</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>greenplum role of this cluster, could be master or segment</td></tr><tr><td style=text-align:left><a href=#pg_exporters><code>pg_exporters</code></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>additional pg_exporters to monitor remote postgres instances</td></tr><tr><td style=text-align:left><a href=#pg_offline_query><code>pg_offline_query</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>set to true to mark this replica as offline instance for offline queries</td></tr></tbody></table><hr><p><a href=#pg_business><code>PG_BUSINESS</code></a> parameters are used to define business users, databases, services and access control rules, as well as default system user credentials.</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_users><code>pg_users</code></a></td><td style=text-align:center><code>user[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres business users</td></tr><tr><td style=text-align:left><a href=#pg_databases><code>pg_databases</code></a></td><td style=text-align:center><code>database[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres business databases</td></tr><tr><td style=text-align:left><a href=#pg_services><code>pg_services</code></a></td><td style=text-align:center><code>service[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres business services</td></tr><tr><td style=text-align:left><a href=#pg_hba_rules><code>pg_hba_rules</code></a></td><td style=text-align:center><code>hba[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>business hba rules for postgres</td></tr><tr><td style=text-align:left><a href=#pgb_hba_rules><code>pgb_hba_rules</code></a></td><td style=text-align:center><code>hba[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>business hba rules for pgbouncer</td></tr><tr><td style=text-align:left><a href=#pg_crontab><code>pg_crontab</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>crontab entries for postgres dbsu</td></tr><tr><td style=text-align:left><a href=#pg_replication_username><code>pg_replication_username</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres replication username, <code>replicator</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_replication_password><code>pg_replication_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres replication password, <code>DBUser.Replicator</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_admin_username><code>pg_admin_username</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres admin username, <code>dbuser_dba</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_admin_password><code>pg_admin_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres admin password in plain text, <code>DBUser.DBA</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_monitor_username><code>pg_monitor_username</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres monitor username, <code>dbuser_monitor</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_monitor_password><code>pg_monitor_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres monitor password, <code>DBUser.Monitor</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_dbsu_password><code>pg_dbsu_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>dbsu password, empty string disables it by default, best not set</td></tr></tbody></table><hr><p><a href=#pg_install><code>PG_INSTALL</code></a> parameters are used to configure PostgreSQL installation options, including version, paths, packages, and extensions.</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_dbsu><code>pg_dbsu</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>os dbsu name, <code>postgres</code> by default, better not change it</td></tr><tr><td style=text-align:left><a href=#pg_dbsu_uid><code>pg_dbsu_uid</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>os dbsu uid and gid, 26 for default postgres user and group</td></tr><tr><td style=text-align:left><a href=#pg_dbsu_sudo><code>pg_dbsu_sudo</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>dbsu sudo privilege, none,limit,all,nopass. limit by default</td></tr><tr><td style=text-align:left><a href=#pg_dbsu_home><code>pg_dbsu_home</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgresql home directory, <code>/var/lib/pgsql</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_dbsu_ssh_exchange><code>pg_dbsu_ssh_exchange</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>exchange postgres dbsu ssh key among same pgsql cluster</td></tr><tr><td style=text-align:left><a href=#pg_version><code>pg_version</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres major version to be installed, 18 by default</td></tr><tr><td style=text-align:left><a href=#pg_bin_dir><code>pg_bin_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres binary dir, <code>/usr/pgsql/bin</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_log_dir><code>pg_log_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres log dir, <code>/pg/log/postgres</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_packages><code>pg_packages</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg packages to be installed, <code>${pg_version}</code> will be replaced</td></tr><tr><td style=text-align:left><a href=#pg_extensions><code>pg_extensions</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg extensions to be installed, <code>${pg_version}</code> will be replaced</td></tr></tbody></table><hr><p><a href=#pg_bootstrap><code>PG_BOOTSTRAP</code></a> parameters are used to configure PostgreSQL cluster initialization, including Patroni high availability, data directory, storage, networking, encoding, and other core settings.</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_data><code>pg_data</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres data directory, <code>/pg/data</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_fs_main><code>pg_fs_main</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>mountpoint/path for pg main data, <code>/data/postgres</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_fs_backup><code>pg_fs_backup</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>mountpoint/path for pg backup data, <code>/data/backups</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_storage_type><code>pg_storage_type</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>storage type for pg main data, SSD,HDD. SSD by default</td></tr><tr><td style=text-align:left><a href=#pg_dummy_filesize><code>pg_dummy_filesize</code></a></td><td style=text-align:center><code>size</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>size of <code>/pg/dummy</code>, hold 64MB disk space for emergency use</td></tr><tr><td style=text-align:left><a href=#pg_listen><code>pg_listen</code></a></td><td style=text-align:center><code>ip(s)</code></td><td style=text-align:center><code>C/I</code></td><td style=text-align:left>postgres/pgbouncer listen addr, comma separated list, <code>0.0.0.0</code></td></tr><tr><td style=text-align:left><a href=#pg_port><code>pg_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres listen port, 5432 by default</td></tr><tr><td style=text-align:left><a href=#pg_localhost><code>pg_localhost</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres unix socket dir for localhost connection</td></tr><tr><td style=text-align:left><a href=#pg_namespace><code>pg_namespace</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>top level key namespace in etcd, used by patroni & vip</td></tr><tr><td style=text-align:left><a href=#patroni_enabled><code>patroni_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>if disabled, no postgres cluster will be created during init</td></tr><tr><td style=text-align:left><a href=#patroni_mode><code>patroni_mode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni working mode: default,pause,remove</td></tr><tr><td style=text-align:left><a href=#patroni_port><code>patroni_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni listen port, 8008 by default</td></tr><tr><td style=text-align:left><a href=#patroni_log_dir><code>patroni_log_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni log dir, <code>/pg/log/patroni</code> by default</td></tr><tr><td style=text-align:left><a href=#patroni_ssl_enabled><code>patroni_ssl_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>secure patroni RestAPI communications with SSL?</td></tr><tr><td style=text-align:left><a href=#patroni_watchdog_mode><code>patroni_watchdog_mode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni watchdog mode: automatic,required,off. off by default</td></tr><tr><td style=text-align:left><a href=#patroni_username><code>patroni_username</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni restapi username, <code>postgres</code> by default</td></tr><tr><td style=text-align:left><a href=#patroni_password><code>patroni_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni restapi password, <code>Patroni.API</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_primary_db><code>pg_primary_db</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>primary database name, used by citus,etc. <code>postgres</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_parameters><code>pg_parameters</code></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>extra parameters in postgresql.auto.conf</td></tr><tr><td style=text-align:left><a href=#pg_files><code>pg_files</code></a></td><td style=text-align:center><code>path[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>extra files to be copied to PGDATA (e.g. license files)</td></tr><tr><td style=text-align:left><a href=#pg_conf><code>pg_conf</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>config template: oltp,olap,crit,tiny. <code>oltp.yml</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_max_conn><code>pg_max_conn</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres max connections, <code>auto</code> will use recommended value</td></tr><tr><td style=text-align:left><a href=#pg_shared_buffer_ratio><code>pg_shared_buffer_ratio</code></a></td><td style=text-align:center><code>float</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres shared buffer memory ratio, 0.25 by default, 0.1~0.4</td></tr><tr><td style=text-align:left><a href=#pg_rto><code>pg_rto</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>recovery time objective in seconds, <code>30s</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_rpo><code>pg_rpo</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>recovery point objective in bytes, <code>1MiB</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_libs><code>pg_libs</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>preloaded libraries, <code>pg_stat_statements,auto_explain</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_delay><code>pg_delay</code></a></td><td style=text-align:center><code>interval</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>WAL replay apply delay for standby cluster, for delayed replica</td></tr><tr><td style=text-align:left><a href=#pg_checksum><code>pg_checksum</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>enable data checksum for postgres cluster?</td></tr><tr><td style=text-align:left><a href=#pg_pwd_enc><code>pg_pwd_enc</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>password encryption algorithm: fixed to scram-sha-256</td></tr><tr><td style=text-align:left><a href=#pg_encoding><code>pg_encoding</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>database cluster encoding, <code>UTF8</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_locale><code>pg_locale</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>database cluster locale, <code>C</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_lc_collate><code>pg_lc_collate</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>database cluster collate, <code>C</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_lc_ctype><code>pg_lc_ctype</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>database character type, <code>C</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_io_method><code>pg_io_method</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>PostgreSQL IO method: <code>auto</code>, <code>sync</code>, <code>worker</code>, <code>io_uring</code></td></tr><tr><td style=text-align:left><a href=#pg_etcd_password><code>pg_etcd_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>etcd password for this PostgreSQL cluster, cluster name by default</td></tr><tr><td style=text-align:left><a href=#pgsodium_key><code>pgsodium_key</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsodium encryption master key, 64 hex digits, sha256(pg_cluster)</td></tr><tr><td style=text-align:left><a href=#pgsodium_getkey_script><code>pgsodium_getkey_script</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsodium getkey script path, uses template pgsodium_getkey</td></tr></tbody></table><hr><p><a href=#pg_provision><code>PG_PROVISION</code></a> parameters are used to configure PostgreSQL cluster template provisioning, including default roles, privileges, schemas, extensions, and HBA rules.</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_provision><code>pg_provision</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>provision postgres cluster content after bootstrap?</td></tr><tr><td style=text-align:left><a href=#pg_init><code>pg_init</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>init script for cluster template, <code>pg-init</code> by default</td></tr><tr><td style=text-align:left><a href=#pg_default_roles><code>pg_default_roles</code></a></td><td style=text-align:center><code>role[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>default predefined roles and system users in postgres</td></tr><tr><td style=text-align:left><a href=#pg_default_privileges><code>pg_default_privileges</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>default privileges when created by admin user</td></tr><tr><td style=text-align:left><a href=#pg_default_schemas><code>pg_default_schemas</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>default schemas to be created</td></tr><tr><td style=text-align:left><a href=#pg_default_extensions><code>pg_default_extensions</code></a></td><td style=text-align:center><code>extension[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>default extensions to be created</td></tr><tr><td style=text-align:left><a href=#pg_reload><code>pg_reload</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>A</code></td><td style=text-align:left>reload postgres config after hba changes?</td></tr><tr><td style=text-align:left><a href=#pg_default_hba_rules><code>pg_default_hba_rules</code></a></td><td style=text-align:center><code>hba[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>postgres default host-based auth rules, global default HBA</td></tr><tr><td style=text-align:left><a href=#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a></td><td style=text-align:center><code>hba[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>pgbouncer default host-based auth rules, global default HBA</td></tr></tbody></table><hr><p><a href=#pg_backup><code>PG_BACKUP</code></a> parameters are used to configure pgBackRest backup and recovery, including repository type, paths, and retention policies.</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pgbackrest_enabled><code>pgbackrest_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>enable pgbackrest on pgsql host?</td></tr><tr><td style=text-align:left><a href=#pgbackrest_clean><code>pgbackrest_clean</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>remove previous pg backup data during init?</td></tr><tr><td style=text-align:left><a href=#pgbackrest_log_dir><code>pgbackrest_log_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbackrest log dir, <code>/pg/log/pgbackrest</code> by default</td></tr><tr><td style=text-align:left><a href=#pgbackrest_method><code>pgbackrest_method</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbackrest repo method: local,minio,etc&mldr;</td></tr><tr><td style=text-align:left><a href=#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>perform full backup after init? <code>true</code> by default</td></tr><tr><td style=text-align:left><a href=#pgbackrest_repo><code>pgbackrest_repo</code></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>pgbackrest repo definition</td></tr></tbody></table><hr><p><a href=#pg_access><code>PG_ACCESS</code></a> parameters are used to configure service exposure, connection pooling, VIP, DNS, and other client access options.</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pgbouncer_enabled><code>pgbouncer_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>if disabled, pgbouncer will not be configured</td></tr><tr><td style=text-align:left><a href=#pgbouncer_port><code>pgbouncer_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer listen port, 6432 by default</td></tr><tr><td style=text-align:left><a href=#pgbouncer_log_dir><code>pgbouncer_log_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer log dir, <code>/pg/log/pgbouncer</code> by default</td></tr><tr><td style=text-align:left><a href=#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>use AuthQuery to get unlisted business users from postgres?</td></tr><tr><td style=text-align:left><a href=#pgbouncer_poolmode><code>pgbouncer_poolmode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pool mode: transaction,session,statement. transaction by default</td></tr><tr><td style=text-align:left><a href=#pgbouncer_sslmode><code>pgbouncer_sslmode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer client ssl mode, disabled by default</td></tr><tr><td style=text-align:left><a href=#pgbouncer_ignore_param><code>pgbouncer_ignore_param</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer ignore startup parameters list</td></tr><tr><td style=text-align:left><a href=#pg_weight><code>pg_weight</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>relative load balancing weight in service, 0-255, 100 by default</td></tr><tr><td style=text-align:left><a href=#pg_service_provider><code>pg_service_provider</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>dedicated haproxy node group name, or use local haproxy</td></tr><tr><td style=text-align:left><a href=#pg_default_service_dest><code>pg_default_service_dest</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>default service dest if svc.dest=&lsquo;default&rsquo;: postgres or pgbouncer</td></tr><tr><td style=text-align:left><a href=#pg_default_services><code>pg_default_services</code></a></td><td style=text-align:center><code>service[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>postgres default service definition list, shared globally</td></tr><tr><td style=text-align:left><a href=#pg_vip_enabled><code>pg_vip_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>enable L2 VIP for pgsql primary? disabled by default</td></tr><tr><td style=text-align:left><a href=#pg_vip_address><code>pg_vip_address</code></a></td><td style=text-align:center><code>cidr4</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>vip address in <code>&lt;ipv4>/&lt;mask></code> format, required if vip enabled</td></tr><tr><td style=text-align:left><a href=#pg_vip_interface><code>pg_vip_interface</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C/I</code></td><td style=text-align:left>vip network interface to bindg, eth0 by default</td></tr><tr><td style=text-align:left><a href=#pg_dns_suffix><code>pg_dns_suffix</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql dns suffix, empty by default</td></tr><tr><td style=text-align:left><a href=#pg_dns_target><code>pg_dns_target</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>PG DNS resolves to: auto, primary, vip, none, or specific IP</td></tr></tbody></table><hr><p><a href=#pg_monitor><code>PG_MONITOR</code></a> parameters are used to configure PostgreSQL monitoring exporters, including pg_exporter, pgbouncer_exporter, and pgbackrest_exporter.</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_exporter_enabled><code>pg_exporter_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>enable pg_exporter on pgsql host?</td></tr><tr><td style=text-align:left><a href=#pg_exporter_config><code>pg_exporter_config</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter config file/template name</td></tr><tr><td style=text-align:left><a href=#pg_exporter_cache_ttls><code>pg_exporter_cache_ttls</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter collector ttl stages, &lsquo;1,10,60,300&rsquo; by default</td></tr><tr><td style=text-align:left><a href=#pg_exporter_port><code>pg_exporter_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter listen port, 9630 by default</td></tr><tr><td style=text-align:left><a href=#pg_exporter_params><code>pg_exporter_params</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>extra URL parameters for pg_exporter dsn</td></tr><tr><td style=text-align:left><a href=#pg_exporter_url><code>pg_exporter_url</code></a></td><td style=text-align:center><code>pgurl</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>overwrite auto-generated postgres DSN connection string</td></tr><tr><td style=text-align:left><a href=#pg_exporter_auto_discovery><code>pg_exporter_auto_discovery</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>enable auto database discovery for monitoring? enabled</td></tr><tr><td style=text-align:left><a href=#pg_exporter_exclude_database><code>pg_exporter_exclude_database</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>excluded database list when auto-discovery, comma separated</td></tr><tr><td style=text-align:left><a href=#pg_exporter_include_database><code>pg_exporter_include_database</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>only monitor these databases when auto-discovery enabled</td></tr><tr><td style=text-align:left><a href=#pg_exporter_connect_timeout><code>pg_exporter_connect_timeout</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter connect timeout in ms, 200 by default</td></tr><tr><td style=text-align:left><a href=#pg_exporter_options><code>pg_exporter_options</code></a></td><td style=text-align:center><code>arg</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>extra command line options for pg_exporter</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter_enabled><code>pgbouncer_exporter_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>enable pgbouncer_exporter on pgsql host?</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter_port><code>pgbouncer_exporter_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer_exporter listen port, 9631 by default</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter_url><code>pgbouncer_exporter_url</code></a></td><td style=text-align:center><code>pgurl</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>overwrite auto-generated pgbouncer dsn connection string</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter_options><code>pgbouncer_exporter_options</code></a></td><td style=text-align:center><code>arg</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>extra command line options for pgbouncer_exporter</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>enable pgbackrest_exporter on pgsql host?</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter_port><code>pgbackrest_exporter_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbackrest_exporter listen port, 9854 by default</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter_options><code>pgbackrest_exporter_options</code></a></td><td style=text-align:center><code>arg</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>extra command line options for pgbackrest_exporter</td></tr></tbody></table><hr><p><a href=#pg_remove><code>PG_REMOVE</code></a> parameters are used to configure PostgreSQL instance cleanup and uninstall behavior, including data directory, backup, and package removal control.</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_rm_data><code>pg_rm_data</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>remove postgres data directory when removing instance?</td></tr><tr><td style=text-align:left><a href=#pg_rm_backup><code>pg_rm_backup</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>remove pgbackrest backup when removing primary?</td></tr><tr><td style=text-align:left><a href=#pg_rm_pkg><code>pg_rm_pkg</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>uninstall related packages when removing pgsql instance?</td></tr><tr><td style=text-align:left><a href=#pg_safeguard><code>pg_safeguard</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>prevent accidental pgsql cleanup operations? false</td></tr></tbody></table><hr><h2 id=pg_id><code>PG_ID</code></h2><p>Here are commonly used parameters for identifying <a href=/docs/pgsql/config#er-diagram>entities</a> in the PGSQL module: clusters, instances, services, etc&mldr;</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_cluster:           #CLUSTER  # pgsql cluster name, required identity parameter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_seq: 0             #INSTANCE # pgsql instance seq number, required identity parameter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_role: replica      #INSTANCE # pgsql role, required, could be primary,replica,offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_instances: {}      #INSTANCE # define multiple pg instances on node in `{port:ins_vars}` format</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_upstream:          #INSTANCE # repl upstream ip addr for standby cluster or cascade replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_shard:             #CLUSTER  # pgsql shard name, optional identity for sharding clusters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_group: 0           #CLUSTER  # pgsql shard index number, optional identity for sharding clusters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># gp_role: master       #CLUSTER  # greenplum role of this cluster, could be master or segment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#INSTANCE # set to true to enable offline query on this instance</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You must explicitly specify these <strong>identity parameters</strong>, they have no default values:</p><table><thead><tr><th style=text-align:center>Name</th><th style=text-align:center>Type</th><th style=text-align:center>Level</th><th>Description</th></tr></thead><tbody><tr><td style=text-align:center><a href=#pg_cluster><code>pg_cluster</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><strong>C</strong></td><td><strong>PG cluster name</strong></td></tr><tr><td style=text-align:center><a href=#pg_seq><code>pg_seq</code></a></td><td style=text-align:center><code>number</code></td><td style=text-align:center><strong>I</strong></td><td><strong>PG instance ID</strong></td></tr><tr><td style=text-align:center><a href=#pg_role><code>pg_role</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><strong>I</strong></td><td><strong>PG instance role</strong></td></tr><tr><td style=text-align:center><a href=#pg_shard><code>pg_shard</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><strong>C</strong></td><td><strong>Shard name</strong></td></tr><tr><td style=text-align:center><a href=#pg_group><code>pg_group</code></a></td><td style=text-align:center><code>number</code></td><td style=text-align:center><strong>C</strong></td><td><strong>Shard index</strong></td></tr></tbody></table><ul><li><a href=#pg_cluster><code>pg_cluster</code></a>: Identifies the cluster name, configured at cluster level.</li><li><a href=#pg_role><code>pg_role</code></a>: Configured at instance level, identifies the role of the instance. Only <code>primary</code> role is treated specially. If not specified, defaults to <code>replica</code> role, with special <code>delayed</code> and <code>offline</code> roles.</li><li><a href=#pg_seq><code>pg_seq</code></a>: Used to identify instances within a cluster, typically an integer starting from 0 or 1, once assigned it doesn&rsquo;t change.</li><li><code>{{ pg_cluster }}-{{ pg_seq }}</code> uniquely identifies an instance, i.e., <code>pg_instance</code>.</li><li><code>{{ pg_cluster }}-{{ pg_role }}</code> identifies services within the cluster, i.e., <code>pg_service</code>.</li><li><a href=#pg_shard><code>pg_shard</code></a> and <a href=#pg_group><code>pg_group</code></a> are used for horizontal sharding clusters, only for citus, greenplum, and matrixdb.</li></ul><p><a href=#pg_cluster><code>pg_cluster</code></a>, <a href=#pg_role><code>pg_role</code></a>, <a href=#pg_seq><code>pg_seq</code></a> are core <strong>identity parameters</strong>, <strong>required</strong> for any Postgres cluster and must be explicitly specified. Here is an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>All other parameters can be inherited from global or default configuration, but identity parameters must be <strong>explicitly specified</strong> and <strong>manually assigned</strong>.</p><h3 id=pg_mode><code>pg_mode</code></h3><p>Parameter Name: <code>pg_mode</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>PostgreSQL cluster mode, default value is <code>pgsql</code>, i.e., standard PostgreSQL cluster.</p><p>Available mode options include:</p><ul><li><code>pgsql</code>: Standard PostgreSQL cluster</li><li><code>citus</code>: Citus distributed database cluster</li><li><code>mssql</code>: Babelfish MSSQL wire protocol compatible kernel</li><li><code>mysql</code>: OpenHalo/HaloDB MySQL wire protocol compatible kernel</li><li><code>ivory</code>: IvorySQL Oracle compatible kernel</li><li><code>polar</code>: PolarDB for PostgreSQL kernel</li><li><code>oracle</code>: PolarDB for Oracle kernel</li><li><code>gpsql</code>: Greenplum parallel database cluster (monitoring)</li></ul><p>If <code>pg_mode</code> is set to <code>citus</code> or <code>gpsql</code>, two additional required identity parameters <a href=#pg_shard><code>pg_shard</code></a> and <a href=#pg_group><code>pg_group</code></a> are needed to define the horizontal sharding cluster identity.</p><p>In both cases, each PostgreSQL cluster is part of a larger business unit.</p><h3 id=pg_cluster><code>pg_cluster</code></h3><p>Parameter Name: <code>pg_cluster</code>, Type: <code>string</code>, Level: <code>C</code></p><p>PostgreSQL cluster name, required identity parameter, no default value.</p><p>The cluster name is used as the namespace for resources.</p><p>Cluster naming must follow a specific pattern: <code>[a-z][a-z0-9-]*</code>, i.e., only numbers and lowercase letters, not starting with a number, to meet different identifier constraints.</p><h3 id=pg_seq><code>pg_seq</code></h3><p>Parameter Name: <code>pg_seq</code>, Type: <code>int</code>, Level: <code>I</code></p><p>PostgreSQL instance sequence number, required identity parameter, no default value.</p><p>The sequence number of this instance, uniquely assigned within its <strong>cluster</strong>, typically using natural numbers starting from 0 or 1, usually not recycled or reused.</p><h3 id=pg_role><code>pg_role</code></h3><p>Parameter Name: <code>pg_role</code>, Type: <code>enum</code>, Level: <code>I</code></p><p>PostgreSQL instance role, required identity parameter, no default value. Values can be: <code>primary</code>, <code>replica</code>, <code>offline</code></p><p>The role of a PGSQL instance can be: <code>primary</code>, <code>replica</code>, <code>standby</code>, or <code>offline</code>.</p><ul><li><code>primary</code>: Primary instance, there is one and only one in a cluster.</li><li><code>replica</code>: Replica for serving online read-only traffic, may have slight replication delay under high load (10ms~100ms, 100KB).</li><li><code>offline</code>: Offline replica for handling offline read-only traffic, such as analytics/ETL/personal queries.</li></ul><h3 id=pg_instances><code>pg_instances</code></h3><p>Parameter Name: <code>pg_instances</code>, Type: <code>dict</code>, Level: <code>I</code></p><p>Define multiple PostgreSQL instances on a single host using <code>{port:ins_vars}</code> format.</p><p>This parameter is reserved for multi-instance deployment on a single node. Pigsty has not yet implemented this feature and strongly recommends dedicated node deployment.</p><h3 id=pg_upstream><code>pg_upstream</code></h3><p>Parameter Name: <code>pg_upstream</code>, Type: <code>ip</code>, Level: <code>I</code></p><p>Upstream instance IP address for <a href=/docs/pgsql/config#standby-cluster>standby cluster</a> or cascade replica.</p><p>Setting <code>pg_upstream</code> on the <code>primary</code> instance of a cluster indicates this cluster is a <a href=/docs/pgsql/config#standby-cluster>standby cluster</a>, and this instance will act as a <code>standby leader</code>, receiving and applying changes from the upstream cluster.</p><p>Setting <code>pg_upstream</code> on a non-<code>primary</code> instance specifies a specific instance as the upstream for physical replication. If different from the primary instance IP address, this instance becomes a <strong>cascade replica</strong>. It is the user&rsquo;s responsibility to ensure the upstream IP address is another instance in the same cluster.</p><h3 id=pg_shard><code>pg_shard</code></h3><p>Parameter Name: <code>pg_shard</code>, Type: <code>string</code>, Level: <code>C</code></p><p>PostgreSQL horizontal shard name, required identity parameter for sharding clusters (e.g., citus clusters).</p><p>When multiple standard PostgreSQL clusters serve the same business together in a horizontal sharding manner, Pigsty marks this group of clusters as a <strong>horizontal sharding cluster</strong>.</p><p><a href=#pg_shard><code>pg_shard</code></a> is the shard group name. It is typically a prefix of <a href=#pg_cluster><code>pg_cluster</code></a>.</p><p>For example, if we have a shard group <code>pg-citus</code> with 4 clusters, their identity parameters would be:</p><pre tabindex=0><code>cls pg_shard: pg-citus
cls pg_group = 0:   pg-citus0
cls pg_group = 1:   pg-citus1
cls pg_group = 2:   pg-citus2
cls pg_group = 3:   pg-citus3
</code></pre><h3 id=pg_group><code>pg_group</code></h3><p>Parameter Name: <code>pg_group</code>, Type: <code>int</code>, Level: <code>C</code></p><p>PostgreSQL horizontal sharding cluster shard index number, required identity parameter for sharding clusters (e.g., citus clusters).</p><p>This parameter is used in conjunction with <a href=#pg_shard>pg_shard</a>, typically using non-negative integers as index numbers.</p><h3 id=gp_role><code>gp_role</code></h3><p>Parameter Name: <code>gp_role</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Greenplum/Matrixdb role of the PostgreSQL cluster, can be <code>master</code> or <code>segment</code>.</p><ul><li><code>master</code>: Marks the postgres cluster as a greenplum master instance (coordinator node), this is the default value.</li><li><code>segment</code>: Marks the postgres cluster as a greenplum segment cluster (data node).</li></ul><p>This parameter is only used for Greenplum/MatrixDB databases (<a href=#pg_mode><code>pg_mode</code></a> is <code>gpsql</code>) and has no meaning for regular PostgreSQL clusters.</p><h3 id=pg_exporters><code>pg_exporters</code></h3><p>Parameter Name: <code>pg_exporters</code>, Type: <code>dict</code>, Level: <code>C</code></p><p>Additional exporter definitions for <a href=/docs/pgsql/monitor>monitoring</a> remote PostgreSQL instances, default value: <code>{}</code></p><p>If you want to monitor remote PostgreSQL instances, define them in the <code>pg_exporters</code> parameter on the cluster where the monitoring system resides (Infra node), and use the <a href=/docs/pgsql/playbook#pgsql-monitoryml><code>pgsql-monitor.yml</code></a> playbook to complete the deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># list all remote instances here, alloc a unique unused local port as k</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>20001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 1, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>20004</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 2, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>20002</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 1, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>20003</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 1, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.13</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_offline_query><code>pg_offline_query</code></h3><p>Parameter Name: <code>pg_offline_query</code>, Type: <code>bool</code>, Level: <code>I</code></p><p>Set to <code>true</code> to enable offline queries on this instance, default is <code>false</code>.</p><p>When this parameter is enabled on a PostgreSQL instance, users belonging to the <code>dbrole_offline</code> group can directly connect to this PostgreSQL instance to execute offline queries (slow queries, interactive queries, ETL/analytics queries).</p><p>Instances with this flag have an effect similar to setting <code>pg_role</code> = <code>offline</code> for the instance, with the only difference being that <code>offline</code> instances by default do not serve <code>replica</code> service requests and exist as dedicated offline/analytics replica instances.</p><p>If you don&rsquo;t have spare instances available for this purpose, you can select a regular replica and enable this parameter at the instance level to handle offline queries when needed.</p><hr><h2 id=pg_business><code>PG_BUSINESS</code></h2><p>Customize cluster templates: users, databases, services, and permission rules.</p><p>Users should <strong>pay close attention</strong> to this section of parameters, as this is where business declares its required database objects.</p><ul><li>Business user definition: <a href=#pg_users><code>pg_users</code></a></li><li>Business database definition: <a href=#pg_databases><code>pg_databases</code></a></li><li>Cluster-specific service definition: <a href=#pg_services><code>pg_services</code></a> (global definition: <a href=#pg_default_services><code>pg_default_services</code></a>)</li><li>PostgreSQL cluster/instance-specific HBA rules: <a href=#pg_hba_rules><code>pg_hba_rules</code></a></li><li>Pgbouncer connection pool-specific HBA rules: <a href=#pgb_hba_rules><code>pgb_hba_rules</code></a></li><li>Cron job (crontab) definition: <a href=#pg_crontab><code>pg_crontab</code></a></li></ul><p><a href=/docs/concept/sec/ac/#default-users>Default</a> database users and their credentials. It is strongly recommended to change these user passwords in production environments.</p><ul><li>PG admin user: <a href=#pg_admin_username><code>pg_admin_username</code></a> / <a href=#pg_admin_password><code>pg_admin_password</code></a></li><li>PG replication user: <a href=#pg_replication_username><code>pg_replication_username</code></a> / <a href=#pg_replication_password><code>pg_replication_password</code></a></li><li>PG monitor user: <a href=#pg_monitor_username><code>pg_monitor_username</code></a> / <a href=#pg_monitor_password><code>pg_monitor_password</code></a></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># postgres business object definition, overwrite in group vars</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># postgres business users</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># postgres business databases</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># postgres business services</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># business hba rules for postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># business hba rules for pgbouncer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># crontab entries for postgres dbsu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># global credentials, overwrite in global vars</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># dbsu password, empty string means no dbsu password by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_users><code>pg_users</code></h3><p>Parameter Name: <code>pg_users</code>, Type: <code>user[]</code>, Level: <code>C</code></p><p>PostgreSQL business user list, needs to be defined at the PG cluster level. Default value: <code>[]</code> empty list.</p><p>Each array element is a <a href=/docs/pgsql/config/user>user/role</a> definition, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># required, `name` is the only required field for user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, password, can be scram-sha-256 hash string or plaintext</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># optional, can login by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, default false, is superuser?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, default false, can create database?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, default false, can create role?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, by default, can this role use inherited privileges?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, default false, can this role do replication?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, default false, can this role bypass row-level security?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, default false, add this user to pgbouncer user list? (production users using connection pool should explicitly set to true)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, user connection limit, default -1 disables limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in: 3650                 # optional, this role expires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>calculated from creation + n days (higher priority than expire_at)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># optional, when this role expires, use YYYY-MM-DD format string to specify a specific date (lower priority than expire_in)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, description and comment string for this user/role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles: [dbrole_admin]           # optional, default roles are</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_{admin,readonly,readwrite,offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, use `ALTER ROLE SET` for this role, configure role-level database parameters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at user level, default transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, user-level max database connections, default -1 disables limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, key-value config parameter per postgresql docs (e.g., use pigsty as default search_path)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_databases><code>pg_databases</code></h3><p>Parameter Name: <code>pg_databases</code>, Type: <code>database[]</code>, Level: <code>C</code></p><p>PostgreSQL business database list, needs to be defined at the PG cluster level. Default value: <code>[]</code> empty list.</p><p>Each array element is a <a href=/docs/pgsql/config/db>business database</a> definition, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># required, `name` is the only required field for database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database sql baseline file path (relative path in ansible search path, e.g., files/)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this database to pgbouncer database list? default true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, additional schemas to create, array of schema name strings</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions:                     # optional, additional extensions to install</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>array of extension objects</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># can specify which schema to install extension into, or not (if not specified, installs to first schema in search_path)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># some extensions create and use fixed schemas, so no need to specify schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, description and comment for the database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database owner, default is postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, template to use, default is template1, target must be a template database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database encoding, default UTF8 (must match template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database locale setting, default C (must match template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database collate rule, default C (must match template database), no reason to change</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database ctype character set, default C (must match template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, default tablespace, default is &#39;pg_default&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, allow connections, default true. Explicitly set false to completely forbid connections</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, revoke public connect privileges. default false, when true, CONNECT privilege revoked from users other than owner and admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># optional, register this database to grafana datasource? default true, explicitly false skips registration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, database connection limit, default -1 means no limit, positive integer limits connections</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, all connections to this pgbouncer database will authenticate using this user (useful when pgbouncer_auth_query enabled)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database-level pgbouncer pooling mode, default transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, database-level pgbouncer default pool size, default 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># optional, database-level pgbouncer pool reserve, default 32, max additional burst connections when default pool insufficient</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, database-level pgbouncer pool minimum size, default 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_max_db_conn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># optional, database-level max database connections, default 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>In each database definition object, only <code>name</code> is a required field, all other fields are optional.</p><h3 id=pg_services><code>pg_services</code></h3><p>Parameter Name: <code>pg_services</code>, Type: <code>service[]</code>, Level: <code>C</code></p><p>PostgreSQL service list, needs to be defined at the PG cluster level. Default value: <code>[]</code>, empty list.</p><p>Used to define additional services at the database cluster level. Each object in the array defines a <a href=/docs/pgsql/service/#define-service>service</a>. A complete service definition example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>standby                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># required, service name, final svc name will use `pg_cluster` as prefix, e.g., pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># required, exposed service port (as kubernetes service node port mode)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># optional, IP address to bind service, default is all IP addresses</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># required, service member selector, use JMESPath to filter inventory</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># optional, service member selector (backup), service is handled by these instances when default selector instances are all down</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, target port, default|postgres|pgbouncer|&lt;port_number&gt;, default is &#39;default&#39;, Default means use pg_default_service_dest value to decide</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>check: /sync                    # optional, health check URL path, default is /, here uses Patroni API</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync, only sync standby and primary return 200 health status</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, max frontend connections allowed, default 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>balance: roundrobin             # optional, haproxy load balancing algorithm (default roundrobin, other option</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>leastconn)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Note that this parameter is used to add additional services at the cluster level. If you want to globally define services that all PostgreSQL databases should provide, use the <a href=#pg_default_services><code>pg_default_services</code></a> parameter.</p><h3 id=pg_hba_rules><code>pg_hba_rules</code></h3><p>Parameter Name: <code>pg_hba_rules</code>, Type: <code>hba[]</code>, Level: <code>C</code></p><p>Client IP whitelist/blacklist rules for database cluster/instance. Default: <code>[]</code> empty list.</p><p>Array of objects, each object represents a rule. <a href=/docs/pgsql/config/hba#define-hba>HBA</a> rule object definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  10.0.0.0/8      md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  172.16.0.0/12   md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  192.168.0.0/16  md5</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>title</code>: Rule title name, rendered as comment in HBA file.</li><li><code>rules</code>: Rule array, each element is a standard HBA rule string.</li><li><code>role</code>: Rule application scope, which instance roles will enable this rule?<ul><li><code>common</code>: Applies to all instances</li><li><code>primary</code>, <code>replica</code>, <code>offline</code>: Only applies to instances with specific <a href=#pg_role><code>pg_role</code></a>.</li><li>Special case: <code>role: 'offline'</code> rules apply to instances with <code>pg_role : offline</code>, and also to instances with <a href=#pg_offline_query><code>pg_offline_query</code></a> flag.</li></ul></li></ul><p>In addition to the native HBA rule definition above, Pigsty also provides a more convenient alias form:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;intra&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># world|intra|infra|admin|local|localhost|cluster|&lt;cidr&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pwd&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># trust|pwd|ssl|cert|deny|&lt;official auth method&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># all|${dbsu}|${repl}|${admin}|${monitor}|&lt;user&gt;|&lt;group&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># all|replication|....</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># raw hba string precedence over above all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><a href=#pg_default_hba_rules><code>pg_default_hba_rules</code></a> is similar to this parameter, but it&rsquo;s used to define global HBA rules, while this parameter is typically used to customize HBA rules for specific clusters/instances.</p><h3 id=pgb_hba_rules><code>pgb_hba_rules</code></h3><p>Parameter Name: <code>pgb_hba_rules</code>, Type: <code>hba[]</code>, Level: <code>C</code></p><p>Pgbouncer business HBA rules, default value: <code>[]</code>, empty array.</p><p>This parameter is similar to <a href=#pg_hba_rules><code>pg_hba_rules</code></a>, both are arrays of <a href=/docs/pgsql/config/hba#define-hba>hba</a> rule objects, the difference is that this parameter is for Pgbouncer.</p><p><a href=#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a> is similar to this parameter, but it&rsquo;s used to define global connection pool HBA rules, while this parameter is typically used to customize HBA rules for specific connection pool clusters/instances.</p><h3 id=pg_crontab><code>pg_crontab</code></h3><p>Parameter Name: <code>pg_crontab</code>, Type: <code>string[]</code>, Level: <code>C</code></p><p>Cron job list for the PostgreSQL database superuser (dbsu, default <code>postgres</code>), default value: <code>[]</code> empty array.</p><p>Each array element is a crontab entry line, using standard user crontab format: <code>minute hour day month weekday command</code> (<strong>no need to specify username</strong>).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Full backup at 1 AM daily</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 13 * * * /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Incremental backup at 1 PM daily</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>This parameter writes cron jobs to the postgres user&rsquo;s personal crontab file:</p><ul><li>EL systems: <code>/var/spool/cron/postgres</code></li><li>Debian systems: <code>/var/spool/cron/crontabs/postgres</code></li></ul><blockquote><p><strong>Note</strong>: This parameter replaces the old practice of configuring postgres user tasks in <a href=/docs/node/param#node_crontab><code>node_crontab</code></a>.
Because <code>node_crontab</code> is written to <code>/etc/crontab</code> during NODE initialization, the <code>postgres</code> user may not exist yet, causing cron errors.</p></blockquote><h3 id=pg_replication_username><code>pg_replication_username</code></h3><p>Parameter Name: <code>pg_replication_username</code>, Type: <code>username</code>, Level: <code>G</code></p><p>PostgreSQL physical replication username, default is <code>replicator</code>, not recommended to change this parameter.</p><h3 id=pg_replication_password><code>pg_replication_password</code></h3><p>Parameter Name: <code>pg_replication_password</code>, Type: <code>password</code>, Level: <code>G</code></p><p>PostgreSQL physical replication user password, default value: <code>DBUser.Replicator</code>.</p><blockquote><p>Warning: Please change this password in production environments!</p></blockquote><h3 id=pg_admin_username><code>pg_admin_username</code></h3><p>Parameter Name: <code>pg_admin_username</code>, Type: <code>username</code>, Level: <code>G</code></p><p>PostgreSQL / Pgbouncer admin name, default: <code>dbuser_dba</code>.</p><p>This is the globally used database administrator with database Superuser privileges and connection pool traffic management permissions. Please control its usage scope.</p><h3 id=pg_admin_password><code>pg_admin_password</code></h3><p>Parameter Name: <code>pg_admin_password</code>, Type: <code>password</code>, Level: <code>G</code></p><p>PostgreSQL / Pgbouncer admin password, default: <code>DBUser.DBA</code>.</p><blockquote><p>Warning: Please change this password in production environments!</p></blockquote><h3 id=pg_monitor_username><code>pg_monitor_username</code></h3><p>Parameter Name: <code>pg_monitor_username</code>, Type: <code>username</code>, Level: <code>G</code></p><p>PostgreSQL/Pgbouncer monitor username, default: <code>dbuser_monitor</code>.</p><p>This is a database/connection pool user for monitoring, not recommended to change this username.</p><p>However, if your existing database uses a different monitor user, you can use this parameter to specify the monitor username when defining monitoring targets.</p><h3 id=pg_monitor_password><code>pg_monitor_password</code></h3><p>Parameter Name: <code>pg_monitor_password</code>, Type: <code>password</code>, Level: <code>G</code></p><p>Password used by PostgreSQL/Pgbouncer monitor user, default: <code>DBUser.Monitor</code>.</p><p>Try to avoid using characters like <code>@:/</code> that can be confused with URL delimiters in passwords to reduce unnecessary trouble.</p><blockquote><p>Warning: Please change this password in production environments!</p></blockquote><h3 id=pg_dbsu_password><code>pg_dbsu_password</code></h3><p>Parameter Name: <code>pg_dbsu_password</code>, Type: <code>password</code>, Level: <code>G/C</code></p><p>PostgreSQL <a href=#pg_dbsu><code>pg_dbsu</code></a> superuser password, default is empty string, meaning no password is set.</p><p>We don&rsquo;t recommend configuring password login for dbsu as it increases the attack surface. The exception is: <a href=#pg_mode><code>pg_mode</code></a> = <code>citus</code>, in which case you need to configure a password for each shard cluster&rsquo;s dbsu to allow connections within the shard cluster.</p><hr><h2 id=pg_install><code>PG_INSTALL</code></h2><p>This section is responsible for installing PostgreSQL and its extensions. If you want to install different major versions and extension plugins, just modify <a href=#pg_version><code>pg_version</code></a> and <a href=#pg_extensions><code>pg_extensions</code></a>. Note that not all extensions are available for all major versions.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># os dbsu name, default is postgres, better not change it</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_uid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># os dbsu uid and gid, default is 26, for default postgres user and group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_sudo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>limit              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># dbsu sudo privilege, none,limit,all,nopass. default is limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_home</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/var/lib/pgsql     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgresql home directory, default is `/var/lib/pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_ssh_exchange</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># exchange postgres dbsu ssh key among same pgsql cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># postgres major version to be installed, default is 18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_bin_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/usr/pgsql/bin       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres binary dir, default is `/usr/pgsql/bin`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/postgres     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres log dir, default is `/pg/log/postgres`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># pg packages to be installed, alias can be used</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># pg extensions to be installed, alias can be used</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_dbsu><code>pg_dbsu</code></h3><p>Parameter Name: <code>pg_dbsu</code>, Type: <code>username</code>, Level: <code>C</code></p><p>OS dbsu username used by PostgreSQL, default is <code>postgres</code>, changing this username is not recommended.</p><p>However, in certain situations, you may need a username different from <code>postgres</code>, for example, when installing and configuring Greenplum / MatrixDB, you need to use <code>gpadmin</code> / <code>mxadmin</code> as the corresponding OS superuser.</p><h3 id=pg_dbsu_uid><code>pg_dbsu_uid</code></h3><p>Parameter Name: <code>pg_dbsu_uid</code>, Type: <code>int</code>, Level: <code>C</code></p><p>OS database superuser uid and gid, <code>26</code> is the default postgres user UID/GID from PGDG RPM.</p><p>For Debian/Ubuntu systems, there is no default value, and user <code>26</code> is often taken. Therefore, when Pigsty detects the installation environment is Debian-based and uid is <code>26</code>, it will automatically use the replacement <code>pg_dbsu_uid = 543</code>.</p><h3 id=pg_dbsu_sudo><code>pg_dbsu_sudo</code></h3><p>Parameter Name: <code>pg_dbsu_sudo</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Database superuser sudo privilege, can be <code>none</code>, <code>limit</code>, <code>all</code>, or <code>nopass</code>. Default is <code>limit</code></p><ul><li><p><code>none</code>: No sudo privilege</p></li><li><p><code>limit</code>: Limited sudo privilege for executing <code>systemctl</code> commands for database-related components (default option).</p></li><li><p><code>all</code>: Full <code>sudo</code> privilege, requires password.</p></li><li><p><code>nopass</code>: Full <code>sudo</code> privilege without password (not recommended).</p></li><li><p>Default value is <code>limit</code>, only allows executing <code>sudo systemctl &lt;start|stop|reload> &lt;postgres|patroni|pgbouncer|...></code>.</p></li></ul><h3 id=pg_dbsu_home><code>pg_dbsu_home</code></h3><p>Parameter Name: <code>pg_dbsu_home</code>, Type: <code>path</code>, Level: <code>C</code></p><p>PostgreSQL home directory, default is <code>/var/lib/pgsql</code>, consistent with official pgdg RPM.</p><h3 id=pg_dbsu_ssh_exchange><code>pg_dbsu_ssh_exchange</code></h3><p>Parameter Name: <code>pg_dbsu_ssh_exchange</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Whether to exchange OS dbsu ssh keys within the same PostgreSQL cluster?</p><p>Default is <code>true</code>, meaning database superusers in the same cluster can ssh to each other.</p><h3 id=pg_version><code>pg_version</code></h3><p>Parameter Name: <code>pg_version</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>PostgreSQL major version to install, default is <code>18</code>.</p><p>Note that PostgreSQL physical streaming replication cannot cross major versions, so it&rsquo;s best not to configure this at the instance level.</p><p>You can use parameters in <a href=#pg_packages><code>pg_packages</code></a> and <a href=#pg_extensions><code>pg_extensions</code></a> to install different packages and extensions for specific PG major versions.</p><h3 id=pg_bin_dir><code>pg_bin_dir</code></h3><p>Parameter Name: <code>pg_bin_dir</code>, Type: <code>path</code>, Level: <code>C</code></p><p>PostgreSQL binary directory, default is <code>/usr/pgsql/bin</code>.</p><p>The default value is a symlink manually created during installation, pointing to the specific installed Postgres version directory.</p><p>For example <code>/usr/pgsql -> /usr/pgsql-15</code>. On Ubuntu/Debian it points to <code>/usr/lib/postgresql/15/bin</code>.</p><p>For more details, see <a href=/docs/ref/fhs#postgres-fhs>PGSQL File Structure</a>.</p><h3 id=pg_log_dir><code>pg_log_dir</code></h3><p>Parameter Name: <code>pg_log_dir</code>, Type: <code>path</code>, Level: <code>C</code></p><p>PostgreSQL log directory, default: <code>/pg/log/postgres</code>. The Vector log agent uses this variable to collect PostgreSQL logs.</p><p>Note that if the log directory <a href=#pg_log_dir><code>pg_log_dir</code></a> is prefixed with the data directory <a href=#pg_data><code>pg_data</code></a>, it won&rsquo;t be explicitly created (created automatically during data directory initialization).</p><h3 id=pg_packages><code>pg_packages</code></h3><p>Parameter Name: <code>pg_packages</code>, Type: <code>string[]</code>, Level: <code>C</code></p><p>PostgreSQL packages to install (RPM/DEB), this is an array of package names where elements can be space or comma-separated package aliases.</p><p>Pigsty v4 converges the default value to two aliases:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>pgsql-main</code>: Maps to PostgreSQL kernel, client, PL languages, and core extensions like <code>pg_repack</code>, <code>wal2json</code>, <code>pgvector</code> on the current platform.</li><li><code>pgsql-common</code>: Maps to companion components required for running the database, such as Patroni, Pgbouncer, pgBackRest, pg_exporter, vip-manager, and other daemons.</li></ul><p>Alias definitions can be found in <code>pg_package_map</code> under <a href=https://github.com/pgsty/pigsty/tree/main/roles/node_id/vars><code>roles/node_id/vars/</code></a>. Pigsty first resolves aliases based on OS and architecture, then replaces <code>$v</code>/<code>${pg_version}</code> with the actual major version <a href=#pg_version><code>pg_version</code></a>, and finally installs the real packages. This shields package name differences between distributions.</p><p>If additional packages are needed (e.g., specific FDW or extensions), you can append aliases or real package names directly to <code>pg_packages</code>. But remember to keep <code>pgsql-main pgsql-common</code>, otherwise core components will be missing.</p><h3 id=pg_extensions><code>pg_extensions</code></h3><p>Parameter Name: <code>pg_extensions</code>, Type: <code>string[]</code>, Level: <code>G/C</code></p><p>PostgreSQL extension packages to install (RPM/DEB), this is an array of extension package names or aliases.</p><p>Starting from v4, the default value is an empty list <code>[]</code>. Pigsty no longer forces installation of large extensions, users can choose as needed to avoid extra disk and dependency usage.</p><p>To install extensions, fill in like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgis timescaledb pgvector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-fdw    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use alias to install common FDWs at once</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>pg_package_map</code> provides many aliases to shield package name differences between distributions. Here are available extension combinations for EL9 platform for reference (pick as needed):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_extensions: <span style=color:#8f5902;font-style:italic># extensions to be installed on this cluster</span>
</span></span><span style=display:flex><span>  - timescaledb periods temporal_tables emaj table_version pg_cron pg_later pg_background pg_timetable
</span></span><span style=display:flex><span>  - postgis pgrouting pointcloud pg_h3 q3c ogr_fdw geoip <span style=color:#8f5902;font-style:italic>#pg_geohash #mobilitydb</span>
</span></span><span style=display:flex><span>  - pgvector pgvectorscale pg_vectorize pg_similarity pg_tiktoken pgml <span style=color:#8f5902;font-style:italic>#smlar</span>
</span></span><span style=display:flex><span>  - pg_search pg_bigm zhparser hunspell
</span></span><span style=display:flex><span>  - hydra pg_analytics pg_lakehouse pg_duckdb duckdb_fdw pg_fkpart pg_partman plproxy <span style=color:#8f5902;font-style:italic>#pg_strom citus</span>
</span></span><span style=display:flex><span>  - pg_hint_plan age hll rum pg_graphql pg_jsonschema jsquery index_advisor hypopg imgsmlr pg_ivm pgmq pgq <span style=color:#8f5902;font-style:italic>#rdkit</span>
</span></span><span style=display:flex><span>  - pg_tle plv8 pllua plprql pldebugger plpgsql_check plprofiler plsh <span style=color:#8f5902;font-style:italic>#pljava plr pgtap faker dbt2</span>
</span></span><span style=display:flex><span>  - prefix semver pgunit md5hash asn1oid roaringbitmap pgfaceting pgsphere pg_country pg_currency pgmp numeral pg_rational pguint ip4r timestamp9 chkpass <span style=color:#8f5902;font-style:italic>#pg_uri #pgemailaddr #acl #debversion #pg_rrule</span>
</span></span><span style=display:flex><span>  - topn pg_gzip pg_http pg_net pg_html5_email_address pgsql_tweaks pg_extra_time pg_timeit count_distinct extra_window_functions first_last_agg tdigest aggs_for_arrays pg_arraymath pg_idkit pg_uuidv7 permuteseq pg_hashids
</span></span><span style=display:flex><span>  - sequential_uuids pg_math pg_random pg_base36 pg_base62 floatvec pg_financial pgjwt pg_hashlib shacrypt cryptint pg_ecdsa pgpcre icu_ext envvar url_encode <span style=color:#8f5902;font-style:italic>#pg_zstd #aggs_for_vecs #quantile #lower_quantile #pgqr #pg_protobuf</span>
</span></span><span style=display:flex><span>  - pg_repack pg_squeeze pg_dirtyread pgfincore pgdd ddlx pg_prioritize pg_checksums pg_readonly safeupdate pg_permissions pgautofailover pg_catcheck preprepare pgcozy pg_orphaned pg_crash pg_cheat_funcs pg_savior table_log pg_fio <span style=color:#8f5902;font-style:italic>#pgpool pgagent</span>
</span></span><span style=display:flex><span>  - pg_profile pg_show_plans pg_stat_kcache pg_stat_monitor pg_qualstats pg_store_plans pg_track_settings pg_wait_sampling system_stats pg_meta pgnodemx pg_sqlog bgw_replstatus pgmeminfo toastinfo pagevis powa pg_top <span style=color:#8f5902;font-style:italic>#pg_statviz #pgexporter_ext #pg_mon</span>
</span></span><span style=display:flex><span>  - passwordcheck supautils pgsodium pg_vault anonymizer pg_tde pgsmcrypto pgaudit pgauditlogtofile pg_auth_mon credcheck pgcryptokey pg_jobmon logerrors login_hook set_user pg_snakeoil pgextwlist pg_auditor noset <span style=color:#8f5902;font-style:italic>#sslutils</span>
</span></span><span style=display:flex><span>  - wrappers multicorn odbc_fdw mysql_fdw tds_fdw sqlite_fdw pgbouncer_fdw mongo_fdw redis_fdw pg_redis_pubsub kafka_fdw hdfs_fdw firebird_fdw aws_s3 log_fdw <span style=color:#8f5902;font-style:italic>#oracle_fdw #db2_fdw #jdbc_fdw</span>
</span></span><span style=display:flex><span>  - orafce pgtt session_variable pg_statement_rollback pg_dbms_metadata pg_dbms_lock pgmemcache <span style=color:#8f5902;font-style:italic>#pg_dbms_job #wiltondb</span>
</span></span><span style=display:flex><span>  - pglogical pgl_ddl_deploy pg_failover_slots wal2json wal2mongo decoderbufs decoder_raw mimeo pgcopydb pgloader pg_fact_loader pg_bulkload pg_comparator pgimportdoc pgexportdoc <span style=color:#8f5902;font-style:italic>#repmgr #slony</span>
</span></span><span style=display:flex><span>  - gis-stack rag-stack fdw-stack fts-stack etl-stack feat-stack olap-stack supa-stack stat-stack json-stack
</span></span></code></pre></div><p>For complete list, see: <a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/><code>roles/node_id/vars</code></a></p><hr><h2 id=pg_bootstrap><code>PG_BOOTSTRAP</code></h2><p>Bootstrap PostgreSQL cluster with Patroni and set up 1:1 corresponding Pgbouncer connection pool.</p><p>It also initializes the database cluster with default roles, users, privileges, schemas, and extensions defined in <a href=#pg_provision><code>PG_PROVISION</code></a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/data                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres data directory, `/pg/data` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_fs_main</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/data/postgres       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres main data directory, `/data/postgres` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_fs_backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/data/backups      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres backup data directory, `/data/backups` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_storage_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>SSD             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># storage type for pg main data, SSD,HDD, SSD by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dummy_filesize</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MiB         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># size of `/pg/dummy`, hold 64MB disk space for emergency use</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_listen</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.0.0.0&#39;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># postgres/pgbouncer listen addresses, comma separated list</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># postgres listen port, 5432 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_localhost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/var/run/postgresql</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres unix socket dir for localhost connection</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># if disabled, no postgres cluster will be created during init</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_mode: default             # patroni working mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default,pause,remove</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># top level key namespace in etcd, used by patroni &amp; vip</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8008</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># patroni listen port, 8008 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/patroni </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># patroni log dir, `/pg/log/patroni` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_ssl_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># secure patroni RestAPI communications with SSL?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_watchdog_mode: off        # patroni watchdog mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>automatic,required,off. off by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># patroni restapi username, `postgres` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Patroni.API    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># patroni restapi password, `Patroni.API` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_etcd_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># etcd password for this pg cluster, &#39;&#39; to use pg_cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database name, used by citus,etc... ,postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># extra parameters in postgresql.auto.conf</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># extra files to be copied to postgres data directory (e.g. license)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_conf: oltp.yml                 # config template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp,olap,crit,tiny. `oltp.yml` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_max_conn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>auto                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres max connections, `auto` will use recommended value</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_shared_buffer_ratio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.25</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># postgres shared buffers ratio, 0.25 by default, 0.1~0.4</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_io_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>worker             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># io method for postgres, auto,fsync,worker,io_uring, worker by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>                        </span><span style=color:#8f5902;font-style:italic># recovery time objective in seconds,  `30s` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rpo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1048576</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># recovery point objective in bytes, `1MiB` at most by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># preloaded libraries, `pg_stat_statements,auto_explain` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># replication apply delay for standby cluster leader</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_checksum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># enable data checksum for postgres cluster?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pwd_enc: scram-sha-256         # passwords encryption algorithm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>fixed to scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database cluster encoding, `UTF8` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database cluster local, `C` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database cluster collate, `C` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database character type, `C` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#pgsodium_key: &#34;&#34;                 # pgsodium key, 64 hex digit, default to sha256(pg_cluster)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#pgsodium_getkey_script: &#34;&#34;       # pgsodium getkey script path, pgsodium_getkey by default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_data><code>pg_data</code></h3><p>Parameter Name: <code>pg_data</code>, Type: <code>path</code>, Level: <code>C</code></p><p>Postgres data directory, default is <code>/pg/data</code>.</p><p>This is a symlink to the underlying actual data directory, used in multiple places, please don&rsquo;t modify it. See <a href=/docs/ref/fhs>PGSQL File Structure</a> for details.</p><h3 id=pg_fs_main><code>pg_fs_main</code></h3><p>Parameter Name: <code>pg_fs_main</code>, Type: <code>path</code>, Level: <code>C</code></p><p>Mount point/file system path for PostgreSQL main data disk, default is <code>/data/postgres</code>.</p><p>Default value: <code>/data/postgres</code>, which will be used directly as the parent directory of PostgreSQL main data directory.</p><p>NVME SSD is recommended for PostgreSQL main data storage. Pigsty is optimized for SSD storage by default, but also supports HDD.</p><p>You can change <a href=#pg_storage_type><code>pg_storage_type</code></a> to <code>HDD</code> for HDD storage optimization.</p><h3 id=pg_fs_backup><code>pg_fs_backup</code></h3><p>Parameter Name: <code>pg_fs_backup</code>, Type: <code>path</code>, Level: <code>C</code></p><p>Mount point/file system path for PostgreSQL backup data disk, default is <code>/data/backups</code>.</p><p>If you&rsquo;re using the default <a href=#pgbackrest_method><code>pgbackrest_method</code></a> = <code>local</code>, it&rsquo;s recommended to use a separate disk for backup storage.</p><p>The backup disk should be large enough to hold all backups, at least sufficient for 3 base backups + 2 days of WAL archives. Usually capacity isn&rsquo;t a big issue since you can use cheap large HDDs as backup disks.</p><p>It&rsquo;s recommended to use a separate disk for backup storage, otherwise Pigsty will fall back to the main data disk and consume main data disk capacity and IO.</p><h3 id=pg_storage_type><code>pg_storage_type</code></h3><p>Parameter Name: <code>pg_storage_type</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Type of PostgreSQL data storage media: <code>SSD</code> or <code>HDD</code>, default is <code>SSD</code>.</p><p>Default value: <code>SSD</code>, which affects some tuning parameters like <code>random_page_cost</code> and <code>effective_io_concurrency</code>.</p><h3 id=pg_dummy_filesize><code>pg_dummy_filesize</code></h3><p>Parameter Name: <code>pg_dummy_filesize</code>, Type: <code>size</code>, Level: <code>C</code></p><p>Size of <code>/pg/dummy</code>, default is <code>64MiB</code>, 64MB disk space for emergency use.</p><p>When disk is full, deleting the placeholder file can free some space for emergency use. Recommend at least <code>8GiB</code> for production.</p><h3 id=pg_listen><code>pg_listen</code></h3><p>Parameter Name: <code>pg_listen</code>, Type: <code>ip</code>, Level: <code>C</code></p><p>PostgreSQL / Pgbouncer listen address, default is <code>0.0.0.0</code> (all ipv4 addresses).</p><p>You can use placeholders in this variable, for example: <code>'${ip},${lo}'</code> or <code>'${ip},${vip},${lo}'</code>:</p><ul><li><code>${ip}</code>: Translates to <code>inventory_hostname</code>, which is the primary internal IP address defined in the inventory.</li><li><code>${vip}</code>: If <a href=#pg_vip_enabled><code>pg_vip_enabled</code></a> is enabled, will use the host part of <a href=#pg_vip_address><code>pg_vip_address</code></a>.</li><li><code>${lo}</code>: Will be replaced with <code>127.0.0.1</code></li></ul><p>For production environments with high security requirements, it&rsquo;s recommended to restrict listen IP addresses.</p><h3 id=pg_port><code>pg_port</code></h3><p>Parameter Name: <code>pg_port</code>, Type: <code>port</code>, Level: <code>C</code></p><p>Port that PostgreSQL server listens on, default is <code>5432</code>.</p><h3 id=pg_localhost><code>pg_localhost</code></h3><p>Parameter Name: <code>pg_localhost</code>, Type: <code>path</code>, Level: <code>C</code></p><p>Unix socket directory for localhost PostgreSQL connection, default is <code>/var/run/postgresql</code>.</p><p>Unix socket directory for PostgreSQL and Pgbouncer local connections. <a href=#pg_exporter><code>pg_exporter</code></a> and patroni will preferentially use Unix sockets to access PostgreSQL.</p><h3 id=pg_namespace><code>pg_namespace</code></h3><p>Parameter Name: <code>pg_namespace</code>, Type: <code>path</code>, Level: <code>C</code></p><p>Top-level namespace used in <a href=#etcd>etcd</a>, used by patroni and vip-manager, default is: <code>/pg</code>, not recommended to change.</p><h3 id=patroni_enabled><code>patroni_enabled</code></h3><p>Parameter Name: <code>patroni_enabled</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Enable Patroni? Default is: <code>true</code>.</p><p>If disabled, no Postgres cluster will be created during initialization. Pigsty will skip the task of starting patroni, which can be used when trying to add some components to existing postgres instances.</p><h3 id=patroni_mode><code>patroni_mode</code></h3><p>Parameter Name: <code>patroni_mode</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Patroni working mode: <code>default</code>, <code>pause</code>, <code>remove</code>. Default: <code>default</code>.</p><ul><li><code>default</code>: Normal use of Patroni to bootstrap PostgreSQL cluster</li><li><code>pause</code>: Similar to <code>default</code>, but enters maintenance mode after bootstrap</li><li><code>remove</code>: Use Patroni to initialize cluster, then remove Patroni and use raw PostgreSQL.</li></ul><h3 id=patroni_port><code>patroni_port</code></h3><p>Parameter Name: <code>patroni_port</code>, Type: <code>port</code>, Level: <code>C</code></p><p>Patroni listen port, default is <code>8008</code>, not recommended to change.</p><p>Patroni API server listens on this port for health checks and API requests.</p><h3 id=patroni_log_dir><code>patroni_log_dir</code></h3><p>Parameter Name: <code>patroni_log_dir</code>, Type: <code>path</code>, Level: <code>C</code></p><p>Patroni log directory, default is <code>/pg/log/patroni</code>, collected by Vector log agent.</p><h3 id=patroni_ssl_enabled><code>patroni_ssl_enabled</code></h3><p>Parameter Name: <code>patroni_ssl_enabled</code>, Type: <code>bool</code>, Level: <code>G</code></p><p>Secure patroni RestAPI communications with SSL? Default is <code>false</code>.</p><p>This parameter is a global flag that can only be set before deployment. Because if SSL is enabled for patroni, you will have to use HTTPS instead of HTTP for health checks, fetching metrics, and calling APIs.</p><h3 id=patroni_watchdog_mode><code>patroni_watchdog_mode</code></h3><p>Parameter Name: <code>patroni_watchdog_mode</code>, Type: <code>string</code>, Level: <code>C</code></p><p>Patroni watchdog mode: <code>automatic</code>, <code>required</code>, <code>off</code>, default is <code>off</code>.</p><p>In case of primary failure, Patroni can use <a href=https://patroni.readthedocs.io/en/latest/watchdog.html>watchdog</a> to force shutdown old primary node to avoid split-brain.</p><ul><li><code>off</code>: Don&rsquo;t use <code>watchdog</code>. No fencing at all (default behavior)</li><li><code>automatic</code>: Enable <code>watchdog</code> if kernel has <code>softdog</code> module enabled and watchdog belongs to dbsu.</li><li><code>required</code>: Force enable <code>watchdog</code>, refuse to start Patroni/PostgreSQL if <code>softdog</code> unavailable.</li></ul><p>Default is <code>off</code>. You should not enable watchdog on Infra nodes. Critical systems where data consistency takes priority over availability, especially business clusters involving money, can consider enabling this option.</p><p>Note that if all your access traffic uses HAproxy health check <a href=/docs/pgsql/service/#access-service>service access</a>, there is normally no split-brain risk.</p><h3 id=patroni_username><code>patroni_username</code></h3><p>Parameter Name: <code>patroni_username</code>, Type: <code>username</code>, Level: <code>C</code></p><p>Patroni REST API username, default is <code>postgres</code>, used with <a href=#patroni_password><code>patroni_password</code></a>.</p><p>Patroni&rsquo;s dangerous REST APIs (like restarting cluster) are protected by additional username/password. See <a href=/docs/pgsql/admin#configure-cluster>Configure Cluster</a> and <a href=https://patroni.readthedocs.io/en/latest/rest_api.html>Patroni RESTAPI</a> for details.</p><h3 id=patroni_password><code>patroni_password</code></h3><p>Parameter Name: <code>patroni_password</code>, Type: <code>password</code>, Level: <code>C</code></p><p>Patroni REST API password, default is <code>Patroni.API</code>.</p><blockquote><p>Warning: Must change this parameter in production environments!</p></blockquote><h3 id=pg_primary_db><code>pg_primary_db</code></h3><p>Parameter Name: <code>pg_primary_db</code>, Type: <code>string</code>, Level: <code>C</code></p><p>Specify the primary database name in the cluster, used for citus and other business databases, default is <code>postgres</code>.</p><p>For example, when using Patroni to manage HA Citus clusters, you must choose a &ldquo;primary database&rdquo;.</p><p>Additionally, the database name specified here will be displayed in the printed connection string after PGSQL module installation is complete.</p><h3 id=pg_parameters><code>pg_parameters</code></h3><p>Parameter Name: <code>pg_parameters</code>, Type: <code>dict</code>, Level: <code>G/C/I</code></p><p>Used to specify and manage configuration parameters in <code>postgresql.auto.conf</code>.</p><p>After all cluster instances are initialized, the <code>pg_param</code> task will write the key/value pairs from this dictionary sequentially to <code>/pg/data/postgresql.auto.conf</code>.</p><blockquote><p>Note: Do not manually modify this configuration file, or modify cluster configuration parameters via <code>ALTER SYSTEM</code>, changes will be overwritten on the next configuration sync.</p></blockquote><p>This variable has higher priority than cluster configuration in Patroni / DCS (i.e., higher priority than cluster configuration edited by Patroni <code>edit-config</code>), so it can typically be used to override cluster default parameters at instance level.</p><p>When your cluster members have different specifications (not recommended!), you can use this parameter for fine-grained configuration management of each instance.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5GB&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;4GB&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;3GB&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Note that some <a href=https://patroni.readthedocs.io/en/latest/patroni_configuration.html#important-rules>important cluster parameters</a> (with requirements on primary/replica parameter values) are managed directly by Patroni via command line arguments, have highest priority, and cannot be overridden this way. For these parameters, you must use Patroni <code>edit-config</code> for management and configuration.</p><p>PostgreSQL parameters that must be consistent on primary and replicas (inconsistency will cause replica to fail to start!):</p><ul><li><code>wal_level</code></li><li><code>max_connections</code></li><li><code>max_locks_per_transaction</code></li><li><code>max_worker_processes</code></li><li><code>max_prepared_transactions</code></li><li><code>track_commit_timestamp</code></li></ul><p>Parameters that should preferably be consistent on primary and replicas (considering possibility of failover):</p><ul><li><code>listen_addresses</code></li><li><code>port</code></li><li><code>cluster_name</code></li><li><code>hot_standby</code></li><li><code>wal_log_hints</code></li><li><code>max_wal_senders</code></li><li><code>max_replication_slots</code></li><li><code>wal_keep_segments</code></li><li><code>wal_keep_size</code></li></ul><p>You can set non-existent parameters (e.g., GUCs from extensions, thus configuring &ldquo;not yet existing&rdquo; parameters that <code>ALTER SYSTEM</code> cannot modify), but modifying existing configuration to illegal values may cause PostgreSQL to fail to start, configure with caution!</p><h3 id=pg_files><code>pg_files</code></h3><p>Parameter Name: <code>pg_files</code>, Type: <code>path[]</code>, Level: <code>C</code></p><p>Used to specify a list of files to be copied to the PGDATA directory, default is empty array: <code>[]</code></p><p>Files specified in this parameter will be copied to the <code>{{ pg_data }}</code> directory, mainly used to distribute license files required by special commercial PostgreSQL kernels.</p><p>Currently only PolarDB (Oracle compatible) kernel requires license files. For example, you can place the <code>license.lic</code> file in the <code>files/</code> directory and specify in <code>pg_files</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>license.lic ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_conf><code>pg_conf</code></h3><p>Parameter Name: <code>pg_conf</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Configuration template: <code>{oltp,olap,crit,tiny}.yml</code>, default is <code>oltp.yml</code>.</p><ul><li><code>tiny.yml</code>: Optimized for small nodes, VMs, small demos (1-8 cores, 1-16GB)</li><li><code>oltp.yml</code>: Optimized for OLTP workloads and latency-sensitive applications (4C8GB+) (default template)</li><li><code>olap.yml</code>: Optimized for OLAP workloads and throughput (4C8G+)</li><li><code>crit.yml</code>: Optimized for data consistency and critical applications (4C8G+)</li></ul><p>Default is <code>oltp.yml</code>, but the <a href=/docs/setup/install#configure>configure</a> script will set this to <code>tiny.yml</code> when current node is a small node.</p><p>You can have your own templates, just place them under <code>templates/&lt;mode>.yml</code> and set this value to the template name to use.</p><h3 id=pg_max_conn><code>pg_max_conn</code></h3><p>Parameter Name: <code>pg_max_conn</code>, Type: <code>int</code>, Level: <code>C</code></p><p>PostgreSQL server max connections. You can choose a value between 50 and 5000, or use <code>auto</code> for recommended value.</p><p>Default is <code>auto</code>, which sets max connections based on <a href=#pg_conf><code>pg_conf</code></a> and <a href=#pg_default_service_dest><code>pg_default_service_dest</code></a>.</p><ul><li>tiny: 100</li><li>olap: 200</li><li>oltp: 200 (pgbouncer) / 1000 (postgres)<ul><li>pg_default_service_dest = pgbouncer : 200</li><li>pg_default_service_dest = postgres : 1000</li></ul></li><li>crit: 200 (pgbouncer) / 1000 (postgres)<ul><li>pg_default_service_dest = pgbouncer : 200</li><li>pg_default_service_dest = postgres : 1000</li></ul></li></ul><p>Not recommended to set this value above 5000, otherwise you&rsquo;ll need to manually increase haproxy service connection limits.</p><p>Pgbouncer&rsquo;s transaction pool can mitigate excessive OLTP connection issues, so setting a large connection count is not recommended by default.</p><p>For OLAP scenarios, change <a href=#pg_default_service_dest><code>pg_default_service_dest</code></a> to <code>postgres</code> to bypass connection pooling.</p><h3 id=pg_shared_buffer_ratio><code>pg_shared_buffer_ratio</code></h3><p>Parameter Name: <code>pg_shared_buffer_ratio</code>, Type: <code>float</code>, Level: <code>C</code></p><p>Postgres shared buffer memory ratio, default is <code>0.25</code>, normal range is <code>0.1</code>~<code>0.4</code>.</p><p>Default: <code>0.25</code>, meaning 25% of node memory will be used as PostgreSQL&rsquo;s shared buffer. If you want to enable huge pages for PostgreSQL, this value should be appropriately smaller than <a href=#node_hugepage_ratio><code>node_hugepage_ratio</code></a>.</p><p>Setting this value above 0.4 (40%) is usually not a good idea, but may be useful in extreme cases.</p><p>Note that shared buffers are only part of PostgreSQL&rsquo;s shared memory. To calculate total shared memory, use <code>show shared_memory_size_in_huge_pages;</code>.</p><h3 id=pg_rto><code>pg_rto</code></h3><p>Parameter Name: <code>pg_rto</code>, Type: <code>int</code>, Level: <code>C</code></p><p>Recovery Time Objective (RTO) in seconds. This is used to calculate Patroni&rsquo;s TTL value, default is <code>30</code> seconds.</p><p>If the primary instance is missing for this long, a new leader election will be triggered. This value is not the lower the better, it involves trade-offs:</p><p>Reducing this value can reduce unavailable time (unable to write) during cluster failover, but makes the cluster more sensitive to short-term network jitter, thus increasing the chance of false positives triggering failover.</p><p>You need to configure this value based on network conditions and business constraints, making a <strong>trade-off</strong> between failure probability and failure impact. Default is <code>30s</code>, which affects the following Patroni parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># TTL for acquiring leader lease (in seconds). Think of it as the time before starting automatic failover. Default: 30</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>pg_rto }}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Seconds the loop will sleep. Default: 10, this is patroni check loop interval</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>loop_wait</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>(pg_rto / 3)|round(0, &#39;ceil&#39;)|int }}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Timeout for DCS and PostgreSQL operation retries (in seconds). DCS or network issues shorter than this won&#39;t cause Patroni to demote leader. Default: 10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>retry_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>(pg_rto / 3)|round(0, &#39;ceil&#39;)|int }}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Time (in seconds) allowed for primary to recover from failure before triggering failover, max RTO: 2x loop_wait + primary_start_timeout</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>primary_start_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>(pg_rto / 3)|round(0, &#39;ceil&#39;)|int }}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_rpo><code>pg_rpo</code></h3><p>Parameter Name: <code>pg_rpo</code>, Type: <code>int</code>, Level: <code>C</code></p><p>Recovery Point Objective (RPO) in bytes, default: <code>1048576</code>.</p><p>Default is 1MiB, meaning up to 1MiB of data loss can be tolerated during failover.</p><p>When the primary goes down and all replicas are lagging, you must make a difficult choice, <strong>trade-off between availability and consistency</strong>:</p><ul><li>Promote a replica to become new primary and restore service ASAP, but at the cost of acceptable data loss (e.g., less than 1MB).</li><li>Wait for primary to come back online (may never happen), or manual intervention to avoid any data loss.</li></ul><p>You can use the <code>crit.yml</code> <a href=#pg_conf>conf</a> template to ensure no data loss during failover, but this sacrifices some performance.</p><h3 id=pg_libs><code>pg_libs</code></h3><p>Parameter Name: <code>pg_libs</code>, Type: <code>string</code>, Level: <code>C</code></p><p>Preloaded dynamic shared libraries, default is <code>pg_stat_statements,auto_explain</code>, two PostgreSQL built-in extensions that are strongly recommended to enable.</p><p>For existing clusters, you can directly <a href=/docs/pgsql/admin#configure-cluster>configure cluster</a> <code>shared_preload_libraries</code> parameter and apply.</p><p>If you want to use TimescaleDB or Citus extensions, you need to add <code>timescaledb</code> or <code>citus</code> to this list. <code>timescaledb</code> and <code>citus</code> should be placed at the front of this list, for example:</p><pre tabindex=0><code>citus,timescaledb,pg_stat_statements,auto_explain
</code></pre><p>Other extensions requiring dynamic loading can also be added to this list, such as <code>pg_cron</code>, <code>pgml</code>, etc. Typically <code>citus</code> and <code>timescaledb</code> have highest priority and should be added to the front of the list.</p><h3 id=pg_delay><code>pg_delay</code></h3><p>Parameter Name: <code>pg_delay</code>, Type: <code>interval</code>, Level: <code>I</code></p><p>Delayed standby replication delay, default: <code>0</code>.</p><p>If this value is set to a positive value, the standby cluster leader will be delayed by this time before applying WAL changes. Setting to <code>1h</code> means data in this cluster will always lag the original cluster by one hour.</p><p>See <a href=/docs/pgsql/config#delayed-cluster>Delayed Standby Cluster</a> for details.</p><h3 id=pg_checksum><code>pg_checksum</code></h3><p>Parameter Name: <code>pg_checksum</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Enable data checksum for PostgreSQL cluster? Default is <code>true</code>, enabled.</p><p>This parameter can only be set before PGSQL deployment (but you can enable it manually later).</p><p>Data checksums help detect disk corruption and hardware failures. This feature is enabled by default since Pigsty v3.5 to ensure data integrity.</p><h3 id=pg_pwd_enc><code>pg_pwd_enc</code></h3><p>Parameter Name: <code>pg_pwd_enc</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Password encryption algorithm, fixed to <code>scram-sha-256</code> since Pigsty v4.</p><p>All new users will use SCRAM credentials. <code>md5</code> has been deprecated. For compatibility with old clients, upgrade to SCRAM in business connection pools or client drivers.</p><h3 id=pg_encoding><code>pg_encoding</code></h3><p>Parameter Name: <code>pg_encoding</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Database cluster encoding, default is <code>UTF8</code>.</p><p>Using other non-<code>UTF8</code> encodings is not recommended.</p><h3 id=pg_locale><code>pg_locale</code></h3><p>Parameter Name: <code>pg_locale</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Database cluster locale, default is <code>C</code>.</p><p>This parameter controls the database&rsquo;s default Locale setting, affecting collation, character classification, and other behaviors. Using <code>C</code> or <code>POSIX</code> provides best performance and predictable sorting behavior.</p><p>If you need specific language localization support, you can set it to the corresponding Locale, such as <code>en_US.UTF-8</code> or <code>zh_CN.UTF-8</code>. Note that Locale settings affect index sort order, so they cannot be changed after cluster initialization.</p><h3 id=pg_lc_collate><code>pg_lc_collate</code></h3><p>Parameter Name: <code>pg_lc_collate</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Database cluster collation, default is <code>C</code>.</p><p>Unless you know what you&rsquo;re doing, modifying cluster-level collation settings is not recommended.</p><h3 id=pg_lc_ctype><code>pg_lc_ctype</code></h3><p>Parameter Name: <code>pg_lc_ctype</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Database character set CTYPE, default is <code>C</code>.</p><p>Starting from Pigsty v3.5, to be consistent with <code>pg_lc_collate</code>, the default value changed to <code>C</code>.</p><h3 id=pg_io_method><code>pg_io_method</code></h3><p>Parameter Name: <code>pg_io_method</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>PostgreSQL IO method, default is <code>worker</code>. Available options include:</p><ul><li><code>auto</code>: Automatically select based on operating system, uses <code>io_uring</code> on Debian-based systems or EL 10+, otherwise uses <code>worker</code></li><li><code>sync</code>: Use traditional synchronous IO method</li><li><code>worker</code>: Use background worker processes to handle IO (default option)</li><li><code>io_uring</code>: Use Linux&rsquo;s io_uring asynchronous IO interface</li></ul><p>This parameter only applies to PostgreSQL 17 and above, controlling PostgreSQL&rsquo;s data block layer IO strategy.</p><ul><li>In PostgreSQL 17, <code>io_uring</code> can provide higher IO performance, but requires operating system kernel support (Linux 5.1+) and the <code>liburing</code> library installed.</li><li>In PostgreSQL 18, the default IO method changed from <code>sync</code> to <code>worker</code>, using background worker processes for asynchronous IO without additional dependencies.</li><li>If you&rsquo;re using Debian 12/Ubuntu 22+ or EL 10+ systems and want optimal IO performance, consider setting this to <code>io_uring</code>.</li></ul><p>Note that setting this value on systems that don&rsquo;t support <code>io_uring</code> may cause PostgreSQL startup to fail, so <code>auto</code> or <code>worker</code> are safer choices.</p><h3 id=pg_etcd_password><code>pg_etcd_password</code></h3><p>Parameter Name: <code>pg_etcd_password</code>, Type: <code>password</code>, Level: <code>C</code></p><p>The password used by this PostgreSQL cluster in etcd, default is empty string <code>''</code>.</p><p>If set to empty string, the <a href=#pg_cluster><code>pg_cluster</code></a> parameter value will be used as the password (for Citus clusters, the <a href=#pg_shard><code>pg_shard</code></a> parameter value is used).</p><p>This password is used for authentication when Patroni connects to etcd and when vip-manager accesses etcd.</p><h3 id=pgsodium_key><code>pgsodium_key</code></h3><p>Parameter Name: <code>pgsodium_key</code>, Type: <code>string</code>, Level: <code>C</code></p><p>The encryption master key for the pgsodium extension, consisting of 64 hexadecimal digits.</p><p>This parameter is not set by default. If not specified, Pigsty will automatically generate a deterministic key using the value of <code>sha256(pg_cluster)</code>.</p><p><a href=https://github.com/michelp/pgsodium>pgsodium</a> is a PostgreSQL extension based on libsodium that provides encryption functions and transparent column encryption capabilities.
If you need to use pgsodium&rsquo;s encryption features, it&rsquo;s recommended to explicitly specify a secure random key and keep it safe.</p><p>Example command to generate a random key:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl rand -hex <span style=color:#0000cf;font-weight:700>32</span>   <span style=color:#8f5902;font-style:italic># Generate 64-digit hexadecimal key</span>
</span></span></code></pre></div><h3 id=pgsodium_getkey_script><code>pgsodium_getkey_script</code></h3><p>Parameter Name: <code>pgsodium_getkey_script</code>, Type: <code>path</code>, Level: <code>C</code></p><p>Path to the pgsodium key retrieval script, default uses the <code>pgsodium_getkey</code> script from Pigsty templates.</p><p>This script is used to retrieve pgsodium&rsquo;s master key when PostgreSQL starts. The default script reads the key from environment variables or configuration files.</p><p>If you have custom key management requirements (such as using HashiCorp Vault, AWS KMS, etc.), you can provide a custom script path.</p><h2 id=pg_provision><code>PG_PROVISION</code></h2><p>If <a href=#pg_bootstrap><code>PG_BOOTSTRAP</code></a> is about creating a new cluster, then PG_PROVISION is about creating default objects in the cluster, including:</p><ul><li><a href=/docs/concept/sec/ac/#default-roles>Default Roles</a></li><li><a href=/docs/concept/sec/ac/#default-users>Default Users</a></li><li><a href=/docs/concept/sec/ac/#default-privileges>Default Privileges</a></li><li><a href=/docs/pgsql/config/hba#default-hba>Default HBA Rules</a></li><li>Default Schemas</li><li>Default Extensions</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_provision</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># provision postgres cluster after bootstrap</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_init</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-init                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># init script for cluster template, default is `pg-init`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># default privileges when admin user creates objects</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor ]  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># default schemas</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># default extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_stat_statements ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgstattuple        ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_buffercache     ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pageinspect        ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_prewarm         ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_visibility      ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_freespacemap    ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres_fdw       ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: file_fdw           ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: btree_gist         ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: btree_gin          ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_trgm            ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: intagg             ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: intarray           ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_repack }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_reload</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># reload config after HBA changes?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres default HBA rules, ordered by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title: &#39;admin @ everywhere with ssl &amp; pwd&#39;    ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer default HBA rules, ordered by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_provision-1><code>pg_provision</code></h3><p>Parameter Name: <code>pg_provision</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Complete the PostgreSQL cluster provisioning work defined in this section after the cluster is bootstrapped. Default value is <code>true</code>.</p><p>If disabled, the PostgreSQL cluster will not be provisioned. For some special &ldquo;PostgreSQL&rdquo; clusters, such as Greenplum, you can disable this option to skip the provisioning phase.</p><h3 id=pg_init><code>pg_init</code></h3><p>Parameter Name: <code>pg_init</code>, Type: <code>string</code>, Level: <code>G/C</code></p><p>Location of the shell script for initializing database templates, default is <code>pg-init</code>. This script is copied to <code>/pg/bin/pg-init</code> and then executed.</p><p>This script is located at <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init><code>roles/pgsql/templates/pg-init</code></a></p><p>You can add your own logic to this script, or provide a new script in the <code>templates/</code> directory and set <code>pg_init</code> to the new script name. When using a custom script, please preserve the existing initialization logic.</p><h3 id=pg_default_roles><code>pg_default_roles</code></h3><p>Parameter Name: <code>pg_default_roles</code>, Type: <code>role[]</code>, Level: <code>G/C</code></p><p>Default roles and users in Postgres cluster.</p><p>Pigsty has a built-in role system. Please check <a href=/docs/concept/sec/ac/#role-system>PGSQL Access Control: Role System</a> for details.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly]               ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite]  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true                                          ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_default_privileges><code>pg_default_privileges</code></h3><p>Parameter Name: <code>pg_default_privileges</code>, Type: <code>string[]</code>, Level: <code>G/C</code></p><p>Default privileges (<code>DEFAULT PRIVILEGE</code>) settings in each database:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># default privileges when admin user creates objects</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty provides corresponding default privilege settings based on the default role system. Please check <a href=/docs/concept/sec/ac/#default-privileges>PGSQL Access Control: Privileges</a> for details.</p><h3 id=pg_default_schemas><code>pg_default_schemas</code></h3><p>Parameter Name: <code>pg_default_schemas</code>, Type: <code>string[]</code>, Level: <code>G/C</code></p><p>Default schemas to create, default value is: <code>[ monitor ]</code>. This will create a <code>monitor</code> schema on all databases for placing various monitoring extensions, tables, views, and functions.</p><h3 id=pg_default_extensions><code>pg_default_extensions</code></h3><p>Parameter Name: <code>pg_default_extensions</code>, Type: <code>extension[]</code>, Level: <code>G/C</code></p><p>List of extensions to be created and enabled by default in all databases, default value:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># default extensions to be created</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_stat_statements ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgstattuple        ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_buffercache     ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pageinspect        ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_prewarm         ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_visibility      ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_freespacemap    ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres_fdw       ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: file_fdw           ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: btree_gist         ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: btree_gin          ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_trgm            ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: intagg             ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: intarray           ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_repack }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The only third-party extension is <code>pg_repack</code>, which is important for database maintenance. All other extensions are built-in PostgreSQL Contrib extensions.</p><p>Monitoring-related extensions are installed in the <code>monitor</code> schema by default, which is created by <a href=#pg_default_schemas><code>pg_default_schemas</code></a>.</p><h3 id=pg_reload><code>pg_reload</code></h3><p>Parameter Name: <code>pg_reload</code>, Type: <code>bool</code>, Level: <code>A</code></p><p>Reload PostgreSQL after HBA changes, default value is <code>true</code>.</p><p>Set it to <code>false</code> to disable automatic configuration reload when you want to check before applying HBA changes.</p><h3 id=pg_default_hba_rules><code>pg_default_hba_rules</code></h3><p>Parameter Name: <code>pg_default_hba_rules</code>, Type: <code>hba[]</code>, Level: <code>G/C</code></p><p>PostgreSQL host-based authentication rules, global default rules definition. Default value is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres default host-based authentication rules, ordered by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title: &#39;admin @ everywhere with ssl &amp; pwd&#39;    ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The default value provides a fair security level for common scenarios. Please check <a href=/docs/pgsql/config/hba>PGSQL Authentication</a> for details.</p><p>This parameter is an array of <a href=/docs/pgsql/config/hba#define-hba>HBA</a> rule objects, identical in format to <a href=#pg_hba_rules><code>pg_hba_rules</code></a>.
It&rsquo;s recommended to configure unified <a href=#pg_default_hba_rules><code>pg_default_hba_rules</code></a> globally, and use <a href=#pg_hba_rules><code>pg_hba_rules</code></a> for additional customization on specific clusters. Rules from both parameters are applied sequentially, with the latter having higher priority.</p><h3 id=pgb_default_hba_rules><code>pgb_default_hba_rules</code></h3><p>Parameter Name: <code>pgb_default_hba_rules</code>, Type: <code>hba[]</code>, Level: <code>G/C</code></p><p>Pgbouncer default host-based authentication rules, array of <a href=/docs/pgsql/config/hba#define-hba>HBA</a> rule objects.</p><p>Default value provides a fair security level for common scenarios. Check <a href=/docs/pgsql/config/hba>PGSQL Authentication</a> for details.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer default host-based authentication rules, ordered by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The default Pgbouncer HBA rules are simple:</p><ol><li>Allow login from <strong>localhost</strong> with password</li><li>Allow login from intranet with password</li></ol><p>Users can customize according to their own needs.</p><p>This parameter is identical in format to <a href=#pgb_hba_rules><code>pgb_hba_rules</code></a>. It&rsquo;s recommended to configure unified <a href=#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a> globally, and use <a href=#pgb_hba_rules><code>pgb_hba_rules</code></a> for additional customization on specific clusters. Rules from both parameters are applied sequentially, with the latter having higher priority.</p><hr><h2 id=pg_backup><code>PG_BACKUP</code></h2><p>This section defines variables for <a href=https://pgbackrest.org/>pgBackRest</a>, which is used for PGSQL Point-in-Time Recovery (PITR).</p><p>Check <a href=/docs/pgsql/backup>PGSQL Backup & PITR</a> for detailed information.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># enable pgBackRest on pgsql host?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_clean</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># remove pg backup data during init?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/pgbackrest</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest log dir, default is `/pg/log/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method: local          # pgbackrest repo method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local, minio, [user defined...]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_init_backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># perform a full backup immediately after pgbackrest init?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># default pgbackrest repo with local posix filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># local backup directory, default is `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># retain full backup by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># keep at most 3 full backups when using local filesystem repo, at least 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># optional minio repo for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio is s3-compatible, so use s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio endpoint domain, default is `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio region, default is us-east-1, not effective for minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio bucket name, default is `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user access key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user secret key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use path style uri for minio, instead of host style</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio backup path, default is `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio port, default is 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio ca file path, default is `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable block-level incremental backup (pgBackRest 2.46+)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># bundle small files into one file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># object storage file bundling threshold, default 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># object storage file bundling target size, default 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># enable AES encryption for remote backup repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, default is &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># retain full backup by time on minio repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># keep full backups from the past 14 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgbackrest_enabled><code>pgbackrest_enabled</code></h3><p>Parameter Name: <code>pgbackrest_enabled</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Enable pgBackRest on PGSQL nodes? Default value is: <code>true</code></p><p>When using local filesystem backup repository (<code>local</code>), only the cluster primary will actually enable <code>pgbackrest</code>. Other instances will only initialize an empty repository.</p><h3 id=pgbackrest_clean><code>pgbackrest_clean</code></h3><p>Parameter Name: <code>pgbackrest_clean</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Remove PostgreSQL backup data during initialization? Default value is <code>true</code>.</p><h3 id=pgbackrest_log_dir><code>pgbackrest_log_dir</code></h3><p>Parameter Name: <code>pgbackrest_log_dir</code>, Type: <code>path</code>, Level: <code>C</code></p><p>pgBackRest log directory, default is <code>/pg/log/pgbackrest</code>. The Vector log agent references this parameter for log collection.</p><h3 id=pgbackrest_method><code>pgbackrest_method</code></h3><p>Parameter Name: <code>pgbackrest_method</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>pgBackRest repository method: default options are <code>local</code>, <code>minio</code>, or other user-defined methods, default is <code>local</code>.</p><p>This parameter determines which repository to use for pgBackRest. All available repository methods are defined in <a href=#pgbackrest_repo><code>pgbackrest_repo</code></a>.</p><p>Pigsty uses the <code>local</code> backup repository by default, which creates a backup repository in the <code>/pg/backup</code> directory on the primary instance. The underlying storage path is specified by <a href=#pg_fs_backup><code>pg_fs_backup</code></a>.</p><h3 id=pgbackrest_init_backup><code>pgbackrest_init_backup</code></h3><p>Parameter Name: <code>pgbackrest_init_backup</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Perform a full backup immediately after pgBackRest initialization completes? Default is <code>true</code>.</p><p>This operation is only executed on cluster primary and non-cascading replicas (no <a href=#pg_upstream><code>pg_upstream</code></a> defined). Enabling this parameter ensures you have a base backup immediately after cluster initialization for recovery when needed.</p><h3 id=pgbackrest_repo><code>pgbackrest_repo</code></h3><p>Parameter Name: <code>pgbackrest_repo</code>, Type: <code>dict</code>, Level: <code>G/C</code></p><p>pgBackRest repository documentation: <a href=https://pgbackrest.org/configuration.html#section-repository>https://pgbackrest.org/configuration.html#section-repository</a></p><p>Default value includes two repository methods: <code>local</code> and <code>minio</code>, defined as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># default pgbackrest repo with local posix filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># local backup directory, default is `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># retain full backup by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># keep at most 3 full backups when using local filesystem repo, at least 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># optional minio repo for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio is s3-compatible, so use s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio endpoint domain, default is `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio region, default is us-east-1, not effective for minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio bucket name, default is `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user access key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user secret key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use path style uri for minio, instead of host style</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio backup path, default is `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio port, default is 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio ca file path, default is `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable block-level incremental backup (pgBackRest 2.46+)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># bundle small files into one file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># object storage file bundling threshold, default 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># object storage file bundling target size, default 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># enable AES encryption for remote backup repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, default is &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># retain full backup by time on minio repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># keep full backups from the past 14 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can define new backup repositories, such as using AWS S3, GCP, or other cloud providers&rsquo; S3-compatible storage services.</p><p><strong>Block Incremental Backup</strong>: Starting from pgBackRest 2.46, the <code>block: y</code> option enables block-level incremental backup.
This means during incremental backups, pgBackRest only backs up changed data blocks instead of entire changed files, significantly reducing backup data volume and backup time.
This feature is particularly useful for large databases, and it&rsquo;s recommended to enable this option on object storage repositories.</p><hr><h2 id=pg_access><code>PG_ACCESS</code></h2><p>This section handles database access paths, including:</p><ul><li>Deploy Pgbouncer connection pooler on each PGSQL node and set default behavior</li><li>Publish service ports through local or dedicated haproxy nodes</li><li>Bind optional L2 VIP and register DNS records</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># if disabled, pgbouncer will not be launched on pgsql host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>6432</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># pgbouncer listen port, 6432 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/pgbouncer </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbouncer log dir, `/pg/log/pgbouncer` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_auth_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># query postgres to retrieve unlisted business users?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_poolmode: transaction   # pooling mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction,session,statement, transaction by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disable       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbouncer client ssl mode, disable by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_ignore_param</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>extra_float_digits, application_name, TimeZone, DateStyle, IntervalStyle, search_path ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>#INSTANCE # relative load balance weight in service, 100 by default, 0-255</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># dedicate haproxy node group name, or empty string for local nodes by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbouncer</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># default service destination if svc.dest=&#39;default&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># postgres default service definitions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># enable a l2 vip for pgsql primary? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>127.0.0.1</span><span style=color:#000>/24     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip address in `&lt;ipv4&gt;/&lt;mask&gt;` format, require if vip is enabled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth0           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip network interface to listen, eth0 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dns_suffix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># pgsql dns suffix, &#39;&#39; by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dns_target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>auto              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># auto, primary, vip, none, or ad hoc ip</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgbouncer_enabled><code>pgbouncer_enabled</code></h3><p>Parameter Name: <code>pgbouncer_enabled</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Default value is <code>true</code>. If disabled, the Pgbouncer connection pooler will not be configured on PGSQL nodes.</p><h3 id=pgbouncer_port><code>pgbouncer_port</code></h3><p>Parameter Name: <code>pgbouncer_port</code>, Type: <code>port</code>, Level: <code>C</code></p><p>Pgbouncer listen port, default is <code>6432</code>.</p><h3 id=pgbouncer_log_dir><code>pgbouncer_log_dir</code></h3><p>Parameter Name: <code>pgbouncer_log_dir</code>, Type: <code>path</code>, Level: <code>C</code></p><p>Pgbouncer log directory, default is <code>/pg/log/pgbouncer</code>. The Vector log agent collects Pgbouncer logs based on this parameter.</p><h3 id=pgbouncer_auth_query><code>pgbouncer_auth_query</code></h3><p>Parameter Name: <code>pgbouncer_auth_query</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Allow Pgbouncer to query PostgreSQL to allow users not explicitly listed to access PostgreSQL through the connection pool? Default value is <code>false</code>.</p><p>If enabled, pgbouncer users will authenticate against the postgres database using <code>SELECT username, password FROM monitor.pgbouncer_auth($1)</code>. Otherwise, only business users with <code>pgbouncer: true</code> are allowed to connect to the Pgbouncer connection pool.</p><h3 id=pgbouncer_poolmode><code>pgbouncer_poolmode</code></h3><p>Parameter Name: <code>pgbouncer_poolmode</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Pgbouncer connection pool pooling mode: <code>transaction</code>, <code>session</code>, <code>statement</code>, default is <code>transaction</code>.</p><ul><li><code>session</code>: Session-level pooling with best feature compatibility.</li><li><code>transaction</code>: Transaction-level pooling with better performance (many small connections), may break some session-level features like <code>NOTIFY/LISTEN</code>, etc.</li><li><code>statements</code>: Statement-level pooling for simple read-only queries.</li></ul><p>If your application has feature compatibility issues, consider changing this parameter to <code>session</code>.</p><h3 id=pgbouncer_sslmode><code>pgbouncer_sslmode</code></h3><p>Parameter Name: <code>pgbouncer_sslmode</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Pgbouncer client SSL mode, default is <code>disable</code>.</p><p>Note that enabling SSL may have a significant performance impact on your pgbouncer.</p><ul><li><code>disable</code>: Ignore if client requests TLS (default)</li><li><code>allow</code>: Use TLS if client requests it. Use plain TCP if not. Does not verify client certificate.</li><li><code>prefer</code>: Same as allow.</li><li><code>require</code>: Client must use TLS. Reject client connection if not. Does not verify client certificate.</li><li><code>verify-ca</code>: Client must use TLS with a valid client certificate.</li><li><code>verify-full</code>: Same as verify-ca.</li></ul><h3 id=pgbouncer_ignore_param><code>pgbouncer_ignore_param</code></h3><p>Parameter Name: <code>pgbouncer_ignore_param</code>, Type: <code>string[]</code>, Level: <code>C</code></p><p>List of startup parameters ignored by PgBouncer, default value is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>extra_float_digits, application_name, TimeZone, DateStyle, IntervalStyle, search_path ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>These parameters are configured in the <code>ignore_startup_parameters</code> option in the PgBouncer configuration file. When clients set these parameters during connection, PgBouncer will not create new connections due to parameter mismatch in the connection pool.</p><p>This allows different clients to use the same connection pool even if they set different values for these parameters. This parameter was added in Pigsty v3.5.</p><hr><h3 id=pg_weight><code>pg_weight</code></h3><p>Parameter Name: <code>pg_weight</code>, Type: <code>int</code>, Level: <code>I</code></p><p>Relative load balancing weight in service, default is 100, range 0-255.</p><p>Default value: <code>100</code>. You must define it in instance variables and <a href=/docs/pgsql/admin#reload-service>reload service</a> for it to take effect.</p><h3 id=pg_service_provider><code>pg_service_provider</code></h3><p>Parameter Name: <code>pg_service_provider</code>, Type: <code>string</code>, Level: <code>G/C</code></p><p>Dedicated haproxy node group name, or empty string for local nodes by default.</p><p>If specified, PostgreSQL services will be registered to the dedicated haproxy node group instead of the current PGSQL cluster nodes.</p><p>Remember to allocate <strong>unique</strong> ports for each service on the dedicated haproxy nodes!</p><p>For example, if we define the following parameters on a 3-node <code>pg-test</code> cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>infra      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use load balancer on group `infra`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># alloc port 10001 and 10002 for pg-test primary/replica service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 10001 ,dest: postgres  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 10002 ,dest: postgres  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_default_service_dest><code>pg_default_service_dest</code></h3><p>Parameter Name: <code>pg_default_service_dest</code>, Type: <code>enum</code>, Level: <code>G/C</code></p><p>When defining a <a href=/docs/pgsql/service/#define-service>service</a>, if <code>svc.dest='default'</code>, this parameter will be used as the default value.</p><p>Default value: <code>pgbouncer</code>, meaning the 5433 primary service and 5434 replica service will route traffic to pgbouncer by default.</p><p>If you don&rsquo;t want to use pgbouncer, set it to <code>postgres</code>. Traffic will be routed directly to postgres.</p><h3 id=pg_default_services><code>pg_default_services</code></h3><p>Parameter Name: <code>pg_default_services</code>, Type: <code>service[]</code>, Level: <code>G/C</code></p><p>Postgres default service definitions.</p><p>Default value is four default service definitions, as described in <a href=/docs/pgsql/service/#service-overview>PGSQL Service</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># postgres default service definitions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_vip_enabled><code>pg_vip_enabled</code></h3><p>Parameter Name: <code>pg_vip_enabled</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Enable L2 VIP for PGSQL cluster? Default value is <code>false</code>, meaning no L2 VIP will be created.</p><p>When L2 VIP is enabled, a VIP will be bound to the cluster primary instance node, managed by <code>vip-manager</code> based on data in <code>etcd</code>.</p><p>L2 VIP can only be used within the same L2 network, which may impose additional constraints on your network topology.</p><h3 id=pg_vip_address><code>pg_vip_address</code></h3><p>Parameter Name: <code>pg_vip_address</code>, Type: <code>cidr4</code>, Level: <code>C</code></p><p>VIP address in <code>&lt;ipv4>/&lt;mask></code> format is required if VIP is enabled.</p><p>Default value: <code>127.0.0.1/24</code>. This value consists of two parts: <code>ipv4</code> and <code>mask</code>, separated by <code>/</code>.</p><h3 id=pg_vip_interface><code>pg_vip_interface</code></h3><p>Parameter Name: <code>pg_vip_interface</code>, Type: <code>string</code>, Level: <code>C/I</code></p><p>VIP network interface to listen, <code>eth0</code> by default.</p><p>It should be your node&rsquo;s primary network interface name, i.e., the IP address used in your inventory.</p><p>If your nodes have multiple network interfaces with different names, you can override it in instance variables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: replica ,pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth0 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: primary ,pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica ,pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth2 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># enable L2 VIP for this cluster, binds to primary by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_vip_address: 10.10.10.3/24 # L2 network CIDR: 10.10.10.0/24, vip address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># pg_vip_interface: eth1      # if your nodes have a unified interface, you can define it here</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_dns_suffix><code>pg_dns_suffix</code></h3><p>Parameter Name: <code>pg_dns_suffix</code>, Type: <code>string</code>, Level: <code>C</code></p><p>PostgreSQL DNS name suffix, default is empty string.</p><p>By default, the PostgreSQL cluster name is registered as a DNS domain in <code>dnsmasq</code> on Infra nodes for external resolution.</p><p>You can specify a domain suffix with this parameter, which will use <code>{{ pg_cluster }}{{ pg_dns_suffix }}</code> as the cluster DNS name.</p><p>For example, if you set <code>pg_dns_suffix</code> to <code>.db.vip.company.tld</code>, the <code>pg-test</code> cluster DNS name will be <code>pg-test.db.vip.company.tld</code>.</p><h3 id=pg_dns_target><code>pg_dns_target</code></h3><p>Parameter Name: <code>pg_dns_target</code>, Type: <code>enum</code>, Level: <code>C</code></p><p>Could be: <code>auto</code>, <code>primary</code>, <code>vip</code>, <code>none</code>, or an ad hoc IP address, which will be the target IP address of cluster DNS record.</p><p>Default value: <code>auto</code>, which will bind to <code>pg_vip_address</code> if <code>pg_vip_enabled</code>, or fallback to cluster primary instance IP address.</p><ul><li><code>vip</code>: bind to <code>pg_vip_address</code></li><li><code>primary</code>: resolve to cluster primary instance IP address</li><li><code>auto</code>: resolve to <code>pg_vip_address</code> if <code>pg_vip_enabled</code>, or fallback to cluster primary instance IP address</li><li><code>none</code>: do not bind to any IP address</li><li><code>&lt;ipv4></code>: bind to the given IP address</li></ul><hr><h2 id=pg_monitor><code>PG_MONITOR</code></h2><p>The PG_MONITOR group parameters are used to monitor the status of PostgreSQL databases, Pgbouncer connection pools, and pgBackRest backup systems.</p><p>This parameter group defines three Exporter configurations: <code>pg_exporter</code> for monitoring PostgreSQL, <code>pgbouncer_exporter</code> for monitoring connection pools, and <code>pgbackrest_exporter</code> for monitoring backup status.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># enable pg_exporter on pgsql host?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_exporter.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg_exporter config file name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_cache_ttls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;1,10,60,300&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># pg_exporter collector ttl stages (seconds), default is &#39;1,10,60,300&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># pg_exporter listen port, default is 9630</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_params</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslmode=disable&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># extra url parameters for pg_exporter dsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># if specified, will override auto-generated pg dsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># enable auto database discovery? enabled by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_exclude_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;template0,template1,postgres&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># csv list of databases not monitored during auto-discovery</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># csv list of databases monitored during auto-discovery</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_connect_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># pg_exporter connection timeout (ms), default is 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># extra options to override pg_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># enable pgbouncer_exporter on pgsql host?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9631</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># pgbouncer_exporter listen port, default is 9631</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># if specified, will override auto-generated pgbouncer dsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># extra options to override pgbouncer_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_exporter_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># enable pgbackrest_exporter on pgsql host?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9854</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># pgbackrest_exporter listen port, default is 9854</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_exporter_options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># extra options to override pgbackrest_exporter</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_exporter_enabled><code>pg_exporter_enabled</code></h3><p>Parameter Name: <code>pg_exporter_enabled</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Enable pg_exporter on PGSQL nodes? Default value is: <code>true</code>.</p><p>PG Exporter is used to monitor PostgreSQL database instances. Set to <code>false</code> if you don&rsquo;t want to install pg_exporter.</p><h3 id=pg_exporter_config><code>pg_exporter_config</code></h3><p>Parameter Name: <code>pg_exporter_config</code>, Type: <code>string</code>, Level: <code>C</code></p><p>pg_exporter configuration file name, both PG Exporter and PGBouncer Exporter will use this configuration file. Default value: <code>pg_exporter.yml</code>.</p><p>If you want to use a custom configuration file, you can define it here. Your custom configuration file should be placed in <code>files/&lt;name>.yml</code>.</p><p>For example, when you want to monitor a remote PolarDB database instance, you can use the sample configuration: <code>files/polar_exporter.yml</code>.</p><h3 id=pg_exporter_cache_ttls><code>pg_exporter_cache_ttls</code></h3><p>Parameter Name: <code>pg_exporter_cache_ttls</code>, Type: <code>string</code>, Level: <code>C</code></p><p>pg_exporter collector TTL stages (seconds), default is &lsquo;1,10,60,300&rsquo;.</p><p>Default value: <code>1,10,60,300</code>, which will use different TTL values for different metric collectors: 1s, 10s, 60s, 300s.</p><p>PG Exporter has a built-in caching mechanism to avoid the improper impact of multiple Prometheus scrapes on the database. All metric collectors are divided into four categories by TTL:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>ttl_fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ pg_exporter_cache_ttls.split(&#39;,&#39;)[0]|int }}&#34;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># critical queries</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ttl_norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ pg_exporter_cache_ttls.split(&#39;,&#39;)[1]|int }}&#34;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># common queries</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ttl_slow</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ pg_exporter_cache_ttls.split(&#39;,&#39;)[2]|int }}&#34;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># slow queries (e.g table size)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ttl_slowest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ pg_exporter_cache_ttls.split(&#39;,&#39;)[3]|int }}&#34;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># ver slow queries (e.g bloat)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For example, with default configuration, liveness metrics are cached for at most <code>1s</code>, most common metrics are cached for <code>10s</code> (should match the monitoring scrape interval <a href=/docs/infra/param#victoria_scrape_interval><code>victoria_scrape_interval</code></a>).
A few slow-changing queries have <code>60s</code> TTL, and very few high-overhead monitoring queries have <code>300s</code> TTL.</p><h3 id=pg_exporter_port><code>pg_exporter_port</code></h3><p>Parameter Name: <code>pg_exporter_port</code>, Type: <code>port</code>, Level: <code>C</code></p><p>pg_exporter listen port, default value is: <code>9630</code></p><h3 id=pg_exporter_params><code>pg_exporter_params</code></h3><p>Parameter Name: <code>pg_exporter_params</code>, Type: <code>string</code>, Level: <code>C</code></p><p>Extra URL path parameters in the DSN used by pg_exporter.</p><p>Default value: <code>sslmode=disable</code>, which disables SSL for monitoring connections (since local unix sockets are used by default).</p><h3 id=pg_exporter_url><code>pg_exporter_url</code></h3><p>Parameter Name: <code>pg_exporter_url</code>, Type: <code>pgurl</code>, Level: <code>C</code></p><p>If specified, will override the auto-generated PostgreSQL DSN and use the specified DSN to connect to PostgreSQL. Default value is empty string.</p><p>If not specified, PG Exporter will use the following connection string to access PostgreSQL by default:</p><pre tabindex=0><code>postgres://{{ pg_monitor_username }}:{{ pg_monitor_password }}@{{ pg_host }}:{{ pg_port }}/postgres{% if pg_exporter_params != &#39;&#39; %}?{{ pg_exporter_params }}{% endif %}
</code></pre><p>Use this parameter when you want to monitor a remote PostgreSQL instance, or need to use different monitoring user/password or configuration options.</p><h3 id=pg_exporter_auto_discovery><code>pg_exporter_auto_discovery</code></h3><p>Parameter Name: <code>pg_exporter_auto_discovery</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Enable auto database discovery? Enabled by default: <code>true</code>.</p><p>By default, PG Exporter connects to the database specified in the DSN (default is the admin database <code>postgres</code>) to collect global metrics. If you want to collect metrics from all business databases, enable this option.
PG Exporter will automatically discover all databases in the target PostgreSQL instance and collect <strong>database-level monitoring metrics</strong> from these databases.</p><h3 id=pg_exporter_exclude_database><code>pg_exporter_exclude_database</code></h3><p>Parameter Name: <code>pg_exporter_exclude_database</code>, Type: <code>string</code>, Level: <code>C</code></p><p>If database auto-discovery is enabled (enabled by default), databases in this parameter&rsquo;s list will not be monitored.
Default value is: <code>template0,template1,postgres</code>, meaning the admin database <code>postgres</code> and template databases are excluded from auto-monitoring.</p><p>As an exception, the database specified in the DSN is not affected by this parameter. For example, if PG Exporter connects to the <code>postgres</code> database, it will be monitored even if <code>postgres</code> is in this list.</p><h3 id=pg_exporter_include_database><code>pg_exporter_include_database</code></h3><p>Parameter Name: <code>pg_exporter_include_database</code>, Type: <code>string</code>, Level: <code>C</code></p><p>If database auto-discovery is enabled (enabled by default), only databases in this parameter&rsquo;s list will be monitored. Default value is empty string, meaning this feature is not enabled.</p><p>The parameter format is a comma-separated list of database names, e.g., <code>db1,db2,db3</code>.</p><p>This parameter has higher priority than <a href=#pg_exporter_exclude_database><code>pg_exporter_exclude_database</code></a>, acting as a whitelist mode. Use this parameter if you only want to monitor specific databases.</p><h3 id=pg_exporter_connect_timeout><code>pg_exporter_connect_timeout</code></h3><p>Parameter Name: <code>pg_exporter_connect_timeout</code>, Type: <code>int</code>, Level: <code>C</code></p><p>pg_exporter connection timeout (milliseconds), default is <code>200</code> (in milliseconds).</p><p>How long will PG Exporter wait when trying to connect to a PostgreSQL database? Beyond this time, PG Exporter will give up the connection and report an error.</p><p>The default value of 200ms is sufficient for most scenarios (e.g., same availability zone monitoring), but if your monitored remote PostgreSQL is on another continent, you may need to increase this value to avoid connection timeouts.</p><h3 id=pg_exporter_options><code>pg_exporter_options</code></h3><p>Parameter Name: <code>pg_exporter_options</code>, Type: <code>arg</code>, Level: <code>C</code></p><p>Command line arguments passed to PG Exporter, default value is: <code>""</code> empty string.</p><p>When using empty string, the default command arguments will be used:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% <span style=color:#204a87;font-weight:700>if</span> pg_exporter_port !<span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span> %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--web.listen-address=:{{ pg_exporter_port }} {{ pg_exporter_options }}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% <span style=color:#204a87;font-weight:700>else</span> %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--web.listen-address=:{{ pg_exporter_port }} --log.level=info&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% endif %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Note: Do not override the <a href=#pg_exporter_port><code>pg_exporter_port</code></a> port configuration in this parameter.</p><h3 id=pgbouncer_exporter_enabled><code>pgbouncer_exporter_enabled</code></h3><p>Parameter Name: <code>pgbouncer_exporter_enabled</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Enable pgbouncer_exporter on PGSQL nodes? Default value is: <code>true</code>.</p><h3 id=pgbouncer_exporter_port><code>pgbouncer_exporter_port</code></h3><p>Parameter Name: <code>pgbouncer_exporter_port</code>, Type: <code>port</code>, Level: <code>C</code></p><p>pgbouncer_exporter listen port, default value is: <code>9631</code></p><h3 id=pgbouncer_exporter_url><code>pgbouncer_exporter_url</code></h3><p>Parameter Name: <code>pgbouncer_exporter_url</code>, Type: <code>pgurl</code>, Level: <code>C</code></p><p>If specified, will override the auto-generated pgbouncer DSN and use the specified DSN to connect to pgbouncer. Default value is empty string.</p><p>If not specified, Pgbouncer Exporter will use the following connection string to access Pgbouncer by default:</p><pre tabindex=0><code>postgres://{{ pg_monitor_username }}:{{ pg_monitor_password }}@:{{ pgbouncer_port }}/pgbouncer?host={{ pg_localhost }}&amp;sslmode=disable
</code></pre><p>Use this parameter when you want to monitor a remote Pgbouncer instance, or need to use different monitoring user/password or configuration options.</p><h3 id=pgbouncer_exporter_options><code>pgbouncer_exporter_options</code></h3><p>Parameter Name: <code>pgbouncer_exporter_options</code>, Type: <code>arg</code>, Level: <code>C</code></p><p>Command line arguments passed to Pgbouncer Exporter, default value is: <code>""</code> empty string.</p><p>When using empty string, the default command arguments will be used:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% <span style=color:#204a87;font-weight:700>if</span> pgbouncer_exporter_options !<span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span> %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--web.listen-address=:{{ pgbouncer_exporter_port }} {{ pgbouncer_exporter_options }}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% <span style=color:#204a87;font-weight:700>else</span> %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--web.listen-address=:{{ pgbouncer_exporter_port }} --log.level=info&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% endif %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Note: Do not override the <a href=#pgbouncer_exporter_port><code>pgbouncer_exporter_port</code></a> port configuration in this parameter.</p><h3 id=pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></h3><p>Parameter Name: <code>pgbackrest_exporter_enabled</code>, Type: <code>bool</code>, Level: <code>C</code></p><p>Enable pgbackrest_exporter on PGSQL nodes? Default value is: <code>true</code>.</p><p>pgbackrest_exporter is used to monitor the status of the pgBackRest backup system, including key metrics such as backup size, time, type, and duration.</p><h3 id=pgbackrest_exporter_port><code>pgbackrest_exporter_port</code></h3><p>Parameter Name: <code>pgbackrest_exporter_port</code>, Type: <code>port</code>, Level: <code>C</code></p><p>pgbackrest_exporter listen port, default value is: <code>9854</code>.</p><p>This port needs to be referenced in the Prometheus service discovery configuration to scrape backup-related monitoring metrics.</p><h3 id=pgbackrest_exporter_options><code>pgbackrest_exporter_options</code></h3><p>Parameter Name: <code>pgbackrest_exporter_options</code>, Type: <code>arg</code>, Level: <code>C</code></p><p>Command line arguments passed to pgbackrest_exporter, default value is: <code>""</code> empty string.</p><p>When using empty string, the default command argument configuration will be used. You can specify additional parameter options here to adjust the exporter&rsquo;s behavior.</p><hr><h2 id=pg_remove><code>PG_REMOVE</code></h2><p><a href=/docs/pgsql/playbook#pgsql-rmyml><code>pgsql-rm.yml</code></a> invokes the <code>pg_remove</code> role to safely remove PostgreSQL instances. This section&rsquo;s parameters control cleanup behavior to avoid accidental deletion.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rm_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># remove postgres data during remove? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rm_backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># remove pgbackrest backup during primary remove? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rm_pkg</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># uninstall postgres packages during remove? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># stop pg_remove running if pg_safeguard is enabled, false by default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_rm_data><code>pg_rm_data</code></h3><p>Parameter Name: <code>pg_rm_data</code>, Type: <code>bool</code>, Level: <code>G/C/A</code></p><p>Whether to clean up <a href=#pg_data><code>pg_data</code></a> and symlinks when removing PGSQL instances, default is <code>true</code>.</p><p>This switch affects both <code>pgsql-rm.yml</code> and other scenarios that trigger <code>pg_remove</code>. Set to <code>false</code> to preserve the data directory for manual inspection or remounting.</p><h3 id=pg_rm_backup><code>pg_rm_backup</code></h3><p>Parameter Name: <code>pg_rm_backup</code>, Type: <code>bool</code>, Level: <code>G/C/A</code></p><p>Whether to also clean up the pgBackRest repository and configuration when removing the primary, default is <code>true</code>.</p><p>This parameter only applies to primary instances with <code>pg_role=primary</code>: <code>pg_remove</code> will first stop pgBackRest, delete the current cluster&rsquo;s stanza, and remove data in <a href=#pg_fs_backup><code>pg_fs_backup</code></a> when <code>pgbackrest_method == 'local'</code>. Standby clusters or upstream backups are not affected.</p><h3 id=pg_rm_pkg><code>pg_rm_pkg</code></h3><p>Parameter Name: <code>pg_rm_pkg</code>, Type: <code>bool</code>, Level: <code>G/C/A</code></p><p>Whether to uninstall all packages installed by <a href=#pg_packages><code>pg_packages</code></a> when cleaning up PGSQL instances, default is <code>true</code>.</p><p>If you only want to temporarily stop and preserve binaries, set it to <code>false</code>. Otherwise, <code>pg_remove</code> will call the system package manager to completely uninstall PostgreSQL-related components.</p><h3 id=pg_safeguard><code>pg_safeguard</code></h3><p>Parameter Name: <code>pg_safeguard</code>, Type: <code>bool</code>, Level: <code>G/C/A</code></p><p>Accidental deletion protection, default is <code>false</code>. When explicitly set to <code>true</code>, <code>pg_remove</code> will immediately terminate with a prompt, and will only continue after using <code>-e pg_safeguard=false</code> or disabling it in variables.</p><p>It&rsquo;s recommended to enable this switch before batch cleanup in production environments, verify the commands and target nodes are correct, then disable it to avoid accidental deletion of instances.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-091b9f18681382583303e1ac5c7cea55>15 - Playbook</h1><div class=lead>How to manage PostgreSQL clusters with Ansible playbooks</div><blockquote><p>Pigsty provides a series of playbooks for cluster provisioning, scaling, user/database management, monitoring, backup & recovery, and migration.</p></blockquote><table><thead><tr><th>Playbook</th><th>Function</th></tr></thead><tbody><tr><td><a href=#pgsqlyml><code>pgsql.yml</code></a></td><td>Initialize PostgreSQL cluster or add new replicas</td></tr><tr><td><a href=#pgsql-rmyml><code>pgsql-rm.yml</code></a></td><td>Remove PostgreSQL cluster or specific instances</td></tr><tr><td><a href=#pgsql-useryml><code>pgsql-user.yml</code></a></td><td>Add new business user to existing PostgreSQL cluster</td></tr><tr><td><a href=#pgsql-dbyml><code>pgsql-db.yml</code></a></td><td>Add new business database to existing PostgreSQL cluster</td></tr><tr><td><a href=#pgsql-monitoryml><code>pgsql-monitor.yml</code></a></td><td>Monitor remote PostgreSQL instances</td></tr><tr><td><a href=#pgsql-migrationyml><code>pgsql-migration.yml</code></a></td><td>Generate migration manual and scripts for existing PostgreSQL</td></tr><tr><td><a href=#pgsql-pitryml><code>pgsql-pitr.yml</code></a></td><td>Perform Point-In-Time Recovery (PITR)</td></tr></tbody></table><hr><h2 id=safeguard>Safeguard</h2><p>Be <strong>extra cautious</strong> when using <a href=/docs/pgsql><code>PGSQL</code></a> playbooks. Misuse of <a href=#pgsqlyml><code>pgsql.yml</code></a> and <a href=#pgsql-rmyml><code>pgsql-rm.yml</code></a> can lead to accidental database deletion!</p><ul><li>Always add the <code>-l</code> parameter to limit the execution scope, and ensure you&rsquo;re executing the right tasks on the right targets.</li><li>Limiting scope to a single cluster is recommended. Running <code>pgsql.yml</code> without parameters in production is a high-risk operation—think twice before proceeding.</li></ul><p>To prevent accidental deletion, Pigsty&rsquo;s PGSQL module provides a safeguard mechanism controlled by the <a href=/docs/pgsql/param#pg_safeguard><code>pg_safeguard</code></a> parameter.
When <code>pg_safeguard</code> is set to <code>true</code>, the <a href=#pgsql-rmyml><code>pgsql-rm.yml</code></a> playbook will abort immediately, protecting your database cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Will abort execution, protecting data</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Force override the safeguard via command line parameter</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span></code></pre></div><p>In addition to <code>pg_safeguard</code>, <a href=#pgsql-rmyml><code>pgsql-rm.yml</code></a> provides finer-grained control parameters:</p><table><thead><tr><th>Parameter</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/param#pg_safeguard><code>pg_safeguard</code></a></td><td><code>false</code></td><td>Safeguard switch; when <code>true</code>, playbook aborts</td></tr><tr><td><code>pg_rm_data</code></td><td><code>true</code></td><td>Whether to remove PostgreSQL data directory</td></tr><tr><td><code>pg_rm_backup</code></td><td><code>true</code></td><td>Whether to remove pgBackRest backup data (only when removing primary)</td></tr><tr><td><code>pg_rm_pkg</code></td><td><code>false</code></td><td>Whether to uninstall PostgreSQL packages</td></tr></tbody></table><p>These parameters allow precise control over removal behavior:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove cluster but keep data directory (only stop services)</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test -e <span style=color:#000>pg_rm_data</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove cluster but keep backup data</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove cluster and uninstall packages</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test -e <span style=color:#000>pg_rm_pkg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><hr><h2 id=pgsqlyml><code>pgsql.yml</code></h2><p>The <a href=https://github.com/pgsty/pigsty/blob/main/pgsql.yml><code>pgsql.yml</code></a> playbook is used to initialize PostgreSQL clusters or add new replicas.</p><p>Here&rsquo;s a demo of initializing a PostgreSQL cluster in the sandbox environment:</p><p><a href=https://asciinema.org/a/566417><img src=https://asciinema.org/a/566417.svg alt=asciicast></a></p><p><strong>Basic Usage</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta            <span style=color:#8f5902;font-style:italic># Initialize cluster pg-meta</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.13        <span style=color:#8f5902;font-style:italic># Initialize/add instance 10.10.10.13</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-test -t pg_service  <span style=color:#8f5902;font-style:italic># Refresh services for cluster pg-test</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-test -t pg_hba,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>  <span style=color:#8f5902;font-style:italic># Reload HBA rules</span>
</span></span></code></pre></div><p><strong>Wrapper Scripts</strong></p><p>Pigsty provides convenient wrapper scripts to simplify common operations:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-meta             <span style=color:#8f5902;font-style:italic># Initialize pgsql cluster pg-meta</span>
</span></span><span style=display:flex><span>bin/pgsql-add 10.10.10.10         <span style=color:#8f5902;font-style:italic># Initialize pgsql instance 10.10.10.10</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-test 10.10.10.13 <span style=color:#8f5902;font-style:italic># Add 10.10.10.13 to cluster pg-test (auto refresh services)</span>
</span></span><span style=display:flex><span>bin/pgsql-svc pg-test             <span style=color:#8f5902;font-style:italic># Refresh haproxy services for pg-test (use after membership changes)</span>
</span></span><span style=display:flex><span>bin/pgsql-hba pg-test             <span style=color:#8f5902;font-style:italic># Reload pg/pgb HBA rules for pg-test</span>
</span></span></code></pre></div><p><strong>Subtasks</strong></p><p>This playbook contains the following subtasks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_install              : install postgres packages &amp; extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_dbsu             : setup postgres superuser</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_dbsu_create    : create dbsu user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_dbsu_sudo      : configure dbsu sudo privileges</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_ssh            : exchange dbsu SSH keys</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_pkg              : install postgres packages</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_pre            : pre-installation tasks</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_ext            : install postgres extension packages</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_post           : post-installation tasks</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_link             : link pgsql version bin to /usr/pgsql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_path             : add pgsql bin to system path</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_dir              : create postgres directories and setup FHS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_bin              : sync /pg/bin scripts</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_alias            : configure pgsql/psql aliases</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_dummy            : create dummy placeholder file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_bootstrap            : bootstrap postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_config           : generate postgres config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_conf           : generate patroni config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_key            : generate pgsodium key</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_cert             : issue certificates for postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_cert_private   : check pg private key existence</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_cert_issue     : sign pg server certificate</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_cert_copy      : copy key &amp; certs to pg node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_launch           : launch patroni primary &amp; replicas</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_watchdog       : grant watchdog permission to postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_primary        : launch patroni/postgres primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_init           : init pg cluster with roles/templates</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_pass           : write .pgpass file to pg home</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_replica        : launch patroni/postgres replicas</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_hba            : generate pg HBA rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - patroni_reload    : reload patroni config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_patroni        : pause or remove patroni if necessary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_provision            : provision postgres business users &amp; databases</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_user             : provision postgres business users</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_user_config    : render create user SQL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_user_create    : create user on postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_db               : provision postgres business databases</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_db_drop        : drop database on postgres (state=absent/recreate)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_db_config      : render create database SQL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_db_create      : create database on postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_backup               : init postgres PITR backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbackrest          : setup pgbackrest for backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbackrest_config : generate pgbackrest config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbackrest_init   : init pgbackrest repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbackrest_backup : make initial backup after bootstrap</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_access               : init postgres service access layer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbouncer           : deploy pgbouncer connection pooler</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbouncer_dir     : create pgbouncer directories</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbouncer_config  : generate pgbouncer config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#       - pgbouncer_hba   : generate pgbouncer HBA config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#       - pgbouncer_user  : generate pgbouncer userlist</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbouncer_launch  : launch pgbouncer service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbouncer_reload  : reload pgbouncer config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_vip              : bind VIP to primary with vip-manager</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_vip_config     : generate vip-manager config</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_vip_launch     : launch vip-manager to bind VIP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_dns              : register DNS name to infra dnsmasq</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_dns_ins        : register pg instance name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_dns_cls        : register pg cluster name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_service          : expose pgsql service with haproxy</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_service_config : generate local haproxy config for pg services</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_service_reload : expose postgres services with haproxy</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_monitor              : setup pgsql monitoring and register to infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_exporter         : configure and launch pg_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbouncer_exporter  : configure and launch pgbouncer_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbackrest_exporter : configure and launch pgbackrest_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_register         : register pgsql to monitoring/logging/datasource</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - add_metrics       : register pg as VictoriaMetrics monitoring target</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - add_logs          : register pg as Vector log source</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - add_ds            : register pg database as Grafana datasource</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Related Administration Tasks</strong></p><ul><li><a href=/docs/pgsql/admin#create-cluster>Create Cluster</a></li><li><a href=/docs/pgsql/admin#add-instance>Add Instance</a></li><li><a href=/docs/pgsql/admin#reload-service>Reload Service</a></li><li><a href=/docs/pgsql/admin#reload-hba>Reload HBA</a></li></ul><p><strong>Notes</strong></p><ul><li>When running this playbook on a single replica, ensure the <strong>cluster primary is already initialized!</strong></li><li>After scaling out, you need to <a href=/docs/pgsql/admin#reload-service>Reload Service</a> and <a href=/docs/pgsql/admin#reload-hba>Reload HBA</a>. The wrapper script <code>bin/pgsql-add</code> handles these tasks automatically.</li></ul><p>When scaling a cluster, if Patroni takes too long to bring up a replica, the Ansible playbook may abort due to timeout:</p><ul><li>Typical error message: <code>wait for postgres/patroni replica</code> task runs for a long time before aborting</li><li>However, the replica creation process continues. For scenarios where replica creation takes more than a day, see <a href=/docs/pgsql/faq>FAQ</a>: Replica creation failed.</li></ul><hr><h2 id=pgsql-rmyml><code>pgsql-rm.yml</code></h2><p>The <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-rm.yml><code>pgsql-rm.yml</code></a> playbook is used to remove PostgreSQL clusters or specific instances.</p><p>Here&rsquo;s a demo of removing a PostgreSQL cluster in the sandbox environment:</p><p><a href=https://asciinema.org/a/566418><img src=https://asciinema.org/a/566418.svg alt=asciicast></a></p><p><strong>Basic Usage</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l pg-test          <span style=color:#8f5902;font-style:italic># Remove cluster pg-test</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l 10.10.10.13      <span style=color:#8f5902;font-style:italic># Remove instance 10.10.10.13</span>
</span></span></code></pre></div><p><strong>Command Line Arguments</strong></p><p>This playbook supports the following command line arguments:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l pg-test          <span style=color:#8f5902;font-style:italic># Remove cluster pg-test</span>
</span></span><span style=display:flex><span>    -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>          <span style=color:#8f5902;font-style:italic># Safeguard switch, disabled by default; override when enabled</span>
</span></span><span style=display:flex><span>    -e <span style=color:#000>pg_rm_data</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>             <span style=color:#8f5902;font-style:italic># Whether to remove PostgreSQL data directory, default: remove</span>
</span></span><span style=display:flex><span>    -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>           <span style=color:#8f5902;font-style:italic># Whether to remove pgBackRest backup (primary only), default: remove</span>
</span></span><span style=display:flex><span>    -e <span style=color:#000>pg_rm_pkg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>             <span style=color:#8f5902;font-style:italic># Whether to uninstall PostgreSQL packages, default: keep</span>
</span></span></code></pre></div><p><strong>Wrapper Scripts</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-meta               <span style=color:#8f5902;font-style:italic># Remove pgsql cluster pg-meta</span>
</span></span><span style=display:flex><span>bin/pgsql-rm pg-test 10.10.10.13   <span style=color:#8f5902;font-style:italic># Remove instance 10.10.10.13 from cluster pg-test</span>
</span></span></code></pre></div><p><strong>Subtasks</strong></p><p>This playbook contains the following subtasks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_safeguard           : abort if pg_safeguard is enabled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_monitor             : remove registration from monitoring system</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_deregister      : remove pg monitoring targets from infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - rm_metrics       : remove monitoring targets from prometheus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - rm_ds            : remove datasource from grafana</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - rm_logs          : remove log targets from vector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_exporter        : remove pg_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbouncer_exporter : remove pgbouncer_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbackrest_exporter: remove pgbackrest_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_access              : remove pg service access layer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - dns                : remove pg DNS records</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - vip                : remove vip-manager</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_service         : remove pg service from haproxy</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbouncer          : remove pgbouncer connection middleware</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># postgres               : remove postgres instances</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_replica         : remove all replicas</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_primary         : remove primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_meta            : remove metadata from etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_backup              : remove backup repo (disable with pg_rm_backup=false)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_data                : remove postgres data (disable with pg_rm_data=false)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_pkg                 : uninstall pg packages (enable with pg_rm_pkg=true)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_ext             : uninstall postgres extensions alone</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Related Administration Tasks</strong></p><ul><li><a href=/docs/pgsql/admin#remove-instance>Remove Instance</a></li><li><a href=/docs/pgsql/admin#remove-cluster>Remove Cluster</a></li></ul><p><strong>Notes</strong></p><ul><li><strong>Do not run this playbook on a primary that still has replicas</strong>—otherwise, remaining replicas will trigger automatic failover. Always remove all replicas first, then remove the primary. This is not a concern when removing the entire cluster at once.</li><li><strong>Refresh cluster services after removing instances</strong>. When you remove a replica from a cluster, it remains in the load balancer configuration file. Since health checks will fail, the removed instance won&rsquo;t affect cluster services. However, you should <a href=/docs/pgsql/admin#reload-service>Reload Service</a> at an appropriate time to ensure consistency between the production environment and configuration inventory.</li></ul><hr><h2 id=pgsql-useryml><code>pgsql-user.yml</code></h2><p>The <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-user.yml><code>pgsql-user.yml</code></a> playbook is used to add new business users to existing PostgreSQL clusters.</p><p><strong>Basic Usage</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l pg-meta -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_meta
</span></span></code></pre></div><p><strong>Wrapper Scripts</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_meta  <span style=color:#8f5902;font-style:italic># Create user dbuser_meta on cluster pg-meta</span>
</span></span></code></pre></div><p><strong>Workflow</strong></p><ol><li>Define user in the config inventory: <code>all.children.&lt;pg_cluster>.vars.pg_users[i]</code></li><li>Execute playbook specifying cluster and username: <code>pgsql-user.yml -l &lt;pg_cluster> -e username=&lt;name></code></li></ol><p>The playbook will:</p><ol><li>Generate user creation SQL at <code>/pg/tmp/pg-user-{{ user.name }}.sql</code></li><li>Execute user creation/update SQL on the cluster primary</li><li>Update <code>/etc/pgbouncer/userlist.txt</code> and <code>useropts.txt</code></li><li>Reload pgbouncer to apply configuration</li></ol><p><strong>User Definition Example</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Required, username is the only mandatory field</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, can be scram-sha-256 hash or plaintext</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>login: true                     # Optional, can login, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>superuser: false                # Optional, is superuser, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>createdb: false                 # Optional, can create database, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>createrole: false               # Optional, can create role, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>inherit: true                   # Optional, inherit privileges, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>replication: false              # Optional, can replicate, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bypassrls: false                # Optional, bypass RLS, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer: true                 # Optional, add to pgbouncer userlist, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, connection limit, -1 means unlimited</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, expire in N days (overrides expire_at)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Optional, specify expiration date</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, user comment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, roles to grant</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># Optional, role-level parameters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, pgbouncer user-level pool mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Optional, user-level max connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For details, see: <a href=/docs/pgsql/admin#create-user>Admin SOP: Create User</a></p><hr><h2 id=pgsql-dbyml><code>pgsql-db.yml</code></h2><p>The <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-db.yml><code>pgsql-db.yml</code></a> playbook is used to add new business databases to existing PostgreSQL clusters.</p><p><strong>Basic Usage</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l pg-meta -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>meta
</span></span></code></pre></div><p><strong>Wrapper Scripts</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta meta  <span style=color:#8f5902;font-style:italic># Create database meta on cluster pg-meta</span>
</span></span></code></pre></div><p><strong>Workflow</strong></p><ol><li>Define database in the config inventory: <code>all.children.&lt;pg_cluster>.vars.pg_databases[i]</code></li><li>Execute playbook specifying cluster and database name: <code>pgsql-db.yml -l &lt;pg_cluster> -e dbname=&lt;name></code></li></ol><p>The playbook will:</p><ol><li>Generate database creation SQL at <code>/pg/tmp/pg-db-{{ database.name }}.sql</code></li><li>Execute database creation/update SQL on the cluster primary</li><li>If <code>db.register_datasource</code> is true, register database as Grafana datasource</li><li>Update <code>/etc/pgbouncer/database.txt</code> and reload pgbouncer</li></ol><p><strong>Database Definition Example</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Required, database name is the only mandatory field</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, database initialization SQL file path</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer: true                 # Optional, add to pgbouncer, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, additional schemas to create</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Optional, extensions to install</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, database comment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, database owner</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, template database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, character encoding</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, locale setting</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, default tablespace</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, allow connections</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Optional, revoke public connect privilege</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Optional, register as Grafana datasource</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, connection limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, pgbouncer pool mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, pgbouncer pool size</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Optional, pgbouncer reserve pool size</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For details, see: <a href=/docs/pgsql/admin#create-database>Admin SOP: Create Database</a></p><hr><h2 id=pgsql-monitoryml><code>pgsql-monitor.yml</code></h2><p>The <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-monitor.yml><code>pgsql-monitor.yml</code></a> playbook is used to bring remote PostgreSQL instances into Pigsty&rsquo;s monitoring system.</p><p><strong>Basic Usage</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-monitor.yml -e <span style=color:#000>clsname</span><span style=color:#ce5c00;font-weight:700>=</span>pg-foo  <span style=color:#8f5902;font-style:italic># Monitor remote cluster pg-foo</span>
</span></span></code></pre></div><p><strong>Wrapper Scripts</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-add pg-foo              <span style=color:#8f5902;font-style:italic># Monitor a remote pgsql cluster pg-foo</span>
</span></span><span style=display:flex><span>bin/pgmon-add pg-foo pg-bar       <span style=color:#8f5902;font-style:italic># Monitor multiple clusters simultaneously</span>
</span></span></code></pre></div><p><strong>Configuration</strong></p><p>First, define <code>pg_exporters</code> in the <code>infra</code> group variables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_exporters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># List all remote instances, assign unique unused local ports</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>20001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 1, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>20002</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 2, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Architecture Diagram</strong></p><pre tabindex=0><code>     ------ infra ------
     |                 |
     |   prometheus    |            v---- pg-foo-1 ----v
     |       ^         |  metrics   |         ^        |
     |   pg_exporter &lt;-|------------|----  postgres    |
     |   (port: 20001) |            | 10.10.10.10:5432 |
     |       ^         |            ^------------------^
     |       ^         |                      ^
     |       ^         |            v---- pg-foo-2 ----v
     |       ^         |  metrics   |         ^        |
     |   pg_exporter &lt;-|------------|----  postgres    |
     |   (port: 20002) |            | 10.10.10.11:5433 |
     -------------------            ^------------------^
</code></pre><p><strong>Configurable Parameters</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_exporter.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg_exporter config file name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_cache_ttls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;1,10,60,300&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># pg_exporter collector TTL stages</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># pg_exporter listen port</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_params</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslmode=disable&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># DSN extra URL parameters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># Directly override auto-generated DSN</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Enable auto database discovery</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_exclude_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;template0,template1,postgres&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Databases to exclude</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Databases to include only</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_connect_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Connection timeout (milliseconds)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Monitor username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Monitor password</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Remote Database Setup</strong></p><p>Remote PostgreSQL instances need a monitoring user:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;system monitor user&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#000>PASSWORD</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;DBUser.Monitor&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg_stat_statements&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;monitor&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Limitations</strong></p><ul><li>Only postgres metrics available</li><li>node, pgbouncer, patroni, haproxy metrics not available</li></ul><p>For details, see: <a href=/docs/pgsql/monitor#monitor-rds>Admin SOP: Monitor RDS</a></p><hr><h2 id=pgsql-migrationyml><code>pgsql-migration.yml</code></h2><p>The <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-migration.yml><code>pgsql-migration.yml</code></a> playbook generates migration manuals and scripts for zero-downtime logical replication-based migration of existing PostgreSQL clusters.</p><p><strong>Basic Usage</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-migration.yml -e@files/migration/pg-meta.yml
</span></span></code></pre></div><p><strong>Workflow</strong></p><ol><li>Define migration task configuration file (e.g., <code>files/migration/pg-meta.yml</code>)</li><li>Execute playbook to generate migration manual and scripts</li><li>Follow the manual to execute scripts step by step for migration</li></ol><p><strong>Migration Task Definition Example</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># files/migration/pg-meta.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>context_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~/migration          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Migration manual and scripts output directory</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_cls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Source cluster name (required)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Source database name (required)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Source cluster primary IP (required)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_cls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Target cluster name (required)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Target database name (required)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Target cluster primary IP (required)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Optional parameters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For details, see: <a href=/docs/pgsql/migration/>Admin SOP: Migrate Cluster</a></p><hr><h2 id=pgsql-pitryml><code>pgsql-pitr.yml</code></h2><p>The <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-pitr.yml><code>pgsql-pitr.yml</code></a> playbook performs PostgreSQL Point-In-Time Recovery (PITR).</p><p><strong>Basic Usage</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recover to latest state (end of WAL archive stream)</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recover to specific point in time</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;time&#34;: &#34;2025-07-13 10:00:00+00&#34;}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recover to specific LSN</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;lsn&#34;: &#34;0/4001C80&#34;}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recover to specific transaction ID</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;xid&#34;: &#34;250000&#34;}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recover to named restore point</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;name&#34;: &#34;some_restore_point&#34;}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recover from another cluster&#39;s backup</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;cluster&#34;: &#34;pg-meta&#34;}}&#39;</span>
</span></span></code></pre></div><p><strong>PITR Task Parameters</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># Define PITR task</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg-meta&#34;</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Source cluster name (for restoring from another cluster&#39;s backup)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>type: latest                     # Recovery target type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time, xid, name, lsn, immediate, latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-01 10:00:00+00&#34;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Recovery target: point in time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Recovery target: named restore point</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;100000&#34;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># Recovery target: transaction ID</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;0/3000000&#34;</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Recovery target: log sequence number</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>set: latest                      # Backup set to restore from, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>timeline: latest                 # Target timeline, can be integer, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>exclusive: false                 # Exclude target point, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>action: pause                    # Post-recovery action</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pause, promote, shutdown</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>archive: false                   # Keep archive settings, default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup: false                    # Backup existing data to /pg/data-backup before restore? default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db_include</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Include only these databases</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db_exclude</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Exclude these databases</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>link_map</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Tablespace link mapping</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>process</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># Parallel recovery processes</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># Recovery source repo configuration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/data                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Recovery data directory</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># Recovery instance listen port</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Subtasks</strong></p><p>This playbook contains the following subtasks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># down                 : stop HA and shutdown patroni and postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pause            : pause patroni auto failover</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - stop             : stop patroni and postgres services</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_patroni   : stop patroni service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_postgres  : stop postgres service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pitr                 : execute PITR recovery process</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - config           : generate pgbackrest config and recovery script</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - backup           : perform optional backup to original data</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - restore          : run pgbackrest restore command</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - recovery         : start postgres and complete recovery</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - verify           : verify recovered cluster control data</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># up                   : start postgres/patroni and restore HA</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - etcd             : clean etcd metadata before startup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - start            : start patroni and postgres services</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_postgres : start postgres service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_patroni  : start patroni service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - resume           : resume patroni auto failover</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Recovery Target Types</strong></p><table><thead><tr><th>Type</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td><code>latest</code></td><td>Recover to end of WAL archive stream (latest state)</td><td><code>{"pg_pitr": {}}</code></td></tr><tr><td><code>time</code></td><td>Recover to specific point in time</td><td><code>{"pg_pitr": {"time": "2025-07-13 10:00:00"}}</code></td></tr><tr><td><code>xid</code></td><td>Recover to specific transaction ID</td><td><code>{"pg_pitr": {"xid": "250000"}}</code></td></tr><tr><td><code>name</code></td><td>Recover to named restore point</td><td><code>{"pg_pitr": {"name": "before_ddl"}}</code></td></tr><tr><td><code>lsn</code></td><td>Recover to specific LSN</td><td><code>{"pg_pitr": {"lsn": "0/4001C80"}}</code></td></tr><tr><td><code>immediate</code></td><td>Stop immediately after reaching consistent state</td><td><code>{"pg_pitr": {"type": "immediate"}}</code></td></tr></tbody></table><p>For details, see: <a href=/docs/pgsql/backup/restore/>Backup & Recovery Tutorial</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f11dbaecba8ffad62c75360642541598>16 - Extensions</h1><div class=lead>Harness the synergistic power of PostgreSQL extensions</div><p>Pigsty provides <a href=https://pgext.cloud/list><strong>440+</strong> extensions</a>, covering 16 major categories including time-series, geospatial, vector, full-text search, analytics, and feature enhancements, ready to use out-of-the-box.</p><p>Using extensions in Pigsty involves four core steps: <a href=download><strong>Download</strong></a>, <a href=install><strong>Install</strong></a>, <a href=config><strong>Config/Load</strong></a>, and <a href=create><strong>Create</strong></a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions: [ postgis, timescaledb, vector ]   # Create</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Create extensions in database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs: &#39;timescaledb, pg_stat_statements, auto_explain&#39; # Config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Preload extension libraries</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions: [ postgis, timescaledb, pgvector ]  # Install</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Install extension packages</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><img src=/img/pigsty/ecosystem.gif alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-cb575384aee4c018fb0db527378640fd>16.1 - Quick Start</h1><div class=lead>Four-step process overview for using extensions</div><p>Using extensions in Pigsty requires four steps: <strong>Download</strong>, <strong>Install</strong>, <strong>Config</strong>, and <strong>Create</strong>.</p><ol><li><strong>Download</strong>: Download extension packages to the local repository (Pigsty has already downloaded mainstream extensions by default)</li><li><strong>Install</strong>: Install extension packages on cluster nodes</li><li><strong>Config</strong>: Some extensions need to be preloaded or configured with parameters</li><li><strong>Create</strong>: Execute <code>CREATE EXTENSION</code> in the database to create the extension</li></ol><hr><h2 id=declarative-configuration>Declarative Configuration</h2><p>Declare extensions in the Pigsty configuration manifest, and they will be automatically installed and created during cluster initialization:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, vector ]  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Create extensions in database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Preload extension libraries</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Install extension packages</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>After executing <code>./pgsql.yml</code> to initialize the cluster, the three extensions <code>postgis</code>, <code>timescaledb</code>, and <code>vector</code> will be available in the <code>meta</code> database.</p><hr><h2 id=imperative-operations>Imperative Operations</h2><p>For existing clusters, you can add extensions using command-line methods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Install extension packages</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_extension -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;:[&#34;pgvector&#34;]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Preload extension (if needed, requires restart after modification)</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. Create extension in database</span>
</span></span><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION vector;&#39;</span>
</span></span></code></pre></div><p>You can also use the <a href=https://pgext.cloud/pig>pig</a> package manager to install directly:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig install pgvector        <span style=color:#8f5902;font-style:italic># Install extension package</span>
</span></span><span style=display:flex><span>pig extension create vector  <span style=color:#8f5902;font-style:italic># Create extension in database</span>
</span></span></code></pre></div><hr><h2 id=process-quick-reference>Process Quick Reference</h2><table><thead><tr><th style=text-align:center>Step</th><th style=text-align:left>Parameter/Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center>Download</td><td style=text-align:left><a href=/docs/infra/param#repo_extra_packages><code>repo_extra_packages</code></a></td><td style=text-align:left>Specify extension packages to download to local repository</td></tr><tr><td style=text-align:center>Install</td><td style=text-align:left><a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a></td><td style=text-align:left>Specify extension packages to install on cluster</td></tr><tr><td style=text-align:center>Config</td><td style=text-align:left><a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a></td><td style=text-align:left>Preload extensions to <code>shared_preload_libraries</code></td></tr><tr><td style=text-align:center>Create</td><td style=text-align:left><a href=/docs/pgsql/config/db><code>pg_databases.extensions</code></a></td><td style=text-align:left>Automatically execute <code>CREATE EXTENSION</code> in database</td></tr></tbody></table><blockquote><p>For detailed instructions, please refer to each subsection: <a href=download>Download</a>, <a href=install>Install</a>, <a href=config>Config</a>, <a href=create>Create</a></p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-37c08dbc246cb158947abfb17f172ecc>16.2 - Introduction</h1><div class=lead>Core concepts of PostgreSQL extensions and the Pigsty extension ecosystem</div><p>Extensions are the soul of PostgreSQL. Pigsty includes 440+ pre-compiled, out-of-the-box extension plugins, fully unleashing PostgreSQL&rsquo;s potential.</p><hr><h2 id=what-are-extensions>What are Extensions</h2><p>PostgreSQL extensions are a modular mechanism that allows enhancing database functionality without modifying the core code.
An extension typically consists of three parts:</p><ul><li><strong>Control file</strong> (<code>.control</code>): Required, contains extension metadata</li><li><strong>SQL scripts</strong> (<code>.sql</code>): Optional, defines functions, types, operators, and other database objects</li><li><strong>Dynamic library</strong> (<code>.so</code>): Optional, provides high-performance functionality implemented in C</li></ul><p>Extensions can add to PostgreSQL: new data types, index methods, functions and operators, foreign data access, procedural languages, performance monitoring, security auditing, and more.</p><hr><h2 id=core-extensions>Core Extensions</h2><p>Among the extensions included in Pigsty, the following are most representative:</p><table><thead><tr><th style=text-align:left>Extension</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=https://postgis.net/><strong>PostGIS</strong></a></td><td style=text-align:left>Geospatial data types and indexes, de facto GIS standard</td></tr><tr><td style=text-align:left><a href=https://www.timescale.com/><strong>TimescaleDB</strong></a></td><td style=text-align:left>Time-series database with continuous aggregates, columnar storage, auto-compression</td></tr><tr><td style=text-align:left><a href=https://github.com/pgvector/pgvector><strong>PGVector</strong></a></td><td style=text-align:left>Vector data type with HNSW/IVFFlat indexes, essential for AI applications</td></tr><tr><td style=text-align:left><a href=https://www.citusdata.com/><strong>Citus</strong></a></td><td style=text-align:left>Distributed database with horizontal sharding capabilities</td></tr><tr><td style=text-align:left><a href=https://github.com/duckdb/pg_duckdb><strong>pg_duckdb</strong></a></td><td style=text-align:left>Embedded DuckDB analytical engine for OLAP acceleration</td></tr><tr><td style=text-align:left><a href=https://www.paradedb.com/><strong>ParadeDB</strong></a></td><td style=text-align:left>ElasticSearch-level full-text search capabilities</td></tr><tr><td style=text-align:left><a href=https://age.apache.org/><strong>Apache AGE</strong></a></td><td style=text-align:left>Graph database supporting OpenCypher query language</td></tr><tr><td style=text-align:left><a href=https://github.com/supabase/pg_graphql><strong>pg_graphql</strong></a></td><td style=text-align:left>Native GraphQL query support</td></tr></tbody></table><p>Most extensions can coexist and even be combined, creating synergistic effects far greater than the sum of their parts.</p><hr><h2 id=extension-categories>Extension Categories</h2><p>Pigsty organizes extensions into 16 categories:</p><table><thead><tr><th style=text-align:center>Category</th><th style=text-align:left>Alias</th><th style=text-align:left>Description</th><th style=text-align:left>Typical Extensions</th></tr></thead><tbody><tr><td style=text-align:center>Time-series</td><td style=text-align:left><code>time</code></td><td style=text-align:left>Time-series data processing</td><td style=text-align:left>timescaledb, pg_cron, periods</td></tr><tr><td style=text-align:center>Geospatial</td><td style=text-align:left><code>gis</code></td><td style=text-align:left>Geospatial data</td><td style=text-align:left>postgis, h3, pgrouting</td></tr><tr><td style=text-align:center>Vector</td><td style=text-align:left><code>rag</code></td><td style=text-align:left>Vector retrieval and AI</td><td style=text-align:left>pgvector, vchord, pg_vectorize</td></tr><tr><td style=text-align:center>Search</td><td style=text-align:left><code>fts</code></td><td style=text-align:left>Full-text search</td><td style=text-align:left>pgroonga, zhparser, pg_bigm</td></tr><tr><td style=text-align:center>Analytics</td><td style=text-align:left><code>olap</code></td><td style=text-align:left>OLAP and analytics</td><td style=text-align:left>pg_duckdb, pg_mooncake, citus</td></tr><tr><td style=text-align:center>Feature</td><td style=text-align:left><code>feat</code></td><td style=text-align:left>Feature enhancements</td><td style=text-align:left>age, pg_graphql, hll, rum</td></tr><tr><td style=text-align:center>Language</td><td style=text-align:left><code>lang</code></td><td style=text-align:left>Procedural languages</td><td style=text-align:left>plpython3u, pljava, plv8</td></tr><tr><td style=text-align:center>Type</td><td style=text-align:left><code>type</code></td><td style=text-align:left>Data types</td><td style=text-align:left>hstore, ltree, ip4r</td></tr><tr><td style=text-align:center>Utility</td><td style=text-align:left><code>util</code></td><td style=text-align:left>Utility tools</td><td style=text-align:left>http, pg_net, pgjwt</td></tr><tr><td style=text-align:center>Function</td><td style=text-align:left><code>func</code></td><td style=text-align:left>Function libraries</td><td style=text-align:left>pg_uuidv7, topn, tdigest</td></tr><tr><td style=text-align:center>Admin</td><td style=text-align:left><code>admin</code></td><td style=text-align:left>Operations management</td><td style=text-align:left>pg_repack, pg_squeeze, pgagent</td></tr><tr><td style=text-align:center>Stat</td><td style=text-align:left><code>stat</code></td><td style=text-align:left>Monitoring statistics</td><td style=text-align:left>pg_stat_statements, pg_qualstats, auto_explain</td></tr><tr><td style=text-align:center>Security</td><td style=text-align:left><code>sec</code></td><td style=text-align:left>Security auditing</td><td style=text-align:left>pgaudit, pgsodium, pg_tde</td></tr><tr><td style=text-align:center>FDW</td><td style=text-align:left><code>fdw</code></td><td style=text-align:left>Foreign data access</td><td style=text-align:left>postgres_fdw, mysql_fdw, oracle_fdw</td></tr><tr><td style=text-align:center>Compatibility</td><td style=text-align:left><code>sim</code></td><td style=text-align:left>Database compatibility</td><td style=text-align:left>orafce, babelfish</td></tr><tr><td style=text-align:center>ETL</td><td style=text-align:left><code>etl</code></td><td style=text-align:left>Data synchronization</td><td style=text-align:left>pglogical, wal2json, decoderbufs</td></tr></tbody></table><p>You can batch install an entire category of extensions using category aliases, for example: <code>pg_extensions: [ pgsql-gis, pgsql-rag ]</code>.</p><hr><h2 id=predefined-extension-stacks>Predefined Extension Stacks</h2><p>Pigsty provides several predefined extension stacks for convenient scenario-based selection:</p><table><thead><tr><th style=text-align:left>Stack</th><th style=text-align:left>Included Extensions</th></tr></thead><tbody><tr><td style=text-align:left><code>gis-stack</code></td><td style=text-align:left>postgis, pgrouting, pointcloud, h3, q3c, ogr_fdw</td></tr><tr><td style=text-align:left><code>rag-stack</code></td><td style=text-align:left>pgvector, vchord, pgvectorscale, pg_similarity, pg_tiktoken</td></tr><tr><td style=text-align:left><code>fts-stack</code></td><td style=text-align:left>pgroonga, pg_bigm, zhparser, hunspell</td></tr><tr><td style=text-align:left><code>olap-stack</code></td><td style=text-align:left>pg_duckdb, pg_mooncake, timescaledb, pg_partman, plproxy</td></tr><tr><td style=text-align:left><code>feat-stack</code></td><td style=text-align:left>age, hll, rum, pg_graphql, pg_jsonschema, jsquery</td></tr><tr><td style=text-align:left><code>stat-stack</code></td><td style=text-align:left>pg_show_plans, pg_stat_kcache, pg_qualstats, pg_wait_sampling</td></tr><tr><td style=text-align:left><code>supa-stack</code></td><td style=text-align:left>pg_graphql, pg_jsonschema, wrappers, pgvector, pgsodium, vault</td></tr></tbody></table><p>Simply use these names in <code>pg_extensions</code> to install the entire stack.</p><hr><h2 id=extension-resources>Extension Resources</h2><ul><li><a href=https://pgext.cloud/list><strong>Extension Catalog</strong></a>: Browse detailed information about all available extensions</li><li><a href=https://pgext.cloud/repo/><strong>Extension Repository</strong></a>: Pigsty extension software repository</li><li><a href=https://pgext.cloud/pig><strong>pig Package Manager</strong></a>: Command-line extension management tool</li><li><a href=https://github.com/pgsty/pigsty><strong>GitHub Pigsty</strong></a>: Pigsty source code repository</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6c21bc6ef6cf2173aeb9948071de953f>16.3 - Packages</h1><div class=lead>Extension package aliases and category naming conventions</div><p>Pigsty uses a <strong>package alias</strong> mechanism to simplify extension installation and management.</p><hr><h2 id=package-alias-mechanism>Package Alias Mechanism</h2><p>Managing extensions involves multiple layers of name mapping:</p><table><thead><tr><th style=text-align:left>Layer</th><th style=text-align:left>Example <code>pgvector</code></th><th style=text-align:left>Example <code>postgis</code></th></tr></thead><tbody><tr><td style=text-align:left>Extension Name</td><td style=text-align:left><code>vector</code></td><td style=text-align:left><code>postgis</code>, <code>postgis_topology</code>, &mldr;</td></tr><tr><td style=text-align:left>Package Alias</td><td style=text-align:left><code>pgvector</code></td><td style=text-align:left><code>postgis</code></td></tr><tr><td style=text-align:left>RPM Package Name</td><td style=text-align:left><code>pgvector_18</code></td><td style=text-align:left><code>postgis36_18*</code></td></tr><tr><td style=text-align:left>DEB Package Name</td><td style=text-align:left><code>postgresql-18-pgvector</code></td><td style=text-align:left><code>postgresql-18-postgis-3*</code></td></tr></tbody></table><p>Pigsty provides a <strong>package alias</strong> abstraction layer, so users don&rsquo;t need to worry about specific RPM/DEB package names:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, postgis, timescaledb ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use package aliases</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty automatically translates to the correct package names based on the operating system and PostgreSQL version.</p><blockquote><p>Note: When using <code>CREATE EXTENSION</code>, you use the <strong>extension name</strong> (e.g., <code>vector</code>), not the package alias (<code>pgvector</code>).</p></blockquote><hr><h2 id=category-aliases>Category Aliases</h2><p>All extensions are organized into 16 categories, which can be batch installed using category aliases:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use generic category aliases (auto-adapt to current PG version)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-gis, pgsql-rag, pgsql-fts ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Or use version-specific category aliases</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pg18-gis, pg18-rag, pg18-fts ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Except for the <code>olap</code> category, all category extensions can be installed simultaneously. Within the <code>olap</code> category, there are conflicts: <code>pg_duckdb</code> and <code>pg_mooncake</code> are mutually exclusive.</p><hr><h2 id=category-list>Category List</h2><table><thead><tr><th style=text-align:center>Category</th><th style=text-align:left>Description</th><th style=text-align:left>Typical Extensions</th></tr></thead><tbody><tr><td style=text-align:center><code>time</code></td><td style=text-align:left>Time-series</td><td style=text-align:left>timescaledb, pg_cron, periods</td></tr><tr><td style=text-align:center><code>gis</code></td><td style=text-align:left>Geospatial</td><td style=text-align:left>postgis, h3, pgrouting</td></tr><tr><td style=text-align:center><code>rag</code></td><td style=text-align:left>Vector/RAG</td><td style=text-align:left>pgvector, pgml, vchord</td></tr><tr><td style=text-align:center><code>fts</code></td><td style=text-align:left>Full-text Search</td><td style=text-align:left>pg_trgm, zhparser, pgroonga</td></tr><tr><td style=text-align:center><code>olap</code></td><td style=text-align:left>Analytics</td><td style=text-align:left>citus, pg_duckdb, pg_analytics</td></tr><tr><td style=text-align:center><code>feat</code></td><td style=text-align:left>Feature</td><td style=text-align:left>age, pg_graphql, rum</td></tr><tr><td style=text-align:center><code>lang</code></td><td style=text-align:left>Language</td><td style=text-align:left>plpython3u, pljava, plv8</td></tr><tr><td style=text-align:center><code>type</code></td><td style=text-align:left>Data Type</td><td style=text-align:left>hstore, ltree, citext</td></tr><tr><td style=text-align:center><code>util</code></td><td style=text-align:left>Utility</td><td style=text-align:left>http, pg_net, pgjwt</td></tr><tr><td style=text-align:center><code>func</code></td><td style=text-align:left>Function</td><td style=text-align:left>pgcrypto, uuid-ossp, pg_uuidv7</td></tr><tr><td style=text-align:center><code>admin</code></td><td style=text-align:left>Admin</td><td style=text-align:left>pg_repack, pgagent, pg_squeeze</td></tr><tr><td style=text-align:center><code>stat</code></td><td style=text-align:left>Statistics</td><td style=text-align:left>pg_stat_statements, pg_qualstats, auto_explain</td></tr><tr><td style=text-align:center><code>sec</code></td><td style=text-align:left>Security</td><td style=text-align:left>pgaudit, pgcrypto, pgsodium</td></tr><tr><td style=text-align:center><code>fdw</code></td><td style=text-align:left>Foreign Data Wrapper</td><td style=text-align:left>postgres_fdw, mysql_fdw, oracle_fdw</td></tr><tr><td style=text-align:center><code>sim</code></td><td style=text-align:left>Compatibility</td><td style=text-align:left>orafce, babelfishpg_tds</td></tr><tr><td style=text-align:center><code>etl</code></td><td style=text-align:left>Data/ETL</td><td style=text-align:left>pglogical, wal2json, decoderbufs</td></tr></tbody></table><hr><h2 id=browse-extension-catalog>Browse Extension Catalog</h2><p>You can browse detailed information about all available extensions on the <a href=https://pgext.cloud/list>Pigsty Extension Catalog</a> website, including:</p><ul><li>Extension name, description, version</li><li>Supported PostgreSQL versions</li><li>Supported OS distributions</li><li>Installation methods, preloading requirements</li><li>License, source repository</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-96a6a67c2f3d2429fabeed6f98b76c7f>16.4 - Download</h1><div class=lead>Download extension packages from software repositories to local</div><p>Before installing extensions, ensure that extension packages are downloaded to the local repository or available from upstream.</p><hr><h2 id=default-behavior>Default Behavior</h2><p>Pigsty automatically downloads mainstream extensions available for the default PostgreSQL version to the local software repository during installation.</p><p>Benefits of using a local repository:</p><ul><li>Accelerated installation, avoiding repeated downloads</li><li>Reduced network traffic consumption</li><li>Improved delivery reliability</li><li>Ensured version consistency</li></ul><hr><h2 id=download-new-extensions>Download New Extensions</h2><p>To download additional extensions, add them to <a href=/docs/infra/param#repo_extra_packages><code>repo_extra_packages</code></a> and rebuild the repository:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>repo_extra_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, postgis, timescaledb, pg_duckdb ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Re-download packages to local repository</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Refresh package source cache on all nodes</span>
</span></span><span style=display:flex><span>./node.yml -t node_repo
</span></span></code></pre></div><hr><h2 id=using-upstream-repositories>Using Upstream Repositories</h2><p>You can also install directly from internet upstream repositories without pre-downloading:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Add upstream software sources on nodes</span>
</span></span><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql
</span></span></code></pre></div><p>This approach is suitable for:</p><ul><li>Quick testing of latest versions</li><li>Installing rare extensions</li><li>Environments with good network conditions</li></ul><p>But may face:</p><ul><li>Network instability affecting installation</li><li>Version inconsistency risks</li></ul><hr><h2 id=extension-sources>Extension Sources</h2><p>Extension packages come from two main sources:</p><table><thead><tr><th style=text-align:left>Repository</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><strong>PGDG</strong></td><td style=text-align:left>PostgreSQL official repository, providing core extensions</td></tr><tr><td style=text-align:left><strong>Pigsty</strong></td><td style=text-align:left>Pigsty supplementary repository, providing additional extensions</td></tr></tbody></table><p>The Pigsty repository only includes extensions not present in the PGDG repository. Once an extension enters the PGDG repository, the Pigsty repository will remove it or keep it consistent.</p><p>Repository URLs:</p><ul><li>PGDG YUM: <a href=https://download.postgresql.org/pub/repos/yum/>https://download.postgresql.org/pub/repos/yum/</a></li><li>PGDG APT: <a href=https://apt.postgresql.org/pub/repos/apt/>https://apt.postgresql.org/pub/repos/apt/</a></li><li>Pigsty YUM: <a href=https://repo.pigsty.io/yum/>https://repo.pigsty.io/yum/</a></li><li>Pigsty APT: <a href=https://repo.pigsty.io/apt/>https://repo.pigsty.io/apt/</a></li></ul><p>For detailed repository configuration, see <a href=repo>Extension Repository</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-128bcfdba2d6b955af1661f0a806fd9e>16.5 - Install</h1><div class=lead>Install extension packages on cluster nodes</div><p>Pigsty uses the operating system&rsquo;s package manager (yum/apt) to install extension packages.</p><hr><h2 id=related-parameters>Related Parameters</h2><p>Two parameters are used to specify extensions to install:</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>Purpose</th><th style=text-align:left>Default Behavior</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_packages><code>pg_packages</code></a></td><td style=text-align:left>Global common packages</td><td style=text-align:left>Ensure present (no upgrade)</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a></td><td style=text-align:left>Cluster-specific extensions</td><td style=text-align:left>Install latest version</td></tr></tbody></table><p><code>pg_packages</code> is typically used to specify base components needed by all clusters (PostgreSQL kernel, Patroni, pgBouncer, etc.) and essential extensions.</p><p><code>pg_extensions</code> is used to specify extensions needed by specific clusters.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># Global base packages</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># Cluster extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgis timescaledb pgvector</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=install-during-cluster-initialization>Install During Cluster Initialization</h2><p>Declare extensions in cluster configuration, and they will be automatically installed during initialization:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector, pg_duckdb ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When executing <code>./pgsql.yml</code> to initialize the cluster, extensions will be automatically installed.</p><hr><h2 id=install-extensions-on-existing-cluster>Install Extensions on Existing Cluster</h2><p>For initialized clusters, there are multiple ways to install extensions:</p><h3 id=using-pigsty-playbook>Using Pigsty Playbook</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Install using playbook after modifying configuration</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_extension
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Or specify extensions directly on command line</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_extension -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;:[&#34;pg_duckdb&#34;]}&#39;</span>
</span></span></code></pre></div><h3 id=using-pig-package-manager>Using pig Package Manager</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Install extension using pig</span>
</span></span><span style=display:flex><span>pig install pg_duckdb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Batch install</span>
</span></span><span style=display:flex><span>ansible pg-meta -b -a <span style=color:#4e9a06>&#39;pig install pg_duckdb pgvector&#39;</span>
</span></span></code></pre></div><h3 id=using-package-manager-directly>Using Package Manager Directly</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL systems</span>
</span></span><span style=display:flex><span>sudo yum install -y pg_duckdb_18*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian/Ubuntu systems</span>
</span></span><span style=display:flex><span>sudo apt install -y postgresql-18-pg-duckdb
</span></span></code></pre></div><hr><h2 id=using-package-aliases>Using Package Aliases</h2><p>Pigsty supports using standardized package aliases, automatically translating to package names for the corresponding PG version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgvector          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Auto-translates to pgvector_18* (EL) or postgresql-18-pgvector (Debian)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgis           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Auto-translates to postgis36_18* (EL) or postgresql-18-postgis-3* (Debian)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-gis         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Category alias, installs entire GIS category of extensions</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can also use raw package names directly:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgvector_18*                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># EL system raw package name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgresql-18-pgvector         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Debian system raw package name</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For package alias definitions, see:</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el8.x86_64.yml>EL8 Extension List</a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el9.x86_64.yml>EL9 Extension List</a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d12.x86_64.yml>D12 Extension List</a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u22.x86_64.yml>U22 Extension List</a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u24.x86_64.yml>U24 Extension List</a></li></ul><hr><h2 id=verify-installation>Verify Installation</h2><p>After installation, verify in the database:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Check installed extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Check if extension files exist
</span></span></span><span style=display:flex><span><span style=color:#a40000>\</span><span style=color:#000>dx</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8c405665bb423ccc536997bd9c3a64ca>16.6 - Config</h1><div class=lead>Preload extension libraries and configure extension parameters</div><p>Some extensions require preloading dynamic libraries or configuring parameters before use. This section describes how to configure extensions.</p><hr><h2 id=preload-extensions>Preload Extensions</h2><p>Most extensions can be enabled directly with <code>CREATE EXTENSION</code> after installation, but some extensions using PostgreSQL&rsquo;s Hook mechanism require <strong>preloading</strong>.</p><p>Preloading is specified via the <code>shared_preload_libraries</code> parameter and requires a <strong>database restart</strong> to take effect.</p><h3 id=extensions-requiring-preload>Extensions Requiring Preload</h3><p>Common extensions that require preloading:</p><table><thead><tr><th style=text-align:left>Extension</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>timescaledb</code></td><td style=text-align:left>Time-series database extension, must be placed first</td></tr><tr><td style=text-align:left><code>citus</code></td><td style=text-align:left>Distributed database extension, must be placed first</td></tr><tr><td style=text-align:left><code>pg_stat_statements</code></td><td style=text-align:left>SQL statement statistics, enabled by default in Pigsty</td></tr><tr><td style=text-align:left><code>auto_explain</code></td><td style=text-align:left>Automatically log slow query execution plans, enabled by default in Pigsty</td></tr><tr><td style=text-align:left><code>pg_cron</code></td><td style=text-align:left>Scheduled task scheduling</td></tr><tr><td style=text-align:left><code>pg_net</code></td><td style=text-align:left>Asynchronous HTTP requests</td></tr><tr><td style=text-align:left><code>pg_tle</code></td><td style=text-align:left>Trusted language extensions</td></tr><tr><td style=text-align:left><code>pgaudit</code></td><td style=text-align:left>Audit logging</td></tr><tr><td style=text-align:left><code>pg_stat_kcache</code></td><td style=text-align:left>Kernel statistics</td></tr><tr><td style=text-align:left><code>pg_squeeze</code></td><td style=text-align:left>Online table space reclamation</td></tr><tr><td style=text-align:left><code>pgml</code></td><td style=text-align:left>PostgresML machine learning</td></tr></tbody></table><p>For the complete list, see the <a href=https://pgext.cloud/list>Extension Catalog</a> (marked with <code>LOAD</code>).</p><h3 id=preload-order>Preload Order</h3><p>The loading order of extensions in <code>shared_preload_libraries</code> is important:</p><ul><li><code>timescaledb</code> and <code>citus</code> must be placed <strong>first</strong></li><li>If using both, <code>citus</code> should come before <code>timescaledb</code></li><li>Statistics extensions should come after <code>pg_stat_statements</code> to use the same query_id</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=configure-during-cluster-initialization>Configure During Cluster Initialization</h2><p>When creating a new cluster, use the <a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a> parameter to specify preloaded extensions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb, postgis, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The value of <code>pg_libs</code> will be written to <code>shared_preload_libraries</code> during cluster initialization.</p><h3 id=default-value>Default Value</h3><p>The default value of <a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a> is <code>pg_stat_statements, auto_explain</code>. These two Contrib extensions provide basic observability:</p><ul><li><code>pg_stat_statements</code>: Track execution statistics of all SQL statements</li><li><code>auto_explain</code>: Automatically log execution plans for slow queries</li></ul><hr><h2 id=modify-configuration-on-existing-cluster>Modify Configuration on Existing Cluster</h2><p>For initialized clusters, use <code>patronictl</code> to modify <code>shared_preload_libraries</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Add timescaledb to preload libraries</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart cluster to apply configuration</span>
</span></span><span style=display:flex><span>pg restart pg-meta
</span></span></code></pre></div><p>You can also directly modify <code>postgresql.conf</code> or use <code>ALTER SYSTEM</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>shared_preload_libraries</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>A PostgreSQL service restart is required after modification.</p><hr><h2 id=extension-parameter-configuration>Extension Parameter Configuration</h2><p>Many extensions have configurable parameters that can be set in the following locations:</p><h3 id=during-cluster-initialization>During Cluster Initialization</h3><p>Use the <a href=/docs/pgsql/param#pg_parameters><code>pg_parameters</code></a> parameter to specify:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_cron, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Database used by pg_cron</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_stat_statements.track</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Track all statements</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>auto_explain.log_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Log queries exceeding 1 second</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=runtime-modification>Runtime Modification</h3><p>Use <code>ALTER SYSTEM</code> or <code>patronictl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Modify parameter
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_statements</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>track</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Reload configuration
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_reload_conf</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify using patronictl</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#4e9a06>&#39;pg_stat_statements.track=all&#39;</span>
</span></span></code></pre></div><hr><h2 id=important-notes>Important Notes</h2><ol><li><p><strong>Preload errors prevent startup</strong>: If an extension in <code>shared_preload_libraries</code> doesn&rsquo;t exist or fails to load, PostgreSQL will not start. Ensure extensions are properly installed before adding to preload.</p></li><li><p><strong>Modification requires restart</strong>: Changes to <code>shared_preload_libraries</code> require restarting the PostgreSQL service to take effect.</p></li><li><p><strong>Partial functionality available</strong>: Some extensions can be partially used without preloading, but full functionality requires preloading.</p></li><li><p><strong>View current configuration</strong>: Use the following command to view current preload libraries:</p></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>shared_preload_libraries</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5b462599a5e29b51a35ede5bb5e310a8>16.7 - Create</h1><div class=lead>Create and enable extensions in databases</div><p>After installing extension packages, you need to execute <code>CREATE EXTENSION</code> in the database to use extension features.</p><hr><h2 id=view-available-extensions>View Available Extensions</h2><p>After installing extension packages, you can view available extensions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View all available extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View specific extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View enabled extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=create-extensions>Create Extensions</h2><p>Use <code>CREATE EXTENSION</code> to enable extensions in the database:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Create extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Create extension in specific schema
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Automatically install dependent extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Create if not exists
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>Note: <code>CREATE EXTENSION</code> uses the <strong>extension name</strong> (e.g., <code>vector</code>), not the package alias (<code>pgvector</code>).</p></blockquote><hr><h2 id=create-during-cluster-initialization>Create During Cluster Initialization</h2><p>Declare extensions in <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a>, and they will be automatically created during cluster initialization:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>vector }                        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use default schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Specify schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_stat_statements, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty will automatically execute <code>CREATE EXTENSION</code> after database creation.</p><hr><h2 id=extensions-requiring-preload>Extensions Requiring Preload</h2><p>Some extensions must be added to <code>shared_preload_libraries</code> and restarted before creation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Requires preload</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If you try to create without preloading, you will receive an error message.</p><p>Common extensions requiring preload: <code>timescaledb</code>, <code>citus</code>, <code>pg_cron</code>, <code>pg_net</code>, <code>pgaudit</code>, etc. See <a href=config>Configure Extensions</a>.</p><hr><h2 id=extension-dependencies>Extension Dependencies</h2><p>Some extensions depend on other extensions and need to be created in order:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- postgis_topology depends on postgis
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Or use CASCADE to automatically install dependencies
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=extensions-not-requiring-creation>Extensions Not Requiring Creation</h2><p>A few extensions don&rsquo;t provide SQL interfaces and don&rsquo;t need <code>CREATE EXTENSION</code>:</p><table><thead><tr><th style=text-align:left>Extension</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>wal2json</code></td><td style=text-align:left>Logical decoding plugin, used directly in replication slots</td></tr><tr><td style=text-align:left><code>decoderbufs</code></td><td style=text-align:left>Logical decoding plugin</td></tr><tr><td style=text-align:left><code>decoder_raw</code></td><td style=text-align:left>Logical decoding plugin</td></tr></tbody></table><p>These extensions can be used immediately after installation, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Create logical replication slot using wal2json
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_create_logical_replication_slot</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;test_slot&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;wal2json&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=view-extension-information>View Extension Information</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View extension details
</span></span></span><span style=display:flex><span><span style=color:#a40000>\</span><span style=color:#000>dx</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View objects contained in extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension_config_dump</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View extension version
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-aeb68b34de12844024f2519dd13df6f0>16.8 - Update</h1><div class=lead>Upgrade PostgreSQL extension versions</div><p>Extension updates involve two levels: <strong>package updates</strong> (operating system level) and <strong>extension object updates</strong> (database level).</p><hr><h2 id=update-packages>Update Packages</h2><p>Use package managers to update extension packages:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL systems</span>
</span></span><span style=display:flex><span>sudo yum update pgvector_18*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian/Ubuntu systems</span>
</span></span><span style=display:flex><span>sudo apt update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> sudo apt upgrade postgresql-18-pgvector
</span></span></code></pre></div><p>Batch update using Pigsty:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Update extension packages for specified cluster</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_extension -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;:[&#34;pgvector&#34;]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Using pig package manager</span>
</span></span><span style=display:flex><span>pig update pgvector
</span></span></code></pre></div><hr><h2 id=update-extension-objects>Update Extension Objects</h2><p>After package updates, extension objects in the database may need to be synchronized.</p><h3 id=view-updatable-extensions>View Updatable Extensions</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View installed extensions and their versions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View upgradable extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=execute-extension-update>Execute Extension Update</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Update to latest version
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Update to specific version
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.8.0&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=view-update-paths>View Update Paths</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View available upgrade paths for extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension_update_paths</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgvector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=important-notes>Important Notes</h2><ol><li><p><strong>Backup first</strong>: Backup the database before updating extensions, especially for extensions involving data type changes.</p></li><li><p><strong>Check compatibility</strong>: Some extension major version upgrades may be incompatible. Consult the extension&rsquo;s upgrade documentation.</p></li><li><p><strong>Preloaded extensions</strong>: If updating a preloaded extension (like <code>timescaledb</code>), a database restart may be required after the update.</p></li><li><p><strong>Dependencies</strong>: If other extensions depend on the updated extension, update them in dependency order.</p></li><li><p><strong>Replication environments</strong>: In master-slave replication environments, test updates on slaves first, then update the master after confirmation.</p></li></ol><hr><h2 id=common-issues>Common Issues</h2><h3 id=update-failure>Update Failure</h3><p>If <code>ALTER EXTENSION UPDATE</code> fails, it may be because:</p><ul><li>No available upgrade path</li><li>Extension is in use</li><li>Insufficient permissions</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View extension dependencies
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>refobjid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgvector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=rollback-update>Rollback Update</h3><p>PostgreSQL extensions typically don&rsquo;t support direct rollback. To rollback:</p><ol><li>Restore from backup</li><li>Or: Uninstall new version extension, install old version package, recreate extension</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-13869765de25ae294c556ad54ac4ee27>16.9 - Remove</h1><div class=lead>Uninstall PostgreSQL extensions</div><p>Removing extensions involves two levels: <strong>dropping extension objects</strong> (database level) and <strong>uninstalling packages</strong> (operating system level).</p><hr><h2 id=drop-extension-objects>Drop Extension Objects</h2><p>Use <code>DROP EXTENSION</code> to remove extensions from the database:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Drop extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- If there are dependent objects, cascade delete is required
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p><strong>Warning</strong>: <code>CASCADE</code> will drop all objects that depend on this extension (tables, functions, views, etc.). Use with caution.</p></blockquote><h3 id=check-extension-dependencies>Check Extension Dependencies</h3><p>It&rsquo;s recommended to check dependencies before dropping:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View objects that depend on an extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>classid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>objid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>deptype</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>refobjid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgvector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View tables using extension types
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>a</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>column_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>typname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>type_name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#f8f8f8> </span><span style=color:#000>a</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>c</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>a</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_type</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>a</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>atttypid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>typname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=remove-preload>Remove Preload</h2><p>If the extension is in <code>shared_preload_libraries</code>, it must be removed from the preload list after dropping:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify shared_preload_libraries, remove extension</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart to apply configuration</span>
</span></span><span style=display:flex><span>pg restart pg-meta
</span></span></code></pre></div><hr><h2 id=uninstall-packages>Uninstall Packages</h2><p>After dropping the extension from the database, you can optionally uninstall the package:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL systems</span>
</span></span><span style=display:flex><span>sudo yum remove pgvector_18*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian/Ubuntu systems</span>
</span></span><span style=display:flex><span>sudo apt remove postgresql-18-pgvector
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Using pig package manager</span>
</span></span><span style=display:flex><span>pig remove pgvector
</span></span></code></pre></div><blockquote><p>Typically keeping the package doesn&rsquo;t cause issues. Only uninstall when you need to free disk space or resolve conflicts.</p></blockquote><hr><h2 id=important-notes>Important Notes</h2><ol><li><p><strong>Data loss risk</strong>: Using <code>CASCADE</code> will drop dependent objects, potentially causing data loss.</p></li><li><p><strong>Application compatibility</strong>: Ensure applications no longer use the extension&rsquo;s functionality before dropping.</p></li><li><p><strong>Preload order</strong>: If dropping a preloaded extension, be sure to also remove it from <code>shared_preload_libraries</code>, otherwise the database may fail to start.</p></li><li><p><strong>Master-slave environments</strong>: In replication environments, <code>DROP EXTENSION</code> automatically replicates to slaves.</p></li></ol><hr><h2 id=operation-sequence>Operation Sequence</h2><p>Complete extension removal workflow:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Check dependencies</span>
</span></span><span style=display:flex><span>psql -d mydb -c <span style=color:#4e9a06>&#34;SELECT * FROM pg_depend WHERE refobjid = (SELECT oid FROM pg_extension WHERE extname = &#39;pgvector&#39;);&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Drop extension from database</span>
</span></span><span style=display:flex><span>psql -d mydb -c <span style=color:#4e9a06>&#34;DROP EXTENSION pgvector;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. If it&#39;s a preloaded extension, remove from shared_preload_libraries</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. Restart database (if preload configuration was modified)</span>
</span></span><span style=display:flex><span>pg restart pg-meta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. Optional: Uninstall package</span>
</span></span><span style=display:flex><span>sudo yum remove pgvector_18*
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-cd40e09e16b398209123543c21e68960>16.10 - Default Extensions</h1><div class=lead>PostgreSQL extensions installed by default in Pigsty</div><p>Pigsty installs and enables some core extensions by default when initializing PostgreSQL clusters.</p><hr><h2 id=default-installed-extensions>Default Installed Extensions</h2><p>Extensions installed by default via <a href=/docs/pgsql/param#pg_packages><code>pg_packages</code></a>:</p><table><thead><tr><th style=text-align:left>Extension</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>pg_repack</code></td><td style=text-align:left>Handle table bloat online, important maintenance tool</td></tr><tr><td style=text-align:left><code>wal2json</code></td><td style=text-align:left>Logical decoding outputs JSON format changes, commonly used in CDC scenarios</td></tr></tbody></table><p>Extensions optionally installed via <a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a> (commented by default):</p><table><thead><tr><th style=text-align:left>Extension</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>postgis</code></td><td style=text-align:left>Geospatial database extension</td></tr><tr><td style=text-align:left><code>timescaledb</code></td><td style=text-align:left>Time-series database extension</td></tr><tr><td style=text-align:left><code>pgvector</code></td><td style=text-align:left>Vector data type and indexes</td></tr></tbody></table><hr><h2 id=default-enabled-extensions>Default Enabled Extensions</h2><p>Extensions enabled by default in all databases via <a href=/docs/pgsql/param#pg_default_extensions><code>pg_default_extensions</code></a>:</p><table><thead><tr><th style=text-align:left>Extension</th><th style=text-align:left>Schema</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>pg_stat_statements</code></td><td style=text-align:left>monitor</td><td style=text-align:left>SQL statement execution statistics</td></tr><tr><td style=text-align:left><code>pgstattuple</code></td><td style=text-align:left>monitor</td><td style=text-align:left>Tuple-level statistics</td></tr><tr><td style=text-align:left><code>pg_buffercache</code></td><td style=text-align:left>monitor</td><td style=text-align:left>Buffer cache inspection</td></tr><tr><td style=text-align:left><code>pageinspect</code></td><td style=text-align:left>monitor</td><td style=text-align:left>Page-level inspection</td></tr><tr><td style=text-align:left><code>pg_prewarm</code></td><td style=text-align:left>monitor</td><td style=text-align:left>Relation prewarming</td></tr><tr><td style=text-align:left><code>pg_visibility</code></td><td style=text-align:left>monitor</td><td style=text-align:left>Visibility map inspection</td></tr><tr><td style=text-align:left><code>pg_freespacemap</code></td><td style=text-align:left>monitor</td><td style=text-align:left>Free space map inspection</td></tr><tr><td style=text-align:left><code>postgres_fdw</code></td><td style=text-align:left>public</td><td style=text-align:left>PostgreSQL foreign data wrapper</td></tr><tr><td style=text-align:left><code>file_fdw</code></td><td style=text-align:left>public</td><td style=text-align:left>File foreign data wrapper</td></tr><tr><td style=text-align:left><code>btree_gist</code></td><td style=text-align:left>public</td><td style=text-align:left>B-tree GiST operator classes</td></tr><tr><td style=text-align:left><code>btree_gin</code></td><td style=text-align:left>public</td><td style=text-align:left>B-tree GIN operator classes</td></tr><tr><td style=text-align:left><code>pg_trgm</code></td><td style=text-align:left>public</td><td style=text-align:left>Trigram matching</td></tr><tr><td style=text-align:left><code>intagg</code></td><td style=text-align:left>public</td><td style=text-align:left>Integer aggregator</td></tr><tr><td style=text-align:left><code>intarray</code></td><td style=text-align:left>public</td><td style=text-align:left>Integer array functions</td></tr><tr><td style=text-align:left><code>pg_repack</code></td><td style=text-align:left>-</td><td style=text-align:left>Online table reorganization</td></tr></tbody></table><p>These extensions provide basic monitoring, operations, and feature enhancement capabilities.</p><hr><h2 id=default-preloaded-extensions>Default Preloaded Extensions</h2><p>Extensions preloaded by default into <code>shared_preload_libraries</code> via <a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a>:</p><table><thead><tr><th style=text-align:left>Extension</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>pg_stat_statements</code></td><td style=text-align:left>Track execution statistics of all SQL statements</td></tr><tr><td style=text-align:left><code>auto_explain</code></td><td style=text-align:left>Automatically log execution plans for slow queries</td></tr></tbody></table><p>These two extensions provide basic observability and are strongly recommended to keep.</p><hr><h2 id=customize-default-extensions>Customize Default Extensions</h2><p>You can customize default installed and enabled extensions by modifying configuration parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Modify default extension packages</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>pg_repack_$v* wal2json_$v*</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Modify default installed extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Modify default preloaded extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Modify default enabled extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_stat_statements, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_repack }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># ... add more</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For detailed extension usage, please refer to:</p><ul><li><a href=start>Quick Start</a>: Overview of the extension usage process</li><li><a href=intro>Extension Introduction</a>: Core concepts of extensions</li><li><a href=install>Install Extensions</a>: How to install extensions</li><li><a href=config>Configure Extensions</a>: Preloading and parameter configuration</li><li><a href=create>Create Extensions</a>: Creating extensions in databases</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fef9a9d4af92d185f18fab30d92a530d>16.11 - Repository</h1><div class=lead>Pigsty extension software repository configuration</div><p>Pigsty provides supplementary extension repositories, offering additional extension packages on top of the PGDG official repository.</p><hr><h2 id=yum-repository>YUM Repository</h2><p>Applicable to EL 7/8/9/10 and compatible systems (RHEL, Rocky, AlmaLinux, CentOS, etc.).</p><h3 id=add-repository>Add Repository</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Add GPG public key</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Add repository configuration</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Refresh cache</span>
</span></span><span style=display:flex><span>sudo yum makecache
</span></span></code></pre></div><h3 id=china-mainland-mirror>China Mainland Mirror</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span></code></pre></div><h3 id=repository-urls>Repository URLs</h3><ul><li>International: <a href=https://repo.pigsty.io/yum/>https://repo.pigsty.io/yum/</a></li><li>China: <a href=https://repo.pigsty.cc/yum/>https://repo.pigsty.cc/yum/</a></li></ul><hr><h2 id=apt-repository>APT Repository</h2><p>Applicable to Debian 11/12/13 and Ubuntu 22.04/24.04 and compatible systems.</p><h3 id=add-repository-1>Add Repository</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Add GPG public key</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/pigsty.gpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Get distribution codename and add repository</span>
</span></span><span style=display:flex><span><span style=color:#000>distro_codename</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>lsb_release -cs<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/pgsql ${distro_codename} main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Refresh cache</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span></code></pre></div><h3 id=china-mainland-mirror-1>China Mainland Mirror</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/key <span style=color:#000;font-weight:700>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/pigsty.gpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>distro_codename</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>lsb_release -cs<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.cc/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.cc/apt/pgsql/${distro_codename} ${distro_codename} main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=repository-urls-1>Repository URLs</h3><ul><li>International: <a href=https://repo.pigsty.io/apt/>https://repo.pigsty.io/apt/</a></li><li>China Mirror: <a href=https://repo.pigsty.cc/apt/>https://repo.pigsty.cc/apt/</a></li></ul><hr><h2 id=gpg-signature>GPG Signature</h2><p>All packages are signed with GPG:</p><ul><li>Fingerprint: <code>9592A7BC7A682E7333376E09E7935D8DB9BD8B20</code></li><li>Short ID: <code>B9BD8B20</code></li></ul><hr><h2 id=repository-policy>Repository Policy</h2><p>The Pigsty repository follows these principles:</p><ol><li><strong>Supplementary</strong>: Only includes extensions not present in the PGDG repository</li><li><strong>Consistency</strong>: Once an extension enters the PGDG repository, the Pigsty repository will remove it or keep it consistent</li><li><strong>Compatibility</strong>: Supports multiple major versions of PostgreSQL 13-18</li><li><strong>Multi-platform</strong>: Supports x86_64 and aarch64 architectures</li></ol><hr><h2 id=related-resources>Related Resources</h2><ul><li><a href=https://pgext.cloud/list>Pigsty Extension Catalog</a>: Browse all available extensions</li><li><a href=https://download.postgresql.org/pub/repos/yum/>PGDG YUM Repository</a></li><li><a href=https://apt.postgresql.org/pub/repos/apt/>PGDG APT Repository</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a670d0bcea1364c05aff52997d9cdc42>17 - Param Templates</h1><div class=lead>Use Pigsty&rsquo;s built-in Patroni config templates or customize your own</div><p>Pigsty provides four preset Patroni/PostgreSQL config templates optimized for different workloads:</p><table class=full-width><thead><tr><th style=text-align:left>Template</th><th style=text-align:left>CPU Cores</th><th style=text-align:left>Use Case</th><th style=text-align:left>Characteristics</th></tr></thead><tbody><tr><td style=text-align:left><a href=oltp><strong><code>oltp.yml</code></strong></a></td><td style=text-align:left>4-128C</td><td style=text-align:left>OLTP transactions</td><td style=text-align:left>High concurrency, low latency</td></tr><tr><td style=text-align:left><a href=olap><strong><code>olap.yml</code></strong></a></td><td style=text-align:left>4-128C</td><td style=text-align:left>OLAP analytics</td><td style=text-align:left>Large queries, high parallelism</td></tr><tr><td style=text-align:left><a href=crit><strong><code>crit.yml</code></strong></a></td><td style=text-align:left>4-128C</td><td style=text-align:left>Critical/Finance</td><td style=text-align:left>Data safety, audit, zero-loss</td></tr><tr><td style=text-align:left><a href=tiny><strong><code>tiny.yml</code></strong></a></td><td style=text-align:left>1-3C</td><td style=text-align:left>Tiny instances</td><td style=text-align:left>Resource-constrained envs</td></tr></tbody></table><p>Use <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> to select a template; default is <a href=oltp><strong><code>oltp.yml</code></strong></a>.</p><blockquote><p>The database tuning template <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> should be paired with the OS tuning template <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>.</p></blockquote><hr><h2 id=usage>Usage</h2><p>Set <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> in your cluster definition.
It&rsquo;s recommended to set <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> accordingly for OS-level tuning:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL config template (default)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS tuning template (default)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For critical financial workloads, use <a href=crit><strong><code>crit.yml</code></strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-finance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.21</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.22</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.23</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-finance</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL critical template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS critical tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For low-spec VMs or dev environments, use <a href=tiny><strong><code>tiny.yml</code></strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-dev</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.31</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL tiny template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS tiny tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=comparison>Comparison</h2><p>The four templates differ significantly in key parameters:</p><h3 id=connections--memory>Connections & Memory</h3><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>max_connections</strong></td><td style=text-align:left>500/1000</td><td style=text-align:left>500</td><td style=text-align:left>500/1000</td><td style=text-align:left>250</td></tr><tr><td style=text-align:left><strong>work_mem</strong> range</td><td style=text-align:left>64MB-1GB</td><td style=text-align:left>64MB-8GB</td><td style=text-align:left>64MB-1GB</td><td style=text-align:left>16MB-256MB</td></tr><tr><td style=text-align:left><strong>maintenance_work_mem</strong></td><td style=text-align:left>25% shmem</td><td style=text-align:left>50% shmem</td><td style=text-align:left>25% shmem</td><td style=text-align:left>25% shmem</td></tr><tr><td style=text-align:left><strong>max_locks_per_transaction</strong></td><td style=text-align:left>1-2x maxconn</td><td style=text-align:left>2-4x maxconn</td><td style=text-align:left>1-2x maxconn</td><td style=text-align:left>1-2x maxconn</td></tr></tbody></table><h3 id=parallel-query>Parallel Query</h3><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>max_worker_processes</strong></td><td style=text-align:left>cpu+8</td><td style=text-align:left>cpu+12</td><td style=text-align:left>cpu+8</td><td style=text-align:left>cpu+4</td></tr><tr><td style=text-align:left><strong>max_parallel_workers</strong></td><td style=text-align:left>50% cpu</td><td style=text-align:left>80% cpu</td><td style=text-align:left>50% cpu</td><td style=text-align:left>50% cpu</td></tr><tr><td style=text-align:left><strong>max_parallel_workers_per_gather</strong></td><td style=text-align:left>20% cpu (max 8)</td><td style=text-align:left>50% cpu</td><td style=text-align:left>0 (off)</td><td style=text-align:left>0 (off)</td></tr><tr><td style=text-align:left><strong>parallel_setup_cost</strong></td><td style=text-align:left>2000</td><td style=text-align:left>1000</td><td style=text-align:left>2000</td><td style=text-align:left>1000</td></tr><tr><td style=text-align:left><strong>parallel_tuple_cost</strong></td><td style=text-align:left>0.2</td><td style=text-align:left>0.1</td><td style=text-align:left>0.2</td><td style=text-align:left>0.1</td></tr></tbody></table><h3 id=sync-replication>Sync Replication</h3><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>synchronous_mode</strong></td><td style=text-align:left>depends pg_rpo</td><td style=text-align:left>depends pg_rpo</td><td style=text-align:left>forced on</td><td style=text-align:left>depends pg_rpo</td></tr><tr><td style=text-align:left><strong>data_checksums</strong></td><td style=text-align:left>optional</td><td style=text-align:left>optional</td><td style=text-align:left>forced on</td><td style=text-align:left>optional</td></tr></tbody></table><h3 id=vacuum-config>Vacuum Config</h3><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>vacuum_cost_delay</strong></td><td style=text-align:left>20ms</td><td style=text-align:left>10ms</td><td style=text-align:left>20ms</td><td style=text-align:left>20ms</td></tr><tr><td style=text-align:left><strong>vacuum_cost_limit</strong></td><td style=text-align:left>2000</td><td style=text-align:left>10000</td><td style=text-align:left>2000</td><td style=text-align:left>2000</td></tr><tr><td style=text-align:left><strong>autovacuum_max_workers</strong></td><td style=text-align:left>3</td><td style=text-align:left>3</td><td style=text-align:left>3</td><td style=text-align:left>2</td></tr></tbody></table><h3 id=timeout--security>Timeout & Security</h3><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>idle_in_transaction_session_timeout</strong></td><td style=text-align:left>10min</td><td style=text-align:left>off</td><td style=text-align:left>1min</td><td style=text-align:left>10min</td></tr><tr><td style=text-align:left><strong>log_min_duration_statement</strong></td><td style=text-align:left>100ms</td><td style=text-align:left>1000ms</td><td style=text-align:left>100ms</td><td style=text-align:left>100ms</td></tr><tr><td style=text-align:left><strong>default_statistics_target</strong></td><td style=text-align:left>400</td><td style=text-align:left>1000</td><td style=text-align:left>400</td><td style=text-align:left>200</td></tr><tr><td style=text-align:left><strong>track_activity_query_size</strong></td><td style=text-align:left>8KB</td><td style=text-align:left>8KB</td><td style=text-align:left>32KB</td><td style=text-align:left>8KB</td></tr><tr><td style=text-align:left><strong>log_connections</strong></td><td style=text-align:left>auth</td><td style=text-align:left>auth</td><td style=text-align:left>full</td><td style=text-align:left>default</td></tr></tbody></table><h3 id=io-config-pg17>IO Config (PG17+)</h3><table class=full-width><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>io_workers</strong></td><td style=text-align:left>25% cpu (4-16)</td><td style=text-align:left>50% cpu (4-32)</td><td style=text-align:left>25% cpu (4-8)</td><td style=text-align:left>3</td></tr><tr><td style=text-align:left><strong>temp_file_limit</strong></td><td style=text-align:left>1/20 disk</td><td style=text-align:left>1/5 disk</td><td style=text-align:left>1/20 disk</td><td style=text-align:left>1/20 disk</td></tr></tbody></table><hr><h2 id=selection-guide>Selection Guide</h2><ul><li><p><a href=oltp><strong>OLTP Template</strong></a>: Default choice for most transaction processing. Ideal for e-commerce, social, gaming apps.</p></li><li><p><a href=olap><strong>OLAP Template</strong></a>: For data warehouses, BI reports, ETL. Allows large queries, high parallelism, relaxed timeouts.</p></li><li><p><a href=crit><strong>CRIT Template</strong></a>: For financial transactions, core accounting with strict consistency/security requirements. Forced sync replication, checksums, full audit.</p></li><li><p><a href=tiny><strong>TINY Template</strong></a>: For dev/test environments, resource-constrained VMs, Raspberry Pi. Minimizes resource usage, disables parallel queries.</p></li></ul><hr><h2 id=custom-templates>Custom Templates</h2><p>Create custom templates based on existing ones. Templates are in <code>roles/pgsql/templates/</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>roles/pgsql/templates/
</span></span><span style=display:flex><span>├── oltp.yml    <span style=color:#8f5902;font-style:italic># OLTP template (default)</span>
</span></span><span style=display:flex><span>├── olap.yml    <span style=color:#8f5902;font-style:italic># OLAP template</span>
</span></span><span style=display:flex><span>├── crit.yml    <span style=color:#8f5902;font-style:italic># CRIT critical template</span>
</span></span><span style=display:flex><span>└── tiny.yml    <span style=color:#8f5902;font-style:italic># TINY micro template</span>
</span></span></code></pre></div><p>Steps to create a custom template:</p><ol><li>Copy an existing template as base</li><li>Modify parameters as needed</li><li>Place in <code>roles/pgsql/templates/</code></li><li>Reference via <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a></li></ol><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp roles/pgsql/templates/oltp.yml roles/pgsql/templates/myapp.yml
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Edit myapp.yml as needed</span>
</span></span></code></pre></div><p>Then use in your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-myapp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp.yml</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Templates use Jinja2 syntax; parameters are dynamically computed based on node resources (CPU, memory, disk).</p><hr><h2 id=tuning-strategy>Tuning Strategy</h2><p>For technical details on template parameter optimization, see <a href=tune><strong>Tuning Strategy</strong></a>:</p><ul><li>Memory tuning (shared buffers, work mem, max connections)</li><li>CPU tuning (parallel query worker config)</li><li>Storage tuning (WAL size, temp file limits)</li><li>Manual parameter adjustment</li></ul><hr><h2 id=related-parameters>Related Parameters</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>: PostgreSQL config template</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>: OS tuning template, should match <code>pg_conf</code></li><li><a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a>: Recovery time objective, affects failover timeout</li><li><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a>: Recovery point objective, affects sync replication</li><li><a href=/docs/pgsql/param#pg_max_conn><strong><code>pg_max_conn</code></strong></a>: Override template max connections</li><li><a href=/docs/pgsql/param#pg_shared_buffer_ratio><strong><code>pg_shared_buffer_ratio</code></strong></a>: Shared buffer memory ratio</li><li><a href=/docs/pgsql/param#pg_storage_type><strong><code>pg_storage_type</code></strong></a>: Storage type, affects IO params</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c343b4e12cd241ebdb244700f6f7ae20>17.1 - Parameter Optimization Policy</h1><div class=lead>Learn the parameter optimization strategies Pigsty uses for the 4 different PostgreSQL workload scenarios.</div><p>Pigsty provides four scenario-based parameter templates by default, which can be specified and used through the <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a> parameter.</p><ul><li><code>tiny.yml</code>: Optimized for small nodes, VMs, and small demos (1-8 cores, 1-16GB)</li><li><code>oltp.yml</code>: Optimized for OLTP workloads and latency-sensitive applications (4C8GB+) (default template)</li><li><code>olap.yml</code>: Optimized for OLAP workloads and throughput (4C8G+)</li><li><code>crit.yml</code>: Optimized for data consistency and critical applications (4C8G+)</li></ul><p>Pigsty adopts different parameter optimization strategies for these four default scenarios, as shown below:</p><hr><h2 id=memory-parameter-tuning>Memory Parameter Tuning</h2><p>Pigsty automatically detects the system&rsquo;s memory size and uses it as the basis for setting the maximum number of connections and memory-related parameters.</p><ul><li><a href=/docs/pgsql/param#pg_max_conn><code>pg_max_conn</code></a>: PostgreSQL maximum connections, <code>auto</code> will use recommended values for different scenarios</li><li><a href=/docs/pgsql/param#pg_shared_buffer_ratio><code>pg_shared_buffer_ratio</code></a>: Shared buffer memory ratio, default is 0.25</li></ul><p>By default, Pigsty uses 25% of memory as PostgreSQL shared buffers, with the remaining 75% as the operating system cache.</p><p>By default, if the user has not set a <a href=/docs/pgsql/param#pg_max_conn><code>pg_max_conn</code></a> maximum connections value, Pigsty will use defaults according to the following rules:</p><ul><li>oltp: 500 (pgbouncer) / 1000 (postgres)</li><li>crit: 500 (pgbouncer) / 1000 (postgres)</li><li>tiny: 300</li><li>olap: 300</li></ul><p>For OLTP and CRIT templates, if the service is not pointing to the pgbouncer connection pool but directly connects to the postgres database, the maximum connections will be doubled to 1000.</p><p>After determining the maximum connections, <code>work_mem</code> is calculated from shared memory size / maximum connections and limited to the range of 64MB ~ 1GB.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#000>% raw %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% if pg_max_conn != &#39;auto&#39; and pg_max_conn|int &gt;= 20 %}{% set pg_max_connections = pg_max_conn|int %}{% else %}{% if pg_default_service_dest|default(&#39;postgres&#39;) == &#39;pgbouncer&#39; %}{% set pg_max_connections = 500 %}{% else %}{% set pg_max_connections = 1000 %}{% endif %}{% endif %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_max_prepared_transactions = pg_max_connections if &#39;citus&#39; in pg_libs else 0 %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_max_locks_per_transaction = (2 * pg_max_connections)|int if &#39;citus&#39; in pg_libs or &#39;timescaledb&#39; in pg_libs else pg_max_connections %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_shared_buffers = (node_mem_mb|int * pg_shared_buffer_ratio|float) | round(0, &#39;ceil&#39;) | int %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_maintenance_mem = (pg_shared_buffers|int * 0.25)|round(0, &#39;ceil&#39;)|int %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_effective_cache_size = node_mem_mb|int - pg_shared_buffers|int  %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_workmem =  ([ ([ (pg_shared_buffers / pg_max_connections)|round(0,&#39;floor&#39;)|int , 64 ])|max|int , 1024])|min|int %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% endraw %}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=cpu-parameter-tuning>CPU Parameter Tuning</h2><p>In PostgreSQL, there are 4 important parameters related to parallel queries. Pigsty automatically optimizes parameters based on the current system&rsquo;s CPU cores.
In all strategies, the total number of parallel processes (total budget) is usually set to CPU cores + 8, with a minimum of 16, to reserve enough background workers for logical replication and extensions. The OLAP and TINY templates vary slightly based on scenarios.</p><table><thead><tr><th>OLTP</th><th>Setting Logic</th><th>Range Limits</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td>max(100% CPU + 8, 16)</td><td>CPU cores + 4, minimum 12</td></tr><tr><td><code>max_parallel_workers</code></td><td>max(ceil(50% CPU), 2)</td><td>1/2 CPU rounded up, minimum 2</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td>max(ceil(33% CPU), 2)</td><td>1/3 CPU rounded up, minimum 2</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td>min(max(ceil(20% CPU), 2),8)</td><td>1/5 CPU rounded down, minimum 2, max 8</td></tr></tbody></table><table><thead><tr><th>OLAP</th><th>Setting Logic</th><th>Range Limits</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td>max(100% CPU + 12, 20)</td><td>CPU cores + 12, minimum 20</td></tr><tr><td><code>max_parallel_workers</code></td><td>max(ceil(80% CPU, 2))</td><td>4/5 CPU rounded up, minimum 2</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td>max(ceil(33% CPU), 2)</td><td>1/3 CPU rounded up, minimum 2</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td>max(floor(50% CPU), 2)</td><td>1/2 CPU rounded up, minimum 2</td></tr></tbody></table><table><thead><tr><th>CRIT</th><th>Setting Logic</th><th>Range Limits</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td>max(100% CPU + 8, 16)</td><td>CPU cores + 8, minimum 16</td></tr><tr><td><code>max_parallel_workers</code></td><td>max(ceil(50% CPU), 2)</td><td>1/2 CPU rounded up, minimum 2</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td>max(ceil(33% CPU), 2)</td><td>1/3 CPU rounded up, minimum 2</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td>0, enable as needed</td><td></td></tr></tbody></table><table><thead><tr><th>TINY</th><th>Setting Logic</th><th>Range Limits</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td>max(100% CPU + 4, 12)</td><td>CPU cores + 4, minimum 12</td></tr><tr><td><code>max_parallel_workers</code></td><td>max(ceil(50% CPU) 1)</td><td>50% CPU rounded down, minimum 1</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td>max(ceil(33% CPU), 1)</td><td>33% CPU rounded down, minimum 1</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td>0, enable as needed</td><td></td></tr></tbody></table><p>Note that the CRIT and TINY templates disable parallel queries by setting <code>max_parallel_workers_per_gather = 0</code>.
Users can enable parallel queries as needed by setting this parameter.</p><p>Both OLTP and CRIT templates additionally set the following parameters, doubling the parallel query cost to reduce the tendency to use parallel queries.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_setup_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># double from 100 to increase parallel cost</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_tuple_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># double from 0.1 to increase parallel cost</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_table_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># double from 8MB to increase parallel cost</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_index_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># double from 512 to increase parallel cost</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Note that adjustments to the <code>max_worker_processes</code> parameter only take effect after a restart. Additionally, when a replica&rsquo;s configuration value for this parameter is higher than the primary&rsquo;s, the replica will fail to start.
This parameter must be adjusted through Patroni configuration management, which ensures consistent primary-replica configuration and prevents new replicas from failing to start during failover.</p><hr><h2 id=storage-space-parameters>Storage Space Parameters</h2><p>Pigsty automatically detects the total space of the disk where the <code>/data/postgres</code> main data directory is located and uses it as the basis for specifying the following parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#000>% raw %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth, 200])|min }}GB                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 1/20 disk size, max 200GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth * 4, 2000])|min }}GB            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 2/10 disk size, max 2000GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_slot_wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth * 6, 3000])|min }}GB  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 3/10 disk size, max 3000GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>temp_file_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth, 200])|min }}GB              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 1/20 of disk size, max 200GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% endraw %}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>temp_file_limit</code> defaults to 5% of disk space, capped at 200GB.</li><li><code>min_wal_size</code> defaults to 5% of disk space, capped at 200GB.</li><li><code>max_wal_size</code> defaults to 20% of disk space, capped at 2TB.</li><li><code>max_slot_wal_keep_size</code> defaults to 30% of disk space, capped at 3TB.</li></ul><p>As a special case, the OLAP template allows 20% for <code>temp_file_limit</code>, capped at 2TB.</p><hr><h2 id=manual-parameter-tuning>Manual Parameter Tuning</h2><p>In addition to using Pigsty&rsquo;s automatically configured parameters, you can also manually tune PostgreSQL parameters.</p><p>Use the <code>pg edit-config &lt;cluster></code> command to interactively edit cluster configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta
</span></span></code></pre></div><p>Or use the <code>-p</code> parameter to directly set parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span> pg-meta
</span></span><span style=display:flex><span>pg edit-config --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&#39;</span> pg-meta
</span></span></code></pre></div><p>You can also use the Patroni REST API to modify configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -u <span style=color:#4e9a06>&#39;postgres:Patroni.API&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    -d <span style=color:#4e9a06>&#39;{&#34;postgresql&#34;:{&#34;parameters&#34;: {&#34;log_min_duration_statement&#34;:200}}}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    -s -X PATCH http://10.10.10.10:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-04bbfb111fd00b28b14a77c5a5a92955>17.2 - OLTP Template</h1><div class=lead>PostgreSQL config template optimized for online transaction processing workloads</div><p><code>oltp.yml</code> is Pigsty&rsquo;s default config template, optimized for <strong>online transaction processing</strong> (OLTP). Designed for 4-128 core CPUs with high concurrency, low latency, and high throughput.</p><blockquote><p>Pair with <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>oltp</code> for OS-level tuning.</p></blockquote><hr><h2 id=use-cases>Use Cases</h2><p>OLTP template is ideal for:</p><ul><li><strong>E-commerce</strong>: Order processing, inventory, user transactions</li><li><strong>Social apps</strong>: User feeds, messaging, following relationships</li><li><strong>Gaming backends</strong>: Player data, leaderboards, game state</li><li><strong>SaaS applications</strong>: Multi-tenant business systems</li><li><strong>Web apps</strong>: CRUD-intensive workloads</li></ul><p><strong>Workload characteristics</strong>:</p><ul><li>Many short transactions (millisecond-level)</li><li>High concurrent connections (hundreds to thousands)</li><li>Read/write ratio typically 7:3 to 9:1</li><li>Latency-sensitive, requires fast response</li><li>High data consistency requirements</li></ul><hr><h2 id=usage>Usage</h2><p><a href=oltp><strong><code>oltp.yml</code></strong></a> is the default template, no explicit specification needed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-oltp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># pg_conf: oltp.yml  # PostgreSQL config template (default)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># node_tune: oltp    # OS tuning template (default)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Or explicitly specify:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL config template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS tuning template</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=parameter-details>Parameter Details</h2><h3 id=connection-management>Connection Management</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#000>/1000  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># depends on pgbouncer usage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>When <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> is <code>pgbouncer</code>, <code>max_connections</code> is set to 500</li><li>When traffic connects directly to PostgreSQL, <code>max_connections</code> is set to 1000</li><li>Override via <a href=/docs/pgsql/param#pg_max_conn><code>pg_max_conn</code></a> parameter</li></ul><h3 id=memory-config>Memory Config</h3><p>OLTP template memory allocation strategy:</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>Formula</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>mem × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>Default ratio 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × 25%</td><td style=text-align:left>For VACUUM, CREATE INDEX</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>64MB - 1GB</td><td style=text-align:left>Based on shared_buffers/max_connections</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>total mem - shared_buffers</td><td style=text-align:left>Estimated cache memory</td></tr></tbody></table><p><strong>work_mem calculation</strong>:</p><pre tabindex=0><code>work_mem = min(max(shared_buffers / max_connections, 64MB), 1GB)
</code></pre><p>Ensures each connection has sufficient sort/hash memory without over-allocation.</p><h3 id=parallel-query>Parallel Query</h3><p>OLTP template moderately limits parallel queries to prevent resource contention:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cpu + 8 (min 16)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000>% × cpu (min 2)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000>% × cpu (2-8)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_maintenance_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000>% × cpu (min 2)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Parallel cost estimates are increased to favor serial execution:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_setup_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 2x default (1000)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_tuple_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 2x default (0.1)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_table_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 2x default (8MB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_index_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 2x default (512)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=wal-config>WAL Config</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disk/20 (max 200GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disk/5 (max 2000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_slot_wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disk×3/10 (max 3000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_flush_after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>commit_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>commit_siblings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>checkpoint_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>15min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>checkpoint_completion_target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.80</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Balances data safety and write performance.</p><h3 id=vacuum-config>Vacuum Config</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># sleep after each vacuum round</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># cost limit per vacuum round</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_max_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_naptime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_vacuum_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.08</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 8% table change triggers vacuum</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_analyze_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.04</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 4% table change triggers analyze</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_freeze_max_age</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Conservative vacuum settings avoid impacting online transaction performance.</p><h3 id=query-optimization>Query Optimization</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>random_page_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.1</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># SSD optimized</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>effective_io_concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># SSD concurrent IO</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>default_statistics_target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Statistics precision</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Enables planner to generate better query plans.</p><h3 id=logging--monitoring>Logging & Monitoring</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># log queries &gt; 100ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># log DDL statements</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_checkpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_lock_waits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_temp_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># log temp files &gt; 1MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_autovacuum_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=client-timeouts>Client Timeouts</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deadlock_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>10-minute idle transaction timeout prevents zombie transactions holding locks.</p><h3 id=extension-config>Extension Config</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># auto_explain</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_analyze</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_verbose</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_nested_statements</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_stat_statements</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.max</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_utility</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_planning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=template-comparison>Template Comparison</h2><table><thead><tr><th style=text-align:left>Feature</th><th style=text-align:left><a href=oltp><strong>OLTP</strong></a></th><th style=text-align:left><a href=olap><strong>OLAP</strong></a></th><th style=text-align:left><a href=crit><strong>CRIT</strong></a></th></tr></thead><tbody><tr><td style=text-align:left>max_connections</td><td style=text-align:left>500-1000</td><td style=text-align:left>500</td><td style=text-align:left>500-1000</td></tr><tr><td style=text-align:left>work_mem</td><td style=text-align:left>64MB-1GB</td><td style=text-align:left>64MB-8GB</td><td style=text-align:left>64MB-1GB</td></tr><tr><td style=text-align:left>Parallel query</td><td style=text-align:left>Moderate limit</td><td style=text-align:left>Aggressive</td><td style=text-align:left>Disabled</td></tr><tr><td style=text-align:left>Vacuum intensity</td><td style=text-align:left>Conservative</td><td style=text-align:left>Aggressive</td><td style=text-align:left>Conservative</td></tr><tr><td style=text-align:left>Txn timeout</td><td style=text-align:left>10min</td><td style=text-align:left>Disabled</td><td style=text-align:left>1min</td></tr><tr><td style=text-align:left>Slow query threshold</td><td style=text-align:left>100ms</td><td style=text-align:left>1000ms</td><td style=text-align:left>100ms</td></tr></tbody></table><h3 id=why-oltp-over-olap>Why OLTP over OLAP?</h3><ul><li>Queries are mostly simple point/range lookups</li><li>Transaction response time requires milliseconds</li><li>High concurrent connections</li><li>No complex analytical queries</li></ul><h3 id=why-oltp-over-crit>Why OLTP over CRIT?</h3><ul><li>Small probability of data loss acceptable (async replication)</li><li>Complete audit logs not required</li><li>Better write performance desired</li></ul><hr><h2 id=performance-tuning-tips>Performance Tuning Tips</h2><h3 id=connection-pooling>Connection Pooling</h3><p>For high concurrency, use PgBouncer connection pool:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbouncer </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_poolmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># transaction-level pooling</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=read-separation>Read Separation</h3><p>Use read replicas to share read load:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=monitoring-metrics>Monitoring Metrics</h3><p>Focus on these metrics:</p><ul><li><strong>Connections</strong>: Active/waiting connection counts</li><li><strong>Transaction rate</strong>: TPS, commit/rollback ratio</li><li><strong>Response time</strong>: Query latency percentiles (p50/p95/p99)</li><li><strong>Lock waits</strong>: Lock wait time, deadlock counts</li><li><strong>Replication lag</strong>: Replica delay time and bytes</li></ul><hr><h2 id=references>References</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>: PostgreSQL config template selection</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>: OS tuning template, should match <code>pg_conf</code></li><li><a href=olap><strong>OLAP Template</strong></a>: Analytics template comparison</li><li><a href=crit><strong>CRIT Template</strong></a>: Critical business template comparison</li><li><a href=tiny><strong>TINY Template</strong></a>: Micro instance template comparison</li><li><a href=/docs/pgsql/config/cluster>Cluster Config</a>: PostgreSQL cluster type configuration</li><li><a href=/docs/concept/ha>High Availability</a>: HA architecture design</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-571aa5133064fa24ac707a69e4d84659>17.3 - OLAP Template</h1><div class=lead>PostgreSQL config template optimized for online analytical processing workloads</div><p><code>olap.yml</code> is optimized for <strong>online analytical processing</strong> (OLAP). Designed for 4-128 core CPUs with support for large queries, high parallelism, relaxed timeouts, and aggressive vacuum.</p><blockquote><p>Pair with <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>olap</code> for OS-level tuning.</p></blockquote><hr><h2 id=use-cases>Use Cases</h2><p>OLAP template is ideal for:</p><ul><li><strong>Data warehouses</strong>: Historical data storage, multidimensional analysis</li><li><strong>BI reports</strong>: Complex report queries, dashboard data sources</li><li><strong>ETL processing</strong>: Data extraction, transformation, loading</li><li><strong>Data analysis</strong>: Ad-hoc queries, data exploration</li><li><strong>HTAP mixed workloads</strong>: Analytical replicas</li></ul><p><strong>Workload characteristics</strong>:</p><ul><li>Complex queries (seconds to minutes)</li><li>Low concurrent connections (tens to hundreds)</li><li>Read-intensive, writes typically batch operations</li><li>Throughput-sensitive, tolerates higher latency</li><li>Scans large data volumes</li></ul><hr><h2 id=usage>Usage</h2><p>Specify <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <code>olap.yml</code> in cluster definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-olap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-olap</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL analytics template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS analytics tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Use <a href=olap><strong><code>olap.yml</code></strong></a> template for dedicated offline replicas:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-mixed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: offline, pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># offline analytics replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-mixed</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary and online replicas use OLTP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS OLTP tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=parameter-details>Parameter Details</h2><h3 id=connection-management>Connection Management</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>OLAP scenarios typically don&rsquo;t need many connections; 500 is sufficient for most analytical workloads.</p><h3 id=memory-config>Memory Config</h3><p>OLAP template uses more aggressive memory allocation:</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>Formula</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>mem × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>Default ratio 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × <strong>50%</strong></td><td style=text-align:left>Faster index creation and VACUUM</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>64MB - <strong>8GB</strong></td><td style=text-align:left>Larger sort/hash memory</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>total mem - shared_buffers</td><td style=text-align:left>Estimated cache memory</td></tr></tbody></table><p><strong>work_mem calculation</strong> (differs from OLTP):</p><pre tabindex=0><code>work_mem = min(max(shared_buffers / max_connections, 64MB), 8GB)
</code></pre><p>Larger <code>work_mem</code> allows bigger sort and hash operations in memory, avoiding disk spill.</p><h3 id=locks--transactions>Locks & Transactions</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_locks_per_transaction: 2-4x maxconn   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span>-<span style=color:#000>2x</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>OLAP queries may involve more tables (partitions, many JOINs), requiring more lock slots.</p><h3 id=parallel-query>Parallel Query</h3><p>OLAP template aggressively enables parallel queries:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes: cpu + 12 (min 20)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cpu + 8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers: 80% × cpu (min 2)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000>%</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather: 50% × cpu   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000>% (max 8)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_maintenance_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000>% × cpu</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Parallel cost estimates use defaults to favor parallel plans:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># parallel_setup_cost: 1000    # default, not doubled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># parallel_tuple_cost: 0.1     # default, not doubled</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Partition-wise optimization enabled:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>enable_partitionwise_join</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># smart partition JOIN</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>enable_partitionwise_aggregate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># smart partition aggregation</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=io-config-pg17>IO Config (PG17+)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>io_workers: 50% × cpu (4-32)    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000>% (4-16)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>More IO workers support parallel large table scans.</p><h3 id=wal-config>WAL Config</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disk/20 (max 200GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disk/5 (max 2000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_slot_wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disk×3/10 (max 3000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>temp_file_limit: disk/5 (max 2000GB)   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disk/20</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Larger <code>temp_file_limit</code> allows bigger intermediate results to spill to disk.</p><h3 id=vacuum-config>Vacuum Config</h3><p>OLAP template uses aggressive vacuum settings:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_delay: 10ms         # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms, faster vacuum</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_limit: 10000        # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>more work per round</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_max_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_naptime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_vacuum_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.08</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_analyze_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.04</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Analytical databases often have bulk writes requiring aggressive vacuum to reclaim space.</p><h3 id=query-optimization>Query Optimization</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>random_page_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>effective_io_concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>default_statistics_target: 1000    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>more precise stats</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Higher <code>default_statistics_target</code> provides more accurate query plans, crucial for complex analytics.</p><h3 id=logging--monitoring>Logging & Monitoring</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>100ms, relaxed threshold</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_checkpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_lock_waits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_temp_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_autovacuum_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_cost_delay_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># PG18+, track vacuum cost delay</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=client-timeouts>Client Timeouts</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deadlock_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout: 0   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min, disabled</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Analytical queries may need to hold transactions for extended periods, so idle timeout is disabled.</p><hr><h2 id=key-differences-from-oltp>Key Differences from OLTP</h2><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left><a href=olap><strong>OLAP</strong></a></th><th style=text-align:left><a href=oltp><strong>OLTP</strong></a></th><th style=text-align:left>Reason</th></tr></thead><tbody><tr><td style=text-align:left>max_connections</td><td style=text-align:left>500</td><td style=text-align:left>500-1000</td><td style=text-align:left>Fewer analytical connections</td></tr><tr><td style=text-align:left>work_mem limit</td><td style=text-align:left>8GB</td><td style=text-align:left>1GB</td><td style=text-align:left>Support larger in-memory sorts</td></tr><tr><td style=text-align:left>maintenance_work_mem</td><td style=text-align:left>50% buffer</td><td style=text-align:left>25% buffer</td><td style=text-align:left>Faster index creation</td></tr><tr><td style=text-align:left>max_locks_per_transaction</td><td style=text-align:left>2-4x</td><td style=text-align:left>1-2x</td><td style=text-align:left>More tables in queries</td></tr><tr><td style=text-align:left>max_parallel_workers</td><td style=text-align:left>80% cpu</td><td style=text-align:left>50% cpu</td><td style=text-align:left>Aggressive parallelism</td></tr><tr><td style=text-align:left>max_parallel_workers_per_gather</td><td style=text-align:left>50% cpu</td><td style=text-align:left>20% cpu</td><td style=text-align:left>Aggressive parallelism</td></tr><tr><td style=text-align:left>parallel_setup_cost</td><td style=text-align:left>1000</td><td style=text-align:left>2000</td><td style=text-align:left>Default, encourages parallel</td></tr><tr><td style=text-align:left>parallel_tuple_cost</td><td style=text-align:left>0.1</td><td style=text-align:left>0.2</td><td style=text-align:left>Default, encourages parallel</td></tr><tr><td style=text-align:left>enable_partitionwise_join</td><td style=text-align:left>on</td><td style=text-align:left>off</td><td style=text-align:left>Partition optimization</td></tr><tr><td style=text-align:left>enable_partitionwise_aggregate</td><td style=text-align:left>on</td><td style=text-align:left>off</td><td style=text-align:left>Partition optimization</td></tr><tr><td style=text-align:left>vacuum_cost_delay</td><td style=text-align:left>10ms</td><td style=text-align:left>20ms</td><td style=text-align:left>Aggressive vacuum</td></tr><tr><td style=text-align:left>vacuum_cost_limit</td><td style=text-align:left>10000</td><td style=text-align:left>2000</td><td style=text-align:left>Aggressive vacuum</td></tr><tr><td style=text-align:left>temp_file_limit</td><td style=text-align:left>1/5 disk</td><td style=text-align:left>1/20 disk</td><td style=text-align:left>Allow larger temp files</td></tr><tr><td style=text-align:left>io_workers</td><td style=text-align:left>50% cpu</td><td style=text-align:left>25% cpu</td><td style=text-align:left>More parallel IO</td></tr><tr><td style=text-align:left>log_min_duration_statement</td><td style=text-align:left>1000ms</td><td style=text-align:left>100ms</td><td style=text-align:left>Relaxed slow query threshold</td></tr><tr><td style=text-align:left>default_statistics_target</td><td style=text-align:left>1000</td><td style=text-align:left>400</td><td style=text-align:left>More precise stats</td></tr><tr><td style=text-align:left>idle_in_transaction_session_timeout</td><td style=text-align:left>Disabled</td><td style=text-align:left>10min</td><td style=text-align:left>Allow long transactions</td></tr></tbody></table><hr><h2 id=performance-tuning-tips>Performance Tuning Tips</h2><h3 id=with-timescaledb>With TimescaleDB</h3><p>OLAP template works great with TimescaleDB:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-timeseries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>timescaledb</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=with-pg_duckdb>With pg_duckdb</h3><p>For ultimate analytical performance, combine with pg_duckdb:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-analytics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_duckdb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=columnar-storage>Columnar Storage</h3><p>Consider columnar storage extensions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>citus_columnar </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># or pg_mooncake</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=resource-isolation>Resource Isolation</h3><p>For mixed workloads, isolate analytics to dedicated replicas:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-mixed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLTP writes</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLTP reads</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLAP analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-mixed</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=monitoring-metrics>Monitoring Metrics</h3><p>Focus on these metrics:</p><ul><li><strong>Query time</strong>: Long query execution time distribution</li><li><strong>Parallelism</strong>: Parallel worker utilization</li><li><strong>Temp files</strong>: Temp file size and count</li><li><strong>Disk IO</strong>: Sequential and index scan IO volume</li><li><strong>Cache hit ratio</strong>: shared_buffers and OS cache hit rates</li></ul><hr><h2 id=references>References</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>: PostgreSQL config template selection</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>: OS tuning template, should match <code>pg_conf</code></li><li><a href=oltp><strong>OLTP Template</strong></a>: Transaction template comparison</li><li><a href=crit><strong>CRIT Template</strong></a>: Critical business template comparison</li><li><a href=tiny><strong>TINY Template</strong></a>: Micro instance template comparison</li><li><a href=/docs/pgsql/config/cluster#offline-replica>Offline Replica</a>: Dedicated analytics instances</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7cf828587f72da3b425e1bd025ccbacf>17.4 - CRIT Template</h1><div class=lead>PostgreSQL config template optimized for critical/financial workloads with data safety and audit compliance</div><p><code>crit.yml</code> is optimized for <strong>critical/financial workloads</strong>. Designed for 4-128 core CPUs with forced sync replication, data checksums, full audit logging, and strict security. Trades performance for maximum data safety.</p><blockquote><p>Pair with <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>crit</code> for OS-level tuning, optimizing dirty page management.</p></blockquote><hr><h2 id=use-cases>Use Cases</h2><p>CRIT template is ideal for:</p><ul><li><strong>Financial transactions</strong>: Bank transfers, payment settlement, securities trading</li><li><strong>Core accounting</strong>: General ledger systems, accounting systems</li><li><strong>Compliance audit</strong>: Businesses requiring complete operation records</li><li><strong>Critical business</strong>: Any scenario that cannot tolerate data loss</li></ul><p><strong>Requirements</strong>:</p><ul><li>Zero data loss (RPO = 0)</li><li>Data integrity verification</li><li>Complete audit logs</li><li>Strict security policies</li><li>Acceptable performance trade-offs</li></ul><hr><h2 id=usage>Usage</h2><p>Specify <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <code>crit.yml</code> in cluster definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-finance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-finance</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL critical template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS critical tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Recommendation</strong>: Critical clusters should have at least 3 nodes to maintain sync replication when one node fails.</p><hr><h2 id=core-features>Core Features</h2><h3 id=forced-sync-replication>Forced Sync Replication</h3><p>CRIT template <strong>forces sync replication</strong> regardless of <a href=/docs/pgsql/param#pg_rpo><code>pg_rpo</code></a> setting:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># forced on, ignores pg_rpo</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Every transaction commit waits for at least one replica confirmation, ensuring <strong>RPO = 0</strong> (zero data loss).</p><p><strong>Cost</strong>: Write latency increases (typically 1-5ms depending on network).</p><h3 id=forced-data-checksums>Forced Data Checksums</h3><p>CRIT template <strong>forces data checksums</strong> regardless of <a href=/docs/pgsql/param#pg_checksum><code>pg_checksum</code></a> setting:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>initdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>data-checksums  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># forced on, ignores pg_checksum</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Data checksums detect silent disk corruption (bit rot), critical for financial data.</p><h3 id=disabled-parallel-query>Disabled Parallel Query</h3><p>CRIT template disables parallel query gather operations:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># parallel queries disabled</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Parallel cost estimates are also increased:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_setup_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_tuple_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_table_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_index_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Reason</strong>: Parallel queries may cause unstable latency. For latency-sensitive financial transactions, predictable stable performance is more important.</p><hr><h2 id=parameter-details>Parameter Details</h2><h3 id=connection-management>Connection Management</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#000>/1000  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># depends on pgbouncer usage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Same as OLTP template.</p><h3 id=memory-config>Memory Config</h3><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>Formula</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>mem × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>Default ratio 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × 25%</td><td style=text-align:left>For VACUUM, CREATE INDEX</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>64MB - 1GB</td><td style=text-align:left>Same as OLTP</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>total mem - shared_buffers</td><td style=text-align:left>Estimated cache memory</td></tr></tbody></table><h3 id=wal-config-key-differences>WAL Config (Key Differences)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_delay: 10ms              # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms, more frequent flush</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_flush_after: 0           # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1MB, immediate flush, no buffer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_replication_slot_timeout: 3d   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>7d, stricter slot cleanup</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>wal_writer_flush_after: 0</code> ensures every WAL write flushes to disk immediately, minimizing data loss risk.</p><h3 id=replication-config-pg15->Replication Config (PG15-)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_defer_cleanup_age</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># PG15 and below only</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Preserves 500K recent transactions from vacuum cleanup, providing more catchup buffer for replicas.</p><h3 id=audit-logging-key-differences>Audit Logging (Key Differences)</h3><p>CRIT template enables full connection audit:</p><p><strong>PostgreSQL 18+</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;receipt,authentication,authorization&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>PostgreSQL 17 and below</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_disconnections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Records complete connection lifecycle:</p><ul><li>Connection receipt</li><li>Authentication process</li><li>Authorization result</li><li>Disconnection</li></ul><h3 id=query-logging>Query Logging</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># log queries &gt; 100ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># log all DDL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size: 32768    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>capture full queries</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>32KB <code>track_activity_query_size</code> ensures capturing complete long query text.</p><h3 id=statistics-tracking>Statistics Tracking</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_cost_delay_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># PG18+, track vacuum cost delay</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32768</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=client-timeouts-key-differences>Client Timeouts (Key Differences)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout: 1min   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min, stricter</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>1-minute idle transaction timeout quickly releases zombie transactions holding locks.</p><h3 id=extension-config>Extension Config</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;$libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Note</strong>: CRIT template loads <code>passwordcheck</code> by default, enforcing password complexity.</p><hr><h2 id=key-differences-from-oltp>Key Differences from OLTP</h2><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left><a href=crit><strong>CRIT</strong></a></th><th style=text-align:left><a href=oltp><strong>OLTP</strong></a></th><th style=text-align:left>Reason</th></tr></thead><tbody><tr><td style=text-align:left>synchronous_mode</td><td style=text-align:left><strong>Forced true</strong></td><td style=text-align:left>Depends on pg_rpo</td><td style=text-align:left>Zero data loss</td></tr><tr><td style=text-align:left>data-checksums</td><td style=text-align:left><strong>Forced on</strong></td><td style=text-align:left>Optional</td><td style=text-align:left>Data integrity</td></tr><tr><td style=text-align:left>max_parallel_workers_per_gather</td><td style=text-align:left><strong>0</strong></td><td style=text-align:left>20% cpu</td><td style=text-align:left>Stable latency</td></tr><tr><td style=text-align:left>wal_writer_delay</td><td style=text-align:left>10ms</td><td style=text-align:left>20ms</td><td style=text-align:left>More frequent flush</td></tr><tr><td style=text-align:left>wal_writer_flush_after</td><td style=text-align:left><strong>0</strong></td><td style=text-align:left>1MB</td><td style=text-align:left>Immediate flush</td></tr><tr><td style=text-align:left>idle_replication_slot_timeout</td><td style=text-align:left>3d</td><td style=text-align:left>7d</td><td style=text-align:left>Stricter cleanup</td></tr><tr><td style=text-align:left>idle_in_transaction_session_timeout</td><td style=text-align:left><strong>1min</strong></td><td style=text-align:left>10min</td><td style=text-align:left>Quick lock release</td></tr><tr><td style=text-align:left>track_activity_query_size</td><td style=text-align:left><strong>32KB</strong></td><td style=text-align:left>8KB</td><td style=text-align:left>Complete query capture</td></tr><tr><td style=text-align:left>log_connections</td><td style=text-align:left><strong>Full logging</strong></td><td style=text-align:left>Auth only</td><td style=text-align:left>Audit compliance</td></tr><tr><td style=text-align:left>log_disconnections</td><td style=text-align:left><strong>on</strong></td><td style=text-align:left>off</td><td style=text-align:left>Audit compliance</td></tr><tr><td style=text-align:left>passwordcheck</td><td style=text-align:left><strong>Enabled</strong></td><td style=text-align:left>Not enabled</td><td style=text-align:left>Password security</td></tr><tr><td style=text-align:left>vacuum_defer_cleanup_age</td><td style=text-align:left>500000</td><td style=text-align:left>0</td><td style=text-align:left>Replica catchup buffer</td></tr></tbody></table><hr><h2 id=performance-impact>Performance Impact</h2><p>Using CRIT template has these impacts:</p><h3 id=increased-write-latency>Increased Write Latency</h3><p>Sync replication adds 1-5ms write latency (network-dependent):</p><pre tabindex=0><code>Async replication: commit -&gt; local flush -&gt; return to client
Sync replication:  commit -&gt; local flush -&gt; wait replica confirm -&gt; return to client
</code></pre><h3 id=reduced-write-throughput>Reduced Write Throughput</h3><p>Due to replica confirmation wait, write TPS may drop 10-30%.</p><h3 id=more-stable-query-latency>More Stable Query Latency</h3><p>With parallel queries disabled, query latency is more predictable without parallel startup overhead variance.</p><h3 id=slightly-increased-resource-overhead>Slightly Increased Resource Overhead</h3><p>More frequent WAL flushes and complete audit logs add extra IO overhead.</p><hr><h2 id=ha-configuration>HA Configuration</h2><h3 id=minimum-recommended-setup>Minimum Recommended Setup</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-critical</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-critical</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL critical template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS critical tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>3-node setup ensures sync replication continues when one node fails.</p><h3 id=cross-dc-deployment>Cross-DC Deployment</h3><p>For financial-grade disaster recovery:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-critical</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># DC A</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica, pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># DC A</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.20.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica, pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># DC B (standby)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-critical</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL critical template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS critical tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=quorum-commit>Quorum Commit</h3><p>For higher consistency, configure multiple sync replicas:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-critical
</span></span><span style=display:flex><span>synchronous_mode: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>synchronous_node_count: <span style=color:#0000cf;font-weight:700>2</span>    <span style=color:#8f5902;font-style:italic># require 2 replica confirmations</span>
</span></span></code></pre></div><hr><h2 id=security-hardening-tips>Security Hardening Tips</h2><h3 id=password-policy>Password Policy</h3><p>CRIT template has <code>passwordcheck</code> enabled; further configure:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Set password encryption
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>password_encryption</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;scram-sha-256&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=audit-extension>Audit Extension</h3><p>Consider <code>pgaudit</code> for detailed auditing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain, pgaudit&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgaudit.log</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;ddl, role, write&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=network-isolation>Network Isolation</h3><p>Ensure database network is isolated; use <a href=/docs/pgsql/config/hba>HBA rules</a> to restrict access.</p><hr><h2 id=monitoring-metrics>Monitoring Metrics</h2><p>For critical clusters, focus on:</p><ul><li><strong>Replication lag</strong>: Sync lag should be near zero</li><li><strong>Transaction commit time</strong>: p99 latency</li><li><strong>Lock waits</strong>: Long lock waits may impact business</li><li><strong>Checkpoints</strong>: Checkpoint duration and frequency</li><li><strong>WAL generation rate</strong>: Predict disk space needs</li></ul><hr><h2 id=references>References</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>: PostgreSQL config template selection</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>: OS tuning template, should match <code>pg_conf</code></li><li><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a>: Recovery point objective parameter</li><li><a href=oltp><strong>OLTP Template</strong></a>: Transaction template comparison</li><li><a href=olap><strong>OLAP Template</strong></a>: Analytics template comparison</li><li><a href=tiny><strong>TINY Template</strong></a>: Micro instance template comparison</li><li><a href=/docs/pgsql/config/cluster#sync-standby>Sync Standby</a>: Sync replication configuration</li><li><a href=/docs/pgsql/config/cluster#quorum-commit>Quorum Commit</a>: Higher consistency level</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-609856237df74f1f0f6e5fba1111e545>17.5 - TINY Template</h1><div class=lead>PostgreSQL config template optimized for micro instances and resource-constrained environments</div><p><code>tiny.yml</code> is optimized for <strong>micro instances</strong> and resource-constrained environments. Designed for 1-3 core CPUs with minimal resource usage, conservative memory allocation, and disabled parallel queries.</p><blockquote><p>Pair with <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>tiny</code> for OS-level tuning.</p></blockquote><hr><h2 id=use-cases>Use Cases</h2><p>TINY template is ideal for:</p><ul><li><strong>Dev/test</strong>: Local development, CI/CD testing</li><li><strong>Low-spec VMs</strong>: 1-2 core CPU, 1-4GB RAM cloud instances</li><li><strong>Edge computing</strong>: Raspberry Pi, embedded devices</li><li><strong>Demos</strong>: Quick Pigsty experience</li><li><strong>Personal projects</strong>: Resource-limited blogs, small apps</li></ul><p><strong>Resource constraints</strong>:</p><ul><li>1-3 CPU cores</li><li>1-8 GB RAM</li><li>Limited disk space</li><li>May share resources with other services</li></ul><hr><h2 id=usage>Usage</h2><p>Specify <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <code>tiny.yml</code> in cluster definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-dev</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL micro instance template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS micro instance tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Single-node development:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>127.0.0.1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-local</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL micro instance template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS micro instance tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=parameter-details>Parameter Details</h2><h3 id=connection-management>Connection Management</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections: 250   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500-1000</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>reduced connection overhead</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Micro instances don&rsquo;t need many concurrent connections; 250 is sufficient for dev/test.</p><h3 id=memory-config>Memory Config</h3><p>TINY template uses conservative memory allocation:</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>Formula</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>mem × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>Default ratio 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × 25%</td><td style=text-align:left>For VACUUM, CREATE INDEX</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>16MB - <strong>256MB</strong></td><td style=text-align:left>Smaller sort/hash memory</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>total mem - shared_buffers</td><td style=text-align:left>Estimated cache memory</td></tr></tbody></table><p><strong>work_mem calculation</strong> (differs from OLTP):</p><pre tabindex=0><code>work_mem = min(max(shared_buffers / max_connections, 16MB), 256MB)
</code></pre><p>Smaller <code>work_mem</code> limit (256MB vs OLTP&rsquo;s 1GB) prevents memory exhaustion.</p><h3 id=parallel-query-fully-disabled>Parallel Query (Fully Disabled)</h3><p>TINY template completely disables parallel queries:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes: cpu + 4 (min 12)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cpu + 8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers: 50% × cpu (min 1)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000>% (min 2)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># parallel queries disabled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_maintenance_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000>% × cpu (min 1)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>max_parallel_workers_per_gather: 0</code> ensures queries won&rsquo;t spawn parallel workers, avoiding resource contention on low-core systems.</p><h3 id=io-config-pg17>IO Config (PG17+)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>io_workers: 3   # fixed value, OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000>% cpu (4-16)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Fixed low IO worker count suitable for resource-constrained environments.</p><h3 id=vacuum-config>Vacuum Config</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_max_workers: 2          # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>one fewer worker</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_naptime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># autovacuum_vacuum_scale_factor uses default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># autovacuum_analyze_scale_factor uses default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Fewer autovacuum workers reduce background resource usage.</p><h3 id=query-optimization>Query Optimization</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>random_page_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>effective_io_concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>default_statistics_target: 200     # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>lower precision saves space</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Lower <code>default_statistics_target</code> reduces <code>pg_statistic</code> table size.</p><h3 id=logging-config>Logging Config</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># same as OLTP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_checkpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_lock_waits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_temp_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># log_connections uses default (no extra logging)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>TINY template doesn&rsquo;t enable extra connection logging to reduce log volume.</p><h3 id=client-timeouts>Client Timeouts</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deadlock_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># same as OLTP</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=extension-config>Extension Config</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.max: 2500      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>reduced memory usage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_utility</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_planning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>pg_stat_statements.max</code> reduced from 10000 to 2500, saving ~75% memory.</p><hr><h2 id=key-differences-from-oltp>Key Differences from OLTP</h2><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left><a href=tiny><strong>TINY</strong></a></th><th style=text-align:left><a href=oltp><strong>OLTP</strong></a></th><th style=text-align:left>Reason</th></tr></thead><tbody><tr><td style=text-align:left>max_connections</td><td style=text-align:left><strong>250</strong></td><td style=text-align:left>500-1000</td><td style=text-align:left>Reduce connection overhead</td></tr><tr><td style=text-align:left>work_mem limit</td><td style=text-align:left><strong>256MB</strong></td><td style=text-align:left>1GB</td><td style=text-align:left>Prevent memory exhaustion</td></tr><tr><td style=text-align:left>max_worker_processes</td><td style=text-align:left>cpu+4</td><td style=text-align:left>cpu+8</td><td style=text-align:left>Fewer background processes</td></tr><tr><td style=text-align:left>max_parallel_workers_per_gather</td><td style=text-align:left><strong>0</strong></td><td style=text-align:left>20% cpu</td><td style=text-align:left>Disable parallel queries</td></tr><tr><td style=text-align:left>autovacuum_max_workers</td><td style=text-align:left><strong>2</strong></td><td style=text-align:left>3</td><td style=text-align:left>Reduce background load</td></tr><tr><td style=text-align:left>default_statistics_target</td><td style=text-align:left><strong>200</strong></td><td style=text-align:left>400</td><td style=text-align:left>Save space</td></tr><tr><td style=text-align:left>pg_stat_statements.max</td><td style=text-align:left><strong>2500</strong></td><td style=text-align:left>10000</td><td style=text-align:left>Reduce memory usage</td></tr><tr><td style=text-align:left>io_workers</td><td style=text-align:left><strong>3</strong></td><td style=text-align:left>25% cpu</td><td style=text-align:left>Fixed low value</td></tr></tbody></table><hr><h2 id=resource-estimates>Resource Estimates</h2><p>TINY template resource usage by configuration:</p><h3 id=1-core-1gb-ram>1 Core 1GB RAM</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~64MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~12</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>PostgreSQL process memory</strong>: ~400-600MB</p><h3 id=2-core-4gb-ram>2 Core 4GB RAM</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~1GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~32MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~12</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>PostgreSQL process memory</strong>: ~1.5-2GB</p><h3 id=4-core-8gb-ram>4 Core 8GB RAM</h3><p>Consider using OLTP template instead:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-small</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 4C8G can use OLTP template</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=performance-tuning-tips>Performance Tuning Tips</h2><h3 id=further-resource-reduction>Further Resource Reduction</h3><p>For extremely constrained resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># further reduce</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MB         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># further reduce</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>8MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=disable-unnecessary-extensions>Disable Unnecessary Extensions</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># keep only essential extensions</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=disable-unnecessary-features>Disable Unnecessary Features</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># disable IO timing tracking</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>none         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># disable function tracking</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=use-external-connection-pool>Use External Connection Pool</h3><p>Even on micro instances, PgBouncer significantly improves concurrency:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-tiny</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbouncer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_poolmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=cloud-platform-recommendations>Cloud Platform Recommendations</h2><h3 id=aws>AWS</h3><ul><li><strong>t3.micro</strong>: 1 vCPU, 1GB RAM - suitable for TINY</li><li><strong>t3.small</strong>: 2 vCPU, 2GB RAM - suitable for TINY</li><li><strong>t3.medium</strong>: 2 vCPU, 4GB RAM - consider OLTP</li></ul><h3 id=alibaba-cloud>Alibaba Cloud</h3><ul><li><strong>ecs.t6-c1m1.small</strong>: 1 vCPU, 1GB RAM - suitable for TINY</li><li><strong>ecs.t6-c1m2.small</strong>: 1 vCPU, 2GB RAM - suitable for TINY</li><li><strong>ecs.t6-c1m4.small</strong>: 1 vCPU, 4GB RAM - suitable for TINY</li></ul><h3 id=tencent-cloud>Tencent Cloud</h3><ul><li><strong>SA2.SMALL1</strong>: 1 vCPU, 1GB RAM - suitable for TINY</li><li><strong>SA2.SMALL2</strong>: 1 vCPU, 2GB RAM - suitable for TINY</li><li><strong>SA2.SMALL4</strong>: 1 vCPU, 4GB RAM - suitable for TINY</li></ul><hr><h2 id=edge-device-deployment>Edge Device Deployment</h2><h3 id=raspberry-pi-4>Raspberry Pi 4</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-pi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>192.168.1.100</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-pi</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL micro instance template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS micro instance tuning</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_storage_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>SSD   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># SSD storage recommended</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=docker-container>Docker Container</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-docker</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>172.17.0.2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-docker</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL micro instance template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OS micro instance tuning</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=upgrading-to-oltp>Upgrading to OLTP</h2><p>When your application grows and needs more resources, easily upgrade to <a href=oltp><strong>OLTP template</strong></a>:</p><ol><li>Upgrade VM specs (4 core 8GB+)</li><li>Modify cluster config:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-growing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># change from tiny.yml to oltp.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># change from tiny to oltp</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ol start=3><li><a href=/docs/pgsql/admin#configure-cluster>Reconfigure cluster</a> or redeploy</li></ol><hr><h2 id=references>References</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>: PostgreSQL config template selection</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>: OS tuning template, should match <code>pg_conf</code></li><li><a href=oltp><strong>OLTP Template</strong></a>: Transaction template, upgrade for 4C8G+</li><li><a href=olap><strong>OLAP Template</strong></a>: Analytics template</li><li><a href=crit><strong>CRIT Template</strong></a>: Critical business template</li><li><a href=/docs/setup/install#single-node-install>Single-Node Install</a>: Pigsty single-node installation guide</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-08a8dc2fb6ea8fd6936acfdf250bdc97>18 - PG Kernels</h1><div class=lead>How to use other PostgreSQL kernel forks in Pigsty? Such as Citus, Babelfish, IvorySQL, PolarDB, etc.</div><p>In Pigsty, you can replace the &ldquo;native PG kernel&rdquo; with different &ldquo;<strong>flavors</strong>&rdquo; of PostgreSQL forks to achieve special features and effects.</p><p>Pigsty supports various PostgreSQL kernels and compatible forks, enabling you to simulate different database systems while leveraging PostgreSQL&rsquo;s ecosystem. Each kernel provides unique capabilities and compatibility layers.</p><table class=full-width><thead><tr><th style=text-align:left>Kernel</th><th style=text-align:left>Key Feature</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql>PostgreSQL</a></td><td style=text-align:left><strong>Original Flavor</strong></td><td style=text-align:left>Vanilla PostgreSQL with 440 extensions</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/citus>Citus</a></td><td style=text-align:left><strong>Horizontal Scaling</strong></td><td style=text-align:left>Distributed PostgreSQL via native extension</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/babelfish>WiltonDB</a></td><td style=text-align:left><strong>SQL Server Compatible</strong></td><td style=text-align:left>SQL Server wire-protocol compatibility</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/ivorysql>IvorySQL</a></td><td style=text-align:left><strong>Oracle Compatible</strong></td><td style=text-align:left>Oracle syntax and PL/SQL compatibility</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/openhalo>OpenHalo</a></td><td style=text-align:left><strong>MySQL Compatible</strong></td><td style=text-align:left>MySQL wire-protocol compatibility</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/percona>Percona</a></td><td style=text-align:left><strong>Transparent Encryption</strong></td><td style=text-align:left>Percona Distribution with pg_tde</td></tr><tr><td style=text-align:left><a href=/docs/ferret>FerretDB</a></td><td style=text-align:left><strong>MongoDB Migration</strong></td><td style=text-align:left>MongoDB wire-protocol compatibility</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/orioledb>OrioleDB</a></td><td style=text-align:left><strong>OLTP Optimization</strong></td><td style=text-align:left>Zheap, No bloat, S3 Storage</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/polardb>PolarDB</a></td><td style=text-align:left><strong>Aurora-style RAC</strong></td><td style=text-align:left>RAC, China domestic compliance</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/supabase>Supabase</a></td><td style=text-align:left><strong>Backend as a Service</strong></td><td style=text-align:left>BaaS based on PostgreSQL, Firebase alternative</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/cloudberry>Cloudberry</a></td><td style=text-align:left><strong>MPP DW & Analytics</strong></td><td style=text-align:left>Massively parallel processing data warehouse</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-6b647bd80a1130f992c12a77393a87c3>18.1 - PostgreSQL</h1><div class=lead>Vanilla PostgreSQL kernel with 440 extensions</div><p><a href=https://www.postgresql.org/>PostgreSQL</a> is the world&rsquo;s most advanced and popular open-source database.</p><p>Pigsty supports PostgreSQL 13 ~ 18 and provides 440 PG extensions.</p><hr><h2 id=quick-start>Quick Start</h2><p><a href=/docs/setup/install><strong>Install</strong></a> Pigsty using the <a href=https://github.com/pgsty/pigsty/blob/main/conf/pgsql.yml><code>pgsql</code></a> configuration template.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c pgsql     <span style=color:#8f5902;font-style:italic># Use postgres kernel</span>
</span></span><span style=display:flex><span>./deploy.yml             <span style=color:#8f5902;font-style:italic># Set up everything with pigsty</span>
</span></span></code></pre></div><p>Most <a href=/docs/conf/>configuration templates</a> use PostgreSQL kernel by default, for example:</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/meta.yml><code>meta</code></a> : <strong>Default</strong>, postgres with core extensions (vector, postgis, timescale)</li><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/rich.yml><code>rich</code></a> : postgres with all extensions installed</li><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/slim.yml><code>slim</code></a> : postgres only, no monitoring infrastructure</li><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/full.yml><code>full</code></a> : 4-node sandbox for HA demonstration</li><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/pgsql.yml><code>pgsql</code></a> : minimal postgres kernel configuration example</li></ul><hr><h2 id=configuration>Configuration</h2><p>Vanilla PostgreSQL kernel requires no special adjustments:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin   ] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta, baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>vector ]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Full backup at 1 AM daily</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main, pgsql-common ]  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg kernel and common utilities</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#pg_extensions: [ pg18-time ,pg18-gis ,pg18-rag ,pg18-fts ,pg18-olap ,pg18-feat ,pg18-lang ,pg18-type ,pg18-util ,pg18-func ,pg18-admin ,pg18-stat ,pg18-sec ,pg18-fdw ,pg18-sim ,pg18-etl]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=version-selection>Version Selection</h2><p>To use a different PostgreSQL major version, you can configure it using the <code>-v</code> parameter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c pgsql            <span style=color:#8f5902;font-style:italic># Default is postgresql 18, no need to specify explicitly</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>17</span>      <span style=color:#8f5902;font-style:italic># Use postgresql 17</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>16</span>      <span style=color:#8f5902;font-style:italic># Use postgresql 16</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>15</span>      <span style=color:#8f5902;font-style:italic># Use postgresql 15</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>14</span>      <span style=color:#8f5902;font-style:italic># Use postgresql 14</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>13</span>      <span style=color:#8f5902;font-style:italic># Use postgresql 13</span>
</span></span></code></pre></div><p>If a PostgreSQL cluster is already installed, you need to uninstall it before installing a new version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml <span style=color:#8f5902;font-style:italic># -l pg-meta</span>
</span></span></code></pre></div><hr><h2 id=extension-ecosystem>Extension Ecosystem</h2><p>Pigsty provides a rich extension ecosystem for PostgreSQL, including:</p><ul><li><strong>Time-series</strong>: timescaledb, pg_cron, periods</li><li><strong>Geospatial</strong>: postgis, h3, pgrouting</li><li><strong>Vector</strong>: pgvector, pgml, vchord</li><li><strong>Search</strong>: pg_trgm, zhparser, pgroonga</li><li><strong>Analytics</strong>: citus, pg_duckdb, pg_analytics</li><li><strong>Features</strong>: age, pg_graphql, rum</li><li><strong>Languages</strong>: plpython3u, pljava, plv8</li><li><strong>Types</strong>: hstore, ltree, citext</li><li><strong>Utilities</strong>: http, pg_net, pgjwt</li><li><strong>Functions</strong>: pgcrypto, uuid-ossp, pg_uuidv7</li><li><strong>Administration</strong>: pg_repack, pgagent, pg_squeeze</li><li><strong>Statistics</strong>: pg_stat_statements, pg_qualstats, auto_explain</li><li><strong>Security</strong>: pgaudit, pgcrypto, pgsodium</li><li><strong>Foreign</strong>: postgres_fdw, mysql_fdw, oracle_fdw</li><li><strong>Compatibility</strong>: orafce, babelfishpg_tds</li><li><strong>Data</strong>: pglogical, wal2json, decoderbufs</li></ul><p>For details, please refer to <a href=https://pgext.cloud/list>Extension Catalog</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2f9342f89a206383c945315b79c7967f>18.2 - Supabase</h1><div class=lead>How to self-host Supabase with Pigsty, deploy an open-source Firebase alternative with a complete backend stack in one click.</div><blockquote><p><a href=https://supabase.com/>Supabase</a> — Build in a weekend, Scale to millions</p></blockquote><p>Supabase is an open-source Firebase alternative that wraps PostgreSQL and provides authentication, out-of-the-box APIs, edge functions, real-time subscriptions, object storage, and vector embedding capabilities.
This is a low-code all-in-one backend platform that lets you skip most backend development work, requiring only database design and frontend knowledge to quickly ship products!</p><p>Supabase&rsquo;s motto is: &ldquo;<strong>Build in a weekend, Scale to millions</strong>&rdquo;. Indeed, Supabase is <a href=https://supabase.com/pricing>extremely cost-effective</a> at small to micro scales (4c8g), like a cyber bodhisattva.
— But when you really scale to millions of users — you should seriously consider self-hosting Supabase — whether for functionality, performance, or cost considerations.</p><p>Pigsty provides you with a complete one-click self-hosting solution for Supabase. Self-hosted Supabase enjoys full PostgreSQL monitoring, IaC, PITR, and high availability,
and compared to Supabase cloud services, it provides up to <a href=https://pgext.cloud><strong>440</strong></a> out-of-the-box PostgreSQL extensions and can more fully utilize the performance and cost advantages of modern hardware.</p><p>For the complete self-hosting tutorial, please refer to: <a href=/docs/app/supabase><strong>Supabase Self-Hosting Guide</strong></a></p><p><img src=/img/pigsty/supabase.webp alt></p><hr><h2 id=quick-start>Quick Start</h2><p>Pigsty&rsquo;s default <a href=https://github.com/pgsty/pigsty/blob/main/conf/supa.yml><code>supa.yml</code></a> configuration template defines a single-node Supabase.</p><p>First, use Pigsty&rsquo;s <a href=/docs/setup/install>standard installation process</a> to install the MinIO and PostgreSQL instances required for Supabase:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash
</span></span><span style=display:flex><span>./bootstrap          <span style=color:#8f5902;font-style:italic># Environment check, install dependencies</span>
</span></span><span style=display:flex><span>./configure -c supa  <span style=color:#8f5902;font-style:italic># Important: modify passwords and other key info in config!</span>
</span></span><span style=display:flex><span>./deploy.yml         <span style=color:#8f5902;font-style:italic># Install Pigsty, deploy PGSQL and MINIO!</span>
</span></span></code></pre></div><p>Before deploying Supabase, please modify the <a href=#configuration-details>Supabase parameters</a> in the <code>pigsty.yml</code> config file according to your actual situation (mainly passwords!)</p><p>Then, run <a href=/docs/docker/playbook><code>docker.yml</code></a> and <a href=/docs/docker/playbook><code>app.yml</code></a> to complete the remaining work and deploy Supabase containers:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./docker.yml       <span style=color:#8f5902;font-style:italic># Install Docker module</span>
</span></span><span style=display:flex><span>./app.yml          <span style=color:#8f5902;font-style:italic># Start Supabase stateless components!</span>
</span></span></code></pre></div><p>For users in China, please configure appropriate Docker mirror sites or proxy servers to bypass GFW to pull DockerHub images.
For <a href=/docs/about/service>professional subscriptions</a>, we provide the ability to <a href=/docs/setup/offline>offline install</a> Pigsty and Supabase without internet access.</p><p>Pigsty exposes web services through Nginx on the admin node/INFRA node by default. You can add DNS resolution for <code>supa.pigsty</code> pointing to this node locally,
then access <code>https://supa.pigsty</code> through a browser to enter the Supabase Studio management interface.</p><blockquote><p>Default username and password: supabase / pigsty</p></blockquote><link rel=stylesheet href=/css/asciinema-player.css><script src=/js/asciinema-player.min.js></script><div id=asciinema-913fe6b5e34ef94a5d10a82176a4fd69 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-913fe6b5e34ef94a5d10a82176a4fd69",o="/demo/supabase.cast",e="solarized-light",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[0,"Check"],[11,"Install"],[43,"Config"],[307,"Docker"],[321,"Domain"],[340,"App"],[350,"Verify"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script></div><div class=td-content style=page-break-before:always><h1 id=pg-5e2941fff6b5b682be30d52c9d82b986>18.3 - Percona</h1><div class=lead>Percona Postgres distribution with TDE transparent encryption support</div><p><a href=https://www.percona.com/postgresql/software/postgresql-distribution>Percona Postgres</a> is a patched Postgres kernel with <a href=https://docs.percona.com/pg-tde/index.html><code>pg_tde</code></a> (Transparent Data Encryption) extension.</p><p>It&rsquo;s compatible with PostgreSQL 18.1 and available on all Pigsty-supported platforms.</p><ul><li><a href=https://andreas.scherbaum.la/post/2025-06-30_performance-test-for-percona-transparent-data-encryption-tde/>Performance Test for Percona Transparent Data Encryption (TDE)</a></li></ul><hr><h2 id=quick-start>Quick Start</h2><p>Use Pigsty&rsquo;s <a href=/docs/setup/install><strong>standard installation process</strong></a> with the <a href=https://github.com/pgsty/pigsty/blob/main/conf/pgtde.yml><code>pgtde</code></a> configuration template.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>./configure -c pgtde     <span style=color:#8f5902;font-style:italic># Use percona postgres kernel</span>
</span></span><span style=display:flex><span>./deploy.yml             <span style=color:#8f5902;font-style:italic># Set up everything with pigsty</span>
</span></span></code></pre></div><hr><h2 id=configuration>Configuration</h2><p>The following parameters need to be adjusted to deploy a Percona cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin   ] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty tde database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>vector, postgis, pg_tde ,pgaudit, { name: pg_stat_monitor, schema: monitor } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Full backup at 1 AM daily</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Percona PostgreSQL TDE specific settings</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>percona-main, pgsql-common ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Install percona postgres packages</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_tde, pgaudit, pg_stat_statements, pg_stat_monitor, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=extensions>Extensions</h2><p>Percona provides 80 available extensions, including <code>pg_tde</code>, <code>pgvector</code>, <code>postgis</code>, <code>pgaudit</code>, <code>set_user</code>, <code>pg_stat_monitor</code>, and other useful third-party extensions.</p><table><thead><tr><th>Extension</th><th>Version</th><th>Description</th></tr></thead><tbody><tr><td>pg_tde</td><td>2.1</td><td>Percona transparent data encryption access method</td></tr><tr><td>vector</td><td>0.8.1</td><td>Vector data type and ivfflat and hnsw access methods</td></tr><tr><td>postgis</td><td>3.5.4</td><td>PostGIS geometry and geography types and functions</td></tr><tr><td>pgaudit</td><td>18.0</td><td>Provides auditing functionality</td></tr><tr><td>pg_stat_monitor</td><td>2.3</td><td>PostgreSQL query performance monitoring tool</td></tr><tr><td>set_user</td><td>4.2.0</td><td>Similar to SET ROLE but with additional logging</td></tr><tr><td>pg_repack</td><td>1.5.3</td><td>Reorganize tables in PostgreSQL databases with minimal locks</td></tr><tr><td>hstore</td><td>1.8</td><td>Data type for storing sets of (key, value) pairs</td></tr><tr><td>ltree</td><td>1.3</td><td>Data type for hierarchical tree-like structures</td></tr><tr><td>pg_trgm</td><td>1.6</td><td>Text similarity measurement and index searching based on trigrams</td></tr></tbody></table><p>For the complete list of 80 extensions, please refer to the <a href=https://docs.percona.com/postgresql/18/extensions.html>Percona Postgres official documentation</a>.</p><hr><h2 id=key-features>Key Features</h2><ul><li><strong>Transparent Data Encryption</strong>: Provides data-at-rest encryption using the pg_tde extension</li><li><strong>PostgreSQL 18 Compatible</strong>: Based on the latest PostgreSQL 18 version</li><li><strong>Enterprise Extensions</strong>: Includes enterprise-grade features like pgaudit, pg_stat_monitor</li><li><strong>Complete Ecosystem</strong>: Supports popular extensions like pgvector, PostGIS</li></ul><blockquote><p><strong>Note</strong>: Currently in stable stage - thoroughly evaluate before production use.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-8b89390bfb5e407f5413ce18cede184b>18.4 - OpenHalo</h1><div class=lead>MySQL compatible Postgres 14 fork</div><p><a href=https://www.openhalo.org/>OpenHalo</a> is an open-source PostgreSQL kernel that provides MySQL wire protocol compatibility.</p><p>OpenHalo is based on PostgreSQL 14.10 kernel version and provides wire protocol compatibility with MySQL 5.7.32-log / 8.0 versions.</p><p>Pigsty provides deployment support for OpenHalo on all supported Linux platforms.</p><hr><h2 id=quick-start>Quick Start</h2><p>Use Pigsty&rsquo;s <a href=/docs/setup/install><strong>standard installation process</strong></a> with the <a href=https://github.com/pgsty/pigsty/blob/main/conf/mysql.yml><code>mysql</code></a> configuration template.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>./configure -c mysql    <span style=color:#8f5902;font-style:italic># Use MySQL (openHalo) configuration template</span>
</span></span><span style=display:flex><span>./deploy.yml            <span style=color:#8f5902;font-style:italic># Install, for production deployment please modify passwords in pigsty.yml first</span>
</span></span></code></pre></div><p>For production deployment, ensure you modify the password parameters in the <code>pigsty.yml</code> configuration file before running the install playbook.</p><hr><h2 id=configuration>Configuration</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: postgres, extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>aux_mysql]}</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># mysql compatible database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Full backup at 1 AM daily</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># OpenHalo specific settings</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mysql                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># HaloDB&#39;s MySQL compatibility mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># Current HaloDB compatible PG major version 14</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>openhalodb, pgsql-common ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Install openhalodb instead of postgresql kernel</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=usage>Usage</h2><p>When accessing MySQL, the actual connection uses the <code>postgres</code> database. Please note that the concept of &ldquo;database&rdquo; in MySQL actually corresponds to &ldquo;Schema&rdquo; in PostgreSQL. Therefore, <code>use mysql</code> actually uses the <code>mysql</code> Schema within the <code>postgres</code> database.</p><p>The username and password for MySQL are the same as in PostgreSQL. You can manage users and permissions using standard PostgreSQL methods.</p><h3 id=client-access>Client Access</h3><p>OpenHalo provides MySQL wire protocol compatibility, listening on port 3306 by default, allowing MySQL clients and drivers to connect directly.</p><p>Pigsty&rsquo;s <a href=https://github.com/pgsty/pigsty/blob/main/conf/mysql.yml><code>conf/mysql</code></a> configuration installs the <code>mysql</code> client tool by default.</p><p>You can access MySQL using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mysql -h 127.0.0.1 -u dbuser_dba
</span></span></code></pre></div><p>Currently, OpenHalo officially ensures Navicat can properly access this MySQL port, but Intellij IDEA&rsquo;s DataGrip access will cause errors.</p><hr><h2 id=modification-notes>Modification Notes</h2><p>The <a href=https://github.com/pgsty/openHalo>OpenHalo</a> kernel installed by Pigsty is based on the <a href=https://github.com/HaloTech-Co-Ltd/openHalo>HaloTech-Co-Ltd/openHalo</a> kernel with minor modifications:</p><ul><li>Changed the default database name from <code>halo0root</code> back to <code>postgres</code></li><li>Removed the <code>1.0.</code> prefix from the default version number, restoring it to <code>14.10</code></li><li>Modified the default configuration file to enable MySQL compatibility and listen on port <code>3306</code> by default</li></ul><p>Please note that Pigsty does not provide any warranty for using the OpenHalo kernel. Any issues or requirements encountered when using this kernel should be addressed with the original vendor.</p><blockquote><p><strong>Warning</strong>: Currently experimental - thoroughly evaluate before production use.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-311f723c83095a738bfb441159db0044>18.5 - OrioleDB</h1><div class=lead>Next-generation OLTP engine for PostgreSQL</div><p><a href=https://orioledb.com/>OrioleDB</a> is a PostgreSQL storage engine extension that claims to provide 4x OLTP performance, no xid wraparound and table bloat issues, and &ldquo;cloud-native&rdquo; (data stored in S3) capabilities.</p><p>OrioleDB&rsquo;s latest version is based on a <a href=https://github.com/orioledb/postgres>patched PostgreSQL 17.0</a> and an additional <a href=https://github.com/orioledb/orioledb>extension</a></p><p>You can run OrioleDB as an RDS using Pigsty. It&rsquo;s compatible with PG 17 and available on all supported Linux platforms.
The latest version is beta12, based on PG 17_11 patch.</p><hr><h2 id=quick-start>Quick Start</h2><p>Follow Pigsty&rsquo;s <a href=/docs/setup/install><strong>standard installation</strong></a> process using the <a href=https://github.com/pgsty/pigsty/blob/main/conf/oriole.yml><code>oriole</code></a> configuration template.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>./configure -c oriole    <span style=color:#8f5902;font-style:italic># Use OrioleDB configuration template</span>
</span></span><span style=display:flex><span>./deploy.yml             <span style=color:#8f5902;font-style:italic># Install Pigsty with OrioleDB</span>
</span></span></code></pre></div><p>For production deployment, ensure you modify the password parameters in the <code>pigsty.yml</code> configuration before running the <code>install</code> playbook.</p><hr><h2 id=configuration>Configuration</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty], extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>orioledb]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Full backup at 1 AM daily</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># OrioleDB specific settings</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oriole                                        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># oriole compatibility mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb, pgsql-common ]                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Install OrioleDB kernel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;orioledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Load OrioleDB extension</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=usage>Usage</h2><p>To use OrioleDB, you need to install the <code>orioledb_17</code> and <code>oriolepg_17</code> packages (currently only RPM versions are available).</p><p>Initialize TPC-B-like tables with <code>pgbench</code> using 100 warehouses:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -is <span style=color:#0000cf;font-weight:700>100</span> meta
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -S -T1000 meta
</span></span><span style=display:flex><span>pgbench -nv -P1 -c50 -S -T1000 meta
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10    -T1000 meta
</span></span><span style=display:flex><span>pgbench -nv -P1 -c50    -T1000 meta
</span></span></code></pre></div><p>Next, you can rebuild these tables using the <code>orioledb</code> storage engine and observe the performance difference:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Create OrioleDB tables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts_o</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INCLUDING</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches_o</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INCLUDING</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history_o</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INCLUDING</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers_o</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INCLUDING</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Copy data from regular tables to OrioleDB tables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>  </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Drop original tables and rename OrioleDB tables
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=key-features>Key Features</h2><ul><li><strong>No XID Wraparound</strong>: Eliminates transaction ID wraparound maintenance</li><li><strong>No Table Bloat</strong>: Advanced storage management prevents table bloat</li><li><strong>Cloud Storage</strong>: Native support for S3-compatible object storage</li><li><strong>OLTP Optimized</strong>: Designed for transactional workloads</li><li><strong>Improved Performance</strong>: Better space utilization and query performance</li></ul><blockquote><p><strong>Note</strong>: Currently in Beta stage - thoroughly evaluate before production use.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-7200791b1d0ca9c1c30f1e8d7dc9ece2>18.6 - Citus</h1><div class=lead>Deploy native high-availability Citus horizontally sharded clusters with Pigsty, seamlessly scaling PostgreSQL across multiple shards and accelerating OLTP/OLAP queries.</div><p>Pigsty natively supports Citus. This is a distributed horizontal scaling extension based on the native PostgreSQL kernel.</p><p><img src=/img/pigsty/citus.jpg alt></p><hr><h2 id=installation>Installation</h2><p>Citus is a PostgreSQL <a href=/docs/pgsql/ext/>extension plugin</a> that can be installed and enabled on a native PostgreSQL cluster following the standard plugin installation process.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_extension -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;:[&#34;citus&#34;]}&#39;</span>
</span></span></code></pre></div><hr><h2 id=configuration>Configuration</h2><p>To define a citus cluster, you need to specify the following parameters:</p><ul><li><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a> must be set to <code>citus</code> instead of the default <code>pgsql</code></li><li>You must define the shard name <a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a> and shard number <a href=/docs/pgsql/param#pg_group><code>pg_group</code></a> on each shard cluster</li><li>You must define <a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a> to specify the database managed by Patroni</li><li>If you want to use <code>postgres</code> from <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a> instead of the default <a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a> to execute admin commands, then <a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a> must be set to a non-empty plaintext password</li></ul><p>Additionally, you need extra hba rules to allow SSL access from localhost and other data nodes.</p><p>You can define each Citus cluster as a separate group, like standard PostgreSQL clusters, as shown in <a href=https://github.com/pgsty/pigsty/blob/main/conf/citus.yml><code>conf/dbms/citus.yml</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus shard 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.14</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># Global parameters for all Citus clusters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                    # pgsql cluster mode must be set to</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                # citus horizontal shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db: meta               # citus database name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># If using dbsu, you need to configure a password for it</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can also specify identity parameters for all Citus cluster members within a single group, as shown in <a href=https://github.com/pgsty/pigsty/blob/main/conf/prod.yml#L298><code>prod.yml</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==========================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-citus: 10 node citus cluster (5 x primary-replica pair)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==========================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.50</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.51</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.52</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.53</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.54</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.55</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.56</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.57</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.58</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.59</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                    # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus postgis timescaledb pgvector&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: test ,password: test ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: test ,owner: test ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 10.10.10.0/24 ,auth: trust ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;trust citus cluster members&#39;</span><span style=color:#f8f8f8>        </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=usage>Usage</h2><p>You can access any node just like accessing a regular cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -i postgres://test:test@pg-citus0/test
</span></span><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus0/test
</span></span></code></pre></div><p>By default, changes you make to one Shard only occur on that cluster and are not synchronized to other Shards.</p><p>If you want to distribute writes across all Shards, you can use the API functions provided by Citus to mark tables as:</p><ul><li><strong>Distributed tables</strong> (automatic partitioning, requires specifying partition key)</li><li><strong>Reference tables</strong> (full replication: does not require specifying partition key)</li></ul><p>Starting from Citus 11.2, any Citus database node can play the role of coordinator, meaning any primary node can write:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -h pg-citus0 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#34;SELECT create_distributed_table(&#39;pgbench_accounts&#39;, &#39;aid&#39;); SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_accounts&#39;);&#34;</span>
</span></span><span style=display:flex><span>psql -h pg-citus0 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#34;SELECT create_reference_table(&#39;pgbench_branches&#39;)         ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_branches&#39;);&#34;</span>
</span></span><span style=display:flex><span>psql -h pg-citus0 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#34;SELECT create_reference_table(&#39;pgbench_history&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_history&#39;);&#34;</span>
</span></span><span style=display:flex><span>psql -h pg-citus0 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#34;SELECT create_reference_table(&#39;pgbench_tellers&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_tellers&#39;);&#34;</span>
</span></span></code></pre></div><p>After distributing the tables, you can also access them on other nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -h pg-citus1 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#39;\dt+&#39;</span>
</span></span></code></pre></div><p>For example, a full table scan will show that the execution plan has become a distributed plan:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant@meta-1:~$ psql -h pg-citus3 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#39;explain select * from pgbench_accounts&#39;</span>
</span></span><span style=display:flex><span>                                               QUERY PLAN
</span></span><span style=display:flex><span>---------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span> Custom Scan <span style=color:#ce5c00;font-weight:700>(</span>Citus Adaptive<span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cost</span><span style=color:#ce5c00;font-weight:700>=</span>0.00..0.00 <span style=color:#000>rows</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100000</span> <span style=color:#000>width</span><span style=color:#ce5c00;font-weight:700>=</span>352<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>   Task Count: <span style=color:#0000cf;font-weight:700>32</span>
</span></span><span style=display:flex><span>   Tasks Shown: One of <span style=color:#0000cf;font-weight:700>32</span>
</span></span><span style=display:flex><span>   -&gt;  Task
</span></span><span style=display:flex><span>         Node: <span style=color:#000>host</span><span style=color:#ce5c00;font-weight:700>=</span>10.10.10.52 <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>test</span>
</span></span><span style=display:flex><span>         -&gt;  Seq Scan on pgbench_accounts_102008 pgbench_accounts  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cost</span><span style=color:#ce5c00;font-weight:700>=</span>0.00..81.66 <span style=color:#000>rows</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3066</span> <span style=color:#000>width</span><span style=color:#ce5c00;font-weight:700>=</span>97<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span> rows<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>You can initiate writes from several different primary nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus1/test
</span></span><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus2/test
</span></span><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus3/test
</span></span><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus4/test
</span></span></code></pre></div><p>When a node fails, the native high availability support provided by Patroni will promote the standby node and automatically take over.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># select * from  pg_dist_node;</span>
</span></span><span style=display:flex><span> nodeid <span style=color:#000;font-weight:700>|</span> groupid <span style=color:#000;font-weight:700>|</span>  nodename   <span style=color:#000;font-weight:700>|</span> nodeport <span style=color:#000;font-weight:700>|</span> noderack <span style=color:#000;font-weight:700>|</span> hasmetadata <span style=color:#000;font-weight:700>|</span> isactive <span style=color:#000;font-weight:700>|</span> noderole <span style=color:#000;font-weight:700>|</span> nodecluster <span style=color:#000;font-weight:700>|</span> metadatasynced <span style=color:#000;font-weight:700>|</span> shouldhaveshards
</span></span><span style=display:flex><span>--------+---------+-------------+----------+----------+-------------+----------+----------+-------------+----------------+------------------
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.51 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.54 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.52 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.58 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.56 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-86f570780ad542823d4ed958af36ce0f>18.7 - Babelfish</h1><div class=lead>Create Microsoft SQL Server compatible PostgreSQL clusters using WiltonDB and Babelfish! (Wire protocol level compatibility)</div><blockquote><p><a href=https://babelfishpg.org/>Babelfish</a> is an MSSQL (Microsoft SQL Server) compatibility solution based on PostgreSQL, open-sourced by AWS.</p></blockquote><hr><h2 id=overview>Overview</h2><p>Pigsty allows users to create Microsoft SQL Server compatible PostgreSQL clusters using Babelfish and WiltonDB!</p><ul><li><a href=https://babelfishpg.org/>Babelfish</a>: An MSSQL (Microsoft SQL Server) compatibility extension plugin open-sourced by AWS</li><li><a href=https://github.com/wiltondb/wiltondb>WiltonDB</a>: A PostgreSQL kernel distribution focusing on integrating Babelfish</li></ul><p>Babelfish is a PostgreSQL extension, but it only works on a slightly modified PostgreSQL kernel fork. WiltonDB provides compiled fork kernel binaries and extension binary packages on EL/Ubuntu systems.</p><p>Pigsty can replace the native PostgreSQL kernel with WiltonDB, providing an out-of-the-box MSSQL compatible cluster. Using and managing an MSSQL cluster is no different from a standard PostgreSQL 15 cluster. You can use all the features provided by Pigsty, such as high availability, backup, monitoring, etc.</p><p>WiltonDB comes with several extension plugins including Babelfish, but cannot use native PostgreSQL extension plugins.</p><p>After the MSSQL compatible cluster starts, in addition to listening on the PostgreSQL default port, it also listens on the MSSQL default port <code>1433</code>, providing MSSQL services via the TDS Wire Protocol on this port.
You can connect to the MSSQL service provided by Pigsty using any MSSQL client, such as SQL Server Management Studio, or using the <code>sqlcmd</code> command-line tool.</p><p><img src=/img/pigsty/mssql.jpg alt></p><hr><h2 id=installation>Installation</h2><p>WiltonDB conflicts with the native PostgreSQL kernel. Only one kernel can be installed on a node. Use the following command to install the WiltonDB kernel online.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_install -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;local,mssql&#34;,&#34;node_packages&#34;:[&#34;wiltondb&#34;]}&#39;</span>
</span></span></code></pre></div><p>Please note that WiltonDB is only available on EL and Ubuntu systems. Debian support is not currently provided.</p><p>The Pigsty Professional Edition provides offline installation packages for WiltonDB, which can be installed from local software sources.</p><hr><h2 id=configuration>Configuration</h2><p>When installing and deploying the MSSQL module, please pay special attention to the following:</p><ul><li>WiltonDB is available on EL (7/8/9) and Ubuntu (20.04/22.04), but <strong>not available on Debian systems</strong>.</li><li>WiltonDB is currently compiled based on PostgreSQL 15, so you need to specify <code>pg_version: 15</code>.</li><li>On EL systems, the <code>wiltondb</code> binary is installed by default in the <code>/usr/bin/</code> directory, while on Ubuntu systems it is installed in the <code>/usr/lib/postgresql/15/bin/</code> directory, which is different from the official PostgreSQL binary placement.</li><li>In WiltonDB compatibility mode, the HBA password authentication rule needs to use <code>md5</code> instead of <code>scram-sha-256</code>. Therefore, you need to override Pigsty&rsquo;s default HBA rule set and insert the <code>md5</code> authentication rule required by SQL Server before the <code>dbrole_readonly</code> wildcard authentication rule.</li><li>WiltonDB can only be enabled for one primary database, and you should designate a user as the Babelfish superuser, allowing Babelfish to create databases and users. The default is <code>mssql</code> and <code>dbuser_mssql</code>. If you change this, please also modify the user in <code>files/mssql.sql</code>.</li><li>The WiltonDB TDS wire protocol compatibility plugin <code>babelfishpg_tds</code> needs to be enabled in <code>shared_preload_libraries</code>.</li><li>After enabling the WiltonDB extension, it listens on the MSSQL default port <code>1433</code>. You can override Pigsty&rsquo;s default service definitions to point the <code>primary</code> and <code>replica</code> services to port <code>1433</code> instead of <code>5432</code> / <code>6432</code>.</li></ul><p>The following parameters need to be configured for the MSSQL database cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL &amp; MSSQL (Babelfish &amp; Wilton)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PG Installation</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local,node,mssql</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add mssql and os upstream repos</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mssql                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Microsoft SQL Server Compatible Mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;babelfishpg_tds, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add timescaledb to shared_preload_libraries</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># The current WiltonDB major version is 15</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>wiltondb                       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install forked version of postgresql with babelfishpg support</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># do not install any vanilla postgresql extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PG Provision</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># overwrite default HBA rules for babelfish cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; pwd&#39;</span><span style=color:#f8f8f8>    </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user: dbuser_mssql ,db: mssql       ,addr: intra     ,auth: md5   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow mssql dbsu intranet access&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- use md5 auth method for mssql user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># route primary &amp; replica service to mssql port 1433</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: 1433  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: 1433  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can define MSSQL business databases and business users:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgsql (singleton on current node)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># this is an example single-node postgres cluster with postgis &amp; timescaledb installed, with one biz database &amp; two biz users</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- primary instance with read-write capability</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># create MSSQL superuser</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_mssql ,password: DBUser.MSSQL ,superuser: true, pgbouncer: true ,roles: [dbrole_admin], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>superuser &amp; owner for babelfish  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mssql               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use `mssql` as the primary sql server database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mssql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mssql.sql            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># init babelfish database &amp; user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>uuid-ossp          }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfishpg_common }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfishpg_tsql   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfishpg_tds    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfishpg_money  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_hint_plan       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system_stats       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tds_fdw            }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_mssql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>&#39;babelfishpg_tsql.migration_mode&#39; </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;multi-db&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfish cluster, a MSSQL compatible pg cluster</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=access>Access</h2><p>You can use any SQL Server compatible client tool to access this database cluster.</p><p>Microsoft provides <a href="https://learn.microsoft.com/en-us/sql/tools/sqlcmd/sqlcmd-use-utility?view=sql-server-ver16">sqlcmd</a> as the official command-line tool.</p><p>In addition, they also provide a Go version command-line tool <a href=https://github.com/microsoft/go-sqlcmd>go-sqlcmd</a>.</p><p>Install <code>go-sqlcmd</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -LO https://github.com/microsoft/go-sqlcmd/releases/download/v1.4.0/sqlcmd-v1.4.0-linux-amd64.tar.bz2
</span></span><span style=display:flex><span>tar xjvf sqlcmd-v1.4.0-linux-amd64.tar.bz2
</span></span><span style=display:flex><span>sudo mv sqlcmd* /usr/bin/
</span></span></code></pre></div><p>Quick start with <code>go-sqlcmd</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sqlcmd -S 10.10.10.10,1433 -U dbuser_mssql -P DBUser.MSSQL
</span></span><span style=display:flex><span>1&gt; <span style=color:#204a87;font-weight:700>select</span> @@version
</span></span><span style=display:flex><span>2&gt; go
</span></span><span style=display:flex><span>version
</span></span><span style=display:flex><span>----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>Babelfish <span style=color:#204a87;font-weight:700>for</span> PostgreSQL with SQL Server Compatibility - 12.0.2000.8
</span></span><span style=display:flex><span>Oct <span style=color:#0000cf;font-weight:700>22</span> <span style=color:#0000cf;font-weight:700>2023</span> 17:48:32
</span></span><span style=display:flex><span>Copyright <span style=color:#ce5c00;font-weight:700>(</span>c<span style=color:#ce5c00;font-weight:700>)</span> Amazon Web Services
</span></span><span style=display:flex><span>PostgreSQL 15.4 <span style=color:#ce5c00;font-weight:700>(</span>EL 1:15.4.wiltondb3.3_2-2.el8<span style=color:#ce5c00;font-weight:700>)</span> on x86_64-redhat-linux-gnu <span style=color:#ce5c00;font-weight:700>(</span>Babelfish 3.3.0<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> row affected<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>Using the service mechanism provided by Pigsty, you can use ports 5433 / 5434 to always connect to port 1433 on the primary/replica.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Access port 5433 on any cluster member, pointing to port 1433 MSSQL port on the primary</span>
</span></span><span style=display:flex><span>sqlcmd -S 10.10.10.11,5433 -U dbuser_mssql -P DBUser.MSSQL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Access port 5434 on any cluster member, pointing to port 1433 MSSQL port on any readable replica</span>
</span></span><span style=display:flex><span>sqlcmd -S 10.10.10.11,5434 -U dbuser_mssql -P DBUser.MSSQL
</span></span></code></pre></div><hr><h2 id=extensions>Extensions</h2><p>Most of the <strong>PGSQL</strong> module&rsquo;s <a href=/docs/pgsql/ext/><strong>extension plugins</strong></a> (non-pure SQL class) cannot be directly used on the WiltonDB kernel of the MSSQL module and need to be recompiled.</p><p>Currently, WiltonDB comes with the following extension plugins. In addition to PostgreSQL Contrib extensions and the four BabelfishPG core extensions, it also provides three third-party extensions: <code>pg_hint_plan</code>, <code>tds_fdw</code>, and <code>system_stats</code>.</p><table><thead><tr><th>Extension Name</th><th>Version</th><th>Description</th></tr></thead><tbody><tr><td>dblink</td><td>1.2</td><td>connect to other PostgreSQL databases from within a database</td></tr><tr><td>adminpack</td><td>2.1</td><td>administrative functions for PostgreSQL</td></tr><tr><td>dict_int</td><td>1.0</td><td>text search dictionary template for integers</td></tr><tr><td>intagg</td><td>1.1</td><td>integer aggregator and enumerator (obsolete)</td></tr><tr><td>dict_xsyn</td><td>1.0</td><td>text search dictionary template for extended synonym processing</td></tr><tr><td>amcheck</td><td>1.3</td><td>functions for verifying relation integrity</td></tr><tr><td>autoinc</td><td>1.0</td><td>functions for autoincrementing fields</td></tr><tr><td>bloom</td><td>1.0</td><td>bloom access method - signature file based index</td></tr><tr><td>fuzzystrmatch</td><td>1.1</td><td>determine similarities and distance between strings</td></tr><tr><td>intarray</td><td>1.5</td><td>functions, operators, and index support for 1-D arrays of integers</td></tr><tr><td>btree_gin</td><td>1.3</td><td>support for indexing common datatypes in GIN</td></tr><tr><td>btree_gist</td><td>1.7</td><td>support for indexing common datatypes in GiST</td></tr><tr><td>hstore</td><td>1.8</td><td>data type for storing sets of (key, value) pairs</td></tr><tr><td>hstore_plperl</td><td>1.0</td><td>transform between hstore and plperl</td></tr><tr><td>isn</td><td>1.2</td><td>data types for international product numbering standards</td></tr><tr><td>hstore_plperlu</td><td>1.0</td><td>transform between hstore and plperlu</td></tr><tr><td>jsonb_plperl</td><td>1.0</td><td>transform between jsonb and plperl</td></tr><tr><td>citext</td><td>1.6</td><td>data type for case-insensitive character strings</td></tr><tr><td>jsonb_plperlu</td><td>1.0</td><td>transform between jsonb and plperlu</td></tr><tr><td>jsonb_plpython3u</td><td>1.0</td><td>transform between jsonb and plpython3u</td></tr><tr><td>cube</td><td>1.5</td><td>data type for multidimensional cubes</td></tr><tr><td>hstore_plpython3u</td><td>1.0</td><td>transform between hstore and plpython3u</td></tr><tr><td>earthdistance</td><td>1.1</td><td>calculate great-circle distances on the surface of the Earth</td></tr><tr><td>lo</td><td>1.1</td><td>Large Object maintenance</td></tr><tr><td>file_fdw</td><td>1.0</td><td>foreign-data wrapper for flat file access</td></tr><tr><td>insert_username</td><td>1.0</td><td>functions for tracking who changed a table</td></tr><tr><td>ltree</td><td>1.2</td><td>data type for hierarchical tree-like structures</td></tr><tr><td>ltree_plpython3u</td><td>1.0</td><td>transform between ltree and plpython3u</td></tr><tr><td>pg_walinspect</td><td>1.0</td><td>functions to inspect contents of PostgreSQL Write-Ahead Log</td></tr><tr><td>moddatetime</td><td>1.0</td><td>functions for tracking last modification time</td></tr><tr><td>old_snapshot</td><td>1.0</td><td>utilities in support of old_snapshot_threshold</td></tr><tr><td>pgcrypto</td><td>1.3</td><td>cryptographic functions</td></tr><tr><td>pgrowlocks</td><td>1.2</td><td>show row-level locking information</td></tr><tr><td>pageinspect</td><td>1.11</td><td>inspect the contents of database pages at a low level</td></tr><tr><td>pg_surgery</td><td>1.0</td><td>extension to perform surgery on a damaged relation</td></tr><tr><td>seg</td><td>1.4</td><td>data type for representing line segments or floating-point intervals</td></tr><tr><td>pgstattuple</td><td>1.5</td><td>show tuple-level statistics</td></tr><tr><td>pg_buffercache</td><td>1.3</td><td>examine the shared buffer cache</td></tr><tr><td>pg_freespacemap</td><td>1.2</td><td>examine the free space map (FSM)</td></tr><tr><td>postgres_fdw</td><td>1.1</td><td>foreign-data wrapper for remote PostgreSQL servers</td></tr><tr><td>pg_prewarm</td><td>1.2</td><td>prewarm relation data</td></tr><tr><td>tcn</td><td>1.0</td><td>Triggered change notifications</td></tr><tr><td>pg_trgm</td><td>1.6</td><td>text similarity measurement and index searching based on trigrams</td></tr><tr><td>xml2</td><td>1.1</td><td>XPath querying and XSLT</td></tr><tr><td>refint</td><td>1.0</td><td>functions for implementing referential integrity (obsolete)</td></tr><tr><td>pg_visibility</td><td>1.2</td><td>examine the visibility map (VM) and page-level visibility info</td></tr><tr><td>pg_stat_statements</td><td>1.10</td><td>track planning and execution statistics of all SQL statements executed</td></tr><tr><td>sslinfo</td><td>1.2</td><td>information about SSL certificates</td></tr><tr><td>tablefunc</td><td>1.0</td><td>functions that manipulate whole tables, including crosstab</td></tr><tr><td>tsm_system_rows</td><td>1.0</td><td>TABLESAMPLE method which accepts number of rows as a limit</td></tr><tr><td>tsm_system_time</td><td>1.0</td><td>TABLESAMPLE method which accepts time in milliseconds as a limit</td></tr><tr><td>unaccent</td><td>1.1</td><td>text search dictionary that removes accents</td></tr><tr><td>uuid-ossp</td><td>1.1</td><td>generate universally unique identifiers (UUIDs)</td></tr><tr><td>plpgsql</td><td>1.0</td><td>PL/pgSQL procedural language</td></tr><tr><td>babelfishpg_money</td><td>1.1.0</td><td>babelfishpg_money</td></tr><tr><td>system_stats</td><td>2.0</td><td>EnterpriseDB system statistics for PostgreSQL</td></tr><tr><td>tds_fdw</td><td>2.0.3</td><td>Foreign data wrapper for querying a TDS database (Sybase or Microsoft SQL Server)</td></tr><tr><td>babelfishpg_common</td><td>3.3.3</td><td>Transact SQL Datatype Support</td></tr><tr><td>babelfishpg_tds</td><td>1.0.0</td><td>TDS protocol extension</td></tr><tr><td>pg_hint_plan</td><td>1.5.1</td><td></td></tr><tr><td>babelfishpg_tsql</td><td>3.3.1</td><td>Transact SQL compatibility</td></tr></tbody></table><ul><li>The Pigsty Professional Edition provides offline installation capabilities for MSSQL compatible modules</li><li>Pigsty <a href=/docs/about/service/><strong>Professional Edition</strong></a> provides optional MSSQL compatible kernel extension porting and customization services, which can port <a href=/docs/pgsql/ext/><strong>extensions</strong></a> available in the PGSQL module to MSSQL clusters.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d4592799fc81bf53d57e017444a325f6>18.8 - IvorySQL</h1><div class=lead>Use HighGo&rsquo;s open-source IvorySQL kernel to achieve Oracle syntax/PLSQL compatibility based on PostgreSQL clusters.</div><p><a href=https://www.ivorysql.org/>IvorySQL</a> is an open-source PostgreSQL kernel fork that aims to provide &ldquo;Oracle compatibility&rdquo; based on PG.</p><hr><h2 id=overview>Overview</h2><p>The IvorySQL kernel is supported in the Pigsty open-source version. Your server needs internet access to download relevant packages directly from IvorySQL&rsquo;s official repository.</p><p>Please note that adding IvorySQL directly to Pigsty&rsquo;s default software repository will affect the installation of the native PostgreSQL kernel. Pigsty Professional Edition provides offline installation solutions including the IvorySQL kernel.</p><p><img src=/img/pigsty/ivory.jpg alt></p><p>The current latest version of IvorySQL is <strong>5.0</strong>, corresponding to PostgreSQL version <strong>18</strong>. Please note that IvorySQL is currently only available on EL8/EL9.</p><blockquote><p>The last IvorySQL version supporting EL7 was 3.3, corresponding to PostgreSQL 16.3; the last version based on PostgreSQL 17 is IvorySQL 4.4</p></blockquote><hr><h2 id=installation>Installation</h2><p>If your environment has internet access, you can add the IvorySQL repository directly to the node using the following method, then execute the PGSQL playbook for installation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;local,node,pgsql,ivory&#34;}&#39;</span>
</span></span></code></pre></div><hr><h2 id=configuration>Configuration</h2><p>The following parameters need to be configured for IvorySQL database clusters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ivory SQL Configuration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local,node,pgsql,ivory </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add ivorysql upstream repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ivory                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># IvorySQL Oracle Compatible Mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;ivorysql patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;liboracle_parser, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># do not install any vanilla postgresql extensions</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>When using Oracle compatibility mode, you need to dynamically load the <code>liboracle_parser</code> extension plugin.</p></blockquote><hr><h2 id=client-access>Client Access</h2><p>IvorySQL is equivalent to PostgreSQL 16, and any client tool compatible with the PostgreSQL wire protocol can access IvorySQL clusters.</p><hr><h2 id=extension-list>Extension List</h2><p>Most of the <strong>PGSQL</strong> module&rsquo;s <a href=/docs/pgsql/ext/><strong>extensions</strong></a> (non-pure SQL types) cannot be used directly on the IvorySQL kernel. If you need to use them, please recompile and install from source for the new kernel.</p><p>Currently, the IvorySQL kernel comes with the following <strong>101</strong> extension plugins.</p><p>(The extension table remains unchanged as it&rsquo;s already in English)</p><p>Please note that Pigsty does not assume any warranty responsibility for using the IvorySQL kernel. Any issues or requirements encountered when using this kernel should be addressed with the original vendor.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-293b566be2331c0d55a3457bdfb0a860>18.9 - PolarDB PG</h1><div class=lead>Using Alibaba Cloud&rsquo;s open-source PolarDB for PostgreSQL kernel to provide domestic innovation qualification support, with Oracle RAC-like user experience.</div><hr><h2 id=overview>Overview</h2><p>Pigsty allows you to create PostgreSQL clusters with &ldquo;domestic innovation qualification&rdquo; credentials using PolarDB!</p><p>PolarDB for PostgreSQL is essentially equivalent to PostgreSQL 15. Any client tool compatible with the PostgreSQL wire protocol can access PolarDB clusters.</p><p>Pigsty&rsquo;s PGSQL repository provides PolarDB PG open-source installation packages for EL7 / EL8, but they are not downloaded to the local software repository during Pigsty installation.</p><p>If you need offline installation support for PolarDB PG, please consider our <a href=/docs/about/service>professional subscription service</a></p><p><img src=/img/pigsty/polar.jpg alt></p><hr><h2 id=installation>Installation</h2><p>If your environment has internet access, you can add the Pigsty PGSQL and dependency repositories to the node using the following method:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local,node,pgsql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Then in <code>pg_packages</code>, replace the native <code>postgresql</code> package with <code>polardb</code>.</p><hr><h2 id=configuration>Configuration</h2><p>The following parameters need special configuration for PolarDB database clusters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL &amp; PolarDB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;polardb patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># do not install any vanilla postgresql extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>polar                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PolarDB Compatible Mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator   ,superuser: true  ,replication: true ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;- superuser is required for replication</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Note particularly that PolarDB PG requires the <code>replicator</code> replication user to be a Superuser, unlike native PG.</p><hr><h2 id=extension-list>Extension List</h2><p>Most <strong>PGSQL</strong> module <a href=/docs/pgsql/ext/><strong>extension plugins</strong></a> (non-pure SQL types) cannot be used directly on the PolarDB kernel. If needed, please recompile and install from source for the new kernel.</p><p>Currently, the PolarDB kernel comes with the following <strong>61</strong> extension plugins. Apart from Contrib extensions, the additional extensions provided include:</p><ul><li><code>polar_csn</code> 1.0 : polar_csn</li><li><code>polar_monitor</code> 1.2 : examine the polardb information</li><li><code>polar_monitor_preload</code> 1.1 : examine the polardb information</li><li><code>polar_parameter_check</code> 1.0 : kernel extension for parameter validation</li><li><code>polar_px</code> 1.0 : Parallel Execution extension</li><li><code>polar_stat_env</code> 1.0 : env stat functions for PolarDB</li><li><code>polar_stat_sql</code> 1.3 : Kernel statistics gathering, and sql plan nodes information gathering</li><li><code>polar_tde_utils</code> 1.0 : Internal extension for TDE</li><li><code>polar_vfs</code> 1.0 : polar_vfs</li><li><code>polar_worker</code> 1.0 : polar_worker</li><li><code>timetravel</code> 1.0 : functions for implementing time travel</li><li><code>vector</code> 0.5.1 : vector data type and ivfflat and hnsw access methods</li><li><code>smlar</code> 1.0 : compute similary of any one-dimensional arrays</li></ul><p>Complete list of available PolarDB plugins:</p><table><thead><tr><th>name</th><th>version</th><th>comment</th></tr></thead><tbody><tr><td>hstore_plpython2u</td><td>1.0</td><td>transform between hstore and plpython2u</td></tr><tr><td>dict_int</td><td>1.0</td><td>text search dictionary template for integers</td></tr><tr><td>adminpack</td><td>2.0</td><td>administrative functions for PostgreSQL</td></tr><tr><td>hstore_plpython3u</td><td>1.0</td><td>transform between hstore and plpython3u</td></tr><tr><td>amcheck</td><td>1.1</td><td>functions for verifying relation integrity</td></tr><tr><td>hstore_plpythonu</td><td>1.0</td><td>transform between hstore and plpythonu</td></tr><tr><td>autoinc</td><td>1.0</td><td>functions for autoincrementing fields</td></tr><tr><td>insert_username</td><td>1.0</td><td>functions for tracking who changed a table</td></tr><tr><td>bloom</td><td>1.0</td><td>bloom access method - signature file based index</td></tr><tr><td>file_fdw</td><td>1.0</td><td>foreign-data wrapper for flat file access</td></tr><tr><td>dblink</td><td>1.2</td><td>connect to other PostgreSQL databases from within a database</td></tr><tr><td>btree_gin</td><td>1.3</td><td>support for indexing common datatypes in GIN</td></tr><tr><td>fuzzystrmatch</td><td>1.1</td><td>determine similarities and distance between strings</td></tr><tr><td>lo</td><td>1.1</td><td>Large Object maintenance</td></tr><tr><td>intagg</td><td>1.1</td><td>integer aggregator and enumerator (obsolete)</td></tr><tr><td>btree_gist</td><td>1.5</td><td>support for indexing common datatypes in GiST</td></tr><tr><td>hstore</td><td>1.5</td><td>data type for storing sets of (key, value) pairs</td></tr><tr><td>intarray</td><td>1.2</td><td>functions, operators, and index support for 1-D arrays of integers</td></tr><tr><td>citext</td><td>1.5</td><td>data type for case-insensitive character strings</td></tr><tr><td>cube</td><td>1.4</td><td>data type for multidimensional cubes</td></tr><tr><td>hstore_plperl</td><td>1.0</td><td>transform between hstore and plperl</td></tr><tr><td>isn</td><td>1.2</td><td>data types for international product numbering standards</td></tr><tr><td>jsonb_plperl</td><td>1.0</td><td>transform between jsonb and plperl</td></tr><tr><td>dict_xsyn</td><td>1.0</td><td>text search dictionary template for extended synonym processing</td></tr><tr><td>hstore_plperlu</td><td>1.0</td><td>transform between hstore and plperlu</td></tr><tr><td>earthdistance</td><td>1.1</td><td>calculate great-circle distances on the surface of the Earth</td></tr><tr><td>pg_prewarm</td><td>1.2</td><td>prewarm relation data</td></tr><tr><td>jsonb_plperlu</td><td>1.0</td><td>transform between jsonb and plperlu</td></tr><tr><td>pg_stat_statements</td><td>1.6</td><td>track execution statistics of all SQL statements executed</td></tr><tr><td>jsonb_plpython2u</td><td>1.0</td><td>transform between jsonb and plpython2u</td></tr><tr><td>jsonb_plpython3u</td><td>1.0</td><td>transform between jsonb and plpython3u</td></tr><tr><td>jsonb_plpythonu</td><td>1.0</td><td>transform between jsonb and plpythonu</td></tr><tr><td>pg_trgm</td><td>1.4</td><td>text similarity measurement and index searching based on trigrams</td></tr><tr><td>pgstattuple</td><td>1.5</td><td>show tuple-level statistics</td></tr><tr><td>ltree</td><td>1.1</td><td>data type for hierarchical tree-like structures</td></tr><tr><td>ltree_plpython2u</td><td>1.0</td><td>transform between ltree and plpython2u</td></tr><tr><td>pg_visibility</td><td>1.2</td><td>examine the visibility map (VM) and page-level visibility info</td></tr><tr><td>ltree_plpython3u</td><td>1.0</td><td>transform between ltree and plpython3u</td></tr><tr><td>ltree_plpythonu</td><td>1.0</td><td>transform between ltree and plpythonu</td></tr><tr><td>seg</td><td>1.3</td><td>data type for representing line segments or floating-point intervals</td></tr><tr><td>moddatetime</td><td>1.0</td><td>functions for tracking last modification time</td></tr><tr><td>pgcrypto</td><td>1.3</td><td>cryptographic functions</td></tr><tr><td>pgrowlocks</td><td>1.2</td><td>show row-level locking information</td></tr><tr><td>pageinspect</td><td>1.7</td><td>inspect the contents of database pages at a low level</td></tr><tr><td>pg_buffercache</td><td>1.3</td><td>examine the shared buffer cache</td></tr><tr><td>pg_freespacemap</td><td>1.2</td><td>examine the free space map (FSM)</td></tr><tr><td>tcn</td><td>1.0</td><td>Triggered change notifications</td></tr><tr><td>plperl</td><td>1.0</td><td>PL/Perl procedural language</td></tr><tr><td>uuid-ossp</td><td>1.1</td><td>generate universally unique identifiers (UUIDs)</td></tr><tr><td>plperlu</td><td>1.0</td><td>PL/PerlU untrusted procedural language</td></tr><tr><td>refint</td><td>1.0</td><td>functions for implementing referential integrity (obsolete)</td></tr><tr><td>xml2</td><td>1.1</td><td>XPath querying and XSLT</td></tr><tr><td>plpgsql</td><td>1.0</td><td>PL/pgSQL procedural language</td></tr><tr><td>plpython3u</td><td>1.0</td><td>PL/Python3U untrusted procedural language</td></tr><tr><td>pltcl</td><td>1.0</td><td>PL/Tcl procedural language</td></tr><tr><td>pltclu</td><td>1.0</td><td>PL/TclU untrusted procedural language</td></tr><tr><td>polar_csn</td><td>1.0</td><td>polar_csn</td></tr><tr><td>sslinfo</td><td>1.2</td><td>information about SSL certificates</td></tr><tr><td>polar_monitor</td><td>1.2</td><td>examine the polardb information</td></tr><tr><td>polar_monitor_preload</td><td>1.1</td><td>examine the polardb information</td></tr><tr><td>polar_parameter_check</td><td>1.0</td><td>kernel extension for parameter validation</td></tr><tr><td>polar_px</td><td>1.0</td><td>Parallel Execution extension</td></tr><tr><td>tablefunc</td><td>1.0</td><td>functions that manipulate whole tables, including crosstab</td></tr><tr><td>polar_stat_env</td><td>1.0</td><td>env stat functions for PolarDB</td></tr><tr><td>smlar</td><td>1.0</td><td>compute similary of any one-dimensional arrays</td></tr><tr><td>timetravel</td><td>1.0</td><td>functions for implementing time travel</td></tr><tr><td>tsm_system_rows</td><td>1.0</td><td>TABLESAMPLE method which accepts number of rows as a limit</td></tr><tr><td>polar_stat_sql</td><td>1.3</td><td>Kernel statistics gathering, and sql plan nodes information gathering</td></tr><tr><td>tsm_system_time</td><td>1.0</td><td>TABLESAMPLE method which accepts time in milliseconds as a limit</td></tr><tr><td>polar_tde_utils</td><td>1.0</td><td>Internal extension for TDE</td></tr><tr><td>polar_vfs</td><td>1.0</td><td>polar_vfs</td></tr><tr><td>polar_worker</td><td>1.0</td><td>polar_worker</td></tr><tr><td>unaccent</td><td>1.1</td><td>text search dictionary that removes accents</td></tr><tr><td>postgres_fdw</td><td>1.0</td><td>foreign-data wrapper for remote PostgreSQL servers</td></tr></tbody></table><ul><li>Pigsty Professional Edition provides PolarDB offline installation support, extension plugin compilation support, and monitoring and management support specifically adapted for PolarDB clusters.</li><li>Pigsty collaborates with the Alibaba Cloud kernel team and can provide paid kernel backup support services.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ffed78d77ebf7627086f9da938f9b9f6>18.10 - PolarDB Oracle</h1><div class=lead>Using Alibaba Cloud&rsquo;s commercial PolarDB for Oracle kernel (closed source, PG14, only available in special enterprise edition customization)</div><p>Pigsty allows you to create PolarDB for Oracle clusters with &ldquo;domestic innovation qualification&rdquo; credentials using PolarDB!</p><p>According to the <a href=http://www.itsec.gov.cn/aqkkcp/cpgg/202312/t20231226_162074.html>Security and Reliability Evaluation Results Announcement (No. 1, 2023)</a>, Appendix 3, Centralized Database. PolarDB v2.0 is an autonomous, controllable, secure, and reliable domestic innovation database.</p><p>PolarDB for Oracle is an Oracle-compatible version developed based on PolarDB for PostgreSQL. Both share the same kernel, distinguished by the <code>--compatibility-mode</code> parameter.</p><p>We collaborate with the Alibaba Cloud kernel team to provide a complete database solution based on PolarDB v2.0 kernel and Pigsty v3.0 RDS. Please contact sales for inquiries, or purchase on Alibaba Cloud Marketplace.</p><p>The PolarDB for Oracle kernel is currently only available on EL systems.</p><p><img src=/img/pigsty/polar.jpg alt></p><hr><h2 id=extensions>Extensions</h2><p>Currently, the PolarDB 2.0 (Oracle compatible) kernel comes with the following <strong>188</strong> extension plugins:</p><table><thead><tr><th>name</th><th>default_version</th><th>comment</th></tr></thead><tbody><tr><td>cube</td><td>1.5</td><td>data type for multidimensional cubes</td></tr><tr><td>ip4r</td><td>2.4</td><td>NULL</td></tr><tr><td>adminpack</td><td>2.1</td><td>administrative functions for PostgreSQL</td></tr><tr><td>dict_xsyn</td><td>1.0</td><td>text search dictionary template for extended synonym processing</td></tr><tr><td>amcheck</td><td>1.4</td><td>functions for verifying relation integrity</td></tr><tr><td>autoinc</td><td>1.0</td><td>functions for autoincrementing fields</td></tr><tr><td>hstore</td><td>1.8</td><td>data type for storing sets of (key, value) pairs</td></tr><tr><td>bloom</td><td>1.0</td><td>bloom access method - signature file based index</td></tr><tr><td>earthdistance</td><td>1.1</td><td>calculate great-circle distances on the surface of the Earth</td></tr><tr><td>hstore_plperl</td><td>1.0</td><td>transform between hstore and plperl</td></tr><tr><td>bool_plperl</td><td>1.0</td><td>transform between bool and plperl</td></tr><tr><td>file_fdw</td><td>1.0</td><td>foreign-data wrapper for flat file access</td></tr><tr><td>bool_plperlu</td><td>1.0</td><td>transform between bool and plperlu</td></tr><tr><td>fuzzystrmatch</td><td>1.1</td><td>determine similarities and distance between strings</td></tr><tr><td>hstore_plperlu</td><td>1.0</td><td>transform between hstore and plperlu</td></tr><tr><td>btree_gin</td><td>1.3</td><td>support for indexing common datatypes in GIN</td></tr><tr><td>hstore_plpython2u</td><td>1.0</td><td>transform between hstore and plpython2u</td></tr><tr><td>btree_gist</td><td>1.6</td><td>support for indexing common datatypes in GiST</td></tr><tr><td>hll</td><td>2.17</td><td>type for storing hyperloglog data</td></tr><tr><td>hstore_plpython3u</td><td>1.0</td><td>transform between hstore and plpython3u</td></tr><tr><td>citext</td><td>1.6</td><td>data type for case-insensitive character strings</td></tr><tr><td>hstore_plpythonu</td><td>1.0</td><td>transform between hstore and plpythonu</td></tr><tr><td>hypopg</td><td>1.3.1</td><td>Hypothetical indexes for PostgreSQL</td></tr><tr><td>insert_username</td><td>1.0</td><td>functions for tracking who changed a table</td></tr><tr><td>dblink</td><td>1.2</td><td>connect to other PostgreSQL databases from within a database</td></tr><tr><td>decoderbufs</td><td>0.1.0</td><td>Logical decoding plugin that delivers WAL stream changes using a Protocol Buffer format</td></tr><tr><td>intagg</td><td>1.1</td><td>integer aggregator and enumerator (obsolete)</td></tr><tr><td>dict_int</td><td>1.0</td><td>text search dictionary template for integers</td></tr><tr><td>intarray</td><td>1.5</td><td>functions, operators, and index support for 1-D arrays of integers</td></tr><tr><td>isn</td><td>1.2</td><td>data types for international product numbering standards</td></tr><tr><td>jsonb_plperl</td><td>1.0</td><td>transform between jsonb and plperl</td></tr><tr><td>jsonb_plperlu</td><td>1.0</td><td>transform between jsonb and plperlu</td></tr><tr><td>jsonb_plpython2u</td><td>1.0</td><td>transform between jsonb and plpython2u</td></tr><tr><td>jsonb_plpython3u</td><td>1.0</td><td>transform between jsonb and plpython3u</td></tr><tr><td>jsonb_plpythonu</td><td>1.0</td><td>transform between jsonb and plpythonu</td></tr><tr><td>lo</td><td>1.1</td><td>Large Object maintenance</td></tr><tr><td>log_fdw</td><td>1.0</td><td>foreign-data wrapper for csvlog</td></tr><tr><td>ltree</td><td>1.2</td><td>data type for hierarchical tree-like structures</td></tr><tr><td>ltree_plpython2u</td><td>1.0</td><td>transform between ltree and plpython2u</td></tr><tr><td>ltree_plpython3u</td><td>1.0</td><td>transform between ltree and plpython3u</td></tr><tr><td>ltree_plpythonu</td><td>1.0</td><td>transform between ltree and plpythonu</td></tr><tr><td>moddatetime</td><td>1.0</td><td>functions for tracking last modification time</td></tr><tr><td>old_snapshot</td><td>1.0</td><td>utilities in support of old_snapshot_threshold</td></tr><tr><td>oracle_fdw</td><td>1.2</td><td>foreign data wrapper for Oracle access</td></tr><tr><td>oss_fdw</td><td>1.1</td><td>foreign-data wrapper for OSS access</td></tr><tr><td>pageinspect</td><td>2.1</td><td>inspect the contents of database pages at a low level</td></tr><tr><td>pase</td><td>0.0.1</td><td>ant ai similarity search</td></tr><tr><td>pg_bigm</td><td>1.2</td><td>text similarity measurement and index searching based on bigrams</td></tr><tr><td>pg_freespacemap</td><td>1.2</td><td>examine the free space map (FSM)</td></tr><tr><td>pg_hint_plan</td><td>1.4</td><td>controls execution plan with hinting phrases in comment of special form</td></tr><tr><td>pg_buffercache</td><td>1.5</td><td>examine the shared buffer cache</td></tr><tr><td>pg_prewarm</td><td>1.2</td><td>prewarm relation data</td></tr><tr><td>pg_repack</td><td>1.4.8-1</td><td>Reorganize tables in PostgreSQL databases with minimal locks</td></tr><tr><td>pg_sphere</td><td>1.0</td><td>spherical objects with useful functions, operators and index support</td></tr><tr><td>pg_cron</td><td>1.5</td><td>Job scheduler for PostgreSQL</td></tr><tr><td>pg_jieba</td><td>1.1.0</td><td>a parser for full-text search of Chinese</td></tr><tr><td>pg_stat_kcache</td><td>2.2.1</td><td>Kernel statistics gathering</td></tr><tr><td>pg_stat_statements</td><td>1.9</td><td>track planning and execution statistics of all SQL statements executed</td></tr><tr><td>pg_surgery</td><td>1.0</td><td>extension to perform surgery on a damaged relation</td></tr><tr><td>pg_trgm</td><td>1.6</td><td>text similarity measurement and index searching based on trigrams</td></tr><tr><td>pg_visibility</td><td>1.2</td><td>examine the visibility map (VM) and page-level visibility info</td></tr><tr><td>pg_wait_sampling</td><td>1.1</td><td>sampling based statistics of wait events</td></tr><tr><td>pgaudit</td><td>1.6.2</td><td>provides auditing functionality</td></tr><tr><td>pgcrypto</td><td>1.3</td><td>cryptographic functions</td></tr><tr><td>pgrowlocks</td><td>1.2</td><td>show row-level locking information</td></tr><tr><td>pgstattuple</td><td>1.5</td><td>show tuple-level statistics</td></tr><tr><td>pgtap</td><td>1.2.0</td><td>Unit testing for PostgreSQL</td></tr><tr><td>pldbgapi</td><td>1.1</td><td>server-side support for debugging PL/pgSQL functions</td></tr><tr><td>plperl</td><td>1.0</td><td>PL/Perl procedural language</td></tr><tr><td>plperlu</td><td>1.0</td><td>PL/PerlU untrusted procedural language</td></tr><tr><td>plpgsql</td><td>1.0</td><td>PL/pgSQL procedural language</td></tr><tr><td>plpython2u</td><td>1.0</td><td>PL/Python2U untrusted procedural language</td></tr><tr><td>plpythonu</td><td>1.0</td><td>PL/PythonU untrusted procedural language</td></tr><tr><td>plsql</td><td>1.0</td><td>Oracle compatible PL/SQL procedural language</td></tr><tr><td>pltcl</td><td>1.0</td><td>PL/Tcl procedural language</td></tr><tr><td>pltclu</td><td>1.0</td><td>PL/TclU untrusted procedural language</td></tr><tr><td>polar_bfile</td><td>1.0</td><td>The BFILE data type enables access to binary file LOBs that are stored in file systems outside Database</td></tr><tr><td>polar_bpe</td><td>1.0</td><td>polar_bpe</td></tr><tr><td>polar_builtin_cast</td><td>1.1</td><td>Internal extension for builtin casts</td></tr><tr><td>polar_builtin_funcs</td><td>2.0</td><td>implement polar builtin functions</td></tr><tr><td>polar_builtin_type</td><td>1.5</td><td>polar_builtin_type for PolarDB</td></tr><tr><td>polar_builtin_view</td><td>1.5</td><td>polar_builtin_view</td></tr><tr><td>polar_catalog</td><td>1.2</td><td>polardb pg extend catalog</td></tr><tr><td>polar_channel</td><td>1.0</td><td>polar_channel</td></tr><tr><td>polar_constraint</td><td>1.0</td><td>polar_constraint</td></tr><tr><td>polar_csn</td><td>1.0</td><td>polar_csn</td></tr><tr><td>polar_dba_views</td><td>1.0</td><td>polar_dba_views</td></tr><tr><td>polar_dbms_alert</td><td>1.2</td><td>implement polar_dbms_alert - supports asynchronous notification of database events.</td></tr><tr><td>polar_dbms_application_info</td><td>1.0</td><td>implement polar_dbms_application_info - record names of executing modules or transactions in the database.</td></tr><tr><td>polar_dbms_pipe</td><td>1.1</td><td>implements polar_dbms_pipe - package lets two or more sessions in the same instance communicate.</td></tr><tr><td>polar_dbms_aq</td><td>1.2</td><td>implement dbms_aq - provides an interface to Advanced Queuing.</td></tr><tr><td>polar_dbms_lob</td><td>1.3</td><td>implement dbms_lob - provides subprograms to operate on BLOBs, CLOBs, and NCLOBs.</td></tr><tr><td>polar_dbms_output</td><td>1.2</td><td>implement polar_dbms_output - enables you to send messages from stored procedures.</td></tr><tr><td>polar_dbms_lock</td><td>1.0</td><td>implement polar_dbms_lock - provides an interface to Oracle Lock Management services.</td></tr><tr><td>polar_dbms_aqadm</td><td>1.3</td><td>polar_dbms_aqadm - procedures to manage Advanced Queuing configuration and administration information.</td></tr><tr><td>polar_dbms_assert</td><td>1.0</td><td>implement polar_dbms_assert - provide an interface to validate properties of the input value.</td></tr><tr><td>polar_dbms_metadata</td><td>1.0</td><td>implement polar_dbms_metadata - provides a way for you to retrieve metadata from the database dictionary.</td></tr><tr><td>polar_dbms_random</td><td>1.0</td><td>implement polar_dbms_random - a built-in random number generator, not intended for cryptography</td></tr><tr><td>polar_dbms_crypto</td><td>1.1</td><td>implement dbms_crypto - provides an interface to encrypt and decrypt stored data.</td></tr><tr><td>polar_dbms_redact</td><td>1.0</td><td>implement polar_dbms_redact - provides an interface to mask data from queries by an application.</td></tr><tr><td>polar_dbms_debug</td><td>1.1</td><td>server-side support for debugging PL/SQL functions</td></tr><tr><td>polar_dbms_job</td><td>1.0</td><td>polar_dbms_job</td></tr><tr><td>polar_dbms_mview</td><td>1.1</td><td>implement polar_dbms_mview - enables to refresh materialized views.</td></tr><tr><td>polar_dbms_job_preload</td><td>1.0</td><td>polar_dbms_job_preload</td></tr><tr><td>polar_dbms_obfuscation_toolkit</td><td>1.1</td><td>implement polar_dbms_obfuscation_toolkit - enables an application to get data md5.</td></tr><tr><td>polar_dbms_rls</td><td>1.1</td><td>implement polar_dbms_rls - a fine-grained access control administrative built-in package</td></tr><tr><td>polar_multi_toast_utils</td><td>1.0</td><td>polar_multi_toast_utils</td></tr><tr><td>polar_dbms_session</td><td>1.2</td><td>implement polar_dbms_session - support to set preferences and security levels.</td></tr><tr><td>polar_odciconst</td><td>1.0</td><td>implement ODCIConst - Provide some built-in constants in Oracle.</td></tr><tr><td>polar_dbms_sql</td><td>1.2</td><td>implement polar_dbms_sql - provides an interface to execute dynamic SQL.</td></tr><tr><td>polar_osfs_toolkit</td><td>1.0</td><td>osfs library tools and functions extension</td></tr><tr><td>polar_dbms_stats</td><td>14.0</td><td>stabilize plans by fixing statistics</td></tr><tr><td>polar_monitor</td><td>1.5</td><td>monitor functions for PolarDB</td></tr><tr><td>polar_osfs_utils</td><td>1.0</td><td>osfs library utils extension</td></tr><tr><td>polar_dbms_utility</td><td>1.3</td><td>implement polar_dbms_utility - provides various utility subprograms.</td></tr><tr><td>polar_parameter_check</td><td>1.0</td><td>kernel extension for parameter validation</td></tr><tr><td>polar_dbms_xmldom</td><td>1.0</td><td>implement dbms_xmldom and dbms_xmlparser - support standard DOM interface and xml parser object</td></tr><tr><td>polar_parameter_manager</td><td>1.1</td><td>Extension to select parameters for manger.</td></tr><tr><td>polar_faults</td><td>1.0.0</td><td>simulate some database faults for end user or testing system.</td></tr><tr><td>polar_monitor_preload</td><td>1.1</td><td>examine the polardb information</td></tr><tr><td>polar_proxy_utils</td><td>1.0</td><td>Extension to provide operations about proxy.</td></tr><tr><td>polar_feature_utils</td><td>1.2</td><td>PolarDB feature utilization</td></tr><tr><td>polar_global_awr</td><td>1.0</td><td>PolarDB Global AWR Report</td></tr><tr><td>polar_publication</td><td>1.0</td><td>support polardb pg logical replication</td></tr><tr><td>polar_global_cache</td><td>1.0</td><td>polar_global_cache</td></tr><tr><td>polar_px</td><td>1.0</td><td>Parallel Execution extension</td></tr><tr><td>polar_serverless</td><td>1.0</td><td>polar serverless extension</td></tr><tr><td>polar_resource_manager</td><td>1.0</td><td>a background process that forcibly frees user session process memory</td></tr><tr><td>polar_sys_context</td><td>1.1</td><td>implement polar_sys_context - returns the value of parameter associated with the context namespace at the current instant.</td></tr><tr><td>polar_gpc</td><td>1.3</td><td>polar_gpc</td></tr><tr><td>polar_tde_utils</td><td>1.0</td><td>Internal extension for TDE</td></tr><tr><td>polar_gtt</td><td>1.1</td><td>polar_gtt</td></tr><tr><td>polar_utl_encode</td><td>1.2</td><td>implement polar_utl_encode - provides functions that encode RAW data into a standard encoded format</td></tr><tr><td>polar_htap</td><td>1.1</td><td>extension for PolarDB HTAP</td></tr><tr><td>polar_htap_db</td><td>1.0</td><td>extension for PolarDB HTAP database level operation</td></tr><tr><td>polar_io_stat</td><td>1.0</td><td>polar io stat in multi dimension</td></tr><tr><td>polar_utl_file</td><td>1.0</td><td>implement utl_file - support PL/SQL programs can read and write operating system text files</td></tr><tr><td>polar_ivm</td><td>1.0</td><td>polar_ivm</td></tr><tr><td>polar_sql_mapping</td><td>1.2</td><td>Record error sqls and mapping them to correct one</td></tr><tr><td>polar_stat_sql</td><td>1.0</td><td>Kernel statistics gathering, and sql plan nodes information gathering</td></tr><tr><td>tds_fdw</td><td>2.0.2</td><td>Foreign data wrapper for querying a TDS database (Sybase or Microsoft SQL Server)</td></tr><tr><td>xml2</td><td>1.1</td><td>XPath querying and XSLT</td></tr><tr><td>polar_upgrade_catalogs</td><td>1.1</td><td>Upgrade catalogs for old version instance</td></tr><tr><td>polar_utl_i18n</td><td>1.1</td><td>polar_utl_i18n</td></tr><tr><td>polar_utl_raw</td><td>1.0</td><td>implement utl_raw - provides SQL functions for manipulating RAW datatypes.</td></tr><tr><td>timescaledb</td><td>2.9.2</td><td>Enables scalable inserts and complex queries for time-series data</td></tr><tr><td>polar_vfs</td><td>1.0</td><td>polar virtual file system for different storage</td></tr><tr><td>polar_worker</td><td>1.0</td><td>polar_worker</td></tr><tr><td>postgres_fdw</td><td>1.1</td><td>foreign-data wrapper for remote PostgreSQL servers</td></tr><tr><td>refint</td><td>1.0</td><td>functions for implementing referential integrity (obsolete)</td></tr><tr><td>roaringbitmap</td><td>0.5</td><td>support for Roaring Bitmaps</td></tr><tr><td>tsm_system_time</td><td>1.0</td><td>TABLESAMPLE method which accepts time in milliseconds as a limit</td></tr><tr><td>vector</td><td>0.5.0</td><td>vector data type and ivfflat and hnsw access methods</td></tr><tr><td>rum</td><td>1.3</td><td>RUM index access method</td></tr><tr><td>unaccent</td><td>1.1</td><td>text search dictionary that removes accents</td></tr><tr><td>seg</td><td>1.4</td><td>data type for representing line segments or floating-point intervals</td></tr><tr><td>sequential_uuids</td><td>1.0.2</td><td>generator of sequential UUIDs</td></tr><tr><td>uuid-ossp</td><td>1.1</td><td>generate universally unique identifiers (UUIDs)</td></tr><tr><td>smlar</td><td>1.0</td><td>compute similary of any one-dimensional arrays</td></tr><tr><td>varbitx</td><td>1.1</td><td>varbit functions pack</td></tr><tr><td>sslinfo</td><td>1.2</td><td>information about SSL certificates</td></tr><tr><td>tablefunc</td><td>1.0</td><td>functions that manipulate whole tables, including crosstab</td></tr><tr><td>tcn</td><td>1.0</td><td>Triggered change notifications</td></tr><tr><td>zhparser</td><td>1.0</td><td>a parser for full-text search of Chinese</td></tr><tr><td>address_standardizer</td><td>3.3.2</td><td>Ganos PostGIS address standardizer</td></tr><tr><td>address_standardizer_data_us</td><td>3.3.2</td><td>Ganos PostGIS address standardizer data us</td></tr><tr><td>ganos_fdw</td><td>6.0</td><td>Ganos Spatial FDW extension for POLARDB</td></tr><tr><td>ganos_geometry</td><td>6.0</td><td>Ganos geometry lite extension for POLARDB</td></tr><tr><td>ganos_geometry_pyramid</td><td>6.0</td><td>Ganos Geometry Pyramid extension for POLARDB</td></tr><tr><td>ganos_geometry_sfcgal</td><td>6.0</td><td>Ganos geometry lite sfcgal extension for POLARDB</td></tr><tr><td>ganos_geomgrid</td><td>6.0</td><td>Ganos geometry grid extension for POLARDB</td></tr><tr><td>ganos_importer</td><td>6.0</td><td>Ganos Spatial importer extension for POLARDB</td></tr><tr><td>ganos_networking</td><td>6.0</td><td>Ganos networking</td></tr><tr><td>ganos_pointcloud</td><td>6.0</td><td>Ganos pointcloud extension For POLARDB</td></tr><tr><td>ganos_pointcloud_geometry</td><td>6.0</td><td>Ganos_pointcloud LIDAR data and ganos_geometry data for POLARDB</td></tr><tr><td>ganos_raster</td><td>6.0</td><td>Ganos raster extension for POLARDB</td></tr><tr><td>ganos_scene</td><td>6.0</td><td>Ganos scene extension for POLARDB</td></tr><tr><td>ganos_sfmesh</td><td>6.0</td><td>Ganos surface mesh extension for POLARDB</td></tr><tr><td>ganos_spatialref</td><td>6.0</td><td>Ganos spatial reference extension for POLARDB</td></tr><tr><td>ganos_trajectory</td><td>6.0</td><td>Ganos trajectory extension for POLARDB</td></tr><tr><td>ganos_vomesh</td><td>6.0</td><td>Ganos volumn mesh extension for POLARDB</td></tr><tr><td>postgis_tiger_geocoder</td><td>3.3.2</td><td>Ganos PostGIS tiger geocoder</td></tr><tr><td>postgis_topology</td><td>3.3.2</td><td>Ganos PostGIS topology</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-e59a81d2edf1c2072f834e4d8ef376db>18.11 - PostgresML</h1><div class=lead>How to deploy PostgresML with Pigsty: ML, training, inference, Embedding, RAG inside DB.</div><p><a href=https://postgresml.org/>PostgresML</a> is a PostgreSQL extension that supports the latest large language models (LLM), vector operations, classical machine learning, and traditional Postgres application workloads.</p><p>PostgresML (pgml) is a PostgreSQL extension written in Rust. You can run standalone Docker images, but this documentation is not a docker-compose template introduction, for reference only.</p><p>PostgresML officially supports Ubuntu 22.04, but we also maintain RPM versions for EL 8/9, if you don&rsquo;t need CUDA and NVIDIA-related features.</p><p>You need internet access on database nodes to download Python dependencies from PyPI and models from HuggingFace.</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>PostgresML is Deprecated</div><p>Because the company behind it has ceased operations.</p></div><hr><h2 id=configuration>Configuration</h2><p>PostgresML is an extension written in Rust, officially supporting Ubuntu. Pigsty maintains RPM versions of PostgresML on EL8 and EL9.</p><p><strong>Creating a New Cluster</strong></p><p>PostgresML 2.7.9 is available for PostgreSQL 15, supporting Ubuntu 22.04 (official), Debian 12, and EL 8/9 (maintained by Pigsty). To enable <code>pgml</code>, you first need to install the extension:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgml, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgml_15 pgvector_15 wal2json_15 repack_15&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># ubuntu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#pg_extensions: [ &#39;postgresql-pgml-15 postgresql-15-pgvector postgresql-15-wal2json postgresql-15-repack&#39; ]  # ubuntu</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>On EL 8/9, the extension name is <code>pgml_15</code>, corresponding to the Ubuntu/Debian name <code>postgresql-pgml-15</code>. You also need to add <code>pgml</code> to <code>pg_libs</code>.</p><p><strong>Enabling on an Existing Cluster</strong></p><p>To enable <code>pgml</code> on an existing cluster, you can install it using Ansible&rsquo;s <code>package</code> module:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible pg-meta -m package -b -a <span style=color:#4e9a06>&#39;name=pgml_15&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ansible el8,el9 -m package -b -a &#39;name=pgml_15&#39;           # EL 8/9</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ansible u22 -m package -b -a &#39;name=postgresql-pgml-15&#39;    # Ubuntu 22.04 jammy</span>
</span></span></code></pre></div><hr><h2 id=python-dependencies>Python Dependencies</h2><p>You also need to install PostgresML&rsquo;s Python dependencies on cluster nodes. Official tutorial: <a href=https://postgresml.org/docs/guides/developer-docs/installation>Installation Guide</a></p><p><strong>Install Python and PIP</strong></p><p>Ensure <code>python3</code>, <code>pip</code>, and <code>venv</code> are installed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ubuntu 22.04 (python3.10), need to install pip and venv using apt</span>
</span></span><span style=display:flex><span>sudo apt install -y python3 python3-pip python3-venv
</span></span></code></pre></div><p>For EL 8 / EL9 and compatible distributions, you can use python3.11:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 8/9, can upgrade the default pip and virtualenv</span>
</span></span><span style=display:flex><span>sudo yum install -y python3.11 python3.11-pip       <span style=color:#8f5902;font-style:italic># install latest python3.11</span>
</span></span><span style=display:flex><span>python3.11 -m pip install --upgrade pip virtualenv  <span style=color:#8f5902;font-style:italic># use python3.11 on EL8 / EL9</span>
</span></span></code></pre></div><details><summary>Using PyPI Mirrors</summary><p>For users in mainland China, we recommend using Tsinghua University&rsquo;s PyPI <a href=https://mirrors.tuna.tsinghua.edu.cn/help/pypi/>mirror</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip config <span style=color:#204a87>set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple    <span style=color:#8f5902;font-style:italic># set global mirror (recommended)</span>
</span></span><span style=display:flex><span>pip install -i https://pypi.tuna.tsinghua.edu.cn/simple some-package        <span style=color:#8f5902;font-style:italic># use for single installation</span>
</span></span></code></pre></div></details><p><strong>Install Dependencies</strong></p><p>Create a Python virtual environment and use <code>pip</code> to install dependencies from <a href=https://github.com/postgresml/postgresml/blob/master/pgml-extension/requirements.txt><code>requirements.txt</code></a> and <a href=https://github.com/postgresml/postgresml/blob/master/pgml-extension/requirements-xformers.txt><code>requirements-xformers.txt</code></a>.</p><blockquote><p>If you&rsquo;re using EL 8/9, replace <code>python3</code> with <code>python3.11</code> in the following commands.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>su - postgres<span style=color:#000;font-weight:700>;</span>                          <span style=color:#8f5902;font-style:italic># create virtual environment as database superuser</span>
</span></span><span style=display:flex><span>mkdir -p /data/pgml<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> /data/pgml<span style=color:#000;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic># create virtual environment directory</span>
</span></span><span style=display:flex><span>python3    -m venv /data/pgml           <span style=color:#8f5902;font-style:italic># create virtual environment directory (Ubuntu 22.04)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>source</span> /data/pgml/bin/activate          <span style=color:#8f5902;font-style:italic># activate virtual environment</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># write Python dependencies and install with pip</span>
</span></span><span style=display:flex><span>cat &gt; /data/pgml/requirments.txt <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>accelerate==0.22.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>auto-gptq==0.4.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>bitsandbytes==0.41.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>catboost==1.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ctransformers==0.2.27
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>datasets==2.14.5
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deepspeed==0.10.3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>huggingface-hub==0.17.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>InstructorEmbedding==1.0.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>lightgbm==4.1.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>orjson==3.9.7
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>pandas==2.1.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>rich==13.5.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>rouge==1.0.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>sacrebleu==2.3.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>sacremoses==0.0.53
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>scikit-learn==1.3.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>sentencepiece==0.1.99
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>sentence-transformers==2.2.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>tokenizers==0.13.3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>torch==2.0.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>torchaudio==2.0.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>torchvision==0.15.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>tqdm==4.66.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>transformers==4.33.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>xgboost==2.0.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>langchain==0.0.287
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>einops==0.6.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>pynvml==11.5.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># install dependencies using pip in the virtual environment</span>
</span></span><span style=display:flex><span>python3 -m pip install -r /data/pgml/requirments.txt
</span></span><span style=display:flex><span>python3 -m pip install <span style=color:#000>xformers</span><span style=color:#ce5c00;font-weight:700>==</span>0.0.21 --no-dependencies
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># additionally, 3 Python packages need to be installed globally using sudo!</span>
</span></span><span style=display:flex><span>sudo python3 -m pip install xgboost lightgbm scikit-learn
</span></span></code></pre></div><hr><h2 id=enable-postgresml>Enable PostgresML</h2><p>After installing the <code>pgml</code> extension and Python dependencies on all cluster nodes, you can enable <code>pgml</code> on the PostgreSQL cluster.</p><p>Use the <code>patronictl</code> command to <a href=https://pigsty.io/docs/pgsql/admin/#config-cluster>configure the cluster</a>, add <code>pgml</code> to <code>shared_preload_libraries</code>, and specify your virtual environment directory in <code>pgml.venv</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgml, timescaledb, pg_stat_statements, auto_explain</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgml.venv</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/pgml&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Then restart the database cluster and create the extension using SQL commands:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- also recommend installing pgvector!
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgml</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- create PostgresML in the current database
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pgml</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- print PostgresML version information
</span></span></span></code></pre></div><p>If everything is normal, you should see output similar to the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># create extension pgml;</span>
</span></span><span style=display:flex><span>INFO:  Python version: 3.11.2 <span style=color:#ce5c00;font-weight:700>(</span>main, Oct  <span style=color:#0000cf;font-weight:700>5</span> 2023, 16:06:03<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>[</span>GCC 8.5.0 <span style=color:#0000cf;font-weight:700>20210514</span> <span style=color:#ce5c00;font-weight:700>(</span>Red Hat 8.5.0-18<span style=color:#ce5c00;font-weight:700>)]</span>
</span></span><span style=display:flex><span>INFO:  Scikit-learn 1.3.0, XGBoost 2.0.0, LightGBM 4.1.0, NumPy 1.26.1
</span></span><span style=display:flex><span>CREATE EXTENSION
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># SELECT pgml.version(); -- print PostgresML version information</span>
</span></span><span style=display:flex><span> version
</span></span><span style=display:flex><span>---------
</span></span><span style=display:flex><span> 2.7.8
</span></span></code></pre></div><p>Done! For more details, please refer to the official PostgresML documentation: <a href=https://postgresml.org/docs/guides/use-cases/>https://postgresml.org/docs/guides/use-cases/</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-227e1bd7e26827efbe4f8ed91ee4c679>18.12 - Greenplum</h1><div class=lead>Deploy/Monitor Greenplum clusters with Pigsty, build Massively Parallel Processing (MPP) PostgreSQL data warehouse clusters!</div><p>Pigsty supports deploying Greenplum clusters and its derivative distribution YMatrixDB, and provides the capability to integrate existing Greenplum deployments into Pigsty monitoring.</p><hr><h2 id=overview>Overview</h2><p>Greenplum / YMatrix cluster deployment capabilities are only available in the professional/enterprise editions and are not currently open source.</p><hr><h2 id=installation>Installation</h2><p>Pigsty provides installation packages for Greenplum 6 (@el7) and Greenplum 7 (@el8). Open source users can install and configure them manually.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 7 Only (Greenplum6)</span>
</span></span><span style=display:flex><span>./node.yml -t node_install  -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;open-source-greenplum-db-6&#34;]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 8 Only (Greenplum7)</span>
</span></span><span style=display:flex><span>./node.yml -t node_install  -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;open-source-greenplum-db-7&#34;]}&#39;</span>
</span></span></code></pre></div><hr><h2 id=configuration>Configuration</h2><p>To define a Greenplum cluster, you need to use <code>pg_mode</code> = <code>gpsql</code> and additional identity parameters <code>pg_shard</code> and <code>gp_role</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#================================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                        GPSQL Clusters                          #</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#================================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cluster: mx-mdw (gp master)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>mx-mdw</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , nodename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-mdw-1 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>gp_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>master         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># this cluster is used as greenplum master</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgsql sharding name &amp; gpsql deployment name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-mdw      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># this master cluster name is mx-mdw</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: matrixmgr , extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>matrixdbts } ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta , password: DBUser.Meta , pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor , password: DBUser.Monitor , roles: [ dbrole_readonly ], superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># enable pgbouncer for greenplum master</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># enable pgbouncer_exporter for greenplum master</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporter_params</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;host=127.0.0.1&amp;sslmode=disable&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># use 127.0.0.1 as local monitor host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cluster: mx-sdw (gp master)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>mx-sdw</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>nodename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-sdw-1       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># greenplum segment node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># greenplum segment instances</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6000</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg1, pg_seq: 1, pg_role: primary , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9633</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg2, pg_seq: 2, pg_role: replica , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9634</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>nodename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-sdw-2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6000</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg2, pg_seq: 1, pg_role: primary , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9633</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg3, pg_seq: 2, pg_role: replica , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9634</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>nodename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-sdw-3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6000</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg3, pg_seq: 1, pg_role: primary , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9633</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg1, pg_seq: 2, pg_role: replica , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9634</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>gp_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>segment              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># these are nodes for gp segments</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgsql sharding name &amp; gpsql deployment name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-sdw            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># these segment clusters name is mx-sdw</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_preflight_skip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># skip preflight check (since pg_seq &amp; pg_role &amp; pg_cluster not exists)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporter_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_exporter_basic.yml                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use basic config to avoid segment server crash</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporter_params</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;options=-c%20gp_role%3Dutility&amp;sslmode=disable&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># use gp_role = utility to connect to segments</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Additionally, PG Exporter requires extra connection parameters to connect to Greenplum Segment instances for metric collection.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a970dfd99688547f0ffb0bf4d5c4de61>18.13 - Cloudberry</h1><div class=lead>Deploy/Monitor Cloudberry clusters with Pigsty, an MPP data warehouse cluster forked from Greenplum!</div><hr><h2 id=installation>Installation</h2><p>Pigsty provides installation packages for Greenplum 6 (@el7) and Greenplum 7 (@el8). Open source users can install and configure them manually.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 7 Only (Greenplum6)</span>
</span></span><span style=display:flex><span>./node.yml -t node_install  -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;cloudberrydb&#34;]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 8 Only (Greenplum7)</span>
</span></span><span style=display:flex><span>./node.yml -t node_install  -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;cloudberrydb&#34;]}&#39;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2342a2eaca8515e616cb1dfa8c4db39d>18.14 - Neon</h1><div class=lead>Use Neon&rsquo;s open-source Serverless PostgreSQL kernel to build flexible, scale-to-zero, forkable PG services.</div><p><a href=https://github.com/neondatabase/neon><strong>Neon</strong></a> adopts a storage and compute separation architecture, providing seamless autoscaling, scale to zero, and unique database branching capabilities.</p><p>Neon official website: <a href=https://neon.tech/>https://neon.tech/</a></p><p>The compiled binaries of Neon are excessively large and are currently not available to open-source users. It is currently in the pilot stage. If you have requirements, please contact Pigsty sales.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-06a73ab7adbd73b0e635c3d9403cab4e>19 - FAQ</h1><div class=lead>Frequently asked questions about PostgreSQL</div><hr><h2 id=why-cant-my-current-user-use-the-pg-admin-alias>Why can&rsquo;t my current user use the <code>pg</code> admin alias?</h2><p>Starting from Pigsty v4.0, permissions to manage global Patroni / PostgreSQL clusters using the <code>pg</code> admin alias have been tightened to the admin group (<code>admin</code>) on admin nodes.</p><p>The admin user (<code>dba</code>) created by the <a href=/docs/node/playbook#nodeyml><strong><code>node.yml</code></strong></a> playbook has this permission by default. If your current user wants this permission, you need to explicitly add them to the <code>admin</code> group:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo usermod -aG admin &lt;username&gt;
</span></span></code></pre></div><hr><h2 id=pgsql-init-fails-fail-to-wait-for-postgrespatroni-primary>PGSQL Init Fails: Fail to wait for postgres/patroni primary</h2><p>There are multiple possible causes for this error. You need to <a href=https://github.com/pgsty/pigsty/discussions/338>check</a> Ansible, Systemd / Patroni / PostgreSQL logs to find the real cause.</p><ul><li>Possibility 1: Cluster config error - find and fix the incorrect config items.</li><li>Possibility 2: A cluster with the same name exists, or the previous same-named cluster primary was improperly removed.</li><li>Possibility 3: Residual garbage metadata from a same-named cluster in DCS - decommissioning wasn&rsquo;t completed properly. Use <code>etcdctl del --prefix /pg/&lt;cls></code> to manually delete residual data (be careful).</li><li>Possibility 4: Your PostgreSQL or node-related RPM pkgs were not successfully installed.</li><li>Possibility 5: Your Watchdog kernel module was not properly enabled/loaded.</li><li>Possibility 6: The locale you specified during database init doesn&rsquo;t exist (e.g., used <code>en_US.UTF8</code> but English language pack or Locale support wasn&rsquo;t installed).</li><li>If you encounter other causes, please submit an Issue or ask the community for help.</li></ul><hr><h2 id=pgsql-init-fails-fail-to-wait-for-postgrespatroni-replica>PGSQL Init Fails: Fail to wait for postgres/patroni replica</h2><p>There are several possible causes:</p><p><strong>Immediate failure</strong>: Usually due to config errors, network issues, corrupted DCS metadata, etc. You must check <code>/pg/log</code> to find the actual cause.</p><p><strong>Failure after a while</strong>: This might be due to source instance data corruption. See PGSQL FAQ: How to create a replica when data is corrupted?</p><p><strong>Timeout after a long time</strong>: If the <code>wait for postgres replica</code> task takes 30 minutes or longer and fails due to timeout, this is common for large clusters (e.g., 1TB+, may take hours to create a replica).</p><p>In this case, the underlying replica creation process is still ongoing. You can use <code>pg list &lt;cls></code> to check cluster status and wait for the replica to catch up with the primary. Then use the following command to continue with remaining tasks and complete the full replica init:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_hba,pg_reload,pg_backup,pgbouncer,pg_vip,pg_dns,pg_service,pg_exporter,pg_register -l &lt;problematic_replica&gt;
</span></span></code></pre></div><hr><h2 id=pgsql-init-fails-abort-due-to-pg_safeguard-enabled>PGSQL Init Fails: ABORT due to pg_safeguard enabled</h2><p>This means the PostgreSQL instance being cleaned has the deletion safeguard enabled. Disable <code>pg_safeguard</code> to remove the Postgres instance.</p><p>If the deletion safeguard <a href=/docs/pgsql/param#pg_safeguard><code>pg_safeguard</code></a> is enabled, you cannot remove running PGSQL instances using <code>bin/pgsql-rm</code> or the <code>pgsql-rm.yml</code> playbook.</p><p>To disable <code>pg_safeguard</code>, you can set <code>pg_safeguard</code> to <code>false</code> in the config inventory, or use the command param <code>-e pg_safeguard=false</code> when executing the playbook.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> -l &lt;cls_to_remove&gt;    <span style=color:#8f5902;font-style:italic># Force override pg_safeguard</span>
</span></span></code></pre></div><hr><h2 id=how-to-ensure-no-data-loss-during-failover>How to Ensure No Data Loss During Failover?</h2><blockquote><p>Use the <code>crit.yml</code> param template, set <code>pg_rpo</code> to <code>0</code>, or <a href=/docs/pgsql/admin#config-cluster>config the cluster</a> for sync commit mode.</p></blockquote><p>Consider using <a href=/docs/pgsql/config#sync-standby><strong>Sync Standby</strong></a> and <a href=/docs/pgsql/config#quorum-commit><strong>Quorum Commit</strong></a> to ensure zero data loss during failover.</p><p>For more details, see the intro in <a href=/docs/setup/security#availability>Security Considerations - Availability</a>.</p><hr><h2 id=how-to-rescue-when-disk-is-full>How to Rescue When Disk is Full?</h2><p>If the disk is full and even Shell commands cannot execute, <code>rm -rf /pg/dummy</code> can release some emergency space.</p><p>By default, <a href=/docs/pgsql/param#pg_dummy_filesize><code>pg_dummy_filesize</code></a> is set to <code>64MB</code>. In prod envs, it&rsquo;s recommended to increase it to <code>8GB</code> or larger.</p><p>It will be placed at <code>/pg/dummy</code> path on the PGSQL main data disk. You can delete this file to free up some emergency space:</p><p>At least it will allow you to run some shell scripts on that node to further reclaim other space (e.g., logs/WAL, stale data, WAL archives and backups).</p><hr><h2 id=how-to-create-a-replica-when-cluster-data-is-corrupted>How to Create a Replica When Cluster Data is Corrupted?</h2><p>Pigsty sets the <code>clonefrom: true</code> tag in the patroni config of all instances, marking the instance as available for creating replicas.</p><p>If an instance has corrupted data files causing errors when creating new replicas, you can set <code>clonefrom: false</code> to avoid pulling data from the corrupted instance. Here&rsquo;s how:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi /pg/bin/patroni.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tags:
</span></span><span style=display:flex><span>  nofailover: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>  clonefrom: <span style=color:#204a87>true</span>      <span style=color:#8f5902;font-style:italic># ----------&gt; change to false</span>
</span></span><span style=display:flex><span>  noloadbalance: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>  nosync: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>  version:  <span style=color:#4e9a06>&#39;15&#39;</span>
</span></span><span style=display:flex><span>  spec: <span style=color:#4e9a06>&#39;4C.8G.50G&#39;</span>
</span></span><span style=display:flex><span>  conf: <span style=color:#4e9a06>&#39;oltp.yml&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ systemctl reload patroni    <span style=color:#8f5902;font-style:italic># Reload Patroni config</span>
</span></span></code></pre></div><hr><h2 id=what-is-the-perf-overhead-of-postgresql-monitoring>What is the Perf Overhead of PostgreSQL Monitoring?</h2><p>A regular PostgreSQL instance scrape takes about 200ms. The scrape interval defaults to 10 seconds, which is almost negligible for a prod multi-core database instance.</p><p>Note that Pigsty enables in-database object monitoring by default, so if your database has hundreds of thousands of table/index objects, scraping may increase to several seconds.</p><p>You can modify Prometheus&rsquo;s scrape frequency. Please ensure: the scrape cycle should be significantly longer than the duration of a single scrape.</p><hr><h2 id=how-to-monitor-an-existing-postgresql-instance>How to Monitor an Existing PostgreSQL Instance?</h2><p>Detailed monitoring config instructions are provided in <a href=/docs/pgsql/monitor>PGSQL Monitor</a>.</p><hr><h2 id=how-to-manually-remove-postgresql-monitoring-targets>How to Manually Remove PostgreSQL Monitoring Targets?</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -t rm_metrics -l &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># Remove all instances of cluster &#39;cls&#39; from victoria</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-rm &lt;ins&gt;     <span style=color:#8f5902;font-style:italic># Remove a single instance &#39;ins&#39; monitoring object from Victoria, especially suitable for removing added external instances</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ac541723370b0cdbf999a3eb82ccfc89>20 - Misc</h1><div class=lead>Miscellaneous Topics</div></div><div class=td-content><h1 id=pg-3a18781032fdda789d5f38d1dd1c01a2>20.1 - Service / Access</h1><div class=lead>Separate read and write operations, route traffic correctly, and deliver PostgreSQL cluster capabilities reliably.</div><blockquote><p>Separate read and write operations, route traffic correctly, and deliver PostgreSQL cluster capabilities reliably.</p></blockquote><p><a href=#service-overview>Service</a> is an abstraction: it is the form in which database clusters provide capabilities to the outside world and encapsulates the details of the underlying cluster.</p><p>Services are critical for <a href=#accessing-services>stable access</a> in production environments and show their value when <a href=/docs/concept/ha>high availability</a> clusters automatically fail over. <a href=#single-node-users>Single-node users</a> typically don&rsquo;t need to worry about this concept.</p><hr><h2 id=single-node-users>Single-Node Users</h2><p>The concept of &ldquo;service&rdquo; is for production environments. Personal users/single-node clusters can simply access the database directly using instance name/IP address.</p><p>For example, Pigsty&rsquo;s default single-node <code>pg-meta</code>.<code>meta</code> database can be connected directly using three different users:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># Connect directly with DBA superuser</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># Connect with default business admin user</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># Connect with default read-only user via instance domain name</span>
</span></span></code></pre></div><hr><h2 id=service-overview>Service Overview</h2><p>In real-world production environments, we use replication-based primary-replica database clusters. In a cluster, there is one and only one instance as the leader (<a href=/docs/pgsql/config#primary>primary</a>) that can accept writes.
Other instances (<a href=/docs/pgsql/config#replica>replicas</a>) continuously fetch change logs from the cluster leader and stay consistent with it. At the same time, replicas can also handle read-only requests, significantly reducing the load on the primary in read-heavy scenarios.
Therefore, separating write requests and read-only requests to the cluster is a very common practice.</p><p>In addition, for production environments with high-frequency short connections, we also pool requests through a connection pool middleware (Pgbouncer) to reduce the overhead of creating connections and backend processes. But for scenarios such as ETL and change execution, we need to bypass the connection pool and access the database directly.
At the same time, high-availability clusters will experience failover when failures occur, and failover will cause changes to the cluster&rsquo;s leader. Therefore, high-availability database solutions require that write traffic can automatically adapt to changes in the cluster&rsquo;s leader.
These different access requirements (read-write separation, pooling and direct connection, automatic failover adaptation) ultimately abstract the concept of <strong>Service</strong>.</p><p>Typically, database clusters must provide this most basic service:</p><ul><li><strong>Read-Write Service (primary)</strong>: Can read and write to the database</li></ul><p>For production database clusters, at least these two services should be provided:</p><ul><li><strong>Read-Write Service (primary)</strong>: Write data: can only be carried by the primary.</li><li><strong>Read-Only Service (replica)</strong>: Read data: can be carried by replicas, or by the primary if there are no replicas</li></ul><p>In addition, depending on specific business scenarios, there may be other services, such as:</p><ul><li><strong>Default Direct Service (default)</strong>: Allows (admin) users to access the database directly, bypassing the connection pool</li><li><strong>Offline Replica Service (offline)</strong>: Dedicated replicas that do not handle online read-only traffic, used for ETL and analytical queries</li><li><strong>Standby Replica Service (standby)</strong>: Read-only service without replication lag, handled by <a href=/docs/pgsql/config#sync-standby>sync standby</a>/primary for read-only queries</li><li><strong>Delayed Replica Service (delayed)</strong>: Access old data from the same cluster at a previous point in time, handled by <a href=/docs/pgsql/config#delayed-cluster>delayed replica</a></li></ul><hr><h2 id=default-services>Default Services</h2><p>Pigsty provides four different services by default for each PostgreSQL database cluster. Here are the default services and their definitions:</p><table><thead><tr><th>Service</th><th>Port</th><th>Description</th></tr></thead><tbody><tr><td><a href=#primary-service>primary</a></td><td>5433</td><td>Production read-write, connects to primary connection pool (6432)</td></tr><tr><td><a href=#replica-service>replica</a></td><td>5434</td><td>Production read-only, connects to replica connection pool (6432)</td></tr><tr><td><a href=#default-service>default</a></td><td>5436</td><td>Admin, ETL writes, direct access to primary (5432)</td></tr><tr><td><a href=#offline-service>offline</a></td><td>5438</td><td>OLAP, ETL, personal users, interactive queries</td></tr></tbody></table><p>Taking the default <code>pg-meta</code> cluster as an example, it provides four default services:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5433/meta   <span style=color:#8f5902;font-style:italic># pg-meta-primary : production read-write via primary pgbouncer(6432)</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5434/meta   <span style=color:#8f5902;font-style:italic># pg-meta-replica : production read-only via replica pgbouncer(6432)</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@pg-meta:5436/meta     <span style=color:#8f5902;font-style:italic># pg-meta-default : direct connection via primary postgres(5432)</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_stats:DBUser.Stats@pg-meta:5438/meta <span style=color:#8f5902;font-style:italic># pg-meta-offline : direct connection via offline postgres(5432)</span>
</span></span></code></pre></div><p>You can see how these four services work from the sample cluster <a href=/docs/pgsql/config>architecture diagram</a>:</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>Note that the <code>pg-meta</code> domain name points to the cluster&rsquo;s L2 VIP, which in turn points to the haproxy load balancer on the cluster primary, which routes traffic to different instances. See <a href=#accessing-services>Accessing Services</a> for details.</p><hr><h2 id=service-implementation>Service Implementation</h2><p>In Pigsty, services are implemented using <a href=/docs/node/param#haproxy>haproxy</a> on <a href=/docs/node>nodes</a>, differentiated by different ports on host nodes.</p><p>Haproxy is enabled by default on each node managed by Pigsty to expose services, and database nodes are no exception.
Although nodes in a cluster have primary-replica distinctions from the database perspective, from the service perspective, each node is the same:
This means that even if you access a replica node, as long as you use the correct service port, you can still use the primary&rsquo;s read-write service.
This design can hide complexity: so as long as you can access any instance on a PostgreSQL cluster, you can completely access all services.</p><p>This design is similar to NodePort services in Kubernetes. Similarly, in Pigsty, each service includes the following two core elements:</p><ol><li>Access endpoints exposed through NodePort (port number, where to access?)</li><li>Target instances selected through Selectors (instance list, who carries the load?)</li></ol><p>Pigsty&rsquo;s service delivery boundary stops at the cluster&rsquo;s HAProxy, and users can access these load balancers in various ways. See <a href=#accessing-services>Accessing Services</a>.</p><p>All services are declared through configuration files. For example, the PostgreSQL default services are defined by the <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> parameter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can also define additional services in <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>. Both <code>pg_default_services</code> and <code>pg_services</code> are arrays of <a href=#defining-services>service definition</a> objects.</p><hr><h2 id=defining-services>Defining Services</h2><p>Pigsty allows you to define your own services:</p><ul><li><a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a>: Services uniformly exposed by all PostgreSQL clusters, four by default.</li><li><a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>: Additional PostgreSQL services, can be defined at global or cluster level as needed.</li><li><a href=/docs/node/param#haproxy_services><code>haproxy_services</code></a>: Directly customize HAProxy service content, can be used for accessing other components</li></ul><p>For PostgreSQL clusters, you typically only need to focus on the first two.
Each service definition generates a new configuration file in the configuration directory of all related HAProxy instances: <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/service.j2><code>/etc/haproxy/&lt;svcname>.cfg</code></a>
Here&rsquo;s a custom service example <code>standby</code>: when you want to provide a read-only service without replication lag, you can add this record to <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name: standby                   # Required, service name, final svc name uses `pg_cluster` as prefix, e.g.</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># Required, exposed service port (as kubernetes service node port mode)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># Optional, IP address the service binds to, all IP addresses by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># Required, service member selector, uses JMESPath to filter configuration manifest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Optional, service member selector (backup), instances selected here only carry the service when all default selector instances are down</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, target port, default|postgres|pgbouncer|&lt;port_number&gt;, defaults to &#39;default&#39;, Default means using pg_default_service_dest value to ultimately decide</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>check: /sync                    # Optional, health check URL path, defaults to /, here uses Patroni API</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync, only sync standby and primary return 200 healthy status code</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, maximum number of allowed frontend connections, defaults to 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>balance: roundrobin             # Optional, haproxy load balancing algorithm (defaults to roundrobin, other options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>leastconn)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The above service definition will be converted to haproxy configuration file <code>/etc/haproxy/pg-test-standby.conf</code> on the sample three-node <code>pg-test</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service: pg-test-standby @ 10.10.10.11:5435</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service instances 10.10.10.11, 10.10.10.13, 10.10.10.12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service backups   10.10.10.11</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>listen pg-test-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5435           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Binds port 5435 on all IP addresses</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Load balancer works on TCP protocol</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Maximum connections 5000, can be increased as needed</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Load balancing algorithm is rr round-robin, can also use leastconn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Enable HTTP health check</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Keep HTTP connection</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /sync  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- Here uses /sync, Patroni health check API, only sync standby and primary return 200 healthy status code</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- Health check return code 200 means normal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers: # All three instances of pg-test cluster are selected by selector: &#34;[]&#34;, since there are no filter conditions, they all become backend servers for pg-test-replica service. But due to /sync health check, only primary and sync standby can actually handle requests</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;----- Only primary satisfies condition pg_role == `primary`, selected by backup selector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100         #        Therefore serves as service fallback instance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>normally doesn&#39;t handle requests, only handles read-only requests when all other replicas fail, thus maximally avoiding read-write service being affected by read-only service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Here, all three instances of the <code>pg-test</code> cluster are selected by <code>selector: "[]"</code>, rendered into the backend server list of the <code>pg-test-replica</code> service. But due to the <code>/sync</code> health check, Patroni Rest API only returns healthy HTTP 200 status code on the primary and <a href=/docs/pgsql/config#sync-standby>sync standby</a>, so only the primary and sync standby can actually handle requests.
Additionally, the primary satisfies the condition <code>pg_role == primary</code>, is selected by the backup selector, and is marked as a backup server, only used when no other instances (i.e., sync standby) can meet the demand.</p><hr><h2 id=primary-service>Primary Service</h2><p>The Primary service is perhaps the most critical service in production environments. It provides read-write capability to the database cluster on port 5433. The service definition is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>The selector parameter <code>selector: "[]"</code> means all cluster members will be included in the Primary service</li><li>But only the primary can pass the health check (<code>check: /primary</code>) and actually carry Primary service traffic.</li><li>The destination parameter <code>dest: default</code> means the Primary service destination is affected by the <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> parameter</li><li>The default value <code>default</code> of <code>dest</code> will be replaced by the value of <code>pg_default_service_dest</code>, which defaults to <code>pgbouncer</code>.</li><li>By default, the Primary service destination is the connection pool on the primary, which is the port specified by <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a>, defaulting to 6432</li></ul><p>If the value of <code>pg_default_service_dest</code> is <code>postgres</code>, then the primary service destination will bypass the connection pool and use the PostgreSQL database port directly (<a href=/docs/pgsql/param#pg_port><code>pg_port</code></a>, default 5432). This parameter is very useful for scenarios that don&rsquo;t want to use a connection pool.</p><details><summary>Example: haproxy configuration for pg-test-primary</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>listen pg-test-primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5433        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary service defaults to port 5433</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /primary</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary service defaults to Patroni RestAPI /primary health check</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><p>Patroni&rsquo;s <a href=/docs/concept/ha>high availability</a> mechanism ensures that at most one instance&rsquo;s <code>/primary</code> health check is true at any time, so the Primary service will always route traffic to the primary instance.</p><p>One benefit of using the Primary service instead of direct database connection is that if the cluster has a split-brain situation for some reason (e.g., kill -9 killing the primary Patroni without watchdog), Haproxy can still avoid split-brain in this case, because it will only distribute traffic when Patroni is alive and returns primary status.</p><hr><h2 id=replica-service>Replica Service</h2><p>The Replica service is second only to the Primary service in importance in production environments. It provides read-only capability to the database cluster on port 5434. The service definition is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>The selector parameter <code>selector: "[]"</code> means all cluster members will be included in the Replica service</li><li>All instances can pass the health check (<code>check: /read-only</code>) and carry Replica service traffic.</li><li>Backup selector: <code>[? pg_role == 'primary' || pg_role == 'offline' ]</code> marks the primary and <a href=/docs/pgsql/config#offline-replica>offline replicas</a> as backup servers.</li><li>Only when all <a href=/docs/pgsql/config#replica>normal replicas</a> are down will the Replica service be carried by the primary or offline replicas.</li><li>The destination parameter <code>dest: default</code> means the Replica service destination is also affected by the <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> parameter</li><li>The default value <code>default</code> of <code>dest</code> will be replaced by the value of <code>pg_default_service_dest</code>, which defaults to <code>pgbouncer</code>, same as the <a href=#primary-service>Primary service</a></li><li>By default, the Replica service destination is the connection pool on the replicas, which is the port specified by <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a>, defaulting to 6432</li></ul><details><summary>Example: haproxy configuration for pg-test-replica</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5434</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /read-only</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><p>The Replica service is very flexible: if there are surviving dedicated Replica instances, it will prioritize using these instances to handle read-only requests. Only when all replica instances are down will the primary handle read-only requests. For the common one-primary-one-replica two-node cluster, this means: use the replica as long as it&rsquo;s alive, use the primary when the replica is down.</p><p>Additionally, unless all dedicated read-only instances are down, the Replica service will not use dedicated Offline instances, thus avoiding mixing online fast queries and offline slow queries together, interfering with each other.</p><hr><h2 id=default-service>Default Service</h2><p>The Default service provides services on port 5436. It is a variant of the Primary service.</p><p>The Default service always bypasses the connection pool and connects directly to PostgreSQL on the primary. This is useful for admin connections, ETL writes, CDC data change capture, etc.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If <code>pg_default_service_dest</code> is changed to <code>postgres</code>, then the Default service is completely equivalent to the Primary service except for port and name. In this case, you can consider removing Default from default services.</p><details><summary>Example: haproxy configuration for pg-test-default</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-default</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5436         # &lt;--- Except for listening port/target port and service name, other configurations are exactly the same as primary service</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><hr><h2 id=offline-service>Offline Service</h2><p>The Offline service provides services on port 5438. It also bypasses the connection pool to directly access the PostgreSQL database, typically used for slow queries/analytical queries/ETL reads/personal user interactive queries. Its service definition is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The Offline service routes traffic directly to dedicated <a href=/docs/pgsql/config#offline-replica>offline replicas</a>, or normal <a href=/docs/pgsql/config#replica>read-only instances</a> with the <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> flag.</p><ul><li>The selector parameter filters two types of instances from the cluster: offline replicas with <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code>, or normal <a href=/docs/pgsql/config#replica>read-only instances</a> with <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code></li><li>The main difference between dedicated offline replicas and flagged normal replicas is: the former does not handle <a href=#replica-service>Replica service</a> requests by default, avoiding mixing fast and slow requests together, while the latter does by default.</li><li>The backup selector parameter filters one type of instance from the cluster: normal replicas without offline flag. This means if offline instances or flagged normal replicas fail, other normal replicas can be used to carry the Offline service.</li><li>The health check <code>/replica</code> only returns 200 for replicas, the primary returns an error, so the Offline service will never distribute traffic to the primary instance, even if only this primary is left in the cluster.</li><li>At the same time, the primary instance is neither selected by the selector nor by the backup selector, so it will never carry the Offline service. Therefore, the Offline service can always avoid user access to the primary, thus avoiding impact on the primary.</li></ul><details><summary>Example: haproxy configuration for pg-test-offline</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-offline</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5438</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100 backup</span>
</span></span></code></pre></div></details><p>The Offline service provides limited read-only service, typically used for two types of queries: interactive queries (personal users), slow queries and long transactions (analytics/ETL).</p><p>The Offline service requires extra maintenance care: when the cluster experiences primary-replica switchover or automatic failover, the cluster&rsquo;s instance roles change, but Haproxy&rsquo;s configuration does not automatically change. For clusters with multiple replicas, this is usually not a problem.
However, for simplified small clusters with one primary and one replica running Offline queries, primary-replica switchover means the replica becomes the primary (health check fails), and the original primary becomes a replica (not in the Offline backend list), so no instance can carry the Offline service. Therefore, you need to manually <a href=/docs/pgsql/admin#reload-services>reload services</a> to make the changes effective.</p><p>If your business model is relatively simple, you can consider removing the Default service and Offline service, and use the Primary service and Replica service to connect directly to the database.</p><hr><h2 id=reload-services>Reload Services</h2><p>When cluster members change, such as adding/removing replicas, primary-replica switchover, or adjusting relative weights, you need to <a href=/docs/pgsql/admin#reload-services>reload services</a> to make the changes effective.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ip...<span style=color:#ce5c00;font-weight:700>]</span>         <span style=color:#8f5902;font-style:italic># Reload services for lb cluster or lb instance</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ./pgsql.yml -t pg_service         # Actual ansible task for reloading services</span>
</span></span></code></pre></div><hr><h2 id=accessing-services>Accessing Services</h2><p>Pigsty&rsquo;s service delivery boundary stops at the cluster&rsquo;s HAProxy. Users can access these load balancers in various ways.</p><p>The typical approach is to use DNS or VIP access, binding them to all or any number of load balancers in the cluster.</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>You can use different host & port combinations, which provide PostgreSQL services in different ways.</p><p><strong>Host</strong></p><table><thead><tr><th>Type</th><th>Example</th><th>Description</th></tr></thead><tbody><tr><td>Cluster Domain</td><td><code>pg-test</code></td><td>Access via cluster domain name (resolved by dnsmasq @ infra node)</td></tr><tr><td>Cluster VIP Address</td><td><code>10.10.10.3</code></td><td>Access via L2 VIP address managed by <code>vip-manager</code>, bound to primary node</td></tr><tr><td>Instance Hostname</td><td><code>pg-test-1</code></td><td>Access via any instance hostname (resolved by dnsmasq @ infra node)</td></tr><tr><td>Instance IP Address</td><td><code>10.10.10.11</code></td><td>Access any instance&rsquo;s IP address</td></tr></tbody></table><p><strong>Port</strong></p><p>Pigsty uses different <strong>ports</strong> to distinguish <a href=#service-overview>pg services</a></p><table><thead><tr><th>Port</th><th>Service</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>Database</td><td>Direct access to postgres server</td></tr><tr><td>6432</td><td>pgbouncer</td><td>Middleware</td><td>Access postgres via connection pool middleware</td></tr><tr><td>5433</td><td>primary</td><td>Service</td><td>Access primary pgbouncer (or postgres)</td></tr><tr><td>5434</td><td>replica</td><td>Service</td><td>Access replica pgbouncer (or postgres)</td></tr><tr><td>5436</td><td>default</td><td>Service</td><td>Access primary postgres</td></tr><tr><td>5438</td><td>offline</td><td>Service</td><td>Access offline postgres</td></tr></tbody></table><p><strong>Combinations</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Access via cluster domain name</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; Primary direct connection</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; Primary connection pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Primary connection pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Replica connection pool -&gt; Replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Primary direct connection (for admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; Offline direct connection (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Direct access via cluster VIP</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; Primary direct access</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; Primary connection pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Primary connection pool -&gt; Primary</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Replica connection pool -&gt; Replica</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Primary direct connection (for admin)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; Offline direct connection (for ETL/personal queries)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify any cluster instance name directly</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; Database instance direct connection (single instance access)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; Connection pool -&gt; Database</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; Connection pool -&gt; Database read/write</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; Connection pool -&gt; Database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; Database direct connection</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; Database offline read/write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify any cluster instance IP directly</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># Database instance direct connection (direct instance specification, no automatic traffic distribution)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># Connection pool -&gt; Database</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; Connection pool -&gt; Database read/write</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; Connection pool -&gt; Database read-only</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; Database direct connection</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; Database offline read-write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Smart client: automatic read-write separation</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div><hr><h2 id=overriding-services>Overriding Services</h2><p>You can override default service configuration in multiple ways. A common requirement is to have <a href=#primary-service>Primary service</a> and <a href=#replica-service>Replica service</a> bypass the Pgbouncer connection pool and access the PostgreSQL database directly.</p><p>To achieve this, you can change <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> to <code>postgres</code>, so all services with <code>svc.dest='default'</code> in their service definitions will use <code>postgres</code> instead of the default <code>pgbouncer</code> as the target.</p><p>If you have already pointed <a href=#primary-service>Primary service</a> to PostgreSQL, then <a href=#default-service>default service</a> becomes redundant and can be considered for removal.</p><p>If you don&rsquo;t need to distinguish between personal interactive queries and analytical/ETL slow queries, you can consider removing <a href=#offline-service>Offline service</a> from the default service list <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a>.</p><p>If you don&rsquo;t need read-only replicas to share online read-only traffic, you can also remove <a href=#replica-service>Replica service</a> from the default service list.</p><hr><h2 id=delegating-services>Delegating Services</h2><p>Pigsty exposes PostgreSQL services through haproxy on nodes. All haproxy instances in the entire cluster are configured with the same <a href=#defining-services>service definitions</a>.</p><p>However, you can delegate pg services to specific node groups (e.g., dedicated haproxy load balancer cluster) instead of haproxy on PostgreSQL cluster members.</p><p>To do this, you need to override the default service definitions using <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> and set <a href=/docs/pgsql/param#pg_service_provider><code>pg_service_provider</code></a> to the proxy group name.</p><p>For example, this configuration will expose the pg cluster&rsquo;s primary service on the <code>proxy</code> haproxy node group on port 10013.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>proxy      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use load balancer from `proxy` group on port 10013</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 10013 ,dest: postgres  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Users need to ensure that the port for each delegated service is <strong>unique</strong> in the proxy cluster.</p><p>An example of using a dedicated load balancer cluster is provided in the 43-node production environment simulation <a href=/docs/deploy/sandbox><strong>sandbox</strong></a>: <a href=https://github.com/pgsty/pigsty/blob/main/conf/prod.yml#L111>prod.yml</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4d65100b9600fb960eb0de13b0e7c894>20.2 - User / Role</h1><div class=lead>Users/roles refer to logical objects within a database cluster created using the SQL commands <code>CREATE USER/ROLE</code>.</div><blockquote><p>In this context, users refer to logical objects within a database cluster created using the SQL commands <code>CREATE USER/ROLE</code>.</p></blockquote><p>In PostgreSQL, users belong directly to the database cluster rather than to a specific database. Therefore, when creating business databases and business users, you should follow the principle of &ldquo;users first, then databases.&rdquo;</p><hr><h2 id=defining-users>Defining Users</h2><p>Pigsty defines roles and users in database clusters through two configuration parameters:</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>: Defines globally unified roles and users</li><li><a href=/docs/pgsql/param#pg_users><code>pg_users</code></a>: Defines business users and roles at the database cluster level</li></ul><p>The former defines roles and users shared across the entire environment, while the latter defines business roles and users specific to individual clusters. Both have the same format and are arrays of user definition objects.</p><p>You can define multiple users/roles, and they will be created sequentially—first global, then cluster-level, and finally in array order—so later users can belong to roles defined earlier.</p><p>Here is the business user definition for the default cluster <code>pg-meta</code> in the Pigsty demo environment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_noco     ,password: DBUser.Noco     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for nocodb service      }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Each user/role definition is an object that may include the following fields. Using <code>dbuser_meta</code> as an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Required, `name` is the only mandatory field in user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, password can be scram-sha-256 hash string or plaintext</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Optional, can login by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Optional, default is false, is this a superuser?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, default is false, can create databases?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Optional, default is false, can create roles?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, by default this role can use inherited privileges?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Optional, default is false, can this role perform replication?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Optional, default is false, can this role bypass row-level security?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Optional, default is false, add this user to pgbouncer user list? (production users using connection pool should explicitly set to true)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Optional, user connection limit, default -1 disables limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in: 3650                 # Optional, this role expires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>calculated from creation + n days (higher priority than expire_at)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Optional, when this role expires, use YYYY-MM-DD format string to specify a date (lower priority than expire_in)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, description and comment string for this user/role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles: [dbrole_admin]           # Optional, default roles are</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_{admin,readonly,readwrite,offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># Optional, use `ALTER ROLE SET` to configure role-level database parameters for this role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, pgbouncer pool mode defaulting to transaction, user level</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Optional, user-level maximum database connections, default -1 disables limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Optional, key-value configuration parameters per postgresql documentation (e.g., use pigsty as default search_path)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>The only required field is <code>name</code>, which should be a valid and unique username in the PostgreSQL cluster.</li><li>Roles don&rsquo;t need a <code>password</code>, but for loginable business users, a password is usually required.</li><li><code>password</code> can be plaintext or scram-sha-256 / md5 hash string; please avoid using plaintext passwords.</li><li>Users/roles are created one by one in array order, so ensure roles/groups are defined before their members.</li><li><code>login</code>, <code>superuser</code>, <code>createdb</code>, <code>createrole</code>, <code>inherit</code>, <code>replication</code>, <code>bypassrls</code> are boolean flags.</li><li><code>pgbouncer</code> is disabled by default: to add business users to the pgbouncer user list, you should explicitly set it to <code>true</code>.</li></ul><p><strong>ACL System</strong></p><p>Pigsty has a built-in, out-of-the-box access control / <a href=/docs/concept/sec/ac/#default-roles>ACL</a> system. You can easily use it by simply assigning the following four default roles to business users:</p><ul><li><code>dbrole_readwrite</code>: Role with global read-write access (production accounts primarily used by business should have database read-write privileges)</li><li><code>dbrole_readonly</code>: Role with global read-only access (if other businesses need read-only access, use this role)</li><li><code>dbrole_admin</code>: Role with DDL privileges (business administrators, scenarios requiring table creation in applications)</li><li><code>dbrole_offline</code>: Restricted read-only access role (can only access <a href=/docs/pgsql/config#offline-replica>offline</a> instances, typically for individual users)</li></ul><p>If you want to redesign your own ACL system, consider customizing the following parameters and templates:</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>: System-wide roles and global users</li><li><a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a>: Default privileges for newly created objects</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-role.sql><code>roles/pgsql/templates/pg-init-role.sql</code></a>: Role creation SQL template</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>roles/pgsql/templates/pg-init-template.sql</code></a>: Privilege SQL template</li></ul><hr><h2 id=creating-users>Creating Users</h2><p>Users and roles <a href=#defining-users>defined</a> in <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> and <a href=/docs/pgsql/param#pg_users><code>pg_users</code></a> are automatically created one by one during the cluster initialization PROVISION phase.
If you want to <a href=/docs/pgsql/admin#create-user>create users</a> on an existing cluster, you can use the <code>bin/pgsql-user</code> tool.
Add the new user/role definition to <code>all.children.&lt;cls>.pg_users</code> and use the following method to create the user:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>Unlike databases, the user creation playbook is always idempotent. When the target user already exists, Pigsty will modify the target user&rsquo;s attributes to match the configuration. So running it repeatedly on existing clusters is usually not a problem.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Please Use Playbooks to Create Users</div><p>We don&rsquo;t recommend manually creating new business users, especially when you want the user to use the default pgbouncer connection pool: unless you&rsquo;re willing to manually maintain the user list in Pgbouncer and keep it consistent with PostgreSQL.
When creating new users with <strong><code>bin/pgsql-user</code></strong> tool or <a href=/docs/pgsql/playbook#pgsql-useryml><strong><code>pgsql-user.yml</code></strong></a> playbook, the user will also be added to the <a href=#pgbouncer-users>Pgbouncer Users</a> list.</p></div><hr><h2 id=modifying-users>Modifying Users</h2><p>The method for modifying PostgreSQL user attributes is the same as <a href=#creating-users><strong>Creating Users</strong></a>.</p><p>First, adjust your user definition, modify the attributes that need adjustment, then execute the following command to apply:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>Note that modifying users will not delete users, but modify user attributes through the <code>ALTER USER</code> command; it also won&rsquo;t revoke user privileges and groups, and will use the <code>GRANT</code> command to grant new roles.</p><hr><h2 id=pgbouncer-users>Pgbouncer Users</h2><p>Pgbouncer is enabled by default and serves as a connection pool middleware, with its users managed by default.</p><p>Pigsty adds all users in <a href=/docs/pgsql/param#pg_users><code>pg_users</code></a> that explicitly have the <code>pgbouncer: true</code> flag to the pgbouncer user list.</p><p>Users in the Pgbouncer connection pool are listed in <code>/etc/pgbouncer/userlist.txt</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>&#34;postgres&#34; &#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_wiki&#34; &#34;SCRAM-SHA-256$4096:+77dyhrPeFDT/TptHs7/7Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$KeatuohpKIYzHPCt/tqBu85vI11o9mar/by0hHYM2W8=:X9gig4JtjoS8Y/o1vQsIX/gY1Fns8ynTXkbWOjUfbRQ=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_view&#34; &#34;SCRAM-SHA-256$4096:DFoZHU/DXsHL8MJ8regdEw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$gx9sUGgpVpdSM4o6A2R9PKAUkAsRPLhLoBDLBUYtKS0=:MujSgKe6rxcIUMv4GnyXJmV0YNbf39uFRZv724+X1FE=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_monitor&#34; &#34;SCRAM-SHA-256$4096:fwU97ZMO/KR0ScHO5+UuBg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$CrNsmGrx1DkIGrtrD1Wjexb/aygzqQdirTO1oBZROPY=:L8+dJ+fqlMQh7y4PmVR/gbAOvYWOr+KINjeMZ8LlFww=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_meta&#34; &#34;SCRAM-SHA-256$4096:leB2RQPcw1OIiRnPnOMUEg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$eyC+NIMKeoTxshJu314+BmbMFpCcspzI3UFZ1RYfNyU=:fJgXcykVPvOfro2MWNkl5q38oz21nSl1dTtM65uYR1Q=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_kong&#34; &#34;SCRAM-SHA-256$4096:bK8sLXIieMwFDz67/0dqXQ</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$P/tCRgyKx9MC9LH3ErnKsnlOqgNd/nn2RyvThyiK6e4=:CDM8QZNHBdPf97ztusgnE7olaKDNHBN0WeAbP/nzu5A=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_grafana&#34; &#34;SCRAM-SHA-256$4096:HjLdGaGmeIAGdWyn2gDt/Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$jgoyOB8ugoce+Wqjr0EwFf8NaIEMtiTuQTg1iEJs9BM=:ed4HUFqLyB4YpRr+y25FBT7KnlFDnan6JPVT9imxzA4=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_gitea&#34; &#34;SCRAM-SHA-256$4096:l1DBGCc4dtircZ8O8Fbzkw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$tpmGwgLuWPDog8IEKdsaDGtiPAxD16z09slvu+rHE74=:pYuFOSDuWSofpD9OZhG7oWvyAR0PQjJBffgHZLpLHds=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_dba&#34; &#34;SCRAM-SHA-256$4096:zH8niABU7xmtblVUo2QFew</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$Zj7/pq+ICZx7fDcXikiN7GLqkKFA+X5NsvAX6CMshF0=:pqevR2WpizjRecPIQjMZOm+Ap+x0kgPL2Iv5zHZs0+g=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_bytebase&#34; &#34;SCRAM-SHA-256$4096:OMoTM9Zf8QcCCMD0svK5gg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$kMchqbf4iLK1U67pVOfGrERa/fY818AwqfBPhsTShNQ=:6HqWteN+AadrUnrgC0byr5A72noqnPugItQjOLFw0Wk=&#34;</span>
</span></span></code></pre></div><p>User-level connection pool parameters are maintained in a separate file: <code>/etc/pgbouncer/useropts.txt</code>, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>                  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>              <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><p>When you <a href=#creating-databases>create a database</a>, the Pgbouncer database list definition file will be refreshed and take effect through online configuration reload, without affecting existing connections.</p><p>Pgbouncer runs with the same <code>dbsu</code> as PostgreSQL, which defaults to the <code>postgres</code> operating system user. You can use the <code>pgb</code> alias to access pgbouncer management functions using the dbsu.</p><p>Pigsty also provides a utility function <code>pgb-route</code> that can quickly switch pgbouncer database traffic to other nodes in the cluster, useful for zero-downtime migration:</p><p>The connection pool user configuration files <code>userlist.txt</code> and <code>useropts.txt</code> are automatically refreshed when you <a href=#creating-users>create users</a>, and take effect through online configuration reload, normally without affecting existing connections.</p><p>Note that the <a href=/docs/pgsql/param#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a> parameter allows you to use dynamic queries to complete connection pool user authentication—this is a compromise when you don&rsquo;t want to manage users in the connection pool.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e73c12463833eb5e14e27191b7858ef7>20.3 - Database</h1><div class=lead>Database refers to the logical object created using the SQL command <code>CREATE DATABASE</code> within a database cluster.</div><blockquote><p>In this context, Database refers to the logical object created using the SQL command <code>CREATE DATABASE</code> within a database cluster.</p></blockquote><p>A PostgreSQL server can serve multiple <strong>databases</strong> simultaneously. In Pigsty, you can <a href=#define-database>define</a> the required databases in the cluster configuration.</p><p>Pigsty will modify and customize the default template database <code>template1</code>, creating default schemas, installing default extensions, and configuring default privileges. Newly created databases will inherit these settings from <code>template1</code> by default.</p><p>By default, all business databases will be added to the Pgbouncer connection pool in a 1:1 manner; <code>pg_exporter</code> will use an <strong>auto-discovery</strong> mechanism to find all business databases and monitor objects within them.</p><hr><h2 id=define-database>Define Database</h2><p>Business databases are defined in the database cluster parameter <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a>, which is an array of database definition objects.
Databases in the array are created sequentially according to the <strong>definition order</strong>, so later defined databases can use previously defined databases as <strong>templates</strong>.</p><p>Below is the database definition for the default <code>pg-meta</code> cluster in the Pigsty demo environment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: noco     ,owner: dbuser_noco     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>nocodb database }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Each database definition is an object that may include the following fields, using the <code>meta</code> database as an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database sql baseline path (relative path among ansible search path, e.g. files/)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this database to pgbouncer database list? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, additional schemas to be created, array of schema names</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions:                     # optional, additional extensions to be installed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>array of extension objects</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># can specify which schema to install the extension in, or leave it unspecified (will install in the first schema of search_path)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># for example, some extensions create and use fixed schemas, so no schema specification is needed.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database owner, postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, which template to use, template1 by default, target must be a template database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database encoding, UTF8 by default (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database locale, C by default (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database collate, C by default (MUST same as template database), no reason not to recommend changing.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database ctype, C by default (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, default tablespace, &#39;pg_default&#39; by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, allow connection, true by default. false will disable connect at all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, revoke public connection privilege. false by default, when set to true, CONNECT privilege will be revoked from users other than owner and admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># optional, register this database to grafana datasources? true by default, explicitly set to false to skip registration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, database connection limit, default -1 disable limit, set to positive integer will limit connections</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, all connections to this pgbouncer database will be authenticated using this user (only useful when pgbouncer_auth_query is enabled)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at database level, default transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size at database level, default 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size reserve at database level, default 32, when default pool is insufficient, can request at most this many burst connections</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size min at database level, default 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_max_db_conn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># optional, max database connections at database level, default 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The only required field is <code>name</code>, which should be a valid and unique database name in the current PostgreSQL cluster, other parameters have reasonable defaults.</p><ul><li><code>name</code>: Database name, <strong>required</strong>.</li><li><code>baseline</code>: SQL file path (Ansible search path, usually in <code>files</code>), used to initialize database content.</li><li><code>owner</code>: Database owner, default is <code>postgres</code></li><li><code>template</code>: Template used when creating the database, default is <code>template1</code></li><li><code>encoding</code>: Database default character encoding, default is <code>UTF8</code>, default is consistent with the instance. It is recommended not to configure and modify.</li><li><code>locale</code>: Database default locale, default is <code>C</code>, it is recommended not to configure, keep consistent with the instance.</li><li><code>lc_collate</code>: Database default locale string collation, default is same as instance setting, it is recommended not to modify, must be consistent with template database. It is strongly recommended not to configure, or configure to <code>C</code>.</li><li><code>lc_ctype</code>: Database default LOCALE, default is same as instance setting, it is recommended not to modify or set, must be consistent with template database. It is recommended to configure to C or <code>en_US.UTF8</code>.</li><li><code>allowconn</code>: Whether to allow connection to the database, default is <code>true</code>, not recommended to modify.</li><li><code>revokeconn</code>: Whether to revoke connection privilege to the database? Default is <code>false</code>. If <code>true</code>, <code>PUBLIC CONNECT</code> privilege on the database will be revoked. Only default users (<code>dbsu|monitor|admin|replicator|owner</code>) can connect. In addition, <code>admin|owner</code> will have GRANT OPTION, can grant connection privileges to other users.</li><li><code>tablespace</code>: Tablespace associated with the database, default is <code>pg_default</code>.</li><li><code>connlimit</code>: Database connection limit, default is <code>-1</code>, meaning no limit.</li><li><code>extensions</code>: Object array, each object defines an <strong>extension</strong> in the database, and the <strong>schema</strong> in which it is installed.</li><li><code>parameters</code>: KV object, each KV defines a parameter that needs to be modified for the database through <code>ALTER DATABASE</code>.</li><li><code>pgbouncer</code>: Boolean option, whether to add this database to Pgbouncer. All databases will be added to Pgbouncer list unless explicitly specified as <code>pgbouncer: false</code>.</li><li><code>comment</code>: Database comment information.</li><li><code>pool_auth_user</code>: When <a href=/docs/pgsql/param#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a> is enabled, all connections to this pgbouncer database will use the user specified here to execute authentication queries. You need to use a user with access to the <code>pg_shadow</code> table.</li><li><code>pool_mode</code>: Database level pgbouncer pool mode, default is transaction, i.e., transaction pooling. If left empty, will use <a href=/docs/pgsql/param#pgbouncer_poolmode><code>pgbouncer_poolmode</code></a> parameter as default value.</li><li><code>pool_size</code>: Database level pgbouncer default pool size, default is 64</li><li><code>pool_size_reserve</code>: Database level pgbouncer pool size reserve, default is 32, when default pool is insufficient, can request at most this many burst connections.</li><li><code>pool_size_min</code>: Database level pgbouncer pool size min, default is 0</li><li><code>pool_max_db_conn</code>: Database level pgbouncer connection pool max database connections, default is 100</li></ul><p>Newly created databases are forked from the <code>template1</code> database by default. This template database will be customized during the <a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a> phase:
configured with extensions, schemas, and default privileges, so newly created databases will also inherit these configurations unless you explicitly use another database as a template.</p><p>For database access privileges, refer to <a href=/docs/concept/sec/ac/#database-privileges>ACL: Database Privilege</a> section.</p><hr><h2 id=create-database>Create Database</h2><p>Databases <a href=#define-database>defined</a> in <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> will be automatically created during cluster initialization.
If you wish to <a href=/docs/pgsql/admin#create-database>create database</a> on an existing cluster, you can use the <code>bin/pgsql-db</code> wrapper script.
Add new database definition to <code>all.children.&lt;cls>.pg_databases</code>, and create that database with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style=color:#8f5902;font-style:italic># pgsql-db.yml -l &lt;cls&gt; -e dbname=&lt;dbname&gt;</span>
</span></span></code></pre></div><p>Here are some considerations when creating a new database:</p><p>The create database playbook is idempotent by default, however when you use <code>baseline</code> scripts, it may not be: in this case, it&rsquo;s usually not recommended to re-run this on existing databases unless you&rsquo;re sure the provided baseline SQL is also idempotent.</p><p>We don&rsquo;t recommend manually creating new databases, especially when you&rsquo;re using the default pgbouncer connection pool: unless you&rsquo;re willing to manually maintain the Pgbouncer database list and keep it consistent with PostgreSQL.
When creating new databases using the <code>pgsql-db</code> tool or <code>pgsql-db.yml</code> playbook, this database will also be added to the <a href=#pgbouncer-database>Pgbouncer Database</a> list.</p><p>If your database definition has a non-trivial <code>owner</code> (default is dbsu <code>postgres</code>), make sure the owner user exists before creating the database.
Best practice is always to <a href=/docs/pgsql/admin#create-user>create</a> <a href=/docs/pgsql/config/user>users</a> before creating databases.</p><hr><h2 id=pgbouncer-database>Pgbouncer Database</h2><p>Pigsty will configure and enable a Pgbouncer connection pool for PostgreSQL instances in a 1:1 manner by default, communicating via <code>/var/run/postgresql</code> Unix Socket.</p><p>Connection pools can optimize short connection performance, reduce concurrency contention, avoid overwhelming the database with too many connections, and provide additional flexibility during database migration.</p><p>Pigsty adds all databases in <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> to pgbouncer&rsquo;s database list by default.
You can disable pgbouncer connection pool support for a specific database by explicitly setting <code>pgbouncer: false</code> in the database <a href=#define-database>definition</a>.</p><p>The Pgbouncer database list is defined in <code>/etc/pgbouncer/database.txt</code>, and connection pool parameters from the database definition are reflected here:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>meta                        = host=/var/run/postgresql mode=session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>grafana                     = host=/var/run/postgresql mode=transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bytebase                    = host=/var/run/postgresql auth_user=dbuser_meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>kong                        = host=/var/run/postgresql pool_size=32 reserve_pool=64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>gitea                       = host=/var/run/postgresql min_pool_size=10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>wiki                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>noco                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>mongo                       = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When you <a href=#create-database>create databases</a>, the Pgbouncer database list definition file will be refreshed and take effect through online configuration reload, normally without affecting existing connections.</p><p>Pgbouncer runs with the same <code>dbsu</code> as PostgreSQL, defaulting to the <code>postgres</code> os user. You can use the <code>pgb</code> alias to access pgbouncer management functions using dbsu.</p><p>Pigsty also provides a utility function <code>pgb-route</code>, which can quickly switch pgbouncer database traffic to other nodes in the cluster for zero-downtime migration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># route pgbouncer traffic to another cluster member</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pgb-route<span style=color:#ce5c00;font-weight:700>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>local</span> <span style=color:#000>ip</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>1</span><span style=color:#000;font-weight:700>-</span><span style=color:#4e9a06>&#39;\/var\/run\/postgresql&#39;</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>  sed -ie <span style=color:#4e9a06>&#34;s/host=[^[:space:]]\+/host=</span><span style=color:#4e9a06>${</span><span style=color:#000>ip</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ba271faa49ebb08213e3b4f058522cdb>20.4 - Authentication / HBA</h1><div class=lead>Detailed explanation of Host-Based Authentication (HBA) in Pigsty.</div><blockquote><p>Detailed explanation of Host-Based Authentication (HBA) in Pigsty.</p></blockquote><p>Authentication is the foundation of <a href=/docs/concept/sec/ac/>Access Control</a> and the <a href=/docs/concept/sec/ac/#privilege-system>Privilege System</a>. PostgreSQL has multiple <a href=https://www.postgresql.org/docs/current/client-authentication.html>authentication</a> methods.</p><p>Here we mainly introduce HBA: Host Based Authentication. HBA rules define which users can access which databases from which locations and in which ways.</p><hr><h2 id=client-authentication>Client Authentication</h2><p>To connect to a PostgreSQL database, users must first be authenticated (password is used by default).</p><p>You can provide the password in the connection string (not secure), or pass it using the <code>PGPASSWORD</code> environment variable or <code>.pgpass</code> file. Refer to the <a href=https://www.postgresql.org/docs/current/app-psql.html#usage><code>psql</code></a> documentation and <a href=https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING>PostgreSQL Connection Strings</a> for more details.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;host=&lt;host&gt; port=&lt;port&gt; dbname=&lt;dbname&gt; user=&lt;username&gt; password=&lt;password&gt;&#39;</span>
</span></span><span style=display:flex><span>psql postgres://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;dbname&gt;
</span></span><span style=display:flex><span><span style=color:#000>PGPASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;password&gt;<span style=color:#000;font-weight:700>;</span> psql -U &lt;username&gt; -h &lt;host&gt; -p &lt;port&gt; -d &lt;dbname&gt;
</span></span></code></pre></div><p>For example, to connect to Pigsty&rsquo;s default <code>meta</code> database, you can use the following connection strings:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;host=10.10.10.10 port=5432 dbname=meta user=dbuser_dba password=DBUser.DBA&#39;</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta
</span></span><span style=display:flex><span><span style=color:#000>PGPASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>DBUser.DBA<span style=color:#000;font-weight:700>;</span> psql -U dbuser_dba -h 10.10.10.10 -p <span style=color:#0000cf;font-weight:700>5432</span> -d meta
</span></span></code></pre></div><p>By default, Pigsty enables server-side SSL encryption but does not verify client SSL certificates. To connect using client SSL certificates, you can provide client parameters using the <code>PGSSLCERT</code> and <code>PGSSLKEY</code> environment variables or <code>sslkey</code> and <code>sslcert</code> parameters.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta?sslkey=/path/to/dbuser_dba.key&amp;sslcert=/path/to/dbuser_dba.crt&#39;</span>
</span></span></code></pre></div><p>Client certificates (<code>CN</code> = username) can be signed using the local CA with the <a href=https://github.com/pgsty/pigsty/blob/main/cert.yml><code>cert.yml</code></a> playbook.</p><hr><h2 id=defining-hba>Defining HBA</h2><p>In Pigsty, there are four parameters related to HBA rules:</p><ul><li><a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a>: postgres HBA rules</li><li><a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a>: postgres global default HBA rules</li><li><a href=/docs/pgsql/param#pgb_hba_rules><code>pgb_hba_rules</code></a>: pgbouncer HBA rules</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a>: pgbouncer global default HBA rules</li></ul><p>These are all arrays of HBA rule objects. Each HBA rule is an object in one of the following two forms:</p><h3 id=1-raw-form>1. Raw Form</h3><p>The raw form of HBA is almost identical to the PostgreSQL <code>pg_hba.conf</code> format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  10.0.0.0/8      md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  172.16.0.0/12   md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  192.168.0.0/16  md5</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>In this form, the <code>rules</code> field is an array of strings, where each line is a raw <a href=https://www.postgresql.org/docs/current/auth-pg-hba-conf.html>HBA rule</a>. The <code>title</code> field is rendered as a comment explaining what the rules below do.</p><p>The <code>role</code> field specifies which instance roles the rule applies to. When an instance&rsquo;s <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> matches the <code>role</code>, the HBA rule will be added to that instance&rsquo;s HBA.</p><ul><li>HBA rules with <code>role: common</code> will be added to all instances.</li><li>HBA rules with <code>role: primary</code> will only be added to primary instances.</li><li>HBA rules with <code>role: replica</code> will only be added to replica instances.</li><li>HBA rules with <code>role: offline</code> will be added to offline instances (<a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code> or <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code>)</li></ul><h3 id=2-alias-form>2. Alias Form</h3><p>The alias form allows you to maintain HBA rules in a simpler, clearer, and more convenient way: it replaces the <code>rules</code> field with <code>addr</code>, <code>auth</code>, <code>user</code>, and <code>db</code> fields. The <code>title</code> and <code>role</code> fields still apply.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;intra&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># world|intra|infra|admin|local|localhost|cluster|&lt;cidr&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pwd&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># trust|pwd|ssl|cert|deny|&lt;official auth method&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># all|${dbsu}|${repl}|${admin}|${monitor}|&lt;user&gt;|&lt;group&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># all|replication|....</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># raw hba string precedence over above all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>addr</code>: <strong>where</strong> - Which IP address ranges are affected by this rule?<ul><li><code>world</code>: All IP addresses</li><li><code>intra</code>: All intranet IP address ranges: <code>'10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16'</code></li><li><code>infra</code>: IP addresses of Infra nodes</li><li><code>admin</code>: IP addresses of <code>admin_ip</code> management nodes</li><li><code>local</code>: Local Unix Socket</li><li><code>localhost</code>: Local Unix Socket and TCP 127.0.0.1/32 loopback address</li><li><code>cluster</code>: IP addresses of all members in the same PostgreSQL cluster</li><li><code>&lt;cidr></code>: A specific CIDR address block or IP address</li></ul></li><li><code>auth</code>: <strong>how</strong> - What authentication method does this rule specify?<ul><li><code>deny</code>: Deny access</li><li><code>trust</code>: Trust directly, no authentication required</li><li><code>pwd</code>: Password authentication, uses <code>md5</code> or <code>scram-sha-256</code> authentication based on the <a href=/docs/pgsql/param#pg_pwd_enc><code>pg_pwd_enc</code></a> parameter</li><li><code>sha</code>/<code>scram-sha-256</code>: Force use of <code>scram-sha-256</code> password authentication.</li><li><code>md5</code>: <code>md5</code> password authentication, but can also be compatible with <code>scram-sha-256</code> authentication, not recommended.</li><li><code>ssl</code>: On top of password authentication <code>pwd</code>, require SSL to be enabled</li><li><code>ssl-md5</code>: On top of password authentication <code>md5</code>, require SSL to be enabled</li><li><code>ssl-sha</code>: On top of password authentication <code>sha</code>, require SSL to be enabled</li><li><code>os</code>/<code>ident</code>: Use <code>ident</code> authentication with the operating system user identity</li><li><code>peer</code>: Use <code>peer</code> authentication method, similar to <code>os ident</code></li><li><code>cert</code>: Use client SSL certificate-based authentication, certificate CN is the username</li></ul></li><li><code>user</code>: <strong>who</strong>: Which users are affected by this rule?<ul><li><code>all</code>: All users</li><li><code>${dbsu}</code>: Default database superuser <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a></li><li><code>${repl}</code>: Default database replication user <a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a></li><li><code>${admin}</code>: Default database admin user <a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a></li><li><code>${monitor}</code>: Default database monitor user <a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a></li><li>Other specific users or roles</li></ul></li><li><code>db</code>: <strong>which</strong>: Which databases are affected by this rule?<ul><li><code>all</code>: All databases</li><li><code>replication</code>: Allow replication connections (not specifying a specific database)</li><li>A specific database</li></ul></li></ul><h3 id=3-definition-location>3. Definition Location</h3><p>Typically, global HBA is defined in <code>all.vars</code>. If you want to modify the global default HBA rules, you can copy one from the <a href=https://github.com/pgsty/pigsty/blob/main/conf/full.yml#L690><code>full.yml</code></a> template to <code>all.vars</code> and modify it.</p><ul><li><a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a>: postgres global default HBA rules</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a>: pgbouncer global default HBA rules</li></ul><p>Cluster-specific HBA rules are defined in the database cluster-level configuration:</p><ul><li><a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a>: postgres HBA rules</li><li><a href=/docs/pgsql/param#pgb_hba_rules><code>pgb_hba_rules</code></a>: pgbouncer HBA rules</li></ul><p>Here are some examples of cluster HBA rule definitions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_view ,db: all    ,addr: infra        ,auth: pwd  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;Allow dbuser_view password access to all databases from infrastructure nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: all         ,db: all    ,addr: 100.0.0.0/8  ,auth: pwd  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;Allow all users password access to all databases from K8S network&#39;</span><span style=color:#f8f8f8>          </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>,db: world  ,addr: 0.0.0.0/0    ,auth: cert ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;Allow admin user to login from anywhere with client certificate&#39;</span><span style=color:#f8f8f8>       </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=reloading-hba>Reloading HBA</h2><p>HBA is a static rule configuration file that needs to be reloaded to take effect after modification. The default HBA rule set typically doesn&rsquo;t need to be reloaded because it doesn&rsquo;t involve Role or cluster members.</p><p>If your HBA design uses specific instance role restrictions or cluster member restrictions, then when cluster instance members change (add/remove/failover), some HBA rules&rsquo; effective conditions/scope change, and you typically also need to <a href=/docs/pgsql/admin#reload-hba>reload HBA</a> to reflect the latest changes.</p><p>To reload postgres/pgbouncer hba rules:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;                 <span style=color:#8f5902;font-style:italic># Reload hba rules for cluster `&lt;cls&gt;`</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; ip1 ip2...      <span style=color:#8f5902;font-style:italic># Reload hba rules for specific instances</span>
</span></span></code></pre></div><p>The underlying Ansible playbook commands actually executed are:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -t pg_hba,pg_reload
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -t pgbouncer_hba,pgbouncer_reload
</span></span></code></pre></div><hr><h2 id=default-hba>Default HBA</h2><p>Pigsty has a default set of HBA rules that are secure enough for most scenarios. These rules use the alias form, so they are basically self-explanatory.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres global default HBA rules </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer global default HBA rules </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu local admin access with os ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user local access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor access via intranet with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other monitor access addr&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin access via intranet with pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other admin access addr&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user intra access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><details><summary>Example: Rendered pg_hba.conf</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># File      :   pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Desc      :   Postgres HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Time      :   2023-01-11 15:19</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Path      :   /pg/data/pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># License   :   AGPLv3</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># addr alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local     : /var/run/postgresql</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># infra     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># user alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu    :  postgres</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># repl    :  replicator</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor :  dbuser_monitor</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin   :  dbuser_dba</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu access via local os user ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                postgres                              ident</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu replication from local os ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    replication        postgres                              ident</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator replication from localhost [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    replication        replicator                            scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator replication from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator postgres db from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor from localhost with password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                dbuser_monitor                        scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor from infra host with password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     10.10.10.10/32     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin @ infra nodes with pwd &amp; ssl [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  all                dbuser_dba         10.10.10.10/32     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin @ everywhere with ssl &amp; pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  all                dbuser_dba         0.0.0.0/0          scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgbouncer read/write via local socket [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                +dbrole_readonly                      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># read/write biz user via password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow etl offline tasks from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow application database intranet access [common] [DISABLED]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    kong            dbuser_kong         10.0.0.0/8          md5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    bytebase        dbuser_bytebase     10.0.0.0/8          md5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    grafana         dbuser_grafana      10.0.0.0/8          md5</span>
</span></span></code></pre></div></details><details><summary>Example: Rendered pgb_hba.conf</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># File      :   pgb_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Desc      :   Pgbouncer HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Time      :   2023-01-11 15:28</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Path      :   /etc/pgbouncer/pgb_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># License   :   AGPLv3</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGBOUNCER HBA RULES FOR pg-meta-1 @ 10.10.10.10:6432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ansible managed: 2023-01-11 14:30:58</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># addr alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local     : /var/run/postgresql</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># infra     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># user alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu    :  postgres</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># repl    :  replicator</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor :  dbuser_monitor</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin   :  dbuser_dba</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu local admin access with os ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    pgbouncer          postgres                              peer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow all user local access with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                all                                   scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor access via intranet with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># reject all other monitor access addr [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     0.0.0.0/0          reject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin access via intranet with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># reject all other admin access addr [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         0.0.0.0/0          reject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow all user intra access with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                192.168.0.0/16     scram-sha-256</span>
</span></span></code></pre></div></details><hr><h2 id=security-hardening>Security Hardening</h2><p>For scenarios requiring higher security, we provide a security hardening configuration template <a href=https://github.com/pgsty/pigsty/blob/main/conf/safe.yml>security.yml</a>, which uses the following default HBA rule set:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres host-based auth rules by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: cert  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; cert&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer host-based authentication rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu local admin access with os ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user local access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor access via intranet with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other monitor access addr&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin access via intranet with pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other admin access addr&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user intra access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For more information, refer to the <a href=/docs/setup/security>Security Hardening</a> section.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0b7772f5fffba0123e7353706362f45e>20.5 - Access Control</h1><div class=lead>Default role system and privilege model provided by Pigsty</div><blockquote><p>Pigsty provides a battery-included access control model based on a <a href=#role-system>role system</a> and <a href=#privilege-system>privilege system</a>.</p></blockquote><p>Access control is important, but many users don&rsquo;t do it well. Therefore, Pigsty provides a simplified, ready-to-use access control model to provide a security baseline for your cluster.</p><hr><h2 id=role-system>Role System</h2><p>Pigsty&rsquo;s default role system includes four <a href=#default-roles>default roles</a> and four <a href=#default-users>default users</a>:</p><table><thead><tr><th>Role Name</th><th>Attributes</th><th>Member of</th><th>Description</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td></td><td>role for global read-only access</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>dbrole_readonly</td><td>role for global read-write access</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>pg_monitor,dbrole_readwrite</td><td>role for object creation</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td></td><td>role for restricted read-only access</td></tr><tr><td><code>postgres</code></td><td><code>SUPERUSER</code></td><td></td><td>system superuser</td></tr><tr><td><code>replicator</code></td><td><code>REPLICATION</code></td><td>pg_monitor,dbrole_readonly</td><td>system replicator</td></tr><tr><td><code>dbuser_dba</code></td><td><code>SUPERUSER</code></td><td>dbrole_admin</td><td>pgsql admin user</td></tr><tr><td><code>dbuser_monitor</code></td><td></td><td>pg_monitor</td><td>pgsql monitor user</td></tr></tbody></table><p>The detailed definitions of these <a href=/docs/pgsql/config/user#defining-users>roles and users</a> are as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=default-roles>Default Roles</h2><p>There are four default roles in Pigsty:</p><ul><li>Business Read-Only (<code>dbrole_readonly</code>): Role for global read-only access. If other businesses need read-only access to this database, they can use this role.</li><li>Business Read-Write (<code>dbrole_readwrite</code>): Role for global read-write access. Production accounts used by primary business should have database read-write privileges.</li><li>Business Admin (<code>dbrole_admin</code>): Role with DDL permissions, typically used for business administrators or scenarios requiring table creation in applications (such as various business software).</li><li>Offline Read-Only (<code>dbrole_offline</code>): Restricted read-only access role (can only access <a href=/docs/pgsql/config#offline-replica>offline</a> instances, typically for personal users and ETL tool accounts).</li></ul><p>Default roles are defined in <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>. Unless you really know what you&rsquo;re doing, it&rsquo;s recommended not to change the default role names.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  , login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access  }                           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># production read-only role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline ,   login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access (offline instance) }     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># restricted-read-only role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># production read-write role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># production DDL change role</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=default-users>Default Users</h2><p>Pigsty also has four default users (system users):</p><ul><li>Superuser (<code>postgres</code>), the owner and creator of the cluster, same as the OS dbsu.</li><li>Replication user (<code>replicator</code>), the system user used for primary-replica replication.</li><li>Monitor user (<code>dbuser_monitor</code>), a user used to monitor database and connection pool metrics.</li><li>Admin user (<code>dbuser_dba</code>), the admin user who performs daily operations and database changes.</li></ul><p>These four default users&rsquo; username/password are defined with four pairs of dedicated parameters, referenced in many places:</p><ul><li><a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a>: os dbsu name, postgres by default, better not change it</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>: dbsu password, empty string by default means no password is set for dbsu, best not to set it.</li><li><a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a>: postgres replication username, <code>replicator</code> by default</li><li><a href=/docs/pgsql/param#pg_replication_password><code>pg_replication_password</code></a>: postgres replication password, <code>DBUser.Replicator</code> by default</li><li><a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a>: postgres admin username, <code>dbuser_dba</code> by default</li><li><a href=/docs/pgsql/param#pg_admin_password><code>pg_admin_password</code></a>: postgres admin password in plain text, <code>DBUser.DBA</code> by default</li><li><a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a>: postgres monitor username, <code>dbuser_monitor</code> by default</li><li><a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a>: postgres monitor password, <code>DBUser.Monitor</code> by default</li></ul><blockquote><p><strong>Remember to change these passwords in production deployment! Don&rsquo;t use default values!</strong></p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database superuser name, it&#39;s recommended not to modify this username.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># database superuser password, it&#39;s recommended to leave this empty! Prohibit dbsu password login.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system replication username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system replication password, be sure to modify this password!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system monitor username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system monitor password, be sure to modify this password!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system admin username</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># system admin password, be sure to modify this password!</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If you modify the default user parameters, update the corresponding role <a href=/docs/pgsql/config/user#defining-user>definition</a> in <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true                                          ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=privilege-system>Privilege System</h2><p>Pigsty has a battery-included privilege model that works with <a href=#default-roles>default roles</a>.</p><ul><li>All users have access to all schemas.</li><li>Read-Only users (<code>dbrole_readonly</code>) can read from all tables. (SELECT, EXECUTE)</li><li>Read-Write users (<code>dbrole_readwrite</code>) can write to all tables and run DML. (INSERT, UPDATE, DELETE).</li><li>Admin users (<code>dbrole_admin</code>) can create objects and run DDL (CREATE, USAGE, TRUNCATE, REFERENCES, TRIGGER).</li><li>Offline users (<code>dbrole_offline</code>) are like Read-Only users, but with limited access, only allowed to access <a href=/docs/pgsql/config#offline-replica>offline instances</a> (<code>pg_role = 'offline'</code> or <code>pg_offline_query = true</code>)</li><li>Objects created by admin users will have correct privileges.</li><li>Default privileges are installed on all databases, including template databases.</li><li>Database connect privilege is covered by database <a href=/docs/pgsql/config/db#defining-database>definition</a>.</li><li><code>CREATE</code> privileges of database & public schema are revoked from <code>PUBLIC</code> by default.</li></ul><hr><h2 id=object-privilege>Object Privilege</h2><p>Default object privileges for newly created objects in the database are controlled by the <a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a> parameter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Newly <strong>created</strong> objects by admin users will have these privileges by default. Use <code>\ddp+</code> to view these default privileges:</p><table><thead><tr><th>Type</th><th>Access privileges</th></tr></thead><tbody><tr><td>function</td><td>=X</td></tr><tr><td></td><td>dbrole_readonly=X</td></tr><tr><td></td><td>dbrole_offline=X</td></tr><tr><td></td><td>dbrole_admin=X</td></tr><tr><td>schema</td><td>dbrole_readonly=U</td></tr><tr><td></td><td>dbrole_offline=U</td></tr><tr><td></td><td>dbrole_admin=UC</td></tr><tr><td>sequence</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=wU</td></tr><tr><td></td><td>dbrole_admin=rwU</td></tr><tr><td>table</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=awd</td></tr><tr><td></td><td>dbrole_admin=arwdDxt</td></tr></tbody></table><hr><h2 id=default-privilege>Default Privilege</h2><p><a href=https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html><code>ALTER DEFAULT PRIVILEGES</code></a> allows you to set the privileges that will be applied to objects created in the future. It does not affect privileges assigned to already-existing objects, nor does it affect objects created by non-admin users.</p><p>In Pigsty, default privileges are defined for three roles:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dbsu</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_admin_username</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- for additional business admin, they should SET ROLE dbrole_admin before executing DDL to use the corresponding default privilege configuration.
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>This content will be used by the PG cluster initialization template <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>pg-init-template.sql</code></a>, rendered during cluster initialization and output to <code>/pg/tmp/pg-init-template.sql</code>.
These commands will be executed on <code>template1</code> and <code>postgres</code> databases, and newly created databases will inherit these default privilege configurations from <code>template1</code>.</p><p>That is to say, to maintain correct object privileges, you must execute DDL with <strong>admin users</strong>, which could be:</p><ol><li><a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>, <code>postgres</code> by default</li><li><a href=/docs/pgsql/param#pg_admin_username><code>{{ pg_admin_username }}</code></a>, <code>dbuser_dba</code> by default</li><li>Business admin users granted with <code>dbrole_admin</code> role (by switching to <code>dbrole_admin</code> identity using <code>SET ROLE</code>)</li></ol><p>It&rsquo;s wise to use <code>postgres</code> as the global object owner. If you wish to create objects as business admin user, you MUST USE <code>SET ROLE dbrole_admin</code> before running that DDL to maintain the correct privileges.</p><p>You can also explicitly grant default privileges to business admin users in the database through <code>ALTER DEFAULT PRIVILEGE FOR ROLE &lt;some_biz_admin> XXX</code>.</p><hr><h2 id=database-privilege>Database Privilege</h2><p>In Pigsty, database-level privileges are covered in the <a href=#defining-database>database definition</a>.</p><p>There are three database level privileges: <code>CONNECT</code>, <code>CREATE</code>, <code>TEMP</code>, and a special &lsquo;privilege&rsquo;: <code>OWNERSHIP</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># required, `name` is the only mandatory field of a database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, specify a database owner, postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># optional, allow connection, true by default. false will disable connect at all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># optional, revoke public connection privilege. false by default. when set to true, CONNECT privilege will be revoked from users other than owner and admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>If <code>owner</code> exists, it will be used as the database owner instead of default <a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a> (which is usually <code>postgres</code>)</li><li>If <code>revokeconn</code> is <code>false</code>, all users have the <code>CONNECT</code> privilege of the database, this is the default behavior.</li><li>If <code>revokeconn</code> is explicitly set to <code>true</code>:<ul><li><code>CONNECT</code> privilege of the database will be revoked from <code>PUBLIC</code>: regular users cannot connect to this database</li><li><code>CONNECT</code> privilege will be explicitly granted to <code>{{ pg_replication_username }}</code>, <code>{{ pg_monitor_username }}</code> and <code>{{ pg_admin_username }}</code></li><li><code>CONNECT</code> privilege will be granted to the database owner with <code>GRANT OPTION</code>, the database owner can then grant connection privileges to other users.</li></ul></li><li><code>revokeconn</code> flag can be used for database access isolation. You can create different business users as owners for each database and set the <code>revokeconn</code> option for them.</li></ul><details><summary>Example: Database Isolation</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.40</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.41</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_confluence, password: mc2iohos , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_gitlab, password: sdf23g22sfdd , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_readwrite ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_jira, password: sdpijfsfdsfdfs , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: confluence , revokeconn: true, owner: dbuser_confluence , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitlab , revokeconn: true, owner: dbuser_gitlab, connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: jira , revokeconn: true, owner: dbuser_jira , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=create-privilege>CREATE Privilege</h2><p>For security reasons, Pigsty revokes the <code>CREATE</code> privilege on databases from <code>PUBLIC</code> by default, which is also the default behavior since PostgreSQL 15.</p><p>The database owner has the full ability to adjust CREATE privileges as they see fit.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Email - Vonng" aria-label="Email - Vonng"><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label="Email - Vonng"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=WeChat aria-label=WeChat><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=WeChat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Discussion aria-label=Discussion><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=Discussion><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Repo aria-label=Repo><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=Repo><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>