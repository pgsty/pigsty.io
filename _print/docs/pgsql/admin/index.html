<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.io/docs/pgsql/admin/><link rel=alternate type=application/rss+xml href=https://pigsty.io/docs/pgsql/admin/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Administration | PIGSTY</title><meta name=description content="Standard Operating Procedures (SOP) for database administration tasks"><meta property="og:url" content="https://pigsty.io/docs/pgsql/admin/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="Administration"><meta property="og:description" content="Standard Operating Procedures (SOP) for database administration tasks"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Administration"><meta itemprop=description content="Standard Operating Procedures (SOP) for database administration tasks"><meta itemprop=dateModified content="2026-01-15T11:51:06+08:00"><meta itemprop=keywords content="Task,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="Administration"><meta name=twitter:description content="Standard Operating Procedures (SOP) for database administration tasks"><link rel=preload href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css as=style integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><link href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css rel=stylesheet integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Ver</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.cc>Pigsty 中文网站</a></li><li><a class=dropdown-item href=https://doc.pgsty.com>Pigsty v3.7 Doc</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc>Pigsty v3.4 Doc</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 Doc</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 Doc</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch Language / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d757e151050fd40088751a74721d74f6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:window.location.href="https://pigsty.cc"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/pgsql/admin/>Return to the regular view of this page</a>.</p></div><h1 class=title>Administration</h1><div class=lead>Standard Operating Procedures (SOP) for database administration tasks</div><ul><li>1: <a href=#pg-17b67ff7274e6ed5025cdb1b71ec35a4>Managing PostgreSQL Clusters</a></li><li>2: <a href=#pg-81e255f632d154a2662d19c783c4514a>Managing PostgreSQL Users</a></li><li>3: <a href=#pg-9dd15cada3b5a59a9375eadbdeec7bf7>Managing PostgreSQL Databases</a></li><li>4: <a href=#pg-0cd896e3522e4cf2db0a08ece91619f5>Patroni HA Management</a></li><li>5: <a href=#pg-289eefb8da504803e0c1952004777bb0>Pgbouncer Connection Pooling</a></li><li>6: <a href=#pg-ef5d737e5bae0aa77e9e8e5340965fd9>Managing PostgreSQL Component Services</a></li><li>7: <a href=#pg-d6d9a4c3d54ca40e435a862870043f19>Manage PostgreSQL Cron Jobs</a></li><li>8: <a href=#pg-2b2e08d4aed2707846688f2a5517519d>Managing PostgreSQL Extensions</a></li><li>9: <a href=#pg-fda28727166c3a3a755b7258c9071594>Upgrading PostgreSQL Major/Minor Versions</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-17b67ff7274e6ed5025cdb1b71ec35a4>1 - Managing PostgreSQL Clusters</h1><div class=lead>Create/destroy PostgreSQL clusters, scale existing clusters, and clone clusters.</div><h2 id=quick-reference>Quick Reference</h2><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#create-cluster><strong>Create Cluster</strong></a></td><td style=text-align:left><code>bin/pgsql-add &lt;cls></code></td><td style=text-align:left>Create a new PostgreSQL cluster</td></tr><tr><td style=text-align:left><a href=#scale-out><strong>Expand Cluster</strong></a></td><td style=text-align:left><code>bin/pgsql-add &lt;cls> &lt;ip...></code></td><td style=text-align:left>Add replica to existing cluster</td></tr><tr><td style=text-align:left><a href=#scale-in><strong>Shrink Cluster</strong></a></td><td style=text-align:left><code>bin/pgsql-rm &lt;cls> &lt;ip...></code></td><td style=text-align:left>Remove instance from cluster</td></tr><tr><td style=text-align:left><a href=#remove-cluster><strong>Remove Cluster</strong></a></td><td style=text-align:left><code>bin/pgsql-rm &lt;cls></code></td><td style=text-align:left>Destroy entire PostgreSQL cluster</td></tr><tr><td style=text-align:left><a href=#reload-service><strong>Reload Service</strong></a></td><td style=text-align:left><code>bin/pgsql-svc &lt;cls> [ip...]</code></td><td style=text-align:left>Reload cluster load balancer config</td></tr><tr><td style=text-align:left><a href=#reload-hba><strong>Reload HBA</strong></a></td><td style=text-align:left><code>bin/pgsql-hba &lt;cls> [ip...]</code></td><td style=text-align:left>Reload cluster HBA access rules</td></tr><tr><td style=text-align:left><a href=#clone-cluster><strong>Clone Cluster</strong></a></td><td style=text-align:left>-</td><td style=text-align:left>Clone via standby cluster or PITR</td></tr></tbody></table><p>For other management tasks, see: <a href=/docs/pgsql/admin/patroni><strong>HA Management</strong></a>, <a href=/docs/pgsql/admin/user/><strong>Manage Users</strong></a>, <a href=/docs/pgsql/admin/db/><strong>Manage Databases</strong></a>.</p><hr><h2 id=create-cluster>Create Cluster</h2><p>To create a new PostgreSQL cluster, first <a href=/docs/pgsql/config/cluster><strong>define the cluster</strong></a> in the <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>, then <a href=/docs/node/admin#add-node><strong>add nodes</strong></a> and initialize:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=script aria-controls=tabs-00-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-00-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=example aria-controls=tabs-00-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add  &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># Add nodes in group &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml  -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># Use Ansible playbook to add nodes in group &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># Add nodes in pg-test group, runs ./node.yml -l pg-test</span>
</span></span></code></pre></div></div></div><p>On managed nodes, create the cluster with: (Execute <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> playbook on <strong><code>&lt;cls></code></strong> group)</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=script aria-controls=tabs-01-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-01-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=example aria-controls=tabs-01-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># Create PostgreSQL cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># Use Ansible playbook to create PostgreSQL cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># Create pg-test cluster</span>
</span></span></code></pre></div></div></div><p><strong>Example: Create 3-node PG cluster <code>pg-test</code></strong></p><div id=asciinema-942dc186323899bcee0f4643447fbd01 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-942dc186323899bcee0f4643447fbd01",o="/demo/pgsql.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[4,"Execute"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Risk: Re-running create on existing cluster</div><p>If you re-run create on an existing cluster, Pigsty won&rsquo;t remove existing data files, but service configs will be overwritten and the cluster will <strong>restart</strong>!
Additionally, if you specified a <code>baseline</code> SQL in <a href=/docs/pgsql/config/db#baseline><strong>database definition</strong></a>, it will re-execute - if it contains delete/overwrite logic, <strong>data loss</strong> may occur.</p></div><hr><h2 id=expand-cluster>Expand Cluster</h2><p>To add a new replica to an <strong>existing PostgreSQL cluster</strong>, add the <a href=/docs/pgsql/config/cluster><strong>instance definition</strong></a> to <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>: <code>all.children.&lt;cls>.hosts</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># existing member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># existing member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- new member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Scaling out is similar to <a href=#create-cluster><strong>creating a cluster</strong></a>. First add the new node to Pigsty: <a href=/docs/node/admin#add-node><strong>Add Node</strong></a>:</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=script aria-controls=tabs-04-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-04-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=example aria-controls=tabs-04-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add &lt;ip&gt;       <span style=color:#8f5902;font-style:italic># Add node with IP &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -l &lt;ip&gt;      <span style=color:#8f5902;font-style:italic># Use Ansible playbook to add node &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add 10.10.10.13    <span style=color:#8f5902;font-style:italic># Add node 10.10.10.13, runs ./node.yml -l 10.10.10.13</span>
</span></span></code></pre></div></div></div><p>Then run the following on the new node to scale out (Install <a href=/docs/pgsql><strong>PGSQL module</strong></a> on new node with same <a href=/docs/pgsql/param#pg_cluster><strong><code>pg_cluster</code></strong></a>):</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=script aria-controls=tabs-05-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-05-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab data-td-tp-persist=example aria-controls=tabs-05-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add &lt;cls&gt; &lt;ip&gt;  <span style=color:#8f5902;font-style:italic># Add node &lt;ip&gt; to cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;       <span style=color:#8f5902;font-style:italic># Core: Use Ansible playbook to install PGSQL module on &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test 10.10.10.13   <span style=color:#8f5902;font-style:italic># Scale out pg-test with node 10.10.10.13</span>
</span></span></code></pre></div></div></div><p>After scaling, you should <a href=/docs/pgsql/admin/service#reload-service><strong>Reload Service</strong></a> to add the new member to load balancer.</p><p><strong>Example: Add replica <code>10.10.10.13</code> to 2-node cluster <code>pg-test</code></strong></p><div id=asciinema-05fce5eacdeb3446795df8299bfa61bb class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-05fce5eacdeb3446795df8299bfa61bb",o="/demo/pgsql-append.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=shrink-cluster>Shrink Cluster</h2><p>To remove a replica from an <strong>existing PostgreSQL cluster</strong>, remove the <a href=/docs/pgsql/config/cluster><strong>instance definition</strong></a> from <a href=/docs/concept/iac/inventory><strong>inventory</strong></a> <code>all.children.&lt;cls>.hosts</code>.</p><p>First uninstall PGSQL module from target node (Execute <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> on <strong><code>&lt;ip></code></strong>):</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist=script aria-controls=tabs-07-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-07-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab data-td-tp-persist=example aria-controls=tabs-07-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm &lt;cls&gt; &lt;ip&gt;   <span style=color:#8f5902;font-style:italic># Remove PostgreSQL instance on &lt;ip&gt; from cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;ip&gt;    <span style=color:#8f5902;font-style:italic># Use Ansible playbook to remove PostgreSQL instance on &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-test 10.10.10.13  <span style=color:#8f5902;font-style:italic># Remove 10.10.10.13 from pg-test cluster</span>
</span></span></code></pre></div></div></div><p>After removing PGSQL module, optionally remove the node from Pigsty: <a href=/docs/node/admin#remove-node><strong>Remove Node</strong></a>:</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=script aria-controls=tabs-08-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-08-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab data-td-tp-persist=example aria-controls=tabs-08-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm &lt;ip&gt;          <span style=color:#8f5902;font-style:italic># Remove node &lt;ip&gt; from Pigsty management</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node-rm.yml -l &lt;ip&gt;     <span style=color:#8f5902;font-style:italic># Use Ansible playbook to remove node &lt;ip&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm 10.10.10.13   <span style=color:#8f5902;font-style:italic># Remove node 10.10.10.13 from Pigsty</span>
</span></span></code></pre></div></div></div><p>After scaling in, remove the instance from <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>, then <a href=/docs/pgsql/admin/service#reload-service><strong>Reload Service</strong></a> to remove it from load balancer.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- remove after execution</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Example: Remove replica <code>10.10.10.13</code> from 3-node cluster <code>pg-test</code></strong></p><div id=asciinema-89bfaa9d26b25502fcaa59352090b5f0 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-89bfaa9d26b25502fcaa59352090b5f0",o="/demo/pgsql-shrink.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=remove-cluster>Remove Cluster</h2><p>To destroy a cluster, uninstall PGSQL module from all nodes (Execute <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> on <strong><code>&lt;cls></code></strong>):</p><ul class="nav nav-tabs" id=tabs-10 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-10-00-tab data-bs-toggle=tab data-bs-target=#tabs-10-00 role=tab data-td-tp-persist=script aria-controls=tabs-10-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-10-01-tab data-bs-toggle=tab data-bs-target=#tabs-10-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-10-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-10-02-tab data-bs-toggle=tab data-bs-target=#tabs-10-02 role=tab data-td-tp-persist=example aria-controls=tabs-10-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-10-content><div class="tab-body tab-pane fade show active" id=tabs-10-00 role=tabpanel aria-labelled-by=tabs-10-00-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm &lt;cls&gt;        <span style=color:#8f5902;font-style:italic># Destroy entire PostgreSQL cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-01 role=tabpanel aria-labelled-by=tabs-10-01-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook to destroy cluster &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-02 role=tabpanel aria-labelled-by=tabs-10-02-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-test      <span style=color:#8f5902;font-style:italic># Destroy pg-test cluster</span>
</span></span></code></pre></div></div></div><p>After destroying PGSQL, optionally remove all nodes from Pigsty: <a href=/docs/node/admin#remove-node><strong>Remove Node</strong></a> (optional if other services exist):</p><ul class="nav nav-tabs" id=tabs-11 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-11-00-tab data-bs-toggle=tab data-bs-target=#tabs-11-00 role=tab data-td-tp-persist=script aria-controls=tabs-11-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-11-01-tab data-bs-toggle=tab data-bs-target=#tabs-11-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-11-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-11-02-tab data-bs-toggle=tab data-bs-target=#tabs-11-02 role=tab data-td-tp-persist=example aria-controls=tabs-11-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-11-content><div class="tab-body tab-pane fade show active" id=tabs-11-00 role=tabpanel aria-labelled-by=tabs-11-00-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm &lt;cls&gt;         <span style=color:#8f5902;font-style:italic># Remove all nodes in group &lt;cls&gt; from Pigsty</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-01 role=tabpanel aria-labelled-by=tabs-11-01-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node-rm.yml -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># Use Ansible playbook to remove nodes in group &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-02 role=tabpanel aria-labelled-by=tabs-11-02-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm pg-test       <span style=color:#8f5902;font-style:italic># Remove all pg-test nodes from Pigsty</span>
</span></span></code></pre></div></div></div><p>After removal, delete the entire <a href=/docs/pgsql/config/cluster><strong>cluster definition</strong></a> from <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># remove this cluster definition group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Example: Destroy 3-node PG cluster <code>pg-test</code></strong></p><div id=asciinema-4b148718963c7bab646e97087cabccda class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-4b148718963c7bab646e97087cabccda",o="/demo/pgsql-rm.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><p>Note: If <a href=/docs/pgsql/param#pg_safeguard><strong><code>pg_safeguard</code></strong></a> is configured (or globally <code>true</code>), <code>pgsql-rm.yml</code> will abort to prevent accidental removal.
Override with playbook command line to force removal.
By default, cluster backup repo is deleted with the cluster. To preserve backups (e.g., with centralized repo), set <a href=/docs/pgsql/param#pg_rm_backup><strong><code>pg_rm_backup=false</code></strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l pg-meta -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># force remove protected cluster pg-meta</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-meta -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># preserve backup repo during removal</span>
</span></span></code></pre></div><hr><h2 id=reload-service>Reload Service</h2><p>PostgreSQL clusters expose <a href=/docs/pgsql/service/><strong>services</strong></a> via <a href=/docs/concept/arch/pgsql#haproxy><strong>HAProxy</strong></a> on host nodes.
When service definitions change, instance weights change, or cluster membership changes (e.g., <a href=#scale-out><strong>scale out</strong></a>/<a href=#scale-in><strong>scale in</strong></a>, switchover/failover), reload services to update load balancer config.</p><p>To reload service config on entire cluster or specific instances (Execute <code>pg_service</code> subtask of <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> on <strong><code>&lt;cls></code></strong> or <strong><code>&lt;ip></code></strong>):</p><ul class="nav nav-tabs" id=tabs-13 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-13-00-tab data-bs-toggle=tab data-bs-target=#tabs-13-00 role=tab data-td-tp-persist=script aria-controls=tabs-13-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-13-01-tab data-bs-toggle=tab data-bs-target=#tabs-13-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-13-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-13-02-tab data-bs-toggle=tab data-bs-target=#tabs-13-02 role=tab data-td-tp-persist=example aria-controls=tabs-13-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-13-content><div class="tab-body tab-pane fade show active" id=tabs-13-00 role=tabpanel aria-labelled-by=tabs-13-00-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># Reload service config for entire cluster &lt;cls&gt;</span>
</span></span><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; &lt;ip...&gt;   <span style=color:#8f5902;font-style:italic># Reload service config for specific instances</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-13-01 role=tabpanel aria-labelled-by=tabs-13-01-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_service -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>        <span style=color:#8f5902;font-style:italic># Reload entire cluster</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;  -t pg_service -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>        <span style=color:#8f5902;font-style:italic># Reload specific instance</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-13-02 role=tabpanel aria-labelled-by=tabs-13-02-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc pg-test                 <span style=color:#8f5902;font-style:italic># Reload pg-test cluster service config</span>
</span></span><span style=display:flex><span>bin/pgsql-svc pg-test 10.10.10.13     <span style=color:#8f5902;font-style:italic># Reload pg-test 10.10.10.13 instance service config</span>
</span></span></code></pre></div></div></div><blockquote><p>Note: If using dedicated load balancer cluster (<a href=/docs/pgsql/param#pg_service_provider><strong><code>pg_service_provider</code></strong></a>), only reloading cluster primary updates the LB config.</p></blockquote><p><strong>Example: Reload <code>pg-test</code> cluster service config</strong></p><div id=asciinema-d04ae8e428be2e84e61f51c21cb4556e class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-d04ae8e428be2e84e61f51c21cb4556e",o="/demo/pgsql-svc.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><details><summary>Example: Reload PG Service to Remove Instance</summary><p><a href=https://asciinema.org/a/568815><img src=https://asciinema.org/a/568815.svg alt=asciicast></a></p></details><hr><h2 id=reload-hba>Reload HBA</h2><p>When HBA configs change, reload HBA rules to apply. (<a href=/docs/pgsql/param#pg_hba_rules><strong><code>pg_hba_rules</code></strong></a> / <a href=/docs/pgsql/param#pgb_hba_rules><strong><code>pgb_hba_rules</code></strong></a>)
If you have role-specific HBA rules or IP ranges referencing cluster member aliases, reload HBA after switchover/scaling.</p><p>To reload PG and Pgbouncer HBA rules on entire cluster or specific instances (Execute HBA subtasks of <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> on <strong><code>&lt;cls></code></strong> or <strong><code>&lt;ip></code></strong>):</p><ul class="nav nav-tabs" id=tabs-15 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-15-00-tab data-bs-toggle=tab data-bs-target=#tabs-15-00 role=tab data-td-tp-persist=script aria-controls=tabs-15-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-15-01-tab data-bs-toggle=tab data-bs-target=#tabs-15-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-15-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-15-02-tab data-bs-toggle=tab data-bs-target=#tabs-15-02 role=tab data-td-tp-persist=example aria-controls=tabs-15-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-15-content><div class="tab-body tab-pane fade show active" id=tabs-15-00 role=tabpanel aria-labelled-by=tabs-15-00-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># Reload HBA rules for entire cluster &lt;cls&gt;</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; &lt;ip...&gt;   <span style=color:#8f5902;font-style:italic># Reload HBA rules for specific instances</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-15-01 role=tabpanel aria-labelled-by=tabs-15-01-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>   <span style=color:#8f5902;font-style:italic># Reload entire cluster</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;  -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>   <span style=color:#8f5902;font-style:italic># Reload specific instance</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-15-02 role=tabpanel aria-labelled-by=tabs-15-02-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba pg-test                 <span style=color:#8f5902;font-style:italic># Reload pg-test cluster HBA rules</span>
</span></span><span style=display:flex><span>bin/pgsql-hba pg-test 10.10.10.13     <span style=color:#8f5902;font-style:italic># Reload pg-test 10.10.10.13 instance HBA rules</span>
</span></span></code></pre></div></div></div><p><strong>Example: Reload <code>pg-test</code> cluster HBA rules</strong></p><div id=asciinema-ff9b13ed062434f2b3b348cc9909ad10 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ff9b13ed062434f2b3b348cc9909ad10",o="/demo/pgsql-hba.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=config-cluster>Config Cluster</h2><p>PostgreSQL config params are managed by Patroni. Initial params are specified by <a href=/docs/pgsql/template/><strong>Patroni config template</strong></a>.
After cluster init, config is stored in Etcd, dynamically managed and synced by Patroni.
Most Patroni <a href=/docs/pgsql/admin/patroni#edit-config><strong>config params</strong></a> can be modified via <code>patronictl</code>.
Other params (e.g., etcd DCS config, log/RestAPI config) can be updated via subtasks. For example, when <a href=/docs/etcd><strong>etcd</strong></a> cluster membership changes, refresh Patroni config:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-test -t pg_conf                   <span style=color:#8f5902;font-style:italic># Update Patroni config file</span>
</span></span><span style=display:flex><span>ansible pg-test -b -a <span style=color:#4e9a06>&#39;systemctl reload patroni&#39;</span>    <span style=color:#8f5902;font-style:italic># Reload Patroni service</span>
</span></span></code></pre></div><p>You can override Patroni-managed defaults at different levels: <a href=/docs/pgsql/param#pg_parameters><strong>specify params per instance</strong></a>,
<a href=/docs/pgsql/admin/user><strong>specify params per user</strong></a>, or <a href=/docs/pgsql/admin/db><strong>specify params per database</strong></a>.</p><hr><h2 id=clone-cluster>Clone Cluster</h2><p>Two ways to clone a cluster: use <a href=/docs/pgsql/config/cluster#standby-cluster><strong>Standby Cluster</strong></a>, or use <a href=/docs/pgsql/backup/restore#quick-start><strong>Point-in-Time Recovery</strong></a>.
The former is simple with no dependencies but only clones latest state; the latter requires centralized <a href=/docs/pgsql/backup/repository><strong>backup repository</strong></a> (e.g., MinIO) but can clone to any point within retention period.</p><table><thead><tr><th style=text-align:left>Method</th><th style=text-align:left>Pros</th><th style=text-align:left>Cons</th><th style=text-align:left>Use Cases</th></tr></thead><tbody><tr><td style=text-align:left>Standby Cluster</td><td style=text-align:left>Simple, no dependencies</td><td style=text-align:left>Only clones latest state</td><td style=text-align:left>DR, read-write separation, migration</td></tr><tr><td style=text-align:left>PITR</td><td style=text-align:left>Recover to any point</td><td style=text-align:left>Requires centralized backup</td><td style=text-align:left>Undo mistakes, data audit</td></tr></tbody></table><h3 id=clone-via-standby-cluster>Clone via Standby Cluster</h3><p>Standby Cluster continuously syncs from upstream cluster via streaming replication - the simplest cloning method.
Specify <a href=/docs/pgsql/param#pg_upstream><strong><code>pg_upstream</code></strong></a> on the new cluster primary to auto-pull data from upstream.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test is the original cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test2 is standby cluster (clone) of pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># specify upstream</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test2 }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Create standby cluster with:</p><ul class="nav nav-tabs" id=tabs-17 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-17-00-tab data-bs-toggle=tab data-bs-target=#tabs-17-00 role=tab data-td-tp-persist=script aria-controls=tabs-17-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-17-01-tab data-bs-toggle=tab data-bs-target=#tabs-17-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-17-01 aria-selected=false>
Playbook</button></li></ul><div class=tab-content id=tabs-17-content><div class="tab-body tab-pane fade show active" id=tabs-17-00 role=tabpanel aria-labelled-by=tabs-17-00-tab tabindex=17><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test2    <span style=color:#8f5902;font-style:italic># Create standby cluster, auto-clone from upstream pg-test</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-17-01 role=tabpanel aria-labelled-by=tabs-17-01-tab tabindex=17><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-test2   <span style=color:#8f5902;font-style:italic># Use Ansible playbook to create standby cluster</span>
</span></span></code></pre></div></div></div><p>Standby cluster follows upstream, keeping data in sync. <strong>Promote</strong> to independent cluster anytime:</p><details><summary>Example: Promote Standby to Independent Cluster</summary><p>Via <a href=#config-cluster><strong>Config Cluster</strong></a>, remove <code>standby_cluster</code> config to promote:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>-standby_cluster:
</span></span><span style=display:flex><span>-  create_replica_methods:
</span></span><span style=display:flex><span>-  - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11
</span></span><span style=display:flex><span>-  port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>After promotion, <code>pg-test2</code> becomes independent cluster accepting writes, forked from <code>pg-test</code>.</p></details><details><summary>Example: Change Replication Upstream</summary><p>If upstream cluster switchover occurs, change standby cluster upstream via <a href=#config-cluster><strong>Config Cluster</strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11     <span style=color:#8f5902;font-style:italic># &lt;--- old upstream</span>
</span></span><span style=display:flex><span>+  host: 10.10.10.14     <span style=color:#8f5902;font-style:italic># &lt;--- new upstream</span>
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><h3 id=clone-via-pitr>Clone via PITR</h3><p><a href=/docs/pgsql/backup/restore><strong>Point-in-Time Recovery</strong></a> (PITR) allows recovery to any point within backup retention.
Requires centralized <a href=/docs/pgsql/backup/repository><strong>backup repository</strong></a> (MinIO/S3), but more powerful.</p><p>To clone via PITR, add <a href=/docs/pgsql/param#pg_pitr><strong><code>pg_pitr</code></strong></a> param specifying recovery target:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Clone new cluster pg-meta2 from pg-meta backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Recover from pg-meta backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-01-10 10:00:00+00&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># Recover to specific time</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Execute clone with <code>pgsql-pitr.yml</code> playbook:</p><ul class="nav nav-tabs" id=tabs-18 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-18-00-tab data-bs-toggle=tab data-bs-target=#tabs-18-00 role=tab data-td-tp-persist=playbook aria-controls=tabs-18-00 aria-selected=true>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-18-01-tab data-bs-toggle=tab data-bs-target=#tabs-18-01 role=tab data-td-tp-persist=cli aria-controls=tabs-18-01 aria-selected=false>
CLI</button></li></ul><div class=tab-content id=tabs-18-content><div class="tab-body tab-pane fade show active" id=tabs-18-00 role=tabpanel aria-labelled-by=tabs-18-00-tab tabindex=18><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2    <span style=color:#8f5902;font-style:italic># Clone pg-meta2 from pg-meta backup</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-18-01 role=tabpanel aria-labelled-by=tabs-18-01-tab tabindex=18><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify PITR options via command line</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-01-10 10:00:00+00&#34;}}&#39;</span>
</span></span></code></pre></div></div></div><p>PITR supports multiple recovery target types:</p><table><thead><tr><th style=text-align:left>Target Type</th><th style=text-align:left>Example</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>Time</td><td style=text-align:left><code>time: "2025-01-10 10:00:00+00"</code></td><td style=text-align:left>Recover to specific timestamp</td></tr><tr><td style=text-align:left>XID</td><td style=text-align:left><code>xid: "250000"</code></td><td style=text-align:left>Recover to before/after txn</td></tr><tr><td style=text-align:left>Name</td><td style=text-align:left><code>name: "before_migration"</code></td><td style=text-align:left>Recover to named restore point</td></tr><tr><td style=text-align:left>LSN</td><td style=text-align:left><code>lsn: "0/4001C80"</code></td><td style=text-align:left>Recover to specific WAL pos</td></tr><tr><td style=text-align:left>Latest</td><td style=text-align:left><code>type: "latest"</code></td><td style=text-align:left>Recover to end of WAL archive</td></tr></tbody></table><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>Post-PITR Processing</div><p>Recovered cluster has <code>archive_mode</code> <strong>disabled</strong> to prevent accidental WAL overwrites.
If recovered data is correct, enable archiving and perform new full backup:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode; SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>pg-backup full    <span style=color:#8f5902;font-style:italic># Execute new full backup</span>
</span></span></code></pre></div></div><p>For detailed PITR usage, see <a href=/docs/pgsql/backup/restore><strong>Restore Operations</strong></a> documentation.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-81e255f632d154a2662d19c783c4514a>2 - Managing PostgreSQL Users</h1><div class=lead>User management - create, modify, delete users, manage role membership, connection pool config</div><h2 id=quick-start>Quick Start</h2><p>Pigsty uses declarative management: first <a href=/docs/pgsql/config/user><strong>define users</strong></a> in the <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>, then use <code>bin/pgsql-user &lt;cls> &lt;username></code> to create or modify.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_app, password: &#39;DBUser.App&#39;, pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># &lt;--- Define user list here!</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=script aria-controls=tabs-00-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-00-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=example aria-controls=tabs-00-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># Create/modify &lt;username&gt; user on &lt;cls&gt; cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l pg-meta -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_app    <span style=color:#8f5902;font-style:italic># Use playbook to create/modify user</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># Create/modify dbuser_app user on pg-meta cluster</span>
</span></span></code></pre></div></div></div><p>For complete user definition reference, see <a href=/docs/pgsql/config/user><strong>User Configuration</strong></a>. For access permissions, see <a href=/docs/concept/sec/ac/#default-roles><strong>ACL: Role Privileges</strong></a>.</p><p>Note: User <code>name</code> cannot be modified after creation. To rename, delete the old user and create new one.</p><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#create-user><strong>Create User</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>Create new business user or role</td></tr><tr><td style=text-align:left><a href=#modify-user><strong>Modify User</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>Modify existing user properties</td></tr><tr><td style=text-align:left><a href=#delete-user><strong>Delete User</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>Safe delete user (requires <code>state: absent</code>)</td></tr></tbody></table><div id=asciinema-ea4542a7c787faec4a82af4534ee61d2 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ea4542a7c787faec4a82af4534ee61d2",o="/demo/pgsql-user.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=create-user>Create User</h2><p>Users defined in <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> are auto-created during PostgreSQL <a href=/docs/pgsql/admin/cluster#create-cluster><strong>cluster creation</strong></a> in the <code>pg_user</code> task.</p><p>To create a new user on an existing cluster, add <a href=/docs/pgsql/config/user><strong>user definition</strong></a> to <code>all.children.&lt;cls>.pg_users</code>, then execute:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=script aria-controls=tabs-02-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-02-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=example aria-controls=tabs-02-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;   <span style=color:#8f5902;font-style:italic># Create user &lt;username&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;username&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># Create dbuser_app user in pg-meta cluster</span>
</span></span></code></pre></div></div></div><p><strong>Example: Create business user <code>dbuser_app</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars.pg_users:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>application user for myapp</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Result</strong>: Creates <code>dbuser_app</code> user on primary, sets password, grants <code>dbrole_readwrite</code> role, adds to Pgbouncer pool, reloads Pgbouncer config on all instances.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Recommendation: Use playbook</div><p>For manual user creation, you must ensure Pgbouncer user list sync yourself.</p></div><hr><h2 id=modify-user>Modify User</h2><p>Same command as create - playbook is idempotent. When target user exists, Pigsty modifies properties to match config.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=script aria-controls=tabs-04-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-04-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=example aria-controls=tabs-04-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;user&gt;   <span style=color:#8f5902;font-style:italic># Modify user &lt;user&gt; properties</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;user&gt;   <span style=color:#8f5902;font-style:italic># Idempotent, can repeat</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># Modify dbuser_app to match config</span>
</span></span></code></pre></div></div></div><p><strong>Immutable properties</strong>: User <code>name</code> can&rsquo;t be modified after creation - requires delete and recreate.</p><p>All other properties can be modified. Common examples:</p><p><strong>Modify password</strong>: Update <code>password</code> field. Logging is temporarily disabled during password change to prevent leakage.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>NewSecretPassword    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># New password</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Modify privilege attributes</strong>: Configure boolean flags for user privileges.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Superuser (use carefully!)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Allow CREATE DATABASE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># Allow CREATE ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Auto-inherit role privileges</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Allow streaming replication</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Bypass row-level security</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Connection limit, -1 unlimited</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Modify expiration</strong>: Use <code>expire_in</code> for relative expiry (N days), or <code>expire_at</code> for absolute date. <code>expire_in</code> takes priority and recalculates on each playbook run - good for temp users needing periodic renewal.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># Expires in 30 days (relative)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Expires on date (absolute)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>permanent_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Never expires</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Modify role membership</strong>: Use <code>roles</code> array with simple or extended format. Role membership is additive - won&rsquo;t remove undeclared existing roles. Use <code>state: absent</code> to explicitly revoke.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>dbrole_readwrite                      # Simple form</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grant role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># With ADMIN OPTION</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set: false }      # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disallow SET ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Revoke role membership</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manage user parameters</strong>: Use <code>parameters</code> dict for user-level params, generates <code>ALTER USER ... SET</code>. Use <code>DEFAULT</code> to reset.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Reset to default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Connection pool config</strong>: Set <code>pgbouncer: true</code> to add user to pool. Optional <code>pool_mode</code> and <code>pool_connlimit</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Add to pool</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Pool mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Max user connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=delete-user>Delete User</h2><p>To delete a user, set <code>state</code> to <code>absent</code> and execute:</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=script aria-controls=tabs-05-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-05-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab data-td-tp-persist=example aria-controls=tabs-05-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;user&gt;   <span style=color:#8f5902;font-style:italic># Delete &lt;user&gt; (config must have state: absent)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;user&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_old    <span style=color:#8f5902;font-style:italic># Delete dbuser_old (config has state: absent)</span>
</span></span></code></pre></div></div></div><p><strong>Config example</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_old</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Deletion process</strong>: Uses <code>pg-drop-role</code> script for safe deletion; auto-disables login and terminates connections; transfers database/tablespace ownership to <code>postgres</code>; handles object ownership in all databases; revokes all role memberships; creates audit log; removes from Pgbouncer and reloads config.</p><p><strong>Protection</strong>: These system users cannot be deleted and are auto-skipped: <code>postgres</code> (superuser), <code>replicator</code> (or <a href=/docs/pgsql/param#pg_replication_username><strong><code>pg_replication_username</code></strong></a>), <code>dbuser_dba</code> (or <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a>), <code>dbuser_monitor</code> (or <a href=/docs/pgsql/param#pg_monitor_username><strong><code>pg_monitor_username</code></strong></a>).</p><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>Safe Deletion</div><p>Pigsty uses <code>pg-drop-role</code> for safe deletion, auto-handling owned databases, tablespaces, schemas, tables, etc. Terminates active connections, transfers ownership to <code>postgres</code>, creates audit log at <code>/tmp/pg_drop_role_&lt;user>_&lt;timestamp>.log</code>. No manual dependency handling needed.</p></div><hr><h2 id=manual-deletion>Manual Deletion</h2><p>For manual user deletion, use <code>pg-drop-role</code> script directly:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check dependencies (read-only)</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --check
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Preview deletion (don&#39;t execute)</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --dry-run -v
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete user, transfer objects to postgres</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Force delete (terminate connections)</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete user, transfer to specific user</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old dbuser_new
</span></span></code></pre></div><hr><h2 id=common-use-cases>Common Use Cases</h2><p>Common user configuration examples:</p><p><strong>Basic business user</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>application user</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Read-only user</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Admin user (can execute DDL)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Temp user (expires in 30 days)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_contractor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>TempPassword</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Role (no login, for permission grouping)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom_role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom role for special permissions</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>User with advanced role options (PG16+)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_execute_server_program, inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=query-users>Query Users</h2><p>Common SQL queries for user info:</p><p><strong>List all users</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolsuper</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolinherit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolcreaterole</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolcreatedb</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>rolcanlogin</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolreplication</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolbypassrls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolconnlimit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_%&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View user role membership</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>member</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>admin_option</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_option</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inherit_option</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_auth_members</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>roleid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbuser_app&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View user-level parameters</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>setconfig</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_db_role_setting</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setrole</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setdatabase</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View expiring users</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>time_remaining</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87>INTERVAL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30 days&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=connection-pool-management>Connection Pool Management</h2><p><a href=/docs/pgsql/config/user#pgbouncer><strong>Connection pool params</strong></a> in user definitions are applied to Pgbouncer when creating/modifying users.</p><p>Users with <code>pgbouncer: true</code> are added to <code>/etc/pgbouncer/userlist.txt</code>. User-level pool params (<code>pool_mode</code>, <code>pool_connlimit</code>) are configured via <code>/etc/pgbouncer/useropts.txt</code>.</p><p>Use <code>postgres</code> OS user with <code>pgb</code> alias to access Pgbouncer admin database. For more pool management, see <a href=/docs/pgsql/admin/pgbouncer><strong>Pgbouncer Management</strong></a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9dd15cada3b5a59a9375eadbdeec7bf7>3 - Managing PostgreSQL Databases</h1><div class=lead>Database management - create, modify, delete, rebuild, and clone databases using templates</div><h2 id=quick-start>Quick Start</h2><p>Pigsty uses declarative management: first <a href=/docs/pgsql/config/db><strong>define databases</strong></a> in the <a href=/docs/concept/iac/inventory><strong>inventory</strong></a>, then use <code>bin/pgsql-db &lt;cls> &lt;dbname></code> to create or modify.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>some_db }] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Define database list here!</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=script aria-controls=tabs-00-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-00-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=example aria-controls=tabs-00-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style=color:#8f5902;font-style:italic># Create/modify &lt;dbname&gt; database on &lt;cls&gt; cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l pg-meta -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>some_db    <span style=color:#8f5902;font-style:italic># Use playbook to create/modify database</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta some_db    <span style=color:#8f5902;font-style:italic># Create/modify some_db database on pg-meta cluster</span>
</span></span></code></pre></div></div></div><p>For complete database definition reference, see <a href=/docs/pgsql/config/db><strong>Database Configuration</strong></a>. For access permissions, see <a href=/docs/concept/sec/ac/#database-privileges><strong>ACL: Database Privileges</strong></a>.</p><p>Note: Some parameters can only be specified at <strong>creation time</strong>. Modifying these requires recreating the database (use <code>state: recreate</code>).</p><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#create-database><strong>Create Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Create new business database</td></tr><tr><td style=text-align:left><a href=#modify-database><strong>Modify Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Modify existing database properties</td></tr><tr><td style=text-align:left><a href=#delete-database><strong>Delete Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Delete database (requires <code>state: absent</code>)</td></tr><tr><td style=text-align:left><a href=#rebuild-database><strong>Rebuild Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Drop and recreate (requires <code>state: recreate</code>)</td></tr><tr><td style=text-align:left><a href=#clone-database><strong>Clone Database</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>Clone database using template</td></tr></tbody></table><div id=asciinema-cd66826a3d08fab10d21e9ac82d386f7 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-cd66826a3d08fab10d21e9ac82d386f7",o="/demo/pgsql-db.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=create-database>Create Database</h2><p>Databases defined in <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> are auto-created during PostgreSQL <a href=/docs/pgsql/admin/cluster#create-cluster><strong>cluster creation</strong></a> in the <code>pg_db</code> task.</p><p>To create a new database on an existing cluster, add <a href=/docs/pgsql/config/db><strong>database definition</strong></a> to <code>all.children.&lt;cls>.pg_databases</code>, then execute:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=script aria-controls=tabs-02-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-02-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=example aria-controls=tabs-02-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;   <span style=color:#8f5902;font-style:italic># Create database &lt;dbname&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;dbname&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta myapp    <span style=color:#8f5902;font-style:italic># Create myapp database in pg-meta cluster</span>
</span></span></code></pre></div></div></div><p><strong>Example: Create business database <code>myapp</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars.pg_databases:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>app]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_trgm }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>btree_gin }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>my application database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Result</strong>: Creates <code>myapp</code> database on primary, sets owner to <code>dbuser_myapp</code>, creates <code>app</code> schema, enables <code>pg_trgm</code> and <code>btree_gin</code> extensions. Database is auto-added to Pgbouncer pool and registered as Grafana datasource.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Recommendation: Use playbook</div><p>For manual database creation, you must ensure Pgbouncer pool and Grafana datasource sync yourself.</p></div><hr><h2 id=modify-database>Modify Database</h2><p>Same command as create - playbook is idempotent when no <code>baseline</code> SQL is defined.</p><p>When target database exists, Pigsty modifies properties to match config. However, some properties can only be set at creation.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=script aria-controls=tabs-04-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-04-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=example aria-controls=tabs-04-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># Modify database &lt;db&gt; properties</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># Idempotent, can repeat</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta myapp    <span style=color:#8f5902;font-style:italic># Modify myapp database to match config</span>
</span></span></code></pre></div></div></div><p><strong>Immutable properties</strong>: These can&rsquo;t be modified after creation, require <code>state: recreate</code>:</p><ul><li><code>name</code> (database name), <code>template</code>, <code>strategy</code> (clone strategy)</li><li><code>encoding</code>, <code>locale</code>/<code>lc_collate</code>/<code>lc_ctype</code>, <code>locale_provider</code>/<code>icu_locale</code>/<code>icu_rules</code>/<code>builtin_locale</code></li></ul><p>All other properties can be modified. Common examples:</p><p><strong>Modify owner</strong>: Update <code>owner</code> field, executes <code>ALTER DATABASE ... OWNER TO</code> and grants permissions.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_new_owner    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># New owner</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Modify connection limit</strong>: Use <code>connlimit</code> to limit max connections.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Max 100 connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Revoke public connect</strong>: Setting <code>revokeconn: true</code> revokes PUBLIC CONNECT privilege, allowing only owner, DBA, monitor, and replication users.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Revoke PUBLIC CONNECT</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manage parameters</strong>: Use <code>parameters</code> dict for database-level params, generates <code>ALTER DATABASE ... SET</code>. Use special value <code>DEFAULT</code> to reset.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;512MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Reset to default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manage schemas</strong>: Use <code>schemas</code> array with simple or extended format. Use <code>state: absent</code> to drop (CASCADE).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>app                                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Simple form</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: core, owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp }  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Specify owner</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: deprecated, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Drop schema</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manage extensions</strong>: Use <code>extensions</code> array with simple or extended format. Use <code>state: absent</code> to uninstall (CASCADE).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>postgis                                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Simple form</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: vector, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Specify schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_trgm, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Uninstall extension</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>CASCADE Warning</div><p>Dropping schemas or uninstalling extensions uses <code>CASCADE</code>, deleting all dependent objects. Understand impact before executing.</p></div><p><strong>Connection pool config</strong>: By default all databases are added to Pgbouncer. Configure <code>pgbouncer</code>, <code>pool_mode</code>, <code>pool_size</code>, <code>pool_reserve</code>, <code>pool_connlimit</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Add to pool (default true)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode: transaction       # Pool mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction/session/statement</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># Default pool size</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># Max database connections</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=delete-database>Delete Database</h2><p>To delete a database, set <code>state</code> to <code>absent</code> and execute:</p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist=script aria-controls=tabs-06-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-06-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-06-02-tab data-bs-toggle=tab data-bs-target=#tabs-06-02 role=tab data-td-tp-persist=example aria-controls=tabs-06-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># Delete &lt;db&gt; (config must have state: absent)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-02 role=tabpanel aria-labelled-by=tabs-06-02-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta olddb    <span style=color:#8f5902;font-style:italic># Delete olddb (config has state: absent)</span>
</span></span></code></pre></div></div></div><p><strong>Config example</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olddb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Deletion process</strong>: If <code>is_template: true</code>, first executes <code>ALTER DATABASE ... IS_TEMPLATE false</code>; uses <code>DROP DATABASE ... WITH (FORCE)</code> (PG13+) to force drop and terminate all connections; removes from Pgbouncer pool; unregisters from Grafana datasource.</p><p><strong>Protection</strong>: System databases <code>postgres</code>, <code>template0</code>, <code>template1</code> cannot be deleted. Deletion only runs on primary - streaming replication syncs to replicas.</p><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>Danger Warning</div><p>Database deletion is <strong>irreversible</strong> - permanently deletes all data. Before executing: ensure recent backup exists, confirm no business uses the database, notify stakeholders.
Pigsty is not responsible for any data loss from database deletion. Use at your own risk.</p></div><hr><h2 id=rebuild-database>Rebuild Database</h2><p><code>recreate</code> state rebuilds database (drop then create):</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=script aria-controls=tabs-08-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-08-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab data-td-tp-persist=example aria-controls=tabs-08-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># Rebuild &lt;db&gt; (config must have state: recreate)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta testdb    <span style=color:#8f5902;font-style:italic># Rebuild testdb (config has state: recreate)</span>
</span></span></code></pre></div></div></div><p><strong>Config example</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>testdb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>recreate</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test_init.sql   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Execute after rebuild</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Use cases</strong>: Test environment reset, clear dev database, modify immutable properties (encoding, locale), restore to initial state.</p><p><strong>Difference from manual DROP + CREATE</strong>: Single command; auto-preserves Pgbouncer and Grafana config; auto-loads <code>baseline</code> init script.</p><hr><h2 id=clone-database>Clone Database</h2><p>Clone PostgreSQL databases using PG template mechanism. During cloning, no active connections to template database are allowed.</p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist=script aria-controls=tabs-09-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-09-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-09-02-tab data-bs-toggle=tab data-bs-target=#tabs-09-02 role=tab data-td-tp-persist=example aria-controls=tabs-09-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># Clone &lt;db&gt; (config must specify template)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-02 role=tabpanel aria-labelled-by=tabs-09-02-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta meta_dev    <span style=color:#8f5902;font-style:italic># Clone meta_dev (config has template: meta)</span>
</span></span></code></pre></div></div></div><p><strong>Config example</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Source database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use meta as template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PG15+ clone strategy, instant on PG18</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Instant Clone (PG18+)</strong>: If using PostgreSQL 18+, Pigsty defaults <a href=https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-FILE-COPY-METHOD><strong><code>file_copy_method</code></strong></a>. With <code>strategy: FILE_COPY</code>, database clone completes in ~200ms without copying data files. E.g., cloning 30GB database: normal takes 18s, instant takes 200ms.</p><p><strong>Manual clone</strong>: Ensure all connections to template are terminated:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_terminate_backend</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TEMPLATE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8> </span><span style=color:#000>STRATEGY</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Limitations</strong>: Instant clone only available on supported filesystems (xfs, brtfs, zfs, apfs); don&rsquo;t use <code>postgres</code> database as template; in high-concurrency environments, all template connections must be cleared within clone window (~200ms).</p><hr><h2 id=connection-pool-management>Connection Pool Management</h2><p><a href=/docs/pgsql/config/db#connection-pool><strong>Connection pool params</strong></a> in database definitions are applied to Pgbouncer when creating/modifying databases.</p><p>By default all databases are added to Pgbouncer pool (<code>pgbouncer: true</code>). Databases are added to <code>/etc/pgbouncer/database.txt</code>. Database-level pool params (<code>pool_mode</code>, <code>pool_size</code>, etc.) are configured via this file.</p><p>Use <code>postgres</code> OS user with <code>pgb</code> alias to access Pgbouncer admin database. For more pool management, see <a href=/docs/pgsql/admin/pgbouncer><strong>Pgbouncer Management</strong></a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0cd896e3522e4cf2db0a08ece91619f5>4 - Patroni HA Management</h1><div class=lead>Manage PostgreSQL cluster HA with Patroni, including config changes, status check, switchover, restart, and reinit replica.</div><h2 id=overview>Overview</h2><p>Pigsty uses Patroni to manage PostgreSQL clusters. It handles config changes, status checks, switchover, restart, reinit replicas, and more.</p><p>To use Patroni for management, you need one of the following identities:</p><ul><li>From <a href=/docs/concept/node#admin-node><strong>INFRA node</strong></a> as <a href=/docs/deploy/admin><strong>admin user</strong></a>, managing all clusters in the environment.</li><li>From <a href=/docs/concept/node#pgsql-node><strong>PGSQL node</strong></a> as <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> (default <code>postgres</code>), managing the current cluster only.</li></ul><p>Patroni provides <a href=https://patroni.readthedocs.io/en/latest/patronictl.html><strong><code>patronictl</code></strong></a> CLI for management. Pigsty provides a wrapper alias <code>pg</code> to simplify operations.</p><details><summary>Using patronictl via pg alias</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg <span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>patroni_conf</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/infra/conf/patronictl.yml&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -r <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#000>patroni_conf</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/etc/patroni/patroni.yml&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -r <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;error: patronictl config not found&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> 1<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    patronictl -c <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$@</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></details><hr><h2 id=available-commands>Available Commands</h2><table class=full-width><thead><tr><th>Command</th><th>Function</th><th>Description</th></tr></thead><tbody><tr><td><a href=#edit-config><strong><code>edit-config</code></strong></a></td><td>Edit Config</td><td>Interactively edit cluster Patroni/PostgreSQL config</td></tr><tr><td><a href=#list-status><strong><code>list</code></strong></a></td><td>List Status</td><td>List cluster members and their status</td></tr><tr><td><a href=#switchover><strong><code>switchover</code></strong></a></td><td>Switchover</td><td>Switch primary role to specified replica (planned)</td></tr><tr><td><a href=#failover><strong><code>failover</code></strong></a></td><td>Failover</td><td>Force failover to specified replica (emergency)</td></tr><tr><td><a href=#restart><strong><code>restart</code></strong></a></td><td>Restart</td><td>Restart PostgreSQL instance to apply restart-required params</td></tr><tr><td><a href=#reload><strong><code>reload</code></strong></a></td><td>Reload</td><td>Reload Patroni config (no restart needed)</td></tr><tr><td><a href=#reinit-replica><strong><code>reinit</code></strong></a></td><td>Reinit Replica</td><td>Reinitialize replica (wipe data and re-clone)</td></tr><tr><td><a href=#pause><strong><code>pause</code></strong></a></td><td>Pause Auto-Failover</td><td>Pause Patroni automatic failover</td></tr><tr><td><a href=#resume><strong><code>resume</code></strong></a></td><td>Resume Auto-Failover</td><td>Resume Patroni automatic failover</td></tr><tr><td><a href=#history><strong><code>history</code></strong></a></td><td>View History</td><td>Show cluster failover history</td></tr><tr><td><a href=#show-config><strong><code>show-config</code></strong></a></td><td>Show Config</td><td>Display current cluster config (read-only)</td></tr><tr><td><a href=#query><strong><code>query</code></strong></a></td><td>Execute Query</td><td>Execute SQL query on cluster members</td></tr><tr><td><a href=#topology><strong><code>topology</code></strong></a></td><td>View Topology</td><td>Display cluster replication topology</td></tr><tr><td><a href=#version><strong><code>version</code></strong></a></td><td>View Version</td><td>Display Patroni version info</td></tr><tr><td><a href=#remove><strong><code>remove</code></strong></a></td><td>Remove Member</td><td>Remove cluster member from DCS (dangerous)</td></tr></tbody></table><hr><h2 id=edit-config>Edit Config</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-edit-config><strong><code>edit-config</code></strong></a> to interactively edit cluster Patroni and PostgreSQL config. This opens an editor to modify config stored in DCS, automatically applying changes to all members. You can change Patroni params (<code>ttl</code>, <code>loop_wait</code>, <code>synchronous_mode</code>, etc.) and PostgreSQL params in <code>postgresql.parameters</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># Interactive edit cluster config</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; --force          <span style=color:#8f5902;font-style:italic># Skip confirmation and apply directly</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; -p &lt;k&gt;<span style=color:#ce5c00;font-weight:700>=</span>&lt;v&gt;       <span style=color:#8f5902;font-style:italic># Modify PostgreSQL param (--pg shorthand)</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; -s &lt;k&gt;<span style=color:#ce5c00;font-weight:700>=</span>&lt;v&gt;       <span style=color:#8f5902;font-style:italic># Modify Patroni param (--set shorthand)</span>
</span></span></code></pre></div><div id=asciinema-7f7700930ae8f7d432a1cae8fb8bc426 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-7f7700930ae8f7d432a1cae8fb8bc426",o="/demo/pgsql-config.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[7,"Edit Config"],[9,"Apply"],[11,"Verify"],[13,"API Edit"],[14,"API Verify"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><p>Common config modification examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify PostgreSQL param: slow query threshold (prompts for confirmation)</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify PostgreSQL param, skip confirmation</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify multiple PostgreSQL params</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>work_mem</span><span style=color:#ce5c00;font-weight:700>=</span>256MB -p <span style=color:#000>maintenance_work_mem</span><span style=color:#ce5c00;font-weight:700>=</span>1GB --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify Patroni params: increase failure detection window (increase RTO)</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>loop_wait</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>15</span> -s <span style=color:#000>ttl</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify Patroni param: enable synchronous replication mode</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>synchronous_mode</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify Patroni param: enable strict synchronous mode (require at least one sync replica for writes)</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>synchronous_mode_strict</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify restart-required params (need pg restart after)</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>shared_buffers</span><span style=color:#ce5c00;font-weight:700>=</span>4GB --force
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements&#39;</span> --force
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>max_connections</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>200</span> --force
</span></span></code></pre></div><p>Some params require PostgreSQL restart to take effect. Use <code>pg list</code> to check - instances marked with <code>*</code> need restart. Then use <code>pg restart</code> to apply.
You can also use <code>curl</code> or programs to call Patroni <a href=https://patroni.readthedocs.io/en/latest/rest_api.html><strong>REST API</strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View current config</span>
</span></span><span style=display:flex><span>curl -s 10.10.10.11:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Modify params via API (requires auth)</span>
</span></span><span style=display:flex><span>curl -u <span style=color:#4e9a06>&#39;postgres:Patroni.API&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>     -d <span style=color:#4e9a06>&#39;{&#34;postgresql&#34;:{&#34;parameters&#34;: {&#34;log_min_duration_statement&#34;:200}}}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>     -s -X PATCH http://10.10.10.11:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span></code></pre></div><hr><h2 id=list-status>List Status</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-list><strong><code>list</code></strong></a> to view cluster members and status. Output shows each instance&rsquo;s name, host, role, state, timeline, and replication lag. This is the most commonly used command for checking cluster health.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list &lt;cls&gt;                         <span style=color:#8f5902;font-style:italic># List specified cluster status</span>
</span></span><span style=display:flex><span>pg list                               <span style=color:#8f5902;font-style:italic># List all clusters (on admin node)</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -e                      <span style=color:#8f5902;font-style:italic># Show extended info (--extended)</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -t                      <span style=color:#8f5902;font-style:italic># Show timestamp (--timestamp)</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -f json                 <span style=color:#8f5902;font-style:italic># Output as JSON (--format)</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -W <span style=color:#0000cf;font-weight:700>5</span>                    <span style=color:#8f5902;font-style:italic># Refresh every 5 seconds (--watch)</span>
</span></span></code></pre></div><p>Example output:</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) -----+----+--------------+
| Member    | Host        | Role    | State   | TL | Lag in MB    |
+-----------+-------------+---------+---------+----+--------------+
| pg-test-1 | 10.10.10.11 | Leader  | running |  1 |              |
| pg-test-2 | 10.10.10.12 | Replica | running |  1 |            0 |
| pg-test-3 | 10.10.10.13 | Replica | running |  1 |            0 |
+-----------+-------------+---------+---------+----+--------------+
</code></pre><p>Column descriptions: <strong>Member</strong> is instance name, composed of <code>pg_cluster</code>-<code>pg_seq</code>; <strong>Host</strong> is instance IP; <strong>Role</strong> is role type - Leader (primary), Replica, Sync Standby, Standby Leader (cascade primary); <strong>State</strong> is running state - <code>running</code>, <code>streaming</code>, <code>in archive recovery</code>, <code>starting</code>, <code>stopped</code>, etc.; <strong>TL</strong> is timeline number, incremented after each switchover; <strong>Lag in MB</strong> is replication lag in MB (not shown for primary).</p><p>Instances requiring restart show <code>*</code> after the name:</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) -------+----+--------------+
| Member      | Host        | Role    | State   | TL | Lag in MB    |
+-------------+-------------+---------+---------+----+--------------+
| pg-test-1 * | 10.10.10.11 | Leader  | running |  1 |              |
| pg-test-2 * | 10.10.10.12 | Replica | running |  1 |            0 |
+-------------+-------------+---------+---------+----+--------------+
</code></pre><hr><h2 id=switchover>Switchover</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-switchover><strong><code>switchover</code></strong></a> for planned primary-replica switchover. Switchover is graceful: Patroni ensures replica is fully synced, demotes primary, then promotes target replica. Takes seconds with brief write unavailability. Use for primary host maintenance, upgrades, or migrating primary to better nodes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg switchover &lt;cls&gt;                   <span style=color:#8f5902;font-style:italic># Interactive switchover, prompts for target replica</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --leader &lt;old&gt;    <span style=color:#8f5902;font-style:italic># Specify current primary name</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --candidate &lt;new&gt; <span style=color:#8f5902;font-style:italic># Specify target replica name</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --scheduled &lt;time&gt; <span style=color:#8f5902;font-style:italic># Scheduled switchover, format: 2024-12-01T03:00</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --force           <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span></code></pre></div><p>Before switchover, ensure all replicas are healthy (<code>running</code> or <code>streaming</code>), replication lag is acceptable, and stakeholders are notified.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Interactive switchover (recommended, shows topology and prompts for selection)</span>
</span></span><span style=display:flex><span>$ pg switchover pg-test
</span></span><span style=display:flex><span>Current cluster topology
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -----+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span>Primary <span style=color:#ce5c00;font-weight:700>[</span>pg-test-1<span style=color:#ce5c00;font-weight:700>]</span>:
</span></span><span style=display:flex><span>Candidate <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;pg-test-2&#39;</span>, <span style=color:#4e9a06>&#39;pg-test-3&#39;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[]</span>: pg-test-2
</span></span><span style=display:flex><span>When should the switchover take place <span style=color:#ce5c00;font-weight:700>(</span>e.g. 2024-01-01T12:00<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>[</span>now<span style=color:#ce5c00;font-weight:700>]</span>:
</span></span><span style=display:flex><span>Are you sure you want to switchover cluster pg-test, demoting current leader pg-test-1? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Non-interactive switchover (specify primary and candidate)</span>
</span></span><span style=display:flex><span>pg switchover pg-test --leader pg-test-1 --candidate pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Scheduled switchover (at 3 AM, for maintenance window)</span>
</span></span><span style=display:flex><span>pg switchover pg-test --leader pg-test-1 --candidate pg-test-2 --scheduled <span style=color:#4e9a06>&#34;2024-12-01T03:00&#34;</span>
</span></span></code></pre></div><p>After switchover, use <code>pg list</code> to confirm new cluster topology.</p><hr><h2 id=failover>Failover</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-failover><strong><code>failover</code></strong></a> for emergency failover. Unlike <code>switchover</code>, <code>failover</code> is for when primary is unavailable. It directly promotes a replica without waiting for original primary confirmation. Since replicas may not be fully synced, <code>failover</code> may cause minor data loss. Use <code>switchover</code> for non-emergency situations.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg failover &lt;cls&gt;                     <span style=color:#8f5902;font-style:italic># Interactive failover</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --leader &lt;old&gt;      <span style=color:#8f5902;font-style:italic># Specify original primary (for verification, optional)</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --candidate &lt;new&gt;   <span style=color:#8f5902;font-style:italic># Specify replica to promote</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --force             <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span></code></pre></div><p>Failover examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Interactive failover</span>
</span></span><span style=display:flex><span>$ pg failover pg-test
</span></span><span style=display:flex><span>Candidate <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;pg-test-2&#39;</span>, <span style=color:#4e9a06>&#39;pg-test-3&#39;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[]</span>: pg-test-2
</span></span><span style=display:flex><span>Are you sure you want to failover cluster pg-test? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>Successfully failed over to <span style=color:#4e9a06>&#34;pg-test-2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Non-interactive failover (for emergencies)</span>
</span></span><span style=display:flex><span>pg failover pg-test --candidate pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Specify original primary for verification (errors if name mismatch)</span>
</span></span><span style=display:flex><span>pg failover pg-test --leader pg-test-1 --candidate pg-test-2 --force
</span></span></code></pre></div><p><strong>Switchover vs Failover</strong>: Switchover is for planned maintenance, requires original primary online, ensures full sync before switching, no data loss; Failover is for emergency recovery, original primary can be offline, directly promotes replica, may lose unsynced data. Use Switchover for daily maintenance/upgrades; use Failover only when primary is completely down and unrecoverable.</p><hr><h2 id=restart>Restart</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-restart><strong><code>restart</code></strong></a> to restart PostgreSQL instances, typically to apply restart-required param changes. Patroni coordinates restarts - for full cluster restart, it uses rolling restart: replicas first, then primary, minimizing downtime.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart &lt;cls&gt;                      <span style=color:#8f5902;font-style:italic># Restart all instances in cluster</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; &lt;member&gt;             <span style=color:#8f5902;font-style:italic># Restart specific instance</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --role leader        <span style=color:#8f5902;font-style:italic># Restart primary only</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --role replica       <span style=color:#8f5902;font-style:italic># Restart all replicas</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --pending            <span style=color:#8f5902;font-style:italic># Restart only instances marked for restart</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --scheduled &lt;time&gt;   <span style=color:#8f5902;font-style:italic># Scheduled restart</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --timeout &lt;sec&gt;      <span style=color:#8f5902;font-style:italic># Set restart timeout (seconds)</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --force              <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span></code></pre></div><p>After modifying restart-required params (<code>shared_buffers</code>, <code>shared_preload_libraries</code>, <code>max_connections</code>, <code>max_worker_processes</code>, etc.), use this command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check which instances need restart (marked with *)</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 * <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 * <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart single replica</span>
</span></span><span style=display:flex><span>pg restart pg-test pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart entire cluster (rolling restart, replicas then primary)</span>
</span></span><span style=display:flex><span>pg restart pg-test --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart only pending instances</span>
</span></span><span style=display:flex><span>pg restart pg-test --pending --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Restart all replicas only</span>
</span></span><span style=display:flex><span>pg restart pg-test --role replica --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Scheduled restart (for maintenance window)</span>
</span></span><span style=display:flex><span>pg restart pg-test --scheduled <span style=color:#4e9a06>&#34;2024-12-01T03:00&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Set restart timeout to 300 seconds</span>
</span></span><span style=display:flex><span>pg restart pg-test --timeout <span style=color:#0000cf;font-weight:700>300</span> --force
</span></span></code></pre></div><hr><h2 id=reload>Reload</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-reload><strong><code>reload</code></strong></a> to reload Patroni config without restarting PostgreSQL. This re-reads config files and applies non-restart params via <code>pg_reload_conf()</code>. Lighter than <code>restart</code> - doesn&rsquo;t interrupt connections or running queries.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg reload &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># Reload entire cluster config</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; &lt;member&gt;              <span style=color:#8f5902;font-style:italic># Reload specific instance config</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --role leader         <span style=color:#8f5902;font-style:italic># Reload primary only</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --role replica        <span style=color:#8f5902;font-style:italic># Reload all replicas</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --force               <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span></code></pre></div><p>Most PostgreSQL params work via <code>reload</code>. Only postmaster-context params (<code>shared_buffers</code>, <code>max_connections</code>, <code>shared_preload_libraries</code>, <code>archive_mode</code>, etc.) require restart.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload entire cluster</span>
</span></span><span style=display:flex><span>pg reload pg-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload single instance</span>
</span></span><span style=display:flex><span>pg reload pg-test pg-test-1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Force reload, skip confirmation</span>
</span></span><span style=display:flex><span>pg reload pg-test --force
</span></span></code></pre></div><hr><h2 id=reinit-replica>Reinit Replica</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-reinit><strong><code>reinit</code></strong></a> to reinitialize a replica. This deletes all data on the replica and performs fresh <code>pg_basebackup</code> from primary. Use when replica data is corrupted, replica is too far behind (WAL already purged), or replica config needs reset.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt;              <span style=color:#8f5902;font-style:italic># Reinitialize specified replica</span>
</span></span><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt; --force      <span style=color:#8f5902;font-style:italic># Skip confirmation</span>
</span></span><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt; --wait       <span style=color:#8f5902;font-style:italic># Wait for rebuild to complete</span>
</span></span></code></pre></div><blockquote><p>Warning: This operation <strong>deletes all data</strong> on target instance! Can only be run on replicas, not primary.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reinitialize replica (prompts for confirmation)</span>
</span></span><span style=display:flex><span>$ pg reinit pg-test pg-test-2
</span></span><span style=display:flex><span>Are you sure you want to reinitialize members pg-test-2? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>Success: reinitialize <span style=color:#204a87;font-weight:700>for</span> member pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Force reinitialize, skip confirmation</span>
</span></span><span style=display:flex><span>pg reinit pg-test pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reinitialize and wait for completion</span>
</span></span><span style=display:flex><span>pg reinit pg-test pg-test-2 --force --wait
</span></span></code></pre></div><p>During rebuild, use <code>pg list</code> to check progress. Replica state shows <code>creating replica</code>:</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) --------------+----+------+
| Member    | Host        | Role    | State            | TL | Lag  |
+-----------+-------------+---------+------------------+----+------+
| pg-test-1 | 10.10.10.11 | Leader  | running          |  2 |      |
| pg-test-2 | 10.10.10.12 | Replica | creating replica |    |    ? |
+-----------+-------------+---------+------------------+----+------+
</code></pre><hr><h2 id=pause>Pause</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-pause><strong><code>pause</code></strong></a> to pause Patroni automatic failover. When paused, Patroni won&rsquo;t auto-promote replicas even if primary fails. Use for planned maintenance windows (prevent accidental triggers), debugging (prevent cluster state changes), or manual switchover timing control.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg pause &lt;cls&gt;                        <span style=color:#8f5902;font-style:italic># Pause automatic failover</span>
</span></span><span style=display:flex><span>pg pause &lt;cls&gt; --wait                 <span style=color:#8f5902;font-style:italic># Pause and wait for all members to confirm</span>
</span></span></code></pre></div><blockquote><p>Warning: During pause, cluster <strong>won&rsquo;t auto-recover</strong> if primary fails! Remember to <code>resume</code> after maintenance.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pause automatic failover</span>
</span></span><span style=display:flex><span>$ pg pause pg-test
</span></span><span style=display:flex><span>Success: cluster management is paused
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check cluster status (shows Maintenance mode: on)</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -----+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span> Maintenance mode: on
</span></span></code></pre></div><hr><h2 id=resume>Resume</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-resume><strong><code>resume</code></strong></a> to resume Patroni automatic failover. Execute immediately after maintenance to ensure cluster auto-recovers on primary failure.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># Resume automatic failover</span>
</span></span><span style=display:flex><span>pg resume &lt;cls&gt; --wait                <span style=color:#8f5902;font-style:italic># Resume and wait for all members to confirm</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Resume automatic failover</span>
</span></span><span style=display:flex><span>$ pg resume pg-test
</span></span><span style=display:flex><span>Success: cluster management is resumed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Confirm resumed (Maintenance mode prompt disappears)</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span></code></pre></div><hr><h2 id=history>History</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-history><strong><code>history</code></strong></a> to view cluster failover history. Each switchover (auto or manual) creates a new timeline record.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt;                      <span style=color:#8f5902;font-style:italic># Show failover history</span>
</span></span><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt; -f json              <span style=color:#8f5902;font-style:italic># Output as JSON</span>
</span></span><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt; -f yaml              <span style=color:#8f5902;font-style:italic># Output as YAML</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg <span style=color:#204a87>history</span> pg-test
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span>       LSN <span style=color:#000;font-weight:700>|</span> Reason                       <span style=color:#000;font-weight:700>|</span> Timestamp                 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 0/5000060 <span style=color:#000;font-weight:700>|</span> no recovery target specified <span style=color:#000;font-weight:700>|</span> 2024-01-15T10:30:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 0/6000000 <span style=color:#000;font-weight:700>|</span> switchover to pg-test-2      <span style=color:#000;font-weight:700>|</span> 2024-01-20T14:00:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span> 0/7000028 <span style=color:#000;font-weight:700>|</span> failover to pg-test-1        <span style=color:#000;font-weight:700>|</span> 2024-01-25T09:15:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span></code></pre></div><p>Column descriptions: <strong>TL</strong> is timeline number, incremented after each switchover, distinguishes primary histories; <strong>LSN</strong> is Log Sequence Number at switchover, marks WAL position; <strong>Reason</strong> is switchover reason - <code>switchover to xxx</code> (manual), <code>failover to xxx</code> (failure), or <code>no recovery target specified</code> (init); <strong>Timestamp</strong> is when switchover occurred.</p><hr><h2 id=show-config>Show Config</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-show-config><strong><code>show-config</code></strong></a> to view current cluster config stored in DCS. This is read-only; use <code>edit-config</code> to modify.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg show-config &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># Show cluster config</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg show-config pg-test
</span></span><span style=display:flex><span>loop_wait: <span style=color:#0000cf;font-weight:700>10</span>
</span></span><span style=display:flex><span>maximum_lag_on_failover: <span style=color:#0000cf;font-weight:700>1048576</span>
</span></span><span style=display:flex><span>postgresql:
</span></span><span style=display:flex><span>  parameters:
</span></span><span style=display:flex><span>    archive_command: pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-test archive-push %p
</span></span><span style=display:flex><span>    max_connections: <span style=color:#0000cf;font-weight:700>100</span>
</span></span><span style=display:flex><span>    shared_buffers: 256MB
</span></span><span style=display:flex><span>    log_min_duration_statement: <span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>  use_pg_rewind: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>  use_slots: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>retry_timeout: <span style=color:#0000cf;font-weight:700>10</span>
</span></span><span style=display:flex><span>ttl: <span style=color:#0000cf;font-weight:700>30</span>
</span></span><span style=display:flex><span>synchronous_mode: <span style=color:#204a87>false</span>
</span></span></code></pre></div><hr><h2 id=query>Query</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-query><strong><code>query</code></strong></a> to quickly execute SQL on cluster members. Convenient for debugging - for complex production queries, use <code>psql</code> or applications.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span>             <span style=color:#8f5902;font-style:italic># Execute on primary</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -m &lt;member&gt; <span style=color:#8f5902;font-style:italic># Execute on specific instance (--member)</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -r leader   <span style=color:#8f5902;font-style:italic># Execute on primary (--role)</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -r replica  <span style=color:#8f5902;font-style:italic># Execute on all replicas</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -f &lt;file&gt;              <span style=color:#8f5902;font-style:italic># Execute SQL from file</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -U &lt;user&gt;   <span style=color:#8f5902;font-style:italic># Specify username (--username)</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -d &lt;db&gt;     <span style=color:#8f5902;font-style:italic># Specify database (--dbname)</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> --format json  <span style=color:#8f5902;font-style:italic># Output as JSON</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check primary connection count</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT count(*) FROM pg_stat_activity&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check PostgreSQL version</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT version()&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check replication status on all replicas</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT pg_is_in_recovery(), pg_last_wal_replay_lsn()&#34;</span> -r replica
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Execute on specific instance</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT pg_is_in_recovery()&#34;</span> -m pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use specific user and database</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT current_user, current_database()&#34;</span> -U postgres -d postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Output as JSON</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT * FROM pg_stat_replication&#34;</span> --format json
</span></span></code></pre></div><hr><h2 id=topology>Topology</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-topology><strong><code>topology</code></strong></a> to view cluster replication topology as a tree. More intuitive than <code>list</code> for showing primary-replica relationships, especially for cascading replication.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg topology &lt;cls&gt;                     <span style=color:#8f5902;font-style:italic># Show replication topology</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg topology pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1   <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> + pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> + pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span></code></pre></div><p>In cascading replication, topology clearly shows replication hierarchy - e.g., <code>pg-test-3</code> replicates from <code>pg-test-2</code>, which replicates from primary <code>pg-test-1</code>.</p><hr><h2 id=version>Version</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-version><strong><code>version</code></strong></a> to view patronictl version.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg version                            <span style=color:#8f5902;font-style:italic># Show patronictl version</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg version
</span></span><span style=display:flex><span>patronictl version 4.1.0
</span></span></code></pre></div><hr><h2 id=remove>Remove</h2><p>Use <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-remove><strong><code>remove</code></strong></a> to remove cluster or member metadata from DCS. This is dangerous - only removes DCS metadata, doesn&rsquo;t stop PostgreSQL or delete data files. Misuse may cause cluster state inconsistency.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg remove &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># Remove entire cluster metadata from DCS</span>
</span></span></code></pre></div><p>Normally you don&rsquo;t need this command. To properly remove clusters/instances, use Pigsty&rsquo;s <a href=/docs/pgsql/admin/cluster#remove-cluster><strong><code>bin/pgsql-rm</code></strong></a> script or <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> playbook.
Only consider <code>remove</code> for: orphaned DCS metadata (node physically removed but metadata remains), or cluster destroyed via other means requiring metadata cleanup.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove entire cluster metadata (requires multiple confirmations)</span>
</span></span><span style=display:flex><span>$ pg remove pg-test
</span></span><span style=display:flex><span>Please confirm the cluster name to remove: pg-test
</span></span><span style=display:flex><span>You are about to remove all information in DCS <span style=color:#204a87;font-weight:700>for</span> pg-test, please type: <span style=color:#4e9a06>&#34;Yes I am aware&#34;</span>: Yes I am aware
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-289eefb8da504803e0c1952004777bb0>5 - Pgbouncer Connection Pooling</h1><div class=lead>Manage Pgbouncer connection pool, including pause, resume, disable, enable, reconnect, kill, and reload operations.</div><h2 id=overview>Overview</h2><p>Pigsty uses <a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> as PostgreSQL connection pooling middleware, listening on port <code>6432</code> by default, proxying access to local PostgreSQL on port <code>5432</code>.</p><p>This is an <strong>optional component</strong>. If you don&rsquo;t have massive connections or need transaction pooling and query metrics, you can disable it, connect directly to the database, or keep it unused.</p><hr><h2 id=user--database-management>User & Database Management</h2><p>Pgbouncer users and databases are auto-managed by Pigsty, applying <a href=/docs/pgsql/config/db><strong>database config</strong></a> and <a href=/docs/pgsql/config/user><strong>user config</strong></a> when <a href=/docs/pgsql/admin/db><strong>creating databases</strong></a> and <a href=/docs/pgsql/admin/user><strong>creating users</strong></a>.</p><p><strong>Database Management</strong>: Databases defined in <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> are auto-added to Pgbouncer by default. Set <a href=/docs/pgsql/admin/db#pgbouncer><strong><code>pgbouncer: false</code></strong></a> to exclude specific databases.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mydb               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Added to connection pool by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Database-level pool mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Default pool size</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># Excluded from connection pool</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>User Management</strong>: Users defined in <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> need explicit <a href=/docs/pgsql/admin/user#pgbouncer><strong><code>pgbouncer: true</code></strong></a> to be added to connection pool user list.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># Add to connection pool user list</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># User-level pool mode</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=service-management>Service Management</h2><p>In Pigsty, PostgreSQL cluster <a href=/docs/concept/ha/svc#primary-service><strong>Primary Service</strong></a> and Replica Service default to Pgbouncer port 6432.
To bypass connection pool and access PostgreSQL directly, customize <a href=/docs/pgsql/param#pg_services><strong><code>pg_services</code></strong></a>, or set <a href=/docs/pgsql/param#pg_default_service_dest><strong><code>pg_default_service_dest</code></strong></a> to <code>postgres</code>.</p><hr><h2 id=config-management>Config Management</h2><p>Pgbouncer config files are in <code>/etc/pgbouncer/</code>, generated and managed by Pigsty:</p><table class=full-width><thead><tr><th>File</th><th>Description</th></tr></thead><tbody><tr><td><code>pgbouncer.ini</code></td><td>Main config, pool-level params</td></tr><tr><td><code>database.txt</code></td><td>Database list, database-level params</td></tr><tr><td><code>userlist.txt</code></td><td>User password list</td></tr><tr><td><code>useropts.txt</code></td><td>User-level pool params</td></tr><tr><td><code>pgb_hba.conf</code></td><td>HBA access control rules</td></tr></tbody></table><p>Pigsty auto-manages <code>database.txt</code> and <code>userlist.txt</code>, updating them when <a href=/docs/pgsql/admin/db#create-database><strong>creating databases</strong></a> or <a href=/docs/pgsql/admin/user#create-user><strong>creating users</strong></a>.</p><p>You can manually edit config then <code>RELOAD</code> to apply:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Edit config</span>
</span></span><span style=display:flex><span>$ vim /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload via systemctl</span>
</span></span><span style=display:flex><span>$ sudo systemctl reload pgbouncer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload as pg_dbsu / postgres user</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>
</span></span></code></pre></div><hr><h2 id=pool-management>Pool Management</h2><p>Pgbouncer runs as the same <code>dbsu</code> as PostgreSQL, default <code>postgres</code> OS user. Pigsty provides <code>pgb</code> alias for easy management:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>alias</span> <span style=color:#000>pgb</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;psql -p 6432 -d pgbouncer -U postgres&#34;</span>
</span></span></code></pre></div><p>Use <code>pgb</code> on database nodes to connect to Pgbouncer admin console for management commands and monitoring queries.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW POOLS;</span>
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW CLIENTS;</span>
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW SERVERS;</span>
</span></span></code></pre></div><table class=full-width><thead><tr><th>Command</th><th>Function</th><th>Description</th></tr></thead><tbody><tr><td><a href=#pause><strong><code>PAUSE</code></strong></a></td><td>Pause</td><td>Pause database, wait for txn completion then disconnect</td></tr><tr><td><a href=#resume><strong><code>RESUME</code></strong></a></td><td>Resume</td><td>Resume database paused by PAUSE/KILL/SUSPEND</td></tr><tr><td><a href=#disable><strong><code>DISABLE</code></strong></a></td><td>Disable</td><td>Reject new client connections for database</td></tr><tr><td><a href=#enable><strong><code>ENABLE</code></strong></a></td><td>Enable</td><td>Allow new client connections for database</td></tr><tr><td><a href=#reconnect><strong><code>RECONNECT</code></strong></a></td><td>Reconnect</td><td>Gracefully close and rebuild server connections</td></tr><tr><td><a href=#kill><strong><code>KILL</code></strong></a></td><td>Kill</td><td>Immediately disconnect all client and server connections</td></tr><tr><td><a href=#kill_client><strong><code>KILL_CLIENT</code></strong></a></td><td>Kill Client</td><td>Terminate specific client connection</td></tr><tr><td><a href=#suspend><strong><code>SUSPEND</code></strong></a></td><td>Suspend</td><td>Flush buffers and stop listening, for online restart</td></tr><tr><td><a href=#shutdown><strong><code>SHUTDOWN</code></strong></a></td><td>Shutdown</td><td>Shutdown Pgbouncer process</td></tr><tr><td><a href=#reload><strong><code>RELOAD</code></strong></a></td><td>Reload</td><td>Reload config files</td></tr><tr><td><a href=#wait_close><strong><code>WAIT_CLOSE</code></strong></a></td><td>Wait Close</td><td>Wait for server connections to close after RECONNECT/RELOAD</td></tr><tr><td><a href=#monitoring><strong>Monitor Commands</strong></a></td><td>Monitor</td><td>View pool status, clients, servers, etc.</td></tr></tbody></table><hr><h3 id=pause>PAUSE</h3><p>Use <code>PAUSE</code> to pause database connections. Pgbouncer waits for active txn/session to complete based on pool mode, then disconnects server connections. New client requests are blocked until <code>RESUME</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>PAUSE</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Pause specified database, or all if not specified
</span></span></span></code></pre></div><p>Typical use cases:</p><ul><li>Online backend database switch (e.g., update connection target after switchover)</li><li>Maintenance operations requiring all connections disconnected</li><li>Combined with <code>SUSPEND</code> for Pgbouncer online restart</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;PAUSE mydb;&#34;</span>        <span style=color:#8f5902;font-style:italic># Pause mydb database</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;PAUSE;&#34;</span>             <span style=color:#8f5902;font-style:italic># Pause all databases</span>
</span></span></code></pre></div><p>After pause, <code>SHOW DATABASES</code> shows <code>paused</code> status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=#</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>DATABASES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>   </span><span style=color:#000>name</span><span style=color:#f8f8f8>   </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8>    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>port</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>paused</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------+-----------+------+----------+-----+--------+----------
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8> </span><span style=color:#000>mydb</span><span style=color:#f8f8f8>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>run</span><span style=color:#f8f8f8>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>mydb</span><span style=color:#f8f8f8>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>      </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h3 id=resume>RESUME</h3><p>Use <code>RESUME</code> to restore databases paused by <code>PAUSE</code>, <code>KILL</code>, or <code>SUSPEND</code>, allowing new connections and resuming normal service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RESUME</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- Resume specified database, or all if not specified
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RESUME mydb;&#34;</span>       <span style=color:#8f5902;font-style:italic># Resume mydb database</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RESUME;&#34;</span>            <span style=color:#8f5902;font-style:italic># Resume all databases</span>
</span></span></code></pre></div><hr><h3 id=disable>DISABLE</h3><p>Use <code>DISABLE</code> to disable a database, rejecting all new client connection requests. Existing connections are unaffected.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>DISABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Disable specified database (database name required)
</span></span></span></code></pre></div><p>Typical use cases:</p><ul><li>Temporarily offline a database for maintenance</li><li>Block new connections for safe database migration</li><li>Gradually decommission a database being removed</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;DISABLE mydb;&#34;</span>      <span style=color:#8f5902;font-style:italic># Disable mydb, new connections rejected</span>
</span></span></code></pre></div><hr><h3 id=enable>ENABLE</h3><p>Use <code>ENABLE</code> to enable a database previously disabled by <code>DISABLE</code>, accepting new client connections again.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ENABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>-- Enable specified database (database name required)
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;ENABLE mydb;&#34;</span>       <span style=color:#8f5902;font-style:italic># Enable mydb, allow new connections</span>
</span></span></code></pre></div><hr><h3 id=reconnect>RECONNECT</h3><p>Use <code>RECONNECT</code> to gracefully rebuild server connections. Pgbouncer closes connections when released back to pool, creating new ones when needed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RECONNECT</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- Rebuild server connections for database, or all if not specified
</span></span></span></code></pre></div><p>Typical use cases:</p><ul><li>Refresh connections after backend database IP change</li><li>Reroute traffic after switchover</li><li>Rebuild connections after DNS update</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT mydb;&#34;</span>    <span style=color:#8f5902;font-style:italic># Rebuild mydb server connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT;&#34;</span>         <span style=color:#8f5902;font-style:italic># Rebuild all server connections</span>
</span></span></code></pre></div><p>After <code>RECONNECT</code>, use <code>WAIT_CLOSE</code> to wait for old connections to fully release.</p><hr><h3 id=kill>KILL</h3><p>Use <code>KILL</code> to immediately disconnect all client and server connections for a database. Unlike <code>PAUSE</code>, <code>KILL</code> doesn&rsquo;t wait for transaction completion - forces immediate disconnect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>KILL</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>-- Kill all connections for database, or all (except admin) if not specified
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL mydb;&#34;</span>         <span style=color:#8f5902;font-style:italic># Force disconnect all mydb connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL;&#34;</span>              <span style=color:#8f5902;font-style:italic># Force disconnect all database connections (except admin)</span>
</span></span></code></pre></div><p>After <code>KILL</code>, new connections are blocked until <code>RESUME</code>.</p><hr><h3 id=kill_client>KILL_CLIENT</h3><p>Use <code>KILL_CLIENT</code> to terminate a specific client connection. Client ID can be obtained from <code>SHOW CLIENTS</code> output.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>KILL_CLIENT</span><span style=color:#f8f8f8> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- Terminate client connection with specified ID
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View client connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW CLIENTS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Terminate specific client (assuming ptr column shows ID 0x1234567890)</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL_CLIENT 0x1234567890;&#34;</span>
</span></span></code></pre></div><hr><h3 id=suspend>SUSPEND</h3><p>Use <code>SUSPEND</code> to suspend Pgbouncer. Flushes all socket buffers and stops listening until <code>RESUME</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SUSPEND</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- Suspend Pgbouncer
</span></span></span></code></pre></div><p><code>SUSPEND</code> is mainly for Pgbouncer online restart (zero-downtime upgrade):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Suspend current Pgbouncer</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SUSPEND;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Start new Pgbouncer process (with -R option to take over sockets)</span>
</span></span><span style=display:flex><span>$ pgbouncer -R /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. New process takes over, old process exits automatically</span>
</span></span></code></pre></div><hr><h3 id=shutdown>SHUTDOWN</h3><p>Use <code>SHUTDOWN</code> to shut down Pgbouncer process. Multiple shutdown modes supported:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic>-- Immediate shutdown
</span></span></span><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#f8f8f8> </span><span style=color:#000>WAIT_FOR_SERVERS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic>-- Wait for server connections to release
</span></span></span><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#f8f8f8> </span><span style=color:#000>WAIT_FOR_CLIENTS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic>-- Wait for clients to disconnect (zero-downtime rolling restart)
</span></span></span></code></pre></div><table class=full-width><thead><tr><th>Mode</th><th>Description</th></tr></thead><tbody><tr><td><code>SHUTDOWN</code></td><td>Immediately shutdown Pgbouncer</td></tr><tr><td><code>WAIT_FOR_SERVERS</code></td><td>Stop accepting new connections, wait for server release</td></tr><tr><td><code>WAIT_FOR_CLIENTS</code></td><td>Stop accepting new connections, wait for all clients disconnect, for rolling restart</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHUTDOWN WAIT_FOR_CLIENTS;&#34;</span>   <span style=color:#8f5902;font-style:italic># Graceful shutdown, wait for clients</span>
</span></span></code></pre></div><hr><h3 id=reload>RELOAD</h3><p>Use <code>RELOAD</code> to reload Pgbouncer config files. Dynamically updates most config params without process restart.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RELOAD</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic>-- Reload config files
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>              <span style=color:#8f5902;font-style:italic># Reload via admin console</span>
</span></span><span style=display:flex><span>$ systemctl reload pgbouncer    <span style=color:#8f5902;font-style:italic># Reload via systemd</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGHUP <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Reload via signal</span>
</span></span></code></pre></div><p>Pigsty provides playbook task to reload Pgbouncer config:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pgbouncer_reload    <span style=color:#8f5902;font-style:italic># Reload cluster Pgbouncer config</span>
</span></span></code></pre></div><hr><h3 id=wait_close>WAIT_CLOSE</h3><p>Use <code>WAIT_CLOSE</code> to wait for server connections to finish closing. Typically used after <code>RECONNECT</code> or <code>RELOAD</code> to ensure old connections are fully released.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>WAIT_CLOSE</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- Wait for server connections to close, or all if not specified
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Complete connection rebuild flow</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT mydb;&#34;</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;WAIT_CLOSE mydb;&#34;</span>    <span style=color:#8f5902;font-style:italic># Wait for old connections to release</span>
</span></span></code></pre></div><hr><h3 id=monitoring>Monitoring</h3><p>Pgbouncer provides rich <code>SHOW</code> commands for monitoring pool status:</p><table class=full-width><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td><code>SHOW HELP</code></td><td>Show available commands</td></tr><tr><td><code>SHOW DATABASES</code></td><td>Show database config and status</td></tr><tr><td><code>SHOW POOLS</code></td><td>Show pool statistics</td></tr><tr><td><code>SHOW CLIENTS</code></td><td>Show client connection list</td></tr><tr><td><code>SHOW SERVERS</code></td><td>Show server connection list</td></tr><tr><td><code>SHOW USERS</code></td><td>Show user config</td></tr><tr><td><code>SHOW STATS</code></td><td>Show statistics (requests, bytes)</td></tr><tr><td><code>SHOW STATS_TOTALS</code></td><td>Show cumulative statistics</td></tr><tr><td><code>SHOW STATS_AVERAGES</code></td><td>Show average statistics</td></tr><tr><td><code>SHOW CONFIG</code></td><td>Show current config params</td></tr><tr><td><code>SHOW MEM</code></td><td>Show memory usage</td></tr><tr><td><code>SHOW DNS_HOSTS</code></td><td>Show DNS cached hostnames</td></tr><tr><td><code>SHOW DNS_ZONES</code></td><td>Show DNS cached zones</td></tr><tr><td><code>SHOW SOCKETS</code></td><td>Show open socket info</td></tr><tr><td><code>SHOW ACTIVE_SOCKETS</code></td><td>Show active sockets</td></tr><tr><td><code>SHOW LISTS</code></td><td>Show internal list counts</td></tr><tr><td><code>SHOW FDS</code></td><td>Show file descriptor usage</td></tr><tr><td><code>SHOW STATE</code></td><td>Show Pgbouncer running state</td></tr><tr><td><code>SHOW VERSION</code></td><td>Show Pgbouncer version</td></tr></tbody></table><p>Common monitoring examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View pool status</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW POOLS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View client connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW CLIENTS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View server connections</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW SERVERS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View statistics</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW STATS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># View database status</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW DATABASES;&#34;</span>
</span></span></code></pre></div><p>For more monitoring command details, see <a href=https://www.pgbouncer.org/usage.html><strong>Pgbouncer official docs</strong></a>.</p><hr><h3 id=unix-signals>Unix Signals</h3><p>Pgbouncer supports Unix signal control, useful when admin console is unavailable:</p><table class=full-width><thead><tr><th>Signal</th><th>Equivalent Command</th><th>Description</th></tr></thead><tbody><tr><td><code>SIGHUP</code></td><td><code>RELOAD</code></td><td>Reload config files</td></tr><tr><td><code>SIGTERM</code></td><td><code>SHUTDOWN WAIT_FOR_CLIENTS</code></td><td>Graceful shutdown, wait clients</td></tr><tr><td><code>SIGINT</code></td><td><code>SHUTDOWN WAIT_FOR_SERVERS</code></td><td>Graceful shutdown, wait servers</td></tr><tr><td><code>SIGQUIT</code></td><td><code>SHUTDOWN</code></td><td>Immediate shutdown</td></tr><tr><td><code>SIGUSR1</code></td><td><code>PAUSE</code></td><td>Pause all databases</td></tr><tr><td><code>SIGUSR2</code></td><td><code>RESUME</code></td><td>Resume all databases</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Reload config via signal</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGHUP <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Graceful shutdown via signal</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGTERM <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pause via signal</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGUSR1 <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Resume via signal</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGUSR2 <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><hr><h2 id=traffic-switching>Traffic Switching</h2><p>Pigsty provides <code>pgb-route</code> utility function to quickly switch Pgbouncer traffic to other nodes for zero-downtime migration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Definition (already in /etc/profile.d/pg-alias.sh)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pgb-route<span style=color:#ce5c00;font-weight:700>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>local</span> <span style=color:#000>ip</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>1</span><span style=color:#000;font-weight:700>-</span><span style=color:#4e9a06>&#39;\/var\/run\/postgresql&#39;</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>  sed -ie <span style=color:#4e9a06>&#34;s/host=[^[:space:]]\+/host=</span><span style=color:#4e9a06>${</span><span style=color:#000>ip</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Usage: Route traffic to 10.10.10.12</span>
</span></span><span style=display:flex><span>$ pgb-route 10.10.10.12
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT; WAIT_CLOSE;&#34;</span>
</span></span></code></pre></div><p>Complete zero-downtime switching flow:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Modify route target</span>
</span></span><span style=display:flex><span>$ pgb-route 10.10.10.12
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Reload config</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. Rebuild connections and wait for old connections to release</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT;&#34;</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;WAIT_CLOSE;&#34;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ef5d737e5bae0aa77e9e8e5340965fd9>6 - Managing PostgreSQL Component Services</h1><div class=lead>Use systemctl to manage PostgreSQL cluster component services - start, stop, restart, reload, and status check.</div><h2 id=overview>Overview</h2><p>Pigsty&rsquo;s PGSQL module consists of multiple components, each running as a systemd service on nodes. (<a href=/docs/concept/arch/pgsql#pgbackrest><strong>pgbackrest</strong></a> is an exception)</p><p>Understanding these components and their management is essential for maintaining production PostgreSQL clusters.</p><table class=full-width><thead><tr><th style=text-align:left>Component</th><th style=text-align:left>Port</th><th style=text-align:left>Service Name</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>Patroni</td><td style=text-align:left><strong><code>8008</code></strong></td><td style=text-align:left><code>patroni</code></td><td style=text-align:left>HA manager, manages PostgreSQL lifecycle</td></tr><tr><td style=text-align:left>PostgreSQL</td><td style=text-align:left><strong><code>5432</code></strong></td><td style=text-align:left><code>postgres</code></td><td style=text-align:left>Placeholder service, not used, for emergency</td></tr><tr><td style=text-align:left>Pgbouncer</td><td style=text-align:left><strong><code>6432</code></strong></td><td style=text-align:left><code>pgbouncer</code></td><td style=text-align:left>Connection pooling middleware, traffic entry</td></tr><tr><td style=text-align:left>PgBackRest</td><td style=text-align:left>-</td><td style=text-align:left>-</td><td style=text-align:left>pgBackRest has no daemon service</td></tr><tr><td style=text-align:left>HAProxy</td><td style=text-align:left><strong><code>543x</code></strong></td><td style=text-align:left><code>haproxy</code></td><td style=text-align:left>Load balancer, exposes database services</td></tr><tr><td style=text-align:left>pg_exporter</td><td style=text-align:left><strong><code>9630</code></strong></td><td style=text-align:left><code>pg_exporter</code></td><td style=text-align:left>PostgreSQL metrics exporter</td></tr><tr><td style=text-align:left>pgbouncer_exporter</td><td style=text-align:left><strong><code>9631</code></strong></td><td style=text-align:left><code>pgbouncer_exporter</code></td><td style=text-align:left>Pgbouncer metrics exporter</td></tr><tr><td style=text-align:left>vip-manager</td><td style=text-align:left>-</td><td style=text-align:left><code>vip-manager</code></td><td style=text-align:left>Optional, manages L2 VIP address floating</td></tr></tbody></table><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Important</div><p><strong>Do NOT use systemctl directly to manage PostgreSQL service</strong>. PostgreSQL is managed by Patroni - use <a href=/docs/pgsql/admin/patroni><strong><code>patronictl</code></strong></a> commands instead.
Direct PostgreSQL operations may cause Patroni state inconsistency and trigger unexpected failover. The <code>postgres</code> service is an emergency escape hatch when Patroni fails.</p></div><hr><h2 id=quick-reference>Quick Reference</h2><table><thead><tr><th style=text-align:left>Operation</th><th style=text-align:left>Command</th></tr></thead><tbody><tr><td style=text-align:left>Start</td><td style=text-align:left><code>systemctl start &lt;service></code></td></tr><tr><td style=text-align:left>Stop</td><td style=text-align:left><code>systemctl stop &lt;service></code></td></tr><tr><td style=text-align:left>Restart</td><td style=text-align:left><code>systemctl restart &lt;service></code></td></tr><tr><td style=text-align:left>Reload</td><td style=text-align:left><code>systemctl reload &lt;service></code></td></tr><tr><td style=text-align:left>Status</td><td style=text-align:left><code>systemctl status &lt;service></code></td></tr><tr><td style=text-align:left>Logs</td><td style=text-align:left><code>journalctl -u &lt;service> -f</code></td></tr><tr><td style=text-align:left>Enable</td><td style=text-align:left><code>systemctl enable &lt;service></code></td></tr><tr><td style=text-align:left>Disable</td><td style=text-align:left><code>systemctl disable &lt;service></code></td></tr></tbody></table><p>Common service names: <code>patroni</code>, <code>pgbouncer</code>, <code>haproxy</code>, <code>pg_exporter</code>, <code>pgbouncer_exporter</code>, <code>vip-manager</code></p><hr><h2 id=patroni>Patroni</h2><p><a href=https://patroni.readthedocs.io/><strong>Patroni</strong></a> is PostgreSQL&rsquo;s HA manager, handling startup, shutdown, failure detection, and automatic failover.
It&rsquo;s the core PGSQL module component. PostgreSQL process is managed by Patroni - don&rsquo;t use systemctl to manage postgres service directly.</p><p><strong>Start Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start patroni     <span style=color:#8f5902;font-style:italic># Start Patroni (also starts PostgreSQL)</span>
</span></span></code></pre></div><p>After starting, Patroni auto-launches PostgreSQL. On first start, behavior depends on role:</p><ul><li>Primary: Initialize or recover data directory</li><li>Replica: Clone data from primary and establish replication</li></ul><p><strong>Stop Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop patroni      <span style=color:#8f5902;font-style:italic># Stop Patroni (also stops PostgreSQL)</span>
</span></span></code></pre></div><p>Stopping Patroni gracefully shuts down PostgreSQL. Note: If this is primary and auto-failover isn&rsquo;t paused, may trigger failover.</p><p><strong>Restart Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni   <span style=color:#8f5902;font-style:italic># Restart Patroni (also restarts PostgreSQL)</span>
</span></span></code></pre></div><p>Restart causes brief service interruption. For production, use <code>pg restart</code> for rolling restart.</p><p><strong>Reload Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload patroni    <span style=color:#8f5902;font-style:italic># Reload Patroni config</span>
</span></span></code></pre></div><p>Reload re-reads config file and applies hot-reloadable params to PostgreSQL.</p><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status patroni    <span style=color:#8f5902;font-style:italic># View Patroni service status</span>
</span></span><span style=display:flex><span>journalctl -u patroni -f    <span style=color:#8f5902;font-style:italic># Real-time Patroni logs</span>
</span></span><span style=display:flex><span>journalctl -u patroni -n <span style=color:#0000cf;font-weight:700>100</span> --no-pager  <span style=color:#8f5902;font-style:italic># Last 100 lines</span>
</span></span></code></pre></div><p><strong>Config file</strong>: <code>/etc/patroni/patroni.yml</code></p><blockquote><p><strong>Best Practice</strong>: Use <a href=/docs/pgsql/admin/patroni><strong><code>patronictl</code></strong></a> instead of systemctl to manage PostgreSQL clusters.</p></blockquote><hr><h2 id=pgbouncer>Pgbouncer</h2><p><a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> is a lightweight PostgreSQL connection pooling middleware.
Business traffic typically goes through Pgbouncer (6432) rather than directly to PostgreSQL (5432) for connection reuse and database protection.</p><p><strong>Start Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pgbouncer
</span></span></code></pre></div><p><strong>Stop Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pgbouncer
</span></span></code></pre></div><p>Note: Stopping Pgbouncer disconnects all pooled business connections.</p><p><strong>Restart Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart pgbouncer
</span></span></code></pre></div><p>Restart disconnects all existing connections. For config changes only, use <code>reload</code>.</p><p><strong>Reload Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload pgbouncer
</span></span></code></pre></div><p>Reload re-reads config files (user list, pool params, etc.) without disconnecting existing connections.</p><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pgbouncer
</span></span><span style=display:flex><span>journalctl -u pgbouncer -f
</span></span></code></pre></div><p><strong>Config files</strong>:</p><ul><li>Main config: <code>/etc/pgbouncer/pgbouncer.ini</code></li><li>HBA rules: <code>/etc/pgbouncer/pgb_hba.conf</code></li><li>User list: <code>/etc/pgbouncer/userlist.txt</code></li><li>Database list: <code>/etc/pgbouncer/database.txt</code></li></ul><p><strong>Admin Console</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>6432</span> -U postgres -d pgbouncer  <span style=color:#8f5902;font-style:italic># Connect to Pgbouncer admin console</span>
</span></span></code></pre></div><p>Common admin commands:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>POOLS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- View pool status
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>CLIENTS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- View client connections
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>SERVERS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- View backend server connections
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>STATS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- View statistics
</span></span></span><span style=display:flex><span><span style=color:#000>RELOAD</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- Reload config
</span></span></span><span style=display:flex><span><span style=color:#000>PAUSE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Pause all pools
</span></span></span><span style=display:flex><span><span style=color:#000>RESUME</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- Resume all pools
</span></span></span></code></pre></div><hr><h2 id=haproxy>HAProxy</h2><p><a href=https://www.haproxy.org/><strong>HAProxy</strong></a> is a high-performance load balancer that routes traffic to correct PostgreSQL instances.
Pigsty uses HAProxy to expose <a href=/docs/pgsql/service/><strong>services</strong></a>, routing traffic based on role (primary/replica) and health status.</p><p><strong>Start HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start haproxy
</span></span></code></pre></div><p><strong>Stop HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop haproxy
</span></span></code></pre></div><p>Note: Stopping HAProxy disconnects all load-balanced connections.</p><p><strong>Restart HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart haproxy
</span></span></code></pre></div><p><strong>Reload HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload haproxy
</span></span></code></pre></div><p>HAProxy supports graceful reload without disconnecting existing connections. Use <code>reload</code> for config changes.</p><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status haproxy
</span></span><span style=display:flex><span>journalctl -u haproxy -f
</span></span></code></pre></div><p><strong>Config file</strong>: <code>/etc/haproxy/haproxy.cfg</code></p><p><strong>Admin Interface</strong></p><p>HAProxy provides a web admin interface, default port 9101:</p><pre tabindex=0><code>http://&lt;node_ip&gt;:9101/haproxy
</code></pre><p>Default auth: username <code>admin</code>, password configured by <a href=/docs/node/param#haproxy_admin_password><strong><code>haproxy_admin_password</code></strong></a>.</p><hr><h2 id=pg_exporter>pg_exporter</h2><p><a href=https://github.com/pgsty/pg_exporter><strong>pg_exporter</strong></a> is PostgreSQL&rsquo;s Prometheus metrics exporter for collecting database performance metrics.</p><p><strong>Start pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pg_exporter
</span></span></code></pre></div><p><strong>Stop pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pg_exporter
</span></span></code></pre></div><p>After stopping, Prometheus can&rsquo;t collect PostgreSQL metrics from this instance.</p><p><strong>Restart pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart pg_exporter
</span></span></code></pre></div><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pg_exporter
</span></span><span style=display:flex><span>journalctl -u pg_exporter -f
</span></span></code></pre></div><p><strong>Config file</strong>: <code>/etc/pg_exporter.yml</code></p><p><strong>Verify Metrics</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s localhost:9630/metrics <span style=color:#000;font-weight:700>|</span> head -20
</span></span></code></pre></div><hr><h2 id=pgbouncer_exporter>pgbouncer_exporter</h2><p><strong>pgbouncer_exporter</strong> is Pgbouncer&rsquo;s Prometheus metrics exporter.</p><p><strong>Start/Stop/Restart</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pgbouncer_exporter
</span></span><span style=display:flex><span>systemctl stop pgbouncer_exporter
</span></span><span style=display:flex><span>systemctl restart pgbouncer_exporter
</span></span></code></pre></div><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pgbouncer_exporter
</span></span><span style=display:flex><span>journalctl -u pgbouncer_exporter -f
</span></span></code></pre></div><p><strong>Verify Metrics</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s localhost:9631/metrics <span style=color:#000;font-weight:700>|</span> head -20
</span></span></code></pre></div><hr><h2 id=vip-manager>vip-manager</h2><p><a href=https://github.com/cybertec-postgresql/vip-manager><strong>vip-manager</strong></a> is an optional component for managing L2 VIP address floating.
When <a href=/docs/pgsql/param#pg_vip_enabled><strong><code>pg_vip_enabled</code></strong></a> is enabled, vip-manager binds VIP to current primary node.</p><p><strong>Start vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start vip-manager
</span></span></code></pre></div><p><strong>Stop vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop vip-manager
</span></span></code></pre></div><p>After stopping, VIP address is released from current node.</p><p><strong>Restart vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart vip-manager
</span></span></code></pre></div><p><strong>View Status & Logs</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status vip-manager
</span></span><span style=display:flex><span>journalctl -u vip-manager -f
</span></span></code></pre></div><p><strong>Config file</strong>: <code>/etc/default/vip-manager</code></p><p><strong>Verify VIP Binding</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip addr show           <span style=color:#8f5902;font-style:italic># Check network interfaces, verify VIP binding</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt;          <span style=color:#8f5902;font-style:italic># Confirm primary location</span>
</span></span></code></pre></div><hr><h2 id=startup-order--dependencies>Startup Order & Dependencies</h2><p>Recommended PGSQL module component startup order:</p><pre tabindex=0><code>1. patroni          # Start Patroni first (auto-starts PostgreSQL)
2. pgbouncer        # Then start connection pool
3. haproxy          # Start load balancer
4. pg_exporter      # Start metrics exporters
5. pgbouncer_exporter
6. vip-manager      # Finally start VIP manager (if enabled)
</code></pre><p>Stop order should be reversed. Pigsty playbooks handle these dependencies automatically.</p><p><strong>Batch Start All Services</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start patroni pgbouncer haproxy pg_exporter pgbouncer_exporter
</span></span></code></pre></div><p><strong>Batch Stop All Services</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pgbouncer_exporter pg_exporter haproxy pgbouncer patroni
</span></span></code></pre></div><hr><h2 id=common-troubleshooting>Common Troubleshooting</h2><p><strong>Service Startup Failure</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status &lt;service&gt;        <span style=color:#8f5902;font-style:italic># View service status</span>
</span></span><span style=display:flex><span>journalctl -u &lt;service&gt; -n <span style=color:#0000cf;font-weight:700>50</span>     <span style=color:#8f5902;font-style:italic># View recent logs</span>
</span></span><span style=display:flex><span>journalctl -u &lt;service&gt; --since <span style=color:#4e9a06>&#34;5 min ago&#34;</span>  <span style=color:#8f5902;font-style:italic># Last 5 minutes logs</span>
</span></span></code></pre></div><p><strong>Patroni Won&rsquo;t Start</strong></p><table><thead><tr><th style=text-align:left>Symptom</th><th style=text-align:left>Possible Cause</th><th style=text-align:left>Solution</th></tr></thead><tbody><tr><td style=text-align:left>Can&rsquo;t connect to etcd</td><td style=text-align:left>etcd cluster unavailable</td><td style=text-align:left>Check etcd service status</td></tr><tr><td style=text-align:left>Data dir permission error</td><td style=text-align:left>File ownership not postgres</td><td style=text-align:left><code>chown -R postgres:postgres /pg/data</code></td></tr><tr><td style=text-align:left>Port in use</td><td style=text-align:left>Leftover PostgreSQL process</td><td style=text-align:left><code>pg_ctl stop -D /pg/data</code> or <code>kill</code></td></tr></tbody></table><p><strong>Pgbouncer Won&rsquo;t Start</strong></p><table><thead><tr><th style=text-align:left>Symptom</th><th style=text-align:left>Possible Cause</th><th style=text-align:left>Solution</th></tr></thead><tbody><tr><td style=text-align:left>Config syntax error</td><td style=text-align:left>INI format error</td><td style=text-align:left>Check <code>/etc/pgbouncer/pgbouncer.ini</code></td></tr><tr><td style=text-align:left>Port in use</td><td style=text-align:left>Port 6432 already used</td><td style=text-align:left><code>lsof -i :6432</code></td></tr><tr><td style=text-align:left>userlist.txt permissions</td><td style=text-align:left>Incorrect file permissions</td><td style=text-align:left><code>chmod 600 /etc/pgbouncer/userlist.txt</code></td></tr></tbody></table><p><strong>HAProxy Won&rsquo;t Start</strong></p><table><thead><tr><th style=text-align:left>Symptom</th><th style=text-align:left>Possible Cause</th><th style=text-align:left>Solution</th></tr></thead><tbody><tr><td style=text-align:left>Config syntax error</td><td style=text-align:left>haproxy.cfg format error</td><td style=text-align:left><code>haproxy -c -f /etc/haproxy/haproxy.cfg</code></td></tr><tr><td style=text-align:left>Port in use</td><td style=text-align:left>Service port conflict</td><td style=text-align:left><code>lsof -i :5433</code></td></tr></tbody></table><hr><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni Management</strong></a>: Manage PostgreSQL HA with patronictl</li><li><a href=/docs/pgsql/admin/cluster/><strong>Cluster Management</strong></a>: Create, scale, destroy clusters</li><li><a href=/docs/pgsql/service/><strong>Service Configuration</strong></a>: HAProxy service definition and config</li><li><a href=/docs/pgsql/monitor/><strong>Monitoring System</strong></a>: PostgreSQL monitoring and alerting</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d6d9a4c3d54ca40e435a862870043f19>7 - Manage PostgreSQL Cron Jobs</h1><div class=lead>Configure crontab to schedule PostgreSQL backups, vacuum freeze, and bloat maintenance tasks</div><p>Pigsty uses crontab to manage scheduled tasks for routine backups, freezing aging transactions, and reorganizing bloated tables and indexes.</p><h2 id=quick-reference>Quick Reference</h2><table class=full-width><thead><tr><th style=text-align:left>Operation</th><th style=text-align:left>Quick Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#configure-cron-jobs><strong>Configure Cron Jobs</strong></a></td><td style=text-align:left><code>./pgsql.yml -t pg_crontab -l &lt;cls></code></td><td style=text-align:left>Apply pg_crontab config</td></tr><tr><td style=text-align:left><a href=#view-cron-jobs><strong>View Cron Jobs</strong></a></td><td style=text-align:left><code>crontab -l</code></td><td style=text-align:left>View as postgres user</td></tr><tr><td style=text-align:left><a href=#pg-backup><strong>Physical Backup</strong></a></td><td style=text-align:left><code>pg-backup [full|diff|incr]</code></td><td style=text-align:left>Execute backup with pgBackRest</td></tr><tr><td style=text-align:left><a href=#pg-vacuum><strong>Transaction Freeze</strong></a></td><td style=text-align:left><code>pg-vacuum [database...]</code></td><td style=text-align:left>Freeze aging transactions, prevent XID wraparound</td></tr><tr><td style=text-align:left><a href=#pg-repack><strong>Bloat Maintenance</strong></a></td><td style=text-align:left><code>pg-repack [database...]</code></td><td style=text-align:left>Online reorganize bloated tables and indexes</td></tr></tbody></table><p>For other management tasks, see: <a href=/docs/pgsql/backup/><strong>Backup Management</strong></a>, <a href=/docs/pgsql/monitor/><strong>Monitoring System</strong></a>, <a href=/docs/pgsql/admin/patroni><strong>HA Management</strong></a>.</p><hr><h2 id=configure-cron-jobs>Configure Cron Jobs</h2><p>Use the <a href=/docs/pgsql/param/#pg_crontab><strong><code>pg_crontab</code></strong></a> parameter to configure cron jobs for the PostgreSQL database superuser (<a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a>, default <code>postgres</code>).</p><p><strong>Example Configuration</strong></p><p>The following <code>pg-meta</code> cluster configures a daily full backup at 1:00 AM, while <code>pg-test</code> configures weekly full backup on Monday with incremental backups on other days.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Recommended Maintenance Schedule</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Daily full backup at 1:00 AM</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 03 * * 0 /pg/bin/pg-vacuum&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Weekly vacuum freeze on Sunday at 3:00 AM</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 04 * * 1 /pg/bin/pg-repack&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># Weekly repack on Monday at 4:00 AM</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:left>Task</th><th style=text-align:left>Frequency</th><th style=text-align:left>Timing</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>pg-backup</code></td><td style=text-align:left>Daily</td><td style=text-align:left>Early morning</td><td style=text-align:left>Full or incremental backup, depending on business needs</td></tr><tr><td style=text-align:left><code>pg-vacuum</code></td><td style=text-align:left>Weekly</td><td style=text-align:left>Sunday early morning</td><td style=text-align:left>Freeze aging transactions, prevent XID wraparound</td></tr><tr><td style=text-align:left><code>pg-repack</code></td><td style=text-align:left>Weekly/Monthly</td><td style=text-align:left>Off-peak hours</td><td style=text-align:left>Reorganize bloated tables/indexes, reclaim space</td></tr></tbody></table><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Primary Only Execution</div><p>The <code>pg-backup</code>, <code>pg-vacuum</code>, and <code>pg-repack</code> scripts automatically detect the current node role. Only the primary will actually execute; replicas will exit directly. Therefore, you can safely configure the same cron jobs on all nodes, and after failover, the new primary will automatically continue executing maintenance tasks.</p></div><hr><h2 id=apply-cron-jobs>Apply Cron Jobs</h2><p>Cron jobs are automatically written to the default location for the corresponding OS distribution when the <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> playbook executes (the <code>pg_crontab</code> task):</p><ul><li>EL (RHEL/Rocky/Alma): <code>/var/spool/cron/postgres</code></li><li>Debian/Ubuntu: <code>/var/spool/cron/crontabs/postgres</code></li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=playbook aria-controls=tabs-01-00 aria-selected=true>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=manual aria-controls=tabs-01-01 aria-selected=false>
Manual</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_crontab     <span style=color:#8f5902;font-style:italic># Apply pg_crontab config to specified cluster</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.10 -t pg_crontab <span style=color:#8f5902;font-style:italic># Target specific host only</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Edit cron jobs as postgres user</span>
</span></span><span style=display:flex><span>sudo -u postgres crontab -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Or edit crontab file directly</span>
</span></span><span style=display:flex><span>sudo vi /var/spool/cron/postgres           <span style=color:#8f5902;font-style:italic># EL series</span>
</span></span><span style=display:flex><span>sudo vi /var/spool/cron/crontabs/postgres  <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><p>Each playbook execution will <strong>fully overwrite</strong> the cron job configuration.</p><hr><h2 id=view-cron-jobs>View Cron Jobs</h2><p>Execute the following command as the <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> OS user to view cron jobs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pigsty Managed Crontab for postgres</span>
</span></span><span style=display:flex><span><span style=color:#000>SHELL</span><span style=color:#ce5c00;font-weight:700>=</span>/bin/bash
</span></span><span style=display:flex><span><span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span>/usr/pgsql/bin:/pg/bin:/usr/local/bin:/usr/bin:/usr/sbin:/bin:/sbin
</span></span><span style=display:flex><span><span style=color:#000>MAILTO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>01</span> * * * /pg/bin/pg-backup
</span></span></code></pre></div><p>If you&rsquo;re not familiar with crontab syntax, refer to <a href=https://crontab.guru/>Crontab Guru</a> for explanations.</p><hr><h2 id=pg-backup>pg-backup</h2><p><code>pg-backup</code> is Pigsty&rsquo;s physical backup script based on <a href=https://pgbackrest.org/><strong>pgBackRest</strong></a>, supporting full, differential, and incremental backup modes.</p><p><strong>Basic Usage</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup                <span style=color:#8f5902;font-style:italic># Execute incremental backup (default), auto full if no existing full backup</span>
</span></span><span style=display:flex><span>pg-backup full           <span style=color:#8f5902;font-style:italic># Execute full backup</span>
</span></span><span style=display:flex><span>pg-backup diff           <span style=color:#8f5902;font-style:italic># Execute differential backup (based on most recent full backup)</span>
</span></span><span style=display:flex><span>pg-backup incr           <span style=color:#8f5902;font-style:italic># Execute incremental backup (based on most recent any backup)</span>
</span></span></code></pre></div><p><strong>Backup Types</strong></p><table class=full-width><thead><tr><th style=text-align:left>Type</th><th style=text-align:left>Parameter</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>Full Backup</td><td style=text-align:left><code>full</code></td><td style=text-align:left>Complete backup of all data, only this backup needed for recovery</td></tr><tr><td style=text-align:left>Differential</td><td style=text-align:left><code>diff</code></td><td style=text-align:left>Backup changes since last full backup, recovery needs full + diff</td></tr><tr><td style=text-align:left>Incremental</td><td style=text-align:left><code>incr</code></td><td style=text-align:left>Backup changes since last any backup, recovery needs complete chain</td></tr></tbody></table><p><strong>Execution Requirements</strong></p><ul><li>Script must run on <strong>primary</strong> as <strong>postgres</strong> user</li><li>Script auto-detects current node role, exits (exit 1) when run on replica</li><li>Auto-retrieves stanza name from <code>/etc/pgbackrest/pgbackrest.conf</code></li></ul><p><strong>Common Cron Configurations</strong></p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="daily full" aria-controls=tabs-02-00 aria-selected=true>
Daily Full</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="weekly full + daily incr" aria-controls=tabs-02-01 aria-selected=false>
Weekly Full + Daily Incr</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist="weekly full + daily diff" aria-controls=tabs-02-02 aria-selected=false>
Weekly Full + Daily Diff</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Daily full backup at 1:00 AM</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Monday full backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># Other days incremental</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Monday full backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup diff&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Other days differential</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p>For more backup and recovery operations, see the <a href=/docs/pgsql/backup/><strong>Backup Management</strong></a> section.</p><hr><h2 id=pg-vacuum>pg-vacuum</h2><p><code>pg-vacuum</code> is Pigsty&rsquo;s transaction freeze script for executing <code>VACUUM FREEZE</code> operations to prevent database shutdown from transaction ID (XID) wraparound.</p><p><strong>Basic Usage</strong></p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist=basic aria-controls=tabs-03-00 aria-selected=true>
Basic</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist=options aria-controls=tabs-03-01 aria-selected=false>
Options</button></li><li class=nav-item><button class=nav-link id=tabs-03-02-tab data-bs-toggle=tab data-bs-target=#tabs-03-02 role=tab data-td-tp-persist="manual sql" aria-controls=tabs-03-02 aria-selected=false>
Manual SQL</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-vacuum                    <span style=color:#8f5902;font-style:italic># Freeze aging tables in all databases</span>
</span></span><span style=display:flex><span>pg-vacuum mydb               <span style=color:#8f5902;font-style:italic># Process specified database only</span>
</span></span><span style=display:flex><span>pg-vacuum mydb1 mydb2        <span style=color:#8f5902;font-style:italic># Process multiple databases</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-vacuum -n mydb            <span style=color:#8f5902;font-style:italic># Dry run mode, display only without executing</span>
</span></span><span style=display:flex><span>pg-vacuum -a <span style=color:#0000cf;font-weight:700>80000000</span> mydb   <span style=color:#8f5902;font-style:italic># Use custom age threshold (default 100M)</span>
</span></span><span style=display:flex><span>pg-vacuum -r <span style=color:#0000cf;font-weight:700>50</span> mydb         <span style=color:#8f5902;font-style:italic># Use custom aging ratio threshold (default 40%)</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-02 role=tabpanel aria-labelled-by=tabs-03-02-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Execute VACUUM FREEZE on entire database
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VACUUM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FREEZE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Execute VACUUM FREEZE on specific table
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VACUUM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FREEZE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p><strong>Command Options</strong></p><table class=full-width><thead><tr><th style=text-align:left>Option</th><th style=text-align:left>Description</th><th style=text-align:left>Default</th></tr></thead><tbody><tr><td style=text-align:left><code>-h, --help</code></td><td style=text-align:left>Show help message</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>-n, --dry-run</code></td><td style=text-align:left>Dry run mode, display only</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-a, --age</code></td><td style=text-align:left>Age threshold, tables exceeding need freeze</td><td style=text-align:left>100000000</td></tr><tr><td style=text-align:left><code>-r, --ratio</code></td><td style=text-align:left>Aging ratio threshold, full freeze if exceeded (%)</td><td style=text-align:left>40</td></tr></tbody></table><p><strong>Logic</strong></p><ol><li>Check database <code>datfrozenxid</code> age, skip database if below threshold</li><li>Calculate aging page ratio (percentage of table pages exceeding age threshold of total pages)</li><li>If aging ratio > 40%, execute full database <code>VACUUM FREEZE ANALYZE</code></li><li>Otherwise, only execute <code>VACUUM FREEZE ANALYZE</code> on tables exceeding age threshold</li></ol><p>Script sets <code>vacuum_cost_limit = 10000</code> and <code>vacuum_cost_delay = 1ms</code> to control I/O impact.</p><p><strong>Execution Requirements</strong></p><ul><li>Script must run on <strong>primary</strong> as <strong>postgres</strong> user</li><li>Uses file lock <code>/tmp/pg-vacuum.lock</code> to prevent concurrent execution</li><li>Auto-skips <code>template0</code>, <code>template1</code>, <code>postgres</code> system databases</li></ul><p><strong>Common Cron Configuration</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 03 * * 0 /pg/bin/pg-vacuum&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># Weekly Sunday at 3:00 AM</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=pg-repack>pg-repack</h2><p><code>pg-repack</code> is Pigsty&rsquo;s bloat maintenance script based on the <a href=https://reorg.github.io/pg_repack/><strong>pg_repack</strong></a> extension for online reorganization of bloated tables and indexes.</p><p><strong>Basic Usage</strong></p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=basic aria-controls=tabs-04-00 aria-selected=true>
Basic</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=options aria-controls=tabs-04-01 aria-selected=false>
Options</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=manual aria-controls=tabs-04-02 aria-selected=false>
Manual</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-repack                    <span style=color:#8f5902;font-style:italic># Reorganize bloated tables and indexes in all databases</span>
</span></span><span style=display:flex><span>pg-repack mydb               <span style=color:#8f5902;font-style:italic># Reorganize specified database only</span>
</span></span><span style=display:flex><span>pg-repack mydb1 mydb2        <span style=color:#8f5902;font-style:italic># Reorganize multiple databases</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-repack -n mydb            <span style=color:#8f5902;font-style:italic># Dry run mode, display only without executing</span>
</span></span><span style=display:flex><span>pg-repack -t mydb            <span style=color:#8f5902;font-style:italic># Reorganize tables only</span>
</span></span><span style=display:flex><span>pg-repack -i mydb            <span style=color:#8f5902;font-style:italic># Reorganize indexes only</span>
</span></span><span style=display:flex><span>pg-repack -T <span style=color:#0000cf;font-weight:700>30</span> -j <span style=color:#0000cf;font-weight:700>4</span> mydb    <span style=color:#8f5902;font-style:italic># Custom lock timeout (seconds) and parallelism</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use pg_repack command directly to reorganize specific table</span>
</span></span><span style=display:flex><span>pg_repack dbname -t schema.table
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Use pg_repack command directly to reorganize specific index</span>
</span></span><span style=display:flex><span>pg_repack dbname -i schema.index
</span></span></code></pre></div></div></div><p><strong>Command Options</strong></p><table class=full-width><thead><tr><th style=text-align:left>Option</th><th style=text-align:left>Description</th><th style=text-align:left>Default</th></tr></thead><tbody><tr><td style=text-align:left><code>-h, --help</code></td><td style=text-align:left>Show help message</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>-n, --dry-run</code></td><td style=text-align:left>Dry run mode, display only</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-t, --table</code></td><td style=text-align:left>Reorganize tables only</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-i, --index</code></td><td style=text-align:left>Reorganize indexes only</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-T, --timeout</code></td><td style=text-align:left>Lock wait timeout (seconds)</td><td style=text-align:left>10</td></tr><tr><td style=text-align:left><code>-j, --jobs</code></td><td style=text-align:left>Parallel jobs</td><td style=text-align:left>2</td></tr></tbody></table><p><strong>Auto-Selection Thresholds</strong></p><p>Script auto-selects objects to reorganize based on table/index size and bloat ratio:</p><p><strong>Table Bloat Thresholds</strong></p><table class=full-width><thead><tr><th style=text-align:left>Size Range</th><th style=text-align:center>Bloat Threshold</th><th style=text-align:center>Max Count</th></tr></thead><tbody><tr><td style=text-align:left>&lt; 256MB</td><td style=text-align:center>> 40%</td><td style=text-align:center>64</td></tr><tr><td style=text-align:left>256MB - 2GB</td><td style=text-align:center>> 30%</td><td style=text-align:center>16</td></tr><tr><td style=text-align:left>2GB - 8GB</td><td style=text-align:center>> 20%</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>8GB - 64GB</td><td style=text-align:center>> 15%</td><td style=text-align:center>1</td></tr></tbody></table><p><strong>Index Bloat Thresholds</strong></p><table class=full-width><thead><tr><th style=text-align:left>Size Range</th><th style=text-align:center>Bloat Threshold</th><th style=text-align:center>Max Count</th></tr></thead><tbody><tr><td style=text-align:left>&lt; 128MB</td><td style=text-align:center>> 40%</td><td style=text-align:center>64</td></tr><tr><td style=text-align:left>128MB - 1GB</td><td style=text-align:center>> 35%</td><td style=text-align:center>16</td></tr><tr><td style=text-align:left>1GB - 8GB</td><td style=text-align:center>> 30%</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>8GB - 64GB</td><td style=text-align:center>> 20%</td><td style=text-align:center>1</td></tr></tbody></table><p>Tables/indexes over 64GB are skipped with a warning and require manual handling.</p><p><strong>Execution Requirements</strong></p><ul><li>Script must run on <strong>primary</strong> as <strong>postgres</strong> user</li><li>Requires <code>pg_repack</code> extension installed (installed by default in Pigsty)</li><li>Requires <code>pg_table_bloat</code> and <code>pg_index_bloat</code> views in <code>monitor</code> schema</li><li>Uses file lock <code>/tmp/pg-repack.lock</code> to prevent concurrent execution</li><li>Auto-skips <code>template0</code>, <code>template1</code>, <code>postgres</code> system databases</li></ul><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>Lock Waiting</div><p>Normal reads/writes are not affected during reorganization, but the <strong>final switch moment</strong> requires acquiring AccessExclusive lock on the table, blocking all access. For high-throughput workloads, recommend running during off-peak hours or maintenance windows.</p></div><p><strong>Common Cron Configuration</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 04 * * 1 /pg/bin/pg-repack&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># Weekly Monday at 4:00 AM</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can confirm database bloat through Pigsty&rsquo;s <a href=https://demo.pigsty.io/d/pgcat-database><strong>PGCAT Database - Table Bloat</strong></a> panel and select high-bloat tables and indexes for reorganization.</p><p>For more details see: <a href=https://vonng.com/pg/bloat/><strong>Managing Relation Bloat</strong></a></p><hr><h2 id=remove-cron-jobs>Remove Cron Jobs</h2><p>When using the <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> playbook to remove a PostgreSQL cluster, it automatically deletes the postgres user&rsquo;s crontab file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt; -t pg_crontab    <span style=color:#8f5902;font-style:italic># Remove cron jobs only</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># Remove entire cluster (including cron jobs)</span>
</span></span></code></pre></div><hr><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=/docs/pgsql/backup/><strong>Backup Management</strong></a>: PostgreSQL backup and recovery</li><li><a href=/docs/pgsql/monitor/><strong>Monitoring System</strong></a>: PostgreSQL monitoring and alerting</li><li><a href=/docs/pgsql/admin/cluster/><strong>Cluster Management</strong></a>: Cluster creation, scaling, and teardown</li><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni Management</strong></a>: HA cluster management</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2b2e08d4aed2707846688f2a5517519d>8 - Managing PostgreSQL Extensions</h1><div class=lead>Extension management - download, install, configure, enable, update, and remove extensions</div><h2 id=quick-start>Quick Start</h2><p>Pigsty provides <a href=https://pgext.cloud/list><strong>440+ extensions</strong></a>. Using extensions involves four steps: <strong>Download</strong>, <strong>Install</strong>, <strong>Configure</strong>, <strong>Enable</strong>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Install extension packages</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- Configure preload extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, vector ]           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- Enable in database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=script aria-controls=tabs-00-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-00-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=example aria-controls=tabs-00-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># Install extensions defined in config on &lt;cls&gt; cluster</span>
</span></span><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ext...<span style=color:#ce5c00;font-weight:700>]</span>  <span style=color:#8f5902;font-style:italic># Install extensions specified on command line</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_ext    <span style=color:#8f5902;font-style:italic># Use playbook to install extensions</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta                         <span style=color:#8f5902;font-style:italic># Install defined extensions on pg-meta cluster</span>
</span></span><span style=display:flex><span>bin/pgsql-ext pg-meta pg_duckdb pg_mooncake   <span style=color:#8f5902;font-style:italic># Install specified extensions</span>
</span></span></code></pre></div></div></div><p>For complete extension reference, see <a href=/docs/pgsql/ext/><strong>Extensions</strong></a>. For available extensions, see <a href=https://pgext.cloud/list><strong>Extension Catalog</strong></a>.</p><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Command</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><a href=#download-extensions><strong>Download Extensions</strong></a></td><td style=text-align:left><code>./infra.yml -t repo_build</code></td><td style=text-align:left>Download extensions to local repo</td></tr><tr><td style=text-align:left><a href=#install-extensions><strong>Install Extensions</strong></a></td><td style=text-align:left><code>bin/pgsql-ext &lt;cls></code></td><td style=text-align:left>Install extension packages on cluster</td></tr><tr><td style=text-align:left><a href=#configure-extensions><strong>Configure Extensions</strong></a></td><td style=text-align:left><code>pg edit-config &lt;cls> -p</code></td><td style=text-align:left>Add to preload libs (requires restart)</td></tr><tr><td style=text-align:left><a href=#enable-extensions><strong>Enable Extensions</strong></a></td><td style=text-align:left><code>psql -c 'CREATE EXT ...'</code></td><td style=text-align:left>Create extension objects in database</td></tr><tr><td style=text-align:left><a href=#update-extensions><strong>Update Extensions</strong></a></td><td style=text-align:left><code>ALTER EXTENSION UPDATE</code></td><td style=text-align:left>Update packages and extension objects</td></tr><tr><td style=text-align:left><a href=#remove-extensions><strong>Remove Extensions</strong></a></td><td style=text-align:left><code>DROP EXTENSION</code></td><td style=text-align:left>Drop extension objects, uninstall pkgs</td></tr></tbody></table><div id=asciinema-ec8f712cd845ce138b45a5d9d91243a9 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ec8f712cd845ce138b45a5d9d91243a9",o="/demo/pgsql-ext.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=install-extensions>Install Extensions</h2><p>Extensions defined in <a href=/docs/pgsql/param#pg_extensions><strong><code>pg_extensions</code></strong></a> are auto-installed during PostgreSQL <a href=/docs/pgsql/admin/cluster#create-cluster><strong>cluster creation</strong></a> in the <code>pg_extension</code> task.</p><p>To install extensions on an existing cluster, add extensions to <code>all.children.&lt;cls>.pg_extensions</code>, then execute:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=script aria-controls=tabs-02-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-02-01 aria-selected=false>
Playbook</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=example aria-controls=tabs-02-02 aria-selected=false>
Example</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt;   <span style=color:#8f5902;font-style:italic># Install extensions on &lt;cls&gt; cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_extension   <span style=color:#8f5902;font-style:italic># Use Ansible playbook</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta    <span style=color:#8f5902;font-style:italic># Install extensions defined in config on pg-meta</span>
</span></span></code></pre></div></div></div><p><strong>Example: Install PostGIS, TimescaleDB and PGVector on cluster</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Result</strong>: Installs extension packages on all cluster nodes. Pigsty auto-translates <a href=/docs/pgsql/config/alias><strong>package aliases</strong></a> to actual package names for OS and PG version.</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>Ensure repos available before install</div><p>Before installing, ensure nodes have correct repos configured - extensions <a href=#download-extensions><strong>downloaded</strong></a> to local repo, or <a href=#configure-repos><strong>upstream repos configured</strong></a>.</p></div><hr><h2 id=manual-install>Manual Install</h2><p>If you don&rsquo;t want to use Pigsty config to manage extensions, pass extension list directly on command line:</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=script aria-controls=tabs-04-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-04-01 aria-selected=false>
Playbook</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta pg_duckdb pg_mooncake   <span style=color:#8f5902;font-style:italic># Install specified extensions on pg-meta</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_ext -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;: [&#34;pg_duckdb&#34;, &#34;pg_mooncake&#34;]}&#39;</span>
</span></span></code></pre></div></div></div><p>You can also use <a href=/docs/pig><strong>pig</strong></a> package manager CLI to install extensions on single node, with auto <a href=/docs/pgsql/config/alias><strong>package alias</strong></a> resolution.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig install postgis timescaledb       <span style=color:#8f5902;font-style:italic># Install multiple extensions</span>
</span></span><span style=display:flex><span>pig install pgvector -v <span style=color:#0000cf;font-weight:700>17</span>            <span style=color:#8f5902;font-style:italic># Install for specific PG major version</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ansible pg-test -b -a <span style=color:#4e9a06>&#39;pig install pg_duckdb&#39;</span>   <span style=color:#8f5902;font-style:italic># Batch install on cluster with Ansible</span>
</span></span></code></pre></div><p>You can also <strong>use OS package manager directly</strong> (<code>apt/dnf</code>), but you must know the exact RPM/DEB package name for your OS/PG:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL systems (RHEL, Rocky, Alma, Oracle Linux)</span>
</span></span><span style=display:flex><span>sudo yum install -y pgvector_17*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian / Ubuntu</span>
</span></span><span style=display:flex><span>sudo apt install -y postgresql-17-pgvector
</span></span></code></pre></div><hr><h2 id=download-extensions>Download Extensions</h2><p>To install extensions, ensure node&rsquo;s <a href=/docs/repo/pgsql><strong>extension repos</strong></a> contain the extension:</p><ul><li><a href=/docs/setup/install><strong>Standalone install</strong></a>: No worries, upstream repos already added to node.</li><li><a href=/docs/setup/offline><strong>Offline install</strong></a>: No worries, most extensions included in offline package, few require online install.</li><li><a href=/docs/deploy/install><strong>Production multi-node deployment</strong></a> with local repo: depends - if extension was in <a href=/docs/infra/param/#repo_packages><code>repo_packages</code></a> / <a href=/docs/infra/param/#repo_extra_packages><code>repo_extra_packages</code></a> when creating local repo, it&rsquo;s already downloaded. Otherwise download first or <a href=#configure-repos><strong>configure upstream repos</strong></a> for online install.</li></ul><p>Pigsty&rsquo;s default config auto-downloads mainstream extensions during installation. For additional extensions, add to <a href=/docs/infra/param#repo_extra_packages><strong><code>repo_extra_packages</code></strong></a> and rebuild repo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>repo_extra_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, postgis, timescaledb ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=script aria-controls=tabs-05-00 aria-selected=true>
Script</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=playbook aria-controls=tabs-05-01 aria-selected=false>
Playbook</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make repo         <span style=color:#8f5902;font-style:italic># Shortcut = repo-build + node-repo</span>
</span></span><span style=display:flex><span>make repo-build   <span style=color:#8f5902;font-style:italic># Rebuild Infra repo (download packages and deps)</span>
</span></span><span style=display:flex><span>make node-repo    <span style=color:#8f5902;font-style:italic># Refresh node repo cache, update Infra repo reference</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy.yml -t repo_build,node_repo  <span style=color:#8f5902;font-style:italic># Execute both tasks at once</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build     <span style=color:#8f5902;font-style:italic># Re-download packages to local repo</span>
</span></span><span style=display:flex><span>./node.yml  -t node_repo      <span style=color:#8f5902;font-style:italic># Refresh node repo cache</span>
</span></span></code></pre></div></div></div><hr><h2 id=configure-repos>Configure Repos</h2><p>You can also let all nodes use upstream repos directly (not recommended for production), skipping download and installing from <a href=/docs/repo/pgsql><strong>upstream extension repos</strong></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql   <span style=color:#8f5902;font-style:italic># Add PGDG and Pigsty upstream repos</span>
</span></span></code></pre></div><hr><h2 id=configure-extensions>Configure Extensions</h2><p>Some extensions require preloading to <a href=https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-SHARED-PRELOAD-LIBRARIES><strong><code>shared_preload_libraries</code></strong></a>, requiring <strong>database restart</strong> after modification.</p><p>Use <a href=/docs/pgsql/param#pg_libs><strong><code>pg_libs</code></strong></a> as its default value to configure preload extensions, but this only takes effect during cluster init - later modifications are ineffective.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># Preload extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb, postgis, pgvector ]         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Install packages</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For existing clusters, refer to <a href=/docs/pgsql/admin/patroni#edit-config><strong>Modify Config</strong></a> to modify <code>shared_preload_libraries</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>pg restart pg-meta   <span style=color:#8f5902;font-style:italic># Modify pg-meta params and restart to apply</span>
</span></span></code></pre></div><p>Ensure extension packages are correctly installed before adding preload config. If extension in <code>shared_preload_libraries</code> doesn&rsquo;t exist or fails to load, PostgreSQL <strong>won&rsquo;t start</strong>.
Also, manage cluster config changes through Patroni - avoid using <code>ALTER SYSTEM</code> or <a href=/docs/pgsql/param#pg_parameters><strong><code>pg_parameters</code></strong></a> to modify instance config separately.
If primary and replica configs differ, it may cause startup failure or replication interruption.</p><hr><h2 id=enable-extensions>Enable Extensions</h2><p>After installing packages, execute <code>CREATE EXTENSION</code> in database to use extension features.</p><p><strong>Enable during cluster init</strong></p><p>Declare extensions to enable in <a href=/docs/pgsql/config/db><strong>database definition</strong></a> via <code>extensions</code> array:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>vector                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Simple form</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Specify schema</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Manual enable</strong></p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist=sql aria-controls=tabs-06-00 aria-selected=true>
SQL</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist=psql aria-controls=tabs-06-01 aria-selected=false>
psql</button></li><li class=nav-item><button class=nav-link id=tabs-06-02-tab data-bs-toggle=tab data-bs-target=#tabs-06-02 role=tab data-td-tp-persist=playbook aria-controls=tabs-06-02 aria-selected=false>
Playbook</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic>-- Create extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- Specify schema
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- Idempotent creation
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- Auto-install dependencies
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION vector;&#39;</span>                  <span style=color:#8f5902;font-style:italic># Create extension in meta database</span>
</span></span><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION postgis SCHEMA public;&#39;</span>   <span style=color:#8f5902;font-style:italic># Specify schema</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-02 role=tabpanel aria-labelled-by=tabs-06-02-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># After modifying database definition, use playbook to enable extensions</span>
</span></span><span style=display:flex><span>bin/pgsql-db pg-meta meta    <span style=color:#8f5902;font-style:italic># Creating/modifying database auto-enables defined extensions</span>
</span></span></code></pre></div></div></div><p><strong>Result</strong>: Creates extension objects (functions, types, operators, index methods, etc.) in database, enabling use of extension features.</p><hr><h2 id=update-extensions>Update Extensions</h2><p>Extension updates involve two layers: <strong>package update</strong> and <strong>extension object update</strong>.</p><p><strong>Update packages</strong></p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist=pig aria-controls=tabs-07-00 aria-selected=true>
pig</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist=yum aria-controls=tabs-07-01 aria-selected=false>
yum</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab data-td-tp-persist=apt aria-controls=tabs-07-02 aria-selected=false>
apt</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig update pgvector                           <span style=color:#8f5902;font-style:italic># Update extension with pig</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum update pgvector_18 <span style=color:#8f5902;font-style:italic># EL</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt upgrade postgresql-18-pgvector  <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><p><strong>Update extension objects</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View upgradeable extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Update extension to latest version
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Update to specific version
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.8.1&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>Update Notes</div><p>Backup database before updating extensions. Preloaded extensions may require PostgreSQL restart after update. Some extension version upgrades may be incompatible - check extension docs.</p></div><hr><h2 id=remove-extensions>Remove Extensions</h2><p>Removing extensions involves two layers: <strong>drop extension objects</strong> and <strong>uninstall packages</strong>.</p><p><strong>Drop extension objects</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- Drop extension
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- Cascade drop (drops dependent objects)
</span></span></span></code></pre></div><p><strong>Remove from preload</strong></p><p>For preloaded extensions, remove from <code>shared_preload_libraries</code> and restart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>pg restart pg-meta   <span style=color:#8f5902;font-style:italic># Restart to apply config</span>
</span></span></code></pre></div><p><strong>Uninstall packages (optional)</strong></p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist=pig aria-controls=tabs-09-00 aria-selected=true>
pig</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist=yum aria-controls=tabs-09-01 aria-selected=false>
yum</button></li><li class=nav-item><button class=nav-link id=tabs-09-02-tab data-bs-toggle=tab data-bs-target=#tabs-09-02 role=tab data-td-tp-persist=apt aria-controls=tabs-09-02 aria-selected=false>
apt</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig remove pgvector                           <span style=color:#8f5902;font-style:italic># Uninstall with pig</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum remove pgvector_17*                  <span style=color:#8f5902;font-style:italic># EL systems</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-02 role=tabpanel aria-labelled-by=tabs-09-02-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt remove postgresql-17-pgvector        <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>CASCADE Warning</div><p>Using <code>CASCADE</code> to drop extensions also drops all objects depending on that extension (tables, indexes, views, etc.). Check dependencies before executing.</p></div><hr><h2 id=query-extensions>Query Extensions</h2><p>Common SQL queries for extension info:</p><p><strong>View enabled extensions</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#f8f8f8> </span><span style=color:#000>n</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extnamespace</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>n</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View available extensions</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- Only show installed
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Check if extension is available</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View extension dependencies</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>refobjid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>depends_on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>objid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>deptype</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;e&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgis_topology&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>View extension objects</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>classid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>objid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>deptype</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>refobjid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>psql shortcuts</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#4e9a06>\d</span>x                    <span style=color:#8f5902;font-style:italic># List enabled extensions</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>\d</span>x+ vector            <span style=color:#8f5902;font-style:italic># Show extension details</span>
</span></span></code></pre></div><hr><h2 id=add-repos>Add Repos</h2><p>To install directly from upstream, manually add repos.</p><p><strong>Using Pigsty playbook</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql        <span style=color:#8f5902;font-style:italic># Add PGDG and Pigsty repos</span>
</span></span><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql,local  <span style=color:#8f5902;font-style:italic># Including local repo</span>
</span></span></code></pre></div><p><strong>YUM repos (EL systems)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pigsty repo</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># China mainland mirror</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span></code></pre></div><p><strong>APT repos (Debian/Ubuntu)</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/pigsty.gpg
</span></span><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/pgsql $(lsb_release -cs) main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># China mainland mirror: replace repo.pigsty.io with repo.pigsty.cc</span>
</span></span></code></pre></div><hr><h2 id=faq>FAQ</h2><p><strong>Difference between extension name and package name</strong></p><table class=full-width><thead><tr><th style=text-align:left>Name</th><th style=text-align:left>Description</th><th style=text-align:left>Example</th></tr></thead><tbody><tr><td style=text-align:left>Extension name</td><td style=text-align:left>Name used with <code>CREATE EXTENSION</code></td><td style=text-align:left><code>vector</code></td></tr><tr><td style=text-align:left>Package alias</td><td style=text-align:left>Standardized name in Pigsty config</td><td style=text-align:left><code>pgvector</code></td></tr><tr><td style=text-align:left>Package name</td><td style=text-align:left>Actual OS package name</td><td style=text-align:left><code>pgvector_17*</code> or <code>postgresql-17-pgvector</code></td></tr></tbody></table><p><strong>Preloaded extension prevents startup</strong></p><p>If extension in <code>shared_preload_libraries</code> doesn&rsquo;t exist or fails to load, PostgreSQL won&rsquo;t start. Solutions:</p><ol><li>Ensure extension package is correctly installed</li><li>Or remove extension from <code>shared_preload_libraries</code> (edit <code>/pg/data/postgresql.conf</code>)</li></ol><p><strong>Extension dependencies</strong></p><p>Some extensions depend on others, requiring sequential creation or using <code>CASCADE</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic>-- Create base extension first
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- Then create dependent extension
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Or
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- Auto-create dependencies
</span></span></span></code></pre></div><p><strong>Extension version incompatibility</strong></p><p>View extension versions supported by current PostgreSQL:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extension_versions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=related-resources>Related Resources</h2><ul><li><a href=/docs/pgsql/ext/><strong>Extensions</strong></a>: Detailed extension management documentation</li><li><a href=https://pgext.cloud/list><strong>Extension Catalog</strong></a>: Browse 440+ available extensions</li><li><a href=https://pgext.cloud/pig><strong>pig Package Manager</strong></a>: Extension installation CLI tool</li><li><a href=/docs/pgsql/admin/db/><strong>Database Management</strong></a>: Enable extensions in databases</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fda28727166c3a3a755b7258c9071594>9 - Upgrading PostgreSQL Major/Minor Versions</h1><div class=lead>Version upgrade - minor version rolling upgrade, major version migration, extension upgrade</div><h2 id=quick-start>Quick Start</h2><p>PostgreSQL version upgrades fall into two types: <strong>minor version upgrade</strong> and <strong>major version upgrade</strong>, with very different risk and complexity.</p><table class=full-width><thead><tr><th style=text-align:left>Type</th><th style=text-align:left>Example</th><th style=text-align:left>Downtime</th><th style=text-align:left>Data Compatibility</th><th style=text-align:left>Risk</th></tr></thead><tbody><tr><td style=text-align:left>Minor upgrade</td><td style=text-align:left>17.2 → 17.3</td><td style=text-align:left>Seconds (rolling)</td><td style=text-align:left>Fully compatible</td><td style=text-align:left>Low</td></tr><tr><td style=text-align:left>Major upgrade</td><td style=text-align:left>17 → 18</td><td style=text-align:left>Minutes</td><td style=text-align:left>Requires data dir upgrade</td><td style=text-align:left>Medium</td></tr></tbody></table><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=minor aria-controls=tabs-00-00 aria-selected=true>
Minor</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=major aria-controls=tabs-00-01 aria-selected=false>
Major</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=extension aria-controls=tabs-00-02 aria-selected=false>
Extension</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Rolling upgrade: replicas first, then primary</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span><span style=display:flex><span>pg restart --role replica --force &lt;cls&gt;
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt;
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; &lt;old-primary&gt; --force
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recommended: Logical replication migration</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-new              <span style=color:#8f5902;font-style:italic># Create new version cluster</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure logical replication to sync data...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Switch traffic to new cluster</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgis36_17*&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER EXTENSION postgis UPDATE;&#39;</span>
</span></span></code></pre></div></div></div><p>For detailed online migration process, see <a href=/docs/pgsql/migration><strong>Online Migration</strong></a> documentation.</p><table class=full-width><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Description</th><th style=text-align:left>Risk</th></tr></thead><tbody><tr><td style=text-align:left><a href=#minor-version-upgrade><strong>Minor Version Upgrade</strong></a></td><td style=text-align:left>Update packages, rolling restart</td><td style=text-align:left>Low</td></tr><tr><td style=text-align:left><a href=#minor-version-downgrade><strong>Minor Version Downgrade</strong></a></td><td style=text-align:left>Rollback to previous minor version</td><td style=text-align:left>Low</td></tr><tr><td style=text-align:left><a href=#major-version-upgrade><strong>Major Version Upgrade</strong></a></td><td style=text-align:left>Logical replication or pg_upgrade</td><td style=text-align:left>Medium</td></tr><tr><td style=text-align:left><a href=#extension-upgrade><strong>Extension Upgrade</strong></a></td><td style=text-align:left>Upgrade extension packages and objects</td><td style=text-align:left>Low</td></tr></tbody></table><hr><h2 id=minor-version-upgrade>Minor Version Upgrade</h2><p>Minor version upgrades (e.g., 17.2 → 17.3) are the most common upgrade scenario, typically for security patches and bug fixes. Data directory is fully compatible, completed via rolling restart.</p><p><strong>Strategy</strong>: Recommended <strong>rolling upgrade</strong>: upgrade replicas first, then switchover to upgrade original primary - minimizes service interruption.</p><pre tabindex=0><code>1. Update repo → 2. Upgrade replica packages → 3. Restart replicas
4. Switchover → 5. Upgrade original primary packages → 6. Restart original primary
</code></pre><p><strong>Step 1: Prepare packages</strong></p><p>Ensure local repo has latest PostgreSQL packages and refresh node cache:</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=repo aria-controls=tabs-01-00 aria-selected=true>
Repo</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=el aria-controls=tabs-01-01 aria-selected=false>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=debian aria-controls=tabs-01-02 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty
</span></span><span style=display:flex><span>./infra.yml -t repo_upstream      <span style=color:#8f5902;font-style:italic># Add upstream repos (needs internet)</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build         <span style=color:#8f5902;font-style:italic># Rebuild local repo</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum clean all&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum makecache&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt clean&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt update&#39;</span>
</span></span></code></pre></div></div></div><p><strong>Step 2: Upgrade replicas</strong></p><p>Upgrade packages on all replicas and verify version:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=el aria-controls=tabs-02-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=debian aria-controls=tabs-02-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;/usr/pgsql/bin/pg_ctl --version&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;/usr/lib/postgresql/17/bin/pg_ctl --version&#39;</span>
</span></span></code></pre></div></div></div><p>Restart all replicas to apply new version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart --role replica --force &lt;cls&gt;
</span></span></code></pre></div><p><strong>Step 3: Switchover</strong></p><p>Execute switchover to transfer primary role to upgraded replica:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg switchover &lt;cls&gt;
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Or non-interactive:</span>
</span></span><span style=display:flex><span>pg switchover --leader &lt;old-primary&gt; --candidate &lt;new-primary&gt; --scheduled<span style=color:#ce5c00;font-weight:700>=</span>now --force &lt;cls&gt;
</span></span></code></pre></div><p><strong>Step 4: Upgrade original primary</strong></p><p>Original primary is now replica - upgrade packages and restart:</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist=el aria-controls=tabs-03-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist=debian aria-controls=tabs-03-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;old-primary-ip&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;old-primary-ip&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17&#39;</span>
</span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart &lt;cls&gt; &lt;old-primary-name&gt; --force
</span></span></code></pre></div><p><strong>Step 5: Verify</strong></p><p>Confirm all instances have consistent version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list &lt;cls&gt;
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;SELECT version()&#34;</span>
</span></span></code></pre></div><hr><h2 id=minor-version-downgrade>Minor Version Downgrade</h2><p>In rare cases (e.g., new version introduces bugs), may need to downgrade PostgreSQL to previous version.</p><p><strong>Step 1: Get old version packages</strong></p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=el aria-controls=tabs-04-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="refresh cache" aria-controls=tabs-04-01 aria-selected=false>
Refresh Cache</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span> ./infra.yml -t repo_upstream     <span style=color:#8f5902;font-style:italic># Add upstream repos</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> /www/pigsty<span style=color:#000;font-weight:700>;</span> repotrack postgresql17-*-17.1 <span style=color:#8f5902;font-style:italic># Download specific version packages</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span> ./infra.yml -t repo_create       <span style=color:#8f5902;font-style:italic># Rebuild repo metadata</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum clean all&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum makecache&#39;</span>
</span></span></code></pre></div></div></div><p><strong>Step 2: Execute downgrade</strong></p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=el aria-controls=tabs-05-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=debian aria-controls=tabs-05-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum downgrade -y postgresql17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17=17.1*&#39;</span>
</span></span></code></pre></div></div></div><p><strong>Step 3: Restart cluster</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart --force &lt;cls&gt;
</span></span></code></pre></div><hr><h2 id=major-version-upgrade>Major Version Upgrade</h2><p>Major version upgrades (e.g., 17 → 18) involve data format changes, requiring specialized tools for data migration.</p><table class=full-width><thead><tr><th style=text-align:left>Method</th><th style=text-align:left>Downtime</th><th style=text-align:left>Complexity</th><th style=text-align:left>Use Case</th></tr></thead><tbody><tr><td style=text-align:left><a href=#logical-replication-migration><strong>Logical Replication Migration</strong></a></td><td style=text-align:left>Seconds (switch)</td><td style=text-align:left>High</td><td style=text-align:left>Production, minimal downtime required</td></tr><tr><td style=text-align:left><a href=#pg_upgrade-in-place-upgrade><strong>pg_upgrade In-Place Upgrade</strong></a></td><td style=text-align:left>Minutes~Hours</td><td style=text-align:left>Medium</td><td style=text-align:left>Test env, smaller data</td></tr></tbody></table><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>Recommended Approach</div><p>For production, we recommend <strong>logical replication migration</strong>: create new version cluster, sync data via logical replication, then blue-green switch. Shortest downtime and rollback-ready. See <a href=/docs/pgsql/migration><strong>Online Migration</strong></a>.</p></div><h3 id=logical-replication-migration>Logical Replication Migration</h3><p>Logical replication is the recommended approach for production major version upgrades. Core steps:</p><pre tabindex=0><code>1. Create new version target cluster → 2. Configure logical replication → 3. Verify data consistency
4. Switch app traffic to new cluster → 5. Decommission old cluster
</code></pre><p><strong>Step 1: Create new version cluster</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta-new</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-new</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># New version</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-meta-new
</span></span></code></pre></div><p><strong>Step 2: Configure logical replication</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Source cluster (old version) primary: create publication
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>PUBLICATION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_pub</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#000>TABLES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Target cluster (new version) primary: create subscription
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>SUBSCRIPTION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_sub</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;host=10.10.10.11 port=5432 dbname=mydb user=replicator password=xxx&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#000>PUBLICATION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_pub</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Step 3: Wait for sync completion</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Target cluster: check subscription status
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_subscription</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Source cluster: check replication slot LSN
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>slot_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>confirmed_flush_lsn</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_replication_slots</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Step 4: Switch traffic</strong></p><p>After confirming data sync complete: stop app writes to source → wait for final sync → switch app connections to new cluster → drop subscription, decommission source.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Target cluster: drop subscription
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>SUBSCRIPTION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_sub</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For detailed migration process, see <a href=/docs/pgsql/migration><strong>Online Migration</strong></a> documentation.</p><h3 id=pg_upgrade-in-place-upgrade>pg_upgrade In-Place Upgrade</h3><p><code>pg_upgrade</code> is PostgreSQL&rsquo;s official major version upgrade tool, suitable for test environments or scenarios accepting longer downtime.</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Important Warning</div><p>In-place upgrade causes longer downtime and is difficult to rollback. For production, prefer logical replication migration.</p></div><p><strong>Step 1: Install new version packages</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_pkg -e <span style=color:#000>pg_version</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>18</span>
</span></span></code></pre></div><p><strong>Step 2: Stop Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg pause &lt;cls&gt;                        <span style=color:#8f5902;font-style:italic># Pause auto-failover</span>
</span></span><span style=display:flex><span>systemctl stop patroni                <span style=color:#8f5902;font-style:italic># Stop Patroni (stops PostgreSQL)</span>
</span></span></code></pre></div><p><strong>Step 3: Run pg_upgrade</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres
</span></span><span style=display:flex><span>mkdir -p /data/postgres/pg-meta-18/data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pre-check (-c parameter: check only, don&#39;t execute)</span>
</span></span><span style=display:flex><span>/usr/pgsql-18/bin/pg_upgrade <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -b /usr/pgsql-17/bin -B /usr/pgsql-18/bin <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -d /data/postgres/pg-meta-17/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -D /data/postgres/pg-meta-18/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -v -c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Execute upgrade</span>
</span></span><span style=display:flex><span>/usr/pgsql-18/bin/pg_upgrade <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -b /usr/pgsql-17/bin -B /usr/pgsql-18/bin <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -d /data/postgres/pg-meta-17/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -D /data/postgres/pg-meta-18/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --link -j <span style=color:#0000cf;font-weight:700>8</span> -v
</span></span></code></pre></div><p><strong>Step 4: Update links and start</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf /usr/pgsql <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ln -s /usr/pgsql-18 /usr/pgsql
</span></span><span style=display:flex><span>rm -rf /pg <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ln -s /data/postgres/pg-meta-18 /pg
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Edit /etc/patroni/patroni.yml to update paths</span>
</span></span><span style=display:flex><span>systemctl start patroni
</span></span><span style=display:flex><span>pg resume &lt;cls&gt;
</span></span></code></pre></div><p><strong>Step 5: Post-processing</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/pgsql-18/bin/vacuumdb --all --analyze-in-stages
</span></span><span style=display:flex><span>./delete_old_cluster.sh   <span style=color:#8f5902;font-style:italic># Cleanup script generated by pg_upgrade</span>
</span></span></code></pre></div><hr><h2 id=extension-upgrade>Extension Upgrade</h2><p>When upgrading PostgreSQL version, typically also need to upgrade related extensions.</p><p><strong>Upgrade extension packages</strong></p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=el aria-controls=tabs-08-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=debian aria-controls=tabs-08-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgis36_17 timescaledb-2-postgresql-17* pgvector_17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17-postgis-3 postgresql-17-pgvector&#39;</span>
</span></span></code></pre></div></div></div><p><strong>Upgrade extension objects</strong></p><p>After package upgrade, execute extension upgrade in database:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- View upgradeable extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Upgrade extensions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Check extension versions
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Extension Compatibility</div><p>Before major version upgrade, confirm all extensions support target PostgreSQL version. Some extensions may require uninstall/reinstall - check extension documentation.</p></div><hr><h2 id=important-notes>Important Notes</h2><ol><li><strong>Backup first</strong>: Always perform complete backup before any upgrade</li><li><strong>Test verify</strong>: Verify upgrade process in test environment first</li><li><strong>Extension compatibility</strong>: Confirm all extensions support target version</li><li><strong>Rollback plan</strong>: Prepare rollback plan, especially for major upgrades</li><li><strong>Monitor closely</strong>: Monitor database performance and error logs after upgrade</li><li><strong>Document</strong>: Record all operations and issues during upgrade</li></ol><hr><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=/docs/pgsql/migration/><strong>Online Migration</strong></a>: Zero-downtime migration using logical replication</li><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni Management</strong></a>: Manage cluster with patronictl</li><li><a href=/docs/pgsql/admin/cluster/><strong>Cluster Management</strong></a>: Cluster creation, scaling, destruction</li><li><a href=/docs/pgsql/backup/><strong>Backup Recovery</strong></a>: PostgreSQL backup and recovery</li><li><a href=/docs/pgsql/admin/ext/><strong>Extension Management</strong></a>: Extension installation and management</li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Email - Vonng" aria-label="Email - Vonng"><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label="Email - Vonng"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=WeChat aria-label=WeChat><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=WeChat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Discussion aria-label=Discussion><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=Discussion><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Repo aria-label=Repo><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=Repo><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>