<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.io/docs/pgsql/backup/><link rel=alternate type=application/rss+xml href=https://pigsty.io/docs/pgsql/backup/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Backup & Restore | PIGSTY</title><meta name=description content="Point-in-Time Recovery (PITR) Backup and Restore"><meta property="og:url" content="https://pigsty.io/docs/pgsql/backup/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="Backup & Restore"><meta property="og:description" content="Point-in-Time Recovery (PITR) Backup and Restore"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Backup & Restore"><meta itemprop=description content="Point-in-Time Recovery (PITR) Backup and Restore"><meta itemprop=dateModified content="2026-01-08T18:48:49+08:00"><meta itemprop=wordCount content="168"><meta itemprop=keywords content="Task,Reference"><meta name=twitter:card content="summary"><meta name=twitter:title content="Backup & Restore"><meta name=twitter:description content="Point-in-Time Recovery (PITR) Backup and Restore"><link rel=preload href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css as=style integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><link href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css rel=stylesheet integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Ver</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.cc>Pigsty 中文网站</a></li><li><a class=dropdown-item href=https://doc.pgsty.com>Pigsty v3.7 Doc</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc>Pigsty v3.4 Doc</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 Doc</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 Doc</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch Language / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d757e151050fd40088751a74721d74f6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:window.location.href="https://pigsty.cc"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/pgsql/backup/>Return to the regular view of this page</a>.</p></div><h1 class=title>Backup & Restore</h1><div class=lead>Point-in-Time Recovery (PITR) Backup and Restore</div><ul><li>1: <a href=#pg-4c34e733cec9746048fccac02c01fd36>Backup Policy</a></li><li>2: <a href=#pg-931bd9f9bf4846ff58a1265e886414d1>Backup Mechanism</a></li><li>3: <a href=#pg-e2aad9fad6e8fd1fba46059ad4ea7613>Backup Repository</a></li><li>4: <a href=#pg-bd9fc4fbfbb9e33698d751afa14c6077>Admin Commands</a></li><li>5: <a href=#pg-ee98f0d297c9a6847c501efbbbed8fa6>Restore Operations</a></li><li>6: <a href=#pg-f811d9356784e47cdedcf860a7ba394a>Clone PG Cluster</a></li><li>7: <a href=#pg-57c909cac5de1f311ae32e0421e66ee7>Clone Database</a></li></ul><div class=content><p>Pigsty uses <a href=https://pgbackrest.org/>pgBackRest</a> to manage PostgreSQL backups, arguably the most powerful open-source backup tool in the ecosystem.
It supports incremental/parallel backup and restore, encryption, <a href=/docs/minio>MinIO</a>/S3, and many other features. Pigsty configures backup functionality by default for each <a href=/docs/pgsql>PGSQL</a> cluster.</p><table><thead><tr><th>Section</th><th>Content</th></tr></thead><tbody><tr><td><a href=mechanism>Mechanism</a></td><td>Backup scripts, cron jobs, pgbackrest, repository and management</td></tr><tr><td><a href=policy>Policy</a></td><td>Backup strategy, disk planning, recovery window tradeoffs</td></tr><tr><td><a href=repository>Repository</a></td><td>Configuring backup repositories: local, MinIO, S3</td></tr><tr><td><a href=admin>Admin</a></td><td>Common backup management commands</td></tr><tr><td><a href=restore>Restore</a></td><td>Restore to a specific point in time using playbooks</td></tr><tr><td><a href=example>Example</a></td><td>Sandbox example: performing restore operations manually</td></tr></tbody></table><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Disclaimer</div><blockquote><p>Pigsty makes every effort to provide a reliable PITR solution, but we accept no responsibility for data loss resulting from PITR operations. Use at your own risk. If you need professional support, please consider our <a href=/docs/about/service>professional services</a>.</p></blockquote></div><hr><h2 id=quick-start>Quick Start</h2><ol><li><a href=mechanism>Backup Policy</a>: Schedule base backups using Crontab</li><li><a href=policy>WAL Archiving</a>: Continuously record write activity</li><li><a href=restore>Restore & Recovery</a>: Recover from backups and WAL archives</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;time&#34;: &#34;2025-07-13 10:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4c34e733cec9746048fccac02c01fd36>1 - Backup Policy</h1><div class=lead>Design backup policies according to your needs</div><ul><li><strong>When</strong>: Backup schedule</li><li><strong>Where</strong>: Backup repository</li><li><strong>How</strong>: Backup method</li></ul><hr><h2 id=when-to-backup>When to Backup</h2><p>The first question is <strong>when</strong> to backup your database - this is a tradeoff between backup frequency and recovery time.
Since you need to replay WAL logs from the last backup to the recovery target point, the more frequent the backups, the less WAL logs need to be replayed, and the faster the recovery.</p><h3 id=daily-full-backup>Daily Full Backup</h3><p>For production databases, it&rsquo;s recommended to start with the simplest daily full backup strategy.
This is also Pigsty&rsquo;s default backup strategy, implemented via <a href=mechanism#scheduled-backups>crontab</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method: local          # Choose backup repository method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>`local`, `minio`, or other custom repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Default pgbackrest repository using local POSIX filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Local backup directory, defaults to `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Keep 2, up to 3 full backups when using local filesystem repository</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When used with the default <code>local</code> local filesystem backup repository, this provides a 24~48 hour recovery window.</p><p><img src=/img/pigsty/pitr-scope.png alt=pitr-scope></p><p>Assuming your database size is 100GB and writes 10GB of data per day, the backup size is as follows:</p><p><img src=/img/pigsty/pitr-space.png alt=pitr-space></p><p>This will consume <code>2~3</code> times the database size in space, plus 2 days of WAL logs.
Therefore, in practice, you may need to prepare at least <code>3~5</code> times the database size for backup disk to use the default backup strategy.</p><h3 id=full--incremental-backup>Full + Incremental Backup</h3><p>You can optimize backup space usage by adjusting these parameters.</p><p>If using MinIO / S3 as a centralized backup repository, you can use storage space beyond local disk limitations.
In this case, consider using full + incremental backup with a 2-week retention policy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Full backup at 1 AM on Monday, incremental backups on weekdays</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Optional minio repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio is S3 compatible</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio endpoint domain, defaults to `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio region, defaults to us-east-1, meaningless for minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio bucket name, defaults to `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user access key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user secret for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio uses path-style URIs instead of host-style</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio backup path, defaults to `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio port, defaults to 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA certificate path, defaults to `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># Enable block-level incremental backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Bundle small files into a single file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle size limit, recommended 20MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle target size, recommended 128MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Enable AES encryption for remote backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, defaults to &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Keep full backups from the last 14 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>When used with the built-in <code>minio</code> backup repository, this provides a guaranteed 1-week PITR recovery window.</p><p><img src=/img/pigsty/pitr-scope2.png alt=pitr-scope2></p><p>Assuming your database size is 100GB and writes 10GB of data per day, the backup size is as follows:</p><p><img src=/img/pigsty/pitr-space2.png alt=pitr-space2></p><hr><h2 id=backup-location>Backup Location</h2><p>By default, Pigsty provides two default backup repository definitions: <code>local</code> and <code>minio</code> backup repositories.</p><ul><li><code>local</code>: <strong>Default option</strong>, uses local <code>/pg/backup</code> directory (symlink to <a href=/docs/pgsql/param/#pg_fs_backup><code>pg_fs_backup</code></a>: <code>/data/backups</code>)</li><li><code>minio</code>: Uses SNSD single-node MinIO cluster (supported by Pigsty, but not enabled by default)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method: local          # Choose backup repository method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>`local`, `minio`, or other custom repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Default pgbackrest repository using local POSIX filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Local backup directory, defaults to `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Keep 2, up to 3 full backups when using local filesystem repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Optional minio repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio is S3 compatible</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio endpoint domain, defaults to `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio region, defaults to us-east-1, meaningless for minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio bucket name, defaults to `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user access key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user secret for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio uses path-style URIs instead of host-style</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio backup path, defaults to `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio port, defaults to 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA certificate path, defaults to `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># Enable block-level incremental backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Bundle small files into a single file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle size limit, recommended 20MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle target size, recommended 128MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Enable AES encryption for remote backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, defaults to &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Keep full backups from the last 14 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-931bd9f9bf4846ff58a1265e886414d1>2 - Backup Mechanism</h1><div class=lead>Backup scripts, cron jobs, backup repository and infrastructure</div><p>Backups can be invoked via built-in <a href=#scripts>scripts</a>, scheduled using node <a href=#scheduled-backups>crontab</a>,
managed by <a href=https://pgbackrest.org/>pgbackrest</a>, and stored in backup repositories,
which can be local disk filesystems or MinIO / S3, supporting different <a href=#retention-policy>retention</a> policies.</p><hr><h2 id=scripts>Scripts</h2><p>You can create backups using the <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a> user (defaults to <code>postgres</code>) to execute <code>pgbackrest</code> commands:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
Backup Commands</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
backup</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
full</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
diff</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
incr</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
info</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>full backup   <span style=color:#8f5902;font-style:italic># Create full backup for cluster pg-meta</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>full backup
</span></span><span style=display:flex><span>2025-07-15 01:36:57.007 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: --annotation<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>pg_cluster</span><span style=color:#ce5c00;font-weight:700>=</span>pg-meta ...
</span></span><span style=display:flex><span>2025-07-15 01:36:57.030 P00   INFO: execute non-exclusive backup start: backup begins after the requested immediate checkpoint completes
</span></span><span style=display:flex><span>2025-07-15 01:36:57.105 P00   INFO: backup start <span style=color:#000>archive</span> <span style=color:#ce5c00;font-weight:700>=</span> 000000010000000000000006, <span style=color:#000>lsn</span> <span style=color:#ce5c00;font-weight:700>=</span> 0/6000028
</span></span><span style=display:flex><span>2025-07-15 01:36:58.540 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F
</span></span><span style=display:flex><span>2025-07-15 01:36:58.588 P00   INFO: full backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 44.5MB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:36:58.589 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1584ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>diff backup
</span></span><span style=display:flex><span>2025-07-15 01:37:24.952 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-15 01:37:24.985 P00   INFO: last backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F, <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> 2.54.2
</span></span><span style=display:flex><span>2025-07-15 01:37:26.337 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013724D
</span></span><span style=display:flex><span>2025-07-15 01:37:26.381 P00   INFO: diff backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 424.3KB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:37:26.381 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1431ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>incr backup
</span></span><span style=display:flex><span>2025-07-15 01:37:30.305 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-15 01:37:30.337 P00   INFO: last backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013724D, <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> 2.54.2
</span></span><span style=display:flex><span>2025-07-15 01:37:31.356 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013730I
</span></span><span style=display:flex><span>2025-07-15 01:37:31.403 P00   INFO: incr backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 8.3KB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:37:31.403 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1099ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta info
</span></span><span style=display:flex><span>stanza: pg-meta
</span></span><span style=display:flex><span>    status: ok
</span></span><span style=display:flex><span>    cipher: aes-256-cbc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    db <span style=color:#ce5c00;font-weight:700>(</span>current<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        wal archive min/max <span style=color:#ce5c00;font-weight:700>(</span>17<span style=color:#ce5c00;font-weight:700>)</span>: 000000010000000000000001/00000001000000000000000A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        full backup: 20250715-013657F
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:36:57+00 / 2025-07-15 01:36:58+00
</span></span><span style=display:flex><span>            wal start/stop: <span style=color:#0000cf;font-weight:700>000000010000000000000006</span> / <span style=color:#0000cf;font-weight:700>000000010000000000000006</span>
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 44.5MB
</span></span><span style=display:flex><span>            repo1: backup size: 8.7MB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        diff backup: 20250715-013657F_20250715-013724D
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:37:24+00 / 2025-07-15 01:37:26+00
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 424.3KB
</span></span><span style=display:flex><span>            repo1: backup size: 94KB
</span></span><span style=display:flex><span>            backup reference total: <span style=color:#0000cf;font-weight:700>1</span> full
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        incr backup: 20250715-013657F_20250715-013730I
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:37:30+00 / 2025-07-15 01:37:31+00
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 8.3KB
</span></span><span style=display:flex><span>            repo1: backup size: 504B
</span></span><span style=display:flex><span>            backup reference total: <span style=color:#0000cf;font-weight:700>1</span> full, <span style=color:#0000cf;font-weight:700>1</span> diff</span></span></code></pre></div></div></div><p>Here the <code>stanza</code> is the database cluster name: <a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a>, which is <code>pg-meta</code> in the default configuration.</p><p>Pigsty provides the <code>pb</code> alias and <code>pg-backup</code> wrapper script, which automatically fills in the current cluster name as the stanza:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pb<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>stanza</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>grep -o <span style=color:#4e9a06>&#39;\[[^][]*]&#39;</span> /etc/pgbackrest/pgbackrest.conf <span style=color:#000;font-weight:700>|</span> head -n1 <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/.*\[\([^]]*\)].*/\1/&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$stanza</span> <span style=color:#000>$@</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>pb ...    <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta ...</span>
</span></span><span style=display:flex><span>pb info   <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta info</span>
</span></span><span style=display:flex><span>pb backup <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta backup</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># Perform full backup         = pgbackrest --stanza=pg-meta --type=full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># Perform incremental backup  = pgbackrest --stanza=pg-meta --type=incr backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># Perform differential backup = pgbackrest --stanza=pg-meta --type=diff backup</span>
</span></span></code></pre></div><hr><h2 id=scheduled-backups>Scheduled Backups</h2><p>Pigsty uses Linux crontab to schedule backup tasks. You can use it to define backup policies.</p><p>For example, most single-node configuration templates have the following <a href=/docs/node/param#node_crontab><code>node_crontab</code></a> for backups:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>You can design more complex backup strategies using crontab and the <code>pg-backup</code> script, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Full backup at 1 AM on Monday, incremental backups on weekdays</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To apply crontab changes, use <a href=/docs/node/playbook/#nodeyml><code>node.yml</code></a> to update crontab on all nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_crontab -l pg-meta    <span style=color:#8f5902;font-style:italic># Apply crontab changes to pg-meta group</span>
</span></span></code></pre></div><hr><h2 id=pgbackrest>pgbackrest</h2><p>Here are the configuration details for pgbackrest in Pigsty:</p><ul><li>pgbackrest backup tool is enabled and configured by default (<a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a>)</li><li>Installed in the <code>pg_install</code> task of the <a href=/docs/pgsql/playbook/#pgsqlyml><code>pgsql.yml</code></a> playbook, defined in <a href=/docs/pgsql/param/#pg_packages><code>pg_packages</code></a></li><li>Configured in the <code>pg_backup</code> task of the <a href=/docs/pgsql/playbook/#pgsqlyml><code>pgsql.yml</code></a> playbook, see <a href=/docs/pgsql/param/#pg_backup>Parameters: PG_BACKUP</a></li><li>Backup repository initialized in the <code>pgbackrest_init</code> task, which will fail if the repository already exists (error can be ignored)</li><li>Initial backup created in the <code>pgbackrest_backup</code> task, controlled by <a href=/docs/pgsql/param/#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a></li></ul><h3 id=file-hierarchy>File Hierarchy</h3><ul><li>bin: <code>/usr/bin/pgbackrest</code>, from PGDG&rsquo;s <code>pgbackrest</code> package, in group alias <code>pgsql-common</code>.</li><li>conf: <code>/etc/pgbackrest</code>, main configuration file is <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pgbackrest.conf><code>/etc/pgbackrest/pgbackrest.conf</code></a>.</li><li>logs: <code>/pg/log/pgbackrest/*</code>, controlled by <a href=/docs/pgsql/param/#pgbackrest_log_dir><code>pgbackrest_log_dir</code></a></li><li>tmp: <code>/pg/spool</code> used as temporary spool directory for pgbackrest</li><li>data: <code>/pg/backup</code> used to store data (when using the default <code>local</code> filesystem backup repository)</li></ul><p>Additionally, during <a href=/docs/pgsql/backup/restore>PITR recovery</a>, Pigsty creates a temporary <code>/pg/conf/pitr.conf</code> pgbackrest configuration file,
and writes postgres recovery logs to the <code>/pg/tmp/recovery.log</code> file.</p><h3 id=monitoring>Monitoring</h3><p>There is a <code>pgbackrest_exporter</code> service running on <a href=/docs/pgsql/param/#pgbackrest_exporter_port><code>pgbackrest_exporter_port</code></a> (<code>9854</code>) port for exporting pgbackrest metrics.
You can customize it via <a href=/docs/pgsql/param/#pgbackrest_exporter_options><code>pgbackrest_exporter_options</code></a>,
or set <a href=/docs/pgsql/param/#pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></a> to <code>false</code> to disable it.</p><h3 id=initial-backup>Initial Backup</h3><p>When creating a postgres cluster, Pigsty automatically creates an initial backup.
Since the new cluster is almost empty, this is a very small backup.
It leaves a <code>/etc/pgbackrest/initial.done</code> marker file to avoid recreating the initial backup.
If you don&rsquo;t want an initial backup, set <a href=/docs/pgsql/param/#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a> to <code>false</code>.</p><hr><h2 id=management>Management</h2><h3 id=enable-backup>Enable Backup</h3><p>If <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> is set to <code>true</code> when the database cluster is created, backups will be automatically enabled.</p><p>If this value was <code>false</code> at creation time, you can enable the pgbackrest component with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># Run pgbackrest subtask</span>
</span></span></code></pre></div><h3 id=remove-backup>Remove Backup</h3><p>When removing the primary instance (<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>), Pigsty will delete the pgbackrest backup stanza.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># Keep backups</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># Remove backups only</span>
</span></span></code></pre></div><p>Use the <code>pg_backup</code> subtask to remove backups only, and the <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> parameter (set to <code>false</code>) to preserve backups.</p><p>If your backup repository is <strong>locked</strong> (e.g., S3 / MinIO has locking options), this operation will fail.</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Backup Deletion</div><p>Deleting backups may result in permanent data loss. This is a dangerous operation, please proceed with caution.</p></div><h3 id=list-backups>List Backups</h3><p>This command will list all backups in the pgbackrest repository (shared across all clusters)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><h3 id=manual-backup>Manual Backup</h3><p>Pigsty provides a built-in script <code>/pg/bin/pg-backup</code> that wraps the <code>pgbackrest</code> backup command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># Perform full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># Perform differential backup</span>
</span></span></code></pre></div><h3 id=base-backup>Base Backup</h3><p>Pigsty provides an alternative backup script <code>/pg/bin/pg-basebackup</code> that does not depend on <code>pgbackrest</code> and directly provides a physical copy of the database cluster.
The default backup directory is <code>/pg/backup</code>.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     Backup <span style=color:#204a87>source</span> URL, optional, defaults to <span style=color:#4e9a06>&#34;postgres:///&#34;</span>, password should be provided in url, ENV, or .pgpass <span style=color:#204a87;font-weight:700>if</span> required
</span></span><span style=display:flex><span>-d, --dst, --dir     Location to store backup file, defaults to <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           Override default backup filename, <span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         Remove .lz4 files older than n minutes, defaults to <span style=color:#0000cf;font-weight:700>1200</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span> hours<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-t, --tag            Backup file tag, uses target cluster name or <span style=color:#204a87>local</span> IP address <span style=color:#204a87;font-weight:700>if</span> not set, also used <span style=color:#204a87;font-weight:700>for</span> default filename
</span></span><span style=display:flex><span>-k, --key            Encryption key when --encrypt is specified, defaults to <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         Upload backup file to cloud storage <span style=color:#ce5c00;font-weight:700>(</span>needs to be implemented by yourself<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-e, --encryption     Use OpenSSL RC4 encryption, uses tag as key <span style=color:#204a87;font-weight:700>if</span> not specified
</span></span><span style=display:flex><span>-h, --help           Print this <span style=color:#204a87>help</span> information</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>The backup uses <code>lz4</code> compression. You can decompress and extract the tarball with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># Extract backup to this directory</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><h3 id=logical-backup>Logical Backup</h3><p>You can also perform logical backups using the <code>pg_dump</code> command.</p><p>Logical backups cannot be used for PITR (Point-in-Time Recovery), but are very useful for migrating data between different major versions or implementing flexible data export logic.</p><h3 id=bootstrap-from-repository>Bootstrap from Repository</h3><p>Suppose you have an existing cluster <code>pg-meta</code> and want to <strong>clone</strong> it as <code>pg-meta2</code>:</p><p>You need to create a new <code>pg-meta2</code> cluster branch and then run <code>pitr</code> on it.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e2aad9fad6e8fd1fba46059ad4ea7613>3 - Backup Repository</h1><div class=lead>PostgreSQL backup storage repository configuration</div><p>You can configure the backup <strong>storage location</strong> by specifying the <a href=/docs/pgsql/param/#pgbackrest_repo><code>pgbackrest_repo</code></a> parameter.
You can define multiple repositories here, and Pigsty will choose which one to use based on the value of <a href=/docs/pgsql/param/#pgbackrest_method><code>pgbackrest_method</code></a>.</p><h2 id=default-repositories>Default Repositories</h2><p>By default, Pigsty provides two default backup repository definitions: <code>local</code> and <code>minio</code> backup repositories.</p><ul><li><code>local</code>: <strong>Default option</strong>, uses local <code>/pg/backup</code> directory (symlink to <a href=/docs/pgsql/param/#pg_fs_backup><code>pg_fs_backup</code></a>: <code>/data/backups</code>)</li><li><code>minio</code>: Uses SNSD single-node MinIO cluster (supported by Pigsty, but not enabled by default)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method: local          # Choose backup repository method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>`local`, `minio`, or other custom repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Default pgbackrest repository using local POSIX filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Local backup directory, defaults to `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Keep 2, up to 3 full backups when using local filesystem repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Optional minio repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio is S3 compatible</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio endpoint domain, defaults to `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio region, defaults to us-east-1, meaningless for minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio bucket name, defaults to `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user access key for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio user secret for pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio uses path-style URIs instead of host-style</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio backup path, defaults to `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio port, defaults to 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA certificate path, defaults to `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># Enable block-level incremental backup</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Bundle small files into a single file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle size limit, recommended 20MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle target size, recommended 128MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Enable AES encryption for remote backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, defaults to &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Keep full backups from the last 14 days</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=repository-retention-policy>Repository Retention Policy</h2><p>If you backup daily but don&rsquo;t delete old backups, the backup repository will grow indefinitely and exhaust disk space.
You need to define a retention policy to keep only a limited number of backups.</p><p>The default backup policy is defined in the <a href=/docs/pgsql/param/#pgbackrest_repo><code>pgbackrest_repo</code></a> parameter and can be adjusted as needed.</p><ul><li><code>local</code>: Keep the latest <strong>2</strong> full backups, allowing up to 3 during backup</li><li><code>minio</code>: Keep all full backups from the last <strong>14</strong> days</li></ul><hr><h2 id=space-planning>Space Planning</h2><p>Object storage provides almost unlimited storage capacity, so there&rsquo;s no need to worry about disk space.
You can use a hybrid full + differential backup strategy to optimize space usage.</p><p>For local disk backup repositories, Pigsty recommends using a policy that keeps the latest <strong>2</strong> full backups,
meaning the disk will retain the two most recent full backups (there may be a third copy while running a new backup).</p><p>This guarantees at least a 24-hour recovery window. See <a href=policy>Backup Policy</a> for details.</p><hr><h2 id=other-repository-options>Other Repository Options</h2><p>You can also use other services as backup repositories, refer to the <a href=https://pgbackrest.org/user-guide.html>pgbackrest documentation</a> for details:</p><ul><li><a href=https://pgbackrest.org/user-guide.html#s3-support>S3 Compatible Object Storage</a></li><li><a href=https://pgbackrest.org/user-guide.html#azure-support>Azure Compatible Object Storage</a></li><li><a href=https://pgbackrest.org/user-guide.html#gcs-support>GCS Compatible Object Storage</a></li><li><a href=https://pgbackrest.org/user-guide.html#sftp-support>SFTP Support</a></li></ul><hr><h2 id=repository-versioning>Repository Versioning</h2><p>You can even specify <a href=https://pgbackrest.org/user-guide.html#sftp-support#repo-target-time>repo target time</a> to get snapshots of object storage.</p><p>You can enable MinIO versioning by adding the <code>versioning</code> flag in <a href=/docs/minio/param#minio_buckets><code>minio_buckets</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_buckets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgsql ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta  ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>data }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=repository-locking>Repository Locking</h2><p>Some object storage services (S3, MinIO, etc.) support <strong>locking</strong> functionality, which can prevent backups from being deleted, even by the DBA.</p><ul><li><a href=https://min.io/docs/minio/linux/administration/object-management/object-retention.html>MinIO Object Locking</a></li><li><a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html>AWS S3: Locking Objects with Object Lock</a></li></ul><p>You can enable MinIO locking by adding the <code>lock</code> flag in <a href=/docs/minio/param#minio_buckets><code>minio_buckets</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_buckets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgsql , lock</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>data }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=using-object-storage>Using Object Storage</h2><p>Object storage services provide almost unlimited storage capacity and provide remote disaster recovery capability for your system.
If you don&rsquo;t have an object storage service, Pigsty has built-in <a href=/docs/minio>MinIO</a> support.</p><h3 id=minio>MinIO</h3><p>You can enable the MinIO backup repository by uncommenting the following settings.
Note that pgbackrest only supports HTTPS / domain names, so you must run MinIO with domain names and HTTPS endpoints.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use minio as default backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># Define a single-node minio SNSD cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq: 1 }} ,vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio }}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=s3>S3</h3><p>If you only have <strong>one</strong> node, a meaningful backup strategy would be to use cloud provider object storage services like AWS S3, Alibaba Cloud OSS, or Google Cloud, etc.
To do this, you can define a new repository:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Use &#39;pgbackrest_repo.s3&#39; as backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest repository configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>s3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># Alibaba Cloud OSS (S3 compatible) object storage service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># oss is S3 compatible</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oss-cn-beijing-internal.aliyuncs.com</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oss-cn-beijing</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_bucket_name&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_access_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_secret_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Bundle small files into a single file</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle size limit, recommended 20MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Bundle target size, recommended 128MiB for object storage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Enable AES encryption for remote backup repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES encryption password, defaults to &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># Keep full backups from the last 14 days</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># Default pgbackrest repository using local POSIX filesystem</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Local backup directory, defaults to `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Retain full backups by count</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># Keep 2, up to 3 full backups when using local filesystem repository</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=managing-backups>Managing Backups</h2><h3 id=enable-backup>Enable Backup</h3><p>If <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> is set to <code>true</code> when the database cluster is created, backups will be automatically enabled.</p><p>If this value was <code>false</code> at creation time, you can enable the pgbackrest component with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># Run pgbackrest subtask</span>
</span></span></code></pre></div><h3 id=remove-backup>Remove Backup</h3><p>When removing the primary instance (<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>), Pigsty will delete the pgbackrest backup stanza.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># Keep backups</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># Remove backups only</span>
</span></span></code></pre></div><p>Use the <code>pg_backup</code> subtask to remove backups only, and the <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> parameter (set to <code>false</code>) to preserve backups.</p><p>If your backup repository is <strong>locked</strong> (e.g., S3 / MinIO has locking options), this operation will fail.</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Backup Deletion</div><p>Deleting backups may result in permanent data loss. This is a dangerous operation, please proceed with caution.</p></div><h3 id=list-backups>List Backups</h3><p>This command will list all backups in the pgbackrest repository (shared across all clusters)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><h3 id=manual-backup>Manual Backup</h3><p>Pigsty provides a built-in script <code>/pg/bin/pg-backup</code> that wraps the <code>pgbackrest</code> backup command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># Perform full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># Perform differential backup</span>
</span></span></code></pre></div><h3 id=base-backup>Base Backup</h3><p>Pigsty provides an alternative backup script <code>/pg/bin/pg-basebackup</code> that does not depend on <code>pgbackrest</code> and directly provides a physical copy of the database cluster.
The default backup directory is <code>/pg/backup</code>.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     Backup <span style=color:#204a87>source</span> URL, optional, defaults to <span style=color:#4e9a06>&#34;postgres:///&#34;</span>, password should be provided in url, ENV, or .pgpass <span style=color:#204a87;font-weight:700>if</span> required
</span></span><span style=display:flex><span>-d, --dst, --dir     Location to store backup file, defaults to <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           Override default backup filename, <span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         Remove .lz4 files older than n minutes, defaults to <span style=color:#0000cf;font-weight:700>1200</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span> hours<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-t, --tag            Backup file tag, uses target cluster name or <span style=color:#204a87>local</span> IP address <span style=color:#204a87;font-weight:700>if</span> not set, also used <span style=color:#204a87;font-weight:700>for</span> default filename
</span></span><span style=display:flex><span>-k, --key            Encryption key when --encrypt is specified, defaults to <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         Upload backup file to cloud storage <span style=color:#ce5c00;font-weight:700>(</span>needs to be implemented by yourself<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-e, --encryption     Use OpenSSL RC4 encryption, uses tag as key <span style=color:#204a87;font-weight:700>if</span> not specified
</span></span><span style=display:flex><span>-h, --help           Print this <span style=color:#204a87>help</span> information</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>The backup uses <code>lz4</code> compression. You can decompress and extract the tarball with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># Extract backup to this directory</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><h3 id=logical-backup>Logical Backup</h3><p>You can also perform logical backups using the <code>pg_dump</code> command.</p><p>Logical backups cannot be used for PITR (Point-in-Time Recovery), but are very useful for migrating data between different major versions or implementing flexible data export logic.</p><h3 id=bootstrap-from-repository>Bootstrap from Repository</h3><p>Suppose you have an existing cluster <code>pg-meta</code> and want to <strong>clone</strong> it as <code>pg-meta2</code>:</p><p>You need to create a new <code>pg-meta2</code> cluster branch and then run <code>pitr</code> on it.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bd9fc4fbfbb9e33698d751afa14c6077>4 - Admin Commands</h1><div class=lead>Managing backup repositories and backups</div><h2 id=enable-backup>Enable Backup</h2><p>If <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> is set to <code>true</code> when the database cluster is created, backups will be automatically enabled.</p><p>If this value was <code>false</code> at creation time, you can enable the pgbackrest component with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># Run pgbackrest subtask</span>
</span></span></code></pre></div><hr><h2 id=remove-backup>Remove Backup</h2><p>When removing the primary instance (<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>), Pigsty will delete the pgbackrest backup stanza.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># Keep backups</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># Remove backups only</span>
</span></span></code></pre></div><p>Use the <code>pg_backup</code> subtask to remove backups only, and the <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> parameter (set to <code>false</code>) to preserve backups.</p><p>If your backup repository is <strong>locked</strong> (e.g., S3 / MinIO has locking options), this operation will fail.</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Backup Deletion</div><p>Deleting backups may result in permanent data loss. This is a dangerous operation, please proceed with caution.</p></div><hr><h2 id=list-backups>List Backups</h2><p>This command will list all backups in the pgbackrest repository (shared across all clusters)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><hr><h2 id=manual-backup>Manual Backup</h2><p>Pigsty provides a built-in script <code>/pg/bin/pg-backup</code> that wraps the <code>pgbackrest</code> backup command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># Perform full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># Perform incremental backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># Perform differential backup</span>
</span></span></code></pre></div><hr><h2 id=base-backup>Base Backup</h2><p>Pigsty provides an alternative backup script <code>/pg/bin/pg-basebackup</code> that does not depend on <code>pgbackrest</code> and directly provides a physical copy of the database cluster.
The default backup directory is <code>/pg/backup</code>.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     Backup <span style=color:#204a87>source</span> URL, optional, defaults to <span style=color:#4e9a06>&#34;postgres:///&#34;</span>, password should be provided in url, ENV, or .pgpass <span style=color:#204a87;font-weight:700>if</span> required
</span></span><span style=display:flex><span>-d, --dst, --dir     Location to store backup file, defaults to <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           Override default backup filename, <span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         Remove .lz4 files older than n minutes, defaults to <span style=color:#0000cf;font-weight:700>1200</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span> hours<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-t, --tag            Backup file tag, uses target cluster name or <span style=color:#204a87>local</span> IP address <span style=color:#204a87;font-weight:700>if</span> not set, also used <span style=color:#204a87;font-weight:700>for</span> default filename
</span></span><span style=display:flex><span>-k, --key            Encryption key when --encrypt is specified, defaults to <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         Upload backup file to cloud storage <span style=color:#ce5c00;font-weight:700>(</span>needs to be implemented by yourself<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>-e, --encryption     Use OpenSSL RC4 encryption, uses tag as key <span style=color:#204a87;font-weight:700>if</span> not specified
</span></span><span style=display:flex><span>-h, --help           Print this <span style=color:#204a87>help</span> information</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>The backup uses <code>lz4</code> compression. You can decompress and extract the tarball with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># Extract backup to this directory</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><hr><h2 id=logical-backup>Logical Backup</h2><p>You can also perform logical backups using the <code>pg_dump</code> command.</p><p>Logical backups cannot be used for PITR (Point-in-Time Recovery), but are very useful for migrating data between different major versions or implementing flexible data export logic.</p><hr><h2 id=bootstrap-from-repository>Bootstrap from Repository</h2><p>Suppose you have an existing cluster <code>pg-meta</code> and want to <strong>clone</strong> it as <code>pg-meta2</code>:</p><p>You need to create a new <code>pg-meta2</code> cluster branch and then run <code>pitr</code> on it.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ee98f0d297c9a6847c501efbbbed8fa6>5 - Restore Operations</h1><div class=lead>Restore PostgreSQL from backups</div><p>You can perform Point-in-Time Recovery (PITR) in Pigsty using pre-configured pgbackrest.</p><ul><li><a href=#manual-approach><strong>Manual Approach</strong></a>: Manually execute PITR using <code>pg-pitr</code> prompt scripts, more flexible but more complex.</li><li><a href=#playbook-approach><strong>Playbook Approach</strong></a>: Automatically execute PITR using <code>pgsql-pitr.yml</code> playbook, highly automated but less flexible and error-prone.</li></ul><p>If you are very familiar with the configuration, you can use the fully automated playbook, otherwise manual step-by-step operation is recommended.</p><hr><h2 id=quick-start>Quick Start</h2><p>If you want to roll back the <code>pg-meta</code> cluster to a previous point in time, add the <code>pg_pitr</code> parameter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-07-13 10:00:00+00&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Recover from latest backup</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Then run the <code>pgsql-pitr.yml</code> playbook, which will roll back the <code>pg-meta</code> cluster to the specified point in time.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta
</span></span></code></pre></div><hr><h2 id=post-recovery>Post-Recovery</h2><p>The recovered cluster will have <code>archive_mode</code> <strong>disabled</strong> to prevent accidental WAL writes.
If the recovered database state is normal, you can enable <code>archive_mode</code> and perform a full backup.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode; SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>pg-backup full    <span style=color:#8f5902;font-style:italic># Perform new full backup</span>
</span></span></code></pre></div><hr><h2 id=recovery-target>Recovery Target</h2><p>You can specify different types of recovery targets in <code>pg_pitr</code>, but they are mutually exclusive:</p><ul><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TIME><code>time</code></a>: To which point in time to recover?</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-NAME><code>name</code></a>: Recover to a named restore point (created by <code>pg_create_restore_point</code>)</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-XID><code>xid</code></a>: Recover to a specific transaction ID (TXID/XID)</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-LSN><code>lsn</code></a>: Recover to a specific LSN (Log Sequence Number) point</li></ul><p>If any of the above parameters are specified, the recovery <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TYPE><code>type</code></a> will be set accordingly,
otherwise it will be set to <code>latest</code> (end of WAL archive stream).
The special <code>immediate</code> type can be used to instruct pgbackrest to minimize recovery time by stopping at the first consistent point.</p><h3 id=target-types>Target Types</h3><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
Recovery Target Types</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
latest</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
time</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
lsn</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
xid</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
name</button></li><li class=nav-item><button class=nav-link id=tabs-00-06-tab data-bs-toggle=tab data-bs-target=#tabs-00-06 role=tab aria-controls=tabs-00-06 aria-selected=false>
immediate</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Recover to latest state (end of WAL archive stream)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-07-13 10:00:00+00&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;0/4001C80&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;250000&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-06 role=tabpanel aria-labelled-by=tabs-00-06-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;immediate&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div></div><h3 id=recover-by-time>Recover by Time</h3><p>The most commonly used target is a point in time; you can specify the time point to recover to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;time&#34;: &#34;2025-07-13 10:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div><p>Time should be in valid PostgreSQL <a href=https://www.postgresql.org/docs/17/datatype-datetime.html#DATATYPE-DATETIME-INPUT-TIME-STAMPS><code>TIMESTAMP</code></a> format, <code>YYYY-MM-DD HH:MM:SS+TZ</code> is recommended.</p><h3 id=recover-by-name>Recover by Name</h3><p>You can create named restore points using <a href=https://www.postgresql.org/docs/current/functions-admin.html#id-1.5.8.34.5.5.2.2.1.1.1.1><code>pg_create_restore_point</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_create_restore_point</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;shit_incoming&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Then use that named restore point in PITR:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;name&#34;: &#34;shit_incoming&#34; }}&#39;</span>
</span></span></code></pre></div><h3 id=recover-by-xid>Recover by XID</h3><p>If you have a transaction that accidentally deleted some data, the best way to recover is to restore the database to the state before that transaction.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;xid&#34;: &#34;250000&#34;, exclusive: true }}&#39;</span>
</span></span></code></pre></div><p>You can find the exact transaction ID from monitoring dashboards or from the <code>TXID</code> field in CSVLOG.</p><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>Inclusive vs Exclusive</div><p>Target parameters are &ldquo;inclusive&rdquo; by default, meaning recovery will include the target point.
The <code>exclusive</code> flag will exclude that exact target, e.g., xid 24999 will be the last transaction replayed.</p><p>This only applies to <code>time</code>, <code>xid</code>, <code>lsn</code> recovery targets, see <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-INCLUSIVE><code>recovery_target_inclusive</code></a> for details.</p></div><h3 id=recover-by-lsn>Recover by LSN</h3><p>PostgreSQL uses <a href=https://www.postgresql.org/docs/current/datatype-pg-lsn.html>LSN</a> (Log Sequence Number) to identify the location of WAL records.
You can find it in many places, such as the PG LSN panel in Pigsty dashboards.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;lsn&#34;: &#34;0/4001C80&#34;, timeline: &#34;1&#34; }}&#39;</span>
</span></span></code></pre></div><p>To recover to an exact position in the WAL stream, you can also specify the <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TIMELINE><code>timeline</code></a> parameter (defaults to <code>latest</code>)</p><hr><h2 id=recovery-source>Recovery Source</h2><ul><li><code>cluster</code>: From which cluster to recover? Defaults to current <code>pg_cluster</code>, you can use any other cluster in the same pgbackrest repository</li><li><code>repo</code>: Override backup repository, uses same format as <code>pgbackrest_repo</code></li><li><code>set</code>: Defaults to <code>latest</code> backup set, but you can specify a specific pgbackrest backup by label</li></ul><p>Pigsty will recover from the pgbackrest backup repository. If you use a centralized backup repository (like MinIO/S3),
you can specify another &ldquo;stanza&rdquo; (another cluster&rsquo;s backup directory) as the recovery source.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Recover from pg-meta cluster backup</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>The above configuration will mark the PITR process to use the <code>pg-meta</code> stanza.
You can also pass the <code>pg_pitr</code> parameter via CLI arguments:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34; }}&#39;</span>
</span></span></code></pre></div><p>You can also use these targets when PITR from another cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-07-14 08:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div><hr><h2 id=step-by-step-execution>Step-by-Step Execution</h2><p>This approach is semi-automatic, you will participate in the PITR process to make critical decisions.</p><p>For example, this configuration will restore the <code>pg-meta</code> cluster itself to the specified point in time:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-07-13 10:00:00+00&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># Recover from latest backup</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Let&rsquo;s execute step by step:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t down     <span style=color:#8f5902;font-style:italic># Pause patroni high availability</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t pitr     <span style=color:#8f5902;font-style:italic># Run pitr process</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t up       <span style=color:#8f5902;font-style:italic># Generate pgbackrest config and recovery script</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># down                 : # Stop high availability and shutdown patroni and postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pause            : # Pause patroni auto-failover</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - stop             : # Stop patroni and postgres services</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_patroni   : # Stop patroni service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_postgres  : # Stop postgres service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pitr                 : # Perform PITR process</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - config           : # Generate pgbackrest config and recovery script</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - restore          : # Run pgbackrest restore command</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - recovery         : # Start postgres and complete recovery</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - verify           : # Verify recovered cluster control data</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># up:                  : # Start postgres / patroni and restore high availability</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - etcd             : # Clean etcd metadata before starting</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - start            : # Start patroni and postgres services</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_postgres : # Start postgres service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_patroni  : # Start patroni service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - resume           : # Resume patroni auto-failover</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=pitr-parameter-definition>PITR Parameter Definition</h2><p>The <code>pg_pitr</code> parameter has more options available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># Define PITR task</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_pg_cls_name&#34;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Source cluster name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type: latest                   # Recovery target type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time, xid, name, lsn, immediate, latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-01 10:00:00+00&#34;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Recovery target: time, mutually exclusive with xid, name, lsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># Recovery target: named restore point, mutually exclusive with time, xid, lsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;100000&#34;</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Recovery target: transaction ID, mutually exclusive with time, name, lsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;0/3000000&#34;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># Recovery target: log sequence number, mutually exclusive with time, name, xid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>timeline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latest              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Target timeline, can be integer, defaults to latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>exclusive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Whether to exclude target point, defaults to false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>action: pause                  # Post-recovery action</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pause, promote, shutdown</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>archive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># Whether to keep archive settings? Defaults to false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db_exclude</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>template0, template1 ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db_include</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>link_map</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_wal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/wal&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_xact</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/pg_xact&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>process</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Number of parallel recovery processes</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># Recovery source repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/data                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Data recovery location</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># Listening port for recovered instance</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f811d9356784e47cdedcf860a7ba394a>6 - Clone PG Cluster</h1><div class=lead>How to use PITR to create a new PostgreSQL cluster and restore to a specified point in time?</div><h2 id=quick-start>Quick Start</h2><ul><li>Create an online replica of an existing cluster using Standby Cluster</li><li>Create a point-in-time snapshot of an existing cluster using PITR</li><li>Perform post-PITR cleanup to ensure the new cluster&rsquo;s backup process works properly</li></ul><p>You can use the PG PITR mechanism to clone an entire database cluster.</p><h2 id=reset-a-clusters-state>Reset a Cluster&rsquo;s State</h2><p>You can also consider creating a brand new empty cluster, then use PITR to reset it to a specific state of the <code>pg-meta</code> cluster.</p><p>Using this technique, you can clone any point-in-time (within backup retention period) state of the existing cluster <code>pg-meta</code> to a new cluster.</p><p>Using the Pigsty 4-node sandbox environment as an example, use the following command to reset the <code>pg-test</code> cluster to the latest state of the <code>pg-meta</code> cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34; }}&#39;</span>
</span></span></code></pre></div><h2 id=post-pitr-cleanup>Post-PITR Cleanup</h2><p>When you restore a cluster using PITR, the new cluster&rsquo;s PITR functionality is disabled. This is because if it also tries to generate backups and archive WAL, it could dirty the backup repository of the previous cluster.</p><p>Therefore, after confirming that the state of this PITR-restored new cluster meets expectations, you need to perform the following cleanup:</p><ul><li>Upgrade the backup repository Stanza to accept new backups from different clusters (only when restoring from another cluster)</li><li>Enable <code>archive_mode</code> to allow the new cluster to archive WAL logs (requires cluster restart)</li><li>Perform a new full backup to ensure the new cluster&rsquo;s data is included (optional, can also wait for crontab scheduled execution)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pb stanza-upgrade
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode;&#39;</span>
</span></span><span style=display:flex><span>pg-backup full
</span></span></code></pre></div><p>Through these operations, your new cluster will have its own backup history starting from the first full backup. If you skip these steps, the new cluster&rsquo;s backups will not work, and WAL archiving will not take effect, meaning you cannot perform any backup or PITR operations on the new cluster.</p><h2 id=consequences-of-not-cleaning-up>Consequences of Not Cleaning Up</h2><p>Suppose you performed PITR recovery on the <code>pg-test</code> cluster using data from another cluster <code>pg-meta</code>, but did not perform cleanup.</p><p>Then at the next routine backup, you will see the following error:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-test-1:~$ pb backup
</span></span><span style=display:flex><span>2025-12-27 10:20:29.336 P00   INFO: backup <span style=color:#204a87>command</span> begin...
</span></span><span style=display:flex><span>2025-12-27 10:20:29.357 P00  ERROR: <span style=color:#ce5c00;font-weight:700>[</span>051<span style=color:#ce5c00;font-weight:700>]</span>: PostgreSQL version 18, system-id <span style=color:#0000cf;font-weight:700>7588470953413201282</span> <span style=color:#204a87;font-weight:700>do</span> not match stanza version 18, system-id <span style=color:#0000cf;font-weight:700>7588470974940466058</span>
</span></span><span style=display:flex><span>                                    HINT: is this the correct stanza?
</span></span></code></pre></div><h2 id=clone-a-new-cluster>Clone a New Cluster</h2><p>For example, suppose you have a cluster <code>pg-meta</code>, and now you want to clone a new cluster <code>pg-meta2</code> from <code>pg-meta</code>.</p><p>You can consider using the <a href=/docs/pgsql/config/cluster#standby_cluster><strong>Standby Cluster</strong></a> method to create a new cluster <code>pg-meta2</code>.</p><p>pgBackrest supports incremental backup/restore, so if you have already pulled <code>pg-meta</code>&rsquo;s data through physical replication, the incremental PITR restore is usually very fast.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pb stop --force
</span></span><span style=display:flex><span>pb stanza-delete --force
</span></span><span style=display:flex><span>pb start
</span></span><span style=display:flex><span>pb stanza-create
</span></span></code></pre></div><p>If you want to reset the <code>pg-test</code> cluster to the state of <code>pg-meta</code> cluster at 15:30 on December 26, 2025, you can use the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-12-27 17:50:00+08&#34; ,archive: true }}&#39;</span>
</span></span></code></pre></div><p>Using this technique, you can not only clone the latest state of the <code>pg-meta</code> cluster, but also clone to any point in time.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-57c909cac5de1f311ae32e0421e66ee7>7 - Clone Database</h1><div class=lead>How to clone an existing database within a PostgreSQL cluster using instant XFS cloning</div><h2 id=clone-database>Clone Database</h2><p>You can copy a PostgreSQL database through the template mechanism, but no active connections to the template database are allowed during this period.</p><p>If you want to clone the <code>postgres</code> database, you must execute the following two statements at the same time. Ensure all connections to the <code>postgres</code> database are cleaned up before executing Clone:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_terminate_backend</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgcopy</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TEMPLATE</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8> </span><span style=color:#000>STRATEGY</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=instant-clone>Instant Clone</h3><p>If you are using PostgreSQL 18 or higher, Pigsty sets <a href=https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-FILE-COPY-METHOD><code>file_copy_method</code></a> by default. This parameter allows you to clone a database in O(1) (~200ms) time complexity without copying data files.</p><p>However, you must explicitly use the <a href=https://www.postgresql.org/docs/current/sql-createdatabase.html#CREATE-DATABASE-STRATEGY><code>FILE_COPY</code></a> strategy to create the database. Since the <code>STRATEGY</code> parameter of <code>CREATE DATABASE</code> was introduced in PostgreSQL 15, the default value has been <code>WAL_LOG</code>. You need to explicitly specify <code>FILE_COPY</code> for instant cloning.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_terminate_backend</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgcopy</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TEMPLATE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8> </span><span style=color:#000>STRATEGY</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>For example, cloning a 30 GB database: normal clone (<code>WAL_LOG</code>) takes 18 seconds, while instant clone (<code>FILE_COPY</code>) only needs constant time of 200 milliseconds.</p><p>However, you still need to ensure no active connections to the template database during cloning, but this time can be very short, making it practical for production environments.</p><p>If you need a new database copy for testing or development, instant cloning is an excellent choice. It doesn&rsquo;t introduce additional storage overhead because it uses the file system&rsquo;s CoW (Copy on Write) mechanism.</p><p>Since Pigsty v4.0, you can use <code>strategy: FILE_COPY</code> in the <a href=/docs/pgsql/param#pg_databases/><code>pg_databases</code></a> parameter to achieve instant database cloning.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- Introduced in PG 15, instant in PG18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>#comment: &#34;meta clone&#34;      # &lt;---- Database comment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>#pgbouncer: false           # &lt;---- Not added to connection pool?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>#register_datasource: false # &lt;---- Not added to Grafana datasource?</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>After configuration, use the standard database creation SOP to create the database:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta meta_dev
</span></span></code></pre></div><h3 id=limitations-and-notes>Limitations and Notes</h3><p>This feature is only available on supported file systems (xfs, btrfs, zfs, apfs). If the file system doesn&rsquo;t support it, PostgreSQL will fail with an error.</p><p>By default, mainstream OS distributions&rsquo; xfs have <code>reflink=1</code> enabled by default, so you don&rsquo;t need to worry about this in most cases.</p><p>OpenZFS requires explicit configuration to support CoW, but due to prior data corruption incidents, it&rsquo;s not recommended for production use.</p><p>If your PostgreSQL version is below 15, specifying <code>strategy</code> will have no effect.</p><p>Please don&rsquo;t use the <code>postgres</code> database as a template database for cloning, as management connections typically connect to the <code>postgres</code> database, which prevents the cloning operation.</p><p>Use instant cloning with caution in extremely high concurrency/throughput production environments, as it requires clearing all connections to the template database within the cloning window (200ms), otherwise the clone will fail.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Email - Vonng" aria-label="Email - Vonng"><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label="Email - Vonng"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=WeChat aria-label=WeChat><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=WeChat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Discussion aria-label=Discussion><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=Discussion><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Repo aria-label=Repo><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=Repo><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>