<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.io/docs/pgsql/tutorial/><link rel=alternate type=application/rss+xml href=https://pigsty.io/docs/pgsql/tutorial/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Tutorials | PIGSTY</title><meta name=description content="Step-by-step guides for common PostgreSQL tasks and scenarios."><meta property="og:url" content="https://pigsty.io/docs/pgsql/tutorial/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="Tutorials"><meta property="og:description" content="Step-by-step guides for common PostgreSQL tasks and scenarios."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Tutorials"><meta itemprop=description content="Step-by-step guides for common PostgreSQL tasks and scenarios."><meta itemprop=dateModified content="2026-01-08T18:48:49+08:00"><meta itemprop=wordCount content="37"><meta itemprop=keywords content="Tutorial,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tutorials"><meta name=twitter:description content="Step-by-step guides for common PostgreSQL tasks and scenarios."><link rel=preload href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css as=style integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><link href=/scss/main.min.f6da858eb22dc48110abb983f095554930a5a614c30190b4e32ee7b08a496331.css rel=stylesheet integrity="sha256-9tqFjrItxIEQq7mD8JVVSTClphTDAZC04y7nsIpJYzE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Ver</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.cc>Pigsty 中文网站</a></li><li><a class=dropdown-item href=https://doc.pgsty.com>Pigsty v3.7 Doc</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc>Pigsty v3.4 Doc</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 Doc</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 Doc</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch Language / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d757e151050fd40088751a74721d74f6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:window.location.href="https://pigsty.cc"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/pgsql/tutorial/>Return to the regular view of this page</a>.</p></div><h1 class=title>Tutorials</h1><div class=lead>Step-by-step guides for common PostgreSQL tasks and scenarios.</div><ul><li>1: <a href=#pg-1a4c8e6cbd3b2738e6fb3dfc5e4011b5>Instance Recovery</a></li><li>2: <a href=#pg-39a4da4f2254a96928c0e56a6cb63c63>Troubleshooting</a></li><li>3: <a href=#pg-58aaa9e1f6e72722733819cd673913c3>Manual Recovery</a></li><li>4: <a href=#pg-ec3ed8119ef85413c277384f41ca7b27>Enabling HugePage for PostgreSQL</a></li><li>5: <a href=#pg-e6716a8d517caddd0851177927c9c69c>Accidental Deletion</a></li><li>6: <a href=#pg-677d9d9a118e237b46693da04151cde7>HA Drill: Handling 2-of-3 Node Failure</a></li><li>7: <a href=#pg-b4eeb541b5d47f6b2e5017106913ea72>Bind a L2 VIP to PostgreSQL Primary with VIP-Manager</a></li><li>8: <a href=#pg-1a6ecaf250187005e255b6c6eafd53e2>Deploy HA Citus Cluster</a></li></ul><div class=content><p>This section provides step-by-step tutorials for common PostgreSQL tasks and scenarios.</p><ul><li><a href=citus/><strong>Citus Cluster</strong></a>: Deploy and manage Citus distributed clusters</li><li><a href=drill/><strong>Disaster Drill</strong></a>: Emergency recovery when 2 of 3 nodes fail</li><li><a href=pg-vip/><strong>PG VIP</strong></a>: Configure L2 VIP for PostgreSQL clusters</li></ul></div></div><div class=td-content><h1 id=pg-1a4c8e6cbd3b2738e6fb3dfc5e4011b5>1 - Instance Recovery</h1><div class=lead>Clone instances and perform point-in-time recovery on the same machine</div><p>Pigsty provides two utility scripts for quickly cloning instances and performing point-in-time recovery on the same machine:</p><ul><li><a href=#pg-fork><code>pg-fork</code></a>: Quickly clone a new PostgreSQL instance on the same machine</li><li><a href=#pg-pitr><code>pg-pitr</code></a>: Manually perform point-in-time recovery using pgbackrest</li></ul><p>These two scripts can be used together: first use <code>pg-fork</code> to clone the instance, then use <code>pg-pitr</code> to restore the cloned instance to a specified point in time.</p><hr><h2 id=pg-fork>pg-fork</h2><p><a href=https://github.com/pgsty/pigsty/blob/main/files/postgres/pg-fork><code>pg-fork</code></a> can quickly clone a new PostgreSQL instance on the same machine.</p><h3 id=quick-start>Quick Start</h3><p>Execute the following command as the <code>postgres</code> user (dbsu) to create a new instance:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span>                         <span style=color:#8f5902;font-style:italic># Clone from /pg/data to /pg/data1, port 15432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>2</span> -d /pg/data1            <span style=color:#8f5902;font-style:italic># Clone from /pg/data1 to /pg/data2, port 25432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>3</span> -D /tmp/test -P <span style=color:#0000cf;font-weight:700>5555</span>    <span style=color:#8f5902;font-style:italic># Clone to custom directory and port</span>
</span></span></code></pre></div><p>After cloning, start and access the new instance:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_ctl -D /pg/data1 start         <span style=color:#8f5902;font-style:italic># Start cloned instance</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span>                     <span style=color:#8f5902;font-style:italic># Connect to cloned instance</span>
</span></span></code></pre></div><h3 id=command-syntax>Command Syntax</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-fork &lt;FORK_ID&gt; <span style=color:#ce5c00;font-weight:700>[</span>options<span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><p><strong>Required Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td><code>&lt;FORK_ID></code></td><td>Clone instance number (1-9), determines default port and data directory</td></tr></tbody></table><p><strong>Optional Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>-d, --data &lt;datadir></code></td><td>Source instance data directory</td><td><code>/pg/data</code> or <code>$PG_DATA</code></td></tr><tr><td><code>-D, --dst &lt;dst_dir></code></td><td>Target data directory</td><td><code>/pg/data&lt;FORK_ID></code></td></tr><tr><td><code>-p, --port &lt;port></code></td><td>Source instance port</td><td><code>5432</code> or <code>$PG_PORT</code></td></tr><tr><td><code>-P, --dst-port &lt;port></code></td><td>Target instance port</td><td><code>&lt;FORK_ID>5432</code></td></tr><tr><td><code>-s, --skip</code></td><td>Skip backup API, use cold copy mode</td><td>-</td></tr><tr><td><code>-y, --yes</code></td><td>Skip confirmation prompts</td><td>-</td></tr><tr><td><code>-h, --help</code></td><td>Show help information</td><td>-</td></tr></tbody></table><h3 id=how-it-works>How It Works</h3><p><code>pg-fork</code> supports two working modes:</p><p><strong>Hot Backup Mode</strong> (default, source instance running):</p><ol><li>Call <code>pg_backup_start()</code> to start backup</li><li>Use <code>cp --reflink=auto</code> to copy data directory</li><li>Call <code>pg_backup_stop()</code> to end backup</li><li>Modify configuration files to avoid conflicts with source instance</li></ol><p><strong>Cold Copy Mode</strong> (using <code>-s</code> parameter or source instance not running):</p><ol><li>Directly use <code>cp --reflink=auto</code> to copy data directory</li><li>Modify configuration files</li></ol><p>If you use XFS (with reflink enabled), Btrfs, or ZFS file systems, <code>pg-fork</code> will leverage <strong>Copy-on-Write</strong> features. The data directory copy completes in a few hundred milliseconds and takes almost no additional storage space.</p><hr><h2 id=pg-pitr>pg-pitr</h2><p><a href=https://github.com/pgsty/pigsty/blob/main/files/postgres/pg-pitr><code>pg-pitr</code></a> is a script for manually performing point-in-time recovery, based on pgbackrest.</p><h3 id=quick-start-1>Quick Start</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr -d                                  <span style=color:#8f5902;font-style:italic># Restore to latest state</span>
</span></span><span style=display:flex><span>pg-pitr -i                                  <span style=color:#8f5902;font-style:italic># Restore to backup completion time</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-01-01 12:00:00+08&#34;</span>         <span style=color:#8f5902;font-style:italic># Restore to specified time point</span>
</span></span><span style=display:flex><span>pg-pitr -n my-savepoint                     <span style=color:#8f5902;font-style:italic># Restore to named restore point</span>
</span></span><span style=display:flex><span>pg-pitr -l <span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span>                      <span style=color:#8f5902;font-style:italic># Restore to specified LSN</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>12345678</span> -X                      <span style=color:#8f5902;font-style:italic># Restore to before transaction</span>
</span></span><span style=display:flex><span>pg-pitr -b 20251225-120000F                 <span style=color:#8f5902;font-style:italic># Restore to specified backup set</span>
</span></span></code></pre></div><h3 id=command-syntax-1>Command Syntax</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr <span style=color:#ce5c00;font-weight:700>[</span>options<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>recovery_target<span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><p><strong>Recovery Target (choose one):</strong></p><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td><code>-d, --default</code></td><td>Restore to end of WAL archive stream (latest state)</td></tr><tr><td><code>-i, --immediate</code></td><td>Restore to database consistency point (fastest recovery)</td></tr><tr><td><code>-t, --time &lt;timestamp></code></td><td>Restore to specified time point</td></tr><tr><td><code>-n, --name &lt;restore_point></code></td><td>Restore to named restore point</td></tr><tr><td><code>-l, --lsn &lt;lsn></code></td><td>Restore to specified LSN</td></tr><tr><td><code>-x, --xid &lt;xid></code></td><td>Restore to specified transaction ID</td></tr><tr><td><code>-b, --backup &lt;label></code></td><td>Restore to specified backup set</td></tr></tbody></table><p><strong>Optional Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>-D, --data &lt;path></code></td><td>Recovery target data directory</td><td><code>/pg/data</code></td></tr><tr><td><code>-s, --stanza &lt;name></code></td><td>pgbackrest stanza name</td><td>Auto-detect</td></tr><tr><td><code>-X, --exclusive</code></td><td>Exclude target point (restore to before target)</td><td>-</td></tr><tr><td><code>-P, --promote</code></td><td>Auto-promote after recovery (default pauses)</td><td>-</td></tr><tr><td><code>-c, --check</code></td><td>Dry run mode, only print commands</td><td>-</td></tr><tr><td><code>-y, --yes</code></td><td>Skip confirmation and countdown</td><td>-</td></tr></tbody></table><h3 id=post-recovery-processing>Post-Recovery Processing</h3><p>After recovery completes, the instance will be in <strong>recovery paused</strong> state (unless <code>-P</code> parameter is used). You need to:</p><ol><li><strong>Start instance</strong>: <code>pg_ctl -D /pg/data start</code></li><li><strong>Verify data</strong>: Check if data meets expectations</li><li><strong>Promote instance</strong>: <code>pg_ctl -D /pg/data promote</code></li><li><strong>Enable archiving</strong>: <code>psql -c "ALTER SYSTEM SET archive_mode = on;"</code></li><li><strong>Restart instance</strong>: <code>pg_ctl -D /pg/data restart</code></li><li><strong>Execute backup</strong>: <code>pg-backup full</code></li></ol><hr><h2 id=combined-usage>Combined Usage</h2><p><code>pg-fork</code> and <code>pg-pitr</code> can be combined for a safe PITR verification workflow:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Clone current instance</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Execute PITR on cloned instance (doesn&#39;t affect production)</span>
</span></span><span style=display:flex><span>pg-pitr -D /pg/data1 -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. Start cloned instance</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. Verify recovery results</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span> -c <span style=color:#4e9a06>&#34;SELECT count(*) FROM orders WHERE created_at &lt; &#39;2025-12-27 10:00:00&#39;;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. After confirmation, you can choose:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#    - Option A: Execute the same PITR on production instance</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#    - Option B: Promote cloned instance as new production instance</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 6. Clean up test instance</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 stop
</span></span><span style=display:flex><span>rm -rf /pg/data1
</span></span></code></pre></div><hr><h2 id=notes>Notes</h2><h3 id=runtime-requirements>Runtime Requirements</h3><ul><li>Must be executed as <code>postgres</code> user (or postgres group member)</li><li><code>pg-pitr</code> requires stopping target instance&rsquo;s PostgreSQL before execution</li><li><code>pg-fork</code> hot backup mode requires source instance to be running</li></ul><h3 id=file-system>File System</h3><ul><li>XFS (with reflink enabled) or Btrfs file system recommended</li><li>Cloning on CoW file systems is almost instant and takes no extra space</li><li>Non-CoW file systems will perform full copy, taking longer</li></ul><h3 id=port-planning>Port Planning</h3><table><thead><tr><th>FORK_ID</th><th>Default Port</th><th>Default Data Directory</th></tr></thead><tbody><tr><td>1</td><td>15432</td><td>/pg/data1</td></tr><tr><td>2</td><td>25432</td><td>/pg/data2</td></tr><tr><td>3</td><td>35432</td><td>/pg/data3</td></tr><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr><tr><td>9</td><td>95432</td><td>/pg/data9</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-39a4da4f2254a96928c0e56a6cb63c63>2 - Troubleshooting</h1><div class=lead>Common failures and analysis troubleshooting approaches</div><p>This document lists potential failures in PostgreSQL and Pigsty, as well as SOPs for locating, handling, and analyzing issues.</p><hr><h2 id=disk-space-exhausted>Disk Space Exhausted</h2><p>Disk space exhaustion is the most common type of failure.</p><h3 id=symptoms>Symptoms</h3><p>When the disk space where the database resides is exhausted, PostgreSQL will not work normally and may exhibit the following symptoms: database logs repeatedly report &ldquo;no space left on device&rdquo; errors, new data cannot be written, and PostgreSQL may even trigger a PANIC and force shutdown.</p><p>Pigsty includes a NodeFsSpaceFull alert rule that triggers when filesystem available space is less than 10%.
Use the monitoring system&rsquo;s NODE Instance panel to review the FS metrics panel to locate the issue.</p><h3 id=diagnosis>Diagnosis</h3><p>You can also log into the database node and use <code>df -h</code> to view the usage of each mounted partition to determine which partition is full.
For database nodes, focus on checking the following directories and their sizes to determine which category of files has filled up the space:</p><ul><li><strong>Data directory</strong> (<code>/pg/data/base</code>): Stores data files for tables and indexes; pay attention to heavy writes and temporary files</li><li><strong>WAL directory</strong> (e.g., <code>pg/data/pg_wal</code>): Stores PG WAL; WAL accumulation/replication slot retention is a common cause of disk exhaustion.</li><li><strong>Database log directory</strong> (e.g., <code>pg/log</code>): If PG logs are not rotated in time and large amounts of errors are written, they may also consume significant space.</li><li><strong>Local backup directory</strong> (e.g., <code>data/backups</code>): When using pgBackRest or similar tools to save backups locally, this may also fill up the disk.</li></ul><p>If the issue occurs on the Pigsty admin node or monitoring node, also consider:</p><ul><li><strong>Monitoring data</strong>: VictoriaMetrics time-series metrics and VictoriaLogs log storage both consume disk space; check retention policies.</li><li><strong>Object storage data</strong>: Pigsty&rsquo;s integrated MinIO object storage may be used for PG backup storage.</li></ul><p>After identifying the directory consuming the most space, you can further use <code>du -sh &lt;directory></code> to drill down and find specific large files or subdirectories.</p><h3 id=resolution>Resolution</h3><p>Disk exhaustion is an emergency issue requiring immediate action to free up space and ensure the database continues to operate.
When the data disk is not separated from the system disk, a full disk may prevent shell commands from executing. In this case, you can delete the <code>/pg/dummy</code> placeholder file to free up a small amount of emergency space so shell commands can work again.
If the database has crashed due to pg_wal filling up, you need to restart the database service after clearing space and carefully check data integrity.</p><hr><h2 id=transaction-id-wraparound>Transaction ID Wraparound</h2><p>PostgreSQL cyclically uses 32-bit transaction IDs (XIDs), and when exhausted, a &ldquo;transaction ID wraparound&rdquo; failure occurs (XID Wraparound).</p><h3 id=symptoms-1>Symptoms</h3><p>The typical sign in the first phase is when the age saturation in the <a href=https://demo.pigsty.io/d/pgsql-persist>PGSQL Persist - Age Usage</a> panel enters the warning zone.
Database logs begin to show messages like: <code>WARNING: database "postgres" must be vacuumed within xxxxxxxx transactions</code>.</p><p>If the problem continues to worsen, PostgreSQL enters protection mode: when remaining transaction IDs drop to about 1 million, the database switches to read-only mode; when reaching the limit of about 2.1 billion (2^31), it refuses any new transactions and forces the server to shut down to avoid data corruption.</p><h3 id=diagnosis-1>Diagnosis</h3><p>PostgreSQL and Pigsty enable automatic garbage collection (AutoVacuum) by default, so the occurrence of this type of failure usually has deeper root causes.
Common causes include: very long transactions (SAGE), misconfigured Autovacuum, replication slot blockage, insufficient resources, storage engine/extension bugs, disk bad blocks.</p><p>First identify the database with the highest age, then use the Pigsty PGCAT Database - Tables panel to confirm the age distribution of tables.
Also review the database error logs, which usually contain clues to locate the root cause.</p><h3 id=resolution-1>Resolution</h3><ol><li><strong>Immediately freeze old transactions</strong>: If the database has not yet entered read-only protection mode, immediately execute a manual VACUUM FREEZE on the affected database. You can start by freezing the most severely aged tables one by one rather than doing the entire database at once to accelerate the effect. Connect to the database as a superuser and run <code>VACUUM FREEZE table_name;</code> on tables identified with the largest <code>relfrozenxid</code>, prioritizing tables with the highest XID age. This can quickly reclaim large amounts of transaction ID space.</li><li><strong>Single-user mode rescue</strong>: If the database is already refusing writes or has crashed for protection, you need to start the database in single-user mode to perform freeze operations. In single-user mode, run <code>VACUUM FREEZE database_name;</code> to freeze and clean the entire database. After completion, restart the database in multi-user mode. This can lift the wraparound lock and make the database writable again. Be very careful when operating in single-user mode and ensure sufficient transaction ID margin to complete the freeze.</li><li><strong>Standby node takeover</strong>: In some complex scenarios (e.g., when hardware issues prevent vacuum from completing), consider promoting a read-only standby node in the cluster to primary to obtain a relatively clean environment for handling the freeze. For example, if the primary cannot vacuum due to bad blocks, you can manually failover to promote the standby to the new primary, then perform emergency vacuum freeze on it. After ensuring the new primary has frozen old transactions, switch the load back.</li></ol><hr><h2 id=connection-exhaustion>Connection Exhaustion</h2><p>PostgreSQL has a maximum connections configuration (<code>max_connections</code>). When client connections exceed this limit, new connection requests will be rejected. The typical symptom is that applications cannot connect to the database and report errors like
<strong>FATAL: remaining connection slots are reserved for non-replication superuser connections</strong> or <strong>too many clients already</strong>.
This indicates that regular connections are exhausted, leaving only slots reserved for superusers or replication.</p><h3 id=diagnosis-2>Diagnosis</h3><p>Connection exhaustion is usually caused by a large number of concurrent client requests. You can directly review the database&rsquo;s current active sessions through PGCAT Instance / PGCAT Database / PGCAT Locks.
Determine what types of queries are filling the system and proceed with further handling. Pay special attention to whether there are many connections in the &ldquo;Idle in Transaction&rdquo; state and long-running transactions (as well as slow queries).</p><h3 id=resolution-2>Resolution</h3><p><strong>Kill queries</strong>: For situations where exhaustion has already blocked business operations, typically use <code>pg_terminate_backend(pid)</code> immediately for emergency pressure relief.
For cases using connection pooling, you can adjust the connection pool size parameters and execute a reload to reduce the number of connections at the database level.</p><p>You can also modify the <code>max_connections</code> parameter to a larger value, but this parameter requires a database restart to take effect.</p><hr><h2 id=etcd-quota-exhausted>etcd Quota Exhausted</h2><p>An exhausted etcd quota will cause the PG high availability control plane to fail and prevent configuration changes.</p><h3 id=diagnosis-3>Diagnosis</h3><p>Pigsty uses etcd as the distributed configuration store (DCS) when implementing high availability. etcd itself has a storage quota (default is about 2GB).
When etcd storage usage reaches the quota limit, etcd will refuse write operations and report &ldquo;<strong>etcdserver: mvcc: database space exceeded</strong>&rdquo;. In this case, Patroni cannot write heartbeats or update configuration to etcd, causing cluster management functions to fail.</p><h3 id=resolution-3>Resolution</h3><p>Versions between Pigsty v2.0.0 and v2.5.1 are affected by this issue by default. Pigsty v2.6.0 added auto-compaction configuration for deployed etcd. If you only use it for PG high availability leases, this issue will no longer occur in regular use cases.</p><hr><h2 id=defective-storage-engine>Defective Storage Engine</h2><p>Currently, TimescaleDB&rsquo;s experimental storage engine Hypercore has been proven to have defects, with cases of VACUUM being unable to reclaim leading to XID wraparound failures.
Users using this feature should migrate to PostgreSQL native tables or TimescaleDB&rsquo;s default engine promptly.</p><p>Detailed introduction: <a href=https://mp.weixin.qq.com/s/LdZVVyOj4BA9C892I25lQw>PG New Storage Engine Failure Case</a> (Chinese)</p></div><div class=td-content style=page-break-before:always><h1 id=pg-58aaa9e1f6e72722733819cd673913c3>3 - Manual Recovery</h1><div class=lead>Manually perform PITR following prompt scripts in sandbox environment</div><p>You can use the <code>pgsql-pitr.yml</code> playbook to perform PITR, but in some cases, you may want to manually execute PITR using pgbackrest primitives directly for fine-grained control.
We will use a <a href=/docs/deploy/sandbox><strong>four-node sandbox</strong></a> cluster with MinIO backup repository to demonstrate the process.</p><p><img src=/img/pigsty/sandbox.png alt=pigsty-sandbox></p><hr><h2 id=initialize-sandbox>Initialize Sandbox</h2><p>Use <a href=/docs/deploy/vagrant><strong>vagrant</strong></a> or <a href=/docs/deploy/terraform><strong>terraform</strong></a> to prepare a four-node sandbox environment, then:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty/
</span></span><span style=display:flex><span>./configure -c full
</span></span><span style=display:flex><span>./install
</span></span></code></pre></div><p>Now operate as the admin user (or dbsu) on the admin node.</p><hr><h2 id=check-backup>Check Backup</h2><p>To check backup status, you need to switch to the <code>postgres</code> user and use the <code>pb</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres    <span style=color:#8f5902;font-style:italic># Switch to dbsu: postgres user</span>
</span></span><span style=display:flex><span>pb info               <span style=color:#8f5902;font-style:italic># Print pgbackrest backup info</span>
</span></span></code></pre></div><p><code>pb</code> is an alias for <code>pgbackrest</code> that automatically retrieves the <code>stanza</code> name from pgbackrest configuration.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pb<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>stanza</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>grep -o <span style=color:#4e9a06>&#39;\[[^][]*]&#39;</span> /etc/pgbackrest/pgbackrest.conf <span style=color:#000;font-weight:700>|</span> head -n1 <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/.*\[\([^]]*\)].*/\1/&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$stanza</span> <span style=color:#000>$@</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>You can see the initial backup information, which is a full backup:</p><pre tabindex=0><code>root@pg-meta-1:~# pb info
stanza: pg-meta
    status: ok
    cipher: aes-256-cbc

    db (current)
        wal archive min/max (17): 000000010000000000000001/000000010000000000000007

        full backup: 20250713-022731F
            timestamp start/stop: 2025-07-13 02:27:31+00 / 2025-07-13 02:27:33+00
            wal start/stop: 000000010000000000000004 / 000000010000000000000004
            database size: 44MB, database backup size: 44MB
            repo1: backup size: 8.4MB
</code></pre><p>The backup completed at <code>2025-07-13 02:27:33+00</code>, which is the earliest time you can restore to.
Since WAL archiving is active, you can restore to any point in time after the backup, up to the end of WAL (i.e., now).</p><hr><h2 id=generate-heartbeats>Generate Heartbeats</h2><p>You can generate some heartbeats to simulate workload. <code>/pg-bin/pg-heartbeat</code> is for this purpose,
it writes a heartbeat timestamp to the <code>monitor.heartbeat</code> table every second.</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
Heartbeat Generation</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
alias</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
pgbench</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make rh     <span style=color:#8f5902;font-style:italic># Run heartbeat: ssh 10.10.10.10 &#39;sudo -iu postgres /pg/bin/pg-heartbeat&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh 10.10.10.10 <span style=color:#4e9a06>&#39;sudo -iu postgres /pg/bin/pg-heartbeat&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>   cls   <span style=color:#000;font-weight:700>|</span>              ts               <span style=color:#000;font-weight:700>|</span>    lsn     <span style=color:#000;font-weight:700>|</span>  lsn_int  <span style=color:#000;font-weight:700>|</span> txid <span style=color:#000;font-weight:700>|</span> status  <span style=color:#000;font-weight:700>|</span>       now       <span style=color:#000;font-weight:700>|</span>  elapse
</span></span><span style=display:flex><span>---------+-------------------------------+------------+-----------+------+---------+-----------------+----------
</span></span><span style=display:flex><span> pg-meta <span style=color:#000;font-weight:700>|</span> 2025-07-13 03:01:20.318234+00 <span style=color:#000;font-weight:700>|</span> 0/115BF5C0 <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>291239360</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4812</span> <span style=color:#000;font-weight:700>|</span> leading <span style=color:#000;font-weight:700>|</span> 03:01:20.318234 <span style=color:#000;font-weight:700>|</span> 00:00:00</span></span></code></pre></div></div></div><p>You can even add more workload to the cluster. Let&rsquo;s use <code>pgbench</code> to generate some random writes:</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pgbench Workload</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
alias</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
pgbench</button></li><li class=nav-item><button class=nav-link id=tabs-01-03-tab data-bs-toggle=tab data-bs-target=#tabs-01-03 role=tab aria-controls=tabs-01-03 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make ri     <span style=color:#8f5902;font-style:italic># Initialize pgbench</span>
</span></span><span style=display:flex><span>make rw     <span style=color:#8f5902;font-style:italic># Run pgbench read-write workload</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -is10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> pgbench -nv -P1 -c4 --rate<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> -T10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-03 role=tabpanel aria-labelled-by=tabs-01-03-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> pgbench -nv -P1 -c4 --rate<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> -T10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>pgbench <span style=color:#ce5c00;font-weight:700>(</span>17.5 <span style=color:#ce5c00;font-weight:700>(</span>Homebrew<span style=color:#ce5c00;font-weight:700>)</span>, server 17.4 <span style=color:#ce5c00;font-weight:700>(</span>Ubuntu 17.4-1.pgdg24.04+2<span style=color:#ce5c00;font-weight:700>))</span>
</span></span><span style=display:flex><span>progress: 1.0 s, 60.9 tps, lat 7.295 ms stddev 4.219, <span style=color:#0000cf;font-weight:700>0</span> failed, lag 1.818 ms
</span></span><span style=display:flex><span>progress: 2.0 s, 69.1 tps, lat 6.296 ms stddev 1.983, <span style=color:#0000cf;font-weight:700>0</span> failed, lag 1.397 ms
</span></span><span style=display:flex><span>...</span></span></code></pre></div></div></div><hr><h2 id=pitr-manual>PITR Manual</h2><p>Now let&rsquo;s choose a recovery point in time, such as <code>2025-07-13 03:03:03+00</code>, which is a point after the initial backup (and heartbeat).
To perform manual PITR, use the <code>pg-pitr</code> tool:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg-pitr -t <span style=color:#4e9a06>&#34;2025-07-13 03:03:00+00&#34;</span>
</span></span></code></pre></div><p>It will generate instructions for performing the recovery, typically requiring four steps:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Perform <span style=color:#204a87>time</span> PITR on pg-meta
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>1. Stop PostgreSQL<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   1.1 Pause Patroni <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> there are any replicas<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ pg pause &lt;cls&gt;  <span style=color:#8f5902;font-style:italic># Pause patroni auto-failover</span>
</span></span><span style=display:flex><span>   1.2 Shutdown Patroni
</span></span><span style=display:flex><span>       $ pt-stop         <span style=color:#8f5902;font-style:italic># sudo systemctl stop patroni</span>
</span></span><span style=display:flex><span>   1.3 Shutdown Postgres
</span></span><span style=display:flex><span>       $ pg-stop         <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data stop -m fast</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2. Perform PITR<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   2.1 Restore Backup
</span></span><span style=display:flex><span>       $ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>   2.2 Start PG to Replay WAL
</span></span><span style=display:flex><span>       $ pg-start        <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data start</span>
</span></span><span style=display:flex><span>   2.3 Validate and Promote
</span></span><span style=display:flex><span>     - If database content is ok, promote it to finish recovery, otherwise goto 2.1
</span></span><span style=display:flex><span>       $ pg-promote      <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data promote</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>3. Restore Primary<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   3.1 Enable Archive Mode <span style=color:#ce5c00;font-weight:700>(</span>Restart Required<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM SET archive_mode = on;&#39;</span>
</span></span><span style=display:flex><span>   3.1 Restart Postgres to Apply Changes
</span></span><span style=display:flex><span>       $ pg-restart      <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data restart</span>
</span></span><span style=display:flex><span>   3.3 Restart Patroni
</span></span><span style=display:flex><span>       $ pt-restart      <span style=color:#8f5902;font-style:italic># sudo systemctl restart patroni</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>4. Restore Cluster<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   4.1 Re-Init All <span style=color:#ce5c00;font-weight:700>[</span>**REPLICAS**<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> any<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       - 4.1.1 option 1: restore replicas with same pgbackrest cmd <span style=color:#ce5c00;font-weight:700>(</span>require central backup repo<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           $ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>       - 4.1.2 option 2: nuke the replica data dir and restart patroni <span style=color:#ce5c00;font-weight:700>(</span>may take long <span style=color:#204a87>time</span> to restore<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           $ rm -rf /pg/data/*<span style=color:#000;font-weight:700>;</span> pt-restart
</span></span><span style=display:flex><span>       - 4.1.3 option 3: reinit with patroni, which may fail <span style=color:#204a87;font-weight:700>if</span> primary lsn &lt; replica lsn
</span></span><span style=display:flex><span>           $ pg reinit pg-meta
</span></span><span style=display:flex><span>   4.2 Resume Patroni
</span></span><span style=display:flex><span>       $ pg resume pg-meta
</span></span><span style=display:flex><span>   4.3 Full Backup <span style=color:#ce5c00;font-weight:700>(</span>optional<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ pg-backup full      <span style=color:#8f5902;font-style:italic># Recommended to perform new full backup after PITR</span>
</span></span></code></pre></div><hr><h2 id=single-node-example>Single Node Example</h2><p>Let&rsquo;s start with the simple single-node <code>pg-meta</code> cluster as a simpler example.</p><h3 id=shutdown-database>Shutdown Database</h3><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
Shutdown Services</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
shutdown patroni</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
shutdown postgres</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pt-stop         <span style=color:#8f5902;font-style:italic># sudo systemctl stop patroni, shutdown patroni (and postgres)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Optional, because postgres will be shutdown by patroni if patroni is not paused</span>
</span></span><span style=display:flex><span>$ pg_stop        <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data stop -m fast, shutdown postgres</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg_ctl: PID file <span style=color:#4e9a06>&#34;/pg/data/postmaster.pid&#34;</span> does not exist
</span></span><span style=display:flex><span>Is server running?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ pg-ps           <span style=color:#8f5902;font-style:italic># Print postgres related processes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> UID         PID   PPID  C STIME TTY      STAT   TIME CMD
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>31048</span>      <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0</span> 02:27 ?        Ssl    0:19 /usr/sbin/pgbouncer /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>32026</span>      <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0</span> 02:28 ?        Ssl    0:03 /usr/bin/pg_exporter ...
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>35510</span>  <span style=color:#0000cf;font-weight:700>35480</span>  <span style=color:#0000cf;font-weight:700>0</span> 03:01 pts/2    S+     0:00 /bin/bash /pg/bin/pg-heartbeat</span></span></code></pre></div></div></div><p>Make sure local postgres is not running, then execute the recovery commands given in the manual:</p><h3 id=restore-backup>Restore Backup</h3><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab aria-controls=tabs-03-00 aria-selected=false>
Restore Backup</button></li><li class=nav-item><button class="nav-link active" id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab aria-controls=tabs-03-01 aria-selected=true>
restore</button></li><li class=nav-item><button class=nav-link id=tabs-03-02-tab data-bs-toggle=tab data-bs-target=#tabs-03-02 role=tab aria-controls=tabs-03-02 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-pane fade" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-03-02 role=tabpanel aria-labelled-by=tabs-03-02-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>2025-07-13 03:17:07.443 P00   INFO: restore <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-13 03:17:07.470 P00   INFO: repo1: restore backup <span style=color:#204a87>set</span> 20250713-022731F, recovery will start at 2025-07-13 02:27:31
</span></span><span style=display:flex><span>2025-07-13 03:17:07.471 P00   INFO: remove invalid files/links/paths from <span style=color:#4e9a06>&#39;/pg/data&#39;</span>
</span></span><span style=display:flex><span>2025-07-13 03:17:08.523 P00   INFO: write updated /pg/data/postgresql.auto.conf
</span></span><span style=display:flex><span>2025-07-13 03:17:08.527 P00   INFO: restore <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 44MB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1436</span>
</span></span><span style=display:flex><span>2025-07-13 03:17:08.527 P00   INFO: restore <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1087ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div></div><h3 id=verify-data>Verify Data</h3><p>We don&rsquo;t want patroni HA to take over until we&rsquo;re sure the data is correct, so start postgres manually:</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab aria-controls=tabs-04-00 aria-selected=false>
Verify Data</button></li><li class=nav-item><button class="nav-link active" id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab aria-controls=tabs-04-01 aria-selected=true>
start postgres</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab aria-controls=tabs-04-02 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-pane fade" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-start</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>waiting <span style=color:#204a87;font-weight:700>for</span> server to start....2025-07-13 03:19:33.133 UTC <span style=color:#ce5c00;font-weight:700>[</span>39294<span style=color:#ce5c00;font-weight:700>]</span> LOG:  redirecting log output to logging collector process
</span></span><span style=display:flex><span>2025-07-13 03:19:33.133 UTC <span style=color:#ce5c00;font-weight:700>[</span>39294<span style=color:#ce5c00;font-weight:700>]</span> HINT:  Future log output will appear in directory <span style=color:#4e9a06>&#34;/pg/log/postgres&#34;</span>.
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>server started</span></span></code></pre></div></div></div><p>Now you can check the data to see if it&rsquo;s at the point in time you want.
You can verify by checking the latest timestamp in business tables, or in this case, check via the heartbeat table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ psql -c <span style=color:#4e9a06>&#39;table monitor.heartbeat&#39;</span>
</span></span><span style=display:flex><span>   id    <span style=color:#000;font-weight:700>|</span>              ts               <span style=color:#000;font-weight:700>|</span>    lsn    <span style=color:#000;font-weight:700>|</span> txid
</span></span><span style=display:flex><span>---------+-------------------------------+-----------+------
</span></span><span style=display:flex><span> pg-meta <span style=color:#000;font-weight:700>|</span> 2025-07-13 03:02:59.214104+00 <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>302005504</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4912</span>
</span></span></code></pre></div><p>The timestamp is just before our specified point in time! (<code>2025-07-13 03:03:00+00</code>).
If this is not the point in time you want, you can repeat the recovery with a different time point.
Since recovery is performed incrementally and in parallel, it&rsquo;s very fast.
You can retry until you find the correct point in time.</p><h3 id=promote-primary>Promote Primary</h3><p>The recovered postgres cluster is in <code>recovery</code> mode, so it will reject any write operations until promoted to primary.
These recovery parameters are generated by pgBackRest in the configuration file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>postgres@pg-meta-1:~$ cat /pg/data/postgresql.auto.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Do not edit this file or use ALTER SYSTEM manually!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># It is managed by Pigsty &amp; Ansible automatically!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recovery settings generated by pgBackRest restore on 2025-07-13 03:17:08</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>archive_mode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;off&#39;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>restore_command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;pgbackrest --stanza=pg-meta archive-get %f &#34;%p&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>recovery_target_time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span>
</span></span></code></pre></div><p>If the data is correct, you can <strong>promote</strong> it to primary, marking it as the new leader and ready to accept writes.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab aria-controls=tabs-05-00 aria-selected=false>
Promote Primary</button></li><li class=nav-item><button class="nav-link active" id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab aria-controls=tabs-05-01 aria-selected=true>
promote</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab aria-controls=tabs-05-02 aria-selected=false>
check</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-pane fade" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-promote
</span></span><span style=display:flex><span>waiting <span style=color:#204a87;font-weight:700>for</span> server to promote.... <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>server promoted</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_is_in_recovery()&#39;</span>   <span style=color:#8f5902;font-style:italic># &#39;f&#39; means promoted to primary</span>
</span></span><span style=display:flex><span> pg_is_in_recovery
</span></span><span style=display:flex><span>-------------------
</span></span><span style=display:flex><span> f
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> row<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>New Timeline and Split Brain</div><p>Once promoted, the database cluster will enter a new timeline (leader epoch).
If there is any write traffic, it will be written to the new timeline.</p></div><h3 id=restore-cluster>Restore Cluster</h3><p>Finally, not only do you need to restore data, but also restore cluster state, such as:</p><ul><li>patroni takeover</li><li>archive mode</li><li>backup set</li><li>replicas</li></ul><h4 id=patroni-takeover>Patroni Takeover</h4><p>Your postgres was started directly. To restore HA takeover, you need to start the patroni service:</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab aria-controls=tabs-07-00 aria-selected=false>
Patroni Takeover</button></li><li class=nav-item><button class="nav-link active" id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab aria-controls=tabs-07-01 aria-selected=true>
launch patroni</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab aria-controls=tabs-07-02 aria-selected=false>
resume patroni</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-pane fade" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pt-start   <span style=color:#8f5902;font-style:italic># sudo systemctl start patroni</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume pg-meta      <span style=color:#8f5902;font-style:italic># Resume patroni auto-failover (if previously paused)</span></span></span></code></pre></div></div></div><h4 id=archive-mode>Archive Mode</h4><p><code>archive_mode</code> is disabled during recovery by pgbackrest.
If you want new leader writes to be archived to the backup repository, you also need to enable the <code>archive_mode</code> configuration.</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab aria-controls=tabs-08-00 aria-selected=false>
Archive Mode</button></li><li class=nav-item><button class="nav-link active" id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab aria-controls=tabs-08-01 aria-selected=true>
check archive_mode</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab aria-controls=tabs-08-02 aria-selected=false>
reset archive_mode</button></li><li class=nav-item><button class=nav-link id=tabs-08-03-tab data-bs-toggle=tab data-bs-target=#tabs-08-03 role=tab aria-controls=tabs-08-03 aria-selected=false>
edit directly</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-pane fade" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;show archive_mode&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> archive_mode
</span></span><span style=display:flex><span>--------------
</span></span><span style=display:flex><span> off</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode;&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;show archive_mode&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-08-03 role=tabpanel aria-labelled-by=tabs-08-03-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># You can also directly edit postgresql.auto.conf and reload with pg_ctl</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;/archive_mode/d&#39;</span> /pg/data/postgresql.auto.conf
</span></span><span style=display:flex><span>pg_ctl -D /pg/data reload</span></span></code></pre></div></div></div><h4 id=backup-set>Backup Set</h4><p>It&rsquo;s generally recommended to perform a new full backup after PITR, but this is optional.</p><h4 id=replicas>Replicas</h4><p>If your postgres cluster has replicas, you also need to perform PITR on each replica.
Alternatively, a simpler approach is to remove the replica data directory and restart patroni, which will reinitialize the replica from the primary.
We&rsquo;ll cover this scenario in the next multi-node cluster example.</p><hr><h2 id=multi-node-example>Multi-Node Example</h2><p>Now let&rsquo;s use the three-node <code>pg-test</code> cluster as a PITR example.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ec3ed8119ef85413c277384f41ca7b27>4 - Enabling HugePage for PostgreSQL</h1><div class=lead>Enabling HugePage for PostgreSQL to reduce memory fragmentation and improve performance.</div><blockquote><p>Use <code>node_hugepage_count</code> and <code>node_hugepage_ratio</code> or <code>/pg/bin/pg-tune-hugepage</code></p></blockquote><p>If you plan to enable HugePages, consider using <a href=/docs/node/param#node_hugepage_count><code>node_hugepage_count</code></a> and <a href=/docs/node/param#node_hugepage_ratio><code>node_hugepage_ratio</code></a>, and apply with <code>./node.yml -t node_tune</code>.</p><p>HugePages have pros and cons for databases. The advantage is that memory is managed exclusively, eliminating concerns about being reallocated and reducing database OOM risk. The disadvantage is that it may negatively impact performance in certain scenarios.</p><p>Before PostgreSQL starts, you need to allocate <strong>enough</strong> huge pages. The wasted portion can be reclaimed using the <code>pg-tune-hugepage</code> script, but this script is only available for PostgreSQL 15+.</p><p>If your PostgreSQL is already running, you can enable huge pages using the following method (PG15+ only):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sync<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>3</span> &gt; /proc/sys/vm/drop_caches   <span style=color:#8f5902;font-style:italic># Flush disk, release system cache (be prepared for database perf impact)</span>
</span></span><span style=display:flex><span>sudo /pg/bin/pg-tune-hugepage             <span style=color:#8f5902;font-style:italic># Write nr_hugepages to /etc/sysctl.d/hugepage.conf</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt;                          <span style=color:#8f5902;font-style:italic># Restart postgres to use hugepage</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e6716a8d517caddd0851177927c9c69c>5 - Accidental Deletion</h1><div class=lead>Handling accidental data deletion, table deletion, and database deletion</div><h2 id=accidental-data-deletion>Accidental Data Deletion</h2><p>If it&rsquo;s a small-scale <code>DELETE</code> misoperation, you can consider using the <a href=https://pgext.cloud/e/pg_surgery><code>pg_surgery</code></a> or <a href=https://pgext.cloud/e/pg_dirtyread><code>pg_dirtyread</code></a> extension for in-place surgical recovery.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Immediately disable Auto Vacuum on this table and abort Auto Vacuum worker processes for this table
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>some_table</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>autovacuum_enabled</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>autovacuum_enabled</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dirtyread</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dirtyread</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;tablename&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#f8f8f8> </span><span style=color:#000>type1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>col2</span><span style=color:#f8f8f8> </span><span style=color:#000>type2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>If the deleted data has already been reclaimed by VACUUM, then use the general accidental deletion recovery process.</p><h2 id=accidental-object-deletion>Accidental Object Deletion</h2><p>When <code>DROP/DELETE</code> type misoperations occur, typically decide on a recovery plan according to the following process:</p><ol><li>Confirm whether this data can be recovered from the business system or other data systems. If yes, recover directly from the business side.</li><li>Confirm whether there is a delayed replica. If yes, advance the delayed replica to the time point before deletion and query the data for recovery.</li><li>If the data has been confirmed deleted, confirm backup information and whether the backup range covers the deletion time point. If it does, start PITR.</li><li>Confirm whether to perform in-place cluster <a href=/docs/pgsql/backup/restore>PITR rollback</a>, or start a new server for replay, or use a replica for replay, and execute the recovery strategy.</li></ol><h2 id=accidental-cluster-deletion>Accidental Cluster Deletion</h2><p>If an entire database cluster is accidentally deleted through Pigsty management commands, for example, incorrectly executing the <a href=/docs/pgsql/playbook#pgsql-rmyml><code>pgsql-rm.yml</code></a> playbook or the <code>bin/pgsql-rm</code> command.
Unless you have set the <a href=/docs/pgsql/param#pg_rm_backup><code>pg_rm_backup</code></a> parameter to <code>false</code>, the backup will be deleted along with the database cluster.</p><blockquote><p><strong>Warning</strong>: In this situation, your data will be unrecoverable! <strong>Please think three times before proceeding!</strong></p></blockquote><p>Recommendation: For production environments, you can globally configure this parameter to <code>false</code> in the configuration manifest to preserve backups when removing clusters.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-677d9d9a118e237b46693da04151cde7>6 - HA Drill: Handling 2-of-3 Node Failure</h1><div class=lead>HA scenario response plan: When two of three nodes fail and auto-failover doesn&rsquo;t work, how to recover from the emergency state?</div><p>If a classic 3-node HA deployment experiences simultaneous failure of two nodes (majority), the system typically cannot complete automatic failover and requires manual intervention.</p><p>First, assess the status of the other two servers. If they can be brought up quickly, prioritize recovering those two servers. Otherwise, enter the <strong>Emergency Recovery Procedure</strong>.</p><p><strong>The Emergency Recovery Procedure assumes your admin node has failed</strong> and only a single regular database node survives. In this case, the fastest recovery process is:</p><ul><li>Adjust HAProxy configuration to direct traffic to the primary.</li><li>Stop Patroni and manually promote the PostgreSQL replica to primary.</li></ul><hr><h2 id=adjust-haproxy-configuration>Adjust HAProxy Configuration</h2><p>If you access the cluster bypassing HAProxy, you can skip this step. If you access the database cluster through HAProxy, you need to adjust the load balancer configuration to manually direct read/write traffic to the primary.</p><ul><li>Edit the <code>/etc/haproxy/&lt;pg_cluster>-primary.cfg</code> configuration file, where <code>&lt;pg_cluster></code> is your PostgreSQL cluster name, e.g., <code>pg-meta</code>.</li><li>Comment out the health check configuration options to stop health checks.</li><li>Comment out the other two failed machines in the server list, keeping only the current primary server.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-meta-primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5433</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Comment out the following four health check lines</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#option httpchk                               # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#option http-keep-alive                       # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#http-check send meth OPTIONS uri /primary    # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#http-check expect status 200                 # &lt;---- remove this</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-meta-1 10.10.10.10:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Comment out the other two failed machines</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#server pg-meta-2 10.10.10.11:6432 check port 8008 weight 100 &lt;---- comment this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#server pg-meta-3 10.10.10.12:6432 check port 8008 weight 100 &lt;---- comment this</span>
</span></span></code></pre></div><p>After adjusting the configuration, don&rsquo;t rush to execute <code>systemctl reload haproxy</code> to reload. Wait until after promoting the primary, then execute together. The effect of this configuration is that HAProxy will no longer perform primary health checks (which by default use Patroni), but will directly direct write traffic to the current primary.</p><hr><h2 id=manually-promote-replica>Manually Promote Replica</h2><p>Log in to the target server, switch to the dbsu user, execute <code>CHECKPOINT</code> to flush to disk, stop Patroni, restart PostgreSQL, and execute Promote.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres                     <span style=color:#8f5902;font-style:italic># Switch to database dbsu user</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;checkpoint; checkpoint;&#39;</span>      <span style=color:#8f5902;font-style:italic># Two Checkpoints to flush dirty pages, avoid long PG restart</span>
</span></span><span style=display:flex><span>sudo systemctl stop patroni            <span style=color:#8f5902;font-style:italic># Stop Patroni</span>
</span></span><span style=display:flex><span>pg-restart                             <span style=color:#8f5902;font-style:italic># Restart PostgreSQL</span>
</span></span><span style=display:flex><span>pg-promote                             <span style=color:#8f5902;font-style:italic># Promote PostgreSQL replica to primary</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_is_in_recovery();&#39;</span>  <span style=color:#8f5902;font-style:italic># If result is f, it has been promoted to primary</span>
</span></span></code></pre></div><p>If you adjusted the HAProxy configuration above, you can now execute <code>systemctl reload haproxy</code> to reload the HAProxy configuration and direct traffic to the new primary.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload haproxy                <span style=color:#8f5902;font-style:italic># Reload HAProxy configuration to direct write traffic to current instance</span>
</span></span></code></pre></div><hr><h2 id=avoid-split-brain>Avoid Split Brain</h2><p>After emergency recovery, the second priority is: <strong>Avoid Split Brain</strong>. Users should prevent the other two servers from coming back online and forming a split brain with the current primary, causing data inconsistency.</p><p>Simple approaches:</p><ul><li><strong>Power off/disconnect network</strong> the other two servers to ensure they don&rsquo;t come online uncontrollably.</li><li>Adjust the database connection string used by applications to point directly to the surviving server&rsquo;s primary.</li></ul><p>Then decide the next steps based on the specific situation:</p><ul><li>A: The two servers have temporary failures (e.g., network/power outage) and can be repaired in place to continue service.</li><li>B: The two failed servers have permanent failures (e.g., hardware damage) and will be removed and decommissioned.</li></ul><hr><h2 id=recovery-after-temporary-failure>Recovery After Temporary Failure</h2><p>If the other two servers have temporary failures and can be repaired to continue service, follow these steps for repair and rebuild:</p><ul><li>Handle one failed server at a time, prioritize the admin node / INFRA node.</li><li>Start the failed server and stop Patroni after startup.</li></ul><p>After the ETCD cluster quorum is restored, it will resume work. Then start Patroni on the surviving server (current primary) to take over the existing PostgreSQL and regain cluster leadership. After Patroni starts, enter maintenance mode.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni
</span></span><span style=display:flex><span>pg pause &lt;pg_cluster&gt;
</span></span></code></pre></div><p>On the other two instances, create the <code>touch /pg/data/standby.signal</code> marker file as the <code>postgres</code> user to mark them as replicas, then start Patroni:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni
</span></span></code></pre></div><p>After confirming Patroni cluster identity/roles are correct, exit maintenance mode:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume &lt;pg_cluster&gt;
</span></span></code></pre></div><hr><h2 id=recovery-after-permanent-failure>Recovery After Permanent Failure</h2><p>After permanent failure, first recover the <code>~/pigsty</code> directory on the admin node. The key files needed are <code>pigsty.yml</code> and <code>files/pki/ca/ca.key</code>.</p><blockquote><p>If you cannot retrieve or don&rsquo;t have backups of these two files, you can deploy a new Pigsty and migrate the existing cluster to the new deployment via <a href=/docs/pgsql/config/#backup-cluster>Backup Cluster</a>.</p><p>Please regularly backup the <code>pigsty</code> directory (e.g., using Git for version control). Learn from this and avoid such mistakes in the future.</p></blockquote><h4 id=configuration-repair>Configuration Repair</h4><p>You can use the surviving node as the new admin node, copy the <code>~/pigsty</code> directory to the new admin node, then start adjusting the configuration. For example, replace the original default admin node <code>10.10.10.10</code> with the surviving node <code>10.10.10.12</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># Use new admin node address</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_etc_hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span><span style=color:#000>h.pigsty a.pigsty p.pigsty g.pigsty sss.pigsty]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># Also modify other configs referencing old admin IP (10.10.10.10)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                              </span><span style=color:#8f5902;font-style:italic># Adjust Infra cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># 10.10.10.10: { infra_seq: 1 } # Old Infra node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># New Infra node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># Adjust ETCD cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.10: { etcd_seq: 1 }   # Comment out this failed node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { etcd_seq: 2 }   # Comment out this failed node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Keep surviving node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># Adjust PGSQL cluster configuration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.10: { pg_seq: 1, pg_role: primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { pg_seq: 2, pg_role: replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.12: { pg_seq: 3, pg_role: replica , pg_offline_query: true }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: primary , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h4 id=etcd-repair>ETCD Repair</h4><p>Then execute the following command to reset ETCD to a single-node cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml -e <span style=color:#000>etcd_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> -e <span style=color:#000>etcd_clean</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><p>Follow the instructions in <a href=/docs/etcd/admin#reload-config>ETCD Reload Configuration</a> to adjust ETCD Endpoint references.</p><h4 id=infra-repair>INFRA Repair</h4><p>If the surviving node doesn&rsquo;t have the INFRA module, configure and install a new INFRA module on the current node. Execute the following command to deploy the INFRA module to the surviving node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -l 10.10.10.12
</span></span></code></pre></div><p>Repair monitoring on the current node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_monitor
</span></span></code></pre></div><h4 id=pgsql-repair>PGSQL Repair</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_conf                            <span style=color:#8f5902;font-style:italic># Regenerate PG configuration files</span>
</span></span><span style=display:flex><span>systemctl reload patroni                          <span style=color:#8f5902;font-style:italic># Reload Patroni configuration on surviving node</span>
</span></span></code></pre></div><p>After repairing each module, you can follow the standard expansion process to add new nodes to the cluster and restore cluster high availability.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b4eeb541b5d47f6b2e5017106913ea72>7 - Bind a L2 VIP to PostgreSQL Primary with VIP-Manager</h1><p>You can define an <strong>OPTIONAL</strong> L2 VIP on a PostgreSQL cluster, provided that all nodes in the cluster are in the same L2 network.</p><p>This VIP works on Master-Backup mode and always points to the node where the primary instance of the database cluster is located.</p><p>This VIP is managed by the <a href=https://github.com/cybertec-postgresql/vip-manager>VIP-Manager</a>, which reads the Leader Key written by Patroni from DCS (etcd) to determine whether it is the master.</p><hr><h2 id=enable-vip>Enable VIP</h2><p>Define <a href=/docs/pgsql/param#pg_vip_enabled><code>pg_vip_enabled</code></a> parameter as <code>true</code> in the cluster level to enable the VIP component on the cluster. You can also enable this configuration in the global configuration.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgsql 3 node ha cluster: pg-test</span>
</span></span><span style=display:flex><span>pg-test:
</span></span><span style=display:flex><span>  hosts:
</span></span><span style=display:flex><span>    10.10.10.11: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 1, pg_role: primary <span style=color:#ce5c00;font-weight:700>}</span>   <span style=color:#8f5902;font-style:italic># primary instance, leader of cluster</span>
</span></span><span style=display:flex><span>    10.10.10.12: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 2, pg_role: replica <span style=color:#ce5c00;font-weight:700>}</span>   <span style=color:#8f5902;font-style:italic># replica instance, follower of leader</span>
</span></span><span style=display:flex><span>    10.10.10.13: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 3, pg_role: replica, pg_offline_query: <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic># replica with offline access</span>
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    pg_cluster: pg-test           <span style=color:#8f5902;font-style:italic># define pgsql cluster name</span>
</span></span><span style=display:flex><span>    pg_users:  <span style=color:#ce5c00;font-weight:700>[{</span> name: <span style=color:#204a87>test</span> , password: <span style=color:#204a87>test</span> , pgbouncer: <span style=color:#204a87>true</span> , roles: <span style=color:#ce5c00;font-weight:700>[</span> dbrole_admin <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>}]</span>
</span></span><span style=display:flex><span>    pg_databases: <span style=color:#ce5c00;font-weight:700>[{</span> name: <span style=color:#204a87>test</span> <span style=color:#ce5c00;font-weight:700>}]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Enable L2 VIP</span>
</span></span><span style=display:flex><span>    pg_vip_enabled: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>    pg_vip_address: 10.10.10.3/24
</span></span><span style=display:flex><span>    pg_vip_interface: eth1
</span></span></code></pre></div><p>Beware that <a href=/docs/pgsql/param#pg_vip_address><code>pg_vip_address</code></a> must be a valid IP address with subnet and available in the current L2 network.</p><p>Beware that <a href=/docs/pgsql/param#pg_vip_interface><code>pg_vip_interface</code></a> must be a valid network interface name and should be the same as the one using IPv4 address in the inventory.</p><p>If the network interface name is different among cluster members, users should explicitly specify the <code>pg_vip_interface</code> parameter for each instance, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth0  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ens33 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># define pgsql cluster name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: test , password: test , pgbouncer: true , roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Enable L2 VIP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.3</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#pg_vip_interface: eth1</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>To refresh the VIP configuration and restart the VIP-Manager, use the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_vip
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1a6ecaf250187005e255b6c6eafd53e2>8 - Deploy HA Citus Cluster</h1><div class=lead>How to deploy a Citus high-availability distributed cluster?</div><p>Citus is a PostgreSQL extension that transforms PostgreSQL into a distributed database, enabling horizontal scaling across multiple nodes to handle large amounts of data and queries.</p><p>Patroni v3.0+ provides native high-availability support for Citus, simplifying the setup of Citus clusters. Pigsty also provides native support for this.</p><ul><li><a href=https://docs.citusdata.com/en/stable/get_started/what_is_citus.html>What is Citus</a></li><li><a href=https://patroni.readthedocs.io/en/latest/citus.html>Patroni Citus Support</a></li></ul><blockquote><p>Note: The current Citus version (13.0) supports PostgreSQL 17, 16, 15, and 14. Pigsty extension repo provides Citus ARM64 packages.</p></blockquote><hr><h2 id=citus-cluster>Citus Cluster</h2><p>Pigsty natively supports Citus. See <a href=https://github.com/pgsty/pigsty/blob/main/conf/citus.yml><code>conf/citus.yml</code></a> for reference.</p><p>Here we use the Pigsty 4-node sandbox to define a Citus cluster <code>pg-citus</code>, which includes a 2-node coordinator cluster <code>pg-citus0</code> and two Worker clusters <code>pg-citus1</code> and <code>pg-citus2</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.2/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.2/24 ,pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.3/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.4/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                            # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># citus 13.0 supports PG 14-17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                        # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable vip for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip interface for all members</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, postgis, pgvector, topn, pg_cron, hll ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install these extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, pg_cron, pg_stat_statements&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_citus ,password: DBUser.Citus ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ]    }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: citus ,owner: dbuser_citus ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, vector, topn, pg_cron, hll ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>citus.node_conninfo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslmode=require sslrootcert=/pg/cert/ca.crt sslmode=verify-full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Compared to standard PostgreSQL clusters, Citus cluster configuration has some special requirements. First, you need to ensure the Citus extension is downloaded, installed, loaded, and enabled, which involves the following four parameters:</p><ul><li><a href=/docs/infra/param#repo_packages><code>repo_packages</code></a>: Must include the <code>citus</code> extension, or you need to use a PostgreSQL offline package that includes Citus.</li><li><a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a>: Must include the <code>citus</code> extension, i.e., you must install the <code>citus</code> extension on each node.</li><li><a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a>: Must include the <code>citus</code> extension at the first position, though Patroni now handles this automatically.</li><li><a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a>: Define a primary database that must have the <code>citus</code> extension installed.</li></ul><p>Second, you need to ensure the Citus cluster is configured correctly:</p><ul><li><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a>: Must be set to <code>citus</code> to tell Patroni to use Citus mode.</li><li><a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a>: Must specify the name of the primary database with <code>citus</code> extension, named <code>citus</code> here.</li><li><a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a>: Must specify a unified name as the cluster name prefix for all horizontal shard PG clusters, <code>pg-citus</code> here.</li><li><a href=/docs/pgsql/param#pg_group><code>pg_group</code></a>: Must specify a shard number, integers starting from zero. <code>0</code> represents the coordinator cluster, others are Worker clusters.</li><li><a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a>: Must correspond to the combination of <a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a> and <a href=/docs/pgsql/param#pg_group><code>pg_group</code></a>.</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>: Must be set to a non-empty plaintext password, otherwise Citus will not work properly.</li><li><a href=/docs/pgsql/param#pg_parameters><code>pg_parameters</code></a>: Recommended to set <code>citus.node_conninfo</code> to enforce SSL access and require node-to-node client certificate verification.</li></ul><p>After configuration, you can deploy the Citus cluster using <code>pgsql.yml</code> just like a regular PostgreSQL cluster.</p><hr><h2 id=manage-citus-cluster>Manage Citus Cluster</h2><p>After defining the Citus cluster, deploy it using the <code>pgsql.yml</code> playbook:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-citus    <span style=color:#8f5902;font-style:italic># Deploy Citus cluster pg-citus</span>
</span></span></code></pre></div><p>Using any member&rsquo;s DBSU (<code>postgres</code>) user, you can list the Citus cluster status with <code>patronictl</code> (alias: <code>pg</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg list
</span></span><span style=display:flex><span>+ Citus cluster: pg-citus ----------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Group <span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State     <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB <span style=color:#000;font-weight:700>|</span> Tags               <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> pg-citus0-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 20C.40G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> pg-citus1-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> pg-citus2-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> pg-citus2-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> streaming <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span></code></pre></div><p>You can treat each horizontal shard cluster as an independent PGSQL cluster and manage them with the <code>pg</code> (<code>patronictl</code>) command. Note that when using the <code>pg</code> command to manage Citus clusters, you need to use the <code>--group</code> parameter to specify the cluster shard number:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list pg-citus --group <span style=color:#0000cf;font-weight:700>0</span>   <span style=color:#8f5902;font-style:italic># Use --group 0 to specify cluster shard number</span>
</span></span></code></pre></div><p>Citus has a system table called <code>pg_dist_node</code> that records Citus cluster node information. Patroni automatically maintains this table.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PGURL</span><span style=color:#ce5c00;font-weight:700>=</span>postgres://postgres:DBUser.Postgres@10.10.10.10/citus
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql <span style=color:#000>$PGURL</span> -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_node;&#39;</span>       <span style=color:#8f5902;font-style:italic># View node information</span>
</span></span><span style=display:flex><span> nodeid <span style=color:#000;font-weight:700>|</span> groupid <span style=color:#000;font-weight:700>|</span>  nodename   <span style=color:#000;font-weight:700>|</span> nodeport <span style=color:#000;font-weight:700>|</span> noderack <span style=color:#000;font-weight:700>|</span> hasmetadata <span style=color:#000;font-weight:700>|</span> isactive <span style=color:#000;font-weight:700>|</span> noderole  <span style=color:#000;font-weight:700>|</span> nodecluster <span style=color:#000;font-weight:700>|</span> metadatasynced <span style=color:#000;font-weight:700>|</span> shouldhaveshards
</span></span><span style=display:flex><span>--------+---------+-------------+----------+----------+-------------+----------+-----------+-------------+----------------+------------------
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> secondary <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span></code></pre></div><p>You can also view user authentication information (superuser access only):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ psql <span style=color:#000>$PGURL</span> -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_authinfo;&#39;</span>   <span style=color:#8f5902;font-style:italic># View node auth info (superuser only)</span>
</span></span></code></pre></div><p>Then you can use a regular business user (e.g., <code>dbuser_citus</code> with DDL privileges) to access the Citus cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_node;&#39;</span>
</span></span></code></pre></div><hr><h2 id=using-citus-cluster>Using Citus Cluster</h2><p>When using Citus clusters, we strongly recommend reading the <a href=https://docs.citusdata.com/en/stable/get_started/concepts.html>Citus official documentation</a> to understand its architecture and core concepts.</p><p>The key is understanding the five types of tables in Citus and their characteristics and use cases:</p><ul><li>Distributed Table</li><li>Reference Table</li><li>Local Table</li><li>Local Management Table</li><li>Schema Table</li></ul><p>On the coordinator node, you can create distributed tables and reference tables and query them from any data node. Since 11.2, any Citus database node can act as a coordinator.</p><p>We can use pgbench to create some tables and distribute the main table (<code>pgbench_accounts</code>) across nodes, then use other small tables as reference tables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PGURL</span><span style=color:#ce5c00;font-weight:700>=</span>postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus
</span></span><span style=display:flex><span>pgbench -i <span style=color:#000>$PGURL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql <span style=color:#000>$PGURL</span> <span style=color:#4e9a06>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_distributed_table(&#39;pgbench_accounts&#39;, &#39;aid&#39;); SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_accounts&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_branches&#39;)         ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_branches&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_history&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_history&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_tellers&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_tellers&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Run read/write tests:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus      <span style=color:#8f5902;font-style:italic># Direct connect to coordinator port 5432</span>
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.10:6432/citus <span style=color:#8f5902;font-style:italic># Through connection pool, reduce client connection pressure</span>
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.13/citus      <span style=color:#8f5902;font-style:italic># Any primary node can act as coordinator</span>
</span></span><span style=display:flex><span>pgbench --select-only -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.11/citus <span style=color:#8f5902;font-style:italic># Read-only queries</span>
</span></span></code></pre></div><hr><h2 id=production-deployment>Production Deployment</h2><p>For production use of Citus, you typically need to set up streaming replication physical replicas for the Coordinator and each Worker cluster.</p><p>For example, <a href=https://github.com/pgsty/pigsty/blob/main/conf/simu.yml><code>simu.yml</code></a> defines a 10-node Citus cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.50</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.51</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.52</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.53</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.54</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.55</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.56</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.57</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.58</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.59</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                            # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># citus 13.0 supports PG 14-17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                        # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable vip for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip interface for all members</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># enable dbsu password access for citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, postgis, pgvector, topn, pg_cron, hll ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install these extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, pg_cron, pg_stat_statements&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_citus ,password: DBUser.Citus ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ]    }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: citus ,owner: dbuser_citus ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, vector, topn, pg_cron, hll ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>citus.node_conninfo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslrootcert=/pg/cert/ca.crt sslmode=verify-full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>We will cover a series of advanced Citus topics in subsequent tutorials:</p><ul><li>Read/write separation</li><li>Failure handling</li><li>Consistent backup and recovery</li><li>Advanced monitoring and diagnostics</li><li>Connection pooling</li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Email - Vonng" aria-label="Email - Vonng"><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label="Email - Vonng"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=WeChat aria-label=WeChat><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=WeChat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Discussion aria-label=Discussion><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=Discussion><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Repo aria-label=Repo><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=Repo><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>